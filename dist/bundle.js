(t=>{var s={};function i(h){if(s[h])return s[h].exports;var e=s[h]={i:h,l:!1,exports:{}};return t[h].call(e.exports,e,e.exports,i),e.l=!0,e.exports}i.m=t,i.c=s,i.d=(t,s,h)=>{i.o(t,s)||Object.defineProperty(t,s,{enumerable:!0,get:h})},i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"u",{value:!0})},i.t=(t,s)=>{if(1&s&&(t=i(t)),8&s)return t;if(4&s&&"object"==typeof t&&t&&t.u)return t;var h=Object.create(null);if(i.r(h),Object.defineProperty(h,"default",{enumerable:!0,value:t}),2&s&&"string"!=typeof t)for(var e in t)i.d(h,e,(s=>t[s]).bind(null,e));return h},i.n=t=>{var s=t&&t.u?function(){return t.default}:function(){return t};return i.d(s,"a",s),s},i.o=(t,s)=>Object.prototype.hasOwnProperty.call(t,s),i.p="",i(i.s=3)})([(t,s)=>{t.exports=PIXI},(t,s)=>{t.exports=PIXI.layers},(t,s)=>{t.exports=PIXI.sound},function(t,s,i){"use strict";i.r(s);var h=i(0);i(1),i(2);const e=2.3283064365386963e-10;class n{constructor(t){if(t<=1)throw"Illegal seed number";return this.v=(t>>>0)*e,t=69069*t+1>>>0,this._=t*e,t=69069*t+1>>>0,this.k=t*e,this.M=1,this}static create(){const t=crypto.getRandomValues(new Uint32Array(1))[0];return new n(t)}static seeded(t){return new n(t)}float(){let t=2091639*this.v+this.M*e;return this.v=this._,this._=this.k,this.M=0|t,this.k=t-this.M,this.k}int(){return 4294967296*this.float()}boolean(){return this.float()<.5}range(t,s){return Math.floor(this.float()*(s-t))+t}normal(t=0,s=1){let i,h,e;do{i=2*this.float()-1,h=2*this.float()-1,e=i*i+h*h}while(e>1||0==e);return t+i*Math.sqrt(-2*Math.log(e)/e)*s}skewNormal(t,s,i){let h=0,e=0;for(;0===h;)h=this.float();for(;0===e;)e=this.float();let n=Math.sqrt(-2*Math.log(h))*Math.cos(2*Math.PI*e);return n=n/10+.5,(n>1||n<0)&&(n=this.skewNormal(t,s,i)),n=Math.pow(n,i),n*=s-t,n+=t,n}select(t){return 0===t.length?null:t[Math.floor(this.float()*t.length)]}}var r;(t=>{t[t.Await=1]="Await",t[t.Pressed=2]="Pressed"})(r||(r={}));class o{constructor(t){this.code=t,this.D=r.Await,this.O=!1,this.S=!0}get triggered(){return this.O}once(){return!this.S&&(this.S=!0,!0)}keydown(t){t.code===this.code&&(t.preventDefault(),this.D===r.Await&&(this.O=!0,this.S=!1,this.D=r.Pressed))}keyup(t){t.code===this.code&&(t.preventDefault(),this.D===r.Pressed&&(this.O=!1,this.D=r.Await))}reset(){this.O=!1,this.S=!0}}class l{constructor(){this.moveUp=new o("KeyW"),this.moveLeft=new o("KeyA"),this.moveDown=new o("KeyS"),this.moveRight=new o("KeyD"),this.hit=new o("KeyF"),this.drop=new o("KeyQ"),this.inventory=new o("KeyI"),this.digit1=new o("Digit1"),this.digit2=new o("Digit2"),this.digit3=new o("Digit3"),this.digit4=new o("Digit4"),this.digit5=new o("Digit5"),this.digit6=new o("Digit6"),this.digit7=new o("Digit7"),this.digit8=new o("Digit8"),this.digit9=new o("Digit9"),this.digit0=new o("Digit0"),this.P={};for(const t of Object.getOwnPropertyNames(this)){const s=this[t];s&&s instanceof o&&(this.P[s.code]=s)}window.addEventListener("keydown",this.keydown.bind(this)),window.addEventListener("keyup",this.keyup.bind(this))}digit(t){switch(t){case 1:return this.digit1;case 2:return this.digit2;case 3:return this.digit3;case 4:return this.digit4;case 5:return this.digit5;case 6:return this.digit6;case 7:return this.digit7;case 8:return this.digit8;case 9:return this.digit9;case 0:return this.digit0}}reset(){var t;for(const s of Object.getOwnPropertyNames(this.P))null===(t=this.P[s])||void 0===t||t.reset()}keydown(t){var s;null===(s=this.P[t.code])||void 0===s||s.keydown(t)}keyup(t){var s;null===(s=this.P[t.code])||void 0===s||s.keyup(t)}}var a=(t,s,i,h)=>new(i||(i=Promise))((e,n)=>{function r(t){try{l(h.next(t))}catch(t){n(t)}}function o(t){try{l(h.throw(t))}catch(t){n(t)}}function l(t){var s;t.done?e(t.value):(s=t.value,s instanceof i?s:new i(t=>{t(s)})).then(r,o)}l((h=h.apply(t,s||[])).next())});class c{constructor(t){this.I={},this.N={},this.loader=t}load(){return a(this,void 0,void 0,(function*(){return yield new Promise(t=>{this.loader.add("npc.json").add("dungeon.json").add("bonfire.json").add("dungeon.rules.json").add("dungeon.rules.4.json").add("dungeon.design.json").add("dialogs.json").add("alagard","fonts/alagard.fnt").add("big_egg_collect","sounds/big_egg_collect.{ogg,mp3}").add("fruit_collect","sounds/fruit_collect.{ogg,mp3}").add("select","sounds/select.{ogg,mp3}").add("confirm","sounds/confirm.{ogg,mp3}").add("cancel","sounds/cancel.{ogg,mp3}").add("text","sounds/text.{ogg,mp3}").add("boss_hit","sounds/boss_hit.{ogg,mp3}").add("hit_damage","sounds/hit_damage.{ogg,mp3}").load((s,i)=>{i["fonts/alagard.png"].texture.baseTexture.scaleMode=h.SCALE_MODES.NEAREST,this.add(i["npc.json"].spritesheet),this.add(i["dungeon.json"].spritesheet),this.add(i["bonfire.json"].spritesheet),t()})})}))}add(t){t.baseTexture.scaleMode=h.SCALE_MODES.NEAREST;for(let s of Object.keys(t.textures))this.I[s]=t.textures[s];for(let s of Object.keys(t.animations))this.N[s]=t.animations[s]}sprite(t,s={}){if(this.I[t])return this.fixed(t);if(this.N[t])return this.animated(t,s);throw"sprite or animation not found: "+t}fixed(t){if(!this.I[t])throw"sprite not found: "+t;const s=new h.Sprite(this.I[t]);return s.name=t,s}animated(t,s={}){if(!this.N[t])throw"animation not found: "+t;const i=new h.AnimatedSprite(this.N[t]);return i.name=t,i.autoUpdate=void 0===s.autoUpdate||s.autoUpdate,i.animationSpeed=void 0!==s.animationSpeed?s.animationSpeed:.2,i.loop=void 0===s.loop||s.loop,(void 0===s.play||s.play)&&i.play(),i}}class u{constructor(t){this.R=t}init(){this.renderTitle(),this.renderHelp(),this.R.app.ticker.add(this.handleInput,this)}destroy(){this.R.app.ticker.remove(this.handleInput,this),this.R.stage.removeChildren()}pause(){}resume(){}renderTitle(){let t=new h.BitmapText("ROGUELIKE DUNGEON",{font:{name:"alagard",size:64}});t.anchor=new h.Point(.5,0),t.position.set(this.R.app.screen.width>>1,64),this.R.stage.addChild(t);let s=new h.BitmapText("YOU DEAD",{font:{name:"alagard",size:128},tint:16711680});s.anchor=.5,s.position.set(this.R.app.screen.width>>1,256),this.R.stage.addChild(s)}renderHelp(){const t=new h.BitmapText("PRESS F TO RESTART",{font:{name:"alagard",size:32}});t.anchor=.5,t.position.set(this.R.app.screen.width>>1,this.R.app.screen.height-64),this.R.stage.addChild(t)}handleInput(){this.R.joystick.hit.once()&&this.R.selectHero()}}class f{constructor(t){this.spriteName="coin",this.C=t.range(1,30)}pickedUp(t){return t.addCoins(this.C),!0}}class d{constructor(){this.spriteName="flask_red.png",this.L=2}info(){return{name:"Health flask",health:this.L,buyPrice:100}}pickedUp(t){return t.inventory.add(this)}same(t){return t instanceof d}use(t,s){s.heal(this.L),t.decrease()}}class w{constructor(){this.spriteName="flask_big_red.png",this.L=5}info(){return{name:"Big health flask",health:this.L,buyPrice:300}}pickedUp(t){return t.inventory.add(this)}same(t){return t instanceof w}use(t,s){s.heal(this.L),t.decrease()}}const p={idle:{angle:[{time:0,args:[0]}],pos:[{time:0,args:[-1,0]},{time:1,args:[-1,1]},{time:2,args:[-1,2]},{time:3,args:[-1,1]}]},run:{angle:[{time:0,args:[0]}],pos:[{time:0,args:[-1,-1]},{time:1,args:[-1,-2]},{time:2,args:[-1,-1]},{time:3,args:[-1,0]}]},hit:{angle:[{time:0,args:[0]},{time:1.5,args:[-30]},{time:2,args:[120]},{time:3,args:[90]},{time:4,args:[0]}],pos:[{time:0,args:[-1,0]},{time:1,args:[-1,0]},{time:2,args:[-1,0]},{time:3,args:[-1,0]}]}},g={knife:{idle:p.idle,run:p.run,hit:{angle:[{time:0,args:[90]}],pos:[{time:0,args:[-8,-4]},{time:1,args:[-4,-4]},{time:2,args:[4,-4]},{time:3,args:[-2,-4]}]}},rusty_sword:p,regular_sword:p,red_gem_sword:p,hammer:p,big_hammer:p,baton_with_spikes:p,mace:p,katana:p,saw_sword:p,anime_sword:p,axe:p,machete:p,cleaver:p,duel_sword:p,knight_sword:p,golden_sword:p,lavish_sword:p},m={knife:{name:"weapon_knife",speed:1.4,distance:1,damage:2,level:1,price:12,animations:g.knife},rusty_sword:{name:"weapon_rusty_sword",speed:1,distance:1,damage:4,level:1,price:15,animations:g.rusty_sword},regular_sword:{name:"weapon_regular_sword",speed:1,distance:1,damage:5,level:3,price:20,animations:g.regular_sword},red_gem_sword:{name:"weapon_red_gem_sword",speed:1,distance:1,damage:6,level:3,price:30,animations:g.red_gem_sword},hammer:{name:"weapon_hammer",speed:.7,distance:1,damage:7,level:5,price:38,animations:g.hammer},big_hammer:{name:"weapon_big_hammer",speed:.5,distance:2,damage:10,level:5,price:40,animations:g.big_hammer},baton_with_spikes:{name:"weapon_baton_with_spikes",speed:.6,distance:1,damage:7,level:5,price:42,animations:g.baton_with_spikes},mace:{name:"weapon_mace",speed:.6,distance:1,damage:7,level:5,price:45,animations:g.mace},katana:{name:"weapon_katana",speed:1.5,distance:1,damage:8,level:7,price:100,animations:g.katana},saw_sword:{name:"weapon_saw_sword",speed:1.5,distance:1,damage:9,level:7,price:110,animations:g.saw_sword},anime_sword:{name:"weapon_anime_sword",speed:.7,distance:1,damage:12,level:7,price:130,animations:g.anime_sword},axe:{name:"weapon_axe",speed:.8,distance:1,damage:12,level:7,price:115,animations:g.axe},machete:{name:"weapon_machete",speed:1,distance:1,damage:11,level:9,price:150,animations:g.machete},cleaver:{name:"weapon_cleaver",speed:1,distance:1,damage:12,level:9,price:160,animations:g.cleaver},duel_sword:{name:"weapon_duel_sword",speed:1.5,distance:1,damage:13,level:9,price:170,animations:g.duel_sword},knight_sword:{name:"weapon_knight_sword",speed:1.5,distance:1,damage:14,level:9,price:180,animations:g.knight_sword},golden_sword:{name:"weapon_golden_sword",speed:1.5,distance:1,damage:15,level:11,price:220,animations:g.golden_sword},lavish_sword:{name:"weapon_lavish_sword",speed:1.5,distance:1,damage:16,level:11,price:240,animations:g.lavish_sword}},y=Object.getOwnPropertyNames(m).map(t=>m[t]),v={knife:{name:"weapon_knife",speed:.7,distance:1,damage:.5,level:1,price:0,animations:g.knife},baton_with_spikes:{name:"weapon_baton_with_spikes",speed:.3,distance:1,damage:3,level:5,price:0,animations:g.baton_with_spikes},anime_sword:{name:"weapon_anime_sword",speed:.4,distance:1,damage:4,level:10,price:0,animations:g.anime_sword},big_hammer:{name:"weapon_big_hammer",speed:.3,distance:2,damage:5,level:15,price:0,animations:g.big_hammer},mace:{name:"weapon_mace",speed:.6,distance:1,damage:6,level:20,price:0,animations:g.mace},cleaver:{name:"weapon_cleaver",speed:.5,distance:1,damage:7,level:25,price:0,animations:g.cleaver}},_={knife:{name:"weapon_knife",speed:1.4,distance:1,damage:2,level:1,price:12,animations:g.knife},hammer:{name:"weapon_hammer",speed:.7,distance:1,damage:7,level:5,price:38,animations:g.hammer},cleaver:{name:"weapon_cleaver",speed:1,distance:1,damage:12,level:9,price:160,animations:g.cleaver},axe:{name:"weapon_axe",speed:.8,distance:1,damage:12,level:7,price:115,animations:g.axe},regular_sword:{name:"weapon_regular_sword",speed:1,distance:1,damage:5,level:3,price:20,animations:g.regular_sword},knight_sword:{name:"weapon_knight_sword",speed:1.5,distance:1,damage:14,level:9,price:180,animations:g.knight_sword}};class b{constructor(t){this.A=t.name,this.speed=t.speed,this.distance=t.distance,this.damage=t.damage,this.$=t.price,this.animations=t.animations}get spriteName(){return this.A+".png"}info(){return{name:this.A.replace(/weapon_/,""),speed:this.speed,distance:this.distance,damage:this.damage,sellPrice:this.$,buyPrice:10*this.$}}pickedUp(t){return t.inventory.add(this)}same(t){return!1}use(t){t.equip()}static create(t,s){const i=y.filter(t=>t.level<=s);if(i.length>0){const s=t.select(i);return new b(s)}return null}static select(t,s){if(s.length>0){const i=t.select(s);return new b(i)}return null}}class x{constructor(t,s){this.begin=!1,this.angle=0,this.point=t,this.segment=s}}var k;(t=>{t[t.NORMAL=0]="NORMAL",t[t.TOP=1]="TOP"})(k||(k={}));class M{constructor(t,s,i){this.distance=0,this.p1=new x(t,this),this.p2=new x(s,this),this.type=i}toString(){const t=this.p1.point,s=this.p2.point;return`[${t.x}:${t.y} - ${s.x}:${s.y}]`}}class D{constructor(){this.B=[],this.U=[],this.H=new h.Point(0,0),this.F=500}init(){this.B=[],this.U=[],this.H=new h.Point(0,0)}addSegment(t,s,i,e,n){const r=new h.Point(t,s),o=new h.Point(i,e),l=new M(r,o,n);this.B.push(l),this.U.push(l.p1),this.U.push(l.p2)}static deduplicated(t){const s=[];for(;t.length>0;){const i=t.pop(),h=[];for(let s=0;s<t.length;s++){let e=t[s],n=i.type===e.type,r=i.p1.point.equals(e.p1.point)&&i.p2.point.equals(e.p2.point);n&&r&&h.push(s)}for(let s of h)t.splice(s,1);s.push(i)}return s}static connected(t){const s=[];for(let i=0;i<t.length;i++){let h=t[i],e=!1,n=!1;for(let r=0;r<t.length;r++){if(r==i)continue;let o=t[r];if((!h.p1.point.equals(o.p1.point)||!h.p2.point.equals(o.p2.point))&&(e||!h.p1.point.equals(o.p1.point)&&!h.p1.point.equals(o.p2.point)||(e=!0),n||!h.p2.point.equals(o.p1.point)&&!h.p2.point.equals(o.p2.point)||(n=!0),e&&n)){s.push(h);break}}}return s}static filtered(t){const s=[],i=[],h=[[0,12,0,16],[5,12,5,16],[0,12,5,12],[0,0,5,0],[11,12,11,16],[11,12,16,12],[11,0,16,0]],e=t=>{const s=t.p1.point.x%16,i=t.p1.point.y%16,e=t.p2.point.x-t.p1.point.x+s,n=t.p2.point.y-t.p1.point.y+i;for(let[t,r,o,l]of h)if(t===s&&r===i&&o===e&&l===n)return!0;return!1};for(const h of t)e(h)?i.push(h):s.push(h);for(;i.length>0;){const t=i.pop(),h=[t],e=[t.p1.point,t.p2.point],n=[1,1],r=[];for(let t=0;t<2;t++)for(let t=0;t<i.length;t++){if(r.indexOf(t)>=0)continue;let s=i[t];const o=s.p1.point,l=s.p2.point;let a=!1,c=!1;for(let t=0;t<e.length;t++){let s=e[t];s.equals(o)?(a=!0,n[t]++):s.equals(l)&&(c=!0,n[t]++)}(a||c)&&(r.push(t),h.push(s),a||(e.push(o),n.push(1)),c||(e.push(l),n.push(1)))}if(4===n.length&&n.every(t=>2===t)){let t=0,e=0;for(let s=0;s<4;s++){let i=h[s];i.p1.point.y===i.p2.point.y&&i.p1.point.y>e&&(t=s,e=i.p1.point.y)}for(let t of r.reverse())i.splice(t,1);h.splice(t,1),s.push(...h)}else s.push(t)}return s}static merge(t){const s=[];for(;t.length>0;){const i=t.pop();let h=null;for(let s=0;s<t.length;s++){let e=t[s];if(i.type===e.type){if(i.p2.point.equals(e.p1.point)){t.splice(s,1),h=[i,e];break}if(e.p2.point.equals(i.p1.point)){t.splice(s,1),h=[e,i];break}}}if(h){const[s,i]=h;t.push(new M(s.p1.point,i.p2.point,s.type))}else s.push(i)}return s}optimize(){const t=D.deduplicated([...this.B]),s=D.connected(t),i=D.filtered(s),h=D.connected(i),e=[...D.merge(h.filter(t=>t.p1.point.x===t.p2.point.x)),...D.merge(h.filter(t=>t.p1.point.y===t.p2.point.y))];this.B=[],this.U=[];for(const t of e)this.B.push(t),this.U.push(t.p1),this.U.push(t.p2)}setLightLocation(t,s,i){this.H.x=t,this.H.y=s,this.F=i,this.U=[];for(const h of this.B){let e=.5*(h.p1.point.x+h.p2.point.x)-t,n=.5*(h.p1.point.y+h.p2.point.y)-s;if(h.distance=Math.sqrt(e*e+n*n),h.distance<i){h.p1.angle=Math.atan2(h.p1.point.y-s,h.p1.point.x-t),h.p2.angle=Math.atan2(h.p2.point.y-s,h.p2.point.x-t);let i=h.p2.angle-h.p1.angle;i<=-Math.PI&&(i+=2*Math.PI),i>Math.PI&&(i-=2*Math.PI),h.p1.begin=i>0,h.p2.begin=!h.p1.begin,this.U.push(h.p1,h.p2)}}this.U.sort(D.compare)}static compare(t,s){return t.angle>s.angle?1:t.angle<s.angle?-1:!t.begin&&s.begin?1:t.begin&&!s.begin?-1:0}static leftOf(t,s){return(t.p2.point.x-t.p1.point.x)*(s.y-t.p1.point.y)-(t.p2.point.y-t.p1.point.y)*(s.x-t.p1.point.x)<0}static interpolate(t,s,i){return new h.Point(t.x*(1-i)+s.x*i,t.y*(1-i)+s.y*i)}static segmentInFrontOf(t,s,i){const h=D.leftOf(t,D.interpolate(s.p1.point,s.p2.point,.01)),e=D.leftOf(t,D.interpolate(s.p2.point,s.p1.point,.01)),n=D.leftOf(t,i),r=D.leftOf(s,D.interpolate(t.p1.point,t.p2.point,.01)),o=D.leftOf(s,D.interpolate(t.p2.point,t.p1.point,.01)),l=D.leftOf(s,i);return r==o&&o!=l||h==e&&e==n}sweep(){const t=[],s=[];let i=0;for(let h=0;h<=2;h++)for(const e of this.U){let n=0===s.length?null:s[0];if(e.begin){let t=0,i=s[t];for(;null!=i&&D.segmentInFrontOf(e.segment,i,this.H);)t++,i=s[t];null==i?s.push(e.segment):s.splice(t,0,e.segment)}else for(let t=0;t<s.length;t++)s[t]===e.segment&&s.splice(t,1);n!==(0===s.length?null:s[0])&&(1==h&&this.addTriangle(i,e.angle,n,t),i=e.angle)}const h=[...t],e=[];for(;h.length>0;){if(h.length>=2){const[t,s]=h;if(t.equals(s)){h.shift();continue}}const t=h.shift();e.push(t)}const n=[];for(;e.length>0;){if(e.length>=3){const[t,s,i]=e;if(t.x===s.x&&t.x===i.x){e.splice(1,1);continue}}const t=e.shift();n.push(t)}return n}static lineIntersection(t,s,i,e){const n=(e.x-i.x)*(t.y-i.y)-(e.y-i.y)*(t.x-i.x),r=(e.y-i.y)*(s.x-t.x)-(e.x-i.x)*(s.y-t.y);if(0===r)return null;const o=n/r;return new h.Point(t.x+o*(s.x-t.x),t.y+o*(s.y-t.y))}addTriangle(t,s,i,e){const n=Math.cos(t),r=Math.sin(t),o=Math.cos(s),l=Math.sin(s);let a=this.H,c=new h.Point(this.H.x+n,this.H.y+r),u=new h.Point(0,0),f=new h.Point(0,0);null!=i?(u.x=i.p1.point.x,u.y=i.p1.point.y,f.x=i.p2.point.x,f.y=i.p2.point.y):(u.x=this.H.x+n*this.F,u.y=this.H.y+r*this.F,f.x=this.H.x+o*this.F,f.y=this.H.y+l*this.F);let d=D.lineIntersection(u,f,a,c);if(null===d)return;d.x=Math.round(d.x),d.y=Math.round(d.y),c.x=this.H.x+o,c.y=this.H.y+l;let w=D.lineIntersection(u,f,a,c);if(null!==w)if(w.x=Math.round(w.x),w.y=Math.round(w.y),null!=i)switch(i.type){case k.TOP:e.push(d),e.push(new h.Point(d.x,d.y-16)),e.push(new h.Point(w.x,w.y-16)),e.push(w);break;case k.NORMAL:e.push(d),e.push(w)}else e.push(d),e.push(w)}debug(){const t=document.createElement("canvas");t.width=1280,t.height=1280;const s=t.getContext("2d");s.fillRect(0,0,1280,1280),s.scale(1,1);const i=new Path2D;for(let t of this.B){const s=t.p1.point,h=t.p2.point;i.moveTo(s.x,s.y),i.lineTo(h.x,h.y)}s.strokeStyle="rgba(255,0,0,0.5)",s.stroke(i)}}class O{constructor(t){this.j=[],this.G={default:[{x1:0,y1:12,x2:16,y2:12,type:k.NORMAL},{x1:0,y1:12,x2:0,y2:16,type:k.NORMAL},{x1:16,y1:12,x2:16,y2:16,type:k.NORMAL}],top:[{x1:0,y1:0,x2:16,y2:0,type:k.TOP}],left:[{x1:0,y1:0,x2:0,y2:12,type:k.NORMAL}],right:[{x1:16,y1:0,x2:16,y2:12,type:k.NORMAL}],bottom:[]},this.W={default:[{x1:11,y1:0,x2:11,y2:16,type:k.NORMAL},{x1:11,y1:0,x2:16,y2:0,type:k.NORMAL},{x1:11,y1:16,x2:16,y2:16,type:k.TOP}],top:[{x1:0,y1:0,x2:11,y2:0,type:k.TOP}],left:[{x1:0,y1:0,x2:0,y2:16,type:k.NORMAL}],right:[],bottom:[{x1:0,y1:16,x2:11,y2:16,type:k.NORMAL}]},this.K={default:[{x1:5,y1:0,x2:5,y2:16,type:k.NORMAL},{x1:0,y1:0,x2:5,y2:0,type:k.NORMAL},{x1:0,y1:16,x2:5,y2:16,type:k.TOP}],top:[{x1:5,y1:0,x2:16,y2:0,type:k.TOP}],left:[],right:[{x1:16,y1:0,x2:16,y2:16,type:k.NORMAL}],bottom:[{x1:5,y1:16,x2:16,y2:16,type:k.NORMAL}]},this.X={default:[{x1:5,y1:0,x2:5,y2:12,type:k.NORMAL},{x1:5,y1:12,x2:16,y2:12,type:k.NORMAL},{x1:16,y1:12,x2:16,y2:16,type:k.NORMAL}],top:[{x1:5,y1:0,x2:16,y2:0,type:k.TOP}],left:[],right:[{x1:16,y1:0,x2:16,y2:12,type:k.NORMAL}],bottom:[]},this.q={default:[{x1:11,y1:0,x2:11,y2:12,type:k.NORMAL},{x1:0,y1:12,x2:11,y2:12,type:k.NORMAL},{x1:0,y1:12,x2:0,y2:16,type:k.NORMAL}],top:[{x1:0,y1:0,x2:11,y2:0,type:k.TOP}],left:[{x1:0,y1:0,x2:0,y2:12,type:k.NORMAL}],right:[],bottom:[]},this.J={default:[],top:[{x1:0,y1:0,x2:16,y2:0,type:k.TOP}],left:[{x1:0,y1:0,x2:0,y2:16,type:k.NORMAL}],right:[{x1:16,y1:0,x2:16,y2:16,type:k.NORMAL}],bottom:[{x1:0,y1:16,x2:16,y2:16,type:k.NORMAL}]},this.V={"wall_top_mid.png":this.G,"wall_side_front_left.png":this.W,"wall_side_front_right.png":this.K,"wall_side_mid_left.png":this.W,"wall_side_mid_right.png":this.K,"wall_side_top_left.png":{default:[{x1:11,y1:12,x2:16,y2:12,type:k.NORMAL},{x1:11,y1:12,x2:11,y2:16,type:k.NORMAL}],top:[{x1:0,y1:0,x2:16,y2:0,type:k.TOP}],left:[{x1:0,y1:0,x2:0,y2:16,type:k.NORMAL}],right:[{x1:16,y1:0,x2:16,y2:12,type:k.NORMAL}],bottom:[{x1:0,y1:16,x2:11,y2:16,type:k.NORMAL}]},"wall_side_top_right.png":{default:[{x1:0,y1:12,x2:5,y2:12,type:k.NORMAL},{x1:5,y1:12,x2:5,y2:16,type:k.NORMAL}],top:[{x1:0,y1:0,x2:16,y2:0,type:k.TOP}],left:[{x1:0,y1:12,x2:0,y2:16,type:k.NORMAL}],right:[{x1:16,y1:0,x2:16,y2:16,type:k.NORMAL}],bottom:[{x1:5,y1:16,x2:16,y2:16,type:k.NORMAL}]},"wall_inner_corner_t_top_left.png":this.G,"wall_inner_corner_t_top_right.png":this.G,"wall_inner_corner_l_top_left.png":this.X,"wall_inner_corner_l_top_right.png":this.q,"wall_corner_bottom_left.png":this.X,"wall_corner_bottom_right.png":this.q,"wall_corner_top_left.png":this.G,"wall_corner_top_right.png":this.G,"wall_fountain_top.png":{default:[{x1:0,y1:12,x2:0,y2:16,type:k.NORMAL},{x1:0,y1:12,x2:2,y2:12,type:k.NORMAL},{x1:2,y1:9,x2:2,y2:12,type:k.NORMAL},{x1:2,y1:9,x2:14,y2:9,type:k.NORMAL},{x1:14,y1:9,x2:14,y2:12,type:k.NORMAL},{x1:14,y1:12,x2:16,y2:12,type:k.NORMAL},{x1:16,y1:12,x2:16,y2:16,type:k.NORMAL}],top:[{x1:0,y1:0,x2:16,y2:0,type:k.TOP}],left:[{x1:0,y1:0,x2:0,y2:12,type:k.NORMAL}],right:[{x1:16,y1:0,x2:16,y2:12,type:k.NORMAL}],bottom:[]},"wall_one_top.png":this.G,"wall_one_corner_left.png":this.X,"wall_one_corner_right.png":this.q},this.Y=t,this.layer=new h.display.Layer,this.layer.useRenderTexture=!0,this.layer.on("display",t=>{t.blendMode=h.BLEND_MODES.MULTIPLY}),this.layer.clearColor=[0,0,0,1],this.container=new h.Container,this.layer.addChild(this.container),this.Z=O.gradient("white",150),this.tt=O.gradient("rgb(211,78,56)",50),this.st=O.gradient("rgb(86,152,204)",50),this.it=O.gradient("rgb(255,239,204)",100),this.ht=new D,this.Y.ticker.add(this.update,this)}destroy(){this.Y.ticker.remove(this.update,this),this.j.forEach(t=>t.destroy()),this.Z.destroy(),this.st.destroy(),this.tt.destroy(),this.it.destroy(),this.container.destroy(),this.layer.destroy()}loadMap(){this.ht.init();const t=this.Y;for(let s=0;s<t.height;s++)for(let i=0;i<t.width;i++){const e=t.cell(i,s);if(e.hasFloor){const n=new h.Point(16*i,16*s);switch(e.floorName){case"wall_fountain_basin_red":this.addLight(n,S.RED_BASIN);break;case"wall_fountain_basin_blue":this.addLight(n,S.BLUE_BASIN)}const r=s>0&&t.cell(i,s-1).hasFloor,o=s+1<t.height&&t.cell(i,s+1).hasFloor,l=i>0&&t.cell(i-1,s).hasFloor,a=i+1<t.width&&t.cell(i+1,s).hasFloor;let c;const u=e.wallName;c=u&&this.V[u]&&this.V[u]||this.J,this.add(i,s,c.default),r||this.add(i,s,c.top),o||this.add(i,s,c.bottom),l||this.add(i,s,c.left),a||this.add(i,s,c.right)}}this.ht.optimize(),this.update()}addLight(t,s){let i,h;switch(s){case S.HERO:i=this.Z,h=350;break;case S.RED_BASIN:i=this.tt,h=150;break;case S.BLUE_BASIN:i=this.st,h=150;break;case S.BONFIRE:i=this.it,h=250}const e=new P(t,h,i,this.container);this.j.push(e),this.renderLight(e)}add(t,s,i){for(let h of i)this.ht.addSegment(16*t+h.x1,16*s+h.y1,16*t+h.x2,16*s+h.y2,h.type)}update(){for(const t of this.j)t.dirty&&(this.renderLight(t),t.rendered())}renderLight(t){const s=new h.Point(t.position.x+8,t.position.y+8);this.ht.setLightLocation(s.x,s.y,t.maxDistance);const i=this.ht.sweep();t.sprite.position.set(s.x,s.y),t.mask.clear().beginFill(16777215).drawPolygon(i).endFill()}static gradient(t,s){const i=s<<1,e=document.createElement("canvas");e.width=i,e.height=i;const n=e.getContext("2d");if(n){const h=n.createRadialGradient(s,s,0,s,s,s);h.addColorStop(.1,t),h.addColorStop(1,"transparent"),n.fillStyle=h,n.fillRect(0,0,i,i)}return h.Texture.from(e)}}var S;(t=>{t[t.HERO=0]="HERO",t[t.RED_BASIN=1]="RED_BASIN",t[t.BLUE_BASIN=2]="BLUE_BASIN",t[t.BONFIRE=3]="BONFIRE"})(S||(S={}));class P{constructor(t,s,i,e){this.et=null,this.position=t,this.maxDistance=s,this.mask=new h.Graphics,this.mask.isMask=!0,this.sprite=new h.Sprite(i),this.sprite.anchor.set(.5,.5),this.sprite.mask=this.mask,this.sprite.blendMode=h.BLEND_MODES.ADD,e.addChild(this.mask),e.addChild(this.sprite)}get dirty(){return null===this.et||this.position.x!==this.et.x||this.position.y!==this.et.y}rendered(){this.et={x:this.position.x,y:this.position.y}}destroy(){this.sprite.destroy(),this.mask.destroy()}}const I=60,E=70,N=50,R=40,T=1,C=100,L=256;class A{constructor(t,s,i,e,n,r,o){this.scale=2,this.controller=t,this.ticker=s,this.rng=i,this.seed=e,this.level=n,this.width=r,this.height=o,this.nt=[];for(let t=0;t<this.width;t++){this.nt[t]=[];for(let s=0;s<this.height;s++)this.nt[t][s]=new $(this,s,t)}this.container=new h.Container,this.container.zIndex=0,this.container.sortableChildren=!0,this.container.scale.set(this.scale,this.scale),this.floorContainer=new h.Container,this.floorContainer.zIndex=T,this.floorContainer.sortableChildren=!1,this.floorContainer.cacheAsBitmap=!0,this.container.addChild(this.floorContainer),this.light=new O(this),this.light.layer.zIndex=1,this.light.container.scale.set(this.scale,this.scale),this.lighting=new h.Sprite(this.light.layer.getRenderTexture()),this.lighting.blendMode=h.BLEND_MODES.MULTIPLY,this.lighting.zIndex=2}destroy(){for(let t=0;t<this.height;t++)for(let s=0;s<this.width;s++)this.nt[t][s].destroy();this.lighting.destroy(),this.light.destroy(),this.container.destroy({children:!0})}log(t){}cell(t,s){return this.nt[s][t]}remove(t,s,i){for(let h=0;h<i.width;h++)for(let e=0;e<i.height;e++){const n=this.cell(t+h,s-e),r=n.object;r&&r===i&&(n.object=null)}}set(t,s,i){for(let h=0;h<i.width;h++)for(let e=0;e<i.height;e++)this.cell(t+h,s-e).object=i}available(t,s,i){for(let h=0;h<i.width;h++)for(let e=0;e<i.height;e++){const n=this.cell(t+h,s-e);if(!n.hasFloor||n.collide(i))return!1}return!0}camera(t,s){const i=this.controller.app.screen.width,h=this.controller.app.screen.height,e=(i>>1)-t*this.scale,n=(h>>1)-s*this.scale;this.container.position.set(e,n),this.light.container.position.set(e,n)}sprite(t,s,i){const h=this.controller.resources.sprite(i);return h.position.set(16*t,16*s),this.container.addChild(h),h}animated(t,s,i){const h=this.controller.resources.animated(i);return h.position.set(16*t,16*s),h.play(),this.container.addChild(h),h}}class ${constructor(t,s,i){this.rt=null,this.ot=null,this.lt=null,this.at=null,this.Y=t,this.x=s,this.y=i}destroy(){var t,s,i,h;null===(t=this.rt)||void 0===t||t.destroy(),this.rt=null,null===(s=this.ot)||void 0===s||s.destroy(),this.ot=null,null===(i=this.lt)||void 0===i||i.destroy(),this.lt=null,null===(h=this.at)||void 0===h||h.destroy(),this.at=null}set floorName(t){var s;null===(s=this.rt)||void 0===s||s.destroy(),this.rt=null,t&&(this.rt=new B(this.Y,this.x,this.y,t))}get floorName(){var t;return(null===(t=this.rt)||void 0===t?void 0:t.name)||null}get floor(){return this.rt}get hasFloor(){return!!this.rt}get wallName(){var t;return(null===(t=this.ot)||void 0===t?void 0:t.name)||null}set wallName(t){var s;null===(s=this.ot)||void 0===s||s.destroy(),this.ot=null,t&&(this.ot=new H(this.Y,this.x,this.y,t))}get wall(){return this.ot}set dropItem(t){var s;null===(s=this.lt)||void 0===s||s.destroy(),this.lt=null,t&&(this.lt=new F(this.Y,this.x,this.y,t))}get drop(){return this.lt}get hasDrop(){return!!this.lt}randomDrop(){const t=this.Y.rng;let s=50*t.float();return(s-=10)<=0?this.dropItem=b.create(t,this.Y.level):(s-=10)<=0?this.dropItem=new w:(s-=10)<=0?this.dropItem=new d:s-20<=0&&(this.dropItem=new f(t)),this.hasDrop}get object(){return this.at}set object(t){if(t&&null!==this.at&&this.at!==t)throw"error while set char to cell";this.at=t}get hasObject(){return null!=this.at}ladder(){var t;null===(t=this.rt)||void 0===t||t.destroy(),this.rt=new U(this.Y,this.x,this.y)}get interacting(){var t,s,i,h;return(null===(t=this.rt)||void 0===t?void 0:t.interacting)||(null===(s=this.ot)||void 0===s?void 0:s.interacting)||(null===(i=this.lt)||void 0===i?void 0:i.interacting)||(null===(h=this.at)||void 0===h?void 0:h.interacting)||!1}interact(t){this.at&&this.at.interacting?this.at.interact(t):this.lt&&this.lt.interacting?this.lt.interact(t):this.ot&&this.ot.interacting?this.ot.interact(t):this.rt&&this.rt.interacting&&this.rt.interact(t)}collide(t){return this.at&&this.at.collide(t)||this.ot&&this.ot.collide(t)||!1}}class z{constructor(t,s,i,e){this.height=1,this.width=1,this.static=!0,this.dungeon=t,this.x=s,this.y=i,this.name=e,this.sprite=this.dungeon.controller.resources.sprite(e),this.sprite.zIndex=T,this.sprite.position.set(16*s,16*i),this.sprite instanceof h.AnimatedSprite?this.dungeon.container.addChild(this.sprite):this.dungeon.floorContainer.addChild(this.sprite)}collide(t){return!1}destroy(){this.sprite.destroy()}}class B extends z{constructor(t,s,i,h){super(t,s,i,h),this.interacting=!1}interact(t){}}class U extends z{constructor(t,s,i){super(t,s,i,"floor_ladder.png"),this.interacting=!0}interact(t){this.dungeon.controller.updateHero(t.character,this.dungeon.level+1)}}class H{constructor(t,s,i,h){this.height=1,this.width=1,this.static=!0,this.interacting=!1,this.dungeon=t,this.x=s,this.y=i,this.name=h,this.sprite=t.sprite(s,i,h),this.sprite.zIndex=C+i*L}interact(t){}collide(t){return!this.dungeon.cell(this.x,this.y).hasFloor}destroy(){this.sprite.destroy()}}class F{constructor(t,s,i,h){this.height=1,this.width=1,this.static=!0,this.interacting=!1,this.dungeon=t,this.x=s,this.y=i,this.drop=h,this.ct=t.sprite(s,i,h.spriteName),this.ct.zIndex=N+i*L,this.ct.x+=8,this.ct.y+=14,this.ct.anchor.set(.5,1)}pickedUp(t){return!!this.drop.pickedUp(t)&&(this.dungeon.cell(this.x,this.y).dropItem=null,!0)}interact(t){}collide(t){return!1}destroy(){this.ct.destroy()}}class j extends h.Container{constructor(){super(),this.ut=new h.BitmapText("",{font:{name:"alagard",size:32}}),this.ut.anchor=.5,this.ut.position.set(0,16),this.addChild(this.ut)}set level(t){this.ut.text="LEVEL "+t}destroy(){this.ut.destroy()}}class G{constructor(t){this.ft=[],this.dt=t}set(t){this.dt=t;for(let t=this.ft.length-1;t>=0;t--){let s=this.ft[t];s.gc?this.ft.splice(t,1):s.send(this.dt)}}update(t){this.set(t(this.dt))}get(){return this.dt}subscribe(t,s){const i=new K(t,s);this.ft.push(i),i.send(this.dt)}unsubscribe(t,s){var i;null===(i=this.ft.find(i=>i.matches(t,s)))||void 0===i||i.unsubscribe()}}class W{constructor(){this.ft=[]}send(t){for(let s=this.ft.length-1;s>=0;s--){let i=this.ft[s];i.gc?this.ft.splice(s,1):i.send(t)}}subscribe(t,s){const i=new K(t,s);this.ft.push(i)}unsubscribe(t,s){var i;null===(i=this.ft.find(i=>i.matches(t,s)))||void 0===i||i.unsubscribe()}}class K{constructor(t,s){this.wt=!1,this.pt=t,this.gt=s||null}get gc(){return this.wt}matches(t,s){return this.pt===t&&this.gt===s}send(t){this.gt?this.pt.call(this.gt,t):this.pt(t)}unsubscribe(){this.wt=!0}}var X;(t=>{t[t.Manhattan=0]="Manhattan",t[t.Euclidean=1]="Euclidean",t[t.Chebyshev=2]="Chebyshev",t[t.Octile=3]="Octile"})(X||(X={}));class q{constructor(t,s){this.g=0,this.h=0,this.f=0,this.parent=t,this.position=s}equal(t){return this.position.equals(t.position)}}class J{constructor(t,s,i=!0,h=!1,e=!1,n=X.Chebyshev,r=1){this.yt=[],this.vt=1,this._width=t,this._height=s,this._t=i,this.bt=h,this.xt=e,this.kt=n,this.vt=r;for(let i=0;i<t;i++){const t=[];this.yt.push(t);for(let i=0;i<s;i++)t.push(1)}}clear(t,s){this.yt[t][s]=0}mark(t,s){this.yt[t][s]=1}find(t,s){let i=new q(null,t),e=new q(null,s),n=[],r=[];for(n.push(i);n.length>0;){let t=n[0],s=0;for(let i=1;i<n.length;i++){let h=n[i];h.f<t.f&&(t=h,s=i)}if(n.splice(s,1),r.push(t),t.equal(e)){const s=[];let i;for(i=this.xt?t:t.parent;null!==i.parent;)s.push(i.position),i=i.parent;return this.bt&&s.push(i.position),s.reverse()}const i=[],o=this._t?J.adjacentSquaresDiagonal:J.adjacentSquares;for(let s=0;s<o.length;s++){let e=o[s],n=new h.Point(t.position.x+e.x,t.position.y+e.y);if(n.x>=this._width||n.x<0||n.y>=this._height||n.y<0)continue;if(0!=this.yt[n.x][n.y])continue;let r=new q(t,n);i.push(r)}for(let s=0;s<i.length;s++){let h=i[s];null==r.find(t=>t.equal(h))&&(h.g=t.g+1,h.h=this.heuristicFunction(h.position,e.position),h.f=h.g+h.h,null==n.find(t=>t.equal(h))&&n.push(h))}}return[]}heuristicFunction(t,s){let i=Math.abs(s.x-t.x),h=Math.abs(s.y-t.y);switch(this.kt){case X.Manhattan:return(i+h)*this.vt;case X.Euclidean:return Math.sqrt(i*i+h*h)*this.vt;case X.Chebyshev:return Math.max(i,h)*this.vt;case X.Octile:return(i+h-.58*Math.min(i,h))*this.vt}}}J.adjacentSquares=[new h.Point(0,-1),new h.Point(0,1),new h.Point(-1,0),new h.Point(1,0)],J.adjacentSquaresDiagonal=[new h.Point(0,-1),new h.Point(0,1),new h.Point(-1,0),new h.Point(1,0),new h.Point(-1,-1),new h.Point(-1,1),new h.Point(1,-1),new h.Point(1,1)];const V=2105376,Y=5263440,Q=4210752,Z=16711680,tt=12557824,st=4,it=16;class ht extends h.Container{constructor(t){super(),this.Mt=!1,this._width=t.width||200,this._height=t.height||24,this.Dt=t.textSize||16,this.Ot=new h.Graphics,this.St=new h.BitmapText(t.label,{font:{name:"alagard",size:this.Dt}}),this.St.anchor=new h.Point(.5,.5),this.St.position.set(this._width>>1,this._height>>1),this.selected=t.selected||!1,super.addChild(this.Ot,this.St)}get selected(){return this.Mt}set selected(t){this.Mt=t,this.Ot.clear().beginFill(V).drawRect(0,0,this._width,this._height).endFill().beginFill(t?Y:Q).drawRect(st,st,this._width-2*st,this._height-2*st).endFill()}}class et{constructor(){this.Pt=0,this.It=0,this.Et=0,this.Nt=0}commit(){this.Pt=this.Et,this.It=this.Nt}reset(){this.Et=this.Pt,this.Nt=this.It}offset(t,s){this.Et+=t,this.Nt+=s}get x(){return this.Et}get y(){return this.Nt}}function nt(t,s){const i=s||0;if(t[i]>0)return i;const h=function(t,s){for(let i=s-1;i>=0;i--)if(t[i]>0)return i;return null}(t,i);if(null!==h)return h;const e=function(t,s){for(let i=s+1;i<t.length;i++)if(t[i]>0)return i;return null}(t,i);return null!==e?e:null}class rt{constructor(t){this.nt=[],this.Rt=[],this.Tt=[],this.Ct=-1,this.Lt=-1,this.At=null,this.$t=null,this.zt=t}reset(){if(this.unmark(),this.At=nt(this.Rt,this.At),this.$t=nt(this.Tt,this.$t),null===this.At||null===this.$t)this.At=null,this.$t=null;else if(!this.cell(this.At,this.$t).isSelectable){const t=this.$t,s=(s=>{for(let i=s-1;i>=0;i--)if(this.cell(i,t).isSelectable)return i;return null})(this.At);if(null!==s)this.At=s;else{const s=(s=>{for(let i=s+1;i<=this.Ct;i++)if(this.cell(i,t).isSelectable)return i;return null})(this.At);if(null===s)throw"illegal state";this.At=s}}this.mark()}moveLeft(){var t;if(this.unmark(),null!==this.At&&null!==this.$t){const s=this.$t;if(0===this.Tt[s])throw"illegal state: empty column "+s;const i=null===(t=this.selectedCell)||void 0===t?void 0:t.merged,h=this.At,e=t=>t>0?t-1:this.Ct;for(let t=e(h);t!=h;t=e(t))if(!(null==i?void 0:i.contains(t,s))&&this.cell(t,s).isSelectable){this.At=t;break}}this.mark()}moveRight(){var t;if(this.unmark(),null!==this.At&&null!==this.$t){const s=this.$t;if(0===this.Tt[s])throw"illegal state: empty column "+s;const i=null===(t=this.selectedCell)||void 0===t?void 0:t.merged,h=this.At,e=t=>(t+1)%(this.Ct+1);for(let t=e(h);t!=h;t=e(t))if(!(null==i?void 0:i.contains(t,s))&&this.cell(t,s).isSelectable){this.At=t;break}}this.mark()}moveUp(){var t;if(this.unmark(),null!==this.At&&null!==this.$t){const s=this.At;if(0===this.Rt[s])throw"illegal state: empty row "+s;const i=null===(t=this.selectedCell)||void 0===t?void 0:t.merged,h=this.$t,e=t=>t>0?t-1:this.Lt;for(let t=e(h);t!=h;t=e(t))if(!(null==i?void 0:i.contains(s,t))&&this.cell(s,t).isSelectable){this.$t=t;break}}this.mark()}moveDown(){var t;if(this.unmark(),null!==this.At&&null!==this.$t){const s=this.At;if(0===this.Rt[s])throw"illegal state: empty row "+s;const i=null===(t=this.selectedCell)||void 0===t?void 0:t.merged,h=this.$t,e=t=>(t+1)%(this.Lt+1);for(let t=e(h);t!=h;t=e(t))if(!(null==i?void 0:i.contains(s,t))&&this.cell(s,t).isSelectable){this.$t=t;break}}this.mark()}unmark(){var t;null===(t=this.selectedCell)||void 0===t||t.unmark()}mark(){var t;null===(t=this.selectedCell)||void 0===t||t.mark()}get selected(){var t;return(null===(t=this.selectedCell)||void 0===t?void 0:t.value)||null}get selectedCell(){if(null!==this.At&&null!==this.$t){const t=this.cell(this.At,this.$t);return t.merged&&t.isRef?this.cell(t.merged.from_x,t.merged.from_y):t}return null}set(t,s,i,h){if(t<0||s<0)throw`illegal coordinate: ${t}:${s}`;const e=this.cell(t,s);if(e.isRef)throw`cell is ref: ${t}:${s}`;const n=null!==e.value;if(e.value=[i,h],!n)if(e.merged){const t=e.merged;for(let s=t.from_x;s<=t.to_x;s++)for(let i=t.from_y;i<=t.to_y;i++)this.Rt[s]++,this.Tt[i]++}else this.Rt[t]++,this.Tt[s]++;this.reset()}merge(t,s,i,h){if(t<0||s<0)throw`illegal coordinate: ${t}:${s}`;if(i<1||h<1)throw`illegal size: ${i}:${h}`;const e=new lt(t,s,t+i-1,s+h-1),n=this.cell(t,s);if(n.isRef)throw`cell is ref: ${t}:${s}`;if(n.merged)throw"cell is merged: "+JSON.stringify(n.merged);n.merged=e;const r=null!==n.value;for(let i=e.from_x;i<=e.to_x;i++)for(let h=e.from_y;h<=e.to_y;h++)if(i!==t||h!==s){const t=this.cell(i,h);if(t.value)throw`merging cell already has value: ${i}:${h}`;if(t.isRef)throw`merging cell is ref: ${i}:${h}`;t.merged=e,r&&(this.Rt[i]++,this.Tt[h]++)}}remove(t,s){if(t<0||s<0)throw`illegal coordinate: ${t}:${s}`;const i=this.cell(t,s);if(i.isRef)throw`cell is ref: ${t}:${s}`;if(i.value)if(i.value=null,i.merged){const t=i.merged;for(let s=t.from_x;s<=t.to_x;s++)for(let i=t.from_y;i<=t.to_y;i++)this.Rt[s]--,this.Tt[i]--}else this.Rt[t]--,this.Tt[s]--}unmerge(t,s){if(t<0||s<0)throw`illegal coordinate: ${t}:${s}`;const i=this.cell(t,s);if(i.isRef)throw`cell is ref: ${t}:${s}`;if(i.merged){const h=null!==i.value,e=i.merged;i.merged=null;for(let i=e.from_x;i<=e.to_x;i++)for(let n=e.from_y;n<=e.to_y;n++)i===t&&n===s||(this.cell(i,n).merged=null,h&&(this.Rt[i]--,this.Tt[n]--))}}cell(t,s){if(t<0||s<0)throw"illegal coordinate";return this.expand(t,s),this.nt[s][t]}expand(t,s){for(;this.Lt<s;){this.Lt++,this.Tt[this.Lt]=0,this.nt[this.Lt]=[];for(let t=0;t<=this.Ct;t++)this.nt[this.Lt][t]=new ot(t,this.Lt)}for(;this.Ct<t;){this.Ct++,this.Rt[this.Ct]=0;for(let t=0;t<=this.Lt;t++)this.nt[t][this.Ct]=new ot(this.Ct,t)}}handleInput(){const t=this.zt;if(t.moveUp.once()&&this.moveUp(),t.moveDown.once()&&this.moveDown(),t.moveLeft.once()&&this.moveLeft(),t.moveRight.once()&&this.moveRight(),t.hit.once()){const t=this.selected;if(t){let[,s]=t;h.sound.play("confirm"),s()}else h.sound.play("cancel")}}}class ot{constructor(t,s){this.x=t,this.y=s,this.merged=null,this.value=null}unmark(){this.value&&(this.value[0].selected=!1)}mark(){this.value&&(this.value[0].selected=!0)}get isRef(){return null!==this.merged&&!(this.merged.from_x===this.x&&this.merged.from_y===this.y)}get isSelectable(){return null!==this.value||this.isRef}}class lt{constructor(t,s,i,h){this.from_x=t,this.from_y=s,this.to_x=i,this.to_y=h}contains(t,s){return t>=this.from_x&&t<=this.to_x&&s>=this.from_y&&s<=this.to_y}}class at extends h.Container{constructor(t={}){super(),this._width=0,this._height=0,this.Bt=!1,this.Ut=void 0!==t.spacing?t.spacing:it,this.Ht=void 0!==t.padding?t.padding:it,t.background?this.Ft=(new h.Graphics).beginFill(t.background.color).drawRect(0,0,1,1).endFill():this.Ft=new h.Container,this.addChild(this.Ft)}destroy(t){var s;super.destroy(t),null===(s=this.Ft)||void 0===s||s.destroy()}onChildrenChange(){this.Bt=!0}_calculateBounds(){this._bounds.addFrame(this.transform,0,0,this._width,this._height)}updateTransform(){this.Bt&&this.updateLayout(),super.updateTransform()}updateLayout(){let t=0,s=this.Ht,i=this.Ht,h=!0;for(let e of this.children){if(e===this.Ft)continue;h||(s+=this.Ut),h=!1,e.position.set(i,s);const n=e.getBounds();s+=n.height,t=Math.max(t,n.width)}this._height=s+this.Ht,this._width=t+2*this.Ht,this.Ft.width=this._width,this.Ft.height=this._height,this._calculateBounds(),this.Bt=!1}}class ct extends h.Container{constructor(t={}){super(),this._width=0,this._height=0,this.Bt=!1,this.Ut=void 0!==t.spacing?t.spacing:it,this.Ht=void 0!==t.padding?t.padding:it,t.background?this.Ft=(new h.Graphics).beginFill(t.background.color,t.background.alpha||1).drawRect(0,0,1,1).endFill():this.Ft=new h.Container,this.addChild(this.Ft)}destroy(t){var s;super.destroy(t),null===(s=this.Ft)||void 0===s||s.destroy()}onChildrenChange(){this.Bt=!0}_calculateBounds(){this._bounds.addFrame(this.transform,0,0,this._width,this._height)}updateTransform(){this.Bt&&this.updateLayout(),super.updateTransform()}updateLayout(){let t=0,s=this.Ht,i=this.Ht,h=!0;for(let e of this.children){if(e===this.Ft)continue;h||(i+=this.Ut),h=!1,e.position.set(i,s);const n=e.getBounds();i+=n.width,t=Math.max(t,n.height)}this._width=i+this.Ht,this._height=t+2*this.Ht,this.Ft.width=this._width,this.Ft.height=this._height,this._calculateBounds(),this.Bt=!1}}class ut{constructor(t){this.lt=new W,this.equipment=new ft(t,this.lt),this.belt=new dt(t,this.lt),this.backpack=new wt(t,this.lt)}get drop(){return this.lt}stack(t){return this.belt.stack(t)||this.backpack.stack(t)}set(t){return this.belt.set(t)||this.backpack.set(t)}add(t){return this.stack(t)||this.set(t)}hasSpace(t){return this.belt.hasSpace(t)||this.backpack.hasSpace(t)}}class ft{constructor(t,s){this.weapon=new pt(t,1,t=>t instanceof b,s,this)}}class dt{constructor(t,s){this.length=10,this.nt=[];for(let i=0;i<10;i++)this.nt[i]=new pt(t,3,()=>!0,s,this)}cell(t){return this.nt[t]}stack(t){for(let s=0;s<this.nt.length;s++)if(this.nt[s].stack(t))return!0;return!1}set(t){for(let s=0;s<this.nt.length;s++)if(this.nt[s].set(t))return!0;return!1}add(t){return this.stack(t)||this.set(t)}hasSpace(t){for(let s=0;s<this.nt.length;s++)if(this.nt[s].hasSpace(t))return!0;return!1}}class wt{constructor(t,s){this.width=10,this.height=5,this.nt=[];for(let i=0;i<this.height;i++){this.nt.push([]);for(let h=0;h<this.width;h++)this.nt[i][h]=new pt(t,3,()=>!0,s,this)}}cell(t,s){return this.nt[s][t]}stack(t){for(let s=0;s<this.height;s++)for(let i=0;i<this.width;i++)if(this.nt[s][i].stack(t))return!0;return!1}set(t){for(let s=0;s<this.height;s++)for(let i=0;i<this.width;i++)if(this.nt[s][i].set(t))return!0;return!1}add(t){return this.stack(t)||this.set(t)}hasSpace(t){for(let s=0;s<this.height;s++)for(let i=0;i<this.width;i++)if(this.nt[s][i].hasSpace(t))return!0;return!1}}class pt{constructor(t,s,i,h,e){this.jt=new G(null),this.Gt=new G(0),this.Wt=t,this.Kt=s,this.Xt=i,this.lt=h,this.parent=e}get item(){return this.jt}get count(){return this.Gt}hasSpace(t){return this.supports(t)&&(this.isEmpty||this.jt.get().same(t)&&this.Gt.get()<this.Kt)}supports(t){return this.Xt(t)}stack(t){var s;return!!((null===(s=this.jt.get())||void 0===s?void 0:s.same(t))&&this.Gt.get()<this.Kt)&&(this.Gt.update(t=>t+1),!0)}clear(){this.jt.get()&&(this.jt.set(null),this.Gt.set(0))}set(t,s=1){return!(this.jt.get()||!this.Xt(t))&&(this.jt.set(t),this.Gt.set(s),!0)}decrease(){this.Gt.update(t=>Math.max(0,t-1)),this.Gt.get()<=0&&(this.jt.set(null),this.Gt.set(0))}get isEmpty(){return null==this.jt.get()}use(){const t=this.jt.get();return!!t&&(t.use(this,this.Wt),!0)}equip(){const t=this.jt.get(),s=this.Wt.inventory.equipment.weapon;if(t&&s.supports(t)){const i=s.item.get();s.clear(),s.set(t),this.clear(),i&&this.set(i)}}toBelt(){const t=this.jt.get();for(;t&&!this.isEmpty&&this.Wt.inventory.belt.add(t);)this.decrease()}toBackpack(){const t=this.jt.get();for(;t&&!this.isEmpty&&this.Wt.inventory.backpack.add(t);)this.decrease()}drop(){const t=this.jt.get(),s=this.Gt.get();t&&(this.jt.set(null),this.Gt.set(0),this.lt.send([t,s]))}}class gt{constructor(t,s){this.inventory=t,this.title=s}handleActions(t,s){t.removeButtons(),s&&this.buttons(t,s)}}class mt extends gt{constructor(t,s){super(t,s)}basicButtons(t,s){const i=t.cell;(i.parent instanceof dt||i.parent instanceof wt)&&(this.inventory.equipment.weapon.supports(s)?t.addButton("Equip",()=>i.equip()):t.addButton("Use item",()=>i.use())),i.parent instanceof dt||t.addButton("To belt",()=>i.toBelt()),i.parent instanceof wt||t.addButton("To backpack",()=>i.toBackpack()),t.addButton("Drop",()=>i.drop())}}class yt extends mt{constructor(t){super(t,"Inventory")}buttons(t,s){this.basicButtons(t,s)}handleInfo(t){const s=t.info();return s.price=s.sellPrice,s}}class vt extends mt{constructor(t,s){super(t.inventory,"Selling"),this.qt=t,this.Jt=s}buttons(t,s){this.basicButtons(t,s),this.sellingButtons(t,s)}sellingButtons(t,s){const i=s.info().sellPrice;void 0!==i&&this.Jt.coins.get()>=i&&this.Jt.inventory.backpack.hasSpace(s)&&t.addButton("Sell",()=>{this.Jt.coins.get()>=i&&this.Jt.inventory.backpack.hasSpace(s)&&(this.Jt.decreaseCoins(i),this.Jt.inventory.backpack.add(s),this.qt.addCoins(i),t.cell.decrease())})}handleInfo(t){const s=t.info();return s.price=s.sellPrice,s}}class _t extends gt{constructor(t,s){super(s.inventory,"Buying"),this.qt=t,this.Jt=s}buttons(t,s){t.cell.parent instanceof wt&&this.buyingButtons(t,s)}buyingButtons(t,s){const i=s.info().buyPrice;void 0!==i&&this.qt.coins.get()>=i&&this.qt.inventory.hasSpace(s)&&t.addButton("Buy",()=>{this.Jt.coins.get()>=i&&this.qt.inventory.hasSpace(s)&&(this.qt.decreaseCoins(i),this.qt.inventory.backpack.add(s),this.Jt.addCoins(i),t.cell.decrease())})}handleInfo(t){const s=t.info();return s.price=s.buyPrice,s}}class bt extends h.Container{constructor(t,s,i,h,e){super(),this.Vt=i,this.Yt=h,this.Qt=e;const n=s.inventory,r=new ct({padding:0});this.addChild(r);const o=new at({padding:0});r.addChild(o),this.Zt=new xt(t,n.equipment),o.addChild(this.Zt),i.set(h,e,this.Zt.weapon,()=>this.show(n.equipment.weapon)),i.merge(h,e,10,1),this.ts=new kt(t,n.belt),o.addChild(this.ts);for(let t=0;t<this.ts.length;t++){const s=n.belt.cell(t);this.Vt.set(h+t,e+1,this.ts.cell(t),()=>this.show(s))}this.ss=new Mt(t,n.backpack),o.addChild(this.ss);for(let t=0;t<n.backpack.width;t++)for(let s=0;s<n.backpack.height;s++){const i=n.backpack.cell(t,s);this.Vt.set(h+t,e+s+2,this.ss.cell(t,s),()=>this.show(i))}this.hs=new St(this.Vt,this.Yt,this.Qt,s),o.addChild(this.hs),this.es=new Ot(t,s,{width:400,height:400}),r.addChild(this.es)}destroy(){super.destroy(),this.Zt.destroy(),this.ts.destroy(),this.ss.destroy(),this.es.destroy()}show(t){this.es.publisher=t.item,this.hs.cell=t}}class xt extends h.Container{constructor(t,s){super(),this.Zt=s;const i=(new h.Graphics).beginFill(V).drawRect(0,0,32+(st<<1),32+(st<<1)).endFill();this.addChild(i),this.weapon=new Dt(t,{item:this.Zt.weapon.item,count:new G(null)}),this.weapon.position.set(st,st),this.addChild(this.weapon)}}class kt extends h.Container{constructor(t,s){super(),this.ns=s;const i=(new h.Graphics).beginFill(V).drawRect(0,0,st+(32+st)*s.length,32+(st<<1)).endFill();this.addChild(i),this.nt=[];for(let i=0;i<s.length;i++){const h=s.cell(i),e=new Dt(t,{item:h.item,count:h.count});e.position.set(st+(32+st)*i,st),this.nt.push(e),this.addChild(e)}}get length(){return this.ns.length}cell(t){return this.nt[t]}}class Mt extends h.Container{constructor(t,s){super();const i=(new h.Graphics).beginFill(V).drawRect(0,0,st+(32+st)*s.width,st+(32+st)*s.height).endFill();this.addChild(i),this.nt=[];for(let i=0;i<s.height;i++){this.nt.push([]);for(let h=0;h<s.width;h++){const e=s.cell(h,i),n=new Dt(t,{item:e.item,count:e.count});n.position.set(st+(32+st)*h,st+(32+st)*i),this.nt[i][h]=n,this.addChild(n)}}}cell(t,s){return this.nt[s][t]}}class Dt extends h.Container{constructor(t,s){super(),this.ct=null,this.Mt=!1,this.jt=s.item,this.Gt=s.count,this.rs=t,this.Ft=new h.Graphics,this.selected=!1,this.os=new h.BitmapText("0",{font:{name:"alagard",size:16}}),this.os.anchor=new h.Point(1,0),this.os.position.set(32-st,0),this.addChild(this.Ft,this.os),this.jt.subscribe(this.updateItem,this),this.Gt.subscribe(this.updateCounter,this)}destroy(){super.destroy(),this.jt.unsubscribe(this.updateItem,this),this.Gt.unsubscribe(this.updateCounter,this)}get selected(){return this.Mt}set selected(t){this.Mt=t,this.Ft.clear().beginFill(t?Y:Q).drawRect(0,0,32,32).endFill()}updateCounter(t){this.os.text=null===t||0===t?"":t.toString()}updateItem(t){var s;if(null===(s=this.ct)||void 0===s||s.destroy(),this.ct=null,t){this.ct=this.rs.sprite(t.spriteName);const s=(32-(st<<1))/Math.max(this.ct.width,this.ct.height);this.ct.scale.set(s,s),this.ct.anchor.set(.5,0),this.ct.position.set(16,st),this.addChild(this.ct)}}}class Ot extends h.Container{constructor(t,s,i){super(),this.ct=null,this.ls=null,this.rs=t,this.R=s,this._width=i.width||400,this._height=i.height||400,this.as=128+(it<<1);const e=(new h.Graphics).beginFill(V).drawRect(0,0,this._width,this._height).endFill().beginFill(Q).drawRect(it,it+32+it,this.as,this.as).endFill();this.ut=new h.BitmapText("",{font:{name:"alagard",size:32}}),this.ut.anchor=new h.Point(.5,0),this.ut.position.set(this._width>>1,it),this.cs=new h.BitmapText("",{font:{name:"alagard",size:16}}),this.cs.position.set(it+this.as+it,it+32+it),this.addChild(e,this.ut,this.cs)}destroy(){var t;super.destroy(),null===(t=this.ls)||void 0===t||t.unsubscribe(this.handle,this),this.ls=null}set publisher(t){var s;null===(s=this.ls)||void 0===s||s.unsubscribe(this.handle,this),this.ls=null,this.ls=t,this.ls.subscribe(this.handle,this)}handle(t){var s;if(null===(s=this.ct)||void 0===s||s.destroy(),this.ct=null,this.ut.text="",this.cs.text="",t){const s=this.ct=this.rs.sprite(t.spriteName);s.anchor=new h.Point(.5,.5),s.position.set(it+(this.as>>1),it+(this.as>>1)+32+it);const i=s.width,e=s.height,n=this.as-it;i>e?(this.ct.width=n,this.ct.height=n/i*e):(this.ct.height=n,this.ct.width=n/e*i),this.addChild(this.ct);const r=this.R.handleInfo(t);this.ut.text=r.name;const o=[];r.health&&o.push("health: "+r.health),r.speed&&o.push(`speed: ${100*r.speed}%`),r.distance&&o.push("distance: "+r.distance),r.damage&&o.push("damage: "+r.damage),r.price&&o.push(`price: ${r.price}$`),this.cs.text=o.join("\n")}}}class St extends h.Container{constructor(t,s,i,h){super(),this.us=[],this.fs=null,this.Vt=t,this.Yt=s,this.Qt=i,this.R=h}destroy(){var t;super.destroy(),null===(t=this.fs)||void 0===t||t.item.unsubscribe(this.handle,this),this.fs=null,this.removeButtons()}set cell(t){var s;null===(s=this.fs)||void 0===s||s.item.unsubscribe(this.handle,this),this.removeButtons(),this.fs=t,this.fs.item.subscribe(this.handle,this)}get cell(){return this.fs}handle(t){this.R.handleActions(this,t)}removeButtons(){for(let[t,s,i]of this.us)this.Vt.unmerge(s,i),this.Vt.remove(s,i),t.destroy();this.Vt.reset(),this.us.splice(0,this.us.length)}addButton(t,s){const i=this.us.length,h=i>>1,e=i%2,n=this.Yt+5*e,r=this.Qt+10+h,o=new ht({label:t,width:170,height:32});o.position.set(e*(170+it),h*(32+it)),this.us.push([o,n,r]),this.Vt.set(n,r,o,s),this.Vt.merge(n,r,5,1),this.addChild(o)}}class Pt{constructor(){this.ds=[],this.ws=!1}get isPlaying(){return this.ws}add(t){this.ds.push(t)}clear(){this.stop(),this.ds.splice(0,this.ds.length)}start(){this.ws=!0;for(let t of this.ds)t.start()}stop(){this.ws=!1;for(let t of this.ds)t.stop()}update(t){let s=!1;for(let i of this.ds)i.update(t),i.isPlaying&&(s=!0);s||this.stop()}}class It{constructor(t){this.ps=0,this.ws=!1,this.animationSpeed=t}get isPlaying(){return this.ws}start(){this.ps=0,this.ws=!0,this.play()}stop(){this.ws=!1}update(t){this.ps+=this.animationSpeed*t,this.ws&&this.play()}}class Et extends It{constructor(t){super(t.animationSpeed),this.ct=t}get duration(){return this.ct.totalFrames}play(){const t=this.ct;let s=Math.floor(this.ps)%t.totalFrames;s<0&&(s+=t.totalFrames);const i=t.currentFrame;this.ps<0||this.ps>=t.totalFrames?this.stop():i!==s&&t.gotoAndStop(s)}}class Nt extends It{constructor(t,s,i,h,e){super(i),this.gs=t,this.ms=s,this.ys=h,this.gt=e}get duration(){return this.ms}play(){let t=this.ps/this.ms;t>=1?(this.ws=!1,this.ys.call(this.gt,...this.gs(1))):this.ys.call(this.gt,...this.gs(t))}}class Rt extends It{constructor(t,s,i){super(t),this.vs=[],this.ys=s,this.gt=i}get duration(){return this.vs.length>0?this.vs[this.vs.length-1].time:0}play(){let t=null,s=null;for(let i=0;i<this.vs.length;i++){let h=this.vs[i];if(!(h.time<=this.ps)){s=h;break}t=h}if(null!==t&&null!==s){let i=[];for(let h=0;h<t.args.length;h++)i[h]=t.args[h]*(s.time-this.ps)+s.args[h]*(this.ps-t.time);this.ys.call(this.gt,...i)}else null!==t?(this.ys.call(this.gt,...t.args),this.ws=!1):null!==s&&this.ys.call(this.gt,...s.args)}addFrame(t){this.vs.push(t),this.vs.sort(this.compare)}addFrames(t){this.vs.push(...t),this.vs.sort(this.compare)}add(t,...s){this.addFrame({time:t,args:s})}compare(t,s){return t.time-s.time}}class Tt extends It{constructor(t,s,i){super(t),this._s=[],this.bs=null,this.ys=s,this.gt=i}get duration(){return this._s.length>0?this._s[this._s.length-1].time:0}play(){for(;this.ws;){let t=null===this.bs?0:this.bs+1;if(t<this._s.length){if(!(this._s[t].time<=this.ps))break;this.bs=t,this.ys.call(this.gt,...this._s[t].args)}else this.ws=!1}}addEvent(t){this._s.push(t),this._s.sort(this.compare)}addEvents(t){this._s.push(...t),this._s.sort(this.compare)}add(t,...s){this.addEvent({time:t,args:s})}compare(t,s){return t.time-s.time}}class Ct{constructor(t){this.inventory=new ut(this),this.name=t.name,this.xs=new G(t.speed),this.ks=new G(t.healthMax),this.L=new G(t.healthMax),this.Ms=new G(!1),this.Ds=new G(null),this.Os=new G(t.baseDamage),this.C=new G(t.coins)}get speed(){return this.xs.get()}get healthMax(){return this.ks}get health(){return this.L}get dead(){return this.Ms}get killedBy(){return this.Ds}get coins(){return this.C}addCoins(t){this.C.update(s=>s+t)}decreaseCoins(t){const s=this.C.get();return s>=t&&(this.C.set(s-t),!0)}get weapon(){return this.inventory.equipment.weapon.item.get()||null}get damage(){var t;return this.Os.get()+((null===(t=this.weapon)||void 0===t?void 0:t.damage)||0)}heal(t){this.L.update(s=>Math.min(this.ks.get(),s+t))}hitDamage(t,s){this.Ms.get()||(this.L.update(t=>Math.max(0,t-s)),0===this.L.get()&&(this.Ds.set(t),this.Ms.set(!0)))}}var Lt;(t=>{t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT",t[t.AROUND=4]="AROUND"})(Lt||(Lt={}));class At{constructor(t,s){this.static=!1,this.Ss=null,this.dungeon=t,this.width=s.width,this.height=s.height,this.Ps=s.x,this.Is=s.y,this.view=new Ht(t,s.zIndex,s.width,s.on_position)}get x(){return this.Ps}get y(){return this.Is}set animation(t){var s;null===(s=this.Ss)||void 0===s||s.cancel(),this.Ss=t,this.Ss.start()}get animation(){return this.Ss}init(){this.setPosition(this.Ps,this.Is),this.character.killedBy.subscribe(this.handleKilledBy,this),this.character.dead.subscribe(this.handleDead,this),this.character.inventory.equipment.weapon.item.subscribe(this.onWeaponUpdate,this),this.idle(),this.dungeon.ticker.add(this.update,this)}destroy(){var t;this.dungeon.ticker.remove(this.update,this),null===(t=this.Ss)||void 0===t||t.cancel(),this.character.killedBy.unsubscribe(this.handleKilledBy,this),this.character.dead.unsubscribe(this.handleDead,this),this.character.inventory.equipment.weapon.item.unsubscribe(this.onWeaponUpdate,this),this.dungeon.remove(this.Ps,this.Is,this),this.view.destroy()}collide(t){return this!==t}handleKilledBy(t){t&&this.onKilledBy(t)}handleDead(t){t&&this.onDead()}onWeaponUpdate(t){this.view.weapon.setWeapon(t)}findDropCell(t=5){return this.findCell(t,t=>t.hasFloor&&!t.hasObject&&!t.hasDrop)}findSpawnCell(t=5){return this.findCell(t,t=>t.hasFloor&&!t.hasObject)}findCell(t,s){const i=this.x,h=this.y,e=this.view.isLeft;let n=null,r=null;const o=Math.max(0,i-t),l=Math.min(this.dungeon.width-1,i+t),a=Math.max(0,h-t),c=Math.min(this.dungeon.width-1,h+t);for(let t=o;t<=l;t++)for(let o=a;o<=c;o++){const l=this.dungeon.cell(t,o);if(l.hasFloor&&s(l)){const t=(u=l,Math.max(Math.abs(u.x-i),Math.abs(u.y-h))+(u.y!==h?.5:0)+(u.x===i&&u.y===h?0:1)+(e?u.x<i?0:1:u.x>i?0:.5));(null===r||r>t)&&(n=l,r=t)}}var u;return n}move(t,s){t>0&&(this.view.isLeft=!1),t<0&&(this.view.isLeft=!0);const i=this.x+t,h=this.y+s;return!!this.dungeon.available(i,h,this)&&(this.run(i,h),!0)}findPath(t){const s=this.dungeon,i=new J(s.width,s.height);for(let h=0;h<s.height;h++)for(let e=0;e<s.width;e++){const n=s.cell(e,h),r=n.object;!n.hasFloor||n.collide(this)&&r!==t?i.mark(e,h):i.clear(e,h)}const e=new h.Point(this.x,this.y),n=new h.Point(t.x,t.y);return i.find(e,n)}idle(){this.animation=new zt(this)}run(t,s){this.animation=new Bt(this,t,s)}hit(){this.animation=new Ut(this)}update(t){const s=this.Ss;s.update(t);const i=!s.isPlaying;!this.action(i)&&i&&this.idle()}setPosition(t,s){this.dungeon.remove(this.Ps,this.Is,this),this.Ps=Math.floor(t),this.Is=Math.floor(s),this.dungeon.set(this.Ps,this.Is,this),this.view.setPosition(t,s)}lookAt(t){t.x<this.x&&(this.view.isLeft=!0),t.x>this.x&&(this.view.isLeft=!1)}scanObjects(t,s,i){const h=this.scanCells(t,s,t=>t.hasObject&&i(t.object)).map(t=>t.object);return[...new Set(h)]}scanCells(t,s,i){const h=this.x,e=this.y,n=t===Lt.AROUND||t===Lt.LEFT,r=t===Lt.AROUND||t===Lt.RIGHT,o=n?Math.max(0,h-s):h,l=r?Math.min(this.dungeon.width-1,h+s):h,a=Math.max(0,e-s),c=Math.min(this.dungeon.height-1,e+s),u=[];for(let t=a;t<=c;t++)for(let s=o;s<=l;s++){const h=this.dungeon.cell(s,t);i(h)&&u.push(h)}return u}raycastIsVisible(t,s){let i=this.x,h=this.y;const e=Math.abs(t-i),n=Math.abs(s-h),r=i<t?1:-1,o=h<s?1:-1;let l=(e>n?e:-n)/2;for(;i!==t||h!==s;){let a=l;if(a>-e&&(l-=n,i+=r),a<n&&(l+=e,h+=o),i===t&&h===s)break;const c=this.dungeon.cell(i,h);if(!c.hasFloor)return!1;if(c.collide(this))return!1}return!0}}class $t{constructor(t,s){this.ai=t,this.view=t.view,this.spriteName=s,this.animation=new Pt}get isPlaying(){return this.animation.isPlaying}animateWeapon(t,s){const i=new Tt(s,this.view.weapon.setPosition,this.view.weapon);i.addEvents(t.pos),this.animation.add(i);const h=new Rt(s,this.view.weapon.setAngle,this.view.weapon);h.addFrames(t.angle),this.animation.add(h)}update(t){this.animation.update(t),this.animation.isPlaying||this.finish()}cancel(){this.animation.stop()}finish(){this.animation.stop()}}class zt extends $t{constructor(t){super(t,t.character.name+"_idle")}start(){const t=this.view.animation(this.spriteName,.2*this.ai.character.speed);this.animation.add(t);const s=this.ai.character.weapon;s&&this.animateWeapon(s.animations.idle,t.animationSpeed),this.animation.start()}}class Bt extends $t{constructor(t,s,i){super(t,t.character.name+"_run"),this.Ps=this.ai.x,this.Is=this.ai.y,this.Es=s,this.Ns=i}start(){const t=this.view.animation(this.spriteName,.2*this.ai.character.speed);this.ai.dungeon.set(this.Es,this.Ns,this.ai),this.animation.clear(),this.animation.add(t),this.animation.add(new Nt(class{static line(t,s){return i=>t*(1-i)+s*i}static matrix(t,s){return i=>{let h=[];for(let e=0;e<t.length;e++)h[e]=t[e]*(1-i)+s[e]*i;return h}}}.matrix([this.Ps,this.Is],[this.Es,this.Ns]),t.duration,t.animationSpeed,this.view.setPosition,this.view));const s=this.ai.character.weapon;s&&this.animateWeapon(s.animations.run,t.animationSpeed),this.animation.start()}cancel(){super.cancel(),this.ai.dungeon.remove(this.Ps,this.Is,this.ai),this.ai.dungeon.remove(this.Es,this.Ns,this.ai),this.ai.setPosition(this.ai.x,this.ai.y)}finish(){super.finish(),this.ai.dungeon.remove(this.Ps,this.Is,this.ai),this.ai.dungeon.remove(this.Es,this.Ns,this.ai),this.ai.setPosition(this.Es,this.Ns)}}class Ut extends $t{constructor(t){super(t,t.character.name+"_idle")}start(){const t=this.ai.character.weapon,s=this.view.animation(this.spriteName,.2*(t?t.speed:this.ai.character.speed));this.animation.clear(),this.animation.add(s),t&&this.animateWeapon(t.animations.hit,s.animationSpeed),this.animation.start()}update(t){this.animation.update(t),this.animation.isPlaying||this.finish()}cancel(){this.animation.stop()}finish(){this.animation.stop()}}class Ht extends h.Container{constructor(t,s,i,e){super(),this.Rs=!1,this.ct=null,this.point=new h.Point(0,0),this.rs=t.controller.resources,this.Ts=s,this.Cs=i,this.Ls=e||null,this.As=new Ft(this.rs),this.As.zIndex=2,this.As.position.set(16*this.Cs,12),this.addChild(this.As),t.container.addChild(this)}get isLeft(){return this.Rs}set isLeft(t){this.Rs=t,this.updatePosition()}get weapon(){return this.As}setPosition(t,s){const i=Math.round(16*t*2)/2,h=Math.round(16*s*2)/2;this.point.set(i,h),this.updatePosition(),this.zIndex=this.Ts+Math.floor(s)*L,this.Ls&&this.Ls(i,h)}updatePosition(){this.scale.set(this.Rs?-1:1,1),this.position.set(this.point.x+(this.Rs?16*this.Cs:0),this.point.y)}animation(t,s){var i;return null===(i=this.ct)||void 0===i||i.destroy(),this.ct=this.rs.animated(t,{autoUpdate:!1,loop:!1,animationSpeed:s}),this.ct.anchor.set(0,1),this.ct.position.y=14,this.ct.position.x=0,this.ct.width>16*this.Cs&&(this.ct.position.x-=(this.ct.width-16*this.Cs)/2),this.ct.zIndex=1,this.addChild(this.ct),new Et(this.ct)}}class Ft extends h.Container{constructor(t){super(),this.ct=null,this.rs=t}destroy(){var t;null===(t=this.ct)||void 0===t||t.destroy(),this.ct=null,super.destroy()}setWeapon(t){var s;null===(s=this.ct)||void 0===s||s.destroy(),this.ct=null,t&&(this.ct=this.rs.sprite(t.spriteName),this.ct.anchor.set(.5,1),this.addChild(this.ct))}setAngle(t){this.ct&&(this.ct.angle=t)}setPosition(t,s){this.ct&&this.ct.position.set(t,s)}}class jt extends h.Container{constructor(t){super(),this.$s=t.color,this._width=t.width||0,this.zs=t.widthMax,this.Bs=new h.Graphics,this.Us=t.labelCenter||!1,this.Hs=new h.BitmapText("",{font:{name:"alagard",size:16}}),this.Hs.anchor=new h.Point(this.Us?.5:0,.5),this.Hs.position.set((st<<1)+(this.Us?this.zs>>1:0),st+9),super.addChild(this.Bs,this.Hs)}set color(t){this.$s=t,this.updateRect()}set width(t){this._width=t,this.updateRect()}set label(t){this.Hs.text=t}set widthMax(t){this.zs=t,this.Hs.position.set((st<<1)+(this.Us?this.zs>>1:0),st+9),this.updateRect()}updateRect(){this.Bs.clear().beginFill(V).drawRect(0,0,this.zs+(st<<1),18+(st<<1)).endFill().beginFill(this.$s).drawRect(st,st,this._width,18).endFill()}}var Gt,Wt,Kt;(t=>{t[t.DEMON=1]="DEMON",t[t.ZOMBIE=2]="ZOMBIE",t[t.ORC=3]="ORC",t[t.SLIME=4]="SLIME",t[t.UNDEAD=5]="UNDEAD"})(Gt||(Gt={})),(t=>{t[t.NORMAL=1]="NORMAL",t[t.LEADER=2]="LEADER",t[t.MINION=3]="MINION"})(Wt||(Wt={})),(t=>{t[t.READY=0]="READY",t[t.ALARM=1]="ALARM"})(Kt||(Kt={}));class Xt extends Ct{constructor(t){super({name:t.name,speed:t.speed,healthMax:t.healthMax,baseDamage:t.baseDamage,coins:0}),this.level=t.level,this.luck=t.luck,this.xp=t.xp,this.category=t.category,this.type=t.type,this.spawn=t.spawn}}class qt extends At{constructor(t,s){super(t,s),this.interacting=!1,this.D=Kt.READY,this.Fs=[],this.js=[]}interact(){}onKilledBy(t){t&&t instanceof Yt&&(this.dungeon.log(`${this.character.name} killed by ${t.name}`),t.addXp(this.character.xp))}ready(){this.D=Kt.READY}sendAlarm(t){this.D=Kt.ALARM;for(const s of this.scanMonsters(Lt.AROUND,this.max_distance))s.alarm(t)}alarm(t){!this.character.dead.get()&&this.character.type!==Wt.LEADER&&this.D===Kt.READY&&this.animation instanceof zt&&this.moveTo(t)}get state(){return this.D}randomMove(){if(Math.random()<.1){const t=Math.floor(3*Math.random())-1,s=Math.floor(3*Math.random())-1;if(this.move(t,s))return!0}return!1}moveToHero(){const[t]=this.scanHero(Lt.AROUND,this.max_distance);if(t){this.lookAt(t),this.sendAlarm(t);const s=Math.abs(this.x-t.x),i=Math.abs(this.y-t.y);if(s>this.width||i>this.height)return this.moveTo(t);if(this.character.luck<this.dungeon.rng.float())return this.hit(),!0}return!1}moveTo(t){return this.Fs=this.findPath(t),this.moveByPath()}moveByPath(){if(this.Fs.length>0){const t=this.Fs[0],s=t.x-this.x,i=t.y-this.y;return this.move(s,i)?(this.Fs.splice(0,1),!0):(this.Fs=[],!1)}return!1}scanHit(){const t=this.character.weapon,s=this.view.isLeft?Lt.LEFT:Lt.RIGHT,i=(null==t?void 0:t.distance)||1,h=this.scanHero(s,i);for(const t of h)t.character.hitDamage(this.character,this.character.damage)}spawnMinions(){for(let t=this.js.length-1;t>=0;t--)this.js[t].character.dead.get()&&this.js.splice(t,1);if(this.js.length<this.character.spawn){if(Math.random()>.1)return!1;const t=this.findSpawnCell();if(!t)return!1;const s=this.spawnMinion(t.x,t.y);return!!s&&(t.object=s,this.js.push(s),!0)}return!1}scanHero(t,s){return this.scanObjects(t,s,t=>t instanceof Qt).filter(t=>this.raycastIsVisible(t.x,t.y))}scanMonsters(t,s){return this.scanObjects(t,s,t=>t instanceof qt)}}const Jt=["elf_f","elf_m","knight_f","knight_m","wizard_f","wizard_m"],Vt={coins:0,baseDamage:3,level:1,levelXp:0,skillPoints:0,xp:0,healthMax:30,speed:1};class Yt extends Ct{constructor(t,s,i){super({name:t,speed:s.speed,healthMax:s.healthMax,baseDamage:s.baseDamage,coins:s.coins}),this.dungeonSeeds=new Map,this.bonfires=new Set,this.Gs=i,this.Ws=new G(s.level),this.Ks=new G(s.levelXp),this.Xs=new G(s.skillPoints),this.qs=new G(s.xp),this.subscribe()}get level(){return this.Ws}get levelXp(){return this.Ks}get skillPoints(){return this.Xs}get xp(){return this.qs}addXp(t){this.qs.update(s=>{let i=s+t;for(;;){const t=this.Ks.get();if(!(i>=t))break;i-=t,this.Ws.update(t=>t+1),this.Ks.update(t=>t+1e3),this.Xs.update(t=>t+1)}return i})}increaseHealth(){this.Xs.update(t=>(t>0&&(t--,this.ks.update(t=>t+1),this.L.update(t=>t+1)),t))}subscribe(){this.C.subscribe(this.save,this),this.Os.subscribe(this.save,this),this.Ws.subscribe(this.save,this),this.Ks.subscribe(this.save,this),this.Xs.subscribe(this.save,this),this.qs.subscribe(this.save,this),this.ks.subscribe(this.save,this),this.xs.subscribe(this.save,this)}save(){this.Gs.global.save(this.name,this.state)}get state(){return{coins:this.C.get(),baseDamage:this.Os.get(),level:this.Ws.get(),levelXp:this.Ks.get(),skillPoints:this.Xs.get(),xp:this.qs.get(),healthMax:this.ks.get(),speed:this.xs.get()}}static load(t,s){let i=s.global.load(t)||Vt;return new Yt(t,i,s)}}class Qt extends At{constructor(t,s,i,h){super(s,{x:i,y:h,width:1,height:1,zIndex:E,on_position:s.camera.bind(s)}),this.interacting=!1,this.character=t,this.init(),this.character.inventory.drop.subscribe(this.onDrop,this)}destroy(){super.destroy(),this.character.inventory.drop.unsubscribe(this.onDrop,this)}interact(){}onKilledBy(t){this.dungeon.log(`${this.character.name} killed by ${t.name}`)}onDead(){this.dungeon.controller.dead()}onDrop(t){let[s]=t;const i=this.findDropCell();i&&(i.dropItem=s)}action(t){if(!this.character.dead.get()){const s=this.animation instanceof zt,i=this.animation instanceof Ut;t&&(i&&this.scanHit(),this.scanDrop());const h=this.dungeon.controller.joystick;if(s&&h.inventory.once())return this.dungeon.controller.showInventory(this.character),this.idle(),!0;for(let t=0;t<=9;t++){const i=(t+1)%10;if(h.digit(i).once()){const i=this.character.inventory.belt.cell(t),h=i.item.get();h&&(h instanceof b||s)&&i.use()}}if(s&&h.drop.once()&&this.character.inventory.equipment.weapon.drop(),s||t){const t=h.hit.triggered,s=h.hit.once();if(s){const t=this.view.isLeft?Lt.LEFT:Lt.RIGHT,[s]=this.scanInteracting(t,1);if(s)return h.hit.reset(),this.idle(),s.interact(this),!0}if(t||s)return this.lookAtMonsters(),this.hit(),!0}if(s||t){const t=Qt.delta(h.moveLeft,h.moveRight),s=Qt.delta(h.moveUp,h.moveDown);if((0!==t||0!==s)&&this.move(t,s))return!0}}return!1}static delta(t,s){return t.triggered?-1:s.triggered?1:0}scanDrop(){var t;(null===(t=this.dungeon.cell(this.x,this.y).drop)||void 0===t?void 0:t.pickedUp(this.character))&&h.sound.play("fruit_collect")}scanHit(){const t=this.character.weapon,s=(null==t?void 0:t.distance)||1,i=this.view.isLeft?Lt.LEFT:Lt.RIGHT,e=this.scanMonsters(i,s);for(let t of e)t.character.hitDamage(this.character,this.character.damage);e.length>0&&h.sound.play("hit_damage",{speed:(null==t?void 0:t.speed)||1})}lookAtMonsters(){const t=this.character.weapon,s=(null==t?void 0:t.distance)||1,i=this.monstersHealth(Lt.LEFT,s),h=this.monstersHealth(Lt.RIGHT,s);i>0&&i>h?this.view.isLeft=!0:h>0&&h>i&&(this.view.isLeft=!1)}scanInteracting(t,s){return this.scanCells(t,s,t=>t.interacting)}scanMonsters(t,s){return this.scanObjects(t,s,t=>t instanceof qt)}monstersHealth(t,s){return this.scanMonsters(t,s).map(t=>t.character.health.get()).reduce((t,s)=>t+s,0)}}class Zt extends h.Container{constructor(t,s){super(),this.Js=s.fixedHPSize,this.Vs=s.hpBarSize||8,this.Ys=s.maxBarSize||256,this.Qs=this.Ys-(st<<1);const i=18+(st<<1)+it;this.Zs=t,this.L=new jt({color:Z,width:0,widthMax:this.Qs}),this.qs=new jt({color:tt,width:0,widthMax:this.Qs}),this.qs.position.set(0,i),this.C=new h.BitmapText("",{font:{name:"alagard",size:16}}),this.C.position.set(0,2*i),super.addChild(this.L,this.qs,this.C),t.health.subscribe(this.updateHealth,this),t.healthMax.subscribe(this.updateHealthMax,this),t.level.subscribe(this.updateXp,this),t.levelXp.subscribe(this.updateXp,this),t.skillPoints.subscribe(this.updateXp,this),t.xp.subscribe(this.updateXp,this),t.coins.subscribe(this.updateCoins,this)}destroy(){super.destroy(),this.Zs.health.unsubscribe(this.updateHealth,this),this.Zs.healthMax.unsubscribe(this.updateHealthMax,this),this.Zs.level.unsubscribe(this.updateXp,this),this.Zs.levelXp.unsubscribe(this.updateXp,this),this.Zs.skillPoints.unsubscribe(this.updateXp,this),this.Zs.xp.unsubscribe(this.updateXp,this),this.Zs.coins.unsubscribe(this.updateCoins,this)}updateHealthMax(t){const s=this.Zs.health.get();this.Js||(this.L.widthMax=this.Vs*t),this.L.label=`${s}/${t}`}updateHealth(t){const s=this.Zs.healthMax.get();this.Js?this.L.width=Math.floor(this.Qs*t/s):this.L.width=this.Vs*t,this.L.label=`${t}/${s}`}updateXp(){const t=this.Zs.level.get(),s=this.Zs.levelXp.get(),i=this.Zs.skillPoints.get(),h=this.Zs.xp.get();this.qs.widthMax=this.Qs,this.qs.width=Math.floor(this.Qs*h/s),this.qs.label=`L:${t} XP:${h}/${s} SP:${i}`}updateCoins(t){this.C.text="$"+t}}const ts=[{name:"chort",category:Gt.DEMON,type:Wt.NORMAL,luck:.3,weapons:[]},{name:"wogol",category:Gt.DEMON,type:Wt.NORMAL,luck:.3,weapons:[]},{name:"imp",category:Gt.DEMON,type:Wt.NORMAL,luck:.3,weapons:[]},{name:"ice_zombie",category:Gt.ZOMBIE,type:Wt.NORMAL,luck:.3,weapons:[v.knife]},{name:"tiny_zombie",category:Gt.ZOMBIE,type:Wt.NORMAL,luck:.3,weapons:[v.knife]},{name:"zombie",category:Gt.ZOMBIE,type:Wt.NORMAL,luck:.3,weapons:[v.knife]},{name:"orc_shaman",category:Gt.ORC,type:Wt.LEADER,luck:.4,weapons:[v.knife]},{name:"masked_orc",category:Gt.ORC,type:Wt.NORMAL,luck:.3,weapons:[v.knife]},{name:"orc_warrior",category:Gt.ORC,type:Wt.MINION,luck:.3,weapons:[v.knife]},{name:"goblin",category:Gt.ORC,type:Wt.MINION,luck:.3,weapons:[v.knife]},{name:"swampy",category:Gt.SLIME,type:Wt.NORMAL,luck:.3,weapons:[]},{name:"muddy",category:Gt.SLIME,type:Wt.NORMAL,luck:.3,weapons:[]},{name:"necromancer",category:Gt.UNDEAD,type:Wt.LEADER,luck:.4,weapons:[v.knife]},{name:"skeleton",category:Gt.UNDEAD,type:Wt.MINION,luck:.3,weapons:[v.knife]}];class ss extends Xt{constructor(t,s){super({name:t.name,category:t.category,type:t.type,speed:.8,healthMax:10+Math.floor(2*s),level:s,luck:t.luck,baseDamage:1+.5*s,xp:35+5*s,spawn:3})}}class is extends qt{constructor(t,s,i,h){super(s,{x:i,y:h,width:1,height:1,zIndex:I}),this.max_distance=5,this.character=new ss(t,s.level);const e=t.luck<this.dungeon.rng.float()?b.select(this.dungeon.rng,t.weapons):null;e&&this.character.inventory.equipment.weapon.set(e),this.init()}action(t){if(!this.character.dead.get()&&t){if(this.animation instanceof Ut&&this.scanHit(),this.character.type===Wt.LEADER){if(this.spawnMinions())return!1;if(this.moveFromHeroOrAttack())return!0;this.ready()}else{if(this.moveToHero())return!0;if(this.moveByPath())return!0;if(this.ready(),this.randomMove())return!0}}return!1}moveFromHeroOrAttack(){const[t]=this.scanHero(Lt.AROUND,this.max_distance);if(t){this.lookAt(t),this.sendAlarm(t);const s=Math.abs(this.x-t.x),i=Math.abs(this.y-t.y);if(s>this.width||i>this.height){const s=Math.min(1,Math.max(-1,this.x-t.x)),i=Math.min(1,Math.max(-1,this.y-t.y));return this.move(s,i)||this.move(s,0)||this.move(0,i)}if(this.character.luck<this.dungeon.rng.float())return this.hit(),!0}return!1}onDead(){var t;Math.random()<this.character.luck&&(null===(t=this.findDropCell())||void 0===t||t.randomDrop()),this.destroy()}spawnMinion(t,s){const i=ts.filter(t=>t.category===this.character.category&&t.type===Wt.MINION);if(0===i.length)return null;const h=this.dungeon.rng.select(i);return new is(h,this.dungeon,t,s)}}const hs=[{name:"big_zombie",category:Gt.ZOMBIE,weapons:[v.anime_sword,v.baton_with_spikes,v.big_hammer,v.cleaver,v.mace]},{name:"big_demon",category:Gt.DEMON,weapons:[]},{name:"ogre",category:Gt.ORC,weapons:[v.anime_sword,v.baton_with_spikes,v.big_hammer,v.cleaver,v.mace]}];class es extends Xt{constructor(t,s){super({name:t.name,category:t.category,type:Wt.LEADER,speed:.5,healthMax:50+Math.floor(10*s),level:s,luck:.4,baseDamage:5+.5*s,xp:100+50*s,spawn:5})}}class ns extends qt{constructor(t,s,i,h){super(s,{width:2,height:2,x:i,y:h,zIndex:I}),this.max_distance=7,this.character=new es(t,s.level);const e=b.select(this.dungeon.rng,t.weapons);e&&this.character.inventory.equipment.weapon.set(e),this.init();const n=s.controller.app.screen.width,r=new rs(this.character);r.zIndex=13,r.position.set(n>>1,64),s.controller.stage.addChild(r)}action(t){if(!this.character.dead.get()&&t){const s=this.animation instanceof Ut;if(t&&s&&this.scanHit(),this.spawnMinions())return!1;if(this.moveToHero())return!0;if(this.moveByPath())return!0;if(this.ready(),this.randomMove())return!0}return!1}onDead(){var t;this.dungeon.controller.showBanner({text:this.dungeon.rng.boolean()?"VICTORY ACHIEVED":"YOU DEFEATED",color:tt});for(let s=0;s<9;s++)null===(t=this.findDropCell())||void 0===t||t.randomDrop();this.destroy()}spawnMinion(t,s){const i=ts.filter(t=>t.category===this.character.category&&t.type!==Wt.LEADER);if(0===i.length)return null;const h=this.dungeon.rng.select(i);return new is(h,this.dungeon,t,s)}}class rs extends h.Container{constructor(t){super(),this.ti=!1,this.si=t;this.ii=Math.min(4,Math.floor(500/this.si.healthMax.get())),this.zs=this.ii*this.si.healthMax.get(),this.L=new jt({color:Z,widthMax:this.zs,labelCenter:!0}),this.L.position.set(-(this.zs>>1),0),this.addChild(this.L),this.si.health.subscribe(this.updateHealth,this),this.si.dead.subscribe(this.updateDead,this)}destroy(){this.ti||(this.ti=!0,this.si.health.unsubscribe(this.updateHealth,this),this.si.dead.unsubscribe(this.updateDead,this),this.L.destroy(),super.destroy())}updateHealth(t){this.L.width=this.ii*t,this.L.label=`${this.si.name} - ${t}`}updateDead(t){t&&this.destroy()}}class os{constructor(t,s){this.npc=t,this.controller=s}}class ls extends os{constructor(t,s){super(t,s)}use(t){this.controller.sellInventory(t,this.npc)}}ls.id="selling";class as extends os{constructor(t,s){super(t,s)}use(t){this.controller.buyInventory(t,this.npc)}}as.id="buying";class cs extends os{constructor(t,s){super(t,s)}use(t){h.sound.play("big_egg_collect"),t.heal(t.healthMax.get())}}var us;cs.id="heal",(t=>{t[t.POTIONS=1]="POTIONS",t[t.WEAPONS=2]="WEAPONS"})(us||(us={}));const fs=[{name:"alchemist",width:1,height:1,baseDamage:0,coins:1e3,skills:[ls.id,as.id],weapons:[],trading:[us.POTIONS]},{name:"archer",width:1,height:1,baseDamage:0,coins:1e3,skills:[],weapons:[],trading:[]},{name:"bishop",width:1,height:2,baseDamage:0,coins:0,skills:[],weapons:[],trading:[]},{name:"blacksmith",width:1,height:1,baseDamage:0,coins:1e3,skills:[ls.id,as.id],weapons:[_.hammer],trading:[us.WEAPONS]},{name:"butcher",width:1,height:1,baseDamage:0,coins:1e3,skills:[ls.id,as.id],weapons:[],trading:[]},{name:"executioner",width:2,height:2,baseDamage:0,coins:0,skills:[],weapons:[_.axe],trading:[]},{name:"herald",width:1,height:1,baseDamage:0,coins:0,skills:[],weapons:[],trading:[]},{name:"king",width:1,height:1,baseDamage:0,coins:0,skills:[],weapons:[],trading:[]},{name:"knight",width:1,height:1,baseDamage:0,coins:0,skills:[],weapons:[_.regular_sword],trading:[]},{name:"knight_elite",width:1,height:1,baseDamage:0,coins:0,skills:[],weapons:[_.regular_sword],trading:[]},{name:"knight_heavy",width:1,height:1,baseDamage:0,coins:0,skills:[],weapons:[_.regular_sword],trading:[]},{name:"large_knight",width:2,height:2,baseDamage:0,coins:0,skills:[],weapons:[_.knight_sword],trading:[]},{name:"large_knight_elite",width:2,height:2,baseDamage:0,coins:0,skills:[],weapons:[_.knight_sword],trading:[]},{name:"mage",width:1,height:1,baseDamage:0,coins:1e3,skills:[ls.id,as.id],weapons:[],trading:[us.POTIONS]},{name:"magic_shop_keeper",width:1,height:1,baseDamage:0,coins:1e3,skills:[ls.id,as.id],weapons:[],trading:[us.POTIONS]},{name:"merchant",width:1,height:1,baseDamage:0,coins:1e4,skills:[ls.id,as.id],weapons:[],trading:[us.POTIONS]},{name:"mountain_king",width:1,height:1,baseDamage:0,coins:0,skills:[],weapons:[],trading:[]},{name:"nun",width:1,height:1,baseDamage:0,coins:0,skills:[cs.id],weapons:[],trading:[]},{name:"nun_fat",width:1,height:1,baseDamage:0,coins:0,skills:[cs.id],weapons:[],trading:[]},{name:"nun_tall",width:1,height:1,baseDamage:0,coins:0,skills:[cs.id],weapons:[],trading:[]},{name:"princess",width:1,height:1,baseDamage:0,coins:0,skills:[],weapons:[],trading:[]},{name:"queen",width:1,height:1,baseDamage:0,coins:0,skills:[],weapons:[],trading:[]},{name:"thief",width:1,height:1,baseDamage:0,coins:1e3,skills:[ls.id,as.id],weapons:[_.knife],trading:[]},{name:"townsfolk_f",width:1,height:1,baseDamage:0,coins:100,skills:[ls.id,as.id],weapons:[],trading:[]},{name:"townsfolk_m",width:1,height:1,baseDamage:0,coins:100,skills:[ls.id,as.id],weapons:[],trading:[]}];class ds extends Ct{constructor(t){super({name:t.name,speed:1,healthMax:1e3,baseDamage:t.baseDamage,coins:t.coins}),this.gt={},this.hi={}}setContext(t,s){this.gt[t]=s}getContext(t){return this.gt[t]}hasSkill(t){return this.hi.hasOwnProperty(t)}getSkill(t){return this.hi[t]||null}addSkill(t,s){this.hi[t]=s}}class ws extends At{constructor(t,s,i,h,e){super(s,{width:t.width,height:t.height,x:h,y:e,zIndex:I}),this.interacting=!0,this.character=new ds(t);const n=b.select(this.dungeon.rng,t.weapons);n&&this.character.inventory.equipment.weapon.set(n),this.initSkills(i,t),this.init()}initSkills(t,s){for(const i of s.skills)switch(i){case ls.id:this.character.addSkill(i,new ls(this.character,t));break;case as.id:this.character.addSkill(i,new as(this.character,t));const h=this.character.inventory.backpack;for(const t of s.trading)switch(t){case us.POTIONS:for(let t=0;t<10;t++)h.cell(t,0).set(new d,3);for(let t=0;t<10;t++)h.cell(t,1).set(new w,3);break;case us.WEAPONS:for(const t of y)t.level<=this.dungeon.level+2&&h.add(new b(t))}break;case cs.id:this.character.addSkill(i,new cs(this.character,t))}}onDead(){}onKilledBy(t){}action(){return!1}interact(t){this.lookAt(t),this.dungeon.controller.showDialog(t.character,this.character)}}var ps;(t=>{t[t.UNLIT=0]="UNLIT",t[t.LIGHT=1]="LIGHT",t[t.LIT=2]="LIT"})(ps||(ps={}));class gs{constructor(t,s,i,h){this.width=1,this.height=1,this.static=!0,this.interacting=!0,this.Y=t,this.x=s,this.y=i,this.D=ps.UNLIT,this.ct=this.Y.animated(this.x,this.y,"bonfire_unlit"),this.ct.zIndex=R+this.y*L,this.Y.set(this.x,this.y,this),h&&this.light()}get state(){return this.D}destroy(){this.Y.remove(this.x,this.y,this),this.ct.destroy()}interact(t){switch(this.D){case ps.UNLIT:t.character.bonfires.add(this.Y.level),this.Y.controller.showBanner({text:"BONFIRE LIT",color:tt}),this.light();break;case ps.LIGHT:case ps.LIT:this.Y.controller.showBonfire(t.character)}}collide(t){return!0}light(){this.D===ps.UNLIT&&(this.D=ps.LIGHT,this.ct.destroy(),this.ct=this.Y.animated(this.x,this.y,"bonfire_light"),this.ct.zIndex=R+this.y*L,this.ct.loop=!1,this.ct.onComplete=()=>this.lit(),this.Y.light.addLight({x:16*this.x+8,y:16*this.y-16},S.BONFIRE))}lit(){var t;this.D=ps.LIT,null===(t=this.ct)||void 0===t||t.destroy(),this.ct=this.Y.animated(this.x,this.y,"bonfire_lit"),this.ct.zIndex=R+this.y*L}}class ms{constructor(t,s){this.ei=null,this.Ft=null,this.Vt=null,this.R=t,this.qt=s}init(){this.Vt=new rt(this.R.joystick),this.Ft=new h.Graphics,this.Ft.beginFill(0).drawRect(0,0,400,400).endFill(),this.Ft.zIndex=0,this.ei=new h.Container,this.ei.addChild(this.Ft),this.ei.sortChildren(),this.ei.position.set((this.R.app.screen.width>>1)-200,(this.R.app.screen.height>>1)-200),this.R.stage.addChild(this.ei),this.R.app.ticker.add(this.handleInput,this);const t=new et;t.offset(it,it),t.commit();let s=0;const i=(i,h)=>{const e=new ht({label:i,width:400-2*it,height:32,textSize:24});this.ei.addChild(e),e.position.set(t.x,t.y),t.offset(0,32),t.offset(0,it),this.Vt.set(0,s,e,h),s++},e=[...this.qt.bonfires].sort((t,s)=>t-s);for(const t of e)i("Level "+t,()=>this.goto(t));i("Cancel",()=>this.cancel())}goto(t){this.R.closeModal(),this.R.generateDungeon({hero:this.qt,level:t})}cancel(){this.R.closeModal()}handleInput(){var t;null===(t=this.Vt)||void 0===t||t.handleInput()}destroy(){var t,s;this.R.app.ticker.remove(this.handleInput,this),null===(t=this.ei)||void 0===t||t.destroy(),this.ei=null,null===(s=this.Ft)||void 0===s||s.destroy(),this.Ft=null,this.Vt=null}}var ys=(t,s,i,h)=>new(i||(i=Promise))((e,n)=>{function r(t){try{l(h.next(t))}catch(t){n(t)}}function o(t){try{l(h.throw(t))}catch(t){n(t)}}function l(t){var s;t.done?e(t.value):(s=t.value,s instanceof i?s:new i(t=>{t(s)})).then(r,o)}l((h=h.apply(t,s||[])).next())});function vs(t=0){return ys(this,void 0,void 0,(function*(){return yield new Promise(s=>setTimeout(s,t))}))}var _s,bs=(t,s,i,h)=>new(i||(i=Promise))((e,n)=>{function r(t){try{l(h.next(t))}catch(t){n(t)}}function o(t){try{l(h.throw(t))}catch(t){n(t)}}function l(t){var s;t.done?e(t.value):(s=t.value,s instanceof i?s:new i(t=>{t(s)})).then(r,o)}l((h=h.apply(t,s||[])).next())});function xs(t,s){const i=[];for(let h=0;h<t;h++)i.push(s);return i}(t=>{t[t.Decided=0]="Decided",t[t.Undecided=-1]="Undecided",t[t.Contradiction=-2]="Contradiction"})(_s||(_s={}));class ks{constructor(t,s,i){this.wave=[],this.propagator=[],this.compatible=[],this.observed=null,this.toPropagate=[],this.backtrackItems=[],this.ni=[],this.ri=[],this.oi=0,this.T=0,this.periodic=!1,this.weights=[],this.weightLogWeights=[],this.sumsOfOnes=[],this.sumOfWeights=0,this.sumOfWeightLogWeights=0,this.startingEntropy=0,this.sumsOfWeights=[],this.sumsOfWeightLogWeights=[],this.entropies=[],this.status=_s.Undecided,this.deferredConstraintsStep=!1,this.debug=!1,this.rng=t,this.FMX=s,this.FMY=i}get percent(){let t=0;for(let s=0;s<this.wave.length;s++)1===this.sumsOfOnes[s]&&t++;return 100*t/this.wave.length}init(){this.wave=xs(this.FMX*this.FMY,[]),this.compatible=[];for(let t=0;t<this.wave.length;t++){this.wave[t]=xs(this.T,!0),this.compatible[t]=[];for(let s=0;s<this.T;s++)this.compatible[t][s]=xs(4,0)}this.weightLogWeights=[],this.sumOfWeights=0,this.sumOfWeightLogWeights=0;for(let t=0;t<this.T;t++)this.weightLogWeights[t]=this.weights[t]*Math.log(this.weights[t]),this.sumOfWeights+=this.weights[t],this.sumOfWeightLogWeights+=this.weightLogWeights[t];this.startingEntropy=Math.log(this.sumOfWeights)-this.sumOfWeightLogWeights/this.sumOfWeights,this.status=_s.Undecided,this.initConstraint()}clear(){this.sumsOfOnes=[],this.sumsOfWeights=[],this.sumsOfWeightLogWeights=[],this.entropies=[];for(let t=0;t<this.wave.length;t++){for(let s=0;s<this.T;s++){this.wave[t][s]=!0;for(let i=0;i<4;i++)this.compatible[t][s][i]=this.propagator[ks.opposite[i]][s].length}this.sumsOfOnes[t]=this.weights.length,this.sumsOfWeights[t]=this.sumOfWeights,this.sumsOfWeightLogWeights[t]=this.sumOfWeightLogWeights,this.entropies[t]=this.startingEntropy}this.toPropagate=[],this.backtrackItems=[],this.ni=[0],this.oi=0,this.ri=[],this.status=_s.Undecided}run(t=0,s=!1){return bs(this,void 0,void 0,(function*(){0===this.wave.length&&this.init(),this.clear(),this.debug=s;let i=0;for(;(i<t||0===t)&&(i%50==0&&(yield vs()),this.debug,this.step(),this.debug&&this.graphics([]),this.status===_s.Undecided);i++);return this.status}))}step(){let t,s=-1,i=!1;this.deferredConstraintsStep&&(this.debug,this.stepConstraint()),this.status!=_s.Undecided&&(s=0,i=!0,this.debug),i||(this.ni.push(this.oi+this.backtrackItems.length),[s,t]=this.observe(),this.debug,-1!==s&&(this.debug,this.ri.push([s,t])));do{if(this.debug,i=!1,this.debug,this.status===_s.Undecided&&this.propagate(),this.status===_s.Undecided&&this.stepConstraint(),-1===s&&this.status===_s.Undecided)return this.debug,this.status=_s.Decided,this.status;if(this.status===_s.Contradiction)for(this.debug,s=0;;){if(this.debug,1==this.ni.length)return this.debug,_s.Contradiction;this.backtrack();let t=this.ri.pop();if(this.toPropagate=[],this.status=_s.Undecided,this.debug&&this.graphics([t[0]]),this.internalBan(t[0],t[1])&&(this.status=_s.Contradiction),this.status===_s.Undecided&&this.propagate(),this.status!==_s.Contradiction){this.debug,this.ni.pop(),this.ni.push(this.oi+this.backtrackItems.length),this.debug,i=!0;break}this.debug}}while(i);return this.status}observe(){this.debug;let t=1e3,s=-1;for(let i=0;i<this.wave.length;i++){if(this.onBoundary(i%this.FMX,Math.floor(i/this.FMX)))continue;let h=this.sumsOfOnes[i];if(0===h)return this.debug,this.debug&&this.graphics([i]),this.status=_s.Contradiction,[-1,-1];let e=this.entropies[i];if(h>1&&e<=t){let h=1e-6*this.rng.float();e+h<t&&(t=e+h,s=i)}}if(-1==s){this.debug,this.observed=xs(this.FMX*this.FMY,0);for(let t=0;t<this.wave.length;t++){let s=t%this.FMX,i=Math.floor(t/this.FMX);if(!this.onBoundary(s,i)){this.testObserved(t);for(let s=0;s<this.T;s++)if(this.wave[t][s]){this.observed[t]=s;break}}}return[-1,-1]}let i=0,h=[];for(let t=0;t<this.T;t++)h[t]=this.wave[s][t]?this.weights[t]:0,i+=h[t];let e=this.rng.float()*i,n=0;for(let t of h){if(e-=t,e<0)break;n++}let r=this.wave[s];for(let t=0;t<this.T;t++)r[t]!=(t==n)&&(this.debug,this.internalBan(s,t)&&(this.status=_s.Contradiction));return this.debug&&this.graphics([s]),[s,n]}propagate(){for(;this.toPropagate.length>0;){let[t,s]=this.toPropagate.pop(),i=t%this.FMX,h=Math.floor(t/this.FMX);for(let t=0;t<4;t++){let e=i+ks.DX[t],n=h+ks.DY[t];if(this.onBoundary(e,n))continue;e<0?e+=this.FMX:e>=this.FMX&&(e-=this.FMX),n<0?n+=this.FMY:n>=this.FMY&&(n-=this.FMY);let r=e+n*this.FMX,o=this.propagator[t][s],l=this.compatible[r];for(let s of o){let i=l[s];i[t]--,0==i[t]&&this.internalBan(r,s)&&(this.status=_s.Contradiction)}}if(this.status==_s.Contradiction)break}}ban(t,s){return this.debug,this.wave[t][s]&&(this.deferredConstraintsStep=!0,this.internalBan(t,s))?this.status=_s.Contradiction:(this.propagate(),this.status)}internalBan(t,s){this.debug,this.wave[t][s]=!1;let i=this.compatible[t][s];for(let t=0;t<4;t++)i[t]-=this.T;this.toPropagate.push([t,s]),this.sumsOfOnes[t]-=1,this.sumsOfWeights[t]-=this.weights[s],this.sumsOfWeightLogWeights[t]-=this.weightLogWeights[s];let h=this.sumsOfWeights[t];return this.entropies[t]=Math.log(h)-this.sumsOfWeightLogWeights[t]/h,this.backtrackItems.push([t,s]),this.banConstraint(t,s),0===this.sumsOfOnes[t]&&(this.debug&&this.graphics([t]),!0)}backtrack(){const t=this.ni.pop()-this.oi;this.debug;const s=[],i=new Set(this.toPropagate.map(t=>t.join(",")));for(;this.backtrackItems.length>t;){let[t,h]=this.backtrackItems.pop();s.push(t);let e=this.compatible[t][h];for(let t=0;t<4;t++)e[t]+=this.T;this.wave[t][h]=!0,this.sumsOfOnes[t]+=1,this.sumsOfWeights[t]+=this.weights[h],this.sumsOfWeightLogWeights[t]+=this.weightLogWeights[h];let n=this.sumsOfWeights[t];if(this.entropies[t]=Math.log(n)-this.sumsOfWeightLogWeights[t]/n,!i.has([t,h].join(","))){let i=t%this.FMX,e=Math.floor(t/this.FMX);for(let t=0;t<4;t++){let n=i+ks.DX[t],r=e+ks.DY[t];if(this.onBoundary(n,r))continue;n<0?n+=this.FMX:n>=this.FMX&&(n-=this.FMX),r<0?r+=this.FMY:r>=this.FMY&&(r-=this.FMY);let o=n+r*this.FMX;s.push(o);const l=this.propagator[t][h];for(let s of l)this.compatible[o][s][t]++}}this.backtrackConstraint(t,h)}this.debug&&this.graphics(s)}}ks.DX=[-1,0,1,0],ks.DY=[0,1,0,-1],ks.opposite=[2,3,0,1];var Ms,Ds,Os,Ss;(t=>{t[t.TOP=0]="TOP",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.LEFT=3]="LEFT"})(Ms||(Ms={}));class Ps{constructor(t=0,s=0){this.x=t,this.y=s}plus(t){return new Ps(this.x+t.x,this.y+t.y)}minus(t){return new Ps(this.x-t.x,this.y-t.y)}multiply(t){return new Ps(this.x*t,this.y*t)}get negative(){return new Ps(-this.x,-this.y)}equal(t,s){return this.x===t&&this.y===s}equals(t){return this.x===t.x&&this.y===t.y}toString(){return`{x: ${this.x}, y: ${this.y}}`}static from(t){return new Ps(t.x,t.y)}}Ps.NORTH=new Ps(-1,0),Ps.SOUTH=new Ps(1,0),Ps.EAST=new Ps(0,1),Ps.WEST=new Ps(0,-1),Ps.NORTH_EAST=new Ps(-1,1),Ps.SOUTH_EAST=new Ps(1,1),Ps.SOUTH_WEST=new Ps(1,-1),Ps.NORTH_WEST=new Ps(-1,-1),Ps.ZERO=new Ps(0,0),(t=>{t[t.NORTH=0]="NORTH",t[t.EAST=1]="EAST",t[t.SOUTH=2]="SOUTH",t[t.WEST=3]="WEST",t[t.NORTH_EAST=4]="NORTH_EAST",t[t.SOUTH_EAST=5]="SOUTH_EAST",t[t.SOUTH_WEST=6]="SOUTH_WEST",t[t.NORTH_WEST=7]="NORTH_WEST"})(Ds||(Ds={})),(t=>{t[t.OPEN=0]="OPEN",t[t.CLOSED=1]="CLOSED",t[t.GUARANTEED_OPEN=2]="GUARANTEED_OPEN",t[t.GUARANTEED_CLOSED=3]="GUARANTEED_CLOSED",t[t.NON_JOIN_OPEN=4]="NON_JOIN_OPEN",t[t.NON_JOIN_CLOSED=5]="NON_JOIN_CLOSED",t[t.NON_JOIN_GUARANTEED_OPEN=6]="NON_JOIN_GUARANTEED_OPEN",t[t.NON_JOIN_GUARANTEED_CLOSED=7]="NON_JOIN_GUARANTEED_CLOSED",t[t.INSIDE_ROOM_OPEN=8]="INSIDE_ROOM_OPEN",t[t.INSIDE_TUNNEL_OPEN=9]="INSIDE_TUNNEL_OPEN",t[t.INSIDE_ANTEROOM_OPEN=10]="INSIDE_ANTEROOM_OPEN",t[t.H_DOOR=11]="H_DOOR",t[t.V_DOOR=12]="V_DOOR",t[t.COLUMN=13]="COLUMN"})(Os||(Os={})),(t=>{t[t.SMALL=0]="SMALL",t[t.MEDIUM=1]="MEDIUM",t[t.LARGE=2]="LARGE"})(Ss||(Ss={}));class Is{constructor(t=[]){this.inside=t,this.inDungeon=!1}randomSquare(){return this.inside[Math.floor(Math.random()*this.inside.length)]}static compare(t,s){return t.inside.length-s.inside.length}}class Es{constructor(t,s,i,h,e){this.startX=t,this.startY=s,this.endX=i,this.endY=h,this.type=e}}class Ns{constructor(t,s,i,h,e,n,r){this.rng=t,this.dungeonCrawler=s,this.config=s.config,this.location=i,this.direction=h,this.age=e,this.maxAge=n,this.generation=r}rightDirection(){if(0===this.direction.x)return new Ps(this.direction.y,0);if(0===this.direction.y)return new Ps(0,-this.direction.x);throw"illegal direction"}valid(t){return t.x>=0&&t.y>=0&&t.x<this.config.width&&t.y<this.config.height}validDirection(t){return 0===t.x&&(-1===t.y||1===t.y)||0===t.y&&(-1===t.x||1===t.x)}frontFree(t,s,i,h){let e;if(0===s.x)e=new Ps(s.y,0);else{if(0!==s.y)throw"invalid heading";e=new Ps(0,-s.x)}const n=this.findFrontFree(i,h,t,e,s);return n>0&&(i=this.findLeftFree(i,n,t,e,s),h=this.findRightFree(h,n,t,e,s)),[n,i,h]}findFrontFree(t,s,i,h,e){let n=0;for(;;){n++;for(let r=-t;r<=s;r++){const t=i.plus(h.multiply(r)).plus(e.multiply(n));if(!this.valid(t))return Math.max(0,n-1);if(this.freePredicate(this.dungeonCrawler.getMap(t)))return Math.max(0,n-1)}}}findLeftFree(t,s,i,h,e){for(;;){t++;for(let n=1;n<=s;n++){const s=i.minus(h.multiply(t)).plus(e.multiply(n));if(!this.valid(s))return t-1;if(this.freePredicate(this.dungeonCrawler.getMap(s)))return t-1}}}findRightFree(t,s,i,h,e){for(;;){t++;for(let n=1;n<=s;n++){const s=i.plus(h.multiply(t)).plus(e.multiply(n));if(!this.valid(s))return t-1;if(this.freePredicate(this.dungeonCrawler.getMap(s)))return t-1}}}freePredicate(t){return t!==Os.CLOSED&&t!==Os.NON_JOIN_CLOSED}contains(t,...s){for(const i of s)if(t===i)return!0;return!1}}class Rs extends Ns{constructor(t,s,i,h,e,n,r,o,l){super(t,s,i,h,e,n,r),this.li=o,this.ci=l}stepAhead(){if(!this.dungeonCrawler.isMoreRoomsDungeon(this.ci))return!1;if(this.generation!==this.dungeonCrawler.activeGeneration)return!0;if(this.age++,this.age>=this.maxAge)return!1;if(this.age<0)return!0;const t=this.rightDirection();let s=this.li;const i=this.getMinRoomSize(this.ci),h=this.getMaxRoomSize(this.ci);let e,n,r;do{[r,e,n]=this.frontFree(this.location,this.direction,s+1,s+1);let o=r-2,l=e+n-1;if(o<2)break;if(l/o<this.config.roomAspectRatio&&(o=Math.floor(l/this.config.roomAspectRatio),this.config.roomAspectRatio),o/l<this.config.roomAspectRatio&&(l=Math.floor(o/this.config.roomAspectRatio),this.config.roomAspectRatio),l/o<this.config.roomAspectRatio)return!1;for(;o*l>h;)o>l?o--:l>o?l--:this.rng.range(0,100)<50?o--:l--;if(o*l>=i){const s=new Is;return e<=n?(2*e-1>l?this.attachRoom(s,t,o,(l>>1)-l+1,l>>2):this.attachRoom(s,t,o,1-e,-e+l),0===this.direction.x?this.dungeonCrawler.setMap(this.location.plus(this.direction),Os.V_DOOR):this.dungeonCrawler.setMap(this.location.plus(this.direction),Os.H_DOOR)):(2*n-1>l?this.attachRoom(s,t,o,-(l>>1),-(l>>1)+l-1):this.attachRoom(s,t,o,n-l,n-1),0===this.direction.x?this.dungeonCrawler.setMap(this.location.plus(this.direction),Os.V_DOOR):this.dungeonCrawler.setMap(this.location.plus(this.direction),Os.H_DOOR)),this.dungeonCrawler.builtRoomDungeon(this.ci),s.inDungeon=!0,this.dungeonCrawler.addRoom(s),!1}s++}while(r-2>=(2*s+1)*this.config.roomAspectRatio);return!1}attachRoom(t,s,i,h,e){for(let n=1;n<=i;n++)for(let i=h;i<=e;i++){const h=this.location.plus(this.direction.multiply(n+1)).plus(s.multiply(i));this.dungeonCrawler.setMap(h,Os.INSIDE_ROOM_OPEN),t.inside.push(h)}}getMinRoomSize(t){switch(t){case Ss.SMALL:return this.config.minRoomSize;case Ss.MEDIUM:return this.config.mediumRoomSize;case Ss.LARGE:return this.config.largeRoomSize}}getMaxRoomSize(t){switch(t){case Ss.SMALL:return this.config.mediumRoomSize-1;case Ss.MEDIUM:return this.config.largeRoomSize-1;case Ss.LARGE:return this.config.maxRoomSize-1}}}class Ts extends Ns{constructor(t,s,i,h,e,n,r,o,l,a,c,u,f,d,w,p){super(t,s,i,h,e,n,r),this.ui=o,this.fi=l,this.di=a,this.wi=c,this.pi=u,this.gi=f,this.mi=d,this.yi=w,this.vi=p}freePredicate(t){if(this.config.crawlersInTunnels&&this.config.crawlersInAnterooms){if(!this.contains(t,Os.OPEN,Os.NON_JOIN_OPEN,Os.GUARANTEED_OPEN,Os.INSIDE_TUNNEL_OPEN,Os.INSIDE_ANTEROOM_OPEN,Os.NON_JOIN_GUARANTEED_OPEN))return!0}else if(this.config.crawlersInTunnels){if(!this.contains(t,Os.OPEN,Os.NON_JOIN_OPEN,Os.GUARANTEED_OPEN,Os.INSIDE_TUNNEL_OPEN,Os.NON_JOIN_GUARANTEED_OPEN))return!0}else if(!this.contains(t,Os.OPEN,Os.NON_JOIN_OPEN,Os.GUARANTEED_OPEN,Os.NON_JOIN_GUARANTEED_OPEN))return!0;return!1}stepAhead(){if(this.generation!==this.dungeonCrawler.activeGeneration)return!0;if(this.age++,this.age>=this.maxAge)return!1;if(this.age<0)return!0;let[t,s,i]=this.frontFree(this.location,this.direction,this.wi,this.wi);const h=this.rightDirection(),e=h.negative;let n=h;if(0===this.di&&t<this.config.joinDistance&&this.join(t))return!1;let r=this.fi;if(t>this.wi){t-this.wi<this.fi&&(r=t-this.wi);for(let t=1;t<=r;t++)n=this.location.plus(this.direction.multiply(t)),1===this.di?this.dungeonCrawler.setMap(n,Os.CLOSED):this.dungeonCrawler.setMap(n,Os.NON_JOIN_CLOSED);this.location=n;let o=this.rng.range(0,100),l=this.generation+1,a=0;for(let t=0;t<=10;t++)if(a+=this.getChildDelayProbabilityForGenerationCrawlers(t),o<a){l=this.generation+t;break}const c={straightSingleSpawnProbability:this.dungeonCrawler.mutate(this.pi),straightDoubleSpawnProbability:this.dungeonCrawler.mutate(this.gi),turnSingleSpawnProbability:this.dungeonCrawler.mutate(this.mi),turnDoubleSpawnProbability:this.dungeonCrawler.mutate(this.yi),changeDirectionProbability:this.dungeonCrawler.mutate(this.vi)};if(this.rng.range(0,100)<this.vi){let t=this.direction;if(0===this.ui.x&&0===this.ui.y||this.ui.x===this.direction.x&&this.ui.y===this.direction.y){let t=this.rng.range(0,4);0===t?this.direction=h:1===t?this.direction=e:i>s||i===s&&this.rng.boolean()?this.direction=h:this.direction=e}else 0===this.ui.x||0===this.ui.y?this.direction=this.ui:this.direction=this.ui.minus(this.direction);this.rng.range(0,100)<this.yi?(this.spawnWallCrawler(this.direction.negative,this.direction.negative,l,c),this.spawnWallCrawler(t,t,l,c)):this.rng.range(0,100)<this.mi&&this.spawnWallCrawler(this.direction.negative,this.direction.negative,l,c)}else this.rng.range(0,100)<this.gi?(this.spawnWallCrawler(h,h,l,c),this.spawnWallCrawler(e,e,l,c)):this.rng.range(0,100)<this.pi&&(n=s>i||s===i&&this.rng.boolean()?e:h,0===this.rng.range(0,3)&&(n=n.negative),this.spawnWallCrawler(n,n,l,c))}else if(this.direction.equals(this.ui)||this.ui.equal(0,0)){let[t]=this.frontFree(this.location,h,this.wi,this.wi),[s]=this.frontFree(this.location,e,this.wi,this.wi);if(t<=this.wi&&s<=this.wi)return!1;t>2*this.wi+1&&s>2*this.wi+1?this.rng.boolean()?this.direction=h:this.direction=e:t>s?this.direction=h:s>t?this.direction=e:this.rng.boolean()?this.direction=h:this.direction=e}else if(0===this.ui.x||0===this.ui.y){let[t]=this.frontFree(this.location,this.ui,this.wi,this.wi);if(!(t>this.wi))return!1;this.direction=this.ui}else{n=this.ui.minus(this.direction);let[t]=this.frontFree(this.location,n,this.wi,this.wi);if(!(t>this.wi))return!1;this.direction=n}return!0}spawnWallCrawler(t,s,i,h){this.rng.range(0,100)<this.config.noHeadingProbability&&(s=Ps.ZERO),this.dungeonCrawler.createWallCrawler(this.location,t,0,this.dungeonCrawler.getMaxAgeCrawlers(i),i,s,this.dungeonCrawler.getStepLength(i),1,this.dungeonCrawler.getCorridorWidth(i),h.straightSingleSpawnProbability,h.straightDoubleSpawnProbability,h.turnSingleSpawnProbability,h.turnDoubleSpawnProbability,h.changeDirectionProbability)}join(t){let s=this.rightDirection(),i=this.location.plus(this.direction.multiply(t+1));if(!this.valid(i))return!1;let h=this.dungeonCrawler.getMap(i);if(this.contains(h,Os.CLOSED,Os.GUARANTEED_CLOSED)){for(let s=1;s<=t;s++){const t=this.location.plus(this.direction.multiply(s));if(!this.valid(t))return!1;this.dungeonCrawler.setMap(t,Os.NON_JOIN_CLOSED)}return!0}if(this.contains(h,Os.NON_JOIN_CLOSED,Os.NON_JOIN_GUARANTEED_CLOSED))return!1;let e=new Ps,n=0;for(let i=1;i<=this.wi;i++){let r=this.location.plus(s.multiply(i)).plus(this.direction.multiply(t+1));if(!this.valid(r))return!1;if(h=this.dungeonCrawler.getMap(r),this.contains(h,Os.CLOSED,Os.GUARANTEED_CLOSED,Os.NON_JOIN_CLOSED,Os.NON_JOIN_GUARANTEED_CLOSED)){e=r,n=i;break}if(r=this.location.minus(s.multiply(i).plus(this.direction.multiply(t+1))),!this.valid(r))return!1;if(h=this.dungeonCrawler.getMap(r),this.contains(h,Os.CLOSED,Os.GUARANTEED_CLOSED,Os.NON_JOIN_CLOSED,Os.NON_JOIN_GUARANTEED_CLOSED)){e=r,n=-i;break}}if(0!==e.x||0!==e.y)return!1;if(0!==n)return!1;if(this.contains(h,Os.NON_JOIN_CLOSED,Os.NON_JOIN_GUARANTEED_CLOSED))return!1;i=n<0?s:s.negative;let r,o,[l]=this.frontFree(e,i,1,1);if(n>0?(r=n,o=1):(r=-n,o=-1),l<r+1)return!1;for(let s=1;s<=t+1;s++){const t=this.location.plus(this.direction.multiply(s));if(!this.valid(t))return!1;this.dungeonCrawler.setMap(t,Os.NON_JOIN_CLOSED)}for(let i=1;i<r;i++){const h=this.location.plus(s.multiply(i*o)).plus(this.direction.multiply(t+1));if(!this.valid(h))return!1;this.dungeonCrawler.setMap(h,Os.NON_JOIN_CLOSED)}return!0}getChildDelayProbabilityForGenerationCrawlers(t){return 0<=t&&t<=10?this.config.childDelayProbabilityForGenerationCrawlers[t]:0}}class Cs extends Ns{constructor(t,s,i,h,e,n,r,o,l,a,c,u,f,d,w,p){super(t,s,i,h,e,n,r),this.ui=o,this.fi=l,this._i=a,this.gi=c,this.yi=u,this.vi=f,this.bi=d,this.xi=w,this.ki=p}stepAhead(){const t=this.dungeonCrawler;if(this.generation!==t.activeGeneration)return!0;if(this.age++,this.age>=this.maxAge)return!1;if(this.age<0)return!0;let[s,i,h]=this.frontFree(this.location,this.direction,this._i+1,this._i+1);if(0===s)return!1;let[e,n]=this.sidewaysBranchingRoomSizes(),r=this.rightDirection(),o=r.negative;const l=this.roomGeneration();if(s<2*this.fi||this.maxAge-1===this.age)return this.joinOrBuildTerminatingRoom(n,s,i,h,r,o);if(this.buildTunnel(this.fi,this._i),this.rng.range(0,100)<this.bi){let t=this.location.plus(this.direction.multiply(this.fi>>2)).plus(r.multiply(this._i));this.spawnRoomCrawler(t,r,-1,2,l,e,!1)}if(this.rng.range(0,100)<this.xi){let t=this.location.plus(this.direction.multiply(this.fi>>2)).plus(o.multiply(this._i));this.spawnRoomCrawler(t,o,-1,2,l,e,!1)}this.location=this.location.plus(this.direction.multiply(this.fi));const a=this.isAnteroomPossible(r,this._i+2,this._i+2,2*this._i+5),c=this.isAnteroomPossible(r,this._i+3,this._i+3,2*this._i+7);let u=!1,f=!1,d=this.rng.range(0,100);const w=this.getSizeUpProbability(this.generation);let p=w+this.getSizeDownProbability(this.generation);if(d<w?u=!0:d<p&&(f=!0),u&&!c)return!0;const g=this.isChangeDirection(),m=this.isSpawn(g);if(!g&&!m)return!0;const y=this.isSpawnRoom(m),v=this.rng.range(0,100);let _=this.generation+1;if(m)if(u)_=this.generation+this.config.sizeUpGenDelay;else{let t=0;for(let s=0;s<=10;s++)if(t+=this.getChildDelayProbabilityForGenerationTunnelCrawlers(s),v<t){_=this.generation+s;break}}const b=this.mutateOptions();let x=this.determineSpawnPoints(u,m,a,r,o);if(!0===x)return!0;const[k,M,D,O]=x;let S=!1,P=!1,I=this.direction,E=!1;if(g){let[t]=this.frontFree(M,r,this._i+1,this._i+1),[s]=this.frontFree(D,o,this._i+1,this._i+1);if(this.ui.equal(0,0)||this.ui.equals(this.direction)?u&&m?t<s||t===s&&this.rng.boolean()?t>0&&(this.location=M,this.direction=r,S=!0):s>0&&(this.location=D,this.direction=o,P=!0):t>s||t===s&&this.rng.boolean()?t>0&&(this.location=M,this.direction=r,S=!0):s>0&&(this.location=D,this.direction=o,P=!0):0===this.ui.x||0===this.ui.y?(this.direction=this.ui,this.direction.equals(r)?t>0&&(S=!0,this.location=M):s>0&&(this.location=D,P=!0)):(this.direction=this.ui.minus(this.direction),this.direction.equals(r)?t>0&&(S=!0,this.location=M):s>0&&(this.location=D,P=!0)),m){let t=Ps.ZERO,s=Ps.ZERO;if(P?(t=M,s=r):S?(t=D,s=o):E=!0,!E){let i=this.rng.range(0,100);y&&i<50?this.spawnRoomCrawler(t,s,0,2,l,n,O):this.spawnTunnelCrawler(u,f,t,s,_,s,b),y&&i>=50?this.spawnRoomCrawler(k,I,0,2,l,n,O):this.spawnTunnelCrawler(u,f,k,I,_,I,b)}}}else E=!0;if(E){this.location=k;const t=this.rng.range(0,100);y&&t<50?this.spawnRoomCrawler(M,r,0,2,l,n,O):this.spawnTunnelCrawler(u,f,M,r,_,r,b),y&&t>=50?this.spawnRoomCrawler(M,o,0,2,l,n,O):this.spawnTunnelCrawler(u,f,D,o,_,o,b)}return!0}isAnteroomPossible(t,s,i,h){const e=this.dungeonCrawler;let n=!1;e.setMap(this.location,Os.CLOSED);for(let s=1;s<=this._i;s++)e.setMap(this.location.plus(t.multiply(s)),Os.CLOSED),e.setMap(this.location.minus(t.multiply(s)),Os.CLOSED);let[r]=this.frontFree(this.location.minus(this.direction),this.direction,s,i);r>=h&&(n=!0),e.setMap(this.location,Os.INSIDE_TUNNEL_OPEN);for(let s=1;s<=this._i;s++)e.setMap(this.location.plus(t.multiply(s)),Os.INSIDE_TUNNEL_OPEN),e.setMap(this.location.minus(t.multiply(s)),Os.INSIDE_TUNNEL_OPEN);return n}determineSpawnPoints(t,s,i,h,e){const n=this.dungeonCrawler;if(t){if(this.rng.range(0,100)<this.getAnteroomProbability(this._i)||s){this.buildAnteroom(2*this._i+5,this._i+2);return[this.location.plus(this.direction.multiply(2*this._i+5)),this.location.plus(this.direction.multiply(this._i+3)).plus(h.multiply(this._i+2)),this.location.plus(this.direction.multiply(this._i+3)).plus(e.multiply(this._i+2)),!0]}}else if(this.rng.range(0,100)<this.getAnteroomProbability(this._i)&&i){this.buildAnteroom(2*this._i+3,this._i+1);return[this.location.plus(this.direction.multiply(2*this._i+3)),this.location.plus(this.direction.multiply(this._i+2)).plus(h.multiply(this._i+1)),this.location.plus(this.direction.multiply(this._i+2)).plus(e.multiply(this._i+1)),!0]}const r=this.location,o=this.location.minus(this.direction.multiply(this._i)).plus(h.multiply(this._i)),l=this.location.minus(this.direction.multiply(this._i)).plus(e.multiply(this._i));return this.dungeonCrawler.getMap(o)!==Os.INSIDE_TUNNEL_OPEN||n.getMap(l)!==Os.INSIDE_TUNNEL_OPEN||[r,o,l,!1]}joinOrBuildTerminatingRoom(t,s,i,h,e,n){const r=this.dungeonCrawler;let o=!1,l=!1,a=!1,c=0;for(let t=-this._i;t<=this._i;t++){const i=this.location.plus(this.direction.multiply(s+1)).plus(e.multiply(t)),h=r.getMap(i);this.contains(h,Os.OPEN,Os.GUARANTEED_OPEN,Os.INSIDE_TUNNEL_OPEN,Os.INSIDE_ANTEROOM_OPEN)?(l=!0,c++):this.contains(h,Os.GUARANTEED_CLOSED,Os.NON_JOIN_GUARANTEED_CLOSED)?(o=!0,c=0):h===Os.INSIDE_ROOM_OPEN?(a=!0,c=0):c=0}if(this.rng.range(0,100)<=this.ki&&(this.age<this.maxAge-1||s<=this.config.tunnelJoinDist)||s<5){const t=this.joinOtherTunnel(c,s,i,h,l,a,o,e);if(null!=t)return t}r.isMoreRoomsDungeon(t)&&this.spawnRoomCrawler(this.location,this.direction,0,2,this.generation,t,!1);let u=10*this.rng.range(0,11);if(100!==this.ki||this.xi!==this.config.lastChanceTunnelCrawler.makeRoomsLeftProbability||this.bi!==this.config.lastChanceTunnelCrawler.makeRoomsRightProbability||this.vi!==this.config.lastChanceTunnelCrawler.changeDirectionProbability||this.gi!==this.config.lastChanceTunnelCrawler.straightDoubleSpawnProbability||this.yi!==this.config.lastChanceTunnelCrawler.turnDoubleSpawnProbability||0!==this._i){let[t]=this.frontFree(this.location.plus(e.multiply(this._i)),e,this._i+1,this._i+1),[i]=this.frontFree(this.location.minus(e.multiply(this._i)),n,this._i+1,this._i+1),[h]=this.frontFree(this.location,this.direction.negative,this._i+1,this._i+1);const r=(t,s,i,h)=>{this.dungeonCrawler.createTunnelCrawler(t,s,0,this.maxAge,i,h,3,0,this.config.lastChanceTunnelCrawler.straightDoubleSpawnProbability,this.config.lastChanceTunnelCrawler.turnDoubleSpawnProbability,this.config.lastChanceTunnelCrawler.changeDirectionProbability,this.config.lastChanceTunnelCrawler.makeRoomsRightProbability,this.config.lastChanceTunnelCrawler.makeRoomsLeftProbability,u)};0===this._i?this.xi===this.config.lastChanceTunnelCrawler.makeRoomsLeftProbability&&this.bi===this.config.lastChanceTunnelCrawler.makeRoomsRightProbability&&this.vi===this.config.lastChanceTunnelCrawler.changeDirectionProbability&&this.gi===this.config.lastChanceTunnelCrawler.straightDoubleSpawnProbability&&this.yi===this.config.lastChanceTunnelCrawler.turnDoubleSpawnProbability?s>=t&&s>=i&&s>=h?r(this.location,this.direction,this.generation+1,this.direction):h>=t&&h>=i?r(this.location,this.direction.negative,this.generation+this.config.genDelayLastChance,this.direction.negative):t>=i||t===i&&this.rng.range(0,100)<50?r(this.location,e,this.generation+this.config.genDelayLastChance,e):r(this.location,n,this.generation+this.config.genDelayLastChance,n):r(this.location,this.direction,this.generation+this.config.genDelayLastChance,this.direction):o?(r(this.location.plus(e.multiply(this._i)),e,this.generation+this.config.genDelayLastChance,e),r(this.location.minus(e.multiply(this._i)),n,this.generation+this.config.genDelayLastChance,n)):t>=i||t===i&&this.rng.range(0,100)<50?(r(this.location.plus(e.multiply(this._i)),e,this.generation+this.config.genDelayLastChance,e),r(this.location.minus(e.multiply(this._i)),this.direction,this.generation+this.config.genDelayLastChance,this.direction)):(r(this.location.plus(e.multiply(this._i)),this.direction,this.generation+this.config.genDelayLastChance,this.direction),r(this.location.minus(e.multiply(this._i)),this.direction,this.generation+this.config.genDelayLastChance,this.direction))}return!1}joinOtherTunnel(t,s,i,h,e,n,r,o){const l=this.dungeonCrawler;if(2*this._i+1===t)return this.buildTunnel(s,this._i),!1;if(e)return this.buildSmallerTunnel(s,l,o);if(n&&0===this._i&&s>1){const t=this.location.plus(this.direction.multiply(s+1));l.getMap(t);return this.buildTunnel(s-1,0),0===this.direction.x?l.setMap(this.location.plus(this.direction.multiply(s)),Os.V_DOOR):l.setMap(this.location.plus(this.direction.multiply(s)),Os.H_DOOR),!1}if(r&&0===this._i){if(100!==this.ki||20!==this.xi||20!==this.bi||30!==this.vi||0!==this.gi||0!==this.yi||0!==this._i){const t=10*this.rng.range(0,11),s=i>=h?o.negative:o;l.createTunnelCrawler(this.location,s,0,this.maxAge,this.generation+1,s,3,0,0,0,30,20,20,t)}return!1}if(!e&&!r){if(this.isSpecialCase(s,o)){this.buildTunnel(s,this._i);for(let t=-this._i;t<=this._i;t++)l.setMap(this.location.plus(this.direction.multiply(s+1)).plus(o.multiply(t)),Os.INSIDE_TUNNEL_OPEN);let t=s+2,i=!0,h=!0;for(;i&&h;){for(let s=-this._i;s<=this._i;s++){const h=this.location.plus(this.direction.multiply(t)).plus(o.multiply(s));if(l.getMap(h)!==Os.CLOSED){i=!1;break}}let s=this.location.plus(this.direction.multiply(t)).plus(o.multiply(this._i+1)),e=this.location.plus(this.direction.multiply(t)).minus(o.multiply(this._i+1)),n=l.getMap(s),r=l.getMap(e);if(!this.contains(n,Os.OPEN,Os.GUARANTEED_OPEN,Os.INSIDE_TUNNEL_OPEN,Os.INSIDE_ANTEROOM_OPEN)&&!this.contains(r,Os.OPEN,Os.GUARANTEED_OPEN,Os.INSIDE_TUNNEL_OPEN,Os.INSIDE_ANTEROOM_OPEN)){i=!1;break}if(n===Os.INSIDE_ROOM_OPEN||r===Os.INSIDE_ROOM_OPEN){i=!1;break}for(let s=-this._i;s<=this._i;s++){const i=this.location.plus(this.direction.multiply(t+1)).plus(o.multiply(s));l.getMap(i)!==Os.CLOSED&&(h=!1)}s=this.location.plus(this.direction.multiply(t+1)).plus(o.multiply(this._i+1)),e=this.location.plus(this.direction.multiply(t+1)).minus(o.multiply(this._i+1)),n=l.getMap(s),r=l.getMap(e),this.contains(n,Os.OPEN,Os.GUARANTEED_OPEN,Os.INSIDE_TUNNEL_OPEN,Os.INSIDE_ANTEROOM_OPEN,Os.CLOSED)||this.contains(r,Os.OPEN,Os.GUARANTEED_OPEN,Os.INSIDE_TUNNEL_OPEN,Os.INSIDE_ANTEROOM_OPEN,Os.CLOSED)||(h=!1),n!==Os.INSIDE_ROOM_OPEN&&r!==Os.INSIDE_ROOM_OPEN||(h=!1);let a=!0;for(let s=-this._i-1;s<=this._i+1;s++){const i=this.location.plus(this.direction.multiply(t+1)).plus(o.multiply(s)),h=l.getMap(i);h!==Os.INSIDE_TUNNEL_OPEN&&h!==Os.INSIDE_ANTEROOM_OPEN&&(a=!1)}if(a&&(h=!0),i&&h)for(let s=-this._i;s<=this._i;s++)l.setMap(this.location.plus(this.direction.multiply(t)).plus(o.multiply(s)),Os.INSIDE_TUNNEL_OPEN);t++}return!1}if(0===this._i&&l.getMap(this.location.plus(this.direction.multiply(s+1)))===Os.CLOSED){if(l.getMap(this.location.plus(this.direction.multiply(s+1)).plus(o))===Os.INSIDE_ROOM_OPEN)return this.direction=o.negative,this.direction.equals(this.ui.negative)&&(this.direction=this.ui),!0;if(l.getMap(this.location.plus(this.direction.multiply(s+1)).minus(o))===Os.INSIDE_ROOM_OPEN)return this.direction=o,this.direction.equals(this.ui.negative)&&(this.direction=this.ui),!0}}return null}isSpecialCase(t,s){const i=this.dungeonCrawler;let h=!0;for(let e=-this._i;e<=this._i;e++){const n=this.location.plus(this.direction.multiply(t+1)).plus(s.multiply(e));if(i.getMap(n)!==Os.CLOSED){h=!1;break}}let e=this.location.plus(this.direction.multiply(t+1)).plus(s.multiply(this._i+1)),n=this.location.plus(this.direction.multiply(t+1)).minus(s.multiply(this._i+1)),r=i.getMap(e),o=i.getMap(n);this.contains(r,Os.OPEN,Os.GUARANTEED_OPEN,Os.INSIDE_TUNNEL_OPEN,Os.INSIDE_ANTEROOM_OPEN)||this.contains(o,Os.OPEN,Os.GUARANTEED_OPEN,Os.INSIDE_TUNNEL_OPEN,Os.INSIDE_ANTEROOM_OPEN)||(h=!1),r!==Os.INSIDE_ROOM_OPEN&&o!==Os.INSIDE_ROOM_OPEN||(h=!1);for(let e=-this._i-1;e<=this._i+1;e++){const n=this.location.plus(this.direction.multiply(t+2)).plus(s.multiply(e));if(i.getMap(n)===Os.INSIDE_ROOM_OPEN){h=!1;break}}return h}spawnTunnelCrawler(t,s,i,h,e,n,r){let o=this._i,l=this.fi;t?(o++,l+=2):s&&(o--,o<0&&(o=0),l-=2,l<3&&(l=3)),this.dungeonCrawler.createTunnelCrawler(i,h,0,this.getMaxAgeTunnelCrawlers(e),e,n,l,o,r.straightDoubleSpawnProbability,r.turnDoubleSpawnProbability,r.changeDirectionProbability,r.makeRoomsRightProbability,r.makeRoomsLeftProbability,r.joinPreference)}spawnRoomCrawler(t,s,i,h,e,n,r){const o=Math.max(1,2*this._i);r&&(e=this.generation+Math.floor((e-this.generation)/this.config.genSpeedUpOnAnteroom)),this.dungeonCrawler.createRoomCrawler(t,s,i,h,e,o,n)}buildSmallerTunnel(t,s,i){const h=this.location.plus(this.direction.multiply(t+1)),e=s.getMap(h);if(this.contains(e,Os.OPEN,Os.GUARANTEED_OPEN,Os.INSIDE_TUNNEL_OPEN,Os.INSIDE_ANTEROOM_OPEN))return this.buildTunnel(t,0),!1;let n=0;for(let h=1;h<=this._i;h++){const e=this.location.plus(this.direction.multiply(t+1)).plus(i.multiply(h)),r=s.getMap(e);if(this.contains(r,Os.OPEN,Os.GUARANTEED_OPEN,Os.INSIDE_TUNNEL_OPEN,Os.INSIDE_ANTEROOM_OPEN)){n=h;break}const o=this.location.plus(this.direction.multiply(t+1)).minus(i.multiply(h)),l=s.getMap(o);if(this.contains(l,Os.OPEN,Os.GUARANTEED_OPEN,Os.INSIDE_TUNNEL_OPEN,Os.INSIDE_ANTEROOM_OPEN)){n=-h;break}}for(let h=1;h<=t;h++){const t=this.location.plus(this.direction.multiply(h)).plus(i.multiply(n));s.setMap(t,Os.INSIDE_TUNNEL_OPEN)}return!1}roomGeneration(){let t=this.rng.range(0,100),s=this.generation,i=0;for(let h=0;h<=10;h++)if(i+=this.getChildDelayProbabilityForGenerationRoomCrawlers(h),t<i){s=this.generation+h;break}return s}sidewaysBranchingRoomSizes(){let t,s;const i=this.getRoomSizeProbabilitySideways(this._i,Ss.MEDIUM),h=this.getRoomSizeProbabilitySideways(this._i,Ss.SMALL),e=this.getRoomSizeProbabilityBranching(this._i,Ss.MEDIUM),n=this.getRoomSizeProbabilityBranching(this._i,Ss.SMALL);let r=this.rng.range(0,100);return t=r<h?Ss.SMALL:r<h+i?Ss.MEDIUM:Ss.LARGE,s=r<n?Ss.SMALL:r<n+e?Ss.MEDIUM:Ss.LARGE,[t,s]}isChangeDirection(){return this.rng.range(0,100)<this.vi}isSpawn(t){return!!(t&&this.rng.range(0,100)<this.yi)||!t&&this.rng.range(0,100)<this.gi}isSpawnRoom(t){return t&&this.rng.range(0,100)>this.config.patience}buildAnteroom(t,s){if(t<3||s<1)return!1;let[i]=this.frontFree(this.location,this.direction,s+1,s+1);if(i<=t)return!1;const h=this.rightDirection();for(let i=1;i<=t;i++)for(let t=-s;t<=s;t++){const s=this.location.plus(this.direction.multiply(i)).plus(h.multiply(t));this.dungeonCrawler.setMap(s,Os.INSIDE_ANTEROOM_OPEN)}if(s>=3&&t>=7&&this.config.columnsInTunnels){let t=2;this.placeColumns(s,t,h)}return!0}buildTunnel(t,s){if(t<1||s<0)return!1;let[i]=this.frontFree(this.location,this.direction,s+1,s+1);if(i<t)return!1;const h=this.rightDirection();for(let i=1;i<=t;i++)for(let t=-s;t<=s;t++){const s=this.location.plus(this.direction.multiply(i)).plus(h.multiply(t));this.dungeonCrawler.setMap(s,Os.INSIDE_TUNNEL_OPEN)}if(s>=3&&t>=7&&this.config.columnsInTunnels){const i=Math.floor((t-1)/6);for(let t=0;t<i;t++){let i=2+3*t;this.placeColumns(s,i,h)}}return!0}placeColumns(t,s,i){let h=1-t,e=this.location.plus(this.direction.multiply(s)).plus(i.multiply(h));this.dungeonCrawler.setMap(e,Os.COLUMN),h=t-1,e=this.location.plus(this.direction.multiply(s)).plus(i.multiply(h)),this.dungeonCrawler.setMap(e,Os.COLUMN),s-=1,h=1-t,e=this.location.plus(this.direction.multiply(s)).plus(i.multiply(h)),this.dungeonCrawler.setMap(e,Os.COLUMN),h=t-1,e=this.location.plus(this.direction.multiply(s)).plus(i.multiply(h)),this.dungeonCrawler.setMap(e,Os.COLUMN)}getChildDelayProbabilityForGenerationRoomCrawlers(t){return 0<=t&&t<=10?this.config.childDelayProbabilityForGenerationRoomCrawlers[t]:0}getChildDelayProbabilityForGenerationTunnelCrawlers(t){return 0<=t&&t<=10?this.config.childDelayProbabilityForGenerationTunnelCrawlers[t]:0}getAnteroomProbability(t){return t>=this.config.anteroomProbability.length?100:this.config.anteroomProbability[t]}getSizeUpProbability(t){return t>=this.config.sizeUpProbability.length?this.config.sizeUpProbability[this.config.sizeUpProbability.length-1]:this.config.sizeUpProbability[t]}getSizeDownProbability(t){return t>=this.config.sizeDownProbability.length?this.config.sizeDownProbability[this.config.sizeDownProbability.length-1]:this.config.sizeDownProbability[t]}getMaxAgeTunnelCrawlers(t){return t>=this.config.maxAgesTunnelCrawlers.length?this.config.maxAgesTunnelCrawlers[this.config.maxAgesTunnelCrawlers.length-1]:this.config.maxAgesTunnelCrawlers[t]}getRoomSizeProbabilitySideways(t,s){if(t>=this.config.roomSizeProbabilitySidewaysRooms.length)return Ss.LARGE===s?100:0;switch(s){case Ss.LARGE:return this.config.roomSizeProbabilitySidewaysRooms[t][2];case Ss.MEDIUM:return this.config.roomSizeProbabilitySidewaysRooms[t][1];case Ss.SMALL:return this.config.roomSizeProbabilitySidewaysRooms[t][0]}}getRoomSizeProbabilityBranching(t,s){if(t>=this.config.roomSizeProbabilityBranching.length)return Ss.LARGE===s?100:0;switch(s){case Ss.LARGE:return this.config.roomSizeProbabilityBranching[t][2];case Ss.MEDIUM:return this.config.roomSizeProbabilityBranching[t][1];case Ss.SMALL:return this.config.roomSizeProbabilityBranching[t][0]}}mutateOptions(){return{straightDoubleSpawnProbability:this.dungeonCrawler.mutate(this.gi),turnDoubleSpawnProbability:this.dungeonCrawler.mutate(this.yi),changeDirectionProbability:this.dungeonCrawler.mutate(this.vi),makeRoomsRightProbability:this.dungeonCrawler.mutate(this.bi),makeRoomsLeftProbability:this.dungeonCrawler.mutate(this.xi),joinPreference:this.dungeonCrawler.mutate(this.ki)}}}class Ls{constructor(t,s){this.Mi=[],this.Di=[],this.Oi=[],this.activeGeneration=0,this.Si=0,this.Pi=0,this.Ii=0,this.Ei=0,this.Ni=0,this.Ri=0,this.rng=s,this.config=t,this.yt=[];for(let t=0;t<this.config.width*this.config.height;t++)this.yt[t]=this.config.background,this.Di[t]=!1;for(let t=0;t<4;t++)this.Oi[t]=null;this.setRect(0,0,this.config.width-1,0,Os.GUARANTEED_CLOSED),this.setRect(0,0,0,this.config.height-1,Os.GUARANTEED_CLOSED),this.setRect(this.config.width-1,0,this.config.width-1,this.config.height-1,Os.GUARANTEED_CLOSED),this.setRect(0,this.config.height-1,this.config.width-1,this.config.height-1,Os.GUARANTEED_CLOSED);for(const t of this.config.design)this.setRectFill(t);for(const t of this.config.openings)switch(t){case Ds.NORTH:this.setRect(0,Math.floor(this.config.height/2)-1,2,Math.floor(this.config.height/2)+1,Os.GUARANTEED_OPEN);break;case Ds.WEST:this.setRect(Math.floor(this.config.width/2)-1,0,Math.floor(this.config.width/2)+1,2,Os.GUARANTEED_OPEN);break;case Ds.EAST:this.setRect(Math.floor(this.config.width/2)-1,this.config.height-3,Math.floor(this.config.width/2)+1,this.config.height-1,Os.GUARANTEED_OPEN);break;case Ds.SOUTH:this.setRect(this.config.width-3,Math.floor(this.config.height/2)-1,this.config.width-1,Math.floor(this.config.height/2)+1,Os.GUARANTEED_OPEN);break;case Ds.NORTH_WEST:this.setRect(0,0,2,2,Os.GUARANTEED_OPEN);break;case Ds.NORTH_EAST:this.setRect(0,this.config.height-3,2,this.config.height-1,Os.GUARANTEED_OPEN);break;case Ds.SOUTH_WEST:this.setRect(this.config.width-3,0,this.config.width-1,2,Os.GUARANTEED_OPEN);break;case Ds.SOUTH_EAST:this.setRect(this.config.width-3,this.config.height-3,this.config.width-1,this.config.height-1,Os.GUARANTEED_OPEN)}const i=(s,i,h)=>{this.createWallCrawler(s,i,0,this.getMaxAgeCrawlers(h),h,i,this.getStepLength(h),1,this.getCorridorWidth(h),this.mutate2(t.randCrawler.straightSingleSpawnProbability),this.mutate2(t.randCrawler.straightDoubleSpawnProbability),this.mutate2(t.randCrawler.turnSingleSpawnProbability),this.mutate2(t.randCrawler.turnDoubleSpawnProbability),this.mutate2(t.randCrawler.changeDirectionProbability))};for(let s=0;s<t.randCrawler.perGeneration.length;s++){let h=t.randCrawler.perGeneration[s];if(h>0){let t=Math.floor(this.config.height*h/1e3);0===t&&this.rng.range(0,1e3)<this.config.height*h&&(t=1);let e=0;for(let h=0;h<t;h++)e=2+this.rng.range(0,this.config.height-4),i(new Ps(0,e),Ps.SOUTH,s),e=2+this.rng.range(0,this.config.height-4),i(new Ps(this.config.width-1,e),Ps.NORTH,s);let n=Math.floor(this.config.width*h/1e3);0===n&&this.rng.range(0,1e3)<this.config.width*h&&(n=1);let r=0;for(let t=0;t<n;t++)r=2+this.rng.range(0,this.config.width-4),i(new Ps(r,0),Ps.EAST,s),r=2+this.rng.range(0,this.config.width-4),i(new Ps(r,this.config.height-1),Ps.EAST,s)}}for(const s of t.crawlers)this.createWallCrawler(s.location,s.direction,-s.age,s.maxAge,s.generation,s.intendedDirection,s.stepLength,s.opening,s.corridorWidth,s.straightSingleSpawnProbability,s.straightDoubleSpawnProbability,s.turnSingleSpawnProbability,s.turnDoubleSpawnProbability,s.changeDirectionProbability);for(let[s,i]of t.crawlerPairs){let t=!0;this.rng.boolean()&&(t=!1),this.createWallCrawler(s.location,s.direction,-s.age,s.maxAge,s.generation,s.intendedDirection,s.stepLength,t?1:0,s.corridorWidth,s.straightSingleSpawnProbability,s.straightDoubleSpawnProbability,s.turnSingleSpawnProbability,s.turnDoubleSpawnProbability,s.changeDirectionProbability),this.setMap(s.location,Os.CLOSED),this.createWallCrawler(i.location,i.direction,-i.age,i.maxAge,i.generation,i.intendedDirection,i.stepLength,t?1:0,i.corridorWidth,i.straightSingleSpawnProbability,i.straightDoubleSpawnProbability,i.turnSingleSpawnProbability,i.turnDoubleSpawnProbability,i.changeDirectionProbability),this.setMap(i.location,Os.CLOSED)}for(let s of t.tunnelCrawlers)this.createTunnelCrawler(s.location,s.direction,-s.age,s.maxAge,s.generation,s.intendedDirection,s.stepLength,s.tunnelWidth,s.straightDoubleSpawnProbability,s.turnDoubleSpawnProbability,s.changeDirectionProbability,s.makeRoomsRightProbability,s.makeRoomsLeftProbability,s.joinPreference)}isOpen(t){let s=this.getMap(t);return s===Os.OPEN||s===Os.NON_JOIN_OPEN||s===Os.INSIDE_TUNNEL_OPEN||s===Os.INSIDE_ANTEROOM_OPEN||s===Os.GUARANTEED_OPEN||s===Os.NON_JOIN_GUARANTEED_OPEN}static isActive(t,s){for(let i of s)if(t.x===i.x&&t.y===i.y)return!0;return!1}setMap(t,s){const i=t.x,h=t.y;this.yt[i*this.config.height+h]=s}getMap(t){const s=t.x,i=t.y;return this.yt[s*this.config.height+i]}isMapOpen(t){switch(this.getMap(t)){case Os.OPEN:case Os.GUARANTEED_OPEN:case Os.NON_JOIN_OPEN:case Os.NON_JOIN_GUARANTEED_OPEN:case Os.INSIDE_ROOM_OPEN:case Os.INSIDE_TUNNEL_OPEN:case Os.INSIDE_ANTEROOM_OPEN:case Os.H_DOOR:case Os.V_DOOR:return!0;default:return!1}}isMoreRoomsLabyrinth(t=null){if(null===t)return this.isMoreRoomsLabyrinth(Ss.SMALL)||this.isMoreRoomsLabyrinth(Ss.MEDIUM)||this.isMoreRoomsLabyrinth(Ss.LARGE);switch(t){case Ss.SMALL:return this.config.numSmallRoomsInLabyrinth>this.Si;case Ss.MEDIUM:return this.config.numMediumRoomsInLabyrinth>this.Pi;case Ss.LARGE:return this.config.numLargeRoomsInLabyrinth>this.Ii}}isMoreRoomsDungeon(t){if(null===t)return this.isMoreRoomsDungeon(Ss.SMALL)||this.isMoreRoomsDungeon(Ss.MEDIUM)||this.isMoreRoomsDungeon(Ss.LARGE);switch(t){case Ss.SMALL:return this.config.numSmallRoomsInDungeon>this.Ei;case Ss.MEDIUM:return this.config.numMediumRoomsInDungeon>this.Ni;case Ss.LARGE:return this.config.numLargeRoomsInDungeon>this.Ri}}builtRoomDungeon(t){Ss.SMALL===t?this.Ei++:Ss.MEDIUM===t?this.Ni++:Ss.LARGE===t&&this.Ri++}getStepLength(t){return t>=this.config.stepLengths.length?this.config.stepLengths[this.config.stepLengths.length-1]:this.config.stepLengths[t]}getCorridorWidth(t){return t>=this.config.corridorWidths.length?this.config.corridorWidths[this.config.corridorWidths.length-1]:this.config.corridorWidths[t]}getMaxAgeCrawlers(t){return t>=this.config.maxAgesCrawlers.length?this.config.maxAgesCrawlers[this.config.maxAgesCrawlers.length-1]:this.config.maxAgesCrawlers[t]}addRoom(t){this.Mi.push(t)}isChecked(t){return this.Di[t.x*this.config.height+t.y]}static isCheckedList(t,s){for(let i=0;i<s.length;i++)if(t.x===s[i].x&&t.y===s[i].y)return!0;return!1}setChecked(t){this.Di[t.x*this.config.height+t.y]=!0}setRectFill(t){this.setRect(t.startX,t.startY,t.endX,t.endY,t.type)}setRect(t,s,i,h,e){if(!(i<t||h<s))for(let n=t;n<=i;n++)for(let t=s;t<=h;t++)this.setMap({x:n,y:t},e)}createWallCrawler(t,s,i,h,e,n,r,o,l,a,c,u,f,d){let w=new Ts(this.rng,this,Ps.from(t),Ps.from(s),i,h,e,Ps.from(n),r,o,l,a,c,u,f,d);for(let t=0;t<this.Oi.length;t++)if(null===this.Oi[t])return void(this.Oi[t]=w);this.Oi.push(w)}createTunnelCrawler(t,s,i,h,e,n,r,o,l,a,c,u,f,d){let w=new Cs(this.rng,this,Ps.from(t),Ps.from(s),i,h,e,Ps.from(n),r,o,l,a,c,u,f,d);for(let t=0;t<this.Oi.length;t++)if(null===this.Oi[t])return void(this.Oi[t]=w);this.Oi.push(w)}createRoomCrawler(t,s,i,h,e,n,r){const o=new Rs(this.rng,this,Ps.from(t),Ps.from(s),i,h,e,n,r);for(let t=0;t<this.Oi.length;t++)if(null===this.Oi[t])return void(this.Oi[t]=o);this.Oi.push(o)}mutate(t){let s=t-this.config.mutator+this.rng.range(0,2*this.config.mutator+1);return s<0?0:s}mutate2(t){return t<=50?t<0?0:this.rng.range(0,2*t+1):t>100?100:2*t-100+this.rng.range(0,200-2*t+1)}createSeedCrawlersInTunnels(){let t=0,s=0;for(new Ts(this.rng,this,new Ps(2,2),Ps.SOUTH,0,1,0,Ps.SOUTH,1,0,1,0,0,0,0,0);t<this.config.seedCrawlersInTunnels&&s<this.config.width*this.config.height;){s++;let i=1+this.rng.range(0,this.config.width-4),h=1+this.rng.range(0,this.config.height-4),e=new Ps(i,h);this.rng.range(0,100)<50?i=0:h=0,0===i?h=this.rng.range(0,100)<50?-1:1:i=this.rng.range(0,100)<50?-1:1;let n,r=new Ps(i,h);if(0===r.x)n=new Ps(r.y,0);else{if(0!==r.y)throw"illegal direction";n=new Ps(0,-r.x)}let o=!0;for(;o&&(e=e.plus(r),!(e.x<2||e.y<2||e.x>this.config.width-3||e.y>this.config.height-3));)this.getMap(e)===Os.INSIDE_TUNNEL_OPEN&&this.getMap(e.plus(r))===Os.INSIDE_TUNNEL_OPEN&&this.getMap(e.minus(r))===Os.INSIDE_TUNNEL_OPEN&&this.getMap(e.plus(n))===Os.INSIDE_TUNNEL_OPEN&&this.getMap(e.minus(n))===Os.INSIDE_TUNNEL_OPEN&&this.getMap(e.plus(r).plus(n))===Os.INSIDE_TUNNEL_OPEN&&this.getMap(e.minus(r).plus(n))===Os.INSIDE_TUNNEL_OPEN&&this.getMap(e.plus(r).minus(n))===Os.INSIDE_TUNNEL_OPEN&&this.getMap(e.minus(r).minus(n))===Os.INSIDE_TUNNEL_OPEN&&(this.setMap(e,Os.CLOSED),this.createWallCrawler(e,r,0,this.config.tunnelCrawlerStats.maxAge,this.activeGeneration+1,r,this.config.tunnelCrawlerStats.stepLength,1,1,this.config.tunnelCrawlerStats.straightSingleSpawnProbability,this.config.tunnelCrawlerStats.straightDoubleSpawnProbability,this.config.tunnelCrawlerStats.turnSingleSpawnProbability,this.config.tunnelCrawlerStats.turnDoubleSpawnProbability,this.config.tunnelCrawlerStats.changeDirectionProbability),this.createWallCrawler(e,n,0,this.config.tunnelCrawlerStats.maxAge,this.activeGeneration+1,r,this.config.tunnelCrawlerStats.stepLength,1,1,this.config.tunnelCrawlerStats.straightSingleSpawnProbability,this.config.tunnelCrawlerStats.straightDoubleSpawnProbability,this.config.tunnelCrawlerStats.turnSingleSpawnProbability,this.config.tunnelCrawlerStats.turnDoubleSpawnProbability,this.config.tunnelCrawlerStats.changeDirectionProbability),this.createWallCrawler(e,n.negative,0,this.config.tunnelCrawlerStats.maxAge,this.activeGeneration+1,r,this.config.tunnelCrawlerStats.stepLength,1,1,this.config.tunnelCrawlerStats.straightSingleSpawnProbability,this.config.tunnelCrawlerStats.straightDoubleSpawnProbability,this.config.tunnelCrawlerStats.turnSingleSpawnProbability,this.config.tunnelCrawlerStats.turnDoubleSpawnProbability,this.config.tunnelCrawlerStats.changeDirectionProbability),this.rng.range(0,100)<this.config.tunnelCrawlerClosedProbability?this.createWallCrawler(e,r.negative,0,this.config.tunnelCrawlerStats.maxAge,this.activeGeneration+1,r,this.config.tunnelCrawlerStats.stepLength,0,1,this.config.tunnelCrawlerStats.straightSingleSpawnProbability,this.config.tunnelCrawlerStats.straightDoubleSpawnProbability,this.config.tunnelCrawlerStats.turnSingleSpawnProbability,this.config.tunnelCrawlerStats.turnDoubleSpawnProbability,this.config.tunnelCrawlerStats.changeDirectionProbability):this.createWallCrawler(e,r.negative,0,this.config.tunnelCrawlerStats.maxAge,this.activeGeneration+1,r,this.config.tunnelCrawlerStats.stepLength,1,1,this.config.tunnelCrawlerStats.straightSingleSpawnProbability,this.config.tunnelCrawlerStats.straightDoubleSpawnProbability,this.config.tunnelCrawlerStats.turnSingleSpawnProbability,this.config.tunnelCrawlerStats.turnDoubleSpawnProbability,this.config.tunnelCrawlerStats.changeDirectionProbability),o=!1,t++)}}makeIteration(){for(let t=0;t<this.Oi.length;t++)null!==this.Oi[t]&&(this.Oi[t].stepAhead()||(this.Oi[t]=null));return!1}advanceGeneration(){let t=!1,s=0;for(let i=0;i<this.Oi.length;i++)if(null!==this.Oi[i]&&(t=!0,this.Oi[i].generation===this.activeGeneration)){let t=this.Oi[i].age;if(t>=0)return!0;(0===s||t>s)&&(s=t)}if(0===s)return this.activeGeneration++,t;for(let t=0;t<this.Oi.length;t++)null!==this.Oi[t]&&this.Oi[t].generation===this.activeGeneration&&(this.Oi[t].age-=s);return t}createRoom(t){if(this.config.width<10||this.config.height<10)return!1;if(t.endX-t.startX<=5)return!1;if(t.endY-t.startY<=5)return!1;let s=t.startX+1+this.rng.range(0,t.endX-t.startX-3),i=t.startY+1+this.rng.range(0,t.endY-t.startY-3),h=new Ps(s,i);if(!this.isOpen(h))return!1;if(this.isChecked(h))return!1;let e=this.config.maxRoomSize;if(this.isMoreRoomsLabyrinth(Ss.LARGE)||(e=this.config.largeRoomSize),this.isMoreRoomsLabyrinth(Ss.LARGE)||this.isMoreRoomsLabyrinth(Ss.MEDIUM)||(e=this.config.mediumRoomSize),!this.isMoreRoomsLabyrinth())return!1;let n,r=!0,o=[],l=[],a=[];for(l.push(h);r;){r=!1;for(let t=0;t<l.length;){let s=l[t];if(n=0,!this.isOpen(s.plus(Ps.NORTH))||Ls.isCheckedList(s.plus(Ps.NORTH),o)||Ls.isActive(s.plus(Ps.NORTH),l)||Ls.isActive(s.plus(Ps.NORTH),a)||n++,!this.isOpen(s.plus(Ps.SOUTH))||Ls.isCheckedList(s.plus(Ps.SOUTH),o)||Ls.isActive(s.plus(Ps.SOUTH),l)||Ls.isActive(s.plus(Ps.SOUTH),a)||n++,!this.isOpen(s.plus(Ps.EAST))||Ls.isCheckedList(s.plus(Ps.EAST),o)||Ls.isActive(s.plus(Ps.EAST),l)||Ls.isActive(s.plus(Ps.EAST),a)||n++,!this.isOpen(s.plus(Ps.WEST))||Ls.isCheckedList(s.plus(Ps.WEST),o)||Ls.isActive(s.plus(Ps.WEST),l)||Ls.isActive(s.plus(Ps.WEST),a)||n++,!this.isOpen(s.plus(Ps.NORTH_EAST))||Ls.isCheckedList(s.plus(Ps.NORTH_EAST),o)||Ls.isActive(s.plus(Ps.NORTH_EAST),l)||Ls.isActive(s.plus(Ps.NORTH_EAST),a)||n++,!this.isOpen(s.plus(Ps.NORTH_WEST))||Ls.isCheckedList(s.plus(Ps.NORTH_WEST),o)||Ls.isActive(s.plus(Ps.NORTH_WEST),l)||Ls.isActive(s.plus(Ps.NORTH_WEST),a)||n++,!this.isOpen(s.plus(Ps.SOUTH_EAST))||Ls.isCheckedList(s.plus(Ps.SOUTH_EAST),o)||Ls.isActive(s.plus(Ps.SOUTH_EAST),l)||Ls.isActive(s.plus(Ps.SOUTH_EAST),a)||n++,!this.isOpen(s.plus(Ps.SOUTH_WEST))||Ls.isCheckedList(s.plus(Ps.SOUTH_WEST),o)||Ls.isActive(s.plus(Ps.SOUTH_WEST),l)||Ls.isActive(s.plus(Ps.SOUTH_WEST),a)||n++,n>2)r=!0,!this.isOpen(s.plus(Ps.NORTH))||Ls.isCheckedList(s.plus(Ps.NORTH),o)||Ls.isActive(s.plus(Ps.NORTH),l)||Ls.isActive(s.plus(Ps.NORTH),a)||a.push(s.plus(Ps.NORTH)),!this.isOpen(s.plus(Ps.SOUTH))||Ls.isCheckedList(s.plus(Ps.SOUTH),o)||Ls.isActive(s.plus(Ps.SOUTH),l)||Ls.isActive(s.plus(Ps.SOUTH),a)||a.push(s.plus(Ps.SOUTH)),!this.isOpen(s.plus(Ps.EAST))||Ls.isCheckedList(s.plus(Ps.EAST),o)||Ls.isActive(s.plus(Ps.EAST),l)||Ls.isActive(s.plus(Ps.EAST),a)||a.push(s.plus(Ps.EAST)),!this.isOpen(s.plus(Ps.WEST))||Ls.isCheckedList(s.plus(Ps.WEST),o)||Ls.isActive(s.plus(Ps.WEST),l)||Ls.isActive(s.plus(Ps.WEST),a)||a.push(s.plus(Ps.WEST)),!this.isOpen(s.plus(Ps.NORTH_EAST))||Ls.isCheckedList(s.plus(Ps.NORTH_EAST),o)||Ls.isActive(s.plus(Ps.NORTH_EAST),l)||Ls.isActive(s.plus(Ps.NORTH_EAST),a)||a.push(s.plus(Ps.NORTH_EAST)),!this.isOpen(s.plus(Ps.NORTH_WEST))||Ls.isCheckedList(s.plus(Ps.NORTH_WEST),o)||Ls.isActive(s.plus(Ps.NORTH_WEST),l)||Ls.isActive(s.plus(Ps.NORTH_WEST),a)||a.push(s.plus(Ps.NORTH_WEST)),!this.isOpen(s.plus(Ps.SOUTH_EAST))||Ls.isCheckedList(s.plus(Ps.SOUTH_EAST),o)||Ls.isActive(s.plus(Ps.SOUTH_EAST),l)||Ls.isActive(s.plus(Ps.SOUTH_EAST),a)||a.push(s.plus(Ps.SOUTH_EAST)),!this.isOpen(s.plus(Ps.SOUTH_WEST))||Ls.isCheckedList(s.plus(Ps.SOUTH_WEST),o)||Ls.isActive(s.plus(Ps.SOUTH_WEST),l)||Ls.isActive(s.plus(Ps.SOUTH_WEST),a)||a.push(s.plus(Ps.SOUTH_WEST)),Ls.isCheckedList(s,o)||(o.push(s),this.setChecked(s)),l.splice(t,1),t++;else if(2===n){let i=0;if(!this.isOpen(s.plus(Ps.NORTH))||Ls.isCheckedList(s.plus(Ps.NORTH),o)||Ls.isActive(s.plus(Ps.NORTH),l)||Ls.isActive(s.plus(Ps.NORTH),a)||(a.push(s.plus(Ps.NORTH)),i++),!this.isOpen(s.plus(Ps.SOUTH))||Ls.isCheckedList(s.plus(Ps.SOUTH),o)||Ls.isActive(s.plus(Ps.SOUTH),l)||Ls.isActive(s.plus(Ps.SOUTH),a)||(a.push(s.plus(Ps.SOUTH)),i++),!this.isOpen(s.plus(Ps.EAST))||Ls.isCheckedList(s.plus(Ps.EAST),o)||Ls.isActive(s.plus(Ps.EAST),l)||Ls.isActive(s.plus(Ps.EAST),a)||(a.push(s.plus(Ps.EAST)),i++),!this.isOpen(s.plus(Ps.WEST))||Ls.isCheckedList(s.plus(Ps.WEST),o)||Ls.isActive(s.plus(Ps.WEST),l)||Ls.isActive(s.plus(Ps.WEST),a)||(a.push(s.plus(Ps.WEST)),i++),1===i){t++;continue}!this.isOpen(s.plus(Ps.NORTH_EAST))||Ls.isCheckedList(s.plus(Ps.NORTH_EAST),o)||Ls.isActive(s.plus(Ps.NORTH_EAST),l)||Ls.isActive(s.plus(Ps.NORTH_EAST),a)||a.push(s.plus(Ps.NORTH_EAST)),!this.isOpen(s.plus(Ps.NORTH_WEST))||Ls.isCheckedList(s.plus(Ps.NORTH_WEST),o)||Ls.isActive(s.plus(Ps.NORTH_WEST),l)||Ls.isActive(s.plus(Ps.NORTH_WEST),a)||a.push(s.plus(Ps.NORTH_WEST)),!this.isOpen(s.plus(Ps.SOUTH_EAST))||Ls.isCheckedList(s.plus(Ps.SOUTH_EAST),o)||Ls.isActive(s.plus(Ps.SOUTH_EAST),l)||Ls.isActive(s.plus(Ps.SOUTH_EAST),a)||a.push(s.plus(Ps.SOUTH_EAST)),!this.isOpen(s.plus(Ps.SOUTH_WEST))||Ls.isCheckedList(s.plus(Ps.SOUTH_WEST),o)||Ls.isActive(s.plus(Ps.SOUTH_WEST),l)||Ls.isActive(s.plus(Ps.SOUTH_WEST),a)||a.push(s.plus(Ps.SOUTH_WEST)),Ls.isCheckedList(s,o)||(o.push(s),this.setChecked(s)),l.splice(t,1),t++}else 1==n||(Ls.isCheckedList(s,o)||(o.push(s),this.setChecked(s)),l.splice(t,1)),t++;if(o.length>e)return!1}for(let t of a){if(this.getMap(t)===Os.GUARANTEED_OPEN||this.getMap(t)===Os.NON_JOIN_GUARANTEED_OPEN)return!1;Ls.isCheckedList(t,o)||Ls.isActive(t,l)||l.push(t)}a.splice(0,a.length)}let c=!0,u=0,f=Ps.ZERO;for(;c;){u=0,c=!1;for(let t=0;t<l.length;)f=l[t],n=0,!this.isOpen(f.plus(Ps.NORTH))||Ls.isCheckedList(f.plus(Ps.NORTH),o)||Ls.isActive(f.plus(Ps.NORTH),l)||Ls.isActive(f.plus(Ps.NORTH),a)||n++,!this.isOpen(f.plus(Ps.SOUTH))||Ls.isCheckedList(f.plus(Ps.SOUTH),o)||Ls.isActive(f.plus(Ps.SOUTH),l)||Ls.isActive(f.plus(Ps.SOUTH),a)||n++,!this.isOpen(f.plus(Ps.EAST))||Ls.isCheckedList(f.plus(Ps.EAST),o)||Ls.isActive(f.plus(Ps.EAST),l)||Ls.isActive(f.plus(Ps.EAST),a)||n++,!this.isOpen(f.plus(Ps.WEST))||Ls.isCheckedList(f.plus(Ps.WEST),o)||Ls.isActive(f.plus(Ps.WEST),l)||Ls.isActive(f.plus(Ps.WEST),a)||n++,!this.isOpen(f.plus(Ps.NORTH_EAST))||Ls.isCheckedList(f.plus(Ps.NORTH_EAST),o)||Ls.isActive(f.plus(Ps.NORTH_EAST),l)||Ls.isActive(f.plus(Ps.NORTH_EAST),a)||n++,!this.isOpen(f.plus(Ps.NORTH_WEST))||Ls.isCheckedList(f.plus(Ps.NORTH_WEST),o)||Ls.isActive(f.plus(Ps.NORTH_WEST),l)||Ls.isActive(f.plus(Ps.NORTH_WEST),a)||n++,!this.isOpen(f.plus(Ps.SOUTH_EAST))||Ls.isCheckedList(f.plus(Ps.SOUTH_EAST),o)||Ls.isActive(f.plus(Ps.SOUTH_EAST),l)||Ls.isActive(f.plus(Ps.SOUTH_EAST),a)||n++,!this.isOpen(f.plus(Ps.SOUTH_WEST))||Ls.isCheckedList(f.plus(Ps.SOUTH_WEST),o)||Ls.isActive(f.plus(Ps.SOUTH_WEST),l)||Ls.isActive(f.plus(Ps.SOUTH_WEST),a)||n++,n>1?(u++,t++):1===n?(c=!0,!this.isOpen(f.plus(Ps.NORTH))||Ls.isCheckedList(f.plus(Ps.NORTH),o)||Ls.isActive(f.plus(Ps.NORTH),l)||Ls.isActive(f.plus(Ps.NORTH),a)||a.push(f.plus(Ps.NORTH)),!this.isOpen(f.plus(Ps.SOUTH))||Ls.isCheckedList(f.plus(Ps.SOUTH),o)||Ls.isActive(f.plus(Ps.SOUTH),l)||Ls.isActive(f.plus(Ps.SOUTH),a)||a.push(f.plus(Ps.SOUTH)),!this.isOpen(f.plus(Ps.EAST))||Ls.isCheckedList(f.plus(Ps.EAST),o)||Ls.isActive(f.plus(Ps.EAST),l)||Ls.isActive(f.plus(Ps.EAST),a)||a.push(f.plus(Ps.EAST)),!this.isOpen(f.plus(Ps.WEST))||Ls.isCheckedList(f.plus(Ps.WEST),o)||Ls.isActive(f.plus(Ps.WEST),l)||Ls.isActive(f.plus(Ps.WEST),a)||a.push(f.plus(Ps.WEST)),!this.isOpen(f.plus(Ps.NORTH_EAST))||Ls.isCheckedList(f.plus(Ps.NORTH_EAST),o)||Ls.isActive(f.plus(Ps.NORTH_EAST),l)||Ls.isActive(f.plus(Ps.NORTH_EAST),a)||a.push(f.plus(Ps.NORTH_EAST)),!this.isOpen(f.plus(Ps.NORTH_WEST))||Ls.isCheckedList(f.plus(Ps.NORTH_WEST),o)||Ls.isActive(f.plus(Ps.NORTH_WEST),l)||Ls.isActive(f.plus(Ps.NORTH_WEST),a)||a.push(f.plus(Ps.NORTH_WEST)),!this.isOpen(f.plus(Ps.SOUTH_EAST))||Ls.isCheckedList(f.plus(Ps.SOUTH_EAST),o)||Ls.isActive(f.plus(Ps.SOUTH_EAST),l)||Ls.isActive(f.plus(Ps.SOUTH_EAST),a)||a.push(f.plus(Ps.SOUTH_EAST)),!this.isOpen(f.plus(Ps.SOUTH_WEST))||Ls.isCheckedList(f.plus(Ps.SOUTH_WEST),o)||Ls.isActive(f.plus(Ps.SOUTH_WEST),l)||Ls.isActive(f.plus(Ps.SOUTH_WEST),a)||a.push(f.plus(Ps.SOUTH_WEST)),Ls.isCheckedList(f,o)||(o.push(f),this.setChecked(f)),l.splice(t,1)):(Ls.isCheckedList(f,o)||(o.push(f),this.setChecked(f)),l.splice(t,1));for(f of a){if(this.getMap(f)===Os.GUARANTEED_OPEN||this.getMap(f)===Os.NON_JOIN_GUARANTEED_OPEN)return!1;Ls.isCheckedList(f,o)||Ls.isActive(f,l)||l.push(f)}a.splice(0,a.length)}if(u>1)return!1;if(0===u)for(let t=0;t!==o.length;t++)this.setMap(o[t],Os.CLOSED);else{if(o.length<this.config.minRoomSize)return!1;let t=!1,s=!1;for(let i=0;i!==o.length;i++)o[i].x!==o[0].x&&(t=!0),o[i].y!==o[0].y&&(s=!0);if(!t||!s)return!1;if(this.getMap(f.plus(Ps.WEST))===Os.V_DOOR||this.getMap(f.plus(Ps.EAST))===Os.V_DOOR||this.getMap(f.plus(Ps.WEST))===Os.H_DOOR||this.getMap(f.plus(Ps.EAST))===Os.H_DOOR||this.getMap(f.plus(Ps.NORTH))===Os.V_DOOR||this.getMap(f.plus(Ps.SOUTH))===Os.V_DOOR||this.getMap(f.plus(Ps.NORTH))===Os.H_DOOR||this.getMap(f.plus(Ps.SOUTH))===Os.H_DOOR)return!1;if(o.length<this.config.mediumRoomSize){if(!this.isMoreRoomsLabyrinth(Ss.SMALL))return!1;this.Si++}else if(o.length<this.config.largeRoomSize){if(!this.isMoreRoomsLabyrinth(Ss.MEDIUM))return!1;this.Pi++}else{if(!(o.length<this.config.maxRoomSize))return!1;if(!this.isMoreRoomsLabyrinth(Ss.LARGE))return!1;this.Ii++}f=l[0],this.isOpen(f.plus(Ps.NORTH))?this.setMap(f,Os.H_DOOR):this.isOpen(f.plus(Ps.WEST))&&this.setMap(f,Os.V_DOOR);let i=new Is;for(let t=0;t!==o.length;t++)this.setMap(o[t],Os.INSIDE_ROOM_OPEN),i.inside.push(o[t]);i.inDungeon=!1,this.Mi.push(i)}return!0}generate(){for(;;){for(this.activeGeneration===this.config.tunnelCrawlerGeneration&&this.createSeedCrawlersInTunnels();this.makeIteration(););if(!this.advanceGeneration())break}if(this.config.tunnelCrawlerGeneration<0||this.activeGeneration<this.config.tunnelCrawlerGeneration)for(this.createSeedCrawlersInTunnels();;){for(;this.makeIteration(););if(!this.advanceGeneration())break}let t=0,s=0;if(this.config.background===Os.OPEN){let i=new Es(0,0,this.config.width,this.config.height,this.config.background);for(t=0,s=this.config.width*this.config.height;this.isMoreRoomsLabyrinth()&&(this.createRoom(i)||t++,!(t>s)););}for(let i of this.config.design)if(i.type===Os.OPEN)for(t=0,s=(i.endX-i.startX)*(i.endY-i.startY);this.isMoreRoomsLabyrinth()&&(this.createRoom(i)||t++,!(t>s)););}}var As,$s;(t=>{t[t.RIGHT=2]="RIGHT",t[t.DOWN=1]="DOWN"})(As||(As={})),(t=>{t[t.EMPTY=0]="EMPTY",t[t.FLOOR=1]="FLOOR",t[t.FLOOR_WALL_TOP=2]="FLOOR_WALL_TOP",t[t.WALL_MID=3]="WALL_MID",t[t.WALL_TOP=4]="WALL_TOP",t[t.WALL_SIDE=5]="WALL_SIDE"})($s||($s={}));class zs extends ks{constructor(t,s,i,h,e,n){super(i,h,e),this.Ti=null,this.rs=t,this.weights=[],this.tileset=s,this.Ci=n,this.T=s.cells.length;for(let t=0;t<this.T;t++)this.weights[t]=1;const r=[];for(let t=0;t<4;t++){r[t]=[];for(let s=0;s<this.T;s++){r[t][s]=[];for(let i=0;i<this.T;i++)r[t][s][i]=!1}}for(let[t,i]of s.right){const s=ks.opposite[As.RIGHT];r[As.RIGHT][t][i]=!0,r[s][i][t]=!0}for(let[t,i]of s.down){const s=ks.opposite[As.DOWN];r[As.DOWN][t][i]=!0,r[s][i][t]=!0}this.propagator=[];for(let t=0;t<4;t++){this.propagator[t]=[];for(let s=0;s<this.T;s++){this.propagator[t][s]=[];for(let i=0;i<this.T;i++)r[t][s][i]&&this.propagator[t][s].push(i)}}}onBoundary(t,s){return!this.periodic&&(t<0||s<0||t>=this.FMX||s>=this.FMY)}clear(){super.clear();for(let t of this.Ci)t.onClear(),this.propagate()}backtrackConstraint(t,s){for(let i of this.Ci)i.onBacktrack(t,s)}banConstraint(t,s){for(let i of this.Ci)i.onBan(t,s)}initConstraint(){for(let t of this.Ci)if(t.init(this),this.status!=_s.Undecided)return void this.debug}stepConstraint(){for(let t of this.Ci){if(t.check(),this.status!=_s.Undecided)return void this.debug;if(this.propagate(),this.status!=_s.Undecided)return void this.debug}this.deferredConstraintsStep=!1}testObserved(t){let s=t%this.FMX,i=Math.floor(t/this.FMX);if(!this.onBoundary(s,i)){this.wave[t].filter(t=>t).length}}graphics(t){const s=this.tileset.size;null==this.Ti&&(this.Ti=new h.Application({width:this.FMX*s*1,height:this.FMY*s*1,resolution:1,antialias:!1,autoStart:!1,sharedTicker:!1,sharedLoader:!1}),document.body.appendChild(this.Ti.view));const i=this.Ti;this.Ti.stage.removeChildren();const e=new h.Container;if(e.scale.set(1,1),i.stage.addChild(e),null!=this.observed)for(let t=0;t<this.FMX;t++)for(let i=0;i<this.FMY;i++){let[h,n]=this.tileset.cells[this.observed[t+i*this.FMX]];if(h>=0){const n=this.rs.sprite(this.tileset.tiles[h]);n.position.set(t*s,i*s),n.zIndex=1,e.addChild(n)}if(n>=0){const h=this.rs.sprite(this.tileset.tiles[n]);h.position.set(t*s,i*s),h.zIndex=2,e.addChild(h)}}else for(let t=0;t<this.FMX;t++)for(let i=0;i<this.FMY;i++){let h=this.wave[t+i*this.FMX],n=0;for(let t=0;t<this.T;t++)h[t]&&(n+=this.weights[t]);const r=1/n;for(let n=0;n<this.T;n++)if(h[n]){const[h,o]=this.tileset.cells[n],l=(h>=0?1:0)+(o>=0?1:0);if(h>=0){const o=this.rs.sprite(this.tileset.tiles[h]);o.position.set(t*s,i*s),o.zIndex=1,o.alpha=r*(1/l)*this.weights[n],e.addChild(o)}if(o>=0){const h=this.rs.sprite(this.tileset.tiles[o]);h.position.set(t*s,i*s),h.zIndex=2,h.alpha=r*(1/l)*this.weights[n],e.addChild(h)}}}const n=new h.Graphics;e.addChild(n),n.lineStyle(1,16711680);for(let i of t){let t=i%this.FMX,h=Math.floor(i/this.FMX);n.drawRect(t*s,h*s,s,s)}i.render();i.view}}class Bs{constructor(t){this.Li=null,this.V=t}init(t){this.Li=t}onClear(){const t=this.Li,s=new Ls(this.V,t.rng);s.generate();const i=xs(t.FMX*t.FMY,!1);for(let h=0;h<s.config.height;h++)for(let e=0;e<s.config.width;e++){const n=e+h*t.FMX;i[n]=s.isMapOpen({x:e,y:h})}function h(s){let h=s%t.FMX,e=Math.floor(s/t.FMX);for(let s=0;s<=1;s++)for(let n=-1;n<=1;n++)if(0!==n||0!==s){let r=h+n,o=e+s;if(t.onBoundary(r,o))continue;if(!i[r+o*t.FMX])return!1}return!0}function e(s,h=2){let e=s%t.FMX,n=Math.floor(s/t.FMX);for(let s=-1;s<=h;s++)for(let h=-1;h<=1;h++)if(0!==h||0!==s){let r=e+h,o=n+s;if(t.onBoundary(r,o))continue;if(i[r+o*t.FMX])return!0}return!1}function n(s,h,e){let n=s%t.FMX+h,r=Math.floor(s/t.FMX)+e;return t.onBoundary(n,r)?null:i[n+r*t.FMX]}for(let s=0;s<i.length;s++){const r=xs(6,!1),o=n(s,0,1);if(i[s])r[$s.EMPTY]=!1,r[$s.FLOOR]=!0,h(s)||(r[$s.FLOOR_WALL_TOP]=!0);else if(e(s)){const t=n(s,0,-1);r[$s.EMPTY]=!(!0===t||!0===o),r[$s.WALL_MID]=!0===t||!0===o,r[$s.WALL_TOP]=!0,r[$s.WALL_SIDE]=!0}else r[$s.EMPTY]=!0;for(let i=0;i<t.T;i++){r[t.tileset.cells[i][2]]||t.ban(s,i)}}}check(){}onBacktrack(t,s){}onBan(t,s){}}var Us=(t,s,i,h)=>new(i||(i=Promise))((e,n)=>{function r(t){try{l(h.next(t))}catch(t){n(t)}}function o(t){try{l(h.throw(t))}catch(t){n(t)}}function l(t){var s;t.done?e(t.value):(s=t.value,s instanceof i?s:new i(t=>{t(s)})).then(r,o)}l((h=h.apply(t,s||[])).next())});class Hs extends class{constructor(t){this.resources=t.resources,this.controller=t}createDungeon(t,s,i,e,n){return new A(this.controller,new h.Ticker,t,s,i,e,n)}replaceFloorRandomly(t,s){const i=["floor_2.png","floor_3.png","floor_4.png","floor_5.png","floor_6.png","floor_7.png","floor_8.png"];for(let h=0;h<s.height;h++)for(let e=0;e<s.width;e++){const n=s.cell(e,h);n.hasFloor&&t.float()<.2&&(n.floorName=t.select(i))}}replaceWallRandomly(t,s){const i=["wall_banner_red.png","wall_banner_blue.png","wall_banner_green.png","wall_banner_yellow.png"],h=["wall_goo.png"],e=["wall_fountain_mid_red","wall_fountain_mid_blue"],n=["wall_hole_1.png","wall_hole_2.png"];for(let r=0;r<s.height;r++)for(let o=0;o<s.width;o++){if("wall_mid.png"===s.cell(o,r).wallName&&t.float()<.3){const l=[...n],a=r+1<s.height&&"floor_1.png"===s.cell(o,r+1).floorName;a&&(l.push(...i),l.push(...h)),r>0&&"wall_top_mid.png"===s.cell(o,r-1).wallName&&a&&l.push(...e);const c=t.select(l);switch(c){case"wall_goo.png":s.cell(o,r).wallName="wall_goo.png",s.cell(o,r+1).floorName="wall_goo_base.png";break;case"wall_fountain_mid_red":s.cell(o,r-1).wallName="wall_fountain_top.png",s.cell(o,r).wallName="wall_fountain_mid_red",s.cell(o,r+1).floorName="wall_fountain_basin_red";break;case"wall_fountain_mid_blue":s.cell(o,r-1).wallName="wall_fountain_top.png",s.cell(o,r).wallName="wall_fountain_mid_blue",s.cell(o,r+1).floorName="wall_fountain_basin_blue";break;default:s.cell(o,r).wallName=c}}}}distance(t,s){return Math.max(Math.abs(t.x-s.x),Math.abs(t.y-s.y))}findFreePositions(t,s,i){const h=[];for(let e=i;e<t.height;e++)for(let n=0;n<t.width-s;n++){let r=!0;for(let h=0;h<i&&r;h++)for(let i=0;i<s&&r;i++){const s=t.cell(n+i,e-h);r=s.hasFloor&&!s.hasObject}r&&h.push(t.cell(n,e))}return h}placeHero(t,s,i){const h=this.findFreePositions(s,2,2);if(0===h.length)throw"hero not placed";const e=t.select(h),n=new Qt(i,s,e.x,e.y);return s.light.addLight(n.view.point,S.HERO),n}placeNpc(t,s,i){for(let h=0;h<5;h++){const h=this.findFreePositions(s,2,2).filter(t=>this.distance(i,t)<10);h.length;const e=t.range(0,h.length),[n]=h.splice(e,1),r=t.select(fs);new ws(r,s,this.controller,n.x,n.y)}}placeMonsters(t,s,i){const h=s.width*s.height,e=Math.floor(.4*h),n=Math.floor(.2*e),r=Math.floor(.07*n);for(let h=0;h<r&&this.placeMonster(t,s,i);h++);}placeMonster(t,s,i){const h=this.bossConfig(s).category,e=ts.filter(t=>t.category===h||t.category!=Gt.DEMON&&t.category!=Gt.ORC&&t.category!=Gt.ZOMBIE);if(0===e.length)return!1;const n=this.findFreePositions(s,2,2).filter(t=>this.distance(i,t)>15);if(0===n.length)return!1;const r=t.range(0,n.length);let[o]=n.splice(r,1);const l=t.select(e);return new is(l,s,o.x,o.y),!0}placeBoss(t,s,i){const h=this.findFreePositions(s,2,2).filter(t=>this.distance(i,t)>20);if(h.length>0){const i=t.range(0,h.length);let[e]=h.splice(i,1);const n=this.bossConfig(s);new ns(n,s,e.x,e.y)}}bossConfig(t){return hs[Math.floor(t.level/5)%hs.length]}placeDrop(t,s){const i=[];for(let t=0;t<s.height;t++)for(let h=0;h<s.height;h++){const e=s.cell(h,t);!e.hasFloor||e.hasDrop||e.hasObject||i.push(e)}const h=Math.floor(3*i.length/100);for(let s=0;s<h&&i.length>0;s++){const s=t.range(0,i.length);i.splice(s,1)[0].randomDrop()}}placeLadder(t,s,i){const h=[],e=[],n=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]];for(let t=1;t<s.height-1;t++)for(let r=1;r<s.height-1;r++){const o=s.cell(r,t);if(o.hasFloor){let l=0;for(let[i,h]of n)s.cell(r+i,t+h).hasFloor&&l++;const a=this.distance(i,{x:r,y:t});l===n.length?h.push([o,a]):e.push([o,a])}}h.sort((t,s)=>t[1]-s[1]),e.sort((t,s)=>t[1]-s[1]);const r=[...e,...h].reverse().splice(0,10);if(0==r.length)throw"ladder not set";t.select(r)[0].ladder()}placeBonfire(t,s,i){const h=this.findFreePositions(s,2,2).filter(t=>this.distance(i,t)<10);if(h.length>0){const e=t.select(h),n=i.character.bonfires.has(s.level);return new gs(s,e.x,e.y,n)}throw"bonfire not placed"}}{constructor(t){super(t),this.Li=null}get percent(){var t;return(null===(t=this.Li)||void 0===t?void 0:t.percent)||0}generate(t){return Us(this,void 0,void 0,(function*(){const s=this.controller.app.loader.resources["dungeon.rules.4.json"].data,i=this.controller.app.loader.resources["dungeon.design.json"].data,h=t.hero;let e;h.dungeonSeeds.has(t.level)?e=h.dungeonSeeds.get(t.level):(e=this.controller.rng.int(),h.dungeonSeeds.set(t.level,e));const r=n.seeded(e);yield vs(10);const o=new Bs(i);let l;for(this.Li=new zs(this.resources,s,r,i.width,i.height,[o]);l=yield this.Li.run(1e4),l!==_s.Decided;)yield vs();const a=this.createDungeon(r,e,t.level,this.Li.FMX,this.Li.FMY),c=this.Li.observed;for(let t=0;t<this.Li.FMY;t++)for(let i=0;i<this.Li.FMX;i++){const h=i+t*this.Li.FMX,[e,n]=s.cells[c[h]];e>=0&&(a.cell(i,t).floorName=s.tiles[e]),n>=0&&(a.cell(i,t).wallName=s.tiles[n])}yield vs(),this.replaceFloorRandomly(r,a),yield vs(),this.replaceWallRandomly(r,a);const u=this.placeHero(r,a,t.hero);return yield vs(),this.placeLadder(r,a,u),yield vs(),t.level%5==1&&(this.placeBonfire(r,a,u),yield vs()),this.placeNpc(r,a,u),yield vs(),this.placeMonsters(r,a,u),yield vs(),t.level%5==0&&(this.placeBoss(r,a,u),yield vs()),this.placeDrop(r,a),yield vs(),a.light.loadMap(),yield vs(),a}))}}class Fs{constructor(t,s){this.ut=null,this.R=t,this.Ai=new Hs(this.R),this.$i=this.Ai.generate(s),this.$i.then(t=>this.R.dungeon(s.hero,t)),this.zi=new h.Graphics}init(){this.renderTitle(),this.renderProgressBar(),this.R.app.ticker.add(this.update,this)}destroy(){var t,s;this.R.app.ticker.remove(this.update,this),null===(t=this.ut)||void 0===t||t.destroy(),null===(s=this.zi)||void 0===s||s.destroy()}pause(){}resume(){}renderTitle(){this.ut=new h.BitmapText("ROGUELIKE DUNGEON",{font:{name:"alagard",size:64}}),this.ut.anchor=new h.Point(.5,0),this.ut.position.set(this.R.app.screen.width>>1,64),this.R.stage.addChild(this.ut)}renderProgressBar(){this.zi=new h.Graphics,this.R.stage.addChild(this.zi)}update(){const t=this.R.app.screen.width,s=this.R.app.screen.height,i=t-40-40,h=Math.floor((i-4-4)*this.Ai.percent/100);this.zi.clear(),this.zi.beginFill(V),this.zi.drawRect(40,s-40-60-4-4,i,60),this.zi.endFill(),this.zi.beginFill(Y),this.zi.drawRect(44,s-40-60-4,h,52),this.zi.endFill()}}class js{constructor(t,s,i){this.R=t,this.Y=i,this.Bi=new j,this.Ui=new kt(this.R.resources,s.inventory.belt),this.Hi=new Zt(s,{fixedHPSize:!1})}init(){const t=this.R.app.screen.width,s=this.R.app.screen.height;this.Bi.position.set(t>>1,16),this.Bi.zIndex=10,this.R.stage.addChild(this.Bi);const i=this.Ui.width;this.Ui.position.set((t>>1)-(i>>1),s-52),this.Ui.zIndex=11,this.R.stage.addChild(this.Ui),this.Hi.position.set(16,16),this.Hi.zIndex=12,this.R.stage.addChild(this.Hi),this.Bi.level=this.Y.level,this.Y.container.zIndex=0,this.R.stage.addChild(this.Y.container),this.Y.light.layer.zIndex=1,this.R.stage.addChild(this.Y.light.layer),this.Y.lighting.zIndex=2,this.Y.lighting.alpha=.8,this.R.stage.addChild(this.Y.lighting),this.R.stage.sortChildren(),this.Y.ticker.start()}destroy(){this.Bi.destroy(),this.Hi.destroy(),this.Ui.destroy(),this.Y.destroy(),this.R.stage.removeChildren()}pause(){this.Y.ticker.stop()}resume(){this.Y.ticker.start()}}class Gs{constructor(t){this.R=t}init(){this.renderTitle(),this.renderHelp(),this.R.app.ticker.add(this.handleInput,this)}destroy(){this.R.app.ticker.remove(this.handleInput,this),this.R.stage.removeChildren()}pause(){}resume(){}renderTitle(){let t=new h.BitmapText("ROGUELIKE DUNGEON",{font:{name:"alagard",size:64}});t.anchor=new h.Point(.5,0),t.position.set(this.R.app.screen.width>>1,64),this.R.stage.addChild(t)}renderHelp(){const t=["WASD - top, left, bottom, right","F - action","Q - drop weapon","I - inventory","1 ... 0 - belt","","PRESS F TO CONTINUE"];for(let s=0;s<t.length;s++){const i=t[s];if(i.length>0){const t=new h.BitmapText(i,{font:{name:"alagard",size:32}});t.position.set(40,200+30*s),this.R.stage.addChild(t)}}}handleInput(){this.R.joystick.hit.once()&&this.R.selectHero()}}class Ws{constructor(t){this.Fi=[],this.R=t,this.Vt=new rt(t.joystick)}init(){this.renderTitle(),this.renderHeroes(),this.R.app.ticker.add(this.Vt.handleInput,this.Vt)}destroy(){this.R.app.ticker.remove(this.Vt.handleInput,this.Vt),this.Fi.forEach(t=>t.destroy()),this.R.stage.removeChildren()}pause(){}resume(){}renderTitle(){let t=new h.BitmapText("ROGUELIKE DUNGEON",{font:{name:"alagard",size:64}});t.anchor=new h.Point(.5,0),t.position.set(this.R.app.screen.width>>1,64),this.R.stage.addChild(t)}renderHeroes(){const t=this.R.app.screen.width,s=this.R.app.screen.height,i=Jt.length,h=Math.floor((t-40*(i+1))/i),e=(h-80)/16,n=Math.floor(28*e)+32+120;for(let t=0;t<i;t++){const i=Jt[t],e=40*(t+1)+h*t,r=(s>>1)-(n>>1),o=new Ks(h,n,i,this.R.resources);o.position.set(e,r),this.Fi.push(o),this.R.stage.addChild(o),this.Vt.set(t,0,o,()=>this.select(i))}this.Vt.reset()}select(t){const s=Yt.load(t,this.R.persistent),i=new b(m.knife);s.inventory.equipment.weapon.set(i),this.R.generateDungeon({level:1,hero:s})}}class Ks extends h.Container{constructor(t,s,i,e){super(),this.ji=!1,this.Gi=(new h.Graphics).beginFill(Y).drawRect(0,0,t,s).endFill(),this.Wi=(new h.Graphics).beginFill(Q).drawRect(0,0,t,s).endFill(),this.ut=new h.BitmapText(i,{font:{name:"alagard",size:32}}),this.ut.anchor=.5,this.ut.position.set(t>>1,40);const n=t-80,r=n/16,o=Math.floor(28*r);this.ct=e.animated(i+"_idle"),this.ct.width=n,this.ct.height=o,this.ct.position.set(40,112),this.addChild(this.Gi,this.Wi,this.ut,this.ct),this.selected=!1}get selected(){return this.ji}set selected(t){this.ji=t,t?(this.Gi.visible=!0,this.Wi.visible=!1,this.ut.visible=!0,this.ct.gotoAndPlay(0)):(this.Gi.visible=!1,this.Wi.visible=!0,this.ut.visible=!1,this.ct.gotoAndStop(0))}destroy(){super.destroy(),this.Gi.destroy(),this.Wi.destroy(),this.ut.destroy(),this.ct.destroy()}}class Xs{constructor(t,s){this.ut=null,this.ct=null,this.Ki=null,this.D=null,this.ns=null,this.us=[],this.R=t,this.qt=s.hero,this.Xi=s,this.Vt=new rt(t.joystick)}init(){const t=new et;this.renderTitle(t),this.renderState(t),this.renderIcon(t),this.renderContinue(t),t.reset(),t.offset(256+it,0),t.commit(),this.renderIncreaseHealth(t),t.reset(),t.offset(24+2*it,0),t.commit(),this.renderInventory(t),this.Vt.reset(),this.R.app.ticker.add(this.handleInput,this)}destroy(){var t,s,i,h,e;this.R.app.ticker.remove(this.handleInput,this),null===(t=this.ut)||void 0===t||t.destroy(),null===(s=this.ct)||void 0===s||s.destroy(),null===(i=this.Ki)||void 0===i||i.destroy(),null===(h=this.D)||void 0===h||h.destroy(),null===(e=this.ns)||void 0===e||e.destroy();for(let t of this.us)t.destroy();this.ct=null,this.Ki=null,this.ut=null,this.D=null,this.ns=null,this.us.splice(0,1e3)}pause(){}resume(){}renderTitle(t){this.ut=new h.BitmapText("ROGUELIKE DUNGEON",{font:{name:"alagard",size:64}}),this.ut.anchor=new h.Point(.5,0),this.ut.position.set(this.R.app.screen.width>>1,64),this.R.stage.addChild(this.ut),t.offset(0,128+it),t.commit()}renderState(t){t.offset(it,0),t.commit(),this.D=new Zt(this.qt,{fixedHPSize:!0}),this.D.position.set(t.x,t.y),this.R.stage.addChild(this.D),t.offset(0,this.D.getBounds().height)}renderIcon(t){this.ct=this.R.resources.animated(this.qt.name+"_idle");const s=this.ct.width,i=this.ct.height;this.ct.width=256-(it<<1);const e=this.ct.width/s;this.ct.height=Math.floor(e*i);const n=Math.floor(e*this.ct.texture.trim.height),r=this.ct.height-n;t.offset(0,it),this.ct.position.set(t.x+it,t.y+it-r),this.Ki=(new h.Graphics).beginFill(V).drawRect(0,0,256,n+(it<<1)).endFill(),this.Ki.position.set(t.x,t.y),this.R.stage.addChild(this.Ki,this.ct),t.offset(0,n+(it<<1))}renderIncreaseHealth(t){const s=new ht({label:"+",width:24,height:24});s.position.set(t.x,t.y),this.Vt.set(1,0,s,()=>this.qt.increaseHealth()),this.Vt.merge(1,0,1,12),this.us.push(s),this.R.stage.addChild(s),t.offset(0,24)}renderContinue(t){t.offset(0,it);const s=new ht({label:"Continue ...",width:256,height:32});s.position.set(t.x,t.y),this.Vt.set(0,0,s,()=>this.R.generateDungeon(this.Xi)),this.Vt.merge(0,0,1,12),this.us.push(s),this.R.stage.addChild(s),t.offset(0,32)}renderInventory(t){const s=new yt(this.qt.inventory);this.ns=new bt(this.R.resources,s,this.Vt,2,0),this.ns.position.set(t.x,t.y),this.R.stage.addChild(this.ns)}handleInput(){this.Vt.handleInput()}}class qs{constructor(t,s){this.ei=null,this.qi=null,this.ut=null,this.Ji=null,this.Vt=null,this.Ui=null,this.R=t,this.Vi=s}init(){this.Vt=new rt(this.R.joystick),this.ei=new at({background:{color:0}}),this.qi=new ct({padding:0}),this.ei.addChild(this.qi),this.Ji=new ht({label:"X",width:40,height:32}),this.qi.addChild(this.Ji),this.Vt.set(0,0,this.Ji,()=>this.R.closeModal()),this.ut=new h.BitmapText(this.Vi.title,{font:{name:"alagard",size:32}}),this.qi.addChild(this.ut),this.Ui=new bt(this.R.resources,this.Vi,this.Vt,0,1),this.Ui.position.set(it,it),this.Ui.calculateBounds(),this.Ui.zIndex=1,this.ei.addChild(this.Ui);const t=this.ei.width,s=this.ei.height;this.ei.position.set((this.R.app.screen.width>>1)-(t>>1),(this.R.app.screen.height>>1)-(s>>1)),this.R.stage.addChild(this.ei),this.R.app.ticker.add(this.handleInput,this)}destroy(){var t,s,i,h,e;this.R.app.ticker.remove(this.handleInput,this),null===(t=this.ei)||void 0===t||t.destroy(),this.ei=null,null===(s=this.qi)||void 0===s||s.destroy(),this.qi=null,null===(i=this.ut)||void 0===i||i.destroy(),this.ut=null,null===(h=this.Ji)||void 0===h||h.destroy(),this.Ji=null,null===(e=this.Ui)||void 0===e||e.destroy(),this.Ui=null,this.Vt=null}handleInput(){var t;this.R.joystick.inventory.once()?this.R.closeModal():null===(t=this.Vt)||void 0===t||t.handleInput()}}class Js{constructor(t,s){this.Yi=new Map,this.Qi=t,this.Zi=s}clear(){for(let t of Object.keys(this.Qi))t.startsWith(this.Zi)&&this.Qi.removeItem(t);this.Yi.clear()}load(t){const s=this.Qi.getItem(this.key(t));return null!==s?JSON.parse(s):null}save(t,s){this.Yi.set(t,s),this.Qi.setItem(this.key(t),JSON.stringify(s))}commit(){for(let[t,s]of this.Yi)this.Qi.setItem(this.key(t),JSON.stringify(s));this.Yi.clear()}key(t){return[this.Zi,t].join()}}class Vs{constructor(){const t="localhost"===location.hostname||"0.0.0.0"===location.hostname||"127.0.0.1"===location.hostname?sessionStorage:localStorage;this.global=new Js(t,"global."),this.session=new Js(t,"session.")}}var Ys,Qs;(t=>{t[t.Started=1]="Started",t[t.ParsingNumber=2]="ParsingNumber",t[t.ParsingStringStarted=3]="ParsingStringStarted",t[t.ParsingString=4]="ParsingString",t[t.ParsingStringFinished=5]="ParsingStringFinished",t[t.ParsingFunction=6]="ParsingFunction",t[t.Finished=7]="Finished",t[t.ParsingContext=8]="ParsingContext",t[t.ParsingBracket=9]="ParsingBracket",t[t.Error=10]="Error"})(Ys||(Ys={})),(t=>{t[t.Delimiter=1]="Delimiter",t[t.Digit=2]="Digit",t[t.Bracket=3]="Bracket",t[t.Other=4]="Other",t[t.ContextBracket=5]="ContextBracket",t[t.Quote=6]="Quote"})(Qs||(Qs={}));const Zs={[Ys.Started]:{[Qs.Delimiter]:Ys.Started,[Qs.Digit]:Ys.ParsingNumber,[Qs.Bracket]:Ys.ParsingBracket,[Qs.Other]:Ys.ParsingFunction,[Qs.ContextBracket]:Ys.ParsingContext,[Qs.Quote]:Ys.ParsingStringStarted},[Ys.ParsingNumber]:{[Qs.Delimiter]:Ys.Finished,[Qs.Digit]:Ys.ParsingNumber,[Qs.Bracket]:Ys.Finished,[Qs.Other]:Ys.Finished,[Qs.ContextBracket]:Ys.Error,[Qs.Quote]:Ys.Error},[Ys.ParsingFunction]:{[Qs.Delimiter]:Ys.Finished,[Qs.Digit]:Ys.ParsingFunction,[Qs.Bracket]:Ys.Finished,[Qs.Other]:Ys.ParsingFunction,[Qs.ContextBracket]:Ys.Error,[Qs.Quote]:Ys.Error},[Ys.ParsingContext]:{[Qs.Delimiter]:Ys.Finished,[Qs.Digit]:Ys.ParsingContext,[Qs.Bracket]:Ys.Finished,[Qs.Other]:Ys.ParsingContext,[Qs.ContextBracket]:Ys.ParsingContext,[Qs.Quote]:Ys.Error},[Ys.ParsingBracket]:{[Qs.Delimiter]:Ys.Finished,[Qs.Digit]:Ys.Finished,[Qs.Bracket]:Ys.Finished,[Qs.Other]:Ys.Finished,[Qs.ContextBracket]:Ys.Finished,[Qs.Quote]:Ys.Finished},[Ys.ParsingStringStarted]:{[Qs.Delimiter]:Ys.ParsingString,[Qs.Digit]:Ys.ParsingString,[Qs.Bracket]:Ys.ParsingString,[Qs.Other]:Ys.ParsingString,[Qs.ContextBracket]:Ys.ParsingString,[Qs.Quote]:Ys.Finished},[Ys.ParsingString]:{[Qs.Delimiter]:Ys.ParsingString,[Qs.Digit]:Ys.ParsingString,[Qs.Bracket]:Ys.ParsingString,[Qs.Other]:Ys.ParsingString,[Qs.ContextBracket]:Ys.ParsingString,[Qs.Quote]:Ys.ParsingStringFinished},[Ys.ParsingStringFinished]:{[Qs.Delimiter]:Ys.Finished,[Qs.Digit]:Ys.Finished,[Qs.Bracket]:Ys.Finished,[Qs.Other]:Ys.Finished,[Qs.ContextBracket]:Ys.Finished,[Qs.Quote]:Ys.Finished}};class ti{constructor(){this.th={"+":{priority:0,variable:!1,apply:(t,s)=>t+s},"-":{priority:0,variable:!1,apply:(t,s)=>t-s},"*":{priority:1,variable:!1,apply:(t,s)=>t*s},"/":{priority:1,variable:!1,apply:(t,s)=>t/s},"%":{priority:1,variable:!1,apply:(t,s)=>t%s},or:{priority:0,variable:!1,apply:(t,s)=>t||s},and:{priority:1,variable:!1,apply:(t,s)=>t&&s},"!":{priority:2,variable:!1,apply:t=>!t},true:{priority:100,variable:!1,apply:()=>!0},false:{priority:100,variable:!1,apply:()=>!1},$$getContextValue:{priority:100,variable:!1,apply:(t,s)=>s[t.substring(1,t.length-1)]}},this.gt={}}static classifySymbol(t){return-1!==ti.delimiters.indexOf(t)?Qs.Delimiter:-1!==ti.brackets.indexOf(t)?Qs.Bracket:-1!==ti.digits.indexOf(t)?Qs.Digit:-1!==ti.contextBrackets.indexOf(t)?Qs.ContextBracket:-1!==ti.quotes.indexOf(t)?Qs.Quote:Qs.Other}isOfMoreOrEqualPriority(t,s){return this.th[t].priority<=this.th[s].priority}scanToken(t,s){let i=Ys.Started,h=Ys.Error,e="",n=s;for(;n<t.length&&i!==Ys.Finished&&i!==Ys.Error;){let s=ti.classifySymbol(t[n]);i=Zs[i][s],i===Ys.ParsingFunction&&void 0!==this.th[e]&&(i=Ys.Finished),i===Ys.ParsingFunction||i===Ys.ParsingNumber||i===Ys.ParsingBracket||i===Ys.ParsingContext||i===Ys.ParsingString?(h=i,e+=t[n++]):i!==Ys.Started&&i!==Ys.ParsingStringStarted&&i!==Ys.ParsingStringFinished||n++}return""===e&&(h=Ys.Error),{workingState:h,tokenString:e,pos:n}}convertToRPN(t){let s,i=[],h=[],e=0;for(let n=0;n<t.length;n++)if("n"!==t[n].type)if("("!==t[n].type)if(")"!==t[n].type){if(-1!==Object.keys(this.th).indexOf(t[n].type)){if(i.length>0){do{s=i.pop(),h[e++]=s}while(i.length>0&&-1===ti.brackets.indexOf(h[e-1].type)&&this.isOfMoreOrEqualPriority(t[n].type,h[e-1].type));-1===ti.brackets.indexOf(h[e-1].type)&&this.isOfMoreOrEqualPriority(t[n].type,h[e-1].type)||(i.push(s),e--)}i.push(t[n])}}else{do{s=i.pop(),h[e++]=s}while("("!==h[e-1].type);e--}else i.push(t[n]);else h[e++]=t[n];for(;i.length>0;)s=i.pop(),h[e++]=s;return h}calculateRPN(t){var s;let i=[];if(0===t.length)return null;for(let s=0;s<t.length;s++)if("n"===t[s].type)i.push(t[s]);else{let h=this.th[t[s].type],e=h.apply,n=h.variable?i.length:e.length,r=i.splice(i.length-n).map(t=>t.value),o=e.apply(null,r);i.push({type:"n",value:o})}return(null===(s=i.shift())||void 0===s?void 0:s.value)||null}tokenize(t){const s=[];for(let i=0;i<t.length;){let h=this.scanToken(t,i);h.workingState!==Ys.Error&&(h.workingState===Ys.ParsingNumber?s.push({type:"n",value:-1!==h.tokenString.indexOf(".")?parseFloat(h.tokenString):parseInt(h.tokenString)}):h.workingState===Ys.ParsingContext?(s.push({type:"$$getContextValue",value:null}),s.push({type:"n",value:h.tokenString}),s.push({type:"n",value:this.gt})):h.workingState===Ys.ParsingString?s.push({type:"n",value:h.tokenString}):s.push({type:h.tokenString,value:null})),i=h.pos}return s}register(t,s,i,h){this.th[t]={priority:s,variable:i,apply:h}}evaluate(t,s={}){this.gt=s;const i=this.tokenize(t),h=this.convertToRPN(i);return this.calculateRPN(h)}}ti.digits="0123456789.",ti.brackets="()",ti.contextBrackets="{}",ti.delimiters=" ,\r\r\n",ti.quotes="'\"";class si{constructor(){this.gt={}}add(t,s){this.gt[t]=s}render(t){return t.replace(/{{([^}]+)}}/g,(t,s)=>{let i=s.split(".");if(i.length>=1){let t=this.gt;for(;i.length>0;){const[s]=i.splice(0,1);t=t[s]}return t||null}return s})}}class ii{constructor(t){this.R=t}dialog(t,s){const i=this.R.app.loader.resources["dialogs.json"].data,h=i[s.name]||i.default;return new hi(this.R,t,s,h)}}class hi{constructor(t,s,i,h){this.sh=new W,this.R=t,this.hero=s,this.npc=i,this.V=h,this.ih=new ti,this.ih.register("goto",100,!0,this.goto.bind(this)),this.ih.register("exit",100,!1,this.exit.bind(this)),this.ih.register("context",100,!1,this.context.bind(this)),this.ih.register("hasSkill",100,!1,this.hasSkill.bind(this)),this.ih.register("skill",100,!1,this.skill.bind(this)),this.hh=new si,this.hh.add("hero",this.hero),this.hh.add("npc",this.npc)}get question(){return this.sh}start(){this.goto(...this.V.start)}hasSkill(t){return this.npc.hasSkill(t)}skill(t){var s;null===(s=this.npc.getSkill(t))||void 0===s||s.use(this.hero)}exit(){this.R.closeModal()}context(t,s){return void 0===s?this.npc.getContext(t):(this.npc.setContext(t,s),null)}goto(...t){for(let s of t){const t=this.V.questions[s];if(this.check(t.conditions||[])){const s=this.hh.render(t.text),i=new ei(this,s);for(let s of t.answers)if(this.check(s.conditions)){const t=this.hh.render(s.text);i.add(t,s.commands)}return void this.sh.send(i)}}}check(t){if(t)for(let s of t)if(!this.evaluate(s))return!1;return!0}evaluate(t){return this.ih.evaluate(t)}}class ei{constructor(t,s){this.answers=[],this.eh=t,this.text=s}add(t,s){this.answers.push(new ni(this.eh,t,s))}}class ni{constructor(t,s,i){this.dialog=t,this.text=s,this.commands=i}action(){for(let t of this.commands)this.dialog.evaluate(t)}}class ri{constructor(t,s){this.ei=null,this.Ft=null,this.Vt=null,this._width=0,this.nh=new et,this.sh=null,this.rh=[],this.R=t,this.eh=s}init(){this.Ft=new h.Graphics,this.Vt=new rt(this.R.joystick);this.Ft.beginFill(0).drawRect(0,0,600,400).endFill(),this.Ft.zIndex=0,this.ei=new h.Container,this.ei.addChild(this.Ft),this.ei.sortChildren(),this.ei.position.set((this.R.app.screen.width>>1)-300,(this.R.app.screen.height>>1)-200);const t=this.nh;t.offset(it,it);const s=this.R.resources.animated(this.eh.npc.name+"_idle");s.width=4*s.width,s.height=4*s.height,s.position.set(t.x+st,t.y+st);const i=new h.Graphics;i.beginFill(V).drawRect(t.x,t.y,s.width+2*st,s.height+2*st).endFill(),t.reset(),t.offset(s.width,0),t.offset(it,0),t.offset(2*st,0),t.commit(),this._width=600-t.x,this.ei.addChild(i,s),this.R.stage.addChild(this.ei),this.R.app.ticker.add(this.handleInput,this),this.eh.question.subscribe(this.onQuestion,this),this.eh.start()}destroy(){var t,s;this.eh.question.unsubscribe(this.onQuestion,this),this.R.app.ticker.remove(this.handleInput,this),null===(t=this.ei)||void 0===t||t.destroy(),this.ei=null,null===(s=this.Ft)||void 0===s||s.destroy(),this.Ft=null,this.Vt=null}onQuestion(t){var s;null===(s=this.sh)||void 0===s||s.destroy();for(let t=0;t<this.rh.length;t++){this.rh[t].destroy(),this.Vt.remove(0,t)}this.Vt.reset(),this.rh=[];const i=this._width-2*it,h=this.nh;h.reset(),h.offset(it,it),this.sh=new oi(t,i),this.sh.position.set(h.x,h.y),this.ei.addChild(this.sh),h.offset(0,this.sh.height),h.offset(0,it);for(let s=0;s<t.answers.length;s++){let e=t.answers[s];const n=new li(e,i);this.Vt.set(0,s,n,e.action.bind(e)),n.position.set(h.x,h.y),h.offset(0,n.height),h.offset(0,it),this.rh.push(n),this.ei.addChild(n)}this.Vt.reset()}handleInput(){var t;null===(t=this.Vt)||void 0===t||t.handleInput()}}class oi extends h.Container{constructor(t,s){super(),this.St=new h.BitmapText(t.text,{font:{name:"alagard",size:16}}),this.St.maxWidth=s-2*st,this.St.calculateBounds(),this.St.position.set(st,st);const i=this.St.height+2*st;this.Ft=new h.Graphics,this.Ft.clear().beginFill(V).drawRect(0,0,s,i).endFill(),this.addChild(this.Ft,this.St)}}class li extends h.Container{constructor(t,s){super(),this.Mt=!1,this.Ft=new h.Graphics,this.St=new h.BitmapText(t.text,{font:{name:"alagard",size:16}}),this.St.maxWidth=s-2*st,this.St.calculateBounds(),this.St.position.set(st,st),this._width=s,this._height=this.St.height+2*st,this.selected=!1,this.addChild(this.Ft,this.St)}get selected(){return this.Mt}set selected(t){this.Mt=t,this.Ft.clear().beginFill(t?Y:Q).drawRect(0,0,this._width,this._height).endFill()}}class ai extends h.Container{constructor(t,s){super(),this.oh=120,this.lh=60,this.R=t;const i=this.R.app.screen,e=Math.floor(.7*i.height);this.St=new h.BitmapText(s.text,{font:{name:"alagard",size:64},align:"center",tint:s.color}),this.St.anchor=new h.Point(.5,.5),this.St.position.set(i.width>>1,e);const n=new h.filters.BlurFilter;n.blurY=1,n.blurX=10,n.quality=4,this.ah=new h.BitmapText(s.text,{font:{name:"alagard",size:64},align:"center",tint:s.color}),this.ah.anchor=new h.Point(.5,.5),this.ah.position.set(i.width>>1,e),this.ah.width+=44.8,this.ah.alpha=.5,this.ah.filters=[n],this.ah.filterArea=this.ah.getBounds().clone().pad(50,0),this.uh=ai.gradient(1,128),this.Ft=new h.TilingSprite(this.uh,i.width,128),this.Ft.position.set(0,e-64),this.addChild(this.Ft,this.ah,this.St),this.R.stage.addChild(this),this.R.app.ticker.add(this.update,this)}update(t){this.oh>0?this.oh-=t:this.lh>0?(this.lh-=t,this.alpha=this.lh/60):this.R.closeBanner()}destroy(){super.destroy(),this.R.app.ticker.remove(this.update,this),this.St.destroy(),this.Ft.destroy(),this.uh.destroy(!0)}static gradient(t,s){const i=document.createElement("canvas");i.width=t,i.height=s;const e=i.getContext("2d"),n=e.createLinearGradient(0,0,0,s);return n.addColorStop(0,"rgba(0, 0, 0, 0)"),n.addColorStop(.3,"rgba(0, 0, 0, 1)"),n.addColorStop(.7,"rgba(0, 0, 0, 1)"),n.addColorStop(1,"rgba(0, 0, 0, 0)"),e.fillStyle=n,e.fillRect(0,0,t,s),h.Texture.from(i)}}var ci=(t,s,i,h)=>new(i||(i=Promise))((e,n)=>{function r(t){try{l(h.next(t))}catch(t){n(t)}}function o(t){try{l(h.throw(t))}catch(t){n(t)}}function l(t){var s;t.done?e(t.value):(s=t.value,s instanceof i?s:new i(t=>{t(s)})).then(r,o)}l((h=h.apply(t,s||[])).next())});class ui{constructor(t,s){this.fh=null,this.dh=null,this.wh=null,this.persistent=new Vs,this.rng=n.create(),this.joystick=new l,this.resources=new c(t.loader),this.app=t,this.stage=s,this.dialogs=new ii(this),this.app.ticker.add(this.persistent.global.commit,this.persistent.global,h.UPDATE_PRIORITY.LOW),this.app.ticker.add(this.persistent.session.commit,this.persistent.session,h.UPDATE_PRIORITY.LOW)}init(){return ci(this,void 0,void 0,(function*(){yield this.resources.load()}))}set scene(t){var s;null===(s=this.fh)||void 0===s||s.destroy(),this.joystick.reset(),this.fh=t,this.fh.init()}keyBind(){this.scene=new Gs(this)}selectHero(){this.scene=new Ws(this)}updateHero(t,s){this.scene=new Xs(this,{level:s,hero:t})}dead(){this.scene=new u(this)}generateDungeon(t){this.scene=new Fs(this,t)}dungeon(t,s){this.scene=new js(this,t,s)}modal(t){var s;h.sound.play("text"),null===(s=this.fh)||void 0===s||s.pause(),this.joystick.reset(),this.dh=t,this.dh.init()}closeModal(){var t,s;null===(t=this.dh)||void 0===t||t.destroy(),this.joystick.reset(),null===(s=this.fh)||void 0===s||s.resume()}showInventory(t){const s=new yt(t.inventory);this.modal(new qs(this,s))}sellInventory(t,s){const i=new vt(t,s);this.modal(new qs(this,i))}buyInventory(t,s){const i=new _t(t,s);this.modal(new qs(this,i))}showDialog(t,s){const i=this.dialogs.dialog(t,s);this.modal(new ri(this,i))}showBonfire(t){this.modal(new ms(this,t))}showBanner(t){this.closeBanner(),this.wh=new ai(this,t)}closeBanner(){var t;null===(t=this.wh)||void 0===t||t.destroy(),this.wh=null}}var fi=(t,s,i,h)=>new(i||(i=Promise))((e,n)=>{function r(t){try{l(h.next(t))}catch(t){n(t)}}function o(t){try{l(h.throw(t))}catch(t){n(t)}}function l(t){var s;t.done?e(t.value):(s=t.value,s instanceof i?s:new i(t=>{t(s)})).then(r,o)}l((h=h.apply(t,s||[])).next())});!function(){fi(this,void 0,void 0,(function*(){PIXI.settings.SCALE_MODE=PIXI.SCALE_MODES.NEAREST,PIXI.settings.FAIL_IF_MAJOR_PERFORMANCE_CAVEAT=!1,PIXI.sound.volumeAll=.5;const t=new PIXI.Application({width:1200,height:700,resolution:1,antialias:!1}),s=new PIXI.display.Stage;t.stage=s,t.renderer.backgroundColor=0,document.getElementById("container").appendChild(t.view);const i=new ui(t,s);yield i.init(),i.keyBind()}))}()}]);
//# sourceMappingURL=bundle.js.map