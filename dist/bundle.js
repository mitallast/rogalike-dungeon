!function(t){"use strict";class s extends t.display.Stage{constructor(t){super(),this.t=t}}const i=1052688,h=2105376,e=7368816,n=4210752,r=16711680,o=12557824,l=4,a=16;class c extends t.Container{constructor(s){super(),this._backgroundColor=s.backgroundColor||h,this.s=s.color,this._width=s.width,this._height=s.height||16+(l<<1),this.i=0,this.h=s.o,this.l=s.u||!1,this.p=!0,this.g=new t.Graphics,this.m=new t.BitmapText(s.label||"",{font:{name:"alagard",size:16}}),this.v(this.g,this.m),this.update(),t.Ticker.shared.add(this.update,this,t.UPDATE_PRIORITY.LOW)}set backgroundColor(t){this._backgroundColor=t}set _(t){this.s=t,this.p=!0}set M(t){this._width=t,this.p=!0}set k(t){this._height=t,this.p=!0}set value(t){this.i=t,this.p=!0}set o(t){this.h=t,this.p=!0}set u(t){this.l=t,this.p=!0}set label(t){this.m.text=t}I(){t.Ticker.shared.remove(this.update,this),super.I({children:!0})}update(){if(!this.p)return;const s=this._width,i=this._height,h=l;this.m.anchor=new t.Point(this.l?.5:0,.5),this.m.position.set(this.l?s>>1:h<<1,i>>1);const e=Math.round((s-(h<<1))*Math.min(this.i,this.h)/this.h);this.g.clear().T(this._backgroundColor).N(0,0,s,i).O().T(this.s).N(h,h,e,i-(h<<1)).O(),this.p=!0}}class u extends t.Container{constructor(s){super(),this.D=!1,this._width=s.width||200,this._height=s.height||24,this.S=s.A||16,this.L=s.border||!1,this.P=new t.Graphics,this.R=new t.BitmapText(s.label,{font:{name:"alagard",size:this.S}}),this.R.anchor=new t.Point(.5,.5),this.R.position.set(this._width>>1,this._height>>1),this.selected=s.selected||!1,super.v(this.P,this.R)}get selected(){return this.D}set selected(t){this.D=t,this.L?this.P.clear().T(h).N(0,0,this._width,this._height).O().T(t?e:n).N(l,l,this._width-2*l,this._height-2*l).O():this.P.clear().T(t?e:n).N(0,0,this._width,this._height).O()}}class f extends t.Container{constructor(s={}){super(),this._width=0,this._height=0,this.C=!1,this.$=void 0!==s.spacing?s.spacing:a,this.B=void 0!==s.padding?s.padding:a,void 0!==s.backgroundColor?this.H=(new t.Graphics).T(s.backgroundColor).N(0,0,1,1).O():this.H=new t.Container,this.v(this.H)}U(){this.C=!0}_calculateBounds(){this._bounds.G(this.transform,0,0,this._width,this._height)}F(){this.C&&this.W(),super.F()}W(){let t=0,s=this.B;const i=this.B;let h=!0;for(const e of this.children){if(e===this.H)continue;h||(s+=this.$),h=!1,e.position.set(i,s),e.F();const n=e.j();s+=n.height,t=Math.max(t,n.width)}this._height=s+this.B,this._width=t+2*this.B,this.H.width=this._width,this.H.height=this._height,this._calculateBounds(),this.C=!1}}class d extends t.Container{constructor(s={}){super(),this._width=0,this._height=0,this.C=!1,this.$=void 0!==s.spacing?s.spacing:a,this.B=void 0!==s.padding?s.padding:a,void 0!==s.backgroundColor?this.H=(new t.Graphics).T(s.backgroundColor).N(0,0,1,1).O():this.H=new t.Container,this.v(this.H)}U(){this.C=!0}_calculateBounds(){this._bounds.G(this.transform,0,0,this._width,this._height)}F(){this.C&&this.W(),super.F()}W(){let t=0;const s=this.B;let i=this.B,h=!0;for(const e of this.children){if(e===this.H)continue;h||(i+=this.$),h=!1,e.position.set(i,s),e.F();const n=e.j();i+=n.width,t=Math.max(t,n.height)}this._width=i+this.B,this._height=t+2*this.B,this.H.width=this._width,this.H.height=this._height,this._calculateBounds(),this.C=!1}}function w(t,s){const i=s||0;if(t[i]>0)return i;const h=function(t,s){for(let i=s-1;i>=0;i--)if(t[i]>0)return i;return null}(t,i);if(null!==h)return h;const e=function(t,s){for(let i=s+1;i<t.length;i++)if(t[i]>0)return i;return null}(t,i);return null!==e?e:null}class p{constructor(t){this.K=[],this.V=[],this.X=[],this.q=-1,this.J=-1,this.Y=null,this.Z=null,this.tt=t}reset(){if(this.st(),this.Y=w(this.V,this.Y),this.Z=w(this.X,this.Z),null===this.Y||null===this.Z)this.Y=null,this.Z=null;else if(!this.ht(this.Y,this.Z).it){const t=this.Z,s=(s=>{for(let i=s-1;i>=0;i--)if(this.ht(i,t).it)return i;return null})(this.Y);if(null!==s)this.Y=s;else{const s=(s=>{for(let i=s+1;i<=this.q;i++)if(this.ht(i,t).it)return i;return null})(this.Y);if(null===s)throw"illegal state";this.Y=s}}this.mark()}et(){var t;if(this.st(),null!==this.Y&&null!==this.Z){const s=this.Z;if(0===this.X[s])throw"illegal state: empty column "+s;const i=null===(t=this.nt)||void 0===t?void 0:t.rt,h=this.Y,e=t=>t>0?t-1:this.q;for(let t=e(h);t!=h;t=e(t))if(!(null==i?void 0:i.contains(t,s))&&this.ht(t,s).it){this.Y=t;break}}this.mark()}ot(){var t;if(this.st(),null!==this.Y&&null!==this.Z){const s=this.Z;if(0===this.X[s])throw"illegal state: empty column "+s;const i=null===(t=this.nt)||void 0===t?void 0:t.rt,h=this.Y,e=t=>(t+1)%(this.q+1);for(let t=e(h);t!=h;t=e(t))if(!(null==i?void 0:i.contains(t,s))&&this.ht(t,s).it){this.Y=t;break}}this.mark()}lt(){var t;if(this.st(),null!==this.Y&&null!==this.Z){const s=this.Y;if(0===this.V[s])throw"illegal state: empty row "+s;const i=null===(t=this.nt)||void 0===t?void 0:t.rt,h=this.Z,e=t=>t>0?t-1:this.J;for(let t=e(h);t!=h;t=e(t))if(!(null==i?void 0:i.contains(s,t))&&this.ht(s,t).it){this.Z=t;break}}this.mark()}at(){var t;if(this.st(),null!==this.Y&&null!==this.Z){const s=this.Y;if(0===this.V[s])throw"illegal state: empty row "+s;const i=null===(t=this.nt)||void 0===t?void 0:t.rt,h=this.Z,e=t=>(t+1)%(this.J+1);for(let t=e(h);t!=h;t=e(t))if(!(null==i?void 0:i.contains(s,t))&&this.ht(s,t).it){this.Z=t;break}}this.mark()}select(t,s){this.ht(t,s).it&&(this.st(),this.Y=t,this.Z=s,this.mark())}st(){var t;null===(t=this.nt)||void 0===t||t.st()}mark(){var t;null===(t=this.nt)||void 0===t||t.mark()}get selected(){var t;return(null===(t=this.nt)||void 0===t?void 0:t.value)||null}get nt(){if(null!==this.Y&&null!==this.Z){const t=this.ht(this.Y,this.Z);return t.rt&&t.ct?this.ht(t.rt.ut,t.rt.ft):t}return null}set(t,s,i,h){if(t<0||s<0)throw`illegal coordinate: ${t}:${s}`;const e=this.ht(t,s);if(e.ct)throw`cell is ref: ${t}:${s}`;const n=null!==e.value;if(e.value=[i,h],!n)if(e.rt){const t=e.rt;for(let s=t.ut;s<=t.dt;s++)for(let i=t.ft;i<=t.wt;i++)this.V[s]++,this.X[i]++}else this.V[t]++,this.X[s]++;this.reset()}pt(t,s,i,h){if(t<0||s<0)throw`illegal coordinate: ${t}:${s}`;if(i<1||h<1)throw`illegal size: ${i}:${h}`;const e=new y(t,s,t+i-1,s+h-1),n=this.ht(t,s);if(n.ct)throw`cell is ref: ${t}:${s}`;if(n.rt)throw"cell is merged: "+JSON.stringify(n.rt);n.rt=e;const r=null!==n.value;for(let i=e.ut;i<=e.dt;i++)for(let h=e.ft;h<=e.wt;h++)if(i!==t||h!==s){const t=this.ht(i,h);if(t.value)throw`merging cell already has value: ${i}:${h}`;if(t.ct)throw`merging cell is ref: ${i}:${h}`;t.rt=e,r&&(this.V[i]++,this.X[h]++)}}remove(t,s){if(t<0||s<0)throw`illegal coordinate: ${t}:${s}`;const i=this.ht(t,s);if(i.ct)throw`cell is ref: ${t}:${s}`;if(i.value)if(i.value=null,i.rt){const t=i.rt;for(let s=t.ut;s<=t.dt;s++)for(let i=t.ft;i<=t.wt;i++)this.V[s]--,this.X[i]--}else this.V[t]--,this.X[s]--}gt(t,s){if(t<0||s<0)throw`illegal coordinate: ${t}:${s}`;const i=this.ht(t,s);if(i.ct)throw`cell is ref: ${t}:${s}`;if(i.rt){const h=null!==i.value,e=i.rt;i.rt=null;for(let i=e.ut;i<=e.dt;i++)for(let n=e.ft;n<=e.wt;n++)i===t&&n===s||(this.ht(i,n).rt=null,h&&(this.V[i]--,this.X[n]--))}}ht(t,s){if(t<0||s<0)throw"illegal coordinate";return this.expand(t,s),this.K[s][t]}expand(t,s){for(;this.J<s;){this.J++,this.X[this.J]=0,this.K[this.J]=[];for(let t=0;t<=this.q;t++)this.K[this.J][t]=new g(t,this.J)}for(;this.q<t;){this.q++,this.V[this.q]=0;for(let t=0;t<=this.J;t++)this.K[t][this.q]=new g(this.q,t)}}yt(){const s=this.tt;if(s.lt.once()&&this.lt(),s.at.once()&&this.at(),s.et.once()&&this.et(),s.ot.once()&&this.ot(),s.bt.once()){const s=this.selected;if(s){const[,i]=s;t.sound.play("confirm"),i()}else t.sound.play("cancel")}}}class g{constructor(t,s){this.x=t,this.y=s,this.rt=null,this.value=null}st(){this.value&&(this.value[0].selected=!1)}mark(){this.value&&(this.value[0].selected=!0)}get ct(){return null!==this.rt&&!(this.rt.ut===this.x&&this.rt.ft===this.y)}get it(){return null!==this.value||this.ct}}class y{constructor(t,s,i,h){this.ut=t,this.ft=s,this.dt=i,this.wt=h}contains(t,s){return t>=this.ut&&t<=this.dt&&s>=this.ft&&s<=this.wt}}class m extends f{constructor(s,h){super({backgroundColor:i}),this.t=s,this.vt=new p(s.xt);const e=new d({padding:0});this.v(e),this._t=new u({label:"X",width:40,height:32}),e.v(this._t),this.vt.set(0,0,this._t,()=>this.t.Mt()),this.kt=new t.BitmapText(h,{font:{name:"alagard",size:32}}),e.v(this.kt)}init(){this.t.ticker.add(this.vt.yt,this.vt)}I(){this.t.ticker.remove(this.vt.yt,this.vt),super.I({children:!0})}}const b=2.3283064365386963e-10;class v{constructor(t){if(t<=1)throw"Illegal seed number";return this.It=(t>>>0)*b,t=69069*t+1>>>0,this.Ot=t*b,t=69069*t+1>>>0,this.Nt=t*b,this.Tt=1,this}static create(){const t=crypto.getRandomValues(new Uint32Array(1))[0];return new v(t)}static Et(t){return new v(t)}float(){const t=2091639*this.It+this.Tt*b;return this.It=this.Ot,this.Ot=this.Nt,this.Tt=0|t,this.Nt=t-this.Tt,this.Nt}Dt(){return 4294967296*this.float()}St(){return this.float()<.5}range(t,s){return Math.floor(this.float()*(s-t))+t}At(t=0,s=1){let i,h,e;do{i=2*this.float()-1,h=2*this.float()-1,e=i*i+h*h}while(e>1||0==e);return t+i*Math.sqrt(-2*Math.log(e)/e)*s}Lt(t,s,i){let h=0,e=0;for(;0===h;)h=this.float();for(;0===e;)e=this.float();let n=Math.sqrt(-2*Math.log(h))*Math.cos(2*Math.PI*e);return n=n/10+.5,(n>1||n<0)&&(n=this.Lt(t,s,i)),n=Math.pow(n,i),n*=s-t,n+=t,n}select(t){return 0===t.length?null:t[Math.floor(this.float()*t.length)]}}var x;(t=>{t[t.Await=1]="Await",t[t.Pressed=2]="Pressed"})(x||(x={}));class _{constructor(t){this.code=t,this.Pt=x.Await,this.Rt=!1,this.Ct=!0}get $t(){return this.Rt}once(){return!this.Ct&&(this.Ct=!0,!0)}repeat(){return this.Ct?this.Rt:(this.Ct=!0,!0)}zt(t){t.code===this.code&&(t.preventDefault(),this.Pt===x.Await&&(this.Rt=!0,this.Ct=!1,this.Pt=x.Pressed))}Bt(t){t.code===this.code&&(t.preventDefault(),this.Pt===x.Pressed&&(this.Rt=!1,this.Pt=x.Await))}reset(){this.Rt=!1,this.Ct=!0}}class M{constructor(){this.lt=new _("KeyW"),this.et=new _("KeyA"),this.at=new _("KeyS"),this.ot=new _("KeyD"),this.bt=new _("KeyF"),this.Ht=new _("KeyQ"),this.Ut=new _("KeyI"),this.Gt=new _("Digit1"),this.Ft=new _("Digit2"),this.Wt=new _("Digit3"),this.jt=new _("Digit4"),this.Kt=new _("Digit5"),this.Vt=new _("Digit6"),this.Xt=new _("Digit7"),this.qt=new _("Digit8"),this.Jt=new _("Digit9"),this.Yt=new _("Digit0"),this.Qt={};for(const t of Object.getOwnPropertyNames(this)){const s=this[t];s&&s instanceof _&&(this.Qt[s.code]=s)}window.addEventListener("keydown",this.zt.bind(this)),window.addEventListener("keyup",this.Bt.bind(this))}Zt(t){switch(t){case 1:return this.Gt;case 2:return this.Ft;case 3:return this.Wt;case 4:return this.jt;case 5:return this.Kt;case 6:return this.Vt;case 7:return this.Xt;case 8:return this.qt;case 9:return this.Jt;case 0:return this.Yt}}reset(){var t;for(const s of Object.getOwnPropertyNames(this.Qt))null===(t=this.Qt[s])||void 0===t||t.reset()}zt(t){var s;null===(s=this.Qt[t.code])||void 0===s||s.zt(t)}Bt(t){var s;null===(s=this.Qt[t.code])||void 0===s||s.Bt(t)}}class k{constructor(t){this.ts={},this.ss={},this.loader=t}async load(){return await new Promise(s=>{this.loader.add("spritesheets/npc.json").add("spritesheets/dungeon.json").add("spritesheets/bonfire.json").add("dungeon.rules.json").add("dungeon.design.json").add("dialogs.json").add("npc.config.json").add("weapon.config.json").add("monster.config.json").add("alagard","fonts/alagard.fnt").add("big_egg_collect","sounds/big_egg_collect.{ogg,mp3}").add("fruit_collect","sounds/fruit_collect.{ogg,mp3}").add("select","sounds/select.{ogg,mp3}").add("confirm","sounds/confirm.{ogg,mp3}").add("cancel","sounds/cancel.{ogg,mp3}").add("text","sounds/text.{ogg,mp3}").add("boss_hit","sounds/boss_hit.{ogg,mp3}").add("hit_damage","sounds/hit_damage.{ogg,mp3}").load((i,h)=>{h["fonts/alagard.png"].texture.baseTexture.scaleMode=t.SCALE_MODES.NEAREST,this.add(h["spritesheets/npc.json"].spritesheet),this.add(h["spritesheets/dungeon.json"].spritesheet),this.add(h["spritesheets/bonfire.json"].spritesheet),s()})})}add(s){s.baseTexture.scaleMode=t.SCALE_MODES.NEAREST;for(const t of Object.keys(s.textures))this.ts[t]=s.textures[t];for(const t of Object.keys(s.animations))this.ss[t]=s.animations[t]}texture(t){const s=this.ts[t];if(!s)throw"texture not found: "+t;return s}hs(s){const i=new t.Sprite(this.texture(s));return i.name=s,i}animation(t){const s=this.ss[t];if(!s)throw"animation not found: "+t;return[...s]}es(s,i={}){const h=new t.AnimatedSprite(this.animation(s));return h.name=s,h.autoUpdate=void 0===i.autoUpdate||i.autoUpdate,h.animationSpeed=void 0!==i.animationSpeed?i.animationSpeed:.2,h.loop=void 0===i.loop||i.loop,(void 0===i.play||i.play)&&h.play(),h}ns(t,s={}){if(this.ts[t])return this.hs(t);if(this.ss[t])return this.es(t,s);throw"sprite or animation not found: "+t}}class I extends s{constructor(t){super(t)}init(){const s=new t.BitmapText("ROGUELIKE DUNGEON",{font:{name:"alagard",size:64}});s.anchor=new t.Point(.5,0),s.position.set(this.t.screen.width>>1,64),this.v(s);const i=new t.BitmapText("YOU DEAD",{font:{name:"alagard",size:128},rs:16711680});i.anchor=.5,i.position.set(this.t.screen.width>>1,256),this.v(i);const h=new t.BitmapText("PRESS F TO RESTART",{font:{name:"alagard",size:32}});h.anchor=.5,h.position.set(this.t.screen.width>>1,this.t.screen.height-64),this.v(h),this.t.ticker.add(this.yt,this)}I(){this.t.ticker.remove(this.yt,this),super.I({children:!0})}pause(){}resume(){}yt(){this.t.xt.bt.once()&&this.t.os()}}class O{constructor(t){this.name=t.name,this.speed=t.speed,this.ls=t.ls,this.as=t.as,this.cs=t.us,this.animations=t.animations}get fs(){return`weapon_${this.name}.png`}info(){return{name:this.name,speed:this.speed,ls:this.ls,as:this.as,ds:this.cs,ws:10*this.cs}}ps(t){return t.Ut.add(this)}gs(){return!1}ys(t){t.ms()}}class N{constructor(t){this.t=t}init(){this.bs=this.t.loader.vs["weapon.config.json"].data}animation(t){const s=this.bs.animations[t];if(!s)throw"Animation not found";return s}animations(t){return{xs:this.animation(t.xs),_s:this.animation(t._s),bt:t.bt.map(t=>this.animation(t))}}Ms(t){return new O({name:t.name,speed:t.speed,ls:t.ls,as:t.as,level:t.level,us:t.us,animations:this.animations(t.animations)})}ks(t){const s=this.Is(t.level),i=t.Os.select(s);return i?this.Ms(i):null}Is(t){return Object.keys(this.bs.Ts.Ns).map(t=>this.bs.Ts.Ns[t]).filter(s=>s.level<=t)}Es(t){const s=this.bs.Ts.Ns[t];if(!s)throw"Hero weapon config not found: "+t;return this.Ms(s)}Ds(t){const s=this.bs.Ts.Ss[t];if(!s)throw"Npc weapon config not found: "+t;return this.Ms(s)}As(t){const s=this.bs.Ts.Ls[t];if(!s)throw"Monster weapon config not found: "+t;return this.Ms(s)}}class T extends t.Container{constructor(t){super(),this.Ps=null,this.Rs=t}I(){var t;null===(t=this.Ps)||void 0===t||t.I(),this.Ps=null,super.I()}Cs(t){var s;null===(s=this.Ps)||void 0===s||s.I(),this.Ps=null,t&&(this.Ps=this.Rs.ns(t.fs),this.Ps.anchor.set(.5,1),this.v(this.Ps))}$s(t){this.Ps&&(this.Ps.angle=t)}setPosition(t,s){this.Ps&&this.Ps.position.set(t,s)}}class E{constructor(t){this.zs=t}Bs(t){const s=JSON.parse(t);switch(s.type){case"HealthFlask":return new S;case"HealthBigFlask":return new A;case"Weapon":return this.zs.Es(s.name)}}Hs(t){let s;if(t instanceof S)s={type:"HealthFlask"};else if(t instanceof A)s={type:"HealthBigFlask"};else{if(!(t instanceof O))throw"unexpected value";s={type:"Weapon",name:t.name}}return JSON.stringify(s)}}class D{constructor(t){this.fs="coin",this.Us=t.range(1,30)}ps(t){return t.Gs.update(t=>t+this.Us),!0}}class S{constructor(){this.fs="flask_red.png",this.Fs=2}info(){return{name:"Health flask",Ws:this.Fs,ws:100}}ps(t){return t.Ut.add(this)}gs(t){return t instanceof S}ys(t,s){s.Ws.update(t=>Math.min(s.js.get(),t+this.Fs)),t.Ks()}}class A{constructor(){this.fs="flask_big_red.png",this.Fs=5}info(){return{name:"Big health flask",Ws:this.Fs,ws:300}}ps(t){return t.Ut.add(this)}gs(t){return t instanceof A}ys(t,s){s.Ws.update(t=>Math.min(s.js.get(),t+this.Fs)),t.Ks()}}class L{constructor(t){this.Vs=[],this.Xs=0,this.qs=0,this.Js=2,this.t=t}add(t){this.Vs.push(t);const s=this.t.screen,i=(s.width>>1)-this.Xs*this.Js,h=(s.height>>1)-this.qs*this.Js;t.position.set(i,h),t.scale.set(this.Js,this.Js)}set scale(t){this.Js=t;for(const s of this.Vs)s.scale.set(t,t)}setPosition(t,s){this.Xs=t,this.qs=s;const i=this.t.screen,h=(i.width>>1)-this.Xs*this.Js,e=(i.height>>1)-this.qs*this.Js;for(const t of this.Vs)t.position.set(h,e)}}class P{constructor(t,s){this.Ys=t,this.Qs=s.Qs,this.Zs=s.Zs,this.height=s.height,this.width=s.width,this.Ys.register(this)}I(){this.Ys.unregister(this)}ti(t){return!1}si(t){}}class R{constructor(){this.ii=[]}hi(t){let s=this.ii.filter(t.type);return t.filter&&(s=s.filter(t.filter)),t.sort&&s.sort(t.sort),s}register(t){if(t.Zs||!t.Qs){this.ii.push(t);const s={};for(const t of this.ii)s[t.constructor.name]=(s[t.constructor.name]||0)+1}}unregister(t){const s=this.ii.indexOf(t);s>=0&&this.ii.splice(s,1)}}class C extends P{constructor(t,s,i,h){super(t.ei,{width:1,height:1,Qs:!1,Zs:!1}),this.x=s,this.y=i,this.Ht=h,this.ni=t,this.Ps=t.hs(s,i,h.fs),this.Ps.zIndex=V.Ht+i*V.ri,this.Ps.x+=8,this.Ps.y+=14,this.Ps.anchor.set(.5,1)}ps(t){return!!this.Ht.ps(t.state)&&(this.ni.ht(this.x,this.y).oi=null,!0)}I(){super.I(),this.Ps.I()}}class $ extends P{constructor(s,i,h,e,n=!1){super(s.ei,{width:1,height:1,Qs:!0,Zs:n}),this.x=i,this.y=h,this.name=e,this.ni=s,this.Ps=this.ni.controller.vs.ns(e),this.Ps.zIndex=V.floor,this.Ps.position.set(16*i,16*h),this.Ps instanceof t.AnimatedSprite?this.ni.li.v(this.Ps):this.ni.ai.v(this.Ps)}I(){super.I(),this.Ps.I()}}class z extends ${constructor(t,s,i){super(t,s,i,"floor_ladder.png",!0)}si(t){this.ni.controller.ci({level:this.ni.level+1,Ns:t.state.name})}}class B{constructor(t,s){this.ui=!1,this.angle=0,this.fi=t,this.di=s}}var H;(t=>{t[t.NORMAL=0]="NORMAL",t[t.TOP=1]="TOP"})(H||(H={}));class U{constructor(t,s,i){this.ls=0,this.p1=new B(t,this),this.p2=new B(s,this),this.type=i}toString(){const t=this.p1.fi,s=this.p2.fi;return`[${t.x}:${t.y} - ${s.x}:${s.y}]`}}class G{constructor(){this.wi=[],this.pi=[],this.gi=new t.Point(0,0),this.yi=500}init(){this.wi=[],this.pi=[],this.gi=new t.Point(0,0)}mi(s,i,h,e,n){const r=new t.Point(s,i),o=new t.Point(h,e),l=new U(r,o,n);this.wi.push(l),this.pi.push(l.p1),this.pi.push(l.p2)}static bi(t){const s=[];for(;t.length>0;){const i=t.pop(),h=[];for(let s=0;s<t.length;s++){const e=t[s],n=i.type===e.type,r=i.p1.fi.vi(e.p1.fi)&&i.p2.fi.vi(e.p2.fi);n&&r&&h.push(s)}for(const s of h)t.splice(s,1);s.push(i)}return s}static connected(t){const s=[];for(let i=0;i<t.length;i++){const h=t[i];let e=!1,n=!1;for(let r=0;r<t.length;r++){if(r==i)continue;const o=t[r];if((!h.p1.fi.vi(o.p1.fi)||!h.p2.fi.vi(o.p2.fi))&&(e||!h.p1.fi.vi(o.p1.fi)&&!h.p1.fi.vi(o.p2.fi)||(e=!0),n||!h.p2.fi.vi(o.p1.fi)&&!h.p2.fi.vi(o.p2.fi)||(n=!0),e&&n)){s.push(h);break}}}return s}static xi(t){const s=[],i=[],h=[[0,12,0,16],[5,12,5,16],[0,12,5,12],[0,0,5,0],[11,12,11,16],[11,12,16,12],[11,0,16,0]],e=t=>{const s=t.p1.fi.x%16,i=t.p1.fi.y%16,e=t.p2.fi.x-t.p1.fi.x+s,n=t.p2.fi.y-t.p1.fi.y+i;for(const[t,r,o,l]of h)if(t===s&&r===i&&o===e&&l===n)return!0;return!1};for(const h of t)e(h)?i.push(h):s.push(h);for(;i.length>0;){const t=i.pop(),h=[t],e=[t.p1.fi,t.p2.fi],n=[1,1],r=[];for(let t=0;t<2;t++)for(let t=0;t<i.length;t++){if(r.indexOf(t)>=0)continue;const s=i[t],o=s.p1.fi,l=s.p2.fi;let a=!1,c=!1;for(let t=0;t<e.length;t++){const s=e[t];s.vi(o)?(a=!0,n[t]++):s.vi(l)&&(c=!0,n[t]++)}(a||c)&&(r.push(t),h.push(s),a||(e.push(o),n.push(1)),c||(e.push(l),n.push(1)))}if(4===n.length&&n.every(t=>2===t)){let t=0,e=0;for(let s=0;s<4;s++){const i=h[s];i.p1.fi.y===i.p2.fi.y&&i.p1.fi.y>e&&(t=s,e=i.p1.fi.y)}for(const t of r.reverse())i.splice(t,1);h.splice(t,1),s.push(...h)}else s.push(t)}return s}static pt(t){const s=[];for(;t.length>0;){const i=t.pop();let h=null;for(let s=0;s<t.length;s++){const e=t[s];if(i.type===e.type){if(i.p2.fi.vi(e.p1.fi)){t.splice(s,1),h=[i,e];break}if(e.p2.fi.vi(i.p1.fi)){t.splice(s,1),h=[e,i];break}}}if(h){const[s,i]=h;t.push(new U(s.p1.fi,i.p2.fi,s.type))}else s.push(i)}return s}_i(){const t=G.bi([...this.wi]),s=G.connected(t),i=G.xi(s),h=G.connected(i),e=[...G.pt(h.filter(t=>t.p1.fi.x===t.p2.fi.x)),...G.pt(h.filter(t=>t.p1.fi.y===t.p2.fi.y))];this.wi=[],this.pi=[];for(const t of e)this.wi.push(t),this.pi.push(t.p1),this.pi.push(t.p2)}Mi(t,s,i){this.gi.x=t,this.gi.y=s,this.yi=i,this.pi=[];for(const h of this.wi){const e=.5*(h.p1.fi.x+h.p2.fi.x)-t,n=.5*(h.p1.fi.y+h.p2.fi.y)-s;if(h.ls=Math.sqrt(e*e+n*n),h.ls<i){h.p1.angle=Math.atan2(h.p1.fi.y-s,h.p1.fi.x-t),h.p2.angle=Math.atan2(h.p2.fi.y-s,h.p2.fi.x-t);let i=h.p2.angle-h.p1.angle;i<=-Math.PI&&(i+=2*Math.PI),i>Math.PI&&(i-=2*Math.PI),h.p1.ui=i>0,h.p2.ui=!h.p1.ui,this.pi.push(h.p1,h.p2)}}this.pi.sort(G.ki)}static ki(t,s){return t.angle>s.angle?1:t.angle<s.angle?-1:!t.ui&&s.ui?1:t.ui&&!s.ui?-1:0}static Ii(t,s){return(t.p2.fi.x-t.p1.fi.x)*(s.y-t.p1.fi.y)-(t.p2.fi.y-t.p1.fi.y)*(s.x-t.p1.fi.x)<0}static Oi(s,i,h){return new t.Point(s.x*(1-h)+i.x*h,s.y*(1-h)+i.y*h)}static Ni(t,s,i){const h=G.Ii(t,G.Oi(s.p1.fi,s.p2.fi,.01)),e=G.Ii(t,G.Oi(s.p2.fi,s.p1.fi,.01)),n=G.Ii(t,i),r=G.Ii(s,G.Oi(t.p1.fi,t.p2.fi,.01)),o=G.Ii(s,G.Oi(t.p2.fi,t.p1.fi,.01)),l=G.Ii(s,i);return r==o&&o!=l||h==e&&e==n}Ti(){const t=[],s=[];let i=0;for(let h=0;h<=2;h++)for(const e of this.pi){const n=0===s.length?null:s[0];if(e.ui){let t=0,i=s[t];for(;null!=i&&G.Ni(e.di,i,this.gi);)t++,i=s[t];null==i?s.push(e.di):s.splice(t,0,e.di)}else for(let t=0;t<s.length;t++)s[t]===e.di&&s.splice(t,1);n!==(0===s.length?null:s[0])&&(1==h&&this.Ei(i,e.angle,n,t),i=e.angle)}const h=[...t],e=[];for(;h.length>0;){if(h.length>=2){const[t,s]=h;if(t.vi(s)){h.shift();continue}}const t=h.shift();e.push(t)}const n=[];for(;e.length>0;){if(e.length>=3){const[t,s,i]=e;if(t.x===s.x&&t.x===i.x){e.splice(1,1);continue}}const t=e.shift();n.push(t)}return n}static Di(s,i,h,e){const n=(e.x-h.x)*(s.y-h.y)-(e.y-h.y)*(s.x-h.x),r=(e.y-h.y)*(i.x-s.x)-(e.x-h.x)*(i.y-s.y);if(0===r)return null;const o=n/r;return new t.Point(s.x+o*(i.x-s.x),s.y+o*(i.y-s.y))}Ei(s,i,h,e){const n=Math.cos(s),r=Math.sin(s),o=Math.cos(i),l=Math.sin(i),a=this.gi,c=new t.Point(this.gi.x+n,this.gi.y+r),u=new t.Point(0,0),f=new t.Point(0,0);null!=h?(u.x=h.p1.fi.x,u.y=h.p1.fi.y,f.x=h.p2.fi.x,f.y=h.p2.fi.y):(u.x=this.gi.x+n*this.yi,u.y=this.gi.y+r*this.yi,f.x=this.gi.x+o*this.yi,f.y=this.gi.y+l*this.yi);const d=G.Di(u,f,a,c);if(null===d)return;d.x=Math.round(d.x),d.y=Math.round(d.y),c.x=this.gi.x+o,c.y=this.gi.y+l;const w=G.Di(u,f,a,c);if(null!==w)if(w.x=Math.round(w.x),w.y=Math.round(w.y),null!=h)switch(h.type){case H.TOP:e.push(d),e.push(new t.Point(d.x,d.y-16)),e.push(new t.Point(w.x,w.y-16)),e.push(w);break;case H.NORMAL:e.push(d),e.push(w)}else e.push(d),e.push(w)}debug(){const t=document.createElement("canvas");t.width=1280,t.height=1280;const s=t.getContext("2d");s.fillRect(0,0,1280,1280),s.scale(1,1);const i=new Path2D;for(const t of this.wi){const s=t.p1.fi,h=t.p2.fi;i.moveTo(s.x,s.y),i.lineTo(h.x,h.y)}s.strokeStyle="rgba(255,0,0,0.5)",s.stroke(i)}}class F{constructor(s){this.Si=[],this.Ai={default:[{x1:0,y1:12,x2:16,y2:12,type:H.NORMAL},{x1:0,y1:12,x2:0,y2:16,type:H.NORMAL},{x1:16,y1:12,x2:16,y2:16,type:H.NORMAL}],top:[{x1:0,y1:0,x2:16,y2:0,type:H.TOP}],left:[{x1:0,y1:0,x2:0,y2:12,type:H.NORMAL}],right:[{x1:16,y1:0,x2:16,y2:12,type:H.NORMAL}],bottom:[]},this.Li={default:[{x1:11,y1:0,x2:11,y2:16,type:H.NORMAL},{x1:11,y1:0,x2:16,y2:0,type:H.NORMAL},{x1:11,y1:16,x2:16,y2:16,type:H.TOP}],top:[{x1:0,y1:0,x2:11,y2:0,type:H.TOP}],left:[{x1:0,y1:0,x2:0,y2:16,type:H.NORMAL}],right:[],bottom:[{x1:0,y1:16,x2:11,y2:16,type:H.NORMAL}]},this.Pi={default:[{x1:5,y1:0,x2:5,y2:16,type:H.NORMAL},{x1:0,y1:0,x2:5,y2:0,type:H.NORMAL},{x1:0,y1:16,x2:5,y2:16,type:H.TOP}],top:[{x1:5,y1:0,x2:16,y2:0,type:H.TOP}],left:[],right:[{x1:16,y1:0,x2:16,y2:16,type:H.NORMAL}],bottom:[{x1:5,y1:16,x2:16,y2:16,type:H.NORMAL}]},this.Ri={default:[{x1:5,y1:0,x2:5,y2:12,type:H.NORMAL},{x1:5,y1:12,x2:16,y2:12,type:H.NORMAL},{x1:16,y1:12,x2:16,y2:16,type:H.NORMAL}],top:[{x1:5,y1:0,x2:16,y2:0,type:H.TOP}],left:[],right:[{x1:16,y1:0,x2:16,y2:12,type:H.NORMAL}],bottom:[]},this.Ci={default:[{x1:11,y1:0,x2:11,y2:12,type:H.NORMAL},{x1:0,y1:12,x2:11,y2:12,type:H.NORMAL},{x1:0,y1:12,x2:0,y2:16,type:H.NORMAL}],top:[{x1:0,y1:0,x2:11,y2:0,type:H.TOP}],left:[{x1:0,y1:0,x2:0,y2:12,type:H.NORMAL}],right:[],bottom:[]},this.$i={default:[],top:[{x1:0,y1:0,x2:16,y2:0,type:H.TOP}],left:[{x1:0,y1:0,x2:0,y2:16,type:H.NORMAL}],right:[{x1:16,y1:0,x2:16,y2:16,type:H.NORMAL}],bottom:[{x1:0,y1:16,x2:16,y2:16,type:H.NORMAL}]},this.bs={"wall_top_mid.png":this.Ai,"wall_side_front_left.png":this.Li,"wall_side_front_right.png":this.Pi,"wall_side_mid_left.png":this.Li,"wall_side_mid_right.png":this.Pi,"wall_side_top_left.png":{default:[{x1:11,y1:12,x2:16,y2:12,type:H.NORMAL},{x1:11,y1:12,x2:11,y2:16,type:H.NORMAL}],top:[{x1:0,y1:0,x2:16,y2:0,type:H.TOP}],left:[{x1:0,y1:0,x2:0,y2:16,type:H.NORMAL}],right:[{x1:16,y1:0,x2:16,y2:12,type:H.NORMAL}],bottom:[{x1:0,y1:16,x2:11,y2:16,type:H.NORMAL}]},"wall_side_top_right.png":{default:[{x1:0,y1:12,x2:5,y2:12,type:H.NORMAL},{x1:5,y1:12,x2:5,y2:16,type:H.NORMAL}],top:[{x1:0,y1:0,x2:16,y2:0,type:H.TOP}],left:[{x1:0,y1:12,x2:0,y2:16,type:H.NORMAL}],right:[{x1:16,y1:0,x2:16,y2:16,type:H.NORMAL}],bottom:[{x1:5,y1:16,x2:16,y2:16,type:H.NORMAL}]},"wall_inner_corner_t_top_left.png":this.Ai,"wall_inner_corner_t_top_right.png":this.Ai,"wall_inner_corner_l_top_left.png":this.Ri,"wall_inner_corner_l_top_right.png":this.Ci,"wall_corner_bottom_left.png":this.Ri,"wall_corner_bottom_right.png":this.Ci,"wall_corner_top_left.png":this.Ai,"wall_corner_top_right.png":this.Ai,"wall_fountain_top.png":{default:[{x1:0,y1:12,x2:0,y2:16,type:H.NORMAL},{x1:0,y1:12,x2:2,y2:12,type:H.NORMAL},{x1:2,y1:9,x2:2,y2:12,type:H.NORMAL},{x1:2,y1:9,x2:14,y2:9,type:H.NORMAL},{x1:14,y1:9,x2:14,y2:12,type:H.NORMAL},{x1:14,y1:12,x2:16,y2:12,type:H.NORMAL},{x1:16,y1:12,x2:16,y2:16,type:H.NORMAL}],top:[{x1:0,y1:0,x2:16,y2:0,type:H.TOP}],left:[{x1:0,y1:0,x2:0,y2:12,type:H.NORMAL}],right:[{x1:16,y1:0,x2:16,y2:12,type:H.NORMAL}],bottom:[]},"wall_one_top.png":this.Ai,"wall_one_corner_left.png":this.Ri,"wall_one_corner_right.png":this.Ci},this.ni=s,this.li=new t.display.Layer,this.li.zi=!0,this.li.Bi("display",s=>{s.Hi=t.BLEND_MODES.MULTIPLY}),this.li.clearColor=[0,0,0,1],this.Ui=new t.Sprite(this.li.Gi()),this.Ui.Hi=t.BLEND_MODES.MULTIPLY,this.Fi=F.Wi("white",150),this.ji=F.Wi("rgb(211,78,56)",50),this.Ki=F.Wi("rgb(86,152,204)",50),this.Vi=F.Wi("rgb(255,239,204)",100),this.Xi=new G,this.ni.ticker.add(this.update,this)}I(){this.ni.ticker.remove(this.update,this),this.Si.forEach(t=>t.I()),this.Fi.I(),this.Ki.I(),this.ji.I(),this.Vi.I(),this.li.I(),this.Ui.I()}qi(){this.Xi.init();const s=this.ni;for(let i=0;i<s.height;i++)for(let h=0;h<s.width;h++){const e=s.ht(h,i);if(e.Ji){const n=new t.Point(16*h,16*i);switch(e.Yi){case"wall_fountain_basin_red":this.Qi(n,W.RED_BASIN);break;case"wall_fountain_basin_blue":this.Qi(n,W.BLUE_BASIN)}const r=i>0&&s.ht(h,i-1).Ji,o=i+1<s.height&&s.ht(h,i+1).Ji,l=h>0&&s.ht(h-1,i).Ji,a=h+1<s.width&&s.ht(h+1,i).Ji;let c;const u=e.Zi;c=u&&this.bs[u]&&this.bs[u]||this.$i,this.add(h,i,c.default),r||this.add(h,i,c.top),o||this.add(h,i,c.bottom),l||this.add(h,i,c.left),a||this.add(h,i,c.right)}}this.Xi._i(),this.update()}Qi(t,s){let i,h;switch(s){case W.HERO:i=this.Fi,h=350;break;case W.RED_BASIN:i=this.ji,h=150;break;case W.BLUE_BASIN:i=this.Ki,h=150;break;case W.BONFIRE:i=this.Vi,h=250}const e=new j(t,h,i);this.li.v(e.mask),this.li.v(e.hs),this.Si.push(e),this.th(e)}add(t,s,i){for(const h of i)this.Xi.mi(16*t+h.x1,16*s+h.y1,16*t+h.x2,16*s+h.y2,h.type)}update(){for(const t of this.Si)t.sh&&(this.th(t),t.ih())}th(s){const i=new t.Point(s.position.x+8,s.position.y+8);this.Xi.Mi(i.x,i.y,s.maxDistance);const h=this.Xi.Ti();s.hs.position.set(i.x,i.y),s.mask.clear().T(16777215).hh(h).O()}static Wi(s,i){const h=i<<1,e=document.createElement("canvas");e.width=h,e.height=h;const n=e.getContext("2d");if(n){const t=n.createRadialGradient(i,i,0,i,i,i);t.addColorStop(.1,s),t.addColorStop(1,"transparent"),n.fillStyle=t,n.fillRect(0,0,h,h)}return t.eh.from(e)}}var W;(t=>{t[t.HERO=0]="HERO",t[t.RED_BASIN=1]="RED_BASIN",t[t.BLUE_BASIN=2]="BLUE_BASIN",t[t.BONFIRE=3]="BONFIRE"})(W||(W={}));class j{constructor(s,i,h){this.nh=null,this.position=s,this.maxDistance=i,this.mask=new t.Graphics,this.mask.rh=!0,this.hs=new t.Sprite(h),this.hs.anchor.set(.5,.5),this.hs.mask=this.mask,this.hs.Hi=t.BLEND_MODES.ADD}get sh(){return null===this.nh||this.position.x!==this.nh.x||this.position.y!==this.nh.y}ih(){this.nh={x:this.position.x,y:this.position.y}}I(){this.hs.I(),this.mask.I()}}class K extends P{constructor(t,s,i,h){super(t.ei,{width:1,height:1,Qs:!0,Zs:!1}),this.x=s,this.y=i,this.name=h,this.ni=t,this.Ps=t.hs(s,i,h),this.Ps.zIndex=V.oh+i*V.ri}ti(t){return!this.ni.ht(this.x,this.y).Ji}I(){super.I(),this.Ps.I()}}const V={lh:60,Ns:70,Ht:50,Qs:40,floor:1,oh:100,ri:256};class X{constructor(s,i,h,e,n,r,o){this.scale=2,this.controller=s,this.ticker=i,this.Os=h,this.seed=e,this.level=n,this.width=r,this.height=o,this.K=[];for(let t=0;t<this.width;t++){this.K[t]=[];for(let s=0;s<this.height;s++)this.K[t][s]=new q(this,s,t)}this.li=new t.display.Layer,this.li.ah=!0,this.ai=new t.Container,this.ai.zIndex=V.floor,this.ai.ah=!1,this.ai.uh=!0,this.li.v(this.ai),this.fh=new F(this),this.dh=new L(s),this.dh.add(this.li),this.dh.add(this.fh.li),this.ei=new R}I(){for(let t=0;t<this.height;t++)for(let s=0;s<this.width;s++)this.K[t][s].I();this.fh.I(),this.li.I({children:!0})}log(t){}ht(t,s){return this.K[s][t]}remove(t,s,i){for(let h=0;h<i.width;h++)for(let e=0;e<i.height;e++){const n=this.ht(t+h,s-e),r=n.object;r&&r===i&&(n.object=null)}}set(t,s,i){for(let h=0;h<i.width;h++)for(let e=0;e<i.height;e++)this.ht(t+h,s-e).object=i}available(t,s,i){for(let h=0;h<i.width;h++)for(let e=0;e<i.height;e++){const n=this.ht(t+h,s-e);if(!n.Ji||n.ti(i))return!1}return!0}hs(t,s,i){const h=this.controller.vs.ns(i);return h.position.set(16*t,16*s),this.li.v(h),h}wh(t,s,i){const h=this.controller.vs.es(i);return h.position.set(16*t,16*s),h.play(),this.li.v(h),h}}class q{constructor(t,s,i){this.ph=null,this.gh=null,this.yh=null,this.mh=null,this.ni=t,this.x=s,this.y=i}I(){var t,s,i,h;null===(t=this.ph)||void 0===t||t.I(),this.ph=null,null===(s=this.gh)||void 0===s||s.I(),this.gh=null,null===(i=this.yh)||void 0===i||i.I(),this.yh=null,null===(h=this.mh)||void 0===h||h.I(),this.mh=null}set Yi(t){var s;null===(s=this.ph)||void 0===s||s.I(),this.ph=null,t&&(this.ph=new $(this.ni,this.x,this.y,t))}get Yi(){var t;return(null===(t=this.ph)||void 0===t?void 0:t.name)||null}get floor(){return this.ph}get Ji(){return!!this.ph}get Zi(){var t;return(null===(t=this.gh)||void 0===t?void 0:t.name)||null}set Zi(t){var s;null===(s=this.gh)||void 0===s||s.I(),this.gh=null,t&&(this.gh=new K(this.ni,this.x,this.y,t))}get oh(){return this.gh}set oi(t){var s;null===(s=this.yh)||void 0===s||s.I(),this.yh=null,t&&(this.yh=new C(this.ni,this.x,this.y,t))}get Ht(){return this.yh}get bh(){return!!this.yh}vh(){const t=this.ni.Os;let s=170*t.float();return(s-=20)<=0?this.oi=this.ni.controller.xh.ks(this.ni):(s-=30)<=0?this.oi=new A:(s-=50)<=0?this.oi=new S:s-70<=0&&(this.oi=new D(t)),this.bh}get object(){return this.mh}set object(t){if(t&&null!==this.mh&&this.mh!==t)throw"error while set object to cell";this.mh=t}get _h(){return null!=this.mh}Mh(){var t;null===(t=this.ph)||void 0===t||t.I(),this.ph=new z(this.ni,this.x,this.y)}get Zs(){var t,s,i,h;return(null===(t=this.ph)||void 0===t?void 0:t.Zs)||(null===(s=this.gh)||void 0===s?void 0:s.Zs)||(null===(i=this.yh)||void 0===i?void 0:i.Zs)||(null===(h=this.mh)||void 0===h?void 0:h.Zs)||!1}si(t){this.mh&&this.mh.Zs?this.mh.si(t):this.yh&&this.yh.Zs?this.yh.si(t):this.gh&&this.gh.Zs?this.gh.si(t):this.ph&&this.ph.Zs&&this.ph.si(t)}ti(t){return this.mh&&this.mh.ti(t)||this.gh&&this.gh.ti(t)||!1}}var J,Y,Q;(t=>{t[t.UNLIT=0]="UNLIT",t[t.LIGHT=1]="LIGHT",t[t.LIT=2]="LIT"})(J||(J={}));class Z extends P{constructor(t,s,i,h){super(t.ei,{Qs:!1,Zs:!0,width:1,height:1}),this.ni=t,this.x=s,this.y=i,this.Pt=J.UNLIT,this.Ps=this.ni.wh(this.x,this.y,"bonfire_unlit"),this.Ps.zIndex=V.Qs+this.y*V.ri,this.ni.ht(this.x,this.y).object=this,h&&this.fh()}get state(){return this.Pt}I(){super.I(),this.ni.remove(this.x,this.y,this),this.Ps.I()}si(t){switch(this.Pt){case J.UNLIT:t.state.Ih.kh(this.ni.level),this.ni.controller.Oh({text:"BONFIRE LIT",color:o}),this.fh();break;case J.LIGHT:case J.LIT:this.ni.controller.Nh(t.state)}}ti(){return!0}fh(){if(this.Pt===J.UNLIT){this.Pt=J.LIGHT,this.Ps.I(),this.Ps=this.ni.wh(this.x,this.y,"bonfire_light"),this.Ps.zIndex=V.Qs+this.y*V.ri,this.Ps.loop=!1,this.Ps.Th=()=>this.Eh();const s=new t.Point(16*this.x+8,16*this.y-16);this.ni.fh.Qi(s,W.BONFIRE)}}Eh(){var t;this.Pt=J.LIT,null===(t=this.Ps)||void 0===t||t.I(),this.Ps=this.ni.wh(this.x,this.y,"bonfire_lit"),this.Ps.zIndex=V.Qs+this.y*V.ri}}class tt extends m{constructor(t,s){super(t,"Bonfire"),this.Dh=s}init(){super.init();let t=1;const s=(s,i)=>{const h=new u({label:s,width:400,height:32,A:24});this.v(h),this.vt.set(0,t,h,i),t++},i=this.Dh.Ih.Sh().sort((t,s)=>t-s);for(const t of i)s("Level "+t,()=>{this.t.Mt(),this.t.ci({Ns:this.Dh.name,level:t})});this.vt.select(0,1)}}class st extends t.Container{constructor(s){super(),this.kt=new t.BitmapText("LEVEL "+s,{font:{name:"alagard",size:32}}),this.kt.anchor=.5,this.kt.position.set(0,16),this.v(this.kt)}}class it{constructor(t){this.Ah=[],this.i=t}set(t){this.i=t,this.Lh(t);for(let t=this.Ah.length-1;t>=0;t--){const s=this.Ah[t];s.Ph?this.Ah.splice(t,1):s.send(this.i)}}Lh(t){}update(t){this.set(t(this.i))}get(){return this.i}subscribe(t,s){const i=new et(t,s);this.Ah.push(i),i.send(this.i)}unsubscribe(t,s){var i;null===(i=this.Ah.find(i=>i.matches(t,s)))||void 0===i||i.unsubscribe()}}class ht{constructor(){this.Ah=[]}send(t){for(let s=this.Ah.length-1;s>=0;s--){const i=this.Ah[s];i.Ph?this.Ah.splice(s,1):i.send(t)}}subscribe(t,s){const i=new et(t,s);this.Ah.push(i)}unsubscribe(t,s){var i;null===(i=this.Ah.find(i=>i.matches(t,s)))||void 0===i||i.unsubscribe()}}class et{constructor(t,s){this.Rh=!1,this.Ch=t,this.$h=s||null}get Ph(){return this.Rh}matches(t,s){return this.Ch===t&&this.$h===s}send(t){this.$h?this.Ch.call(this.$h,t):this.Ch(t)}unsubscribe(){this.Rh=!0}}(t=>{t[t.Manhattan=0]="Manhattan",t[t.Euclidean=1]="Euclidean",t[t.Chebyshev=2]="Chebyshev",t[t.Octile=3]="Octile"})(Y||(Y={}));class nt{constructor(t,s){this.zh=0,this.Bh=0,this.f=0,this.parent=t,this.position=s}vi(t){return this.position.vi(t.position)}}class rt{constructor(t,s){this.x=t,this.y=s}vi(t){return this.x===t.x&&this.y===t.y}static of(t){return new rt(t.x,t.y)}}(t=>{t[t.OPEN=0]="OPEN",t[t.CLOSED=1]="CLOSED"})(Q||(Q={}));let ot=(()=>{class t{constructor(t,s,i=!0,h=!1,e=!1,n=2,r=1){this.Hh=[],this.Uh=1,this._width=t,this._height=s,this.Gh=i,this.Fh=h,this.Wh=e,this.jh=n,this.Uh=r;for(let i=0;i<t;i++){const t=[];this.Hh.push(t);for(let i=0;i<s;i++)t.push(1)}}clear(t,s){this.Hh[t][s]=0}mark(t,s){this.Hh[t][s]=1}find(s,i){const h=new nt(null,rt.of(s)),e=new nt(null,rt.of(i)),n=[],r=[];for(n.push(h);n.length>0;){let s=n[0],i=0;for(let t=1;t<n.length;t++){const h=n[t];h.f<s.f&&(s=h,i=t)}if(n.splice(i,1),r.push(s),s.vi(e)){const t=[];let i;for(i=this.Wh?s:s.parent;null!==i.parent;)t.push(i.position),i=i.parent;return this.Fh&&t.push(i.position),t.reverse()}const h=[],o=this.Gh?t.Kh:t.Vh;for(let t=0;t<o.length;t++){const i=o[t],e=new rt(s.position.x+i.x,s.position.y+i.y);if(e.x>=this._width||e.x<0||e.y>=this._height||e.y<0)continue;if(1===this.Hh[e.x][e.y])continue;const n=new nt(s,e);h.push(n)}for(let t=0;t<h.length;t++){const i=h[t];null==r.find(t=>t.vi(i))&&(i.zh=s.zh+1,i.Bh=this.Xh(i.position,e.position),i.f=i.zh+i.Bh,null==n.find(t=>t.vi(i))&&n.push(i))}}return[]}Xh(t,s){const i=Math.abs(s.x-t.x),h=Math.abs(s.y-t.y);switch(this.jh){case 0:return(i+h)*this.Uh;case 1:return Math.sqrt(i*i+h*h)*this.Uh;case 2:return Math.max(i,h)*this.Uh;case 3:return(i+h-.58*Math.min(i,h))*this.Uh}}}return t.Vh=[new rt(0,-1),new rt(0,1),new rt(-1,0),new rt(1,0)],t.Kh=[new rt(0,-1),new rt(0,1),new rt(-1,0),new rt(1,0),new rt(-1,-1),new rt(-1,1),new rt(1,-1),new rt(1,1)],t})();class lt{constructor(t,s){const i={};for(const t of s)i[t]=new at;this.qh=i,this.Jh=t,this.Yh=this.Jh}get Qh(){return this.qh[this.Yh].Qh}get Zh(){return this.Yh}state(t){return this.qh[t]}start(){this.Yh=this.Jh,this.qh[this.Yh].te(),this.transition()}stop(){this.qh[this.Yh].se()}update(t){this.qh[this.Yh].update(t),this.transition()}ie(t){this.qh[this.Yh].ie(t),this.transition()}transition(){for(;;){const t=this.qh[this.Yh].transition();if(null===t)break;this.qh[this.Yh].se(),this.Yh=t,this.qh[this.Yh].te()}}}class at{constructor(){this.he=[],this.ee=[],this.ne=[],this.re=[],this.oe=[],this.le=[]}get Qh(){return 0===this.oe.length}ae(t){return this.he.push(t),this}Lh(t){return this.ee.push(t),this}ce(t){return this.ne.push(t),this}ue(t){return this.re.push(t),this}fe(t){return this.le.push(t),this}de(t){const s=new ct(t);return this.oe.push(s),s}te(){for(const t of this.he)t();for(const t of this.le)t.start()}update(t){for(const s of this.ee)s(t);for(const s of this.le)s.update(t)}se(){for(const t of this.re)t();for(const t of this.le)t.stop()}ie(t){for(const s of this.ne)s(t);for(const s of this.le)s.ie(t)}transition(){for(const t of this.oe)if(t.we())return t.pe(),t.ge;return null}}class ct{constructor(t){this.ye=[],this.me=[],this.ge=t}be(t){return this.ye.push(t),this}action(t){return this.me.push(t),this}we(){for(const t of this.ye)if(!t())return!1;return!0}pe(){for(const t of this.me)t()}}class ut{constructor(s,i,h,e,n,r){this.ve=!1,this.Xs=0,this.qs=0,this.Rs=i,this.xe=e,this._e=n,this.Me=r||null,this.Ps=new t.AnimatedSprite(i.animation(h),!1),this.Ps.zIndex=2,this.Ps.loop=!1,this.Ps.position.set(0,14),this.Ps.anchor.set(0,1),this.Ps.width>16*this._e&&(this.Ps.position.x-=(this.Ps.width-16*this._e)/2),this.ke=new T(this.Rs),this.ke.zIndex=1,this.ke.position.set(16*this._e,12),this.Ie=new t.Container,this.Ie.v(this.ke,this.Ps),s.v(this.Ie)}get x(){return this.Xs}get y(){return this.qs}get Oe(){return this.ve}set Oe(t){this.ve=t,this.Ne()}get Ms(){return this.ke}I(){this.Ie.I(),this.ke.I(),this.Ps.I()}setPosition(t,s){this.Xs=Math.round(16*t*2)/2,this.qs=Math.round(16*s*2)/2,this.Ne(),this.Ie.zIndex=this.xe+Math.floor(s)*V.ri,this.Me&&this.Me(this.Xs,this.qs)}Te(t){this.Ps.textures=this.Rs.animation(t),this.Ps.Ee(0)}De(t){this.Ps.Ee(t)}Ne(){this.Ie.scale.set(this.ve?-1:1,1),this.Ie.position.set(this.Xs+(this.ve?16*this._e:0),this.qs)}}class ft{constructor(t){this.Se=0,this.Ae=!1,this.animationSpeed=t}get Le(){return this.Ae}start(){this.Se=0,this.Ae=!0,this.play()}stop(){this.Ae=!1}update(t){this.Se+=this.animationSpeed*t,this.Ae&&this.play()}}class dt extends ft{constructor(t,s,i){super(t),this.Pe=[],this.Re=null,this.Ce=s,this.$h=i}get duration(){return this.Pe.length>0?this.Pe[this.Pe.length-1].time:0}play(){for(;this.Ae;){const t=null===this.Re?0:this.Re+1;if(t<this.Pe.length){if(!(this.Pe[t].time<=this.Se))break;this.Re=t,this.Ce.call(this.$h,...this.Pe[t].$e)}else this.Ae=!1}}ze(t){return this.Pe.push(t),this.Pe.sort(this.ki),this}Be(t){return this.Pe.push(...t),this.Pe.sort(this.ki),this}add(t,...s){return this.ze({time:t,$e:s}),this}ki(t,s){return t.time-s.time}}class wt extends ft{constructor(t,s,i){super(t),this.He=[],this.Ce=s,this.$h=i}get duration(){return this.He.length>0?this.He[this.He.length-1].time:0}play(){let t=null,s=null;for(let i=0;i<this.He.length;i++){const h=this.He[i];if(!(h.time<=this.Se)){s=h;break}t=h}if(null!==t&&null!==s){const i=[],h=s.time-t.time,e=(this.Se-t.time)/h;for(let h=0;h<t.$e.length;h++)i[h]=t.$e[h]*(1-e)+s.$e[h]*e;this.Ce.call(this.$h,...i)}else null!==t?(this.Ce.call(this.$h,...t.$e),this.Ae=!1):null!==s&&this.Ce.call(this.$h,...s.$e)}ze(t){return this.He.push(t),this.He.sort(this.ki),this}Be(t){return this.He.push(...t),this.He.sort(this.ki),this}add(t,...s){return this.ze({time:t,$e:s}),this}ki(t,s){return t.time-s.time}}class pt extends ft{constructor(t,s,i,h,e){super(i),this.Ue=t,this.Ge=s,this.Ce=h,this.$h=e}get duration(){return this.Ge}play(){const t=this.Se/this.Ge;t>=1?(this.Ae=!1,this.Ce.call(this.$h,...this.Ue(1))):this.Ce.call(this.$h,...this.Ue(t))}}class gt{constructor(){this.Fe=[],this.Ae=!1}get Le(){return this.Ae}add(t){this.Fe.push(t)}We(t,s,i){const h=new dt(t,s,i);return this.add(h),h}je(t,s,i){const h=new wt(t,s,i);return this.add(h),h}Ke(t,s,i,h,e){const n=new pt(t,s,i,h,e);return this.add(n),n}clear(){this.stop(),this.Fe.splice(0,this.Fe.length)}start(){this.Ae=!0;for(const t of this.Fe)t.start()}stop(){this.Ae=!1;for(const t of this.Fe)t.stop()}update(t){let s=!1;for(const i of this.Fe)i.update(t),i.Le&&(s=!0);s||this.stop()}}class yt{constructor(t){this.Ve=t,this.animation=new gt}Xe(t,s,i){this.animation.We(t,this.Ve.Te,this.Ve).add(0,s);const h=this.animation.We(t,this.Ve.De,this.Ve);for(let t=0;t<i;t++)h.add(t,t);h.add(i,0)}qe(t,s){this.animation.je(t,this.Ve.setPosition,this.Ve).add(0,s.x,s.y).add(4,s.Je,s.Ye)}Qe(t,s){const i=this.Ve.Ms;this.animation.je(t,i.$s,i).Be(s.angle),s.Ze?this.animation.je(t,i.setPosition,i).Be(s.tn):this.animation.We(t,i.setPosition,i).Be(s.tn)}get Le(){return this.animation.Le}start(){this.animation.start()}update(t){this.animation.update(t)}stop(){this.animation.stop()}clear(){this.animation.clear()}}var mt,bt,vt,xt,_t,Mt,kt,It;(t=>{t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT",t[t.AROUND=4]="AROUND"})(mt||(mt={}));class Ot extends P{constructor(t,s){super(t.ei,{Qs:!1,Zs:s.Zs,height:s.height,width:s.width}),this.sn=new it(!1),this.in=-1,this.hn=-1,this.ni=t,this.Xs=s.x,this.qs=s.y,this.view=new ut(t.li,t.controller.vs,s.animation,s.zIndex,s.width,s.en),this.nn=new yt(this.view),this.rn=this.on()}get x(){return this.Xs}get y(){return this.qs}get Je(){return this.in}get Ye(){return this.hn}get ln(){return this.sn}get an(){return this.sn.get()}init(){this.setPosition(this.Xs,this.qs),this.sn.subscribe(this.cn,this),this.state.Ut.un.Ms.item.subscribe(this.fn,this),this.rn.start(),this.ni.ticker.add(this.rn.update,this.rn)}I(){super.I(),this.ni.ticker.remove(this.rn.update,this.rn),this.rn.stop(),this.sn.unsubscribe(this.cn,this),this.state.Ut.un.Ms.item.unsubscribe(this.fn,this),this.ni.remove(this.Xs,this.qs,this),-1!==this.in&&-1!==this.hn&&this.ni.remove(this.in,this.hn,this),this.view.I()}ti(t){return this!==t}dn(t,s){this.an||(this.state.Ws.update(t=>parseFloat(Math.max(0,t-s).toFixed(1))),0===this.state.Ws.get()&&(this.wn(t),this.sn.set(!0)))}wn(t){t&&this.pn(t)}cn(t){t&&this.gn()}fn(t){this.view.Ms.Cs(t)}setPosition(t,s){this.yn(),this.ni.remove(this.Xs,this.qs,this),this.Xs=Math.floor(t),this.qs=Math.floor(s),this.ni.set(this.Xs,this.qs,this),this.view.setPosition(t,s)}mn(t,s){this.yn(),this.in=t,this.hn=s,this.ni.set(this.in,this.hn,this)}bn(t,s){return(0!==t||0!==s)&&this.move(t,s)||0!==t&&this.move(t,0)||0!==s&&this.move(0,s)}move(t,s){t>0&&(this.view.Oe=!1),t<0&&(this.view.Oe=!0);const i=this.Xs+t,h=this.qs+s;return!!this.ni.available(i,h,this)&&(this.mn(i,h),!0)}vn(){if(Math.random()<.1){const t=Math.floor(3*Math.random())-1,s=Math.floor(3*Math.random())-1;if(this.bn(t,s))return!0}return!1}xn(){-1!==this.in&&-1!==this.hn&&this.setPosition(this.in,this.hn)}yn(){-1!==this.in&&-1!==this.hn&&(this.ni.remove(this.in,this.hn,this),this.ni.set(this.Xs,this.qs,this),this.in=-1,this.hn=-1)}_n(t){t.x<this.x&&(this.view.Oe=!0),t.x>this.x&&(this.view.Oe=!1)}Mn(t,s=15,i=15){const h=this.ni,e=new ot(h.width,h.height),n=Math.max(0,this.Xs-s),r=Math.min(h.width-1,this.Xs+this.width-1+s),o=Math.max(0,this.qs-this.height-s),l=Math.min(h.width-1,this.qs+s);for(let s=o;s<=l;s++)for(let i=n;i<=r;i++){const n=h.ht(i,s),r=n.object;!n.Ji||n.ti(this)&&r!==t?e.mark(i,s):e.clear(i,s)}const a=e.find(this,t);return a.length<=i?a:[]}kn(t,s,i,h){return Math.max(0,Math.max(t,i)-Math.min(s,h))}In(t){const s=this.kn(this.x,this.x+this.width-1,t.x,t.x+t.width-1),i=this.kn(this.y-this.height+1,this.y,t.y-t.height+1,t.y);return Math.max(s,i)}On(t,s){const i=this.x,h=this.width,e=4===t||1===t?0:i+(h-1),n=4===t||2===t?this.ni.width-1:i+(h-1),r=s.x,o=r+s.width-1;return 0===this.kn(e,n,r,o)}Nn(t){return Math.max(Math.abs(t.x-this.Xs),Math.abs(t.y-this.qs))+(t.y!==this.qs?.5:0)+(t.x===this.Xs&&t.y===this.qs?0:1)+(this.view.Oe?t.x<this.Xs?0:1:t.x>this.Xs?0:.5)}Tn(t,s,i){const h=this.x,e=this.y,n=this.width,r=this.height,o=4===t||2===t,l=4===t||1===t?Math.max(0,h-s):h+(n-1),a=o?Math.min(this.ni.width-1,h+(n-1)+s):h,c=Math.max(0,e-r+1-s),u=Math.min(this.ni.height-1,e+s),f=[];for(let t=c;t<=u;t++)for(let s=l;s<=a;s++){const h=this.ni.ht(s,t);i(h)&&f.push(h)}return f.sort((t,s)=>this.Nn(t)-this.Nn(s)),f}En(t,s){const[i]=this.Tn(4,t,s);return i||null}Dn(t=5){return this.En(t,t=>t.Ji&&!t._h&&!t.bh)}Sn(t=5){return this.En(t,t=>t.Ji&&!t._h)}An(t){let s=this.x,i=this.y;const h=t.x,e=t.y,n=Math.abs(h-s),r=Math.abs(e-i),o=s<h?1:-1,l=i<e?1:-1;let a=(n>r?n:-r)/2;for(;s!==h||i!==e;){const t=a;if(t>-n&&(a-=r,s+=o),t<r&&(a+=n,i+=l),s===h&&i===e)break;const c=this.ni.ht(s,i);if(!c.Ji)return!1;if(c.ti(this))return!1}return!0}xs(){const t=this.nn,s=new lt(0,[0,1]);return s.state(0).ae(()=>{const s=.2*this.state.speed.get();t.clear(),t.Xe(s,this.state.name+"_idle",4);const i=this.state.Ms;i&&t.Qe(s,i.animations.xs),t.start()}).Lh(s=>t.update(s)).ue(()=>t.stop()).de(1).be(()=>!t.Le),s}_s(){const t=this.nn,s=new lt(0,[0,0,1]);return s.state(0).ae(()=>{const s=.2*this.state.speed.get();t.clear(),t.Xe(s,this.state.name+"_run",4),t.qe(s,this);const i=this.state.Ms;i&&t.Qe(s,i.animations._s),t.start()}).ue(()=>{t.Le?(this.yn(),t.stop()):this.xn()}).Lh(s=>t.update(s)).de(1).be(()=>!t.Le),s}bt(t){const s=this.Ln(t),i=this.Pn(t),h=new lt(0,[0,1,2,3]);return h.state(0).de(2).be(()=>null!==this.state.Ms).be(()=>this.state.Ms.animations.bt.length>1),h.state(0).de(1),h.state(1).fe(s).de(3).be(()=>s.Qh),h.state(2).fe(i).de(3).be(()=>i.Qh),h}Ln(t){const s=this.nn,i=new lt(0,[0,1,2]);return i.state(0).ae(()=>{const t=this.state.Ms;if(s.clear(),t){const i=.2*t.speed;s.Xe(i,this.state.name+"_idle",4),s.Qe(i,t.animations.bt[0])}else{const t=.2*this.state.speed.get();s.Xe(t,this.state.name+"_idle",4)}s.start()}).de(1),i.state(1).Lh(t=>s.update(t)),i.state(1).de(2).be(()=>!s.Le),i.state(2).ae(()=>t.Rn(1)).ae(()=>s.stop()),i}Pn(t){const s=this.nn;let i=0,h=0,e=[];const n=new lt(0,[0,1,2]);return n.state(0).ae(()=>{const t=this.state.Ms;e=t.animations.bt,h=.2*t.speed,i=0,s.clear(),s.Xe(h,this.state.name+"_idle",4),s.Qe(h,e[0]),s.start(),i++}).Lh(t=>s.update(t)).ue(()=>t.Rn(i)),n.state(0).de(1).be(()=>!s.Le).be(()=>t.Cn()),n.state(0).de(2).be(()=>!s.Le).be(()=>!t.Cn()),n.state(1).ae(()=>{s.clear(),s.Xe(h,this.state.name+"_idle",4),s.Qe(h,e[i]),s.start(),i++}).Lh(t=>s.update(t)).ue(()=>t.Rn(i)),n.state(1).de(1).be(()=>!s.Le).be(()=>i<e.length).be(()=>t.Cn()),n.state(1).de(1).be(()=>!s.Le).be(()=>i<e.length).be(()=>!t.Cn()),n.state(1).de(2).be(()=>!s.Le).be(()=>i===e.length),n}}(t=>{t[t.PLAY=0]="PLAY",t[t.COMPLETE=1]="COMPLETE"})(bt||(bt={})),(t=>{t[t.PLAY=0]="PLAY",t[t.COMPLETE=1]="COMPLETE"})(vt||(vt={})),(t=>{t[t.INITIAL=0]="INITIAL",t[t.SIMPLE_HIT=1]="SIMPLE_HIT",t[t.COMBO_HIT=2]="COMBO_HIT",t[t.COMPLETE=3]="COMPLETE"})(xt||(xt={})),(t=>{t[t.INITIAL=0]="INITIAL",t[t.PLAY=1]="PLAY",t[t.COMPLETE=2]="COMPLETE"})(_t||(_t={})),(t=>{t[t.FIRST_HIT=0]="FIRST_HIT",t[t.NEXT_HIT=1]="NEXT_HIT",t[t.COMPLETE=2]="COMPLETE"})(Mt||(Mt={})),(t=>{t.DEMON="demon",t.ZOMBIE="zombie",t.ORC="orc",t.SLIME="slime",t.UNDEAD="undead"})(kt||(kt={})),(t=>{t.NORMAL="normal",t.SUMMON="summon",t.MINION="minion",t.BOSS="boss"})(It||(It={}));let Nt=(()=>{class t extends Ot{constructor(t,s,i){super(s,i),this.$n=[],this.state=t}get zn(){return this.$n.length>0}pn(t){t&&t instanceof Ms&&(this.ni.log(`${this.state.name} killed by ${t.state.name}`),t.state.Bn(this.state.Hn))}Un(t){const s=this.state.Ms,i=this.view.Oe?1:2,h=(null==s?void 0:s.ls)||1,e=this.Gn(i,h),n=this.state.as+t;for(const t of e)t.dn(this,n)}Fn(t){this.In(t)<=2*this.state.Wn&&(this.$n=this.Mn(t))}Gn(t,s=this.state.Wn){return this.ni.ei.hi({type:Ms.type,filter:i=>!i.an&&this.In(i)<=s&&this.On(t,i)&&this.An(i)})}jn(){const[t]=this.Gn(4,this.state.Wn);if(t){for(const s of this.Kn())s.Fn(t);return!0}return!1}get Vn(){var t;const s=(null===(t=this.state.Ms)||void 0===t?void 0:t.ls)||1;return this.Gn(4,s).length>0}get Xn(){return this.Gn(4).length>0}qn(){const[t]=this.Gn(4);return!!t&&(this._n(t),this.moveTo(t))}Jn(){const[t]=this.Gn(4);t&&this._n(t)}Yn(){const[t]=this.Gn(4);if(!t)return!1;const s=Math.min(1,Math.max(-1,this.x-t.x)),i=Math.min(1,Math.max(-1,this.y-t.y));return this.bn(s,i)}Kn(){return this.ni.ei.hi({type:t.type,filter:t=>!t.an&&this.In(t)<=this.state.Wn&&this.An(t)})}Qn(){if(this.$n.length>0){const t=this.$n[0],s=t.x-this.x,i=t.y-this.y;return this.move(s,i)?(this.$n.splice(0,1),!0):(this.$n=[],!1)}return!1}moveTo(t){return this.$n=this.Mn(t),this.Qn()}}return t.type=s=>s instanceof t,t})();class Tt{constructor(t){this.t=t}Rn(t){this.t.Un(t)}Cn(){return!0}}let Et=(()=>{class t extends Nt{constructor(t,s,i,h){super(t,s,{width:2,height:2,x:i,y:h,animation:t.name+"_idle",zIndex:V.lh,Qs:!1,Zs:!1}),this.init()}gn(){var t;this.ni.controller.Oh({text:this.ni.Os.St()?"VICTORY ACHIEVED":"YOU DEFEATED",color:o});for(let s=0;s<9;s++)null===(t=this.Dn())||void 0===t||t.vh();this.I()}on(){const t=new lt(0,[0,1,2]),s=this.Zn(),i=this.tr(),h=this.attack();return t.state(0).ae(()=>s.start()).Lh(t=>s.update(t)).ce(t=>s.ie(t)),t.state(0).de(2).be(()=>s.Qh).be(()=>3===s.Zh),t.state(0).de(1).be(()=>s.Qh).be(()=>2===s.Zh),t.state(1).ae(()=>i.start()).Lh(t=>i.update(t)),t.state(1).de(2).be(()=>i.Qh).be(()=>3===i.Zh),t.state(1).de(0).be(()=>i.Qh).be(()=>4===i.Zh),t.state(2).ae(()=>h.start()).Lh(t=>h.update(t)),t.state(2).de(1).be(()=>h.Qh).be(()=>4===h.Zh),t}Zn(){const t=new lt(0,[0,1,2,3]),s=this.xs(),i=this._s();return t.state(0).fe(s),t.state(0).de(3).be(()=>this.jn()),t.state(0).de(2).be(()=>this.zn),t.state(0).de(1).be(()=>s.Qh).be(()=>this.vn()),t.state(0).de(0).be(()=>s.Qh),t.state(1).fe(i),t.state(1).de(3).be(()=>i.Qh).be(()=>this.jn()),t.state(1).de(2).be(()=>i.Qh).be(()=>this.zn),t.state(1).de(0).be(()=>i.Qh),t}tr(){const t=new lt(1,[0,1,2,3,4]),s=this.xs(),i=this._s();let h=0;return t.state(0).ae(()=>h=10),t.state(0).de(2).be(()=>this.Qn()),t.state(0).de(1),t.state(1).fe(s),t.state(1).de(3).be(()=>this.jn()),t.state(1).de(2).be(()=>s.Qh).be(()=>this.Qn()),t.state(1).de(1).be(()=>s.Qh).be(()=>--h>0),t.state(1).de(4).be(()=>s.Qh),t.state(2).fe(i),t.state(2).de(3).be(()=>i.Qh).be(()=>this.jn()),t.state(2).de(2).be(()=>i.Qh).be(()=>this.Qn()),t.state(2).de(1).be(()=>i.Qh),t}attack(){const t=this.ni.Os,s=new lt(0,[0,1,2,3,4]),i=this.xs(),h=this._s(),e=this.bt(new Tt(this));return s.state(0).de(3).be(()=>this.Vn).be(()=>t.float()<this.state.sr),s.state(0).de(2).be(()=>this.qn()),s.state(0).de(1).be(()=>this.Xn),s.state(0).de(4),s.state(1).fe(i).ae(()=>this.Jn()),s.state(1).de(3).be(()=>i.Qh).be(()=>this.Vn).be(()=>t.float()<this.state.sr),s.state(1).de(2).be(()=>i.Qh).be(()=>this.qn()),s.state(1).de(1).be(()=>i.Qh).be(()=>this.Xn),s.state(1).de(4).be(()=>i.Qh),s.state(2).fe(h),s.state(2).de(3).be(()=>h.Qh).be(()=>this.Vn).be(()=>t.float()<this.state.sr),s.state(2).de(2).be(()=>h.Qh).be(()=>this.qn()),s.state(2).de(1).be(()=>h.Qh),s.state(3).fe(e).ae(()=>this.Jn()),s.state(3).de(2).be(()=>e.Qh).be(()=>this.qn()),s.state(3).de(1).be(()=>e.Qh),s}}return t.type=s=>s instanceof t,t})();var Dt,St,At,Lt;(t=>{t[t.PATROLLING=0]="PATROLLING",t[t.ALARM=1]="ALARM",t[t.ATTACK=2]="ATTACK"})(Dt||(Dt={})),(t=>{t[t.IDLE=0]="IDLE",t[t.RANDOM_MOVE=1]="RANDOM_MOVE",t[t.GO_ALARM=2]="GO_ALARM",t[t.GO_ATTACK=3]="GO_ATTACK"})(St||(St={})),(t=>{t[t.INITIAL=0]="INITIAL",t[t.IDLE=1]="IDLE",t[t.RUN=2]="RUN",t[t.GO_ATTACK=3]="GO_ATTACK",t[t.GO_PATROLLING=4]="GO_PATROLLING"})(At||(At={})),(t=>{t[t.INITIAL=0]="INITIAL",t[t.IDLE=1]="IDLE",t[t.RUN=2]="RUN",t[t.HIT=3]="HIT",t[t.GO_ALARM=4]="GO_ALARM"})(Lt||(Lt={}));class Pt extends t.Container{constructor(t){super(),this.ir=t;const s=Math.floor(Math.min(4*t.state.js.get(),550));this.Fs=new c({color:r,width:s,o:t.state.js.get(),u:!0}),this.Fs.position.set(-(this.Fs.width>>1),0),this.v(this.Fs),this.ir.state.Ws.subscribe(this.hr,this),this.ir.ln.subscribe(this.er,this)}I(){this.ir.state.Ws.unsubscribe(this.hr,this),this.ir.ln.unsubscribe(this.er,this),this.Fs.I(),super.I()}hr(t){this.Fs.value=t,this.Fs.label=`${this.ir.state.name} - ${t}`}er(t){t&&this.I()}}class Rt extends Nt{constructor(t,s,i,h){super(t,s,{x:i,y:h,width:1,height:1,Qs:!1,Zs:!1,animation:t.name+"_idle",zIndex:V.lh}),this.init()}gn(){var t;Math.random()<this.state.sr&&(null===(t=this.Dn())||void 0===t||t.vh()),this.I()}on(){const t=new lt(0,[0,1,2]),s=this.Zn(),i=this.tr(),h=this.attack();return t.state(0).fe(s),t.state(0).de(2).be(()=>s.Qh).be(()=>3===s.Zh),t.state(0).de(1).be(()=>s.Qh).be(()=>2===s.Zh),t.state(1).fe(i),t.state(1).de(2).be(()=>i.Qh).be(()=>3===i.Zh),t.state(1).de(0).be(()=>i.Qh).be(()=>4===i.Zh),t.state(2).fe(h),t.state(2).de(1).be(()=>h.Qh).be(()=>4===h.Zh),t}Zn(){const t=new lt(0,[0,1,2,3]),s=this.xs(),i=this._s();return t.state(0).fe(s),t.state(0).de(3).be(()=>this.jn()),t.state(0).de(2).be(()=>s.Qh).be(()=>this.zn),t.state(0).de(1).be(()=>s.Qh).be(()=>this.vn()),t.state(0).de(0).be(()=>s.Qh),t.state(1).fe(i),t.state(1).de(3).be(()=>i.Qh).be(()=>this.jn()),t.state(1).de(2).be(()=>i.Qh).be(()=>this.zn),t.state(1).de(0).be(()=>i.Qh),t}tr(){const t=new lt(1,[0,1,2,3,4]),s=this.xs(),i=this._s();let h=0;return t.state(0).ae(()=>h=10),t.state(0).de(2).be(()=>this.Qn()),t.state(0).de(1),t.state(1).fe(s),t.state(1).de(3).be(()=>this.jn()),t.state(1).de(2).be(()=>s.Qh).be(()=>this.Qn()),t.state(1).de(1).be(()=>s.Qh).be(()=>--h>0),t.state(1).de(4).be(()=>s.Qh),t.state(2).fe(i),t.state(2).de(3).be(()=>i.Qh).be(()=>this.jn()),t.state(2).de(2).be(()=>i.Qh).be(()=>this.Qn()),t.state(2).de(1).be(()=>i.Qh),t}attack(){const t=this.ni.Os,s=new lt(0,[0,1,2,3,4]),i=this.xs(),h=this._s(),e=this.bt(new Tt(this));return s.state(0).de(3).be(()=>this.Vn),s.state(0).de(2).be(()=>this.qn()),s.state(0).de(1).be(()=>this.Xn),s.state(0).de(4),s.state(1).fe(i).ae(()=>this.Jn()),s.state(1).de(3).be(()=>i.Qh).be(()=>this.Vn).be(()=>t.float()<this.state.sr),s.state(1).de(2).be(()=>i.Qh).be(()=>this.qn()),s.state(1).de(1).be(()=>i.Qh).be(()=>this.Xn),s.state(1).de(4).be(()=>i.Qh),s.state(2).fe(h),s.state(2).de(3).be(()=>h.Qh).be(()=>this.Vn).be(()=>t.float()<this.state.sr),s.state(2).de(2).be(()=>h.Qh).be(()=>this.qn()),s.state(2).de(1).be(()=>h.Qh),s.state(3).fe(e).ae(()=>this.Jn()),s.state(3).de(2).be(()=>e.Qh).be(()=>this.qn()),s.state(3).de(1).be(()=>e.Qh),s}}var Ct,$t,zt,Bt,Ht,Ut,Gt;(t=>{t[t.PATROLLING=0]="PATROLLING",t[t.ALARM=1]="ALARM",t[t.ATTACK=2]="ATTACK"})(Ct||(Ct={})),(t=>{t[t.IDLE=0]="IDLE",t[t.RANDOM_MOVE=1]="RANDOM_MOVE",t[t.GO_ALARM=2]="GO_ALARM",t[t.GO_ATTACK=3]="GO_ATTACK"})($t||($t={})),(t=>{t[t.INITIAL=0]="INITIAL",t[t.IDLE=1]="IDLE",t[t.RUN=2]="RUN",t[t.GO_ATTACK=3]="GO_ATTACK",t[t.GO_PATROLLING=4]="GO_PATROLLING"})(zt||(zt={})),(t=>{t[t.INITIAL=0]="INITIAL",t[t.IDLE=1]="IDLE",t[t.RUN=2]="RUN",t[t.HIT=3]="HIT",t[t.GO_ALARM=4]="GO_ALARM"})(Bt||(Bt={}));class Ft extends Nt{constructor(t,s,i,h){super(t,s,{x:i,y:h,width:1,height:1,Qs:!1,Zs:!1,animation:t.name+"_idle",zIndex:V.lh}),this.nr=3,this.rr=[],this.init()}gn(){var t;Math.random()<this.state.sr&&(null===(t=this.Dn())||void 0===t||t.vh()),this.I()}or(){for(let t=this.rr.length-1;t>=0;t--)this.rr[t].an&&this.rr.splice(t,1);if(this.rr.length<this.nr){if(Math.random()>.1)return!1;const t=this.Sn();if(!t)return!1;const s=this.ni.controller.ar.lr(this.state.race,this.ni,t.x,t.y);return!!s&&(t.object=s,this.rr.push(s),!0)}return!1}on(){const t=new lt(0,[0,1]),s=this.Zn(),i=this.attack();return t.state(0).fe(s).de(1).be(()=>s.Qh).be(()=>2===s.Zh),t.state(1).fe(i).de(0).be(()=>i.Qh).be(()=>5===i.Zh),t}Zn(){const t=new lt(0,[0,1,2]),s=this.xs(),i=this._s();return t.state(0).fe(s).ae(()=>this.or()),t.state(0).de(2).be(()=>this.jn()),t.state(0).de(1).be(()=>s.Qh).be(()=>this.vn()),t.state(0).de(0).be(()=>s.Qh),t.state(1).fe(i),t.state(1).de(2).be(()=>i.Qh).be(()=>this.jn()),t.state(1).de(0).be(()=>i.Qh),t}attack(){const t=this.ni.Os,s=new lt(0,[0,1,2,3,4,5]),i=this.xs(),h=this._s(),e=this.bt(new Tt(this));return s.state(0),s.state(0).de(5).be(()=>!this.Xn),s.state(0).de(1).be(()=>this.Xn),s.state(1).de(4).be(()=>this.Vn).be(()=>t.float()<this.state.sr),s.state(1).de(3).be(()=>this.Xn).be(()=>this.Yn()),s.state(1).de(2).be(()=>this.Xn),s.state(1).de(5),s.state(2).fe(i).ae(()=>this.or()).de(1).be(()=>i.Qh),s.state(3).fe(h).de(1).be(()=>h.Qh),s.state(4).fe(e).ae(()=>this.Jn()).de(2).be(()=>e.Qh),s}}(t=>{t[t.PATROLLING=0]="PATROLLING",t[t.ATTACK=1]="ATTACK"})(Ht||(Ht={})),(t=>{t[t.IDLE=0]="IDLE",t[t.RANDOM_MOVE=1]="RANDOM_MOVE",t[t.GO_ATTACK=2]="GO_ATTACK"})(Ut||(Ut={})),(t=>{t[t.INITIAL=0]="INITIAL",t[t.DECISION=1]="DECISION",t[t.IDLE=2]="IDLE",t[t.RUN_AWAY=3]="RUN_AWAY",t[t.HIT=4]="HIT",t[t.GO_PATROLLING=5]="GO_PATROLLING"})(Gt||(Gt={}));class Wt{constructor(){this.item=new it(null),this.count=new it(0)}}class jt{constructor(t,s){this.item=t.cr("item",null,s),this.count=t.ur("count",0)}}class Kt{ht(t){return new Wt}}class Vt{constructor(t,s){this.dr=t.prefix("equipment"),this.wr=s}ht(t){return new jt(this.dr.prefix(""+t),this.wr)}}class Xt{ht(t){return new Wt}}class qt{constructor(t,s){this.dr=t.prefix("belt"),this.wr=s}ht(t){return new jt(this.dr.prefix(""+t),this.wr)}}class Jt{ht(t,s){return new Wt}}class Yt{constructor(t,s){this.dr=t.prefix("backpack"),this.wr=s}ht(t,s){return new jt(this.dr.prefix(`${t}:${s}`),this.wr)}}class Qt{constructor(){this.un=new Kt,this.pr=new Xt,this.gr=new Jt,this.Gs=new it(0)}}class Zt{constructor(t,s){const i=new E(s);this.un=new Vt(t,i),this.pr=new qt(t,i),this.gr=new Yt(t,i),this.Gs=t.ur("coins",0)}}class ts{constructor(t,s,i,h,e){this.Pt=t,this.yr=s,this.mr=i,this.yh=h,this.parent=e}get item(){return this.Pt.item}get count(){return this.Pt.count}br(t){return this.supports(t)&&(this.vr||this.Pt.item.get().gs(t)&&this.Pt.count.get()<this.yr)}supports(t){return this.mr(t)}stack(t){var s;return!!((null===(s=this.Pt.item.get())||void 0===s?void 0:s.gs(t))&&this.Pt.count.get()<this.yr)&&(this.Pt.count.update(t=>t+1),!0)}clear(){this.Pt.item.get()&&(this.Pt.item.set(null),this.Pt.count.set(0))}set(t,s=1){return!(this.Pt.item.get()||!this.mr(t))&&(this.Pt.item.set(t),this.Pt.count.set(s),!0)}Ks(){this.Pt.count.update(t=>Math.max(0,t-1)),this.Pt.count.get()<=0&&(this.Pt.item.set(null),this.Pt.count.set(0))}get vr(){return null==this.Pt.item.get()}ys(t){const s=this.Pt.item.get();return!!s&&(s.ys(this,t),!0)}ms(){const t=this.Pt.item.get(),s=this.parent.Ut.un.Ms;if(t&&s.supports(t)){const i=s.item.get();s.clear(),s.set(t),this.clear(),i&&this.set(i)}}xr(){const t=this.Pt.item.get();for(;t&&!this.vr&&this.parent.Ut.pr.add(t);)this.Ks()}_r(){const t=this.Pt.item.get();for(;t&&!this.vr&&this.parent.Ut.gr.add(t);)this.Ks()}Ht(){const t=this.Pt.item.get(),s=this.Pt.count.get();t&&(this.Pt.item.set(null),this.Pt.count.set(0),this.yh.send([t,s]))}}class ss{constructor(t){this.yh=new ht,this.un=new is(this,t.un,this.yh),this.pr=new hs(this,t.pr,this.yh),this.gr=new es(this,t.gr,this.yh)}get Ht(){return this.yh}stack(t){return this.pr.stack(t)||this.gr.stack(t)}set(t){return this.pr.set(t)||this.gr.set(t)}add(t){return this.stack(t)||this.set(t)}br(t){return this.pr.br(t)||this.gr.br(t)}}class is{constructor(t,s,i){this.Ut=t,this.Ms=new ts(s.ht("weapon"),1,t=>t instanceof O,i,this)}}class hs{constructor(t,s,i){this.length=10,this.Ut=t,this.K=[];for(let t=0;t<10;t++)this.K[t]=new ts(s.ht(t),3,()=>!0,i,this)}ht(t){return this.K[t]}stack(t){for(let s=0;s<this.K.length;s++)if(this.K[s].stack(t))return!0;return!1}set(t){for(let s=0;s<this.K.length;s++)if(this.K[s].set(t))return!0;return!1}add(t){return this.stack(t)||this.set(t)}br(t){for(let s=0;s<this.K.length;s++)if(this.K[s].br(t))return!0;return!1}}class es{constructor(t,s,i){this.width=10,this.height=5,this.Ut=t,this.K=[];for(let t=0;t<this.height;t++){this.K.push([]);for(let h=0;h<this.width;h++)this.K[t][h]=new ts(s.ht(h,t),3,()=>!0,i,this)}}ht(t,s){return this.K[s][t]}stack(t){for(let s=0;s<this.height;s++)for(let i=0;i<this.width;i++)if(this.K[s][i].stack(t))return!0;return!1}set(t){for(let s=0;s<this.height;s++)for(let i=0;i<this.width;i++)if(this.K[s][i].set(t))return!0;return!1}add(t){return this.stack(t)||this.set(t)}br(t){for(let s=0;s<this.height;s++)for(let i=0;i<this.width;i++)if(this.K[s][i].br(t))return!0;return!1}}class ns extends t.Container{constructor(t,s,i,h,e){super(),this.vt=i,this.Mr=h,this.kr=e;const n=s.Ut,r=new d({padding:0});this.v(r);const o=new f({padding:0});r.v(o),this.Ir=new rs(t,n.un),o.v(this.Ir),i.set(h,e,this.Ir.Ms,()=>this.show(n.un.Ms)),i.pt(h,e,10,1),this.Or=new os(t,n.pr),o.v(this.Or);for(let t=0;t<this.Or.length;t++){const s=n.pr.ht(t);this.vt.set(h+t,e+1,this.Or.ht(t),()=>this.show(s))}this.Nr=new ls(t,n.gr),o.v(this.Nr);for(let t=0;t<n.gr.width;t++)for(let s=0;s<n.gr.height;s++){const i=n.gr.ht(t,s);this.vt.set(h+t,e+s+2,this.Nr.ht(t,s),()=>this.show(i))}this.me=new us(this.vt,this.Mr,this.kr,s),o.v(this.me),this.Tr=new cs(t,s,{width:400,height:400}),r.v(this.Tr)}I(){super.I(),this.Ir.I(),this.Or.I(),this.Nr.I(),this.Tr.I()}show(t){this.Tr.Er=t.item,this.me.ht=t}}class rs extends t.Container{constructor(s,i){super(),this.Ir=i;const e=(new t.Graphics).T(h).N(0,0,32+(l<<1),32+(l<<1)).O();this.v(e),this.Ms=new as(s,{item:this.Ir.Ms.item,count:new it(null)}),this.Ms.position.set(l,l),this.v(this.Ms)}}class os extends t.Container{constructor(s,i){super(),this.Dr=i;const e=(new t.Graphics).T(h).N(0,0,l+(32+l)*i.length,32+(l<<1)).O();this.v(e),this.K=[];for(let t=0;t<i.length;t++){const h=i.ht(t),e=new as(s,{item:h.item,count:h.count});e.position.set(l+(32+l)*t,l),this.K.push(e),this.v(e)}}get length(){return this.Dr.length}ht(t){return this.K[t]}}class ls extends t.Container{constructor(s,i){super();const e=(new t.Graphics).T(h).N(0,0,l+(32+l)*i.width,l+(32+l)*i.height).O();this.v(e),this.K=[];for(let t=0;t<i.height;t++){this.K.push([]);for(let h=0;h<i.width;h++){const e=i.ht(h,t),n=new as(s,{item:e.item,count:e.count});n.position.set(l+(32+l)*h,l+(32+l)*t),this.K[t][h]=n,this.v(n)}}}ht(t,s){return this.K[s][t]}}class as extends t.Container{constructor(s,i){super(),this.Ps=null,this.D=!1,this.Sr=i.item,this.Ar=i.count,this.Rs=s,this.H=new t.Graphics,this.selected=!1,this.Lr=new t.BitmapText("0",{font:{name:"alagard",size:16}}),this.Lr.anchor=new t.Point(1,0),this.Lr.position.set(32-l,0),this.v(this.H,this.Lr),this.Sr.subscribe(this.Pr,this),this.Ar.subscribe(this.Rr,this)}I(){super.I(),this.Sr.unsubscribe(this.Pr,this),this.Ar.unsubscribe(this.Rr,this)}get selected(){return this.D}set selected(t){this.D=t,this.H.clear().T(t?e:n).N(0,0,32,32).O()}Rr(t){this.Lr.text=null===t||0===t?"":t.toString()}Pr(t){var s;if(null===(s=this.Ps)||void 0===s||s.I(),this.Ps=null,t){this.Ps=this.Rs.ns(t.fs);const s=(32-(l<<1))/Math.max(this.Ps.width,this.Ps.height);this.Ps.scale.set(s,s),this.Ps.anchor.set(.5,0),this.Ps.position.set(16,l),this.v(this.Ps)}}}class cs extends t.Container{constructor(s,i,e){super(),this.Ps=null,this.Cr=null,this.Rs=s,this.t=i,this._width=e.width||400,this._height=e.height||400,this.$r=128+(a<<1);const r=(new t.Graphics).T(h).N(0,0,this._width,this._height).O().T(n).N(a,a+32+a,this.$r,this.$r).O();this.kt=new t.BitmapText("",{font:{name:"alagard",size:32}}),this.kt.anchor=new t.Point(.5,0),this.kt.position.set(this._width>>1,a),this.zr=new t.BitmapText("",{font:{name:"alagard",size:16}}),this.zr.position.set(a+this.$r+a,a+32+a),this.v(r,this.kt,this.zr)}I(){var t;super.I(),null===(t=this.Cr)||void 0===t||t.unsubscribe(this.ie,this),this.Cr=null}set Er(t){var s;null===(s=this.Cr)||void 0===s||s.unsubscribe(this.ie,this),this.Cr=null,this.Cr=t,this.Cr.subscribe(this.ie,this)}ie(s){var i;if(null===(i=this.Ps)||void 0===i||i.I(),this.Ps=null,this.kt.text="",this.zr.text="",s){const i=this.Ps=this.Rs.ns(s.fs);i.anchor=new t.Point(.5,.5),i.position.set(a+(this.$r>>1),a+(this.$r>>1)+32+a);const h=this.$r-a,e=i.width,n=i.height;e>n?(this.Ps.width=h,this.Ps.height=h/e*n):(this.Ps.height=h,this.Ps.width=h/n*e),this.v(this.Ps);const r=this.t.Br(s);this.kt.text=r.name;const o=[];r.Ws&&o.push("health: "+r.Ws),r.speed&&o.push(`speed: ${100*r.speed}%`),r.ls&&o.push("distance: "+r.ls),r.as&&o.push("damage: "+r.as),r.us&&o.push(`price: ${r.us}$`),this.zr.text=o.join("\n")}}}class us extends t.Container{constructor(t,s,i,h){super(),this.Hr=[],this.Ur=null,this.vt=t,this.Mr=s,this.kr=i,this.t=h}I(){var t;super.I(),null===(t=this.Ur)||void 0===t||t.item.unsubscribe(this.ie,this),this.Ur=null,this.Gr()}set ht(t){var s;null===(s=this.Ur)||void 0===s||s.item.unsubscribe(this.ie,this),this.Gr(),this.Ur=t,this.Ur.item.subscribe(this.ie,this)}get ht(){return this.Ur}ie(t){this.t.Fr(this,t)}Gr(){for(const[t,s,i]of this.Hr)this.vt.gt(s,i),this.vt.remove(s,i),t.I();this.vt.reset(),this.Hr.splice(0,this.Hr.length)}Wr(t,s){const i=this.Hr.length,h=i>>1,e=i%2,n=this.Mr+5*e,r=this.kr+10+h,o=new u({label:t,width:170,height:32});o.position.set(e*(170+a),h*(32+a)),this.Hr.push([o,n,r]),this.vt.set(n,r,o,s),this.vt.pt(n,r,5,1),this.v(o)}}class fs extends m{constructor(t,s){super(t,s.title),this.jr=s}init(){super.init(),this.v(new ns(this.t.vs,this.jr,this.vt,0,1)),this.t.ticker.add(this.yt,this)}I(){this.t.ticker.remove(this.yt,this),super.I()}yt(){this.t.xt.Ut.once()&&this.t.Mt()}}class ds{constructor(t,s){this.Ut=t,this.title=s}Fr(t,s){t.Gr(),s&&this.buttons(t,s)}}class ws extends ds{constructor(t,s){super(t.Ut,s),this.Dh=t}Kr(t,s){const i=t.ht;(i.parent instanceof hs||i.parent instanceof es)&&(this.Ut.un.Ms.supports(s)?t.Wr("Equip",()=>i.ms()):t.Wr("Use item",()=>i.ys(this.Dh))),i.parent instanceof hs||t.Wr("To belt",()=>i.xr()),i.parent instanceof es||t.Wr("To backpack",()=>i._r()),t.Wr("Drop",()=>i.Ht())}}class ps extends ws{constructor(t){super(t,"Inventory")}buttons(t,s){this.Kr(t,s)}Br(t){const s=t.info();return s.us=s.ds,s}}class gs extends ws{constructor(t,s){super(t,"Selling"),this.Vr=s}buttons(t,s){this.Kr(t,s),this.Xr(t,s)}Xr(t,s){const i=s.info().ds;void 0!==i&&this.Vr.Gs.get()>=i&&this.Vr.Ut.gr.br(s)&&t.Wr("Sell",()=>{this.Vr.Gs.get()>=i&&this.Vr.Ut.gr.br(s)&&(this.Vr.qr(i),this.Vr.Ut.gr.add(s),this.Dh.Gs.update(t=>t+i),t.ht.Ks())})}Br(t){const s=t.info();return s.us=s.ds,s}}class ys extends ds{constructor(t,s){super(s.Ut,"Buying"),this.Dh=t,this.Vr=s}buttons(t,s){t.ht.parent instanceof es&&this.Jr(t,s)}Jr(t,s){const i=s.info().ws;void 0!==i&&this.Dh.Gs.get()>=i&&this.Dh.Ut.br(s)&&t.Wr("Buy",()=>{this.Vr.Gs.get()>=i&&this.Dh.Ut.br(s)&&(this.Dh.Gs.update(t=>Math.max(0,t-i)),this.Dh.Ut.gr.add(s),this.Vr.Yr(i),t.ht.Ks())})}Br(t){const s=t.info();return s.us=s.ws,s}}class ms{constructor(){}get Ms(){return this.Ut.un.Ms.item.get()||null}get as(){var t;return this.Qr.get()+((null===(t=this.Ms)||void 0===t?void 0:t.as)||0)}Yr(t){this.Gs.update(s=>s+t)}qr(t){const s=this.Gs.get();return s>=t&&(this.Gs.set(s-t),!0)}Zr(t){this.Ws.update(s=>Math.min(this.js.get(),s+t))}}class bs extends ms{constructor(t){super(),this.name=t.name,this.js=new it(t.js),this.Ws=new it(t.Ws),this.Qr=new it(t.Qr),this.speed=new it(t.speed),this.Gs=new it(t.Gs),this.Ut=new ss(new Qt)}}class vs extends bs{constructor(t){super(t),this.level=t.level,this.sr=t.sr,this.Hn=t.Hn,this.race=t.race,this.type=t.type,this.Wn=t.Wn,this.width=t.width,this.height=t.height}}class xs{constructor(t){this.t=t}init(){this.bs=this.t.loader.vs["monster.config.json"].data}modify(t,s,i){return Math.floor(t+t*s*i)}lr(t,s,i,h){const e=this.bs.to.filter(s=>s.race===t&&"minion"===s.type),n=s.Os.select(e);return n?this.so(n,s,i,h):null}io(t,s,i){const h=this.ho(t.level).race,e=this.bs.to.filter(t=>t.race===h||"demon"!=t.race&&"orc"!=t.race&&"zombie"!=t.race),n=t.Os.select(e);if(null===n)throw"No tiny monster config found";return this.so(n,t,s,i)}so(t,s,i,h){const e=new vs({name:t.name,js:this.modify(t.Ws,.1,s.level),Ws:this.modify(t.Ws,.1,s.level),Qr:this.modify(t.as,.1,s.level),speed:t.speed,Gs:0,level:s.level,sr:t.sr,Hn:35+5*s.level,race:t.race,type:t.type,Wn:7,width:1,height:1}),n=e.sr<s.Os.float()?s.Os.select(t.Ts):null;if(n){const t=this.t.xh.As(n);e.Ut.un.Ms.set(t)}return new Rt(e,s,i,h)}eo(t,s,i){const h=this.ho(t.level).race,e=this.bs.no.filter(t=>t.race===h||"demon"!=t.race&&"orc"!=t.race&&"zombie"!=t.race),n=t.Os.select(e);if(null===n)throw"No summon monster config found";return this.ro(n,t,s,i)}ro(t,s,i,h){const e=new vs({name:t.name,js:this.modify(t.Ws,.1,s.level),Ws:this.modify(t.Ws,.1,s.level),Qr:this.modify(t.as,.1,s.level),speed:t.speed,Gs:0,level:s.level,sr:t.sr,Hn:35+5*s.level,race:t.race,type:"summon",Wn:7,width:1,height:1}),n=e.sr<s.Os.float()?s.Os.select(t.Ts):null;if(n){const t=this.t.xh.As(n);e.Ut.un.Ms.set(t)}return new Ft(e,s,i,h)}oo(t,s,i){const h=this.ho(t.level);return this.lo(h,t,s,i)}lo(t,s,i,h){const e=new vs({name:t.name,js:this.modify(t.Ws,.1,s.level),Ws:this.modify(t.Ws,.1,s.level),Qr:this.modify(t.as,.1,s.level),speed:t.speed,Gs:0,level:s.level,sr:t.sr,Hn:200+20*s.level,race:t.race,type:"boss",Wn:7,width:2,height:2}),n=e.sr<s.Os.float()?s.Os.select(t.Ts):null;if(n){const t=this.t.xh.As(n);e.Ut.un.Ms.set(t)}return new Et(e,s,i,h)}ho(t){return this.bs.ao[Math.floor((t-1)/5)%this.bs.ao.length]}}const _s=["elf_f","elf_m","knight_f","knight_m","wizard_f","wizard_m"];let Ms=(()=>{class s extends Ot{constructor(t,s,i,h){super(s,{x:i,y:h,width:1,height:1,zIndex:V.Ns,Qs:!1,Zs:!1,animation:t.name+"_idle",en:(t,i)=>s.dh.setPosition(t,i)}),this.state=t,this.init()}init(){super.init(),this.state.Ut.Ht.subscribe(this.co,this)}I(){this.state.Ut.Ht.unsubscribe(this.co,this),super.I()}pn(t){this.ni.log(`${this.state.name} killed by ${t.state.name}`)}gn(){this.I(),this.state.uo(),this.ni.controller.ln()}co(t){const[s]=t,i=this.Dn();i&&(i.oi=s)}fo(){var s;(null===(s=this.ni.ht(this.x,this.y).Ht)||void 0===s?void 0:s.ps(this))&&t.sound.play("fruit_collect")}Un(s){const i=this.state.Ms,h=(null==i?void 0:i.ls)||1,e=this.view.Oe?1:2,n=this.Kn(e,h),r=this.state.as+s;for(const t of n)t.dn(this,r);n.length>0&&t.sound.play("hit_damage",{speed:(null==i?void 0:i.speed)||1})}do(){var t;const s=(null===(t=this.state.Ms)||void 0===t?void 0:t.ls)||1,i=this.wo(1,s),h=this.wo(2,s);i>0&&i>h?this.view.Oe=!0:h>0&&h>i&&(this.view.Oe=!1)}po(){const t=this.view.Oe?1:2,[s]=this.Tn(t,1,t=>t.Zs);return!!s&&(s.si(this),!0)}Kn(t,s){return this.ni.ei.hi({type:Nt.type,filter:i=>this.In(i)<=s&&this.On(t,i)})}wo(t,s){return this.Kn(t,s).map(t=>t.state.Ws.get()).reduce((t,s)=>t+s,0)}on(){const t=this.ni.controller.xt,s=new lt(0,[0,1,2,3]),i=this.xs(),h=this._s(),e=this.bt(new ks(this,this.ni.controller.xt));return s.state(0).fe(i).ae(()=>this.fo()).Lh(()=>this.yo()),s.state(0).de(3).be(()=>t.bt.once()),s.state(0).de(1).be(()=>this.mo()),s.state(0).de(0).be(()=>i.Qh),s.state(1).fe(h).ae(()=>this.fo()).Lh(()=>this.yo()),s.state(1).de(3).be(()=>h.Qh).be(()=>t.bt.once()),s.state(1).de(1).be(()=>h.Qh).be(()=>this.mo()),s.state(1).de(0).be(()=>h.Qh),s.state(2).fe(e).ae(()=>this.fo()).ae(()=>this.do()).Lh(()=>this.yo()),s.state(2).de(3).be(()=>e.Qh).be(()=>t.bt.once()),s.state(2).de(1).be(()=>e.Qh).be(()=>this.mo()),s.state(2).de(0).be(()=>e.Qh),s.state(3).de(2).be(()=>this.Kn(4,1).length>0),s.state(3).de(0).be(()=>this.po()).action(()=>t.bt.reset()),s.state(3).de(2),s}delta(t,s){return t.repeat()?-1:s.repeat()?1:0}mo(){const t=this.ni.controller.xt,s=this.delta(t.et,t.ot),i=this.delta(t.lt,t.at);return this.bn(s,i)}yo(){const t=this.ni.controller.xt,s=this.state.Ut;for(let s=0;s<=9;s++){const i=(s+1)%10;t.Zt(i).once()&&this.state.Ut.pr.ht(s).ys(this.state)}t.Ht.once()&&s.un.Ms.Ht(),t.Ut.once()&&this.ni.controller.bo(this.state)}}return s.type=t=>t instanceof s,s})();class ks{constructor(t,s){this.t=t,this.tt=s}Cn(){return this.tt.bt.once()}Rn(t){this.t.Un(t)}}var Is,Os;(t=>{t[t.IDLE=0]="IDLE",t[t.RUN=1]="RUN",t[t.HIT=2]="HIT",t[t.ON_HIT=3]="ON_HIT"})(Is||(Is={}));class Ns extends ms{constructor(t,s,i,h){super(),this.vo=s,this.xo=i,this.name=t,this.js=this.vo._o("healthMax",30),this.Ws=this.xo._o("health",30),this.Qr=this.vo.ur("baseDamage",3),this.speed=this.vo._o("speed",1),this.Gs=this.vo.ur("coins",0),this.Ut=new ss(new Zt(this.xo,h)),this.level=this.vo.ur("level",1),this.Mo=this.vo.ur("levelXp",0),this.ko=this.vo.ur("skillPoints",0),this.Hn=this.vo.ur("xp",0),this.Ih=new Ts(this.xo)}uo(){this.xo.clear(),this.xo.I()}Bn(t){this.Hn.update(s=>{let i=s+t;for(;;){const t=this.Mo.get();if(!(i>=t))break;i-=t,this.level.update(t=>t+1),this.Mo.update(t=>t+1e3),this.ko.update(t=>t+1)}return i})}}class Ts{constructor(t){this.ni=t.prefix("dungeon"),this.Io=t.prefix("bonfire")}Oo(t){if(isNaN(t))throw"NaN"}No(t){return this.Oo(t),null!==this.ni.get(""+t)}To(t,s){this.Oo(t),this.Oo(s),this.ni.set(""+t,""+s)}Eo(t){return this.Oo(t),parseInt(this.ni.get(""+t))}Do(t){return this.Oo(t),null!==this.Io.get(""+t)}kh(t){return this.Oo(t),null!==this.Io.set(""+t,"true")}Sh(){return this.Io.keys().map(parseInt).sort((t,s)=>t-s)}}class Es{constructor(t){this.t=t,this.dr=t.So}state(t){const s=this.dr.prefix(t),i=s.prefix("global"),h=s.prefix("session"),e=h.vr(),n=new Ns(t,i,h,this.t.xh);if(e){const t=this.t.xh.Es("knife");n.Ut.un.Ms.set(t)}return n}}class Ds extends t.Container{constructor(s,i){super(),this.Ao=i.Lo,this.Po=i.Ro||(256-(l<<1))/30,this.Co=i.$o||256,this.zo=this.Co-(l<<1);const h=18+(l<<1)+a;this.Dh=s,this.Bo=new c({color:r,width:this.zo,o:s.state.js.get()}),this.Ho=new c({color:o,width:this.zo,o:s.state.Mo.get()}),this.Ho.position.set(0,h),this.Us=new t.BitmapText("",{font:{name:"alagard",size:16}}),this.Us.position.set(0,2*h),super.v(this.Bo,this.Ho,this.Us),s.state.Ws.subscribe(this.hr,this),s.state.js.subscribe(this.Uo,this),s.state.level.subscribe(this.Go,this),s.state.Mo.subscribe(this.Go,this),s.state.ko.subscribe(this.Go,this),s.state.Hn.subscribe(this.Go,this),s.state.Gs.subscribe(this.Fo,this)}I(){super.I(),this.Dh.state.Ws.unsubscribe(this.hr,this),this.Dh.state.js.unsubscribe(this.Uo,this),this.Dh.state.level.unsubscribe(this.Go,this),this.Dh.state.Mo.unsubscribe(this.Go,this),this.Dh.state.ko.unsubscribe(this.Go,this),this.Dh.state.Hn.unsubscribe(this.Go,this),this.Dh.state.Gs.unsubscribe(this.Fo,this)}Uo(t){const s=this.Dh.state.Ws.get();this.Bo.o=t,this.Bo.label=`${s}/${t}`,this.Ao||(this.Bo.M=this.Po*t)}hr(t){const s=this.Dh.state.js.get();this.Bo.value=t,this.Bo.label=`${t}/${s}`}Go(){const t=this.Dh,s=t.state.level.get(),i=t.state.Mo.get(),h=t.state.ko.get(),e=t.state.Hn.get();this.Ho.o=i,this.Ho.value=e,this.Ho.label=`L:${s} XP:${e}/${i} SP:${h}`}Fo(t){this.Us.text="$"+t}}class Ss extends s{constructor(t,s){super(t),this.ni=s}init(){const t=this.t.screen,s=new st(this.ni.level);s.position.set(t.width>>1,16),s.zIndex=10,this.v(s),this.ni.li.zIndex=0,this.v(this.ni.li),this.ni.fh.li.zIndex=1,this.v(this.ni.fh.li),this.ni.fh.Ui.zIndex=2,this.ni.fh.Ui.alpha=.8,this.v(this.ni.fh.Ui);const[i]=this.ni.ei.hi({type:Ms.type}),h=new os(this.t.vs,i.state.Ut.pr),e=h.width;h.position.set((t.width>>1)-(e>>1),t.height-52),h.zIndex=11,this.v(h);const n=new Ds(i,{Lo:!1});n.position.set(16,16),n.zIndex=12,this.v(n);const[r]=this.ni.ei.hi({type:Et.type});if(r){const s=new Pt(r);s.zIndex=13,s.position.set(t.width>>1,64),this.v(s)}this.Wo(),this.ni.ticker.start()}I(){this.ni.I(),super.I({children:!0})}pause(){this.ni.ticker.stop()}resume(){this.ni.ticker.start()}}async function As(t=0){return await new Promise(s=>setTimeout(s,t))}function Ls(t,s){const i=[];for(let h=0;h<t;h++)i.push(s);return i}(t=>{t[t.Decided=0]="Decided",t[t.Undecided=-1]="Undecided",t[t.Contradiction=-2]="Contradiction"})(Os||(Os={}));let Ps=(()=>{class t{constructor(t,s,i){this.jo=[],this.Ko=[],this.compatible=[],this.Vo=null,this.Xo=[],this.qo=[],this.Jo=[],this.Yo=[],this.Qo=0,this.Zo=0,this.tl=!1,this.sl=[],this.il=[],this.hl=[],this.el=0,this.nl=0,this.rl=0,this.ol=[],this.ll=[],this.al=[],this.status=Os.Undecided,this.cl=!1,this.debug=!1,this.Os=t,this.ul=s,this.fl=i}get dl(){let t=0;for(let s=0;s<this.jo.length;s++)1===this.hl[s]&&t++;return 100*t/this.jo.length}init(){this.jo=Ls(this.ul*this.fl,[]),this.compatible=[];for(let t=0;t<this.jo.length;t++){this.jo[t]=Ls(this.Zo,!0),this.compatible[t]=[];for(let s=0;s<this.Zo;s++)this.compatible[t][s]=Ls(4,0)}this.il=[],this.el=0,this.nl=0;for(let t=0;t<this.Zo;t++)this.il[t]=this.sl[t]*Math.log(this.sl[t]),this.el+=this.sl[t],this.nl+=this.il[t];this.rl=Math.log(this.el)-this.nl/this.el,this.status=Os.Undecided,this.wl()}clear(){this.hl=[],this.ol=[],this.ll=[],this.al=[];for(let s=0;s<this.jo.length;s++){for(let i=0;i<this.Zo;i++){this.jo[s][i]=!0;for(let h=0;h<4;h++)this.compatible[s][i][h]=this.Ko[t.pl[h]][i].length}this.hl[s]=this.sl.length,this.ol[s]=this.el,this.ll[s]=this.nl,this.al[s]=this.rl}this.Xo=[],this.qo=[],this.Jo=[0],this.Qo=0,this.Yo=[],this.status=Os.Undecided}async _s(t=0,s=!1){0===this.jo.length&&this.init(),this.clear(),this.debug=s;let i=0;for(;(i<t||0===t)&&(i%50==0&&await As(),this.debug,this.step(),this.debug&&this.gl([]),this.status===Os.Undecided);i++);return this.status}step(){let t,s=-1,i=!1;this.cl&&(this.debug,this.yl()),this.status!=Os.Undecided&&(s=0,i=!0,this.debug),i||(this.Jo.push(this.Qo+this.qo.length),[s,t]=this.observe(),this.debug,-1!==s&&(this.debug,this.Yo.push([s,t])));do{if(this.debug,i=!1,this.debug,this.status===Os.Undecided&&this.ml(),this.status===Os.Undecided&&this.yl(),-1===s&&this.status===Os.Undecided)return this.debug,this.status=Os.Decided,this.status;if(this.status===Os.Contradiction)for(this.debug,s=0;;){if(this.debug,1==this.Jo.length)return this.debug,Os.Contradiction;this.bl();const t=this.Yo.pop();if(this.Xo=[],this.status=Os.Undecided,this.debug&&this.gl([t[0]]),this.vl(t[0],t[1])&&(this.status=Os.Contradiction),this.status===Os.Undecided&&this.ml(),this.status!==Os.Contradiction){this.debug,this.Jo.pop(),this.Jo.push(this.Qo+this.qo.length),this.debug,i=!0;break}this.debug}}while(i);return this.status}observe(){this.debug;let t=1e3,s=-1;for(let i=0;i<this.jo.length;i++){if(this.xl(i%this.ul,Math.floor(i/this.ul)))continue;const h=this.hl[i];if(0===h)return this.debug,this.debug&&this.gl([i]),this.status=Os.Contradiction,[-1,-1];const e=this.al[i];if(h>1&&e<=t){const h=1e-6*this.Os.float();e+h<t&&(t=e+h,s=i)}}if(-1==s){this.debug,this.Vo=Ls(this.ul*this.fl,0);for(let t=0;t<this.jo.length;t++){const s=t%this.ul,i=Math.floor(t/this.ul);if(!this.xl(s,i)){this._l(t);for(let s=0;s<this.Zo;s++)if(this.jo[t][s]){this.Vo[t]=s;break}}}return[-1,-1]}let i=0;const h=[];for(let t=0;t<this.Zo;t++)h[t]=this.jo[s][t]?this.sl[t]:0,i+=h[t];let e=this.Os.float()*i,n=0;for(const t of h){if(e-=t,e<0)break;n++}const r=this.jo[s];for(let t=0;t<this.Zo;t++)r[t]!=(t==n)&&(this.debug,this.vl(s,t)&&(this.status=Os.Contradiction));return this.debug&&this.gl([s]),[s,n]}ml(){for(;this.Xo.length>0;){const[s,i]=this.Xo.pop(),h=s%this.ul,e=Math.floor(s/this.ul);for(let s=0;s<4;s++){let n=h+t.Ml[s],r=e+t.kl[s];if(this.xl(n,r))continue;n<0?n+=this.ul:n>=this.ul&&(n-=this.ul),r<0?r+=this.fl:r>=this.fl&&(r-=this.fl);const o=n+r*this.ul,l=this.Ko[s][i],a=this.compatible[o];for(const t of l){const i=a[t];i[s]--,0==i[s]&&this.vl(o,t)&&(this.status=Os.Contradiction)}}if(this.status==Os.Contradiction)break}}Il(t,s){return this.debug,this.jo[t][s]&&(this.cl=!0,this.vl(t,s))?this.status=Os.Contradiction:(this.ml(),this.status)}vl(t,s){this.debug,this.jo[t][s]=!1;const i=this.compatible[t][s];for(let t=0;t<4;t++)i[t]-=this.Zo;this.Xo.push([t,s]),this.hl[t]-=1,this.ol[t]-=this.sl[s],this.ll[t]-=this.il[s];const h=this.ol[t];return this.al[t]=Math.log(h)-this.ll[t]/h,this.qo.push([t,s]),this.Ol(t,s),0===this.hl[t]&&(this.debug&&this.gl([t]),!0)}bl(){const s=this.Jo.pop()-this.Qo;this.debug;const i=[],h=new Set(this.Xo.map(t=>t.join(",")));for(;this.qo.length>s;){const[s,e]=this.qo.pop();i.push(s);const n=this.compatible[s][e];for(let t=0;t<4;t++)n[t]+=this.Zo;this.jo[s][e]=!0,this.hl[s]+=1,this.ol[s]+=this.sl[e],this.ll[s]+=this.il[e];const r=this.ol[s];if(this.al[s]=Math.log(r)-this.ll[s]/r,!h.has([s,e].join(","))){const h=s%this.ul,n=Math.floor(s/this.ul);for(let s=0;s<4;s++){let r=h+t.Ml[s],o=n+t.kl[s];if(this.xl(r,o))continue;r<0?r+=this.ul:r>=this.ul&&(r-=this.ul),o<0?o+=this.fl:o>=this.fl&&(o-=this.fl);const l=r+o*this.ul;i.push(l);const a=this.Ko[s][e];for(const t of a)this.compatible[l][t][s]++}}this.Nl(s,e)}this.debug&&this.gl(i)}}return t.Ml=[-1,0,1,0],t.kl=[0,1,0,-1],t.pl=[2,3,0,1],t})(),Rs=(()=>{class t{constructor(t=0,s=0){this.x=t,this.y=s}Tl(s){return new t(this.x+s.x,this.y+s.y)}El(s){return new t(this.x-s.x,this.y-s.y)}multiply(s){return new t(this.x*s,this.y*s)}get negative(){return new t(-this.x,-this.y)}Dl(t,s){return this.x===t&&this.y===s}vi(t){return this.x===t.x&&this.y===t.y}toString(){return`{x: ${this.x}, y: ${this.y}}`}static from(s){return new t(s.x,s.y)}}return t.NORTH=new t(-1,0),t.SOUTH=new t(1,0),t.EAST=new t(0,1),t.WEST=new t(0,-1),t.NORTH_EAST=new t(-1,1),t.SOUTH_EAST=new t(1,1),t.SOUTH_WEST=new t(1,-1),t.NORTH_WEST=new t(-1,-1),t.ZERO=new t(0,0),t})();var Cs,$s,zs,Bs,Hs;(t=>{t[t.NORTH=0]="NORTH",t[t.EAST=1]="EAST",t[t.SOUTH=2]="SOUTH",t[t.WEST=3]="WEST",t[t.NORTH_EAST=4]="NORTH_EAST",t[t.SOUTH_EAST=5]="SOUTH_EAST",t[t.SOUTH_WEST=6]="SOUTH_WEST",t[t.NORTH_WEST=7]="NORTH_WEST"})(Cs||(Cs={})),(t=>{t[t.OPEN=0]="OPEN",t[t.CLOSED=1]="CLOSED",t[t.GUARANTEED_OPEN=2]="GUARANTEED_OPEN",t[t.GUARANTEED_CLOSED=3]="GUARANTEED_CLOSED",t[t.NON_JOIN_OPEN=4]="NON_JOIN_OPEN",t[t.NON_JOIN_CLOSED=5]="NON_JOIN_CLOSED",t[t.NON_JOIN_GUARANTEED_OPEN=6]="NON_JOIN_GUARANTEED_OPEN",t[t.NON_JOIN_GUARANTEED_CLOSED=7]="NON_JOIN_GUARANTEED_CLOSED",t[t.INSIDE_ROOM_OPEN=8]="INSIDE_ROOM_OPEN",t[t.INSIDE_TUNNEL_OPEN=9]="INSIDE_TUNNEL_OPEN",t[t.INSIDE_ANTEROOM_OPEN=10]="INSIDE_ANTEROOM_OPEN",t[t.H_DOOR=11]="H_DOOR",t[t.V_DOOR=12]="V_DOOR",t[t.COLUMN=13]="COLUMN"})($s||($s={})),(t=>{t[t.SMALL=0]="SMALL",t[t.MEDIUM=1]="MEDIUM",t[t.LARGE=2]="LARGE"})(zs||(zs={}));class Us{constructor(t=[]){this.Sl=t,this.Al=!1}Ll(){return this.Sl[Math.floor(Math.random()*this.Sl.length)]}u(){let t=0,s=0;for(const i of this.Sl)t+=i.x,s+=i.y;t/=this.Sl.length,s/=this.Sl.length;const i=i=>Math.max(Math.abs(t-i.x),Math.abs(s-i.y));let h=this.Sl[0],e=i(h);for(const t of this.Sl){const s=i(t);s<e&&(h=t,e=s)}return h}static ki(t,s){return t.Sl.length-s.Sl.length}}class Gs{constructor(t,s,i,h,e){this.Pl=t,this.Rl=s,this.Cl=i,this.$l=h,this.type=e}}class Fs{constructor(t,s,i,h,e,n,r){this.Os=t,this.zl=s,this.Bl=s.Bl,this.location=i,this.direction=h,this.Hl=e,this.Ul=n,this.Gl=r}Fl(){if(0===this.direction.x)return new Rs(this.direction.y,0);if(0===this.direction.y)return new Rs(0,-this.direction.x);throw"illegal direction"}valid(t){return t.x>=0&&t.y>=0&&t.x<this.Bl.width&&t.y<this.Bl.height}Wl(t){return 0===t.x&&(-1===t.y||1===t.y)||0===t.y&&(-1===t.x||1===t.x)}jl(t,s,i,h){let e;if(0===s.x)e=new Rs(s.y,0);else{if(0!==s.y)throw"invalid heading";e=new Rs(0,-s.x)}const n=this.Kl(i,h,t,e,s);return n>0&&(i=this.Vl(i,n,t,e,s),h=this.Xl(h,n,t,e,s)),[n,i,h]}Kl(t,s,i,h,e){let n=0;for(;;){n++;for(let r=-t;r<=s;r++){const t=i.Tl(h.multiply(r)).Tl(e.multiply(n));if(!this.valid(t))return Math.max(0,n-1);if(this.ql(this.zl.Jl(t)))return Math.max(0,n-1)}}}Vl(t,s,i,h,e){for(;;){t++;for(let n=1;n<=s;n++){const s=i.El(h.multiply(t)).Tl(e.multiply(n));if(!this.valid(s))return t-1;if(this.ql(this.zl.Jl(s)))return t-1}}}Xl(t,s,i,h,e){for(;;){t++;for(let n=1;n<=s;n++){const s=i.Tl(h.multiply(t)).Tl(e.multiply(n));if(!this.valid(s))return t-1;if(this.ql(this.zl.Jl(s)))return t-1}}}ql(t){return t!==$s.CLOSED&&t!==$s.NON_JOIN_CLOSED}contains(t,...s){for(const i of s)if(t===i)return!0;return!1}}class Ws extends Fs{constructor(t,s,i,h,e,n,r,o,l){super(t,s,i,h,e,n,r),this.Yl=o,this.Ql=l}Zl(){if(!this.zl.ta(this.Ql))return!1;if(this.Gl!==this.zl.sa)return!0;if(this.Hl++,this.Hl>=this.Ul)return!1;if(this.Hl<0)return!0;const t=this.Fl();let s=this.Yl;const i=this.ia(this.Ql),h=this.ha(this.Ql);let e,n,r;do{[r,e,n]=this.jl(this.location,this.direction,s+1,s+1);let o=r-2,l=e+n-1;if(o<2)break;if(l/o<this.Bl.ea&&(o=Math.floor(l/this.Bl.ea),this.Bl.ea),o/l<this.Bl.ea&&(l=Math.floor(o/this.Bl.ea),this.Bl.ea),l/o<this.Bl.ea)return!1;for(;o*l>h;)o>l?o--:l>o?l--:this.Os.range(0,100)<50?o--:l--;if(o*l>=i){const s=new Us;return e<=n?(2*e-1>l?this.na(s,t,o,(l>>1)-l+1,l>>2):this.na(s,t,o,1-e,-e+l),0===this.direction.x?this.zl.ra(this.location.Tl(this.direction),$s.V_DOOR):this.zl.ra(this.location.Tl(this.direction),$s.H_DOOR)):(2*n-1>l?this.na(s,t,o,-(l>>1),-(l>>1)+l-1):this.na(s,t,o,n-l,n-1),0===this.direction.x?this.zl.ra(this.location.Tl(this.direction),$s.V_DOOR):this.zl.ra(this.location.Tl(this.direction),$s.H_DOOR)),this.zl.oa(this.Ql),s.Al=!0,this.zl.la(s),!1}s++}while(r-2>=(2*s+1)*this.Bl.ea);return!1}na(t,s,i,h,e){for(let n=1;n<=i;n++)for(let i=h;i<=e;i++){const h=this.location.Tl(this.direction.multiply(n+1)).Tl(s.multiply(i));this.zl.ra(h,$s.INSIDE_ROOM_OPEN),t.Sl.push(h)}}ia(t){switch(t){case zs.SMALL:return this.Bl.aa;case zs.MEDIUM:return this.Bl.ca;case zs.LARGE:return this.Bl.ua}}ha(t){switch(t){case zs.SMALL:return this.Bl.ca-1;case zs.MEDIUM:return this.Bl.ua-1;case zs.LARGE:return this.Bl.fa-1}}}class js extends Fs{constructor(t,s,i,h,e,n,r,o,l,a,c,u,f,d,w,p){super(t,s,i,h,e,n,r),this.da=o,this.wa=l,this.pa=a,this.ga=c,this.ya=u,this.ma=f,this.ba=d,this.va=w,this.xa=p}ql(t){if(this.Bl._a&&this.Bl.Ma){if(!this.contains(t,$s.OPEN,$s.NON_JOIN_OPEN,$s.GUARANTEED_OPEN,$s.INSIDE_TUNNEL_OPEN,$s.INSIDE_ANTEROOM_OPEN,$s.NON_JOIN_GUARANTEED_OPEN))return!0}else if(this.Bl._a){if(!this.contains(t,$s.OPEN,$s.NON_JOIN_OPEN,$s.GUARANTEED_OPEN,$s.INSIDE_TUNNEL_OPEN,$s.NON_JOIN_GUARANTEED_OPEN))return!0}else if(!this.contains(t,$s.OPEN,$s.NON_JOIN_OPEN,$s.GUARANTEED_OPEN,$s.NON_JOIN_GUARANTEED_OPEN))return!0;return!1}Zl(){if(this.Gl!==this.zl.sa)return!0;if(this.Hl++,this.Hl>=this.Ul)return!1;if(this.Hl<0)return!0;const[t,s,i]=this.jl(this.location,this.direction,this.ga,this.ga),h=this.Fl(),e=h.negative;let n=h;if(0===this.pa&&t<this.Bl.ka&&this.join(t))return!1;let r=this.wa;if(t>this.ga){t-this.ga<this.wa&&(r=t-this.ga);for(let t=1;t<=r;t++)n=this.location.Tl(this.direction.multiply(t)),1===this.pa?this.zl.ra(n,$s.CLOSED):this.zl.ra(n,$s.NON_JOIN_CLOSED);this.location=n;const o=this.Os.range(0,100);let l=this.Gl+1,a=0;for(let t=0;t<=10;t++)if(a+=this.Ia(t),o<a){l=this.Gl+t;break}const c={Oa:this.zl.Na(this.ya),Ta:this.zl.Na(this.ma),Ea:this.zl.Na(this.ba),Da:this.zl.Na(this.va),Sa:this.zl.Na(this.xa)};if(this.Os.range(0,100)<this.xa){const t=this.direction;if(0===this.da.x&&0===this.da.y||this.da.x===this.direction.x&&this.da.y===this.direction.y){const t=this.Os.range(0,4);0===t?this.direction=h:1===t?this.direction=e:i>s||i===s&&this.Os.St()?this.direction=h:this.direction=e}else 0===this.da.x||0===this.da.y?this.direction=this.da:this.direction=this.da.El(this.direction);this.Os.range(0,100)<this.va?(this.Aa(this.direction.negative,this.direction.negative,l,c),this.Aa(t,t,l,c)):this.Os.range(0,100)<this.ba&&this.Aa(this.direction.negative,this.direction.negative,l,c)}else this.Os.range(0,100)<this.ma?(this.Aa(h,h,l,c),this.Aa(e,e,l,c)):this.Os.range(0,100)<this.ya&&(n=s>i||s===i&&this.Os.St()?e:h,0===this.Os.range(0,3)&&(n=n.negative),this.Aa(n,n,l,c))}else if(this.direction.vi(this.da)||this.da.Dl(0,0)){const[t]=this.jl(this.location,h,this.ga,this.ga),[s]=this.jl(this.location,e,this.ga,this.ga);if(t<=this.ga&&s<=this.ga)return!1;t>2*this.ga+1&&s>2*this.ga+1?this.Os.St()?this.direction=h:this.direction=e:t>s?this.direction=h:s>t?this.direction=e:this.Os.St()?this.direction=h:this.direction=e}else if(0===this.da.x||0===this.da.y){const[t]=this.jl(this.location,this.da,this.ga,this.ga);if(!(t>this.ga))return!1;this.direction=this.da}else{n=this.da.El(this.direction);const[t]=this.jl(this.location,n,this.ga,this.ga);if(!(t>this.ga))return!1;this.direction=n}return!0}Aa(t,s,i,h){this.Os.range(0,100)<this.Bl.La&&(s=Rs.ZERO),this.zl.Pa(this.location,t,0,this.zl.Ra(i),i,s,this.zl.Ca(i),1,this.zl.$a(i),h.Oa,h.Ta,h.Ea,h.Da,h.Sa)}join(t){const s=this.Fl();let i=this.location.Tl(this.direction.multiply(t+1));if(!this.valid(i))return!1;let h=this.zl.Jl(i);if(this.contains(h,$s.CLOSED,$s.GUARANTEED_CLOSED)){for(let s=1;s<=t;s++){const t=this.location.Tl(this.direction.multiply(s));if(!this.valid(t))return!1;this.zl.ra(t,$s.NON_JOIN_CLOSED)}return!0}if(this.contains(h,$s.NON_JOIN_CLOSED,$s.NON_JOIN_GUARANTEED_CLOSED))return!1;let e=new Rs,n=0;for(let i=1;i<=this.ga;i++){let r=this.location.Tl(s.multiply(i)).Tl(this.direction.multiply(t+1));if(!this.valid(r))return!1;if(h=this.zl.Jl(r),this.contains(h,$s.CLOSED,$s.GUARANTEED_CLOSED,$s.NON_JOIN_CLOSED,$s.NON_JOIN_GUARANTEED_CLOSED)){e=r,n=i;break}if(r=this.location.El(s.multiply(i).Tl(this.direction.multiply(t+1))),!this.valid(r))return!1;if(h=this.zl.Jl(r),this.contains(h,$s.CLOSED,$s.GUARANTEED_CLOSED,$s.NON_JOIN_CLOSED,$s.NON_JOIN_GUARANTEED_CLOSED)){e=r,n=-i;break}}if(0!==e.x||0!==e.y)return!1;if(0!==n)return!1;if(this.contains(h,$s.NON_JOIN_CLOSED,$s.NON_JOIN_GUARANTEED_CLOSED))return!1;i=n<0?s:s.negative;const[r]=this.jl(e,i,1,1);let o,l;if(n>0?(o=n,l=1):(o=-n,l=-1),r<o+1)return!1;for(let s=1;s<=t+1;s++){const t=this.location.Tl(this.direction.multiply(s));if(!this.valid(t))return!1;this.zl.ra(t,$s.NON_JOIN_CLOSED)}for(let i=1;i<o;i++){const h=this.location.Tl(s.multiply(i*l)).Tl(this.direction.multiply(t+1));if(!this.valid(h))return!1;this.zl.ra(h,$s.NON_JOIN_CLOSED)}return!0}Ia(t){return 0<=t&&t<=10?this.Bl.za[t]:0}}class Ks extends Fs{constructor(t,s,i,h,e,n,r,o,l,a,c,u,f,d,w,p){super(t,s,i,h,e,n,r),this.da=o,this.wa=l,this.Ba=a,this.ma=c,this.va=u,this.xa=f,this.Ha=d,this.Ua=w,this.Ga=p}Zl(){const t=this.zl;if(this.Gl!==t.sa)return!0;if(this.Hl++,this.Hl>=this.Ul)return!1;if(this.Hl<0)return!0;const[s,i,h]=this.jl(this.location,this.direction,this.Ba+1,this.Ba+1);if(0===s)return!1;const[e,n]=this.Fa(),r=this.Fl(),o=r.negative,l=this.Wa();if(s<2*this.wa||this.Ul-1===this.Hl)return this.ja(n,s,i,h,r,o);if(this.Ka(this.wa,this.Ba),this.Os.range(0,100)<this.Ha){const t=this.location.Tl(this.direction.multiply(this.wa>>2)).Tl(r.multiply(this.Ba));this.Va(t,r,-1,2,l,e,!1)}if(this.Os.range(0,100)<this.Ua){const t=this.location.Tl(this.direction.multiply(this.wa>>2)).Tl(o.multiply(this.Ba));this.Va(t,o,-1,2,l,e,!1)}this.location=this.location.Tl(this.direction.multiply(this.wa));const a=this.Xa(r,this.Ba+2,this.Ba+2,2*this.Ba+5),c=this.Xa(r,this.Ba+3,this.Ba+3,2*this.Ba+7);let u=!1,f=!1;const d=this.Os.range(0,100),w=this.qa(this.Gl),p=w+this.Ja(this.Gl);if(d<w?u=!0:d<p&&(f=!0),u&&!c)return!0;const g=this.Ya(),y=this.Qa(g);if(!g&&!y)return!0;const m=this.Za(y),b=this.Os.range(0,100);let v=this.Gl+1;if(y)if(u)v=this.Gl+this.Bl.tc;else{let t=0;for(let s=0;s<=10;s++)if(t+=this.sc(s),b<t){v=this.Gl+s;break}}const x=this.ic(),_=this.hc(u,y,a,r,o);if(!0===_)return!0;const[M,k,I,O]=_;let N=!1,T=!1;const E=this.direction;let D=!1;if(g){const[t]=this.jl(k,r,this.Ba+1,this.Ba+1),[s]=this.jl(I,o,this.Ba+1,this.Ba+1);if(this.da.Dl(0,0)||this.da.vi(this.direction)?u&&y?t<s||t===s&&this.Os.St()?t>0&&(this.location=k,this.direction=r,N=!0):s>0&&(this.location=I,this.direction=o,T=!0):t>s||t===s&&this.Os.St()?t>0&&(this.location=k,this.direction=r,N=!0):s>0&&(this.location=I,this.direction=o,T=!0):0===this.da.x||0===this.da.y?(this.direction=this.da,this.direction.vi(r)?t>0&&(N=!0,this.location=k):s>0&&(this.location=I,T=!0)):(this.direction=this.da.El(this.direction),this.direction.vi(r)?t>0&&(N=!0,this.location=k):s>0&&(this.location=I,T=!0)),y){let t=Rs.ZERO,s=Rs.ZERO;if(T?(t=k,s=r):N?(t=I,s=o):D=!0,!D){const i=this.Os.range(0,100);m&&i<50?this.Va(t,s,0,2,l,n,O):this.ec(u,f,t,s,v,s,x),m&&i>=50?this.Va(M,E,0,2,l,n,O):this.ec(u,f,M,E,v,E,x)}}}else D=!0;if(D){this.location=M;const t=this.Os.range(0,100);m&&t<50?this.Va(k,r,0,2,l,n,O):this.ec(u,f,k,r,v,r,x),m&&t>=50?this.Va(k,o,0,2,l,n,O):this.ec(u,f,I,o,v,o,x)}return!0}Xa(t,s,i,h){const e=this.zl;let n=!1;e.ra(this.location,$s.CLOSED);for(let s=1;s<=this.Ba;s++)e.ra(this.location.Tl(t.multiply(s)),$s.CLOSED),e.ra(this.location.El(t.multiply(s)),$s.CLOSED);const[r]=this.jl(this.location.El(this.direction),this.direction,s,i);r>=h&&(n=!0),e.ra(this.location,$s.INSIDE_TUNNEL_OPEN);for(let s=1;s<=this.Ba;s++)e.ra(this.location.Tl(t.multiply(s)),$s.INSIDE_TUNNEL_OPEN),e.ra(this.location.El(t.multiply(s)),$s.INSIDE_TUNNEL_OPEN);return n}hc(t,s,i,h,e){const n=this.zl;if(t){if(this.Os.range(0,100)<this.nc(this.Ba)||s){this.rc(2*this.Ba+5,this.Ba+2);return[this.location.Tl(this.direction.multiply(2*this.Ba+5)),this.location.Tl(this.direction.multiply(this.Ba+3)).Tl(h.multiply(this.Ba+2)),this.location.Tl(this.direction.multiply(this.Ba+3)).Tl(e.multiply(this.Ba+2)),!0]}}else if(this.Os.range(0,100)<this.nc(this.Ba)&&i){this.rc(2*this.Ba+3,this.Ba+1);return[this.location.Tl(this.direction.multiply(2*this.Ba+3)),this.location.Tl(this.direction.multiply(this.Ba+2)).Tl(h.multiply(this.Ba+1)),this.location.Tl(this.direction.multiply(this.Ba+2)).Tl(e.multiply(this.Ba+1)),!0]}const r=this.location,o=this.location.El(this.direction.multiply(this.Ba)).Tl(h.multiply(this.Ba)),l=this.location.El(this.direction.multiply(this.Ba)).Tl(e.multiply(this.Ba));return this.zl.Jl(o)!==$s.INSIDE_TUNNEL_OPEN||n.Jl(l)!==$s.INSIDE_TUNNEL_OPEN||[r,o,l,!1]}ja(t,s,i,h,e,n){const r=this.zl;let o=!1,l=!1,a=!1,c=0;for(let t=-this.Ba;t<=this.Ba;t++){const i=this.location.Tl(this.direction.multiply(s+1)).Tl(e.multiply(t)),h=r.Jl(i);this.contains(h,$s.OPEN,$s.GUARANTEED_OPEN,$s.INSIDE_TUNNEL_OPEN,$s.INSIDE_ANTEROOM_OPEN)?(l=!0,c++):this.contains(h,$s.GUARANTEED_CLOSED,$s.NON_JOIN_GUARANTEED_CLOSED)?(o=!0,c=0):h===$s.INSIDE_ROOM_OPEN?(a=!0,c=0):c=0}if(this.Os.range(0,100)<=this.Ga&&(this.Hl<this.Ul-1||s<=this.Bl.oc)||s<5){const t=this.lc(c,s,i,h,l,a,o,e);if(null!=t)return t}r.ta(t)&&this.Va(this.location,this.direction,0,2,this.Gl,t,!1);const u=10*this.Os.range(0,11);if(100!==this.Ga||this.Ua!==this.Bl.cc.ac||this.Ha!==this.Bl.cc.uc||this.xa!==this.Bl.cc.Sa||this.ma!==this.Bl.cc.Ta||this.va!==this.Bl.cc.Da||0!==this.Ba){const[t]=this.jl(this.location.Tl(e.multiply(this.Ba)),e,this.Ba+1,this.Ba+1),[i]=this.jl(this.location.El(e.multiply(this.Ba)),n,this.Ba+1,this.Ba+1),[h]=this.jl(this.location,this.direction.negative,this.Ba+1,this.Ba+1),r=(t,s,i,h)=>{this.zl.fc(t,s,0,this.Ul,i,h,3,0,this.Bl.cc.Ta,this.Bl.cc.Da,this.Bl.cc.Sa,this.Bl.cc.uc,this.Bl.cc.ac,u)};0===this.Ba?this.Ua===this.Bl.cc.ac&&this.Ha===this.Bl.cc.uc&&this.xa===this.Bl.cc.Sa&&this.ma===this.Bl.cc.Ta&&this.va===this.Bl.cc.Da?s>=t&&s>=i&&s>=h?r(this.location,this.direction,this.Gl+1,this.direction):h>=t&&h>=i?r(this.location,this.direction.negative,this.Gl+this.Bl.dc,this.direction.negative):t>=i||t===i&&this.Os.range(0,100)<50?r(this.location,e,this.Gl+this.Bl.dc,e):r(this.location,n,this.Gl+this.Bl.dc,n):r(this.location,this.direction,this.Gl+this.Bl.dc,this.direction):o?(r(this.location.Tl(e.multiply(this.Ba)),e,this.Gl+this.Bl.dc,e),r(this.location.El(e.multiply(this.Ba)),n,this.Gl+this.Bl.dc,n)):t>=i||t===i&&this.Os.range(0,100)<50?(r(this.location.Tl(e.multiply(this.Ba)),e,this.Gl+this.Bl.dc,e),r(this.location.El(e.multiply(this.Ba)),this.direction,this.Gl+this.Bl.dc,this.direction)):(r(this.location.Tl(e.multiply(this.Ba)),this.direction,this.Gl+this.Bl.dc,this.direction),r(this.location.El(e.multiply(this.Ba)),this.direction,this.Gl+this.Bl.dc,this.direction))}return!1}lc(t,s,i,h,e,n,r,o){const l=this.zl;if(2*this.Ba+1===t)return this.Ka(s,this.Ba),!1;if(e)return this.wc(s,l,o);if(n&&0===this.Ba&&s>1){const t=this.location.Tl(this.direction.multiply(s+1));l.Jl(t);return this.Ka(s-1,0),0===this.direction.x?l.ra(this.location.Tl(this.direction.multiply(s)),$s.V_DOOR):l.ra(this.location.Tl(this.direction.multiply(s)),$s.H_DOOR),!1}if(r&&0===this.Ba){if(100!==this.Ga||20!==this.Ua||20!==this.Ha||30!==this.xa||0!==this.ma||0!==this.va||0!==this.Ba){const t=10*this.Os.range(0,11),s=i>=h?o.negative:o;l.fc(this.location,s,0,this.Ul,this.Gl+1,s,3,0,0,0,30,20,20,t)}return!1}if(!e&&!r){if(this.pc(s,o)){this.Ka(s,this.Ba);for(let t=-this.Ba;t<=this.Ba;t++)l.ra(this.location.Tl(this.direction.multiply(s+1)).Tl(o.multiply(t)),$s.INSIDE_TUNNEL_OPEN);let t=s+2,i=!0,h=!0;for(;i&&h;){for(let s=-this.Ba;s<=this.Ba;s++){const h=this.location.Tl(this.direction.multiply(t)).Tl(o.multiply(s));if(l.Jl(h)!==$s.CLOSED){i=!1;break}}let s=this.location.Tl(this.direction.multiply(t)).Tl(o.multiply(this.Ba+1)),e=this.location.Tl(this.direction.multiply(t)).El(o.multiply(this.Ba+1)),n=l.Jl(s),r=l.Jl(e);if(!this.contains(n,$s.OPEN,$s.GUARANTEED_OPEN,$s.INSIDE_TUNNEL_OPEN,$s.INSIDE_ANTEROOM_OPEN)&&!this.contains(r,$s.OPEN,$s.GUARANTEED_OPEN,$s.INSIDE_TUNNEL_OPEN,$s.INSIDE_ANTEROOM_OPEN)){i=!1;break}if(n===$s.INSIDE_ROOM_OPEN||r===$s.INSIDE_ROOM_OPEN){i=!1;break}for(let s=-this.Ba;s<=this.Ba;s++){const i=this.location.Tl(this.direction.multiply(t+1)).Tl(o.multiply(s));l.Jl(i)!==$s.CLOSED&&(h=!1)}s=this.location.Tl(this.direction.multiply(t+1)).Tl(o.multiply(this.Ba+1)),e=this.location.Tl(this.direction.multiply(t+1)).El(o.multiply(this.Ba+1)),n=l.Jl(s),r=l.Jl(e),this.contains(n,$s.OPEN,$s.GUARANTEED_OPEN,$s.INSIDE_TUNNEL_OPEN,$s.INSIDE_ANTEROOM_OPEN,$s.CLOSED)||this.contains(r,$s.OPEN,$s.GUARANTEED_OPEN,$s.INSIDE_TUNNEL_OPEN,$s.INSIDE_ANTEROOM_OPEN,$s.CLOSED)||(h=!1),n!==$s.INSIDE_ROOM_OPEN&&r!==$s.INSIDE_ROOM_OPEN||(h=!1);let a=!0;for(let s=-this.Ba-1;s<=this.Ba+1;s++){const i=this.location.Tl(this.direction.multiply(t+1)).Tl(o.multiply(s)),h=l.Jl(i);h!==$s.INSIDE_TUNNEL_OPEN&&h!==$s.INSIDE_ANTEROOM_OPEN&&(a=!1)}if(a&&(h=!0),i&&h)for(let s=-this.Ba;s<=this.Ba;s++)l.ra(this.location.Tl(this.direction.multiply(t)).Tl(o.multiply(s)),$s.INSIDE_TUNNEL_OPEN);t++}return!1}if(0===this.Ba&&l.Jl(this.location.Tl(this.direction.multiply(s+1)))===$s.CLOSED){if(l.Jl(this.location.Tl(this.direction.multiply(s+1)).Tl(o))===$s.INSIDE_ROOM_OPEN)return this.direction=o.negative,this.direction.vi(this.da.negative)&&(this.direction=this.da),!0;if(l.Jl(this.location.Tl(this.direction.multiply(s+1)).El(o))===$s.INSIDE_ROOM_OPEN)return this.direction=o,this.direction.vi(this.da.negative)&&(this.direction=this.da),!0}}return null}pc(t,s){const i=this.zl;let h=!0;for(let e=-this.Ba;e<=this.Ba;e++){const n=this.location.Tl(this.direction.multiply(t+1)).Tl(s.multiply(e));if(i.Jl(n)!==$s.CLOSED){h=!1;break}}const e=this.location.Tl(this.direction.multiply(t+1)).Tl(s.multiply(this.Ba+1)),n=this.location.Tl(this.direction.multiply(t+1)).El(s.multiply(this.Ba+1)),r=i.Jl(e),o=i.Jl(n);this.contains(r,$s.OPEN,$s.GUARANTEED_OPEN,$s.INSIDE_TUNNEL_OPEN,$s.INSIDE_ANTEROOM_OPEN)||this.contains(o,$s.OPEN,$s.GUARANTEED_OPEN,$s.INSIDE_TUNNEL_OPEN,$s.INSIDE_ANTEROOM_OPEN)||(h=!1),r!==$s.INSIDE_ROOM_OPEN&&o!==$s.INSIDE_ROOM_OPEN||(h=!1);for(let e=-this.Ba-1;e<=this.Ba+1;e++){const n=this.location.Tl(this.direction.multiply(t+2)).Tl(s.multiply(e));if(i.Jl(n)===$s.INSIDE_ROOM_OPEN){h=!1;break}}return h}ec(t,s,i,h,e,n,r){let o=this.Ba,l=this.wa;t?(o++,l+=2):s&&(o--,o<0&&(o=0),l-=2,l<3&&(l=3)),this.zl.fc(i,h,0,this.gc(e),e,n,l,o,r.Ta,r.Da,r.Sa,r.uc,r.ac,r.yc)}Va(t,s,i,h,e,n,r){const o=Math.max(1,2*this.Ba);r&&(e=this.Gl+Math.floor((e-this.Gl)/this.Bl.mc)),this.zl.bc(t,s,i,h,e,o,n)}wc(t,s,i){const h=this.location.Tl(this.direction.multiply(t+1)),e=s.Jl(h);if(this.contains(e,$s.OPEN,$s.GUARANTEED_OPEN,$s.INSIDE_TUNNEL_OPEN,$s.INSIDE_ANTEROOM_OPEN))return this.Ka(t,0),!1;let n=0;for(let h=1;h<=this.Ba;h++){const e=this.location.Tl(this.direction.multiply(t+1)).Tl(i.multiply(h)),r=s.Jl(e);if(this.contains(r,$s.OPEN,$s.GUARANTEED_OPEN,$s.INSIDE_TUNNEL_OPEN,$s.INSIDE_ANTEROOM_OPEN)){n=h;break}const o=this.location.Tl(this.direction.multiply(t+1)).El(i.multiply(h)),l=s.Jl(o);if(this.contains(l,$s.OPEN,$s.GUARANTEED_OPEN,$s.INSIDE_TUNNEL_OPEN,$s.INSIDE_ANTEROOM_OPEN)){n=-h;break}}for(let h=1;h<=t;h++){const t=this.location.Tl(this.direction.multiply(h)).Tl(i.multiply(n));s.ra(t,$s.INSIDE_TUNNEL_OPEN)}return!1}Wa(){const t=this.Os.range(0,100);let s=this.Gl,i=0;for(let h=0;h<=10;h++)if(i+=this.vc(h),t<i){s=this.Gl+h;break}return s}Fa(){let t,s;const i=this.xc(this.Ba,zs.MEDIUM),h=this.xc(this.Ba,zs.SMALL),e=this._c(this.Ba,zs.MEDIUM),n=this._c(this.Ba,zs.SMALL),r=this.Os.range(0,100);return t=r<h?zs.SMALL:r<h+i?zs.MEDIUM:zs.LARGE,s=r<n?zs.SMALL:r<n+e?zs.MEDIUM:zs.LARGE,[t,s]}Ya(){return this.Os.range(0,100)<this.xa}Qa(t){return!!(t&&this.Os.range(0,100)<this.va)||!t&&this.Os.range(0,100)<this.ma}Za(t){return t&&this.Os.range(0,100)>this.Bl.Mc}rc(t,s){if(t<3||s<1)return!1;const[i]=this.jl(this.location,this.direction,s+1,s+1);if(i<=t)return!1;const h=this.Fl();for(let i=1;i<=t;i++)for(let t=-s;t<=s;t++){const s=this.location.Tl(this.direction.multiply(i)).Tl(h.multiply(t));this.zl.ra(s,$s.INSIDE_ANTEROOM_OPEN)}if(s>=3&&t>=7&&this.Bl.kc){const t=2;this.Ic(s,t,h)}return!0}Ka(t,s){if(t<1||s<0)return!1;const[i]=this.jl(this.location,this.direction,s+1,s+1);if(i<t)return!1;const h=this.Fl();for(let i=1;i<=t;i++)for(let t=-s;t<=s;t++){const s=this.location.Tl(this.direction.multiply(i)).Tl(h.multiply(t));this.zl.ra(s,$s.INSIDE_TUNNEL_OPEN)}if(s>=3&&t>=7&&this.Bl.kc){const i=Math.floor((t-1)/6);for(let t=0;t<i;t++){const i=2+3*t;this.Ic(s,i,h)}}return!0}Ic(t,s,i){let h=1-t,e=this.location.Tl(this.direction.multiply(s)).Tl(i.multiply(h));this.zl.ra(e,$s.COLUMN),h=t-1,e=this.location.Tl(this.direction.multiply(s)).Tl(i.multiply(h)),this.zl.ra(e,$s.COLUMN),s-=1,h=1-t,e=this.location.Tl(this.direction.multiply(s)).Tl(i.multiply(h)),this.zl.ra(e,$s.COLUMN),h=t-1,e=this.location.Tl(this.direction.multiply(s)).Tl(i.multiply(h)),this.zl.ra(e,$s.COLUMN)}vc(t){return 0<=t&&t<=10?this.Bl.Oc[t]:0}sc(t){return 0<=t&&t<=10?this.Bl.Nc[t]:0}nc(t){return t>=this.Bl.Tc.length?100:this.Bl.Tc[t]}qa(t){return t>=this.Bl.Ec.length?this.Bl.Ec[this.Bl.Ec.length-1]:this.Bl.Ec[t]}Ja(t){return t>=this.Bl.Dc.length?this.Bl.Dc[this.Bl.Dc.length-1]:this.Bl.Dc[t]}gc(t){return t>=this.Bl.Sc.length?this.Bl.Sc[this.Bl.Sc.length-1]:this.Bl.Sc[t]}xc(t,s){if(t>=this.Bl.Ac.length)return zs.LARGE===s?100:0;switch(s){case zs.LARGE:return this.Bl.Ac[t][2];case zs.MEDIUM:return this.Bl.Ac[t][1];case zs.SMALL:return this.Bl.Ac[t][0]}}_c(t,s){if(t>=this.Bl.Lc.length)return zs.LARGE===s?100:0;switch(s){case zs.LARGE:return this.Bl.Lc[t][2];case zs.MEDIUM:return this.Bl.Lc[t][1];case zs.SMALL:return this.Bl.Lc[t][0]}}ic(){return{Ta:this.zl.Na(this.ma),Da:this.zl.Na(this.va),Sa:this.zl.Na(this.xa),uc:this.zl.Na(this.Ha),ac:this.zl.Na(this.Ua),yc:this.zl.Na(this.Ga)}}}class Vs{constructor(t,s){this.Pc=[],this.Rc=[],this.Cc=[],this.sa=0,this.$c=0,this.zc=0,this.Bc=0,this.Hc=0,this.Uc=0,this.Gc=0,this.Os=s,this.Bl=t,this.Hh=[];for(let t=0;t<this.Bl.width*this.Bl.height;t++)this.Hh[t]=this.Bl.background,this.Rc[t]=!1;for(let t=0;t<4;t++)this.Cc[t]=null;this.Fc(0,0,this.Bl.width-1,0,$s.GUARANTEED_CLOSED),this.Fc(0,0,0,this.Bl.height-1,$s.GUARANTEED_CLOSED),this.Fc(this.Bl.width-1,0,this.Bl.width-1,this.Bl.height-1,$s.GUARANTEED_CLOSED),this.Fc(0,this.Bl.height-1,this.Bl.width-1,this.Bl.height-1,$s.GUARANTEED_CLOSED);for(const t of this.Bl.Wc)this.jc(t);for(const t of this.Bl.Kc)switch(t){case Cs.NORTH:this.Fc(0,Math.floor(this.Bl.height/2)-1,2,Math.floor(this.Bl.height/2)+1,$s.GUARANTEED_OPEN);break;case Cs.WEST:this.Fc(Math.floor(this.Bl.width/2)-1,0,Math.floor(this.Bl.width/2)+1,2,$s.GUARANTEED_OPEN);break;case Cs.EAST:this.Fc(Math.floor(this.Bl.width/2)-1,this.Bl.height-3,Math.floor(this.Bl.width/2)+1,this.Bl.height-1,$s.GUARANTEED_OPEN);break;case Cs.SOUTH:this.Fc(this.Bl.width-3,Math.floor(this.Bl.height/2)-1,this.Bl.width-1,Math.floor(this.Bl.height/2)+1,$s.GUARANTEED_OPEN);break;case Cs.NORTH_WEST:this.Fc(0,0,2,2,$s.GUARANTEED_OPEN);break;case Cs.NORTH_EAST:this.Fc(0,this.Bl.height-3,2,this.Bl.height-1,$s.GUARANTEED_OPEN);break;case Cs.SOUTH_WEST:this.Fc(this.Bl.width-3,0,this.Bl.width-1,2,$s.GUARANTEED_OPEN);break;case Cs.SOUTH_EAST:this.Fc(this.Bl.width-3,this.Bl.height-3,this.Bl.width-1,this.Bl.height-1,$s.GUARANTEED_OPEN)}const i=(s,i,h)=>{this.Pa(s,i,0,this.Ra(h),h,i,this.Ca(h),1,this.$a(h),this.Vc(t.Xc.Oa),this.Vc(t.Xc.Ta),this.Vc(t.Xc.Ea),this.Vc(t.Xc.Da),this.Vc(t.Xc.Sa))};for(let s=0;s<t.Xc.qc.length;s++){const h=t.Xc.qc[s];if(h>0){let t=Math.floor(this.Bl.height*h/1e3);0===t&&this.Os.range(0,1e3)<this.Bl.height*h&&(t=1);let e=0;for(let h=0;h<t;h++)e=2+this.Os.range(0,this.Bl.height-4),i(new Rs(0,e),Rs.SOUTH,s),e=2+this.Os.range(0,this.Bl.height-4),i(new Rs(this.Bl.width-1,e),Rs.NORTH,s);let n=Math.floor(this.Bl.width*h/1e3);0===n&&this.Os.range(0,1e3)<this.Bl.width*h&&(n=1);let r=0;for(let t=0;t<n;t++)r=2+this.Os.range(0,this.Bl.width-4),i(new Rs(r,0),Rs.EAST,s),r=2+this.Os.range(0,this.Bl.width-4),i(new Rs(r,this.Bl.height-1),Rs.EAST,s)}}for(const s of t.Jc)this.Pa(s.location,s.direction,-s.Hl,s.Ul,s.Gl,s.Yc,s.Qc,s.Zc,s.tu,s.Oa,s.Ta,s.Ea,s.Da,s.Sa);for(const[s,i]of t.su){let t=!0;this.Os.St()&&(t=!1),this.Pa(s.location,s.direction,-s.Hl,s.Ul,s.Gl,s.Yc,s.Qc,t?1:0,s.tu,s.Oa,s.Ta,s.Ea,s.Da,s.Sa),this.ra(s.location,$s.CLOSED),this.Pa(i.location,i.direction,-i.Hl,i.Ul,i.Gl,i.Yc,i.Qc,t?1:0,i.tu,i.Oa,i.Ta,i.Ea,i.Da,i.Sa),this.ra(i.location,$s.CLOSED)}for(const s of t.iu)this.fc(s.location,s.direction,-s.Hl,s.Ul,s.Gl,s.Yc,s.Qc,s.hu,s.Ta,s.Da,s.Sa,s.uc,s.ac,s.yc)}isOpen(t){const s=this.Jl(t);return s===$s.OPEN||s===$s.NON_JOIN_OPEN||s===$s.INSIDE_TUNNEL_OPEN||s===$s.INSIDE_ANTEROOM_OPEN||s===$s.GUARANTEED_OPEN||s===$s.NON_JOIN_GUARANTEED_OPEN}static eu(t,s){for(const i of s)if(t.x===i.x&&t.y===i.y)return!0;return!1}ra(t,s){const i=t.x,h=t.y;this.Hh[i*this.Bl.height+h]=s}Jl(t){const s=t.x,i=t.y;return this.Hh[s*this.Bl.height+i]}nu(t){switch(this.Jl(t)){case $s.OPEN:case $s.GUARANTEED_OPEN:case $s.NON_JOIN_OPEN:case $s.NON_JOIN_GUARANTEED_OPEN:case $s.INSIDE_ROOM_OPEN:case $s.INSIDE_TUNNEL_OPEN:case $s.INSIDE_ANTEROOM_OPEN:case $s.H_DOOR:case $s.V_DOOR:return!0;default:return!1}}ru(t=null){if(null===t)return this.ru(zs.SMALL)||this.ru(zs.MEDIUM)||this.ru(zs.LARGE);switch(t){case zs.SMALL:return this.Bl.ou>this.$c;case zs.MEDIUM:return this.Bl.lu>this.zc;case zs.LARGE:return this.Bl.au>this.Bc}}ta(t){if(null===t)return this.ta(zs.SMALL)||this.ta(zs.MEDIUM)||this.ta(zs.LARGE);switch(t){case zs.SMALL:return this.Bl.cu>this.Hc;case zs.MEDIUM:return this.Bl.uu>this.Uc;case zs.LARGE:return this.Bl.fu>this.Gc}}oa(t){zs.SMALL===t?this.Hc++:zs.MEDIUM===t?this.Uc++:zs.LARGE===t&&this.Gc++}Ca(t){return t>=this.Bl.du.length?this.Bl.du[this.Bl.du.length-1]:this.Bl.du[t]}$a(t){return t>=this.Bl.wu.length?this.Bl.wu[this.Bl.wu.length-1]:this.Bl.wu[t]}Ra(t){return t>=this.Bl.pu.length?this.Bl.pu[this.Bl.pu.length-1]:this.Bl.pu[t]}la(t){this.Pc.push(t)}get gu(){return[...this.Pc]}yu(t){return this.Rc[t.x*this.Bl.height+t.y]}static mu(t,s){for(let i=0;i<s.length;i++)if(t.x===s[i].x&&t.y===s[i].y)return!0;return!1}bu(t){this.Rc[t.x*this.Bl.height+t.y]=!0}jc(t){this.Fc(t.Pl,t.Rl,t.Cl,t.$l,t.type)}Fc(t,s,i,h,e){if(!(i<t||h<s))for(let n=t;n<=i;n++)for(let t=s;t<=h;t++)this.ra({x:n,y:t},e)}Pa(t,s,i,h,e,n,r,o,l,a,c,u,f,d){const w=new js(this.Os,this,Rs.from(t),Rs.from(s),i,h,e,Rs.from(n),r,o,l,a,c,u,f,d);for(let t=0;t<this.Cc.length;t++)if(null===this.Cc[t])return void(this.Cc[t]=w);this.Cc.push(w)}fc(t,s,i,h,e,n,r,o,l,a,c,u,f,d){const w=new Ks(this.Os,this,Rs.from(t),Rs.from(s),i,h,e,Rs.from(n),r,o,l,a,c,u,f,d);for(let t=0;t<this.Cc.length;t++)if(null===this.Cc[t])return void(this.Cc[t]=w);this.Cc.push(w)}bc(t,s,i,h,e,n,r){const o=new Ws(this.Os,this,Rs.from(t),Rs.from(s),i,h,e,n,r);for(let t=0;t<this.Cc.length;t++)if(null===this.Cc[t])return void(this.Cc[t]=o);this.Cc.push(o)}Na(t){const s=t-this.Bl.vu+this.Os.range(0,2*this.Bl.vu+1);return s<0?0:s}Vc(t){return t<=50?t<0?0:this.Os.range(0,2*t+1):t>100?100:2*t-100+this.Os.range(0,200-2*t+1)}xu(){let t=0,s=0;for(new js(this.Os,this,new Rs(2,2),Rs.SOUTH,0,1,0,Rs.SOUTH,1,0,1,0,0,0,0,0);t<this.Bl._u&&s<this.Bl.width*this.Bl.height;){s++;let i=1+this.Os.range(0,this.Bl.width-4),h=1+this.Os.range(0,this.Bl.height-4),e=new Rs(i,h);this.Os.range(0,100)<50?i=0:h=0,0===i?h=this.Os.range(0,100)<50?-1:1:i=this.Os.range(0,100)<50?-1:1;const n=new Rs(i,h);let r;if(0===n.x)r=new Rs(n.y,0);else{if(0!==n.y)throw"illegal direction";r=new Rs(0,-n.x)}let o=!0;for(;o&&(e=e.Tl(n),!(e.x<2||e.y<2||e.x>this.Bl.width-3||e.y>this.Bl.height-3));)this.Jl(e)===$s.INSIDE_TUNNEL_OPEN&&this.Jl(e.Tl(n))===$s.INSIDE_TUNNEL_OPEN&&this.Jl(e.El(n))===$s.INSIDE_TUNNEL_OPEN&&this.Jl(e.Tl(r))===$s.INSIDE_TUNNEL_OPEN&&this.Jl(e.El(r))===$s.INSIDE_TUNNEL_OPEN&&this.Jl(e.Tl(n).Tl(r))===$s.INSIDE_TUNNEL_OPEN&&this.Jl(e.El(n).Tl(r))===$s.INSIDE_TUNNEL_OPEN&&this.Jl(e.Tl(n).El(r))===$s.INSIDE_TUNNEL_OPEN&&this.Jl(e.El(n).El(r))===$s.INSIDE_TUNNEL_OPEN&&(this.ra(e,$s.CLOSED),this.Pa(e,n,0,this.Bl.Mu.Ul,this.sa+1,n,this.Bl.Mu.Qc,1,1,this.Bl.Mu.Oa,this.Bl.Mu.Ta,this.Bl.Mu.Ea,this.Bl.Mu.Da,this.Bl.Mu.Sa),this.Pa(e,r,0,this.Bl.Mu.Ul,this.sa+1,n,this.Bl.Mu.Qc,1,1,this.Bl.Mu.Oa,this.Bl.Mu.Ta,this.Bl.Mu.Ea,this.Bl.Mu.Da,this.Bl.Mu.Sa),this.Pa(e,r.negative,0,this.Bl.Mu.Ul,this.sa+1,n,this.Bl.Mu.Qc,1,1,this.Bl.Mu.Oa,this.Bl.Mu.Ta,this.Bl.Mu.Ea,this.Bl.Mu.Da,this.Bl.Mu.Sa),this.Os.range(0,100)<this.Bl.ku?this.Pa(e,n.negative,0,this.Bl.Mu.Ul,this.sa+1,n,this.Bl.Mu.Qc,0,1,this.Bl.Mu.Oa,this.Bl.Mu.Ta,this.Bl.Mu.Ea,this.Bl.Mu.Da,this.Bl.Mu.Sa):this.Pa(e,n.negative,0,this.Bl.Mu.Ul,this.sa+1,n,this.Bl.Mu.Qc,1,1,this.Bl.Mu.Oa,this.Bl.Mu.Ta,this.Bl.Mu.Ea,this.Bl.Mu.Da,this.Bl.Mu.Sa),o=!1,t++)}}Iu(){for(let t=0;t<this.Cc.length;t++)null!==this.Cc[t]&&(this.Cc[t].Zl()||(this.Cc[t]=null));return!1}Ou(){let t=!1,s=0;for(let i=0;i<this.Cc.length;i++)if(null!==this.Cc[i]&&(t=!0,this.Cc[i].Gl===this.sa)){const t=this.Cc[i].Hl;if(t>=0)return!0;(0===s||t>s)&&(s=t)}if(0===s)return this.sa++,t;for(let t=0;t<this.Cc.length;t++)null!==this.Cc[t]&&this.Cc[t].Gl===this.sa&&(this.Cc[t].Hl-=s);return t}Nu(t){if(this.Bl.width<10||this.Bl.height<10)return!1;if(t.Cl-t.Pl<=5)return!1;if(t.$l-t.Rl<=5)return!1;const s=t.Pl+1+this.Os.range(0,t.Cl-t.Pl-3),i=t.Rl+1+this.Os.range(0,t.$l-t.Rl-3),h=new Rs(s,i);if(!this.isOpen(h))return!1;if(this.yu(h))return!1;let e=this.Bl.fa;if(this.ru(zs.LARGE)||(e=this.Bl.ua),this.ru(zs.LARGE)||this.ru(zs.MEDIUM)||(e=this.Bl.ca),!this.ru())return!1;let n=!0;const r=[],o=[],l=[];let a;for(o.push(h);n;){n=!1;for(let t=0;t<o.length;){const s=o[t];if(a=0,!this.isOpen(s.Tl(Rs.NORTH))||Vs.mu(s.Tl(Rs.NORTH),r)||Vs.eu(s.Tl(Rs.NORTH),o)||Vs.eu(s.Tl(Rs.NORTH),l)||a++,!this.isOpen(s.Tl(Rs.SOUTH))||Vs.mu(s.Tl(Rs.SOUTH),r)||Vs.eu(s.Tl(Rs.SOUTH),o)||Vs.eu(s.Tl(Rs.SOUTH),l)||a++,!this.isOpen(s.Tl(Rs.EAST))||Vs.mu(s.Tl(Rs.EAST),r)||Vs.eu(s.Tl(Rs.EAST),o)||Vs.eu(s.Tl(Rs.EAST),l)||a++,!this.isOpen(s.Tl(Rs.WEST))||Vs.mu(s.Tl(Rs.WEST),r)||Vs.eu(s.Tl(Rs.WEST),o)||Vs.eu(s.Tl(Rs.WEST),l)||a++,!this.isOpen(s.Tl(Rs.NORTH_EAST))||Vs.mu(s.Tl(Rs.NORTH_EAST),r)||Vs.eu(s.Tl(Rs.NORTH_EAST),o)||Vs.eu(s.Tl(Rs.NORTH_EAST),l)||a++,!this.isOpen(s.Tl(Rs.NORTH_WEST))||Vs.mu(s.Tl(Rs.NORTH_WEST),r)||Vs.eu(s.Tl(Rs.NORTH_WEST),o)||Vs.eu(s.Tl(Rs.NORTH_WEST),l)||a++,!this.isOpen(s.Tl(Rs.SOUTH_EAST))||Vs.mu(s.Tl(Rs.SOUTH_EAST),r)||Vs.eu(s.Tl(Rs.SOUTH_EAST),o)||Vs.eu(s.Tl(Rs.SOUTH_EAST),l)||a++,!this.isOpen(s.Tl(Rs.SOUTH_WEST))||Vs.mu(s.Tl(Rs.SOUTH_WEST),r)||Vs.eu(s.Tl(Rs.SOUTH_WEST),o)||Vs.eu(s.Tl(Rs.SOUTH_WEST),l)||a++,a>2)n=!0,!this.isOpen(s.Tl(Rs.NORTH))||Vs.mu(s.Tl(Rs.NORTH),r)||Vs.eu(s.Tl(Rs.NORTH),o)||Vs.eu(s.Tl(Rs.NORTH),l)||l.push(s.Tl(Rs.NORTH)),!this.isOpen(s.Tl(Rs.SOUTH))||Vs.mu(s.Tl(Rs.SOUTH),r)||Vs.eu(s.Tl(Rs.SOUTH),o)||Vs.eu(s.Tl(Rs.SOUTH),l)||l.push(s.Tl(Rs.SOUTH)),!this.isOpen(s.Tl(Rs.EAST))||Vs.mu(s.Tl(Rs.EAST),r)||Vs.eu(s.Tl(Rs.EAST),o)||Vs.eu(s.Tl(Rs.EAST),l)||l.push(s.Tl(Rs.EAST)),!this.isOpen(s.Tl(Rs.WEST))||Vs.mu(s.Tl(Rs.WEST),r)||Vs.eu(s.Tl(Rs.WEST),o)||Vs.eu(s.Tl(Rs.WEST),l)||l.push(s.Tl(Rs.WEST)),!this.isOpen(s.Tl(Rs.NORTH_EAST))||Vs.mu(s.Tl(Rs.NORTH_EAST),r)||Vs.eu(s.Tl(Rs.NORTH_EAST),o)||Vs.eu(s.Tl(Rs.NORTH_EAST),l)||l.push(s.Tl(Rs.NORTH_EAST)),!this.isOpen(s.Tl(Rs.NORTH_WEST))||Vs.mu(s.Tl(Rs.NORTH_WEST),r)||Vs.eu(s.Tl(Rs.NORTH_WEST),o)||Vs.eu(s.Tl(Rs.NORTH_WEST),l)||l.push(s.Tl(Rs.NORTH_WEST)),!this.isOpen(s.Tl(Rs.SOUTH_EAST))||Vs.mu(s.Tl(Rs.SOUTH_EAST),r)||Vs.eu(s.Tl(Rs.SOUTH_EAST),o)||Vs.eu(s.Tl(Rs.SOUTH_EAST),l)||l.push(s.Tl(Rs.SOUTH_EAST)),!this.isOpen(s.Tl(Rs.SOUTH_WEST))||Vs.mu(s.Tl(Rs.SOUTH_WEST),r)||Vs.eu(s.Tl(Rs.SOUTH_WEST),o)||Vs.eu(s.Tl(Rs.SOUTH_WEST),l)||l.push(s.Tl(Rs.SOUTH_WEST)),Vs.mu(s,r)||(r.push(s),this.bu(s)),o.splice(t,1),t++;else if(2===a){let i=0;if(!this.isOpen(s.Tl(Rs.NORTH))||Vs.mu(s.Tl(Rs.NORTH),r)||Vs.eu(s.Tl(Rs.NORTH),o)||Vs.eu(s.Tl(Rs.NORTH),l)||(l.push(s.Tl(Rs.NORTH)),i++),!this.isOpen(s.Tl(Rs.SOUTH))||Vs.mu(s.Tl(Rs.SOUTH),r)||Vs.eu(s.Tl(Rs.SOUTH),o)||Vs.eu(s.Tl(Rs.SOUTH),l)||(l.push(s.Tl(Rs.SOUTH)),i++),!this.isOpen(s.Tl(Rs.EAST))||Vs.mu(s.Tl(Rs.EAST),r)||Vs.eu(s.Tl(Rs.EAST),o)||Vs.eu(s.Tl(Rs.EAST),l)||(l.push(s.Tl(Rs.EAST)),i++),!this.isOpen(s.Tl(Rs.WEST))||Vs.mu(s.Tl(Rs.WEST),r)||Vs.eu(s.Tl(Rs.WEST),o)||Vs.eu(s.Tl(Rs.WEST),l)||(l.push(s.Tl(Rs.WEST)),i++),1===i){t++;continue}!this.isOpen(s.Tl(Rs.NORTH_EAST))||Vs.mu(s.Tl(Rs.NORTH_EAST),r)||Vs.eu(s.Tl(Rs.NORTH_EAST),o)||Vs.eu(s.Tl(Rs.NORTH_EAST),l)||l.push(s.Tl(Rs.NORTH_EAST)),!this.isOpen(s.Tl(Rs.NORTH_WEST))||Vs.mu(s.Tl(Rs.NORTH_WEST),r)||Vs.eu(s.Tl(Rs.NORTH_WEST),o)||Vs.eu(s.Tl(Rs.NORTH_WEST),l)||l.push(s.Tl(Rs.NORTH_WEST)),!this.isOpen(s.Tl(Rs.SOUTH_EAST))||Vs.mu(s.Tl(Rs.SOUTH_EAST),r)||Vs.eu(s.Tl(Rs.SOUTH_EAST),o)||Vs.eu(s.Tl(Rs.SOUTH_EAST),l)||l.push(s.Tl(Rs.SOUTH_EAST)),!this.isOpen(s.Tl(Rs.SOUTH_WEST))||Vs.mu(s.Tl(Rs.SOUTH_WEST),r)||Vs.eu(s.Tl(Rs.SOUTH_WEST),o)||Vs.eu(s.Tl(Rs.SOUTH_WEST),l)||l.push(s.Tl(Rs.SOUTH_WEST)),Vs.mu(s,r)||(r.push(s),this.bu(s)),o.splice(t,1),t++}else 1==a||(Vs.mu(s,r)||(r.push(s),this.bu(s)),o.splice(t,1)),t++;if(r.length>e)return!1}for(const t of l){if(this.Jl(t)===$s.GUARANTEED_OPEN||this.Jl(t)===$s.NON_JOIN_GUARANTEED_OPEN)return!1;Vs.mu(t,r)||Vs.eu(t,o)||o.push(t)}l.splice(0,l.length)}let c=!0,u=0,f=Rs.ZERO;for(;c;){u=0,c=!1;for(let t=0;t<o.length;)f=o[t],a=0,!this.isOpen(f.Tl(Rs.NORTH))||Vs.mu(f.Tl(Rs.NORTH),r)||Vs.eu(f.Tl(Rs.NORTH),o)||Vs.eu(f.Tl(Rs.NORTH),l)||a++,!this.isOpen(f.Tl(Rs.SOUTH))||Vs.mu(f.Tl(Rs.SOUTH),r)||Vs.eu(f.Tl(Rs.SOUTH),o)||Vs.eu(f.Tl(Rs.SOUTH),l)||a++,!this.isOpen(f.Tl(Rs.EAST))||Vs.mu(f.Tl(Rs.EAST),r)||Vs.eu(f.Tl(Rs.EAST),o)||Vs.eu(f.Tl(Rs.EAST),l)||a++,!this.isOpen(f.Tl(Rs.WEST))||Vs.mu(f.Tl(Rs.WEST),r)||Vs.eu(f.Tl(Rs.WEST),o)||Vs.eu(f.Tl(Rs.WEST),l)||a++,!this.isOpen(f.Tl(Rs.NORTH_EAST))||Vs.mu(f.Tl(Rs.NORTH_EAST),r)||Vs.eu(f.Tl(Rs.NORTH_EAST),o)||Vs.eu(f.Tl(Rs.NORTH_EAST),l)||a++,!this.isOpen(f.Tl(Rs.NORTH_WEST))||Vs.mu(f.Tl(Rs.NORTH_WEST),r)||Vs.eu(f.Tl(Rs.NORTH_WEST),o)||Vs.eu(f.Tl(Rs.NORTH_WEST),l)||a++,!this.isOpen(f.Tl(Rs.SOUTH_EAST))||Vs.mu(f.Tl(Rs.SOUTH_EAST),r)||Vs.eu(f.Tl(Rs.SOUTH_EAST),o)||Vs.eu(f.Tl(Rs.SOUTH_EAST),l)||a++,!this.isOpen(f.Tl(Rs.SOUTH_WEST))||Vs.mu(f.Tl(Rs.SOUTH_WEST),r)||Vs.eu(f.Tl(Rs.SOUTH_WEST),o)||Vs.eu(f.Tl(Rs.SOUTH_WEST),l)||a++,a>1?(u++,t++):1===a?(c=!0,!this.isOpen(f.Tl(Rs.NORTH))||Vs.mu(f.Tl(Rs.NORTH),r)||Vs.eu(f.Tl(Rs.NORTH),o)||Vs.eu(f.Tl(Rs.NORTH),l)||l.push(f.Tl(Rs.NORTH)),!this.isOpen(f.Tl(Rs.SOUTH))||Vs.mu(f.Tl(Rs.SOUTH),r)||Vs.eu(f.Tl(Rs.SOUTH),o)||Vs.eu(f.Tl(Rs.SOUTH),l)||l.push(f.Tl(Rs.SOUTH)),!this.isOpen(f.Tl(Rs.EAST))||Vs.mu(f.Tl(Rs.EAST),r)||Vs.eu(f.Tl(Rs.EAST),o)||Vs.eu(f.Tl(Rs.EAST),l)||l.push(f.Tl(Rs.EAST)),!this.isOpen(f.Tl(Rs.WEST))||Vs.mu(f.Tl(Rs.WEST),r)||Vs.eu(f.Tl(Rs.WEST),o)||Vs.eu(f.Tl(Rs.WEST),l)||l.push(f.Tl(Rs.WEST)),!this.isOpen(f.Tl(Rs.NORTH_EAST))||Vs.mu(f.Tl(Rs.NORTH_EAST),r)||Vs.eu(f.Tl(Rs.NORTH_EAST),o)||Vs.eu(f.Tl(Rs.NORTH_EAST),l)||l.push(f.Tl(Rs.NORTH_EAST)),!this.isOpen(f.Tl(Rs.NORTH_WEST))||Vs.mu(f.Tl(Rs.NORTH_WEST),r)||Vs.eu(f.Tl(Rs.NORTH_WEST),o)||Vs.eu(f.Tl(Rs.NORTH_WEST),l)||l.push(f.Tl(Rs.NORTH_WEST)),!this.isOpen(f.Tl(Rs.SOUTH_EAST))||Vs.mu(f.Tl(Rs.SOUTH_EAST),r)||Vs.eu(f.Tl(Rs.SOUTH_EAST),o)||Vs.eu(f.Tl(Rs.SOUTH_EAST),l)||l.push(f.Tl(Rs.SOUTH_EAST)),!this.isOpen(f.Tl(Rs.SOUTH_WEST))||Vs.mu(f.Tl(Rs.SOUTH_WEST),r)||Vs.eu(f.Tl(Rs.SOUTH_WEST),o)||Vs.eu(f.Tl(Rs.SOUTH_WEST),l)||l.push(f.Tl(Rs.SOUTH_WEST)),Vs.mu(f,r)||(r.push(f),this.bu(f)),o.splice(t,1)):(Vs.mu(f,r)||(r.push(f),this.bu(f)),o.splice(t,1));for(f of l){if(this.Jl(f)===$s.GUARANTEED_OPEN||this.Jl(f)===$s.NON_JOIN_GUARANTEED_OPEN)return!1;Vs.mu(f,r)||Vs.eu(f,o)||o.push(f)}l.splice(0,l.length)}if(u>1)return!1;if(0===u)for(let t=0;t!==r.length;t++)this.ra(r[t],$s.CLOSED);else{if(r.length<this.Bl.aa)return!1;let t=!1,s=!1;for(let i=0;i!==r.length;i++)r[i].x!==r[0].x&&(t=!0),r[i].y!==r[0].y&&(s=!0);if(!t||!s)return!1;if(this.Jl(f.Tl(Rs.WEST))===$s.V_DOOR||this.Jl(f.Tl(Rs.EAST))===$s.V_DOOR||this.Jl(f.Tl(Rs.WEST))===$s.H_DOOR||this.Jl(f.Tl(Rs.EAST))===$s.H_DOOR||this.Jl(f.Tl(Rs.NORTH))===$s.V_DOOR||this.Jl(f.Tl(Rs.SOUTH))===$s.V_DOOR||this.Jl(f.Tl(Rs.NORTH))===$s.H_DOOR||this.Jl(f.Tl(Rs.SOUTH))===$s.H_DOOR)return!1;if(r.length<this.Bl.ca){if(!this.ru(zs.SMALL))return!1;this.$c++}else if(r.length<this.Bl.ua){if(!this.ru(zs.MEDIUM))return!1;this.zc++}else{if(!(r.length<this.Bl.fa))return!1;if(!this.ru(zs.LARGE))return!1;this.Bc++}f=o[0],this.isOpen(f.Tl(Rs.NORTH))?this.ra(f,$s.H_DOOR):this.isOpen(f.Tl(Rs.WEST))&&this.ra(f,$s.V_DOOR);const i=new Us;for(let t=0;t!==r.length;t++)this.ra(r[t],$s.INSIDE_ROOM_OPEN),i.Sl.push(r[t]);i.Al=!1,this.Pc.push(i)}return!0}Tu(){for(;;){for(this.sa===this.Bl.Eu&&this.xu();this.Iu(););if(!this.Ou())break}if(this.Bl.Eu<0||this.sa<this.Bl.Eu)for(this.xu();;){for(;this.Iu(););if(!this.Ou())break}let t=0,s=0;if(this.Bl.background===$s.OPEN){const i=new Gs(0,0,this.Bl.width,this.Bl.height,this.Bl.background);for(t=0,s=this.Bl.width*this.Bl.height;this.ru()&&(this.Nu(i)||t++,!(t>s)););}for(const i of this.Bl.Wc)if(i.type===$s.OPEN)for(t=0,s=(i.Cl-i.Pl)*(i.$l-i.Rl);this.ru()&&(this.Nu(i)||t++,!(t>s)););}}(t=>{t[t.RIGHT=2]="RIGHT",t[t.DOWN=1]="DOWN"})(Bs||(Bs={})),(t=>{t[t.EMPTY=0]="EMPTY",t[t.FLOOR=1]="FLOOR",t[t.FLOOR_WALL_TOP=2]="FLOOR_WALL_TOP",t[t.WALL_MID=3]="WALL_MID",t[t.WALL_TOP=4]="WALL_TOP",t[t.WALL_SIDE=5]="WALL_SIDE"})(Hs||(Hs={}));class Xs extends Ps{constructor(t,s,i,h,e,n){super(i,h,e),this.Du=null,this.Rs=t,this.sl=[],this.Su=s,this.Au=n,this.Zo=s.cells.length;for(let t=0;t<this.Zo;t++)this.sl[t]=1;const r=[];for(let t=0;t<4;t++){r[t]=[];for(let s=0;s<this.Zo;s++){r[t][s]=[];for(let i=0;i<this.Zo;i++)r[t][s][i]=!1}}for(const[t,i]of s.right){const s=Ps.pl[Bs.RIGHT];r[Bs.RIGHT][t][i]=!0,r[s][i][t]=!0}for(const[t,i]of s.Lu){const s=Ps.pl[Bs.DOWN];r[Bs.DOWN][t][i]=!0,r[s][i][t]=!0}this.Ko=[];for(let t=0;t<4;t++){this.Ko[t]=[];for(let s=0;s<this.Zo;s++){this.Ko[t][s]=[];for(let i=0;i<this.Zo;i++)r[t][s][i]&&this.Ko[t][s].push(i)}}}xl(t,s){return!this.tl&&(t<0||s<0||t>=this.ul||s>=this.fl)}clear(){super.clear();for(const t of this.Au)t.Pu(),this.ml()}Nl(t,s){for(const i of this.Au)i.Ru(t,s)}Ol(t,s){for(const i of this.Au)i.Cu(t,s)}wl(){for(const t of this.Au)if(t.init(this),this.status!=Os.Undecided)return void this.debug}yl(){for(const t of this.Au){if(t.we(),this.status!=Os.Undecided)return void this.debug;if(this.ml(),this.status!=Os.Undecided)return void this.debug}this.cl=!1}_l(t){const s=t%this.ul,i=Math.floor(t/this.ul);if(!this.xl(s,i)){this.jo[t].filter(t=>t).length}}gl(s){const i=this.Su.size;null==this.Du&&(this.Du=new t.Application({width:this.ul*i*1,height:this.fl*i*1,$u:1,zu:!1,Bu:!1,Hu:!1,Uu:!1}),document.body.appendChild(this.Du.view));const h=this.Du;this.Du.Fu.Gu();const e=new t.Container;if(e.scale.set(1,1),h.Fu.v(e),null!=this.Vo)for(let t=0;t<this.ul;t++)for(let s=0;s<this.fl;s++){const[h,n]=this.Su.cells[this.Vo[t+s*this.ul]];if(h>=0){const n=this.Rs.ns(this.Su.Wu[h]);n.position.set(t*i,s*i),n.zIndex=1,e.v(n)}if(n>=0){const h=this.Rs.ns(this.Su.Wu[n]);h.position.set(t*i,s*i),h.zIndex=2,e.v(h)}}else for(let t=0;t<this.ul;t++)for(let s=0;s<this.fl;s++){const h=this.jo[t+s*this.ul];let n=0;for(let t=0;t<this.Zo;t++)h[t]&&(n+=this.sl[t]);const r=1/n;for(let n=0;n<this.Zo;n++)if(h[n]){const[h,o]=this.Su.cells[n],l=(h>=0?1:0)+(o>=0?1:0);if(h>=0){const o=this.Rs.ns(this.Su.Wu[h]);o.position.set(t*i,s*i),o.zIndex=1,o.alpha=r*(1/l)*this.sl[n],e.v(o)}if(o>=0){const h=this.Rs.ns(this.Su.Wu[o]);h.position.set(t*i,s*i),h.zIndex=2,h.alpha=r*(1/l)*this.sl[n],e.v(h)}}}const n=new t.Graphics;e.v(n),n.ju(1,16711680);for(const t of s){const s=t%this.ul,h=Math.floor(t/this.ul);n.N(s*i,h*i,i,i)}h.Ku();h.view}}class qs{constructor(t){this.Vu=null,this.Xu=null,this.bs=t}get qu(){return this.Xu}init(t){this.Vu=t}Pu(){const t=this.Vu,s=this.Xu=new Vs(this.bs,t.Os);s.Tu();const i=Ls(t.ul*t.fl,!1);for(let h=0;h<s.Bl.height;h++)for(let e=0;e<s.Bl.width;e++){const n=e+h*t.ul;i[n]=s.nu({x:e,y:h})}function h(s){const h=s%t.ul,e=Math.floor(s/t.ul);for(let s=0;s<=1;s++)for(let n=-1;n<=1;n++)if(0!==n||0!==s){const r=h+n,o=e+s;if(t.xl(r,o))continue;if(!i[r+o*t.ul])return!1}return!0}function e(s,h=2){const e=s%t.ul,n=Math.floor(s/t.ul);for(let s=-1;s<=h;s++)for(let h=-1;h<=1;h++)if(0!==h||0!==s){const r=e+h,o=n+s;if(t.xl(r,o))continue;if(i[r+o*t.ul])return!0}return!1}function n(s,h,e){const n=s%t.ul+h,r=Math.floor(s/t.ul)+e;return t.xl(n,r)?null:i[n+r*t.ul]}for(let s=0;s<i.length;s++){const r=Ls(6,!1),o=n(s,0,1);if(i[s])r[Hs.EMPTY]=!1,r[Hs.FLOOR]=!0,h(s)||(r[Hs.FLOOR_WALL_TOP]=!0);else if(e(s)){const t=n(s,0,-1);r[Hs.EMPTY]=!(!0===t||!0===o),r[Hs.WALL_MID]=!0===t||!0===o,r[Hs.WALL_TOP]=!0,r[Hs.WALL_SIDE]=!0}else r[Hs.EMPTY]=!0;for(let i=0;i<t.Zo;i++){r[t.Su.cells[i][2]]||t.Il(s,i)}}}we(){}Ru(t,s){}Cu(t,s){}}class Js extends class{constructor(t){this.vs=t.vs,this.controller=t}Ju(s,i,h,e,n){return new X(this.controller,new t.Ticker,s,i,h,e,n)}Yu(t,s){const i=["floor_2.png","floor_3.png","floor_4.png","floor_5.png","floor_6.png","floor_7.png","floor_8.png"];for(let h=0;h<s.height;h++)for(let e=0;e<s.width;e++){const n=s.ht(e,h);n.Ji&&t.float()<.2&&(n.Yi=t.select(i))}}Qu(t,s){const i=["wall_banner_red.png","wall_banner_blue.png","wall_banner_green.png","wall_banner_yellow.png"],h=["wall_goo.png"],e=["wall_fountain_mid_red","wall_fountain_mid_blue"],n=["wall_hole_1.png","wall_hole_2.png"];for(let r=0;r<s.height;r++)for(let o=0;o<s.width;o++){if("wall_mid.png"===s.ht(o,r).Zi&&t.float()<.3){const l=[...n],a=r+1<s.height&&"floor_1.png"===s.ht(o,r+1).Yi;a&&(l.push(...i),l.push(...h)),r>0&&"wall_top_mid.png"===s.ht(o,r-1).Zi&&a&&l.push(...e);const c=t.select(l);switch(c){case"wall_goo.png":s.ht(o,r).Zi="wall_goo.png",s.ht(o,r+1).Yi="wall_goo_base.png";break;case"wall_fountain_mid_red":s.ht(o,r-1).Zi="wall_fountain_top.png",s.ht(o,r).Zi="wall_fountain_mid_red",s.ht(o,r+1).Yi="wall_fountain_basin_red";break;case"wall_fountain_mid_blue":s.ht(o,r-1).Zi="wall_fountain_top.png",s.ht(o,r).Zi="wall_fountain_mid_blue",s.ht(o,r+1).Yi="wall_fountain_basin_blue";break;default:s.ht(o,r).Zi=c}}}}}{constructor(t){super(t),this.Vu=null}get dl(){var t;return(null===(t=this.Vu)||void 0===t?void 0:t.dl)||0}async Tu(t){const s=this.controller.loader.vs["dungeon.rules.json"].data,i=this.controller.loader.vs["dungeon.design.json"].data,h=this.controller.Zu.state(t.Ns);let e;h.Ih.No(t.level)?e=h.Ih.Eo(t.level):(e=this.controller.Os.Dt(),h.Ih.To(t.level,e));const n=v.Et(e);await As(10);const r=new qs(i);let o;for(this.Vu=new Xs(this.vs,s,n,i.width,i.height,[r]);o=await this.Vu._s(1e4),o!==Os.Decided;)await As();const l=this.Ju(n,e,t.level,this.Vu.ul,this.Vu.fl),a=this.Vu.Vo;for(let t=0;t<this.Vu.fl;t++)for(let i=0;i<this.Vu.ul;i++){const h=i+t*this.Vu.ul,[e,n]=s.cells[a[h]];e>=0&&(l.ht(i,t).Yi=s.Wu[e]),n>=0&&(l.ht(i,t).Zi=s.Wu[n])}const c=r.qu.gu.sort(Us.ki).reverse();for(const t of c);return await As(),this.Yu(n,l),await As(),this.Qu(n,l),t.level%5==0?await this.tf(n,l,c,h):await this.sf(n,l,c,h),await this.if(n,l),l.fh.qi(),await As(),l}async sf(t,s,i,h){const e=i.shift(),n=i.shift();await this.hf(t,s,h,e),await this.ef(t,s,n),await this.nf(t,s,h,e),await this.rf(t,s,e),await this.lf(t,s,e)}async tf(t,s,i,h){const e=i.shift(),n=i.shift();await this.hf(t,s,h,n),await this.rf(t,s,n),await this.nf(t,s,h,n),await this.ef(t,s,e),await this.af(t,s,e),await this.lf(t,s,n)}async hf(t,s,i,h){const e=this.cf(t,s,3,3,h);if(!e)throw"error place bonfire";{const t=new Ms(i,s,e.x+1,e.y-2);s.fh.Qi(t.view,W.HERO)}}async ef(t,s,i){const h=this.cf(t,s,3,3,i);if(!h)throw"error place bonfire";s.ht(h.x+1,h.y-1).Mh()}async nf(t,s,i,h){const e=this.cf(t,s,3,3,h);if(!e)throw"error place bonfire";{const t=i.Ih.Do(s.level);new Z(s,e.x+1,e.y-1,t)}}async rf(t,s,i){for(let h=0;h<5;h++){const h=this.cf(t,s,2,2,i);if(!h)break;this.controller.ff.uf(s,h.x,h.y)}}async af(t,s,i){const h=this.cf(t,s,4,4,i);if(!h)throw"error place boos";this.controller.ar.oo(s,h.x+1,h.y-1)}async lf(t,s,i){const h=s.width*s.height,e=Math.floor(.4*h),n=Math.floor(.2*e),r=Math.floor(.15*n),o=Math.floor(.01*n);for(let h=0;h<r&&await this.df(t,s,i);h++);for(let h=0;h<o&&await this.wf(t,s,i);h++);}async df(t,s,i){const h=this.pf(t,s,2,2,i);return null!==h&&(this.controller.ar.io(s,h.x,h.y),!0)}async wf(t,s,i){const h=this.pf(t,s,3,3,i);return null!==h&&(this.controller.ar.eo(s,h.x+1,h.y-1),!0)}async if(t,s){const i=[];for(let t=0;t<s.height;t++)for(let h=0;h<s.height;h++){const e=s.ht(h,t);!e.Ji||e.bh||e._h||i.push(e)}const h=()=>{const s=t.range(0,i.length);return i.splice(s,1)[0]},e=Math.floor(.01*i.length),n=Math.floor(.008*i.length),r=Math.floor(.004*i.length),o=Math.floor(.002*i.length);for(let t=0;t<o&&i.length>0;t++)h().oi=this.controller.xh.ks(s);for(let t=0;t<r&&i.length>0;t++)h().oi=new A;for(let t=0;t<n&&i.length>0;t++)h().oi=new S;for(let s=0;s<e&&i.length>0;s++)h().oi=new D(t)}pf(t,s,i,h,e){const n=new Set(e.Sl.map(t=>`${t.x}:${t.y}`)),r=[];for(let t=h;t<s.height;t++)for(let e=0;e<s.width-i;e++){let o=!0;for(let r=0;r<h&&o;r++){for(let h=0;h<i&&o;h++){const i=s.ht(e+h,t-r);if(o=i.Ji&&!i._h&&!n.has(`${i.x}:${i.y}`),!o)break}if(!o)break}o&&r.push(s.ht(e,t))}return t.select(r)}cf(t,s,i,h,e){const n=[];for(const t of e.Sl){const e=t.x,r=t.y;let o=!0;for(let t=0;t<h&&o;t++)for(let h=0;h<i&&o;h++){const i=s.ht(e+h,r-t);o=i.Ji&&!i._h}o&&n.push(s.ht(e,r))}return t.select(n)}}class Ys extends s{constructor(s,i){super(s),this.gf=new Js(this.t);const h=this.t.screen,n=new t.BitmapText("ROGUELIKE DUNGEON",{font:{name:"alagard",size:64}});n.anchor=new t.Point(.5,0),n.position.set(this.t.screen.width>>1,64),this.v(n),this.yf=new c({color:e,width:h.width-(a<<2),height:64,o:100}),this.yf.position.set(a<<1,h.height-(a<<1)-64),this.v(this.yf),this.mf=i}async Tu(){const t=await this.gf.Tu(this.mf);this.t.bf(t)}init(){this.t.ticker.add(this.update,this),this.Tu()}I(){this.t.ticker.remove(this.update,this),super.I({children:!0})}pause(){}resume(){}update(){this.yf.value=this.gf.dl}}class Qs extends s{constructor(t){super(t)}init(){this.t.ticker.add(this.yt,this);const s=new t.BitmapText("ROGUELIKE DUNGEON",{font:{name:"alagard",size:64}});s.anchor=new t.Point(.5,0),s.position.set(this.t.screen.width>>1,64),this.v(s);const i=["WASD - top, left, bottom, right","F - action","Q - drop weapon","I - inventory","1 ... 0 - belt","","PRESS F TO CONTINUE"];for(let s=0;s<i.length;s++){const h=i[s];if(h.length>0){const i=new t.BitmapText(h,{font:{name:"alagard",size:32}});i.position.set(40,200+30*s),this.v(i)}}}I(){this.t.ticker.remove(this.yt,this),super.I({children:!0})}pause(){}resume(){}yt(){this.t.xt.bt.once()&&this.t.os()}}class Zs extends s{constructor(t){super(t),this.vt=new p(t.xt)}init(){this.vf(),this.xf(),this.t.ticker.add(this.vt.yt,this.vt)}I(){this.t.ticker.remove(this.vt.yt,this.vt),super.I({children:!0})}pause(){}resume(){}vf(){const s=new t.BitmapText("ROGUELIKE DUNGEON",{font:{name:"alagard",size:64}});s.anchor=new t.Point(.5,0),s.position.set(this.t.screen.width>>1,64),this.v(s)}xf(){const t=this.t.screen,s=_s.length,i=Math.floor((t.width-40*(s+1))/s),h=(i-80)/16,e=Math.floor(28*h)+32+120;for(let h=0;h<s;h++){const s=_s[h],n=40*(h+1)+i*h,r=(t.height>>1)-(e>>1),o=new ti(i,e,s,this.t.vs);o.position.set(n,r),this.v(o),this.vt.set(h,0,o,()=>this.select(s))}this.vt.reset()}select(t){const s=this.t.Zu.state(t).Ih.Sh(),i=s.length>0?s[s.length-1]:1;this.t.ci({level:i,Ns:t})}}class ti extends t.Container{constructor(s,i,h,r){super(),this._f=!1,this.Mf=(new t.Graphics).T(e).N(0,0,s,i).O(),this.kf=(new t.Graphics).T(n).N(0,0,s,i).O(),this.kt=new t.BitmapText(h,{font:{name:"alagard",size:32}}),this.kt.anchor=.5,this.kt.position.set(s>>1,40);const o=s-80,l=o/16,a=Math.floor(28*l);this.Ps=r.es(h+"_idle"),this.Ps.width=o,this.Ps.height=a,this.Ps.position.set(40,112),this.v(this.Mf,this.kf,this.kt,this.Ps),this.selected=!1}get selected(){return this._f}set selected(t){this._f=t,t?(this.Mf.visible=!0,this.kf.visible=!1,this.kt.visible=!0,this.Ps.If(0)):(this.Mf.visible=!1,this.kf.visible=!0,this.kt.visible=!1,this.Ps.Ee(0))}I(){super.I(),this.Mf.I(),this.kf.I(),this.kt.I(),this.Ps.I()}}class si extends Ot{constructor(t,s,i,h){super(s,{x:i,y:h,width:t.width,height:t.height,Qs:!1,Zs:!0,animation:t.name+"_idle",zIndex:V.lh}),this.state=t,this.init()}gn(){this.I()}pn(t){}si(t){this._n(t),this.ni.controller.Of(t.state,this.state)}on(){const t=this.xs();return t.state(1).de(0).action(()=>"npc idle complete"),t}}class ii extends bs{constructor(t){super(t),this.$h=new Map,this.Nf=new Map,this.level=t.level,this.width=t.width,this.height=t.height}Tf(t,s){this.$h.set(t,s)}getContext(t){return this.$h.get(t)}Ef(t){return this.Nf.has(t)}Df(t){return this.Nf.get(t)||null}Sf(t,s){this.Nf.set(t,s)}}class hi{constructor(t,s){this.Ss=t,this.controller=s}}let ei=(()=>{class t extends hi{constructor(t,s){super(t,s)}ys(t){this.controller.Af(t,this.Ss)}}return t.id="selling",t})(),ni=(()=>{class t extends hi{constructor(t,s,i){super(t,s);for(const h of i)switch(h){case"potions":for(let s=0;s<10;s++)t.Ut.gr.ht(s,0).set(new S,3);for(let s=0;s<10;s++)t.Ut.gr.ht(s,1).set(new A,3);break;case"weapons":for(const i of s.xh.Is(t.level+2)){const h=s.xh.Ms(i);t.Ut.gr.add(h)}}}ys(t){this.controller.Lf(t,this.Ss)}}return t.id="buying",t})(),ri=(()=>{class s extends hi{constructor(t,s){super(t,s)}ys(s){t.sound.play("big_egg_collect"),s.Ws.set(s.js.get())}}return s.id="heal",s})();class oi{constructor(t){this.t=t}init(){this.bs=this.t.loader.vs["npc.config.json"].data}state(t,s){const i=this.bs.Ss[s];if(!i)throw"Npc not found: "+s;const h=new ii({name:i.name,js:i.js,Ws:i.Ws,Qr:i.Qr,speed:i.speed,Gs:i.Gs,level:t,width:i.width,height:i.height});for(const t of i.Pf)switch(t){case ei.id:h.Sf(t,new ei(h,this.t));break;case ni.id:h.Sf(t,new ni(h,this.t,i.Rf));break;case ri.id:h.Sf(t,new ri(h,this.t))}const e=this.t.Os.select(i.Ts);if(e){const t=this.t.xh.Ds(e);h.Ut.un.Ms.set(t)}return h}uf(t,s,i){const h=t.Os.select(Object.keys(this.bs.Ss)),e=this.state(t.level,h);return new si(e,t,s,i)}}var li,ai,ci;(t=>{t.POTIONS="potions",t.WEAPONS="weapons"})(li||(li={})),(t=>{t[t.Started=1]="Started",t[t.ParsingNumber=2]="ParsingNumber",t[t.ParsingStringStarted=3]="ParsingStringStarted",t[t.ParsingString=4]="ParsingString",t[t.ParsingStringFinished=5]="ParsingStringFinished",t[t.ParsingFunction=6]="ParsingFunction",t[t.Finished=7]="Finished",t[t.ParsingContext=8]="ParsingContext",t[t.ParsingBracket=9]="ParsingBracket",t[t.Error=10]="Error"})(ai||(ai={})),(t=>{t[t.Delimiter=1]="Delimiter",t[t.Digit=2]="Digit",t[t.Bracket=3]="Bracket",t[t.Other=4]="Other",t[t.ContextBracket=5]="ContextBracket",t[t.Quote=6]="Quote"})(ci||(ci={}));const ui={[ai.Started]:{[ci.Delimiter]:ai.Started,[ci.Digit]:ai.ParsingNumber,[ci.Bracket]:ai.ParsingBracket,[ci.Other]:ai.ParsingFunction,[ci.ContextBracket]:ai.ParsingContext,[ci.Quote]:ai.ParsingStringStarted},[ai.ParsingNumber]:{[ci.Delimiter]:ai.Finished,[ci.Digit]:ai.ParsingNumber,[ci.Bracket]:ai.Finished,[ci.Other]:ai.Finished,[ci.ContextBracket]:ai.Error,[ci.Quote]:ai.Error},[ai.ParsingFunction]:{[ci.Delimiter]:ai.Finished,[ci.Digit]:ai.ParsingFunction,[ci.Bracket]:ai.Finished,[ci.Other]:ai.ParsingFunction,[ci.ContextBracket]:ai.Error,[ci.Quote]:ai.Error},[ai.ParsingContext]:{[ci.Delimiter]:ai.Finished,[ci.Digit]:ai.ParsingContext,[ci.Bracket]:ai.Finished,[ci.Other]:ai.ParsingContext,[ci.ContextBracket]:ai.ParsingContext,[ci.Quote]:ai.Error},[ai.ParsingBracket]:{[ci.Delimiter]:ai.Finished,[ci.Digit]:ai.Finished,[ci.Bracket]:ai.Finished,[ci.Other]:ai.Finished,[ci.ContextBracket]:ai.Finished,[ci.Quote]:ai.Finished},[ai.ParsingStringStarted]:{[ci.Delimiter]:ai.ParsingString,[ci.Digit]:ai.ParsingString,[ci.Bracket]:ai.ParsingString,[ci.Other]:ai.ParsingString,[ci.ContextBracket]:ai.ParsingString,[ci.Quote]:ai.Finished},[ai.ParsingString]:{[ci.Delimiter]:ai.ParsingString,[ci.Digit]:ai.ParsingString,[ci.Bracket]:ai.ParsingString,[ci.Other]:ai.ParsingString,[ci.ContextBracket]:ai.ParsingString,[ci.Quote]:ai.ParsingStringFinished},[ai.ParsingStringFinished]:{[ci.Delimiter]:ai.Finished,[ci.Digit]:ai.Finished,[ci.Bracket]:ai.Finished,[ci.Other]:ai.Finished,[ci.ContextBracket]:ai.Finished,[ci.Quote]:ai.Finished}};let fi=(()=>{class t{constructor(){this.Cf={"+":{$f:0,zf:!1,apply:(t,s)=>t+s},"-":{$f:0,zf:!1,apply:(t,s)=>t-s},"*":{$f:1,zf:!1,apply:(t,s)=>t*s},"/":{$f:1,zf:!1,apply:(t,s)=>t/s},"%":{$f:1,zf:!1,apply:(t,s)=>t%s},Bf:{$f:0,zf:!1,apply:(t,s)=>t||s},Hf:{$f:1,zf:!1,apply:(t,s)=>t&&s},"!":{$f:2,zf:!1,apply:t=>!t},true:{$f:100,zf:!1,apply:()=>!0},false:{$f:100,zf:!1,apply:()=>!1},Uf:{$f:100,zf:!1,apply:(t,s)=>s[t.substring(1,t.length-1)]}},this.$h={}}static Gf(s){return-1!==t.Ff.indexOf(s)?ci.Delimiter:-1!==t.Wf.indexOf(s)?ci.Bracket:-1!==t.jf.indexOf(s)?ci.Digit:-1!==t.Kf.indexOf(s)?ci.ContextBracket:-1!==t.quotes.indexOf(s)?ci.Quote:ci.Other}Vf(t,s){return this.Cf[t].$f<=this.Cf[s].$f}Xf(s,i){let h=ai.Started,e=ai.Error,n="",r=i;for(;r<s.length&&h!==ai.Finished&&h!==ai.Error;){const i=t.Gf(s[r]);h=ui[h][i],h===ai.ParsingFunction&&void 0!==this.Cf[n]&&(h=ai.Finished),h===ai.ParsingFunction||h===ai.ParsingNumber||h===ai.ParsingBracket||h===ai.ParsingContext||h===ai.ParsingString?(e=h,n+=s[r++]):h!==ai.Started&&h!==ai.ParsingStringStarted&&h!==ai.ParsingStringFinished||r++}return""===n&&(e=ai.Error),{qf:e,Jf:n,tn:r}}Yf(s){const i=[],h=[];let e,n=0;for(let r=0;r<s.length;r++)if("n"!==s[r].type)if("("!==s[r].type)if(")"!==s[r].type){if(-1!==Object.keys(this.Cf).indexOf(s[r].type)){if(i.length>0){do{e=i.pop(),h[n++]=e}while(i.length>0&&-1===t.Wf.indexOf(h[n-1].type)&&this.Vf(s[r].type,h[n-1].type));-1===t.Wf.indexOf(h[n-1].type)&&this.Vf(s[r].type,h[n-1].type)||(i.push(e),n--)}i.push(s[r])}}else{do{e=i.pop(),h[n++]=e}while("("!==h[n-1].type);n--}else i.push(s[r]);else h[n++]=s[r];for(;i.length>0;)e=i.pop(),h[n++]=e;return h}Qf(t){var s;const i=[];if(0===t.length)return null;for(let s=0;s<t.length;s++)if("n"===t[s].type)i.push(t[s]);else{const h=this.Cf[t[s].type],e=h.apply,n=h.zf?i.length:e.length,r=e(...i.splice(i.length-n).map(t=>t.value));i.push({type:"n",value:r})}return(null===(s=i.shift())||void 0===s?void 0:s.value)||null}Zf(t){const s=[];for(let i=0;i<t.length;){const h=this.Xf(t,i);h.qf!==ai.Error&&(h.qf===ai.ParsingNumber?s.push({type:"n",value:-1!==h.Jf.indexOf(".")?parseFloat(h.Jf):parseInt(h.Jf)}):h.qf===ai.ParsingContext?(s.push({type:"$$getContextValue",value:null}),s.push({type:"n",value:h.Jf}),s.push({type:"n",value:this.$h})):h.qf===ai.ParsingString?s.push({type:"n",value:h.Jf}):s.push({type:h.Jf,value:null})),i=h.tn}return s}register(t,s,i,h){this.Cf[t]={$f:s,zf:i,apply:h}}evaluate(t,s={}){this.$h=s;const i=this.Zf(t),h=this.Yf(i);return this.Qf(h)}}return t.jf="0123456789.",t.Wf="()",t.Kf="{}",t.Ff=" ,\r\r\n",t.quotes="'\"",t})();class di{constructor(){this.$h={}}add(t,s){this.$h[t]=s}Ku(t){return t.replace(/{{([^}]+)}}/g,(t,s)=>{const i=s.split(".");if(i.length>=1){let t=this.$h;for(;i.length>0;){const[s]=i.splice(0,1);t=t[s]}return t||null}return s})}}class wi{constructor(t){this.t=t}init(){this.td=this.t.loader.vs["dialogs.json"].data}sd(t,s){const i=this.td[s.name]||this.td.default;return new pi(this.t,t,s,i)}}class pi{constructor(t,s,i,h){this.hd=new ht,this.t=t,this.Ns=s,this.Ss=i,this.bs=h,this.ed=new fi,this.ed.register("goto",100,!0,this.nd.bind(this)),this.ed.register("exit",100,!1,this.se.bind(this)),this.ed.register("context",100,!1,this.context.bind(this)),this.ed.register("hasSkill",100,!1,this.Ef.bind(this)),this.ed.register("skill",100,!1,this.rd.bind(this)),this.od=new di,this.od.add("hero",this.Ns),this.od.add("npc",this.Ss)}get ld(){return this.hd}start(){this.nd(...this.bs.start)}Ef(t){return this.Ss.Ef(t)}rd(t){var s;null===(s=this.Ss.Df(t))||void 0===s||s.ys(this.Ns)}se(){this.t.Mt()}context(t,s){return void 0===s?this.Ss.getContext(t):(this.Ss.Tf(t,s),null)}nd(...t){for(const s of t){const t=this.bs.ad[s];if(this.we(t.ud)){const s=this.od.Ku(t.text),i=new gi(this,s);for(const s of t.fd)if(this.we(s.ud)){const t=this.od.Ku(s.text);i.add(t,s.dd)}return void this.hd.send(i)}}}we(t){if(t)for(const s of t)if(!this.evaluate(s))return!1;return!0}evaluate(t){return this.ed.evaluate(t)}}class gi{constructor(t,s){this.fd=[],this.wd=t,this.text=s}add(t,s){this.fd.push(new yi(this.wd,t,s))}}class yi{constructor(t,s,i){this.sd=t,this.text=s,this.dd=i}action(){for(const t of this.dd)this.sd.evaluate(t)}}class mi extends m{constructor(t,s){super(t,"Dialog"),this.pd=null,this.gd=null,this.yd=[],this.wd=s}init(){super.init();const t=new d({padding:0});this.v(t);const s=new f({spacing:0,backgroundColor:h});t.v(s);const i=this.t.vs.es(this.wd.Ss.name+"_idle");i.width=4*i.width,i.height=4*i.height,s.v(i),this.pd=new f({padding:0}),t.v(this.pd),this.gd=new bi(300),this.pd.v(this.gd),this.wd.ld.subscribe(this.md,this),this.wd.start()}I(){this.wd.ld.unsubscribe(this.md,this),super.I()}md(t){for(let t=0;t<this.yd.length;t++){this.yd[t].I(),this.vt.remove(0,t+1)}this.vt.reset(),this.yd=[],this.gd.text=t.text;for(let s=0;s<t.fd.length;s++){const i=t.fd[s],h=new u({label:i.text,width:300});this.vt.set(0,s+1,h,i.action.bind(i)),this.yd.push(h),this.pd.v(h)}this.vt.select(0,1),this.W(),this.vt.reset()}}class bi extends t.Container{constructor(s){super(),this.R=new t.BitmapText("",{font:{name:"alagard",size:16}}),this.R.maxWidth=s-2*l,this.R.bd(),this.R.position.set(l,l),this.H=(new t.Graphics).T(h).N(0,0,1,1).O(),this.H.width=s,this.v(this.H,this.R)}set text(t){this.R.text=t,this.H.height=this.R.height+2*l}}class vi extends t.Container{constructor(s,i){super(),this.vd=120,this.xd=60,this.t=s;const h=s.screen,e=Math.floor(.7*h.height);this.R=new t.BitmapText(i.text,{font:{name:"alagard",size:64},align:"center",rs:i.color}),this.R.anchor=new t.Point(.5,.5),this.R.position.set(h.width>>1,e);const n=new t.filters.BlurFilter;n._d=1,n.Md=10,n.kd=4,this.Id=new t.BitmapText(i.text,{font:{name:"alagard",size:64},align:"center",rs:i.color}),this.Id.anchor=new t.Point(.5,.5),this.Id.position.set(h.width>>1,e),this.Id.width+=44.8,this.Id.alpha=.5,this.Id.filters=[n],this.Id.Od=this.Id.j().clone().pad(50,0),this.Nd=vi.Wi(1,128),this.H=new t.TilingSprite(this.Nd,h.width,128),this.H.position.set(0,e-64),this.v(this.H,this.Id,this.R),this.t.ticker.add(this.update,this)}update(t){this.vd>0?this.vd-=t:this.xd>0?(this.xd-=t,this.alpha=this.xd/60):this.t.Td()}I(){super.I(),this.t.ticker.remove(this.update,this),this.R.I(),this.H.I(),this.Nd.I(!0)}static Wi(s,i){const h=document.createElement("canvas");h.width=s,h.height=i;const e=h.getContext("2d"),n=e.createLinearGradient(0,0,0,i);return n.addColorStop(0,"rgba(0, 0, 0, 0)"),n.addColorStop(.3,"rgba(0, 0, 0, 1)"),n.addColorStop(.7,"rgba(0, 0, 0, 1)"),n.addColorStop(1,"rgba(0, 0, 0, 0)"),e.fillStyle=n,e.fillRect(0,0,s,i),t.eh.from(h)}}class xi{constructor(t){this.wr=t}Bs(t){return t?this.wr.Bs(t):null}Hs(t){return null!==t?this.wr.Hs(t):""}}let _i=(()=>{class t{Bs(t){return t}Hs(t){return t}}return t.Ed=new t,t})(),Mi=(()=>{class t{Bs(t){if(!t)throw"empty";const s=Number.parseFloat(t);if(isNaN(s))throw"NaN";return s}Hs(t){if(isNaN(t))throw"NaN";return t.toString()}}return t.Ed=new t,t})(),ki=(()=>{class t{Bs(t){if(!t)throw"empty";const s=Number.parseInt(t);if(isNaN(s))throw"NaN";return s}Hs(t){if(isNaN(t))throw"NaN";return t.toString()}}return t.Ed=new t,t})();class Ii{Bs(t){return JSON.parse(t)}Hs(t){return JSON.stringify(t)}}class Oi{constructor(t,s){this.Dd=t,this.Sd=s+".",this._destroyed=!1}static init(t){const s="localhost"===location.hostname||"0.0.0.0"===location.hostname||"127.0.0.1"===location.hostname?sessionStorage:localStorage;return new Oi(s,t)}active(){if(this._destroyed)throw"IllegalStateError"}key(t){return this.Sd+t}I(){this._destroyed||(this._destroyed=!0)}clear(){this.active();for(const t of Object.keys(this.Dd))t.startsWith(this.Sd)&&this.Dd.removeItem(t)}keys(){const t=[];for(const s of Object.keys(this.Dd))s.startsWith(this.Sd)&&t.push(s.replace(this.Sd,""));return t}vr(){return 0===this.keys().length}prefix(t){return this.active(),new Oi(this.Dd,this.key(t))}get(t){return this.active(),this.Dd.getItem(this.key(t))}set(t,s){this.active(),this.Dd.setItem(this.key(t),s)}remove(t){this.active(),this.Dd.removeItem(this.key(t))}zf(t,s,i){this.active();const h=this.get(t),e=null===h?s:i.Bs(h);return new Ni(t,e,i,this)}cr(t,s,i){this.active();const h=new xi(i),e=this.get(t),n=null===e?s:h.Bs(e);return new Ni(t,n,h,this)}Ad(t,s){return this.active(),this.zf(t,s,_i.Ed)}_o(t,s){return this.active(),this.zf(t,s,Mi.Ed)}ur(t,s){return this.active(),this.zf(t,s,ki.Ed)}Ld(t,s){return this.active(),this.zf(t,s,new Ii)}}class Ni extends it{constructor(t,s,i,h){super(s),this.Pd=t,this.wr=i,this.dr=h}Lh(t){this.dr.set(this.Pd,this.wr.Hs(t))}}class Ti{constructor(t){this.Rd=null,this.Cd=null,this.$d=null,this.Os=v.create(),this.xt=new M,this.vs=new k(t.loader),this.Du=t,this.ticker=t.ticker,this.loader=t.loader,this.screen=t.screen,this.So=Oi.init("#"),this.zd=new wi(this),this.Zu=new Es(this),this.ff=new oi(this),this.ar=new xs(this),this.xh=new N(this)}async init(){await this.vs.load(),this.xh.init(),this.ff.init(),this.ar.init(),this.zd.init()}I(){this.Du.I()}get Bd(){return this.Rd}Hd(t){var s;null===(s=this.Rd)||void 0===s||s.I(),this.xt.reset(),this.Rd=t,this.Du.Fu=this.Rd,this.Rd.init()}Ud(){this.Hd(new Qs(this))}os(){this.Hd(new Zs(this))}ln(){this.Hd(new I(this))}ci(t){this.Hd(new Ys(this,t))}bf(t){this.Hd(new Ss(this,t))}Gd(s){var i,h;t.sound.play("text"),null===(i=this.Rd)||void 0===i||i.pause(),this.xt.reset(),this.Cd=s,null===(h=this.Rd)||void 0===h||h.v(s),this.Cd.init(),this.Cd.position.set((this.screen.width>>1)-(this.Cd.width>>1),(this.screen.height>>1)-(this.Cd.height>>1))}Mt(){var t,s;null===(t=this.Cd)||void 0===t||t.I(),this.xt.reset(),null===(s=this.Rd)||void 0===s||s.resume()}bo(t){const s=new ps(t);this.Gd(new fs(this,s))}Af(t,s){const i=new gs(t,s);this.Gd(new fs(this,i))}Lf(t,s){const i=new ys(t,s);this.Gd(new fs(this,i))}Of(t,s){const i=this.zd.sd(t,s);this.Gd(new mi(this,i))}Nh(t){this.Gd(new tt(this,t))}Oh(t){var s;this.Td(),this.$d=new vi(this,t),null===(s=this.Rd)||void 0===s||s.v(this.$d)}Td(){var t;null===(t=this.$d)||void 0===t||t.I(),this.$d=null}}(async()=>{PIXI.settings.SCALE_MODE=PIXI.SCALE_MODES.NEAREST,PIXI.settings.FAIL_IF_MAJOR_PERFORMANCE_CAVEAT=!1,PIXI.sound.volumeAll=.5;const t=new PIXI.Application({width:1200,height:700,zu:!1});document.getElementById("container").appendChild(t.view);const s=new Ti(t);await s.init(),s.Ud()})()}(PIXI);
//# sourceMappingURL=bundle.js.map
