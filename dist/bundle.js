!function(t){"use strict";class s extends t.display.Stage{constructor(t){super(),this.t=t}}const i=1052688,h=2105376,e=7368816,n=4210752,r=15482923,o=43830,l=12557824,a=4,c=16;class u extends t.Container{constructor(s){super(),this._backgroundColor=s.backgroundColor||h,this.s=s.color,this._width=s.width,this._height=s.height||16+(a<<1),this.i=0,this.o=s.valueMax,this.l=s.center||!1,this.u=!0,this.p=new t.Graphics,this.m=new t.BitmapText(s.label||"",{font:{name:"alagard",size:16}}),this.addChild(this.p,this.m),this.update(),t.Ticker.shared.add(this.update,this,t.UPDATE_PRIORITY.LOW)}set backgroundColor(t){this._backgroundColor=t}set rectColor(t){this.s=t,this.u=!0}set rectWidth(t){this._width=t,this.u=!0}set rectHeight(t){this._height=t,this.u=!0}set value(t){this.i=t,this.u=!0}set valueMax(t){this.o=t,this.u=!0}set center(t){this.l=t,this.u=!0}set label(t){this.m.text=t}destroy(){t.Ticker.shared.remove(this.update,this),super.destroy({children:!0})}update(){if(!this.u)return;const s=this._width,i=this._height,h=a;this.m.anchor=new t.Point(this.l?.5:0,.5),this.m.position.set(this.l?s>>1:h<<1,i>>1);const e=Math.round((s-(h<<1))*Math.min(this.i,this.o)/this.o);this.p.clear().beginFill(this._backgroundColor).drawRect(0,0,s,i).endFill().beginFill(this.s).drawRect(h,h,e,i-(h<<1)).endFill(),this.u=!0}}class f extends t.Container{constructor(s){super(),this.v=!1,this._width=s.width||200,this._height=s.height||24,this._=s.textSize||16,this.M=s.border||!1,this.k=new t.Graphics,this.I=new t.BitmapText(s.label,{font:{name:"alagard",size:this._}}),this.I.anchor=new t.Point(.5,.5),this.I.position.set(this._width>>1,this._height>>1),this.selected=s.selected||!1,super.addChild(this.k,this.I)}get selected(){return this.v}set selected(t){this.v=t,this.M?this.k.clear().beginFill(h).drawRect(0,0,this._width,this._height).endFill().beginFill(t?e:n).drawRect(a,a,this._width-2*a,this._height-2*a).endFill():this.k.clear().beginFill(t?e:n).drawRect(0,0,this._width,this._height).endFill()}}class d extends t.Container{constructor(s){super(),this._width=0,this._height=0,this.S=!1,void 0!==s.backgroundColor?this.O=(new t.Graphics).beginFill(s.backgroundColor).drawRect(0,0,1,1).endFill():this.O=new t.Container,this.addChild(this.O)}onChildrenChange(){this.S=!0}_calculateBounds(){this._bounds.addFrame(this.transform,0,0,this._width,this._height)}updateTransform(){this.S&&this.N(),super.updateTransform()}updateLayout(){this.S=!0}}class w extends d{constructor(t={}){super(t),this.D=t.width||0,this.A=t.height||0}N(){this._width=this.D,this._height=this.A,this._calculateBounds(),this.S=!1}}class p extends d{constructor(t={}){super(t),this.L=void 0!==t.spacing?t.spacing:c,this.P=void 0!==t.padding?t.padding:c}N(){let t=0,s=this.P;const i=this.P;let h=!0;for(const e of this.children){if(e===this.O)continue;h||(s+=this.L),h=!1,e.position.set(i,s),e.updateTransform();const n=e.getBounds();s+=n.height,t=Math.max(t,n.width)}this._height=s+this.P,this._width=t+2*this.P,this.O.width=this._width,this.O.height=this._height,this._calculateBounds(),this.S=!1}}class g extends d{constructor(t={}){super(t),this.L=void 0!==t.spacing?t.spacing:c,this.P=void 0!==t.padding?t.padding:c}N(){let t=0;const s=this.P;let i=this.P,h=!0;for(const e of this.children){if(e===this.O)continue;h||(i+=this.L),h=!1,e.position.set(i,s),e.updateTransform();const n=e.getBounds();i+=n.width,t=Math.max(t,n.height)}this._width=i+this.P,this._height=t+2*this.P,this.O.width=this._width,this.O.height=this._height,this._calculateBounds(),this.S=!1}}class y extends d{constructor(t={}){super(t),this.R=[],this.C=0,this.$=0,this.L=void 0!==t.spacing?t.spacing:c,this.P=void 0!==t.padding?t.padding:c}setGrid(t,s,i){for(;this.C<=t;){this.R[this.C]=[];for(let t=0;t<this.$;t++)this.R[this.C][t]=null;this.C++}for(;this.$<=s;){for(let t=0;t<this.C;t++)this.R[t][this.$]=null;this.$++}this.S=!0;const h=this.R[t][s];h&&this.removeChild(h),this.R[t][s]=i,i&&this.addChild(i)}N(){var t;const s=[];for(let t=0;t<this.C;t++){s[t]=[];for(let i=0;i<this.$;i++){const h=this.R[t][i];if(h){const e=h.getBounds();s[t][i]=[e.width,e.height]}else s[t][i]=[0,0]}}this._height=this.P;const i=[];for(let t=0;t<this.C;t++){i[t]=0;for(let h=0;h<this.$;h++)i[t]=Math.max(i[t],s[t][h][1]);t>0&&(this._height+=this.L),this._height+=i[t]}this._height+=this.P,this._width=this.P;const h=[];for(let t=0;t<this.$;t++){h[t]=0;for(let i=0;i<this.C;i++)h[t]=Math.max(h[t],s[i][t][0]);t>0&&(this._width+=this.L),this._width+=h[t]}this._width+=this.P;let e=this.P;for(let s=0;s<this.C;s++){let n=this.P;for(let i=0;i<this.$;i++)null===(t=this.R[s][i])||void 0===t||t.position.set(n,e),n+=h[i]+this.L;e+=i[s]+this.L}this.O.width=this._width,this.O.height=this._height,this._calculateBounds(),this.S=!1}}function m(t,s){const i=s||0;if(t[i]>0)return i;const h=function(t,s){for(let i=s-1;i>=0;i--)if(t[i]>0)return i;return null}(t,i);if(null!==h)return h;const e=function(t,s){for(let i=s+1;i<t.length;i++)if(t[i]>0)return i;return null}(t,i);return null!==e?e:null}class v{constructor(t){this.H=[],this.G=[],this.B=[],this.U=-1,this.F=-1,this.W=null,this.j=null,this.K=t}reset(){if(this.unmark(),this.W=m(this.G,this.W),this.j=m(this.B,this.j),null===this.W||null===this.j)this.W=null,this.j=null;else if(!this.cell(this.W,this.j).isSelectable){const t=this.j,s=(s=>{for(let i=s-1;i>=0;i--)if(this.cell(i,t).isSelectable)return i;return null})(this.W);if(null!==s)this.W=s;else{const s=(s=>{for(let i=s+1;i<=this.U;i++)if(this.cell(i,t).isSelectable)return i;return null})(this.W);if(null===s)throw"illegal state";this.W=s}}this.mark()}moveLeft(){var t;if(this.unmark(),null!==this.W&&null!==this.j){const s=this.j;if(0===this.B[s])throw"illegal state: empty column "+s;const i=null===(t=this.selectedCell)||void 0===t?void 0:t.merged,h=this.W,e=t=>t>0?t-1:this.U;for(let t=e(h);t!=h;t=e(t))if(!(null==i?void 0:i.contains(t,s))&&this.cell(t,s).isSelectable){this.W=t;break}}this.mark()}moveRight(){var t;if(this.unmark(),null!==this.W&&null!==this.j){const s=this.j;if(0===this.B[s])throw"illegal state: empty column "+s;const i=null===(t=this.selectedCell)||void 0===t?void 0:t.merged,h=this.W,e=t=>(t+1)%(this.U+1);for(let t=e(h);t!=h;t=e(t))if(!(null==i?void 0:i.contains(t,s))&&this.cell(t,s).isSelectable){this.W=t;break}}this.mark()}moveUp(){var t;if(this.unmark(),null!==this.W&&null!==this.j){const s=this.W;if(0===this.G[s])throw"illegal state: empty row "+s;const i=null===(t=this.selectedCell)||void 0===t?void 0:t.merged,h=this.j,e=t=>t>0?t-1:this.F;for(let t=e(h);t!=h;t=e(t))if(!(null==i?void 0:i.contains(s,t))&&this.cell(s,t).isSelectable){this.j=t;break}}this.mark()}moveDown(){var t;if(this.unmark(),null!==this.W&&null!==this.j){const s=this.W;if(0===this.G[s])throw"illegal state: empty row "+s;const i=null===(t=this.selectedCell)||void 0===t?void 0:t.merged,h=this.j,e=t=>(t+1)%(this.F+1);for(let t=e(h);t!=h;t=e(t))if(!(null==i?void 0:i.contains(s,t))&&this.cell(s,t).isSelectable){this.j=t;break}}this.mark()}select(t,s){this.cell(t,s).isSelectable&&(this.unmark(),this.W=t,this.j=s,this.mark())}unmark(){var t;null===(t=this.selectedCell)||void 0===t||t.unmark()}mark(){var t;null===(t=this.selectedCell)||void 0===t||t.mark()}get selected(){var t;return(null===(t=this.selectedCell)||void 0===t?void 0:t.value)||null}get selectedCell(){if(null!==this.W&&null!==this.j){const t=this.cell(this.W,this.j);return t.merged&&t.isRef?this.cell(t.merged.from_x,t.merged.from_y):t}return null}set(t,s,i,h){if(t<0||s<0)throw`illegal coordinate: ${t}:${s}`;const e=this.cell(t,s);if(e.isRef)throw`cell is ref: ${t}:${s}`;const n=null!==e.value;if(e.value=[i,h],!n)if(e.merged){const t=e.merged;for(let s=t.from_x;s<=t.to_x;s++)for(let i=t.from_y;i<=t.to_y;i++)this.G[s]++,this.B[i]++}else this.G[t]++,this.B[s]++;this.reset()}merge(t,s,i,h){if(t<0||s<0)throw`illegal coordinate: ${t}:${s}`;if(i<1||h<1)throw`illegal size: ${i}:${h}`;const e=new x(t,s,t+i-1,s+h-1),n=this.cell(t,s);if(n.isRef)throw`cell is ref: ${t}:${s}`;if(n.merged)throw"cell is merged: "+JSON.stringify(n.merged);n.merged=e;const r=null!==n.value;for(let i=e.from_x;i<=e.to_x;i++)for(let h=e.from_y;h<=e.to_y;h++)if(i!==t||h!==s){const t=this.cell(i,h);if(t.value)throw`merging cell already has value: ${i}:${h}`;if(t.isRef)throw`merging cell is ref: ${i}:${h}`;t.merged=e,r&&(this.G[i]++,this.B[h]++)}}remove(t,s){if(t<0||s<0)throw`illegal coordinate: ${t}:${s}`;const i=this.cell(t,s);if(i.isRef)throw`cell is ref: ${t}:${s}`;if(i.value)if(i.value=null,i.merged){const t=i.merged;for(let s=t.from_x;s<=t.to_x;s++)for(let i=t.from_y;i<=t.to_y;i++)this.G[s]--,this.B[i]--}else this.G[t]--,this.B[s]--}unmerge(t,s){if(t<0||s<0)throw`illegal coordinate: ${t}:${s}`;const i=this.cell(t,s);if(i.isRef)throw`cell is ref: ${t}:${s}`;if(i.merged){const h=null!==i.value,e=i.merged;i.merged=null;for(let i=e.from_x;i<=e.to_x;i++)for(let n=e.from_y;n<=e.to_y;n++)i===t&&n===s||(this.cell(i,n).merged=null,h&&(this.G[i]--,this.B[n]--))}}cell(t,s){if(t<0||s<0)throw"illegal coordinate";return this.expand(t,s),this.H[s][t]}expand(t,s){for(;this.F<s;){this.F++,this.B[this.F]=0,this.H[this.F]=[];for(let t=0;t<=this.U;t++)this.H[this.F][t]=new b(t,this.F)}for(;this.U<t;){this.U++,this.G[this.U]=0;for(let t=0;t<=this.F;t++)this.H[t][this.U]=new b(this.U,t)}}handleInput(){const s=this.K;if(s.moveUp.once()&&this.moveUp(),s.moveDown.once()&&this.moveDown(),s.moveLeft.once()&&this.moveLeft(),s.moveRight.once()&&this.moveRight(),s.hit.once()){const s=this.selected;if(s){const[,i]=s;t.sound.play("confirm"),i()}else t.sound.play("cancel")}}}class b{constructor(t,s){this.x=t,this.y=s,this.merged=null,this.value=null}unmark(){this.value&&(this.value[0].selected=!1)}mark(){this.value&&(this.value[0].selected=!0)}get isRef(){return null!==this.merged&&!(this.merged.from_x===this.x&&this.merged.from_y===this.y)}get isSelectable(){return null!==this.value||this.isRef}}class x{constructor(t,s,i,h){this.from_x=t,this.from_y=s,this.to_x=i,this.to_y=h}contains(t,s){return t>=this.from_x&&t<=this.to_x&&s>=this.from_y&&s<=this.to_y}}class _ extends p{constructor(s,h){super({backgroundColor:i}),this.t=s,this.X=new v(s.joystick);const e=new g({padding:0});this.addChild(e),this.V=new f({label:"X",width:40,height:32}),e.addChild(this.V),this.X.set(0,0,this.V,()=>this.t.closeModal()),this.q=new t.BitmapText(h,{font:{name:"alagard",size:32}}),e.addChild(this.q)}init(){this.t.ticker.add(this.X.handleInput,this.X)}destroy(){this.t.ticker.remove(this.X.handleInput,this.X),super.destroy({children:!0})}}const M=2.3283064365386963e-10;class k{constructor(t){if(t<=1)throw"Illegal seed number";return this.Y=(t>>>0)*M,t=69069*t+1>>>0,this.J=t*M,t=69069*t+1>>>0,this.Z=t*M,this.tt=1,this}static create(){const t=crypto.getRandomValues(new Uint32Array(1))[0];return new k(t)}static seeded(t){return new k(t)}float(){const t=2091639*this.Y+this.tt*M;return this.Y=this.J,this.J=this.Z,this.tt=0|t,this.Z=t-this.tt,this.Z}int(){return 4294967296*this.float()}boolean(){return this.float()<.5}range(t,s){return Math.floor(this.float()*(s-t))+t}normal(t=0,s=1){let i,h,e;do{i=2*this.float()-1,h=2*this.float()-1,e=i*i+h*h}while(e>1||0==e);return t+i*Math.sqrt(-2*Math.log(e)/e)*s}skewNormal(t,s,i){let h=0,e=0;for(;0===h;)h=this.float();for(;0===e;)e=this.float();let n=Math.sqrt(-2*Math.log(h))*Math.cos(2*Math.PI*e);return n=n/10+.5,(n>1||n<0)&&(n=this.skewNormal(t,s,i)),n=Math.pow(n,i),n*=s-t,n+=t,n}select(t){return 0===t.length?null:t[Math.floor(this.float()*t.length)]}}class I{constructor(t,s){this.st=0,this.it=0,this.code=t,this.ht=!1,this.et=!0,s[t]=this}get triggered(){return this.ht}get startedAt(){return this.st}get finishedAt(){return this.it}get duration(){return this.it-this.st}once(){return!this.et&&(this.et=!0,!0)}repeat(){return this.et?this.ht:(this.et=!0,!0)}keydown(t){t.repeat||t.code!==this.code||(t.preventDefault(),this.st=t.timeStamp,this.it=0,this.ht=!0,this.et=!1)}keyup(t){t.repeat||t.code!==this.code||(t.preventDefault(),this.it=t.timeStamp,this.ht=!1)}}class S{constructor(){this.nt={},this.moveUp=new I("KeyW",this.nt),this.moveLeft=new I("KeyA",this.nt),this.moveDown=new I("KeyS",this.nt),this.moveRight=new I("KeyD",this.nt),this.hit=new I("KeyF",this.nt),this.dodge=new I("Space",this.nt),this.drop=new I("KeyQ",this.nt),this.inventory=new I("KeyI",this.nt),this.stats=new I("KeyP",this.nt),this.digit1=new I("Digit1",this.nt),this.digit2=new I("Digit2",this.nt),this.digit3=new I("Digit3",this.nt),this.digit4=new I("Digit4",this.nt),this.digit5=new I("Digit5",this.nt),this.digit6=new I("Digit6",this.nt),this.digit7=new I("Digit7",this.nt),this.digit8=new I("Digit8",this.nt),this.digit9=new I("Digit9",this.nt),this.digit0=new I("Digit0",this.nt),window.addEventListener("keydown",this.keydown.bind(this)),window.addEventListener("keyup",this.keyup.bind(this))}get direction(){const t=this.moveLeft.triggered?1:0,s=this.moveRight.triggered?1:0,i=this.moveUp.triggered?1:0;return[s-t,(this.moveDown.triggered?1:0)-i]}digit(t){switch(t){case 1:return this.digit1;case 2:return this.digit2;case 3:return this.digit3;case 4:return this.digit4;case 5:return this.digit5;case 6:return this.digit6;case 7:return this.digit7;case 8:return this.digit8;case 9:return this.digit9;case 0:return this.digit0}}keydown(t){var s;null===(s=this.nt[t.code])||void 0===s||s.keydown(t)}keyup(t){var s;null===(s=this.nt[t.code])||void 0===s||s.keyup(t)}}class O{constructor(t){this.rt={},this.ot={},this.loader=t}async load(){return await new Promise(s=>{this.loader.add("spritesheets/npc.json").add("spritesheets/dungeon.json").add("spritesheets/bonfire.json").add("dungeon.rules.json").add("dungeon.design.json").add("dialogs.json").add("npc.config.json").add("weapon.config.json").add("monster.config.json").add("alagard","fonts/alagard.fnt").add("big_egg_collect","sounds/big_egg_collect.{ogg,mp3}").add("fruit_collect","sounds/fruit_collect.{ogg,mp3}").add("select","sounds/select.{ogg,mp3}").add("confirm","sounds/confirm.{ogg,mp3}").add("cancel","sounds/cancel.{ogg,mp3}").add("text","sounds/text.{ogg,mp3}").add("boss_hit","sounds/boss_hit.{ogg,mp3}").add("hit_damage","sounds/hit_damage.{ogg,mp3}").load((i,h)=>{h["fonts/alagard.png"].texture.baseTexture.scaleMode=t.SCALE_MODES.NEAREST,this.add(h["spritesheets/npc.json"].spritesheet),this.add(h["spritesheets/dungeon.json"].spritesheet),this.add(h["spritesheets/bonfire.json"].spritesheet),s()})})}add(s){s.baseTexture.scaleMode=t.SCALE_MODES.NEAREST;for(const t of Object.keys(s.textures))this.rt[t]=s.textures[t];for(const t of Object.keys(s.animations))this.ot[t]=s.animations[t]}texture(t){const s=this.rt[t];if(!s)throw"texture not found: "+t;return s}sprite(s){const i=new t.Sprite(this.texture(s));return i.name=s,i}animation(t){const s=this.ot[t];if(!s)throw"animation not found: "+t;return[...s]}animatedSprite(s,i={}){const h=new t.AnimatedSprite(this.animation(s));return h.name=s,h.autoUpdate=void 0===i.autoUpdate||i.autoUpdate,h.animationSpeed=void 0!==i.animationSpeed?i.animationSpeed:.2,h.loop=void 0===i.loop||i.loop,(void 0===i.play||i.play)&&h.play(),h}spriteOrAnimation(t,s={}){if(this.rt[t])return this.sprite(t);if(this.ot[t])return this.animatedSprite(t,s);throw"sprite or animation not found: "+t}}class N extends s{constructor(t){super(t)}init(){const s=new t.BitmapText("ROGUELIKE DUNGEON",{font:{name:"alagard",size:64}});s.anchor=new t.Point(.5,0),s.position.set(this.t.screen.width>>1,64),this.addChild(s);const i=new t.BitmapText("YOU DEAD",{font:{name:"alagard",size:128},tint:16711680});i.anchor=.5,i.position.set(this.t.screen.width>>1,256),this.addChild(i);const h=new t.BitmapText("PRESS F TO RESTART",{font:{name:"alagard",size:32}});h.anchor=.5,h.position.set(this.t.screen.width>>1,this.t.screen.height-64),this.addChild(h),this.t.ticker.add(this.handleInput,this)}destroy(){this.t.ticker.remove(this.handleInput,this),super.destroy({children:!0})}pause(){}resume(){}handleInput(){this.t.joystick.hit.once()&&this.t.selectHero()}}class D{constructor(t){this.name=t.name,this.speed=t.speed,this.distance=t.distance,this.damage=t.damage,this.stamina=t.stamina,this.lt=t.price,this.animations=t.animations}get spriteName(){return`weapon_${this.name}.png`}info(){return{name:this.name,speed:this.speed,distance:this.distance,stamina:this.stamina,damage:this.damage,sellPrice:this.lt,buyPrice:10*this.lt}}pickedUp(t){return t.inventory.add(this)}same(){return!1}use(t){t.equip()}}class E{constructor(t){this.t=t}init(){this.at=this.t.loader.resources["weapon.config.json"].data}animation(t){const s=this.at.animations[t];if(!s)throw"Animation not found";return s}animations(t){return{idle:this.animation(t.idle),run:this.animation(t.run),hit:t.hit.map(t=>this.animation(t))}}weapon(t){return new D({name:t.name,speed:t.speed,distance:t.distance,damage:t.damage,stamina:t.stamina,level:t.level,price:t.price,animations:this.animations(t.animations)})}randomHeroWeapon(t){const s=this.heroWeapons(t.level),i=t.rng.select(s);return i?this.weapon(i):null}heroWeapons(t){return Object.keys(this.at.weapons.hero).map(t=>this.at.weapons.hero[t]).filter(s=>s.level<=t)}heroWeapon(t){const s=this.at.weapons.hero[t];if(!s)throw"Hero weapon config not found: "+t;return this.weapon(s)}npcWeapon(t){const s=this.at.weapons.npc[t];if(!s)throw"Npc weapon config not found: "+t;return this.weapon(s)}monsterWeapon(t){const s=this.at.weapons.monster[t];if(!s)throw"Monster weapon config not found: "+t;return this.weapon(s)}}class T extends t.Container{constructor(t){super(),this.ct=null,this.ut=t}destroy(){var t;null===(t=this.ct)||void 0===t||t.destroy(),this.ct=null,super.destroy()}setWeapon(t){var s;null===(s=this.ct)||void 0===s||s.destroy(),this.ct=null,t&&(this.ct=this.ut.spriteOrAnimation(t.spriteName),this.ct.anchor.set(.5,1),this.addChild(this.ct))}setAngle(t){this.ct&&(this.ct.angle=t)}setPosition(t,s){this.ct&&this.ct.position.set(t,s)}}class A{constructor(t){this.ft=t}deserialize(t){const s=JSON.parse(t);switch(s.type){case"HealthFlask":return new P;case"HealthBigFlask":return new R;case"Weapon":return this.ft.heroWeapon(s.name)}}serialize(t){let s;if(t instanceof P)s={type:"HealthFlask"};else if(t instanceof R)s={type:"HealthBigFlask"};else{if(!(t instanceof D))throw"unexpected value";s={type:"Weapon",name:t.name}}return JSON.stringify(s)}}class L{constructor(t){this.spriteName="coin",this.dt=t.range(1,30)}pickedUp(t){return t.coins.update(t=>t+this.dt),!0}}class P{constructor(){this.spriteName="flask_red.png",this.wt=2}info(){return{name:"Health flask",health:this.wt,buyPrice:100}}pickedUp(t){return t.inventory.add(this)}same(t){return t instanceof P}use(t,s){s.health.update(t=>Math.min(s.healthMax.get(),t+this.wt)),t.decrease()}}class R{constructor(){this.spriteName="flask_big_red.png",this.wt=5}info(){return{name:"Big health flask",health:this.wt,buyPrice:300}}pickedUp(t){return t.inventory.add(this)}same(t){return t instanceof R}use(t,s){s.heal(this.wt),t.decrease()}}class C{constructor(t){this.pt=[],this.gt=0,this.yt=0,this.vt=2,this.t=t}add(t){this.pt.push(t);const s=this.t.screen,i=(s.width>>1)-this.gt*this.vt,h=(s.height>>1)-this.yt*this.vt;t.position.set(i,h),t.scale.set(this.vt,this.vt)}set scale(t){this.vt=t;for(const s of this.pt)s.scale.set(t,t)}setPosition(t,s){this.gt=t,this.yt=s;const i=this.t.screen,h=(i.width>>1)-this.gt*this.vt,e=(i.height>>1)-this.yt*this.vt;for(const t of this.pt)t.position.set(h,e)}}class ${constructor(t,s){this.bt=t,this.static=s.static,this.interacting=s.interacting,this.height=s.height,this.width=s.width,this.bt.register(this)}destroy(){this.bt.unregister(this)}collide(t){return!1}interact(t){}}class z{constructor(){this.xt=[]}query(t){let s=this.xt.filter(t.type);return t.filter&&(s=s.filter(t.filter)),t.sort&&s.sort(t.sort),s}register(t){if(t.interacting||!t.static){this.xt.push(t);const s={};for(const t of this.xt)s[t.constructor.name]=(s[t.constructor.name]||0)+1}}unregister(t){const s=this.xt.indexOf(t);s>=0&&this.xt.splice(s,1)}}class H extends ${constructor(t,s,i,h){super(t.registry,{width:1,height:1,static:!1,interacting:!1}),this.x=s,this.y=i,this.drop=h,this._t=t,this.ct=t.sprite(s,i,h.spriteName),this.ct.zIndex=Y.drop+i*Y.row,this.ct.x+=8,this.ct.y+=14,this.ct.anchor.set(.5,1)}pickedUp(t){return!!this.drop.pickedUp(t.state)&&(this._t.cell(this.x,this.y).dropItem=null,!0)}destroy(){super.destroy(),this.ct.destroy()}}class G extends ${constructor(s,i,h,e,n=!1){super(s.registry,{width:1,height:1,static:!0,interacting:n}),this.x=i,this.y=h,this.name=e,this._t=s,this.ct=this._t.controller.resources.spriteOrAnimation(e),this.ct.zIndex=Y.floor,this.ct.position.set(16*i,16*h),this.ct instanceof t.AnimatedSprite?this._t.layer.addChild(this.ct):this._t.floorContainer.addChild(this.ct)}destroy(){super.destroy(),this.ct.destroy()}}class B extends G{constructor(t,s,i){super(t,s,i,"floor_ladder.png",!0)}interact(t){this._t.controller.generateDungeon({level:this._t.level+1,hero:t.state.name})}}class U{constructor(t,s){this.begin=!1,this.angle=0,this.point=t,this.segment=s}}var F;(t=>{t[t.NORMAL=0]="NORMAL",t[t.TOP=1]="TOP"})(F||(F={}));class W{constructor(t,s,i){this.distance=0,this.p1=new U(t,this),this.p2=new U(s,this),this.type=i}toString(){const t=this.p1.point,s=this.p2.point;return`[${t.x}:${t.y} - ${s.x}:${s.y}]`}}class j{constructor(){this.Mt=[],this.kt=[],this.It=new t.Point(0,0),this.St=500}init(){this.Mt=[],this.kt=[],this.It=new t.Point(0,0)}addSegment(s,i,h,e,n){const r=new t.Point(s,i),o=new t.Point(h,e),l=new W(r,o,n);this.Mt.push(l),this.kt.push(l.p1),this.kt.push(l.p2)}static deduplicated(t){const s=[];for(;t.length>0;){const i=t.pop(),h=[];for(let s=0;s<t.length;s++){const e=t[s],n=i.type===e.type,r=i.p1.point.equals(e.p1.point)&&i.p2.point.equals(e.p2.point);n&&r&&h.push(s)}for(const s of h)t.splice(s,1);s.push(i)}return s}static connected(t){const s=[];for(let i=0;i<t.length;i++){const h=t[i];let e=!1,n=!1;for(let r=0;r<t.length;r++){if(r==i)continue;const o=t[r];if((!h.p1.point.equals(o.p1.point)||!h.p2.point.equals(o.p2.point))&&(e||!h.p1.point.equals(o.p1.point)&&!h.p1.point.equals(o.p2.point)||(e=!0),n||!h.p2.point.equals(o.p1.point)&&!h.p2.point.equals(o.p2.point)||(n=!0),e&&n)){s.push(h);break}}}return s}static filtered(t){const s=[],i=[],h=[[0,12,0,16],[5,12,5,16],[0,12,5,12],[0,0,5,0],[11,12,11,16],[11,12,16,12],[11,0,16,0]],e=t=>{const s=t.p1.point.x%16,i=t.p1.point.y%16,e=t.p2.point.x-t.p1.point.x+s,n=t.p2.point.y-t.p1.point.y+i;for(const[t,r,o,l]of h)if(t===s&&r===i&&o===e&&l===n)return!0;return!1};for(const h of t)e(h)?i.push(h):s.push(h);for(;i.length>0;){const t=i.pop(),h=[t],e=[t.p1.point,t.p2.point],n=[1,1],r=[];for(let t=0;t<2;t++)for(let t=0;t<i.length;t++){if(r.indexOf(t)>=0)continue;const s=i[t],o=s.p1.point,l=s.p2.point;let a=!1,c=!1;for(let t=0;t<e.length;t++){const s=e[t];s.equals(o)?(a=!0,n[t]++):s.equals(l)&&(c=!0,n[t]++)}(a||c)&&(r.push(t),h.push(s),a||(e.push(o),n.push(1)),c||(e.push(l),n.push(1)))}if(4===n.length&&n.every(t=>2===t)){let t=0,e=0;for(let s=0;s<4;s++){const i=h[s];i.p1.point.y===i.p2.point.y&&i.p1.point.y>e&&(t=s,e=i.p1.point.y)}for(const t of r.reverse())i.splice(t,1);h.splice(t,1),s.push(...h)}else s.push(t)}return s}static merge(t){const s=[];for(;t.length>0;){const i=t.pop();let h=null;for(let s=0;s<t.length;s++){const e=t[s];if(i.type===e.type){if(i.p2.point.equals(e.p1.point)){t.splice(s,1),h=[i,e];break}if(e.p2.point.equals(i.p1.point)){t.splice(s,1),h=[e,i];break}}}if(h){const[s,i]=h;t.push(new W(s.p1.point,i.p2.point,s.type))}else s.push(i)}return s}optimize(){const t=j.deduplicated([...this.Mt]),s=j.connected(t),i=j.filtered(s),h=j.connected(i),e=[...j.merge(h.filter(t=>t.p1.point.x===t.p2.point.x)),...j.merge(h.filter(t=>t.p1.point.y===t.p2.point.y))];this.Mt=[],this.kt=[];for(const t of e)this.Mt.push(t),this.kt.push(t.p1),this.kt.push(t.p2)}setLightLocation(t,s,i){this.It.x=t,this.It.y=s,this.St=i,this.kt=[];for(const h of this.Mt){const e=.5*(h.p1.point.x+h.p2.point.x)-t,n=.5*(h.p1.point.y+h.p2.point.y)-s;if(h.distance=Math.sqrt(e*e+n*n),h.distance<i){h.p1.angle=Math.atan2(h.p1.point.y-s,h.p1.point.x-t),h.p2.angle=Math.atan2(h.p2.point.y-s,h.p2.point.x-t);let i=h.p2.angle-h.p1.angle;i<=-Math.PI&&(i+=2*Math.PI),i>Math.PI&&(i-=2*Math.PI),h.p1.begin=i>0,h.p2.begin=!h.p1.begin,this.kt.push(h.p1,h.p2)}}this.kt.sort(j.compare)}static compare(t,s){return t.angle>s.angle?1:t.angle<s.angle?-1:!t.begin&&s.begin?1:t.begin&&!s.begin?-1:0}static leftOf(t,s){return(t.p2.point.x-t.p1.point.x)*(s.y-t.p1.point.y)-(t.p2.point.y-t.p1.point.y)*(s.x-t.p1.point.x)<0}static interpolate(s,i,h){return new t.Point(s.x*(1-h)+i.x*h,s.y*(1-h)+i.y*h)}static segmentInFrontOf(t,s,i){const h=j.leftOf(t,j.interpolate(s.p1.point,s.p2.point,.01)),e=j.leftOf(t,j.interpolate(s.p2.point,s.p1.point,.01)),n=j.leftOf(t,i),r=j.leftOf(s,j.interpolate(t.p1.point,t.p2.point,.01)),o=j.leftOf(s,j.interpolate(t.p2.point,t.p1.point,.01)),l=j.leftOf(s,i);return r==o&&o!=l||h==e&&e==n}sweep(){const t=[],s=[];let i=0;for(let h=0;h<=2;h++)for(const e of this.kt){const n=0===s.length?null:s[0];if(e.begin){let t=0,i=s[t];for(;null!=i&&j.segmentInFrontOf(e.segment,i,this.It);)t++,i=s[t];null==i?s.push(e.segment):s.splice(t,0,e.segment)}else for(let t=0;t<s.length;t++)s[t]===e.segment&&s.splice(t,1);n!==(0===s.length?null:s[0])&&(1==h&&this.addTriangle(i,e.angle,n,t),i=e.angle)}const h=[...t],e=[];for(;h.length>0;){if(h.length>=2){const[t,s]=h;if(t.equals(s)){h.shift();continue}}const t=h.shift();e.push(t)}const n=[];for(;e.length>0;){if(e.length>=3){const[t,s,i]=e;if(t.x===s.x&&t.x===i.x){e.splice(1,1);continue}}const t=e.shift();n.push(t)}return n}static lineIntersection(s,i,h,e){const n=(e.x-h.x)*(s.y-h.y)-(e.y-h.y)*(s.x-h.x),r=(e.y-h.y)*(i.x-s.x)-(e.x-h.x)*(i.y-s.y);if(0===r)return null;const o=n/r;return new t.Point(s.x+o*(i.x-s.x),s.y+o*(i.y-s.y))}addTriangle(s,i,h,e){const n=Math.cos(s),r=Math.sin(s),o=Math.cos(i),l=Math.sin(i),a=this.It,c=new t.Point(this.It.x+n,this.It.y+r),u=new t.Point(0,0),f=new t.Point(0,0);null!=h?(u.x=h.p1.point.x,u.y=h.p1.point.y,f.x=h.p2.point.x,f.y=h.p2.point.y):(u.x=this.It.x+n*this.St,u.y=this.It.y+r*this.St,f.x=this.It.x+o*this.St,f.y=this.It.y+l*this.St);const d=j.lineIntersection(u,f,a,c);if(null===d)return;d.x=Math.round(d.x),d.y=Math.round(d.y),c.x=this.It.x+o,c.y=this.It.y+l;const w=j.lineIntersection(u,f,a,c);if(null!==w)if(w.x=Math.round(w.x),w.y=Math.round(w.y),null!=h)switch(h.type){case F.TOP:e.push(d),e.push(new t.Point(d.x,d.y-16)),e.push(new t.Point(w.x,w.y-16)),e.push(w);break;case F.NORMAL:e.push(d),e.push(w)}else e.push(d),e.push(w)}debug(){const t=document.createElement("canvas");t.width=1280,t.height=1280;const s=t.getContext("2d");s.fillRect(0,0,1280,1280),s.scale(1,1);const i=new Path2D;for(const t of this.Mt){const s=t.p1.point,h=t.p2.point;i.moveTo(s.x,s.y),i.lineTo(h.x,h.y)}s.strokeStyle="rgba(255,0,0,0.5)",s.stroke(i)}}class K{constructor(s){this.Ot=[],this.Nt={default:[{x1:0,y1:12,x2:16,y2:12,type:F.NORMAL},{x1:0,y1:12,x2:0,y2:16,type:F.NORMAL},{x1:16,y1:12,x2:16,y2:16,type:F.NORMAL}],top:[{x1:0,y1:0,x2:16,y2:0,type:F.TOP}],left:[{x1:0,y1:0,x2:0,y2:12,type:F.NORMAL}],right:[{x1:16,y1:0,x2:16,y2:12,type:F.NORMAL}],bottom:[]},this.Dt={default:[{x1:11,y1:0,x2:11,y2:16,type:F.NORMAL},{x1:11,y1:0,x2:16,y2:0,type:F.NORMAL},{x1:11,y1:16,x2:16,y2:16,type:F.TOP}],top:[{x1:0,y1:0,x2:11,y2:0,type:F.TOP}],left:[{x1:0,y1:0,x2:0,y2:16,type:F.NORMAL}],right:[],bottom:[{x1:0,y1:16,x2:11,y2:16,type:F.NORMAL}]},this.Et={default:[{x1:5,y1:0,x2:5,y2:16,type:F.NORMAL},{x1:0,y1:0,x2:5,y2:0,type:F.NORMAL},{x1:0,y1:16,x2:5,y2:16,type:F.TOP}],top:[{x1:5,y1:0,x2:16,y2:0,type:F.TOP}],left:[],right:[{x1:16,y1:0,x2:16,y2:16,type:F.NORMAL}],bottom:[{x1:5,y1:16,x2:16,y2:16,type:F.NORMAL}]},this.Tt={default:[{x1:5,y1:0,x2:5,y2:12,type:F.NORMAL},{x1:5,y1:12,x2:16,y2:12,type:F.NORMAL},{x1:16,y1:12,x2:16,y2:16,type:F.NORMAL}],top:[{x1:5,y1:0,x2:16,y2:0,type:F.TOP}],left:[],right:[{x1:16,y1:0,x2:16,y2:12,type:F.NORMAL}],bottom:[]},this.At={default:[{x1:11,y1:0,x2:11,y2:12,type:F.NORMAL},{x1:0,y1:12,x2:11,y2:12,type:F.NORMAL},{x1:0,y1:12,x2:0,y2:16,type:F.NORMAL}],top:[{x1:0,y1:0,x2:11,y2:0,type:F.TOP}],left:[{x1:0,y1:0,x2:0,y2:12,type:F.NORMAL}],right:[],bottom:[]},this.Lt={default:[],top:[{x1:0,y1:0,x2:16,y2:0,type:F.TOP}],left:[{x1:0,y1:0,x2:0,y2:16,type:F.NORMAL}],right:[{x1:16,y1:0,x2:16,y2:16,type:F.NORMAL}],bottom:[{x1:0,y1:16,x2:16,y2:16,type:F.NORMAL}]},this.at={"wall_top_mid.png":this.Nt,"wall_side_front_left.png":this.Dt,"wall_side_front_right.png":this.Et,"wall_side_mid_left.png":this.Dt,"wall_side_mid_right.png":this.Et,"wall_side_top_left.png":{default:[{x1:11,y1:12,x2:16,y2:12,type:F.NORMAL},{x1:11,y1:12,x2:11,y2:16,type:F.NORMAL}],top:[{x1:0,y1:0,x2:16,y2:0,type:F.TOP}],left:[{x1:0,y1:0,x2:0,y2:16,type:F.NORMAL}],right:[{x1:16,y1:0,x2:16,y2:12,type:F.NORMAL}],bottom:[{x1:0,y1:16,x2:11,y2:16,type:F.NORMAL}]},"wall_side_top_right.png":{default:[{x1:0,y1:12,x2:5,y2:12,type:F.NORMAL},{x1:5,y1:12,x2:5,y2:16,type:F.NORMAL}],top:[{x1:0,y1:0,x2:16,y2:0,type:F.TOP}],left:[{x1:0,y1:12,x2:0,y2:16,type:F.NORMAL}],right:[{x1:16,y1:0,x2:16,y2:16,type:F.NORMAL}],bottom:[{x1:5,y1:16,x2:16,y2:16,type:F.NORMAL}]},"wall_inner_corner_t_top_left.png":this.Nt,"wall_inner_corner_t_top_right.png":this.Nt,"wall_inner_corner_l_top_left.png":this.Tt,"wall_inner_corner_l_top_right.png":this.At,"wall_corner_bottom_left.png":this.Tt,"wall_corner_bottom_right.png":this.At,"wall_corner_top_left.png":this.Nt,"wall_corner_top_right.png":this.Nt,"wall_fountain_top.png":{default:[{x1:0,y1:12,x2:0,y2:16,type:F.NORMAL},{x1:0,y1:12,x2:2,y2:12,type:F.NORMAL},{x1:2,y1:9,x2:2,y2:12,type:F.NORMAL},{x1:2,y1:9,x2:14,y2:9,type:F.NORMAL},{x1:14,y1:9,x2:14,y2:12,type:F.NORMAL},{x1:14,y1:12,x2:16,y2:12,type:F.NORMAL},{x1:16,y1:12,x2:16,y2:16,type:F.NORMAL}],top:[{x1:0,y1:0,x2:16,y2:0,type:F.TOP}],left:[{x1:0,y1:0,x2:0,y2:12,type:F.NORMAL}],right:[{x1:16,y1:0,x2:16,y2:12,type:F.NORMAL}],bottom:[]},"wall_one_top.png":this.Nt,"wall_one_corner_left.png":this.Tt,"wall_one_corner_right.png":this.At},this._t=s,this.layer=new t.display.Layer,this.layer.useRenderTexture=!0,this.layer.on("display",s=>{s.blendMode=t.BLEND_MODES.MULTIPLY}),this.layer.clearColor=[0,0,0,1],this.shadow=new t.Sprite(this.layer.getRenderTexture()),this.shadow.blendMode=t.BLEND_MODES.MULTIPLY,this.Pt=K.gradient("white",150),this.Rt=K.gradient("rgb(211,78,56)",50),this.Ct=K.gradient("rgb(86,152,204)",50),this.$t=K.gradient("rgb(255,239,204)",100),this.zt=new j,this._t.ticker.add(this.update,this)}destroy(){this._t.ticker.remove(this.update,this),this.Ot.forEach(t=>t.destroy()),this.Pt.destroy(),this.Ct.destroy(),this.Rt.destroy(),this.$t.destroy(),this.layer.destroy(),this.shadow.destroy()}loadMap(){this.zt.init();const s=this._t;for(let i=0;i<s.height;i++)for(let h=0;h<s.width;h++){const e=s.cell(h,i);if(e.hasFloor){const n=new t.Point(16*h,16*i);switch(e.floorName){case"wall_fountain_basin_red":this.addLight(n,X.RED_BASIN);break;case"wall_fountain_basin_blue":this.addLight(n,X.BLUE_BASIN)}const r=i>0&&s.cell(h,i-1).hasFloor,o=i+1<s.height&&s.cell(h,i+1).hasFloor,l=h>0&&s.cell(h-1,i).hasFloor,a=h+1<s.width&&s.cell(h+1,i).hasFloor;let c;const u=e.wallName;c=u&&this.at[u]&&this.at[u]||this.Lt,this.add(h,i,c.default),r||this.add(h,i,c.top),o||this.add(h,i,c.bottom),l||this.add(h,i,c.left),a||this.add(h,i,c.right)}}this.zt.optimize(),this.update()}addLight(t,s){let i,h;switch(s){case X.HERO:i=this.Pt,h=350;break;case X.RED_BASIN:i=this.Rt,h=150;break;case X.BLUE_BASIN:i=this.Ct,h=150;break;case X.BONFIRE:i=this.$t,h=250}const e=new V(t,h,i);this.layer.addChild(e.mask),this.layer.addChild(e.sprite),this.Ot.push(e),this.renderLight(e)}add(t,s,i){for(const h of i)this.zt.addSegment(16*t+h.x1,16*s+h.y1,16*t+h.x2,16*s+h.y2,h.type)}update(){for(const t of this.Ot)t.dirty&&(this.renderLight(t),t.rendered())}renderLight(s){const i=new t.Point(s.position.x+8,s.position.y+8);this.zt.setLightLocation(i.x,i.y,s.maxDistance);const h=this.zt.sweep();s.sprite.position.set(i.x,i.y),s.mask.clear().beginFill(16777215).drawPolygon(h).endFill()}static gradient(s,i){const h=i<<1,e=document.createElement("canvas");e.width=h,e.height=h;const n=e.getContext("2d");if(n){const t=n.createRadialGradient(i,i,0,i,i,i);t.addColorStop(.1,s),t.addColorStop(1,"transparent"),n.fillStyle=t,n.fillRect(0,0,h,h)}return t.Texture.from(e)}}var X;(t=>{t[t.HERO=0]="HERO",t[t.RED_BASIN=1]="RED_BASIN",t[t.BLUE_BASIN=2]="BLUE_BASIN",t[t.BONFIRE=3]="BONFIRE"})(X||(X={}));class V{constructor(s,i,h){this.Ht=null,this.position=s,this.maxDistance=i,this.mask=new t.Graphics,this.mask.isMask=!0,this.sprite=new t.Sprite(h),this.sprite.anchor.set(.5,.5),this.sprite.mask=this.mask,this.sprite.blendMode=t.BLEND_MODES.ADD}get dirty(){return null===this.Ht||this.position.x!==this.Ht.x||this.position.y!==this.Ht.y}rendered(){this.Ht={x:this.position.x,y:this.position.y}}destroy(){this.sprite.destroy(),this.mask.destroy()}}class q extends ${constructor(t,s,i,h){super(t.registry,{width:1,height:1,static:!0,interacting:!1}),this.x=s,this.y=i,this.name=h,this._t=t,this.ct=t.sprite(s,i,h),this.ct.zIndex=Y.wall+i*Y.row}collide(t){return!this._t.cell(this.x,this.y).hasFloor}destroy(){super.destroy(),this.ct.destroy()}}const Y={character:60,hero:70,drop:50,static:40,floor:1,wall:100,row:256};class J{constructor(s,i,h,e,n,r,o){this.scale=2,this.controller=s,this.ticker=i,this.rng=h,this.seed=e,this.level=n,this.width=r,this.height=o,this.H=[];for(let t=0;t<this.width;t++){this.H[t]=[];for(let s=0;s<this.height;s++)this.H[t][s]=new Q(this,s,t)}this.layer=new t.display.Layer,this.layer.sortableChildren=!0,this.floorContainer=new t.Container,this.floorContainer.zIndex=Y.floor,this.floorContainer.sortableChildren=!1,this.floorContainer.cacheAsBitmap=!0,this.layer.addChild(this.floorContainer),this.light=new K(this),this.camera=new C(s),this.camera.add(this.layer),this.camera.add(this.light.layer),this.registry=new z}destroy(){for(let t=0;t<this.height;t++)for(let s=0;s<this.width;s++)this.H[t][s].destroy();this.light.destroy(),this.layer.destroy({children:!0})}log(t){}cell(t,s){return this.H[s][t]}remove(t,s,i){for(let h=0;h<i.width;h++)for(let e=0;e<i.height;e++){const n=this.cell(t+h,s-e),r=n.object;r&&r===i&&(n.object=null)}}set(t,s,i){for(let h=0;h<i.width;h++)for(let e=0;e<i.height;e++)this.cell(t+h,s-e).object=i}available(t,s,i){for(let h=0;h<i.width;h++)for(let e=0;e<i.height;e++){const n=this.cell(t+h,s-e);if(!n.hasFloor||n.collide(i))return!1}return!0}sprite(t,s,i){const h=this.controller.resources.spriteOrAnimation(i);return h.position.set(16*t,16*s),this.layer.addChild(h),h}animated(t,s,i){const h=this.controller.resources.animatedSprite(i);return h.position.set(16*t,16*s),h.play(),this.layer.addChild(h),h}}class Q{constructor(t,s,i){this.Gt=null,this.Bt=null,this.Ut=null,this.Ft=null,this._t=t,this.x=s,this.y=i}destroy(){var t,s,i,h;null===(t=this.Gt)||void 0===t||t.destroy(),this.Gt=null,null===(s=this.Bt)||void 0===s||s.destroy(),this.Bt=null,null===(i=this.Ut)||void 0===i||i.destroy(),this.Ut=null,null===(h=this.Ft)||void 0===h||h.destroy(),this.Ft=null}set floorName(t){var s;null===(s=this.Gt)||void 0===s||s.destroy(),this.Gt=null,t&&(this.Gt=new G(this._t,this.x,this.y,t))}get floorName(){var t;return(null===(t=this.Gt)||void 0===t?void 0:t.name)||null}get floor(){return this.Gt}get hasFloor(){return!!this.Gt}get wallName(){var t;return(null===(t=this.Bt)||void 0===t?void 0:t.name)||null}set wallName(t){var s;null===(s=this.Bt)||void 0===s||s.destroy(),this.Bt=null,t&&(this.Bt=new q(this._t,this.x,this.y,t))}get wall(){return this.Bt}set dropItem(t){var s;null===(s=this.Ut)||void 0===s||s.destroy(),this.Ut=null,t&&(this.Ut=new H(this._t,this.x,this.y,t))}get drop(){return this.Ut}get hasDrop(){return!!this.Ut}randomDrop(){const t=this._t.rng;let s=170*t.float();return(s-=20)<=0?this.dropItem=this._t.controller.weaponManager.randomHeroWeapon(this._t):(s-=30)<=0?this.dropItem=new R:(s-=50)<=0?this.dropItem=new P:s-70<=0&&(this.dropItem=new L(t)),this.hasDrop}get object(){return this.Ft}set object(t){if(t&&null!==this.Ft&&this.Ft!==t)throw"error while set object to cell";this.Ft=t}get hasObject(){return null!=this.Ft}ladder(){var t;null===(t=this.Gt)||void 0===t||t.destroy(),this.Gt=new B(this._t,this.x,this.y)}get interacting(){var t,s,i,h;return(null===(t=this.Gt)||void 0===t?void 0:t.interacting)||(null===(s=this.Bt)||void 0===s?void 0:s.interacting)||(null===(i=this.Ut)||void 0===i?void 0:i.interacting)||(null===(h=this.Ft)||void 0===h?void 0:h.interacting)||!1}interact(t){this.Ft&&this.Ft.interacting?this.Ft.interact(t):this.Ut&&this.Ut.interacting?this.Ut.interact(t):this.Bt&&this.Bt.interacting?this.Bt.interact(t):this.Gt&&this.Gt.interacting&&this.Gt.interact(t)}collide(t){return this.Ft&&this.Ft.collide(t)||this.Bt&&this.Bt.collide(t)||!1}}var Z,tt,st;(t=>{t[t.UNLIT=0]="UNLIT",t[t.LIGHT=1]="LIGHT",t[t.LIT=2]="LIT"})(Z||(Z={}));class it extends ${constructor(t,s,i,h){super(t.registry,{static:!1,interacting:!0,width:1,height:1}),this._t=t,this.x=s,this.y=i,this.Wt=Z.UNLIT,this.ct=this._t.animated(this.x,this.y,"bonfire_unlit"),this.ct.zIndex=Y.static+this.y*Y.row,this._t.cell(this.x,this.y).object=this,h&&this.light()}get state(){return this.Wt}destroy(){super.destroy(),this._t.remove(this.x,this.y,this),this.ct.destroy()}interact(t){switch(this.Wt){case Z.UNLIT:t.state.dungeons.litBonfire(this._t.level),this._t.controller.showBanner({text:"BONFIRE LIT",color:l}),this.light();break;case Z.LIGHT:case Z.LIT:this._t.controller.showBonfire(t.state)}}collide(){return!0}light(){if(this.Wt===Z.UNLIT){this.Wt=Z.LIGHT,this.ct.destroy(),this.ct=this._t.animated(this.x,this.y,"bonfire_light"),this.ct.zIndex=Y.static+this.y*Y.row,this.ct.loop=!1,this.ct.onComplete=()=>this.lit();const s=new t.Point(16*this.x+8,16*this.y-16);this._t.light.addLight(s,X.BONFIRE)}}lit(){var t;this.Wt=Z.LIT,null===(t=this.ct)||void 0===t||t.destroy(),this.ct=this._t.animated(this.x,this.y,"bonfire_lit"),this.ct.zIndex=Y.static+this.y*Y.row}}class ht extends _{constructor(t,s){super(t,"Bonfire"),this.jt=s}init(){super.init();let t=1;const s=(s,i)=>{const h=new f({label:s,width:400,height:32,textSize:24});this.addChild(h),this.X.set(0,t,h,i),t++},i=this.jt.dungeons.bonfires().sort((t,s)=>t-s);for(const t of i)s("Level "+t,()=>{this.t.closeModal(),this.t.generateDungeon({hero:this.jt.name,level:t})});this.X.select(0,1)}}class et extends t.Container{constructor(s){super(),this.q=new t.BitmapText("LEVEL "+s,{font:{name:"alagard",size:32}}),this.q.anchor=.5,this.q.position.set(0,16),this.addChild(this.q)}}(t=>{t[t.Manhattan=0]="Manhattan",t[t.Euclidean=1]="Euclidean",t[t.Chebyshev=2]="Chebyshev",t[t.Octile=3]="Octile"})(tt||(tt={}));class nt{constructor(t,s){this.g=0,this.h=0,this.f=0,this.parent=t,this.position=s}equals(t){return this.position.equals(t.position)}}class rt{constructor(t,s){this.x=t,this.y=s}equals(t){return this.x===t.x&&this.y===t.y}static of(t){return new rt(t.x,t.y)}}(t=>{t[t.OPEN=0]="OPEN",t[t.CLOSED=1]="CLOSED"})(st||(st={}));let ot=(()=>{class t{constructor(t,s,i=!0,h=!1,e=!1,n=2,r=1){this.Kt=[],this.Xt=1,this._width=t,this._height=s,this.Vt=i,this.qt=h,this.Yt=e,this.Jt=n,this.Xt=r;for(let i=0;i<t;i++){const t=[];this.Kt.push(t);for(let i=0;i<s;i++)t.push(1)}}clear(t,s){this.Kt[t][s]=0}mark(t,s){this.Kt[t][s]=1}find(s,i){const h=new nt(null,rt.of(s)),e=new nt(null,rt.of(i)),n=[],r=[];for(n.push(h);n.length>0;){let s=n[0],i=0;for(let t=1;t<n.length;t++){const h=n[t];h.f<s.f&&(s=h,i=t)}if(n.splice(i,1),r.push(s),s.equals(e)){const t=[];let i;for(i=this.Yt?s:s.parent;null!==i.parent;)t.push(i.position),i=i.parent;return this.qt&&t.push(i.position),t.reverse()}const h=[],o=this.Vt?t.adjacentSquaresDiagonal:t.adjacentSquares;for(let t=0;t<o.length;t++){const i=o[t],e=new rt(s.position.x+i.x,s.position.y+i.y);if(e.x>=this._width||e.x<0||e.y>=this._height||e.y<0)continue;if(1===this.Kt[e.x][e.y])continue;const n=new nt(s,e);h.push(n)}for(let t=0;t<h.length;t++){const i=h[t];null==r.find(t=>t.equals(i))&&(i.g=s.g+1,i.h=this.heuristicFunction(i.position,e.position),i.f=i.g+i.h,null==n.find(t=>t.equals(i))&&n.push(i))}}return[]}heuristicFunction(t,s){const i=Math.abs(s.x-t.x),h=Math.abs(s.y-t.y);switch(this.Jt){case 0:return(i+h)*this.Xt;case 1:return Math.sqrt(i*i+h*h)*this.Xt;case 2:return Math.max(i,h)*this.Xt;case 3:return(i+h-.58*Math.min(i,h))*this.Xt}}}return t.adjacentSquares=[new rt(0,-1),new rt(0,1),new rt(-1,0),new rt(1,0)],t.adjacentSquaresDiagonal=[new rt(0,-1),new rt(0,1),new rt(-1,0),new rt(1,0),new rt(-1,-1),new rt(-1,1),new rt(1,-1),new rt(1,1)],t})();class lt{constructor(t,s){const i={};for(const t of s)i[t]=new at;this.Qt=i,this.Zt=t,this.ts=this.Zt}get isFinal(){return this.Qt[this.ts].isFinal}get current(){return this.ts}state(t){return this.Qt[t]}start(){this.ts=this.Zt,this.Qt[this.ts].enter(),this.transition()}stop(){this.Qt[this.ts].exit()}update(t){this.Qt[this.ts].update(t),this.transition()}handle(t){this.Qt[this.ts].handle(t),this.transition()}transition(){for(;;){const t=this.Qt[this.ts].transition();if(null===t)break;this.Qt[this.ts].exit(),this.ts=t,this.Qt[this.ts].enter()}}}class at{constructor(){this.ss=[],this.hs=[],this.es=[],this.ns=[],this.rs=[],this.os=[]}get isFinal(){return 0===this.rs.length}onEnter(t){return this.ss.push(t),this}onUpdate(t){return this.hs.push(t),this}onEvent(t){return this.es.push(t),this}onExit(t){return this.ns.push(t),this}nested(t){return this.os.push(t),this}transitionTo(t){const s=new ct(t);return this.rs.push(s),s}enter(){for(const t of this.ss)t();for(const t of this.os)t.start()}update(t){for(const s of this.hs)s(t);for(const s of this.os)s.update(t)}exit(){for(const t of this.ns)t();for(const t of this.os)t.stop()}handle(t){for(const s of this.es)s(t);for(const s of this.os)s.handle(t)}transition(){for(const t of this.rs)if(t.check())return t.perform(),t.to;return null}}class ct{constructor(t){this.ls=[],this.as=[],this.to=t}condition(t){return this.ls.push(t),this}action(t){return this.as.push(t),this}check(){for(const t of this.ls)if(!t())return!1;return!0}perform(){for(const t of this.as)t()}}class ut{constructor(s,i,h,e,n,r){this.cs=!1,this.gt=0,this.yt=0,this.ut=i,this.us=e,this.fs=n,this.ds=r||null,this.ct=new t.AnimatedSprite(i.animation(h),!1),this.ct.zIndex=2,this.ct.loop=!1,this.ct.position.set(0,14),this.ct.anchor.set(0,1),this.ct.width>16*this.fs&&(this.ct.position.x-=(this.ct.width-16*this.fs)/2),this.ws=new T(this.ut),this.ws.zIndex=1,this.ws.position.set(16*this.fs,12),this.ps=new t.Container,this.ps.addChild(this.ws,this.ct),s.addChild(this.ps)}get x(){return this.gt}get y(){return this.yt}get isLeft(){return this.cs}set isLeft(t){this.cs=t,this.updatePosition()}get weapon(){return this.ws}destroy(){this.ps.destroy(),this.ws.destroy(),this.ct.destroy()}setPosition(t,s){this.gt=Math.round(16*t*2)/2,this.yt=Math.round(16*s*2)/2,this.updatePosition(),this.ps.zIndex=this.us+Math.floor(s)*Y.row,this.ds&&this.ds(this.gt,this.yt)}setAnimation(t){this.ct.textures=this.ut.animation(t),this.ct.gotoAndStop(0)}setFrame(t){this.ct.gotoAndStop(t)}updatePosition(){this.ps.scale.set(this.cs?-1:1,1),this.ps.position.set(this.gt+(this.cs?16*this.fs:0),this.yt)}}class ft{constructor(t){this.gs=0,this.ys=!1,this.animationSpeed=t}get isPlaying(){return this.ys}start(){this.gs=0,this.ys=!0,this.play()}stop(){this.ys=!1}update(t){this.gs+=this.animationSpeed*t,this.ys&&this.play()}}class dt extends ft{constructor(t,s,i){super(t),this.ms=[],this.vs=null,this.bs=s,this.xs=i}get duration(){return this.ms.length>0?this.ms[this.ms.length-1].time:0}play(){for(;this.ys;){const t=null===this.vs?0:this.vs+1;if(t<this.ms.length){if(!(this.ms[t].time<=this.gs))break;this.vs=t,this.bs.call(this.xs,...this.ms[t].args)}else this.ys=!1}}addEvent(t){return this.ms.push(t),this.ms.sort(this.compare),this}addEvents(t){return this.ms.push(...t),this.ms.sort(this.compare),this}add(t,...s){return this.addEvent({time:t,args:s}),this}compare(t,s){return t.time-s.time}}class wt extends ft{constructor(t,s,i){super(t),this._s=[],this.bs=s,this.xs=i}get duration(){return this._s.length>0?this._s[this._s.length-1].time:0}play(){let t=null,s=null;for(let i=0;i<this._s.length;i++){const h=this._s[i];if(!(h.time<=this.gs)){s=h;break}t=h}if(null!==t&&null!==s){const i=[],h=s.time-t.time,e=(this.gs-t.time)/h;for(let h=0;h<t.args.length;h++)i[h]=t.args[h]*(1-e)+s.args[h]*e;this.bs.call(this.xs,...i)}else null!==t?(this.bs.call(this.xs,...t.args),this.ys=!1):null!==s&&this.bs.call(this.xs,...s.args)}addEvent(t){return this._s.push(t),this._s.sort(this.compare),this}addEvents(t){return this._s.push(...t),this._s.sort(this.compare),this}add(t,...s){return this.addEvent({time:t,args:s}),this}compare(t,s){return t.time-s.time}}class pt extends ft{constructor(t,s,i,h,e){super(i),this.Ms=t,this.ks=s,this.bs=h,this.xs=e}get duration(){return this.ks}play(){const t=this.gs/this.ks;t>=1?(this.ys=!1,this.bs.call(this.xs,...this.Ms(1))):this.bs.call(this.xs,...this.Ms(t))}}class gt{constructor(){this.Is=[],this.ys=!1}get isPlaying(){return this.ys}add(t){this.Is.push(t)}addEventClip(t,s,i){const h=new dt(t,s,i);return this.add(h),h}addKeyFrameClip(t,s,i){const h=new wt(t,s,i);return this.add(h),h}addCurveClip(t,s,i,h,e){const n=new pt(t,s,i,h,e);return this.add(n),n}clear(){this.stop(),this.Is.splice(0,this.Is.length)}start(){this.ys=!0;for(const t of this.Is)t.start()}stop(){this.ys=!1;for(const t of this.Is)t.stop()}update(t){let s=!1;for(const i of this.Is)i.update(t),i.isPlaying&&(s=!0);s||this.stop()}}class yt{constructor(t){this.Ss=t,this.animation=new gt}animateCharacter(t,s,i){this.animation.addEventClip(t,this.Ss.setAnimation,this.Ss).add(0,s);const h=this.animation.addEventClip(t,this.Ss.setFrame,this.Ss);for(let t=0;t<i;t++)h.add(t,t);h.add(i,0)}animateMove(t,s){this.animation.addKeyFrameClip(t,this.Ss.setPosition,this.Ss).add(0,s.x,s.y).add(4,s.newX,s.newY)}animateWeapon(t,s){const i=this.Ss.weapon;this.animation.addKeyFrameClip(t,i.setAngle,i).addEvents(s.angle),s.smoothly?this.animation.addKeyFrameClip(t,i.setPosition,i).addEvents(s.pos):this.animation.addEventClip(t,i.setPosition,i).addEvents(s.pos)}get isPlaying(){return this.animation.isPlaying}start(){this.animation.start()}update(t){this.animation.update(t)}stop(){this.animation.stop()}clear(){this.animation.clear()}}var mt,vt,bt,xt,_t,Mt,kt,It,St;(t=>{t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT",t[t.AROUND=4]="AROUND"})(mt||(mt={}));class Ot extends ${constructor(t,s){super(t.registry,{static:!1,interacting:s.interacting,height:s.height,width:s.width}),this.Os=-1,this.Ns=-1,this._t=t,this.gt=s.x,this.yt=s.y,this.view=new ut(t.layer,t.controller.resources,s.animation,s.zIndex,s.width,s.onPosition),this.animator=new yt(this.view),this.Ds=this.fsm()}get x(){return this.gt}get y(){return this.yt}get newX(){return this.Os}get newY(){return this.Ns}init(){this.setPosition(this.gt,this.yt),this.state.dead.subscribe(this.handleDead,this),this.state.inventory.equipment.weapon.item.subscribe(this.onWeaponUpdate,this),this.Ds.start(),this._t.ticker.add(this.Ds.update,this.Ds)}destroy(){super.destroy(),this._t.ticker.remove(this.Ds.update,this.Ds),this.Ds.stop(),this.state.dead.unsubscribe(this.handleDead,this),this.state.inventory.equipment.weapon.item.unsubscribe(this.onWeaponUpdate,this),this._t.remove(this.gt,this.yt,this),-1!==this.Os&&-1!==this.Ns&&this._t.remove(this.Os,this.Ns,this),this.view.destroy()}collide(t){return this!==t}handleDead(t){t&&this.onDead()}onWeaponUpdate(t){this.view.weapon.setWeapon(t)}setPosition(t,s){this.resetDestination(),this._t.remove(this.gt,this.yt,this),this.gt=Math.floor(t),this.yt=Math.floor(s),this._t.set(this.gt,this.yt,this),this.view.setPosition(t,s)}setDestination(t,s){this.resetDestination(),this.Os=t,this.Ns=s,this._t.set(this.Os,this.Ns,this)}tryMove(t,s){return this.moveRel(t,s)||this.moveRel(t,0)||this.moveRel(0,s)}moveRel(t,s){return this.move(this.gt+t,this.yt+s)}move(t,s){const i=t-this.gt,h=s-this.yt;return(0!==i||0!==h)&&(i>0&&(this.view.isLeft=!1),i<0&&(this.view.isLeft=!0),!!this._t.available(t,s,this)&&(this.setDestination(t,s),!0))}randomMove(){if(Math.random()<.1){const t=Math.floor(3*Math.random())-1,s=Math.floor(3*Math.random())-1;if(this.tryMove(t,s))return!0}return!1}moveToDestination(){-1!==this.Os&&-1!==this.Ns&&this.setPosition(this.Os,this.Ns)}resetDestination(){-1!==this.Os&&-1!==this.Ns&&(this._t.remove(this.Os,this.Ns,this),this._t.set(this.gt,this.yt,this),this.Os=-1,this.Ns=-1)}lookAt(t){t.x<this.x&&(this.view.isLeft=!0),t.x>this.x&&(this.view.isLeft=!1)}findPath(t,s=15,i=15){const h=this._t,e=new ot(h.width,h.height),n=Math.max(0,this.gt-s),r=Math.min(h.width-1,this.gt+this.width-1+s),o=Math.max(0,this.yt-this.height-s),l=Math.min(h.width-1,this.yt+s);for(let s=o;s<=l;s++)for(let i=n;i<=r;i++){const n=h.cell(i,s),r=n.object;!n.hasFloor||n.collide(this)&&r!==t?e.mark(i,s):e.clear(i,s)}const a=e.find(this,t);return a.length<=i?a:[]}segmentDistance(t,s,i,h){return Math.max(0,Math.max(t,i)-Math.min(s,h))}distanceTo(t){const s=this.segmentDistance(this.x,this.x+this.width-1,t.x,t.x+t.width-1),i=this.segmentDistance(this.y-this.height+1,this.y,t.y-t.height+1,t.y);return Math.max(s,i)}checkDirection(t,s){const i=this.x,h=this.width,e=4===t||1===t?0:i+(h-1),n=4===t||2===t?this._t.width-1:i+(h-1),r=s.x,o=r+s.width-1;return 0===this.segmentDistance(e,n,r,o)}metric(t){return Math.max(Math.abs(t.x-this.gt),Math.abs(t.y-this.yt))+(t.y!==this.yt?.5:0)+(t.x===this.gt&&t.y===this.yt?0:1)+(this.view.isLeft?t.x<this.gt?0:1:t.x>this.gt?0:.5)}scanCells(t,s,i){const h=this.x,e=this.y,n=this.width,r=this.height,o=4===t||2===t,l=4===t||1===t?Math.max(0,h-s):h+(n-1),a=o?Math.min(this._t.width-1,h+(n-1)+s):h,c=Math.max(0,e-r+1-s),u=Math.min(this._t.height-1,e+s),f=[];for(let t=c;t<=u;t++)for(let s=l;s<=a;s++){const h=this._t.cell(s,t);i(h)&&f.push(h)}return f.sort((t,s)=>this.metric(t)-this.metric(s)),f}findCell(t,s){const[i]=this.scanCells(4,t,s);return i||null}findDropCell(t=5){return this.findCell(t,t=>t.hasFloor&&!t.hasObject&&!t.hasDrop)}findSpawnCell(t=5){return this.findCell(t,t=>t.hasFloor&&!t.hasObject)}raycastIsVisible(t){let s=this.x,i=this.y;const h=t.x,e=t.y,n=Math.abs(h-s),r=Math.abs(e-i),o=s<h?1:-1,l=i<e?1:-1;let a=(n>r?n:-r)/2;for(;s!==h||i!==e;){const c=a;if(c>-n&&(a-=r,s+=o),c<r&&(a+=n,i+=l),s===h&&i===e)break;const u=this._t.cell(s,i);if(!u.hasFloor)return!1;if(u.collide(this)&&u.object!==t)return!1}return!0}idle(){const t=this.animator,s=new lt(0,[0,1]);return s.state(0).onEnter(()=>{const s=.2*this.state.speed.get();t.clear(),t.animateCharacter(s,this.state.name+"_idle",4);const i=this.state.weapon;i&&t.animateWeapon(s,i.animations.idle),t.start()}).onUpdate(s=>t.update(s)).onUpdate(()=>this.state.regenStamina()).onExit(()=>t.stop()).transitionTo(1).condition(()=>!t.isPlaying),s}run(){const t=this.animator,s=new lt(0,[0,1]);return s.state(0).onEnter(()=>{const s=.2*this.state.speed.get();t.clear(),t.animateCharacter(s,this.state.name+"_run",4),t.animateMove(s,this);const i=this.state.weapon;i&&t.animateWeapon(s,i.animations.run),t.start()}).onExit(()=>{t.isPlaying?(this.resetDestination(),t.stop()):this.moveToDestination()}).onUpdate(s=>t.update(s)).onUpdate(()=>this.state.regenStamina()).transitionTo(1).condition(()=>!t.isPlaying),s}dash(){const t=this.animator,s=new lt(0,[0,1]);return s.state(0).onEnter(()=>this.state.spendStamina(this.state.dashStamina)).onEnter(()=>{t.clear(),t.animateCharacter(1,this.state.name+"_run",4),t.animateMove(1,this);const s=this.state.weapon;s&&t.animateWeapon(1,s.animations.run),t.start()}).onExit(()=>{t.isPlaying?(this.resetDestination(),t.stop()):this.moveToDestination()}).onUpdate(s=>t.update(s)).transitionTo(1).condition(()=>!t.isPlaying),s}hit(t){const s=this.simpleHit(t),i=this.comboHit(t),h=new lt(0,[0,1,2,3]);return h.state(0).transitionTo(2).condition(()=>null!==this.state.weapon).condition(()=>this.state.weapon.animations.hit.length>1),h.state(0).transitionTo(1),h.state(1).nested(s).transitionTo(3).condition(()=>s.isFinal),h.state(2).nested(i).transitionTo(3).condition(()=>i.isFinal),h}simpleHit(t){const s=this.animator,i=new lt(0,[0,1,2]);return i.state(0).onEnter(()=>this.state.spendStamina(this.state.hitStamina)).onEnter(()=>{const t=this.state.weapon;if(s.clear(),t){const i=.2*t.speed;s.animateCharacter(i,this.state.name+"_idle",4),s.animateWeapon(i,t.animations.hit[0])}else{const t=.2*this.state.speed.get();s.animateCharacter(t,this.state.name+"_idle",4)}s.start()}).transitionTo(1),i.state(1).onUpdate(t=>s.update(t)),i.state(1).transitionTo(2).condition(()=>!s.isPlaying),i.state(2).onEnter(()=>t.onHit(1)).onEnter(()=>s.stop()),i}comboHit(t){const s=this.animator;let i=0,h=0,e=[];const n=new lt(0,[0,1,2]);return n.state(0).onEnter(()=>this.state.spendStamina(this.state.hitStamina)).onEnter(()=>{const t=this.state.weapon;e=t.animations.hit,h=.2*t.speed,i=0,s.clear(),s.animateCharacter(h,this.state.name+"_idle",4),s.animateWeapon(h,e[0]),s.start(),i++}).onUpdate(t=>s.update(t)).onExit(()=>t.onHit(i)),n.state(0).transitionTo(1).condition(()=>!s.isPlaying).condition(()=>t.continueCombo()).condition(()=>this.state.hasStamina(this.state.hitStamina)),n.state(0).transitionTo(2).condition(()=>!s.isPlaying),n.state(1).onEnter(()=>this.state.spendStamina(this.state.hitStamina)).onEnter(()=>{s.clear(),s.animateCharacter(h,this.state.name+"_idle",4),s.animateWeapon(h,e[i]),s.start(),i++}).onUpdate(t=>s.update(t)).onExit(()=>t.onHit(i)),n.state(1).transitionTo(1).condition(()=>!s.isPlaying).condition(()=>i<e.length).condition(()=>t.continueCombo()).condition(()=>this.state.hasStamina(this.state.hitStamina)),n.state(1).transitionTo(2).condition(()=>!s.isPlaying),n}}(t=>{t[t.PLAY=0]="PLAY",t[t.COMPLETE=1]="COMPLETE"})(vt||(vt={})),(t=>{t[t.PLAY=0]="PLAY",t[t.COMPLETE=1]="COMPLETE"})(bt||(bt={})),(t=>{t[t.PLAY=0]="PLAY",t[t.COMPLETE=1]="COMPLETE"})(xt||(xt={})),(t=>{t[t.INITIAL=0]="INITIAL",t[t.SIMPLE_HIT=1]="SIMPLE_HIT",t[t.COMBO_HIT=2]="COMBO_HIT",t[t.COMPLETE=3]="COMPLETE"})(_t||(_t={})),(t=>{t[t.INITIAL=0]="INITIAL",t[t.PLAY=1]="PLAY",t[t.COMPLETE=2]="COMPLETE"})(Mt||(Mt={})),(t=>{t[t.FIRST_HIT=0]="FIRST_HIT",t[t.NEXT_HIT=1]="NEXT_HIT",t[t.COMPLETE=2]="COMPLETE"})(kt||(kt={})),(t=>{t.DEMON="demon",t.ZOMBIE="zombie",t.ORC="orc",t.SLIME="slime",t.UNDEAD="undead"})(It||(It={})),(t=>{t.NORMAL="normal",t.SUMMON="summon",t.MINION="minion",t.BOSS="boss"})(St||(St={}));let Nt=(()=>{class t extends Ot{constructor(t,s,i){super(s,i),this.Es=[],this.state=t}get hasPath(){return this.Es.length>0}scanHit(t,s){const i=this.state.weapon,h=this.view.isLeft?1:2,e=(null==i?void 0:i.distance)||1,n=this.scanHeroes(h,e),r=this.state.Ts(t,s);for(const t of n)t.state.hitDamage(this,r)}onAlarm(t){this.distanceTo(t)<=2*this.state.viewRange&&(this.Es=this.findPath(t))}scanHeroes(t,s=this.state.viewRange){return this._t.registry.query({type:Ns.type,filter:i=>!i.state.dead.get()&&this.distanceTo(i)<=s&&this.checkDirection(t,i)&&this.raycastIsVisible(i)})}scanHero(){const[t]=this.scanHeroes(4,this.state.viewRange);if(t){for(const s of this.scanMonsters())s.onAlarm(t);return!0}return!1}get heroOnAttack(){var t;const s=(null===(t=this.state.weapon)||void 0===t?void 0:t.distance)||1;return this.scanHeroes(4,s).length>0}get heroIsNear(){return this.scanHeroes(4).length>0}moveToHero(){const[t]=this.scanHeroes(4);return!!t&&(this.lookAt(t),this.moveTo(t))}lookAtHero(){const[t]=this.scanHeroes(4);t&&this.lookAt(t)}runAway(){const[t]=this.scanHeroes(4);if(!t)return!1;const s=Math.min(1,Math.max(-1,this.x-t.x)),i=Math.min(1,Math.max(-1,this.y-t.y));return this.tryMove(s,i)}scanMonsters(){return this._t.registry.query({type:t.type,filter:t=>!t.state.dead.get()&&this.distanceTo(t)<=this.state.viewRange&&this.raycastIsVisible(t)})}moveByPath(){if(this.Es.length>0){const t=this.Es[0];return this.move(t.x,t.y)?(this.Es.splice(0,1),!0):(this.Es=[],!1)}return!1}moveTo(t){return this.Es=this.findPath(t),this.moveByPath()}}return t.type=s=>s instanceof t,t})();class Dt{constructor(t,s){this.t=t,this.As=s}onHit(t){this.t.scanHit(t,this.As)}continueCombo(){return!0}}let Et=(()=>{class t extends Nt{constructor(t,s,i,h){super(t,s,{width:2,height:2,x:i,y:h,animation:t.name+"_idle",zIndex:Y.character,static:!1,interacting:!1}),this.init()}onDead(){var t;this._t.controller.showBanner({text:this._t.rng.boolean()?"VICTORY ACHIEVED":"YOU DEFEATED",color:l});for(let s=0;s<9;s++)null===(t=this.findDropCell())||void 0===t||t.randomDrop();this.destroy()}fsm(){const t=new lt(0,[0,1,2]),s=this.patrolling(),i=this.alarm(),h=this.attack();return t.state(0).onEnter(()=>s.start()).onUpdate(t=>s.update(t)).onEvent(t=>s.handle(t)),t.state(0).transitionTo(2).condition(()=>s.isFinal).condition(()=>3===s.current),t.state(0).transitionTo(1).condition(()=>s.isFinal).condition(()=>2===s.current),t.state(1).onEnter(()=>i.start()).onUpdate(t=>i.update(t)),t.state(1).transitionTo(2).condition(()=>i.isFinal).condition(()=>3===i.current),t.state(1).transitionTo(0).condition(()=>i.isFinal).condition(()=>4===i.current),t.state(2).onEnter(()=>h.start()).onUpdate(t=>h.update(t)),t.state(2).transitionTo(1).condition(()=>h.isFinal).condition(()=>4===h.current),t}patrolling(){const t=new lt(0,[0,1,2,3]),s=this.idle(),i=this.run();return t.state(0).nested(s),t.state(0).transitionTo(3).condition(()=>this.scanHero()),t.state(0).transitionTo(2).condition(()=>this.hasPath),t.state(0).transitionTo(1).condition(()=>s.isFinal).condition(()=>this.randomMove()),t.state(0).transitionTo(0).condition(()=>s.isFinal),t.state(1).nested(i),t.state(1).transitionTo(3).condition(()=>i.isFinal).condition(()=>this.scanHero()),t.state(1).transitionTo(2).condition(()=>i.isFinal).condition(()=>this.hasPath),t.state(1).transitionTo(0).condition(()=>i.isFinal),t}alarm(){const t=new lt(1,[0,1,2,3,4]),s=this.idle(),i=this.run();let h=0;return t.state(0).onEnter(()=>h=10),t.state(0).transitionTo(2).condition(()=>this.moveByPath()),t.state(0).transitionTo(1),t.state(1).nested(s),t.state(1).transitionTo(3).condition(()=>this.scanHero()),t.state(1).transitionTo(2).condition(()=>s.isFinal).condition(()=>this.moveByPath()),t.state(1).transitionTo(1).condition(()=>s.isFinal).condition(()=>--h>0),t.state(1).transitionTo(4).condition(()=>s.isFinal),t.state(2).nested(i),t.state(2).transitionTo(3).condition(()=>i.isFinal).condition(()=>this.scanHero()),t.state(2).transitionTo(2).condition(()=>i.isFinal).condition(()=>this.moveByPath()),t.state(2).transitionTo(1).condition(()=>i.isFinal),t}attack(){const t=this._t.rng,s=new lt(0,[0,1,2,3,4]),i=this.idle(),h=this.run(),e=this.hit(new Dt(this,0));return s.state(0).transitionTo(3).condition(()=>this.heroOnAttack).condition(()=>t.float()<this.state.luck).condition(()=>this.state.hasStamina(this.state.hitStamina)),s.state(0).transitionTo(2).condition(()=>this.moveToHero()),s.state(0).transitionTo(1).condition(()=>this.heroIsNear),s.state(0).transitionTo(4),s.state(1).nested(i).onEnter(()=>this.lookAtHero()),s.state(1).transitionTo(3).condition(()=>i.isFinal).condition(()=>this.heroOnAttack).condition(()=>t.float()<this.state.luck).condition(()=>this.state.hasStamina(this.state.hitStamina)),s.state(1).transitionTo(2).condition(()=>i.isFinal).condition(()=>this.moveToHero()),s.state(1).transitionTo(1).condition(()=>i.isFinal).condition(()=>this.heroIsNear),s.state(1).transitionTo(4).condition(()=>i.isFinal),s.state(2).nested(h),s.state(2).transitionTo(3).condition(()=>h.isFinal).condition(()=>this.heroOnAttack).condition(()=>this.state.hasStamina(this.state.hitStamina)).condition(()=>t.float()<this.state.luck),s.state(2).transitionTo(2).condition(()=>h.isFinal).condition(()=>this.moveToHero()),s.state(2).transitionTo(1).condition(()=>h.isFinal),s.state(3).nested(e).onEnter(()=>this.lookAtHero()),s.state(3).transitionTo(2).condition(()=>e.isFinal).condition(()=>this.moveToHero()),s.state(3).transitionTo(1).condition(()=>e.isFinal),s}}return t.type=s=>s instanceof t,t})();var Tt,At,Lt,Pt;(t=>{t[t.PATROLLING=0]="PATROLLING",t[t.ALARM=1]="ALARM",t[t.ATTACK=2]="ATTACK"})(Tt||(Tt={})),(t=>{t[t.IDLE=0]="IDLE",t[t.RANDOM_MOVE=1]="RANDOM_MOVE",t[t.GO_ALARM=2]="GO_ALARM",t[t.GO_ATTACK=3]="GO_ATTACK"})(At||(At={})),(t=>{t[t.INITIAL=0]="INITIAL",t[t.IDLE=1]="IDLE",t[t.RUN=2]="RUN",t[t.GO_ATTACK=3]="GO_ATTACK",t[t.GO_PATROLLING=4]="GO_PATROLLING"})(Lt||(Lt={})),(t=>{t[t.INITIAL=0]="INITIAL",t[t.IDLE=1]="IDLE",t[t.RUN=2]="RUN",t[t.HIT=3]="HIT",t[t.GO_ALARM=4]="GO_ALARM"})(Pt||(Pt={}));class Rt extends t.Container{constructor(t){super(),this.Ls=t;const s=Math.floor(Math.min(4*t.state.healthMax.get(),550));this.Ps=new u({color:r,width:s,valueMax:t.state.healthMax.get(),center:!0}),this.Ps.position.set(-(this.Ps.width>>1),0),this.addChild(this.Ps),this.Rs=new u({color:o,width:s,valueMax:t.state.staminaMax.get(),center:!0}),this.Rs.position.set(-(this.Rs.width>>1),32),this.addChild(this.Rs),this.Ls.state.health.subscribe(this.updateHealth,this),this.Ls.state.stamina.subscribe(this.updateStamina,this),this.Ls.state.dead.subscribe(this.updateDead,this)}destroy(){this.Ls.state.health.unsubscribe(this.updateHealth,this),this.Ls.state.dead.unsubscribe(this.updateDead,this),this.Ps.destroy(),super.destroy()}updateHealth(t){this.Ps.value=t,this.Ps.label=`${this.Ls.state.name} - ${t.toFixed(1)}`}updateStamina(t){this.Rs.value=t,this.Rs.label=`${t.toFixed(1)}/${this.Ls.state.staminaMax.get()}`}updateDead(t){t&&this.destroy()}}class Ct extends Nt{constructor(t,s,i,h){super(t,s,{x:i,y:h,width:1,height:1,static:!1,interacting:!1,animation:t.name+"_idle",zIndex:Y.character}),this.init()}onDead(){var t;Math.random()<this.state.luck&&(null===(t=this.findDropCell())||void 0===t||t.randomDrop()),this.destroy()}fsm(){const t=new lt(0,[0,1,2]),s=this.patrolling(),i=this.alarm(),h=this.attack();return t.state(0).nested(s),t.state(0).transitionTo(2).condition(()=>s.isFinal).condition(()=>3===s.current),t.state(0).transitionTo(1).condition(()=>s.isFinal).condition(()=>2===s.current),t.state(1).nested(i),t.state(1).transitionTo(2).condition(()=>i.isFinal).condition(()=>3===i.current),t.state(1).transitionTo(0).condition(()=>i.isFinal).condition(()=>4===i.current),t.state(2).nested(h),t.state(2).transitionTo(1).condition(()=>h.isFinal).condition(()=>4===h.current),t}patrolling(){const t=new lt(0,[0,1,2,3]),s=this.idle(),i=this.run();return t.state(0).nested(s),t.state(0).transitionTo(3).condition(()=>this.scanHero()),t.state(0).transitionTo(2).condition(()=>s.isFinal).condition(()=>this.hasPath),t.state(0).transitionTo(1).condition(()=>s.isFinal).condition(()=>this.randomMove()),t.state(0).transitionTo(0).condition(()=>s.isFinal),t.state(1).nested(i),t.state(1).transitionTo(3).condition(()=>i.isFinal).condition(()=>this.scanHero()),t.state(1).transitionTo(2).condition(()=>i.isFinal).condition(()=>this.hasPath),t.state(1).transitionTo(0).condition(()=>i.isFinal),t}alarm(){const t=new lt(1,[0,1,2,3,4]),s=this.idle(),i=this.run();let h=0;return t.state(0).onEnter(()=>h=10),t.state(0).transitionTo(2).condition(()=>this.moveByPath()),t.state(0).transitionTo(1),t.state(1).nested(s),t.state(1).transitionTo(3).condition(()=>this.scanHero()),t.state(1).transitionTo(2).condition(()=>s.isFinal).condition(()=>this.moveByPath()),t.state(1).transitionTo(1).condition(()=>s.isFinal).condition(()=>--h>0),t.state(1).transitionTo(4).condition(()=>s.isFinal),t.state(2).nested(i),t.state(2).transitionTo(3).condition(()=>i.isFinal).condition(()=>this.scanHero()),t.state(2).transitionTo(2).condition(()=>i.isFinal).condition(()=>this.moveByPath()),t.state(2).transitionTo(1).condition(()=>i.isFinal),t}attack(){const t=this._t.rng,s=new lt(0,[0,1,2,3,4]),i=this.idle(),h=this.run(),e=this.hit(new Dt(this,0));return s.state(0).transitionTo(3).condition(()=>this.heroOnAttack).condition(()=>this.state.hasStamina(this.state.hitStamina)),s.state(0).transitionTo(2).condition(()=>this.moveToHero()),s.state(0).transitionTo(1).condition(()=>this.heroIsNear),s.state(0).transitionTo(4),s.state(1).nested(i).onEnter(()=>this.lookAtHero()),s.state(1).transitionTo(3).condition(()=>i.isFinal).condition(()=>this.heroOnAttack).condition(()=>this.state.hasStamina(this.state.hitStamina)).condition(()=>t.float()<this.state.luck),s.state(1).transitionTo(2).condition(()=>i.isFinal).condition(()=>this.moveToHero()),s.state(1).transitionTo(1).condition(()=>i.isFinal).condition(()=>this.heroIsNear),s.state(1).transitionTo(4).condition(()=>i.isFinal),s.state(2).nested(h),s.state(2).transitionTo(3).condition(()=>h.isFinal).condition(()=>this.heroOnAttack).condition(()=>this.state.hasStamina(this.state.hitStamina)).condition(()=>t.float()<this.state.luck),s.state(2).transitionTo(2).condition(()=>h.isFinal).condition(()=>this.moveToHero()),s.state(2).transitionTo(1).condition(()=>h.isFinal),s.state(3).nested(e).onEnter(()=>this.lookAtHero()),s.state(3).transitionTo(2).condition(()=>e.isFinal).condition(()=>this.moveToHero()),s.state(3).transitionTo(1).condition(()=>e.isFinal),s}}var $t,zt,Ht,Gt,Bt,Ut,Ft;(t=>{t[t.PATROLLING=0]="PATROLLING",t[t.ALARM=1]="ALARM",t[t.ATTACK=2]="ATTACK"})($t||($t={})),(t=>{t[t.IDLE=0]="IDLE",t[t.RANDOM_MOVE=1]="RANDOM_MOVE",t[t.GO_ALARM=2]="GO_ALARM",t[t.GO_ATTACK=3]="GO_ATTACK"})(zt||(zt={})),(t=>{t[t.INITIAL=0]="INITIAL",t[t.IDLE=1]="IDLE",t[t.RUN=2]="RUN",t[t.GO_ATTACK=3]="GO_ATTACK",t[t.GO_PATROLLING=4]="GO_PATROLLING"})(Ht||(Ht={})),(t=>{t[t.INITIAL=0]="INITIAL",t[t.IDLE=1]="IDLE",t[t.RUN=2]="RUN",t[t.HIT=3]="HIT",t[t.GO_ALARM=4]="GO_ALARM"})(Gt||(Gt={}));class Wt extends Nt{constructor(t,s,i,h){super(t,s,{x:i,y:h,width:1,height:1,static:!1,interacting:!1,animation:t.name+"_idle",zIndex:Y.character}),this.Cs=3,this.$s=[],this.init()}onDead(){var t;Math.random()<this.state.luck&&(null===(t=this.findDropCell())||void 0===t||t.randomDrop()),this.destroy()}spawnMinions(){for(let t=this.$s.length-1;t>=0;t--)this.$s[t].state.dead.get()&&this.$s.splice(t,1);if(this.$s.length<this.Cs){if(Math.random()>.1)return!1;const t=this.findSpawnCell();if(!t)return!1;const s=this._t.controller.monsterManager.spawnRandomMinion(this.state.race,this._t,t.x,t.y);return!!s&&(t.object=s,this.$s.push(s),!0)}return!1}fsm(){const t=new lt(0,[0,1]),s=this.patrolling(),i=this.attack();return t.state(0).nested(s).transitionTo(1).condition(()=>s.isFinal).condition(()=>2===s.current),t.state(1).nested(i).transitionTo(0).condition(()=>i.isFinal).condition(()=>5===i.current),t}patrolling(){const t=new lt(0,[0,1,2]),s=this.idle(),i=this.run();return t.state(0).nested(s).onEnter(()=>this.spawnMinions()),t.state(0).transitionTo(2).condition(()=>this.scanHero()),t.state(0).transitionTo(1).condition(()=>s.isFinal).condition(()=>this.randomMove()),t.state(0).transitionTo(0).condition(()=>s.isFinal),t.state(1).nested(i),t.state(1).transitionTo(2).condition(()=>i.isFinal).condition(()=>this.scanHero()),t.state(1).transitionTo(0).condition(()=>i.isFinal),t}attack(){const t=this._t.rng,s=new lt(0,[0,1,2,3,4,5]),i=this.idle(),h=this.run(),e=this.hit(new Dt(this,0));return s.state(0),s.state(0).transitionTo(5).condition(()=>!this.heroIsNear),s.state(0).transitionTo(1).condition(()=>this.heroIsNear),s.state(1).transitionTo(4).condition(()=>this.heroOnAttack).condition(()=>t.float()<this.state.luck).condition(()=>this.state.hasStamina(this.state.hitStamina)),s.state(1).transitionTo(3).condition(()=>this.heroIsNear).condition(()=>this.runAway()),s.state(1).transitionTo(2).condition(()=>this.heroIsNear),s.state(1).transitionTo(5),s.state(2).nested(i).onEnter(()=>this.spawnMinions()).transitionTo(1).condition(()=>i.isFinal),s.state(3).nested(h).transitionTo(1).condition(()=>h.isFinal),s.state(4).nested(e).onEnter(()=>this.lookAtHero()).transitionTo(2).condition(()=>e.isFinal),s}}(t=>{t[t.PATROLLING=0]="PATROLLING",t[t.ATTACK=1]="ATTACK"})(Bt||(Bt={})),(t=>{t[t.IDLE=0]="IDLE",t[t.RANDOM_MOVE=1]="RANDOM_MOVE",t[t.GO_ATTACK=2]="GO_ATTACK"})(Ut||(Ut={})),(t=>{t[t.INITIAL=0]="INITIAL",t[t.DECISION=1]="DECISION",t[t.IDLE=2]="IDLE",t[t.RUN_AWAY=3]="RUN_AWAY",t[t.HIT=4]="HIT",t[t.GO_PATROLLING=5]="GO_PATROLLING"})(Ft||(Ft={}));class jt{constructor(t){this.zs=[],this.i=t}set(t){this.i=t,this.onUpdate(t);for(let t=this.zs.length-1;t>=0;t--){const s=this.zs[t];s.gc?this.zs.splice(t,1):s.send(this.i)}}onUpdate(t){}update(t){this.set(t(this.i))}get(){return this.i}subscribe(t,s){const i=new Xt(t,s);this.zs.push(i),i.send(this.i)}unsubscribe(t,s){var i;null===(i=this.zs.find(i=>i.matches(t,s)))||void 0===i||i.unsubscribe()}}class Kt{constructor(){this.zs=[]}send(t){for(let s=this.zs.length-1;s>=0;s--){const i=this.zs[s];i.gc?this.zs.splice(s,1):i.send(t)}}subscribe(t,s){const i=new Xt(t,s);this.zs.push(i)}unsubscribe(t,s){var i;null===(i=this.zs.find(i=>i.matches(t,s)))||void 0===i||i.unsubscribe()}}class Xt{constructor(t,s){this.Hs=!1,this.Gs=t,this.xs=s||null}get gc(){return this.Hs}matches(t,s){return this.Gs===t&&this.xs===s}send(t){this.xs?this.Gs.call(this.xs,t):this.Gs(t)}unsubscribe(){this.Hs=!0}}class Vt{constructor(){this.item=new jt(null),this.count=new jt(0)}}class qt{constructor(t,s){this.item=t.optionalVar("item",null,s),this.count=t.integerVar("count",0)}}class Yt{cell(t){return new Vt}}class Jt{constructor(t,s){this.Bs=t.prefix("equipment"),this.Us=s}cell(t){return new qt(this.Bs.prefix(""+t),this.Us)}}class Qt{cell(t){return new Vt}}class Zt{constructor(t,s){this.Bs=t.prefix("belt"),this.Us=s}cell(t){return new qt(this.Bs.prefix(""+t),this.Us)}}class ts{cell(t,s){return new Vt}}class ss{constructor(t,s){this.Bs=t.prefix("backpack"),this.Us=s}cell(t,s){return new qt(this.Bs.prefix(`${t}:${s}`),this.Us)}}class is{constructor(){this.equipment=new Yt,this.belt=new Qt,this.backpack=new ts,this.coins=new jt(0)}}class hs{constructor(t,s){const i=new A(s);this.equipment=new Jt(t,i),this.belt=new Zt(t,i),this.backpack=new ss(t,i),this.coins=t.integerVar("coins",0)}}class es{constructor(t,s,i,h,e){this.Wt=t,this.Fs=s,this.Ws=i,this.Ut=h,this.parent=e}get item(){return this.Wt.item}get count(){return this.Wt.count}hasSpace(t){return this.supports(t)&&(this.isEmpty||this.Wt.item.get().same(t)&&this.Wt.count.get()<this.Fs)}supports(t){return this.Ws(t)}stack(t){var s;return!!((null===(s=this.Wt.item.get())||void 0===s?void 0:s.same(t))&&this.Wt.count.get()<this.Fs)&&(this.Wt.count.update(t=>t+1),!0)}clear(){this.Wt.item.get()&&(this.Wt.item.set(null),this.Wt.count.set(0))}set(t,s=1){return!(this.Wt.item.get()||!this.Ws(t))&&(this.Wt.item.set(t),this.Wt.count.set(s),!0)}decrease(){this.Wt.count.update(t=>Math.max(0,t-1)),this.Wt.count.get()<=0&&(this.Wt.item.set(null),this.Wt.count.set(0))}get isEmpty(){return null==this.Wt.item.get()}use(t){const s=this.Wt.item.get();return!!s&&(s.use(this,t),!0)}equip(){const t=this.Wt.item.get(),s=this.parent.inventory.equipment.weapon;if(t&&s.supports(t)){const i=s.item.get();s.clear(),s.set(t),this.clear(),i&&this.set(i)}}toBelt(){const t=this.Wt.item.get();for(;t&&!this.isEmpty&&this.parent.inventory.belt.add(t);)this.decrease()}toBackpack(){const t=this.Wt.item.get();for(;t&&!this.isEmpty&&this.parent.inventory.backpack.add(t);)this.decrease()}drop(){const t=this.Wt.item.get(),s=this.Wt.count.get();t&&(this.Wt.item.set(null),this.Wt.count.set(0),this.Ut.send([t,s]))}}class ns{constructor(t){this.Ut=new Kt,this.equipment=new rs(this,t.equipment,this.Ut),this.belt=new os(this,t.belt,this.Ut),this.backpack=new ls(this,t.backpack,this.Ut)}get drop(){return this.Ut}stack(t){return this.belt.stack(t)||this.backpack.stack(t)}set(t){return this.belt.set(t)||this.backpack.set(t)}add(t){return this.stack(t)||this.set(t)}hasSpace(t){return this.belt.hasSpace(t)||this.backpack.hasSpace(t)}}class rs{constructor(t,s,i){this.inventory=t,this.weapon=new es(s.cell("weapon"),1,t=>t instanceof D,i,this)}}class os{constructor(t,s,i){this.length=10,this.inventory=t,this.H=[];for(let t=0;t<10;t++)this.H[t]=new es(s.cell(t),3,()=>!0,i,this)}cell(t){return this.H[t]}stack(t){for(let s=0;s<this.H.length;s++)if(this.H[s].stack(t))return!0;return!1}set(t){for(let s=0;s<this.H.length;s++)if(this.H[s].set(t))return!0;return!1}add(t){return this.stack(t)||this.set(t)}hasSpace(t){for(let s=0;s<this.H.length;s++)if(this.H[s].hasSpace(t))return!0;return!1}}class ls{constructor(t,s,i){this.width=10,this.height=5,this.inventory=t,this.H=[];for(let t=0;t<this.height;t++){this.H.push([]);for(let h=0;h<this.width;h++)this.H[t][h]=new es(s.cell(h,t),3,()=>!0,i,this)}}cell(t,s){return this.H[s][t]}stack(t){for(let s=0;s<this.height;s++)for(let i=0;i<this.width;i++)if(this.H[s][i].stack(t))return!0;return!1}set(t){for(let s=0;s<this.height;s++)for(let i=0;i<this.width;i++)if(this.H[s][i].set(t))return!0;return!1}add(t){return this.stack(t)||this.set(t)}hasSpace(t){for(let s=0;s<this.height;s++)for(let i=0;i<this.width;i++)if(this.H[s][i].hasSpace(t))return!0;return!1}}class as extends t.Container{constructor(t,s,i,h,e){super(),this.X=i,this.js=h,this.Ks=e;const n=s.inventory,r=new g({padding:0});this.addChild(r);const o=new p({padding:0});r.addChild(o),this.Xs=new cs(t,n.equipment),o.addChild(this.Xs),i.set(h,e,this.Xs.weapon,()=>this.show(n.equipment.weapon)),i.merge(h,e,10,1),this.Vs=new us(t,n.belt),o.addChild(this.Vs);for(let t=0;t<this.Vs.length;t++){const s=n.belt.cell(t);this.X.set(h+t,e+1,this.Vs.cell(t),()=>this.show(s))}this.qs=new fs(t,n.backpack),o.addChild(this.qs);for(let t=0;t<n.backpack.width;t++)for(let s=0;s<n.backpack.height;s++){const i=n.backpack.cell(t,s);this.X.set(h+t,e+s+2,this.qs.cell(t,s),()=>this.show(i))}this.as=new ps(this.X,this.js,this.Ks,s),o.addChild(this.as),this.Ys=new ws(t,s,{width:400,height:400}),r.addChild(this.Ys)}destroy(){super.destroy(),this.Xs.destroy(),this.Vs.destroy(),this.qs.destroy(),this.Ys.destroy()}show(t){this.Ys.publisher=t.item,this.as.cell=t}}class cs extends t.Container{constructor(s,i){super(),this.Xs=i;const e=(new t.Graphics).beginFill(h).drawRect(0,0,32+(a<<1),32+(a<<1)).endFill();this.addChild(e),this.weapon=new ds(s,{item:this.Xs.weapon.item,count:new jt(null)}),this.weapon.position.set(a,a),this.addChild(this.weapon)}}class us extends t.Container{constructor(s,i){super(),this.Js=i;const e=(new t.Graphics).beginFill(h).drawRect(0,0,a+(32+a)*i.length,32+(a<<1)).endFill();this.addChild(e),this.H=[];for(let t=0;t<i.length;t++){const h=i.cell(t),e=new ds(s,{item:h.item,count:h.count});e.position.set(a+(32+a)*t,a),this.H.push(e),this.addChild(e)}}get length(){return this.Js.length}cell(t){return this.H[t]}}class fs extends t.Container{constructor(s,i){super();const e=(new t.Graphics).beginFill(h).drawRect(0,0,a+(32+a)*i.width,a+(32+a)*i.height).endFill();this.addChild(e),this.H=[];for(let t=0;t<i.height;t++){this.H.push([]);for(let h=0;h<i.width;h++){const e=i.cell(h,t),n=new ds(s,{item:e.item,count:e.count});n.position.set(a+(32+a)*h,a+(32+a)*t),this.H[t][h]=n,this.addChild(n)}}}cell(t,s){return this.H[s][t]}}class ds extends t.Container{constructor(s,i){super(),this.ct=null,this.v=!1,this.Qs=i.item,this.Zs=i.count,this.ut=s,this.O=new t.Graphics,this.selected=!1,this.ti=new t.BitmapText("0",{font:{name:"alagard",size:16}}),this.ti.anchor=new t.Point(1,0),this.ti.position.set(32-a,0),this.addChild(this.O,this.ti),this.Qs.subscribe(this.updateItem,this),this.Zs.subscribe(this.updateCounter,this)}destroy(){super.destroy(),this.Qs.unsubscribe(this.updateItem,this),this.Zs.unsubscribe(this.updateCounter,this)}get selected(){return this.v}set selected(t){this.v=t,this.O.clear().beginFill(t?e:n).drawRect(0,0,32,32).endFill()}updateCounter(t){this.ti.text=null===t||0===t?"":t.toString()}updateItem(t){var s;if(null===(s=this.ct)||void 0===s||s.destroy(),this.ct=null,t){this.ct=this.ut.spriteOrAnimation(t.spriteName);const s=(32-(a<<1))/Math.max(this.ct.width,this.ct.height);this.ct.scale.set(s,s),this.ct.anchor.set(.5,0),this.ct.position.set(16,a),this.addChild(this.ct)}}}class ws extends t.Container{constructor(s,i,e){super(),this.ct=null,this.si=null,this.ut=s,this.t=i,this._width=e.width||400,this._height=e.height||400,this.ii=128+(c<<1);const r=(new t.Graphics).beginFill(h).drawRect(0,0,this._width,this._height).endFill().beginFill(n).drawRect(c,c+32+c,this.ii,this.ii).endFill();this.q=new t.BitmapText("",{font:{name:"alagard",size:32}}),this.q.anchor=new t.Point(.5,0),this.q.position.set(this._width>>1,c),this.hi=new t.BitmapText("",{font:{name:"alagard",size:16}}),this.hi.position.set(c+this.ii+c,c+32+c),this.addChild(r,this.q,this.hi)}destroy(){var t;super.destroy(),null===(t=this.si)||void 0===t||t.unsubscribe(this.handle,this),this.si=null}set publisher(t){var s;null===(s=this.si)||void 0===s||s.unsubscribe(this.handle,this),this.si=null,this.si=t,this.si.subscribe(this.handle,this)}handle(s){var i;if(null===(i=this.ct)||void 0===i||i.destroy(),this.ct=null,this.q.text="",this.hi.text="",s){const i=this.ct=this.ut.spriteOrAnimation(s.spriteName);i.anchor=new t.Point(.5,.5),i.position.set(c+(this.ii>>1),c+(this.ii>>1)+32+c);const h=this.ii-c,e=i.width,n=i.height;e>n?(this.ct.width=h,this.ct.height=h/e*n):(this.ct.height=h,this.ct.width=h/n*e),this.addChild(this.ct);const r=this.t.handleInfo(s);this.q.text=r.name;const o=[];r.health&&o.push("health: "+r.health),r.speed&&o.push(`speed: ${100*r.speed}%`),r.distance&&o.push("distance: "+r.distance),r.damage&&o.push("damage: "+r.damage),r.stamina&&o.push("stamina: "+r.stamina),r.price&&o.push(`price: ${r.price}$`),this.hi.text=o.join("\n")}}}class ps extends t.Container{constructor(t,s,i,h){super(),this.ei=[],this.ni=null,this.X=t,this.js=s,this.Ks=i,this.t=h}destroy(){var t;super.destroy(),null===(t=this.ni)||void 0===t||t.item.unsubscribe(this.handle,this),this.ni=null,this.removeButtons()}set cell(t){var s;null===(s=this.ni)||void 0===s||s.item.unsubscribe(this.handle,this),this.removeButtons(),this.ni=t,this.ni.item.subscribe(this.handle,this)}get cell(){return this.ni}handle(t){this.t.handleActions(this,t)}removeButtons(){for(const[t,s,i]of this.ei)this.X.unmerge(s,i),this.X.remove(s,i),t.destroy();this.X.reset(),this.ei.splice(0,this.ei.length)}addButton(t,s){const i=this.ei.length,h=i>>1,e=i%2,n=this.js+5*e,r=this.Ks+10+h,o=new f({label:t,width:170,height:32});o.position.set(e*(170+c),h*(32+c)),this.ei.push([o,n,r]),this.X.set(n,r,o,s),this.X.merge(n,r,5,1),this.addChild(o)}}class gs extends _{constructor(t,s){super(t,s.title),this.ri=s}init(){super.init(),this.addChild(new as(this.t.resources,this.ri,this.X,0,1)),this.t.ticker.add(this.handleInput,this)}destroy(){this.t.ticker.remove(this.handleInput,this),super.destroy()}handleInput(){this.t.joystick.inventory.once()&&this.t.closeModal()}}class ys{constructor(t,s){this.inventory=t,this.title=s}handleActions(t,s){t.removeButtons(),s&&this.buttons(t,s)}}class ms extends ys{constructor(t,s){super(t.inventory,s),this.jt=t}basicButtons(t,s){const i=t.cell;(i.parent instanceof os||i.parent instanceof ls)&&(this.inventory.equipment.weapon.supports(s)?t.addButton("Equip",()=>i.equip()):t.addButton("Use item",()=>i.use(this.jt))),i.parent instanceof os||t.addButton("To belt",()=>i.toBelt()),i.parent instanceof ls||t.addButton("To backpack",()=>i.toBackpack()),t.addButton("Drop",()=>i.drop())}}class vs extends ms{constructor(t){super(t,"Inventory")}buttons(t,s){this.basicButtons(t,s)}handleInfo(t){const s=t.info();return s.price=s.sellPrice,s}}class bs extends ms{constructor(t,s){super(t,"Selling"),this.oi=s}buttons(t,s){this.basicButtons(t,s),this.sellingButtons(t,s)}sellingButtons(t,s){const i=s.info().sellPrice;void 0!==i&&this.oi.coins.get()>=i&&this.oi.inventory.backpack.hasSpace(s)&&t.addButton("Sell",()=>{this.oi.coins.get()>=i&&this.oi.inventory.backpack.hasSpace(s)&&(this.oi.decreaseCoins(i),this.oi.inventory.backpack.add(s),this.jt.coins.update(t=>t+i),t.cell.decrease())})}handleInfo(t){const s=t.info();return s.price=s.sellPrice,s}}class xs extends ys{constructor(t,s){super(s.inventory,"Buying"),this.jt=t,this.oi=s}buttons(t,s){t.cell.parent instanceof ls&&this.buyingButtons(t,s)}buyingButtons(t,s){const i=s.info().buyPrice;void 0!==i&&this.jt.coins.get()>=i&&this.jt.inventory.hasSpace(s)&&t.addButton("Buy",()=>{this.oi.coins.get()>=i&&this.jt.inventory.hasSpace(s)&&(this.jt.coins.update(t=>Math.max(0,t-i)),this.jt.inventory.backpack.add(s),this.oi.addCoins(i),t.cell.decrease())})}handleInfo(t){const s=t.info();return s.price=s.buyPrice,s}}class _s{constructor(){this.dead=new jt(!1),this.killedBy=new Kt}get weapon(){return this.inventory.equipment.weapon.item.get()||null}get damage(){return this.Ts(1,0)}Ts(t,s){var i;return(this.baseDamage.get()+((null===(i=this.weapon)||void 0===i?void 0:i.damage)||0))*(1+t/10)*(1===s?1.5:1)}hitDamage(t,s){this.dead.get()||(this.health.update(t=>parseFloat(Math.max(0,t-s).toFixed(1))),0===this.health.get()&&(this.killedBy.send(t),this.dead.set(!0)))}addCoins(t){this.coins.update(s=>s+t)}decreaseCoins(t){const s=this.coins.get();return s>=t&&(this.coins.set(s-t),!0)}heal(t){this.health.update(s=>Math.min(this.healthMax.get(),s+t))}regenStamina(){const t=this.stamina.get(),s=this.staminaMax.get();t<s&&this.stamina.set(Math.min(s,t+.75))}hasStamina(t){return this.stamina.get()>=t}spendStamina(t){this.stamina.update(s=>Math.max(0,s-t))}get hitStamina(){var t;return(null===(t=this.weapon)||void 0===t?void 0:t.stamina)||20}get dashStamina(){return 16}}var Ms;(t=>{t[t.LIGHT=0]="LIGHT",t[t.CHARGED=1]="CHARGED"})(Ms||(Ms={}));class ks extends _s{constructor(t){super(),this.name=t.name,this.healthMax=new jt(t.healthMax),this.health=new jt(t.health),this.staminaMax=new jt(t.staminaMax),this.stamina=new jt(t.stamina),this.baseDamage=new jt(t.baseDamage),this.speed=new jt(t.speed),this.coins=new jt(t.coins),this.inventory=new ns(new is)}}class Is extends ks{constructor(t){super(t),this.level=t.level,this.luck=t.luck,this.xp=t.xp,this.race=t.race,this.type=t.type,this.viewRange=t.viewRange,this.width=t.width,this.height=t.height,this.killedBy.subscribe(t=>{t instanceof Ns&&t.state.addXp(this.xp)},this)}}class Ss{constructor(t){this.t=t}init(){this.at=this.t.loader.resources["monster.config.json"].data}modify(t,s,i){return Math.floor(t+t*s*i)}spawnRandomMinion(t,s,i,h){const e=this.at.tiny.filter(s=>s.race===t&&"minion"===s.type),n=s.rng.select(e);return n?this.spawnTinyMonster(n,s,i,h):null}spawnRandomTinyMonster(t,s,i){const h=this.bossConfig(t.level).race,e=this.at.tiny.filter(t=>t.race===h||"demon"!=t.race&&"orc"!=t.race&&"zombie"!=t.race),n=t.rng.select(e);if(null===n)throw"No tiny monster config found";return this.spawnTinyMonster(n,t,s,i)}spawnTinyMonster(t,s,i,h){const e=new Is({name:t.name,healthMax:this.modify(t.health,.1,s.level),health:this.modify(t.health,.1,s.level),staminaMax:t.stamina,stamina:t.stamina,baseDamage:this.modify(t.damage,.1,s.level),speed:t.speed,coins:0,level:s.level,luck:t.luck,xp:35+5*s.level,race:t.race,type:t.type,viewRange:7,width:1,height:1}),n=e.luck<s.rng.float()?s.rng.select(t.weapons):null;if(n){const t=this.t.weaponManager.monsterWeapon(n);e.inventory.equipment.weapon.set(t)}return new Ct(e,s,i,h)}spawnRandomSummonMonster(t,s,i){const h=this.bossConfig(t.level).race,e=this.at.summon.filter(t=>t.race===h||"demon"!=t.race&&"orc"!=t.race&&"zombie"!=t.race),n=t.rng.select(e);if(null===n)throw"No summon monster config found";return this.spawnSummonMonster(n,t,s,i)}spawnSummonMonster(t,s,i,h){const e=new Is({name:t.name,healthMax:this.modify(t.health,.1,s.level),health:this.modify(t.health,.1,s.level),staminaMax:t.stamina,stamina:t.stamina,baseDamage:this.modify(t.damage,.1,s.level),speed:t.speed,coins:0,level:s.level,luck:t.luck,xp:35+5*s.level,race:t.race,type:"summon",viewRange:7,width:1,height:1}),n=e.luck<s.rng.float()?s.rng.select(t.weapons):null;if(n){const t=this.t.weaponManager.monsterWeapon(n);e.inventory.equipment.weapon.set(t)}return new Wt(e,s,i,h)}spawnLevelBossMonster(t,s,i){const h=this.bossConfig(t.level);return this.spawnBossMonster(h,t,s,i)}spawnBossMonster(t,s,i,h){const e=new Is({name:t.name,healthMax:this.modify(t.health,.1,s.level),health:this.modify(t.health,.1,s.level),staminaMax:t.stamina,stamina:t.stamina,baseDamage:this.modify(t.damage,.1,s.level),speed:t.speed,coins:0,level:s.level,luck:t.luck,xp:200+20*s.level,race:t.race,type:"boss",viewRange:7,width:2,height:2}),n=s.rng.select(t.weapons);if(n){const t=this.t.weaponManager.monsterWeapon(n);e.inventory.equipment.weapon.set(t)}return new Et(e,s,i,h)}bossConfig(t){return this.at.boss[Math.floor((t-1)/5)%this.at.boss.length]}}const Os=["elf_f","elf_m","knight_f","knight_m","wizard_f","wizard_m"];let Ns=(()=>{class s extends Ot{constructor(t,s,i,h){super(s,{x:i,y:h,width:1,height:1,zIndex:Y.hero,static:!1,interacting:!1,animation:t.name+"_idle",onPosition:(t,i)=>s.camera.setPosition(t,i)}),this.state=t,this.init()}init(){super.init(),this.state.inventory.drop.subscribe(this.onDrop,this)}destroy(){this.state.inventory.drop.unsubscribe(this.onDrop,this),super.destroy()}onDead(){this.destroy(),this.state.destroySession(),this._t.controller.dead()}onDrop(t){const[s]=t,i=this.findDropCell();i&&(i.dropItem=s)}scanDrop(){var s;(null===(s=this._t.cell(this.x,this.y).drop)||void 0===s?void 0:s.pickedUp(this))&&t.sound.play("fruit_collect")}scanHit(s,i){const h=this.state.weapon,e=(null==h?void 0:h.distance)||1,n=this.view.isLeft?1:2,r=this.scanMonsters(n,e),o=this.state.Ts(s,i);for(const t of r)t.state.hitDamage(this,o);r.length>0&&t.sound.play("hit_damage",{speed:(null==h?void 0:h.speed)||1})}dashToClosestMonster(){const[t]=this.scanMonsters(4,12);if(t){this.lookAt(t);const s=this.raycastDash(t);return this.move(s.x,s.y)}return!1}raycastDash(s){let i=this.x,h=this.y;const e=s.x,n=s.y,r=Math.abs(e-i),o=Math.abs(n-h),l=i<e?1:-1,a=h<n?1:-1;let c=(r>o?r:-o)/2;const u=new t.Point(i,h);for(;i!==e||h!==n;){const t=c;if(t>-r&&(c-=o,i+=l),t<o&&(c+=r,h+=a),i===e&&h===n)break;const s=this._t.cell(i,h);if(!s.hasFloor)break;if(s.collide(this))break;u.set(i,h)}return u}raycastDodge(s,i,h){let e=this.x,n=this.y;const r=new t.Point(e,n);for(let t=0;t<h;t++){e+=s,n+=i;const t=this._t.cell(e,n);if(!t.hasFloor)break;if(t.collide(this))break;r.set(e,n)}return r}lookAtClosestMonster(t){var s;const i=t||(null===(s=this.state.weapon)||void 0===s?void 0:s.distance)||1,[h]=this.scanMonsters(4,i);h&&this.lookAt(h)}scanAndInteract(){const t=this.view.isLeft?1:2,[s]=this.scanCells(t,1,t=>t.interacting);return!!s&&(s.interact(this),!0)}scanMonsters(t,s){return this._t.registry.query({type:Nt.type,filter:i=>!i.state.dead.get()&&this.distanceTo(i)<=s&&this.checkDirection(t,i)&&this.raycastIsVisible(i),sort:(t,s)=>this.metric(t)-this.metric(s)})}fsm(){const t=this._t.controller.joystick,s=new lt(0,[0,1,2,3,4,5,6]),i=this.idle(),h=this.run(),e=this.dash(),n=this.hit(new Ds(this,t,0)),r=this.hit(new Ds(this,t,1));return s.state(0).nested(i).onEnter(()=>this.scanDrop()).onUpdate(()=>this.processInventory()).onUpdate(()=>this.processModal()),s.state(0).transitionTo(3).condition(()=>t.hit.once()),s.state(0).transitionTo(2).condition(()=>t.dodge.once()).condition(()=>this.state.hasStamina(this.state.dashStamina)).condition(()=>this.processDodge()),s.state(0).transitionTo(1).condition(()=>this.processMove()),s.state(0).transitionTo(0).condition(()=>i.isFinal),s.state(1).nested(h).onEnter(()=>this.scanDrop()).onUpdate(()=>this.processInventory()),s.state(1).transitionTo(3).condition(()=>h.isFinal).condition(()=>t.hit.once()),s.state(1).transitionTo(2).condition(()=>h.isFinal).condition(()=>t.dodge.once()).condition(()=>this.state.hasStamina(this.state.dashStamina)).condition(()=>this.processDodge()),s.state(1).transitionTo(1).condition(()=>h.isFinal).condition(()=>this.processMove()),s.state(1).transitionTo(0).condition(()=>h.isFinal),s.state(2).nested(e).onEnter(()=>this.state.spendStamina(this.state.dashStamina)),s.state(2).transitionTo(3).condition(()=>e.isFinal).condition(()=>t.hit.once()),s.state(2).transitionTo(2).condition(()=>e.isFinal).condition(()=>t.dodge.once()).condition(()=>this.state.hasStamina(this.state.dashStamina)).condition(()=>this.processDodge()),s.state(2).transitionTo(1).condition(()=>e.isFinal).condition(()=>this.processMove()),s.state(2).transitionTo(0).condition(()=>e.isFinal),s.state(3).onUpdate(()=>this.lookAtClosestMonster(7)),s.state(3).transitionTo(0).condition(()=>0===this.scanMonsters(4,1).length).condition(()=>this.scanAndInteract()),s.state(3).transitionTo(5).condition(()=>!t.hit.triggered&&t.hit.duration>500).condition(()=>this.state.hasStamina(this.state.dashStamina+this.state.hitStamina)).condition(()=>this.dashToClosestMonster()),s.state(3).transitionTo(4).condition(()=>!t.hit.triggered).condition(()=>this.state.hasStamina(this.state.hitStamina)),s.state(3).transitionTo(0).condition(()=>!t.hit.triggered),s.state(4).nested(n).onEnter(()=>this.lookAtClosestMonster(1)),s.state(4).transitionTo(3).condition(()=>n.isFinal).condition(()=>t.hit.once()),s.state(4).transitionTo(2).condition(()=>n.isFinal).condition(()=>t.dodge.once()).condition(()=>this.state.hasStamina(this.state.dashStamina)).condition(()=>this.processDodge()),s.state(4).transitionTo(1).condition(()=>n.isFinal).condition(()=>this.processMove()),s.state(4).transitionTo(0).condition(()=>n.isFinal),s.state(5).nested(e).transitionTo(6).condition(()=>e.isFinal),s.state(6).nested(r).onEnter(()=>this.lookAtClosestMonster(1)),s.state(6).transitionTo(3).condition(()=>r.isFinal).condition(()=>t.hit.once()),s.state(6).transitionTo(2).condition(()=>r.isFinal).condition(()=>t.dodge.once()).condition(()=>this.state.hasStamina(this.state.dashStamina)).condition(()=>this.processDodge()),s.state(6).transitionTo(1).condition(()=>r.isFinal).condition(()=>this.processMove()),s.state(6).transitionTo(0).condition(()=>r.isFinal),s}processMove(){const[t,s]=this._t.controller.joystick.direction;return this.tryMove(t,s)}processDodge(){const[t,s]=this._t.controller.joystick.direction;if(0!==t||0!==s){const i=this.raycastDodge(t,s,7);return this.move(i.x,i.y)}return!1}processInventory(){const t=this._t.controller.joystick,s=this.state.inventory;for(let s=0;s<=9;s++){const i=(s+1)%10;t.digit(i).once()&&this.state.inventory.belt.cell(s).use(this.state)}t.drop.once()&&s.equipment.weapon.drop()}processModal(){const t=this._t.controller.joystick;t.inventory.once()&&this._t.controller.showInventory(this.state),t.stats.once()&&this._t.controller.showStats(this.state)}}return s.type=t=>t instanceof s,s})();class Ds{constructor(t,s,i){this.t=t,this.K=s,this.As=i}continueCombo(){return this.K.hit.once()&&this.t.state.hasStamina(this.t.state.hitStamina)}onHit(t){this.t.scanHit(t,this.As)}}var Es,Ts;(t=>{t[t.IDLE=0]="IDLE",t[t.RUN=1]="RUN",t[t.DODGE=2]="DODGE",t[t.HIT_TRIGGERED=3]="HIT_TRIGGERED",t[t.LIGHT_ATTACK=4]="LIGHT_ATTACK",t[t.CHARGED_DASH=5]="CHARGED_DASH",t[t.CHARGED_ATTACK=6]="CHARGED_ATTACK"})(Es||(Es={}));class As extends _s{constructor(t,s,i,h){super(),this.li=s,this.ai=i,this.name=t,this.healthMax=this.li.floatVar("healthMax",30),this.health=this.ai.floatVar("health",30),this.staminaMax=this.li.floatVar("staminaMax",70),this.stamina=this.ai.floatVar("stamina",70),this.baseDamage=this.li.integerVar("baseDamage",3),this.speed=this.li.floatVar("speed",1),this.coins=this.li.integerVar("coins",0),this.inventory=new ns(new hs(this.ai,h)),this.level=this.li.integerVar("level",1),this.levelXp=this.li.integerVar("levelXp",0),this.xp=this.li.integerVar("xp",0),this.skillPoints=this.li.integerVar("skillPoints",0),this.dungeons=new Ls(this.ai)}destroySession(){this.ai.clear(),this.ai.destroy()}addXp(t){this.xp.update(s=>{let i=s+t;for(;;){const t=this.levelXp.get();if(!(i>=t))break;i-=t,this.level.update(t=>t+1),this.levelXp.update(t=>t+1e3),this.skillPoints.update(t=>t+1)}return i})}increaseHealthMax(){this.healthMax.update(t=>t+1)}increaseStamina(){this.staminaMax.update(t=>t+1)}increaseBaseDamage(){this.baseDamage.update(t=>t+1)}increaseSpeed(){this.speed.update(t=>t+.01)}}class Ls{constructor(t){this._t=t.prefix("dungeon"),this.ci=t.prefix("bonfire")}assertNaN(t){if(isNaN(t))throw"NaN"}hasSeed(t){return this.assertNaN(t),null!==this._t.get(""+t)}setSeed(t,s){this.assertNaN(t),this.assertNaN(s),this._t.set(""+t,""+s)}getSeed(t){return this.assertNaN(t),parseInt(this._t.get(""+t))}hasBonfire(t){return this.assertNaN(t),null!==this.ci.get(""+t)}litBonfire(t){return this.assertNaN(t),null!==this.ci.set(""+t,"true")}bonfires(){return this.ci.keys().map(t=>parseInt(t)).sort((t,s)=>t-s)}}class Ps{constructor(t){this.t=t,this.Bs=t.store}state(t){const s=this.Bs.prefix(t),i=s.prefix("global"),h=s.prefix("session"),e=h.isEmpty(),n=new As(t,i,h,this.t.weaponManager);if(e){const t=this.t.weaponManager.heroWeapon("knife");n.inventory.equipment.weapon.set(t)}return n}}class Rs extends t.Container{constructor(s,i){super(),this.ui=i.fixedHPSize,this.fi=i.hpBarSize||(256-(a<<1))/30,this.di=i.maxBarSize||256,this.wi=this.di-(a<<1);const h=18+(a<<1)+c;this.jt=s,this.Ps=new u({color:r,width:this.wi,valueMax:s.state.healthMax.get()}),this.Rs=new u({color:o,width:this.wi,valueMax:s.state.staminaMax.get()}),this.Rs.position.set(0,h),this.pi=new u({color:l,width:this.wi,valueMax:s.state.levelXp.get()}),this.pi.position.set(0,2*h),this.dt=new t.BitmapText("",{font:{name:"alagard",size:16}}),this.dt.position.set(0,3*h),super.addChild(this.Ps,this.Rs,this.pi,this.dt),s.state.healthMax.subscribe(this.updateHealthMax,this),s.state.health.subscribe(this.updateHealth,this),s.state.staminaMax.subscribe(this.updateStaminaMax,this),s.state.stamina.subscribe(this.updateStamina,this),s.state.level.subscribe(this.updateXp,this),s.state.levelXp.subscribe(this.updateXp,this),s.state.skillPoints.subscribe(this.updateXp,this),s.state.xp.subscribe(this.updateXp,this),s.state.coins.subscribe(this.updateCoins,this)}destroy(){super.destroy(),this.jt.state.healthMax.unsubscribe(this.updateHealthMax,this),this.jt.state.health.unsubscribe(this.updateHealth,this),this.jt.state.staminaMax.unsubscribe(this.updateStaminaMax,this),this.jt.state.stamina.unsubscribe(this.updateStamina,this),this.jt.state.level.unsubscribe(this.updateXp,this),this.jt.state.levelXp.unsubscribe(this.updateXp,this),this.jt.state.skillPoints.unsubscribe(this.updateXp,this),this.jt.state.xp.unsubscribe(this.updateXp,this),this.jt.state.coins.unsubscribe(this.updateCoins,this)}updateHealthMax(t){const s=this.jt.state.health.get();this.Ps.valueMax=t,this.Ps.label=`${s.toFixed(1)}/${t}`,this.ui||(this.Ps.rectWidth=this.fi*t)}updateHealth(t){const s=this.jt.state.healthMax.get();this.Ps.value=t,this.Ps.label=`${t.toFixed(1)}/${s}`}updateStaminaMax(t){const s=this.jt.state.stamina.get();this.Rs.valueMax=t,this.Rs.label=`${s.toFixed(1)}/${t}`}updateStamina(t){const s=this.jt.state.staminaMax.get();this.Rs.value=t,this.Rs.label=`${t.toFixed(1)}/${s}`}updateXp(){const t=this.jt,s=t.state.level.get(),i=t.state.levelXp.get(),h=t.state.skillPoints.get(),e=t.state.xp.get();this.pi.valueMax=i,this.pi.value=e,this.pi.label=`L:${s} XP:${e}/${i} SP:${h}`}updateCoins(t){this.dt.text="$"+t}}class Cs extends _{constructor(t,s){super(t,"Hero stats"),this.jt=s}init(){super.init(),this.t.ticker.add(this.handleInput,this);const t=this.R=new y({spacing:c,padding:0});this.addChild(t);const s=(s,i,h)=>{const e=new PIXI.BitmapText(h,{font:{name:"alagard",size:16},tint:l});t.setGrid(s,i,e)},i=(s,i)=>{const h=new PIXI.BitmapText("",{font:{name:"alagard",size:16}});h.anchor=new PIXI.Point(1,0),h.position.set(100,0);const e=new w({width:100});return e.addChild(h),t.setGrid(s,i,e),h};s(0,0,"Level"),s(1,0,"XP"),s(2,0,"Skill points"),this.gi=i(0,1),this.yi=i(1,1),this.mi=i(2,1),this.vi=new zs(this.jt,t,3,this.X,1),this.bi=new Hs(this.jt,t,4,this.X,2),this.xi=new Gs(this.jt,t,5,this.X,3),this._i=new Bs(this.jt,t,6,this.X,4),this.jt.level.subscribe(this.updateLevel,this),this.jt.levelXp.subscribe(this.updateLevelXp,this),this.jt.xp.subscribe(this.updateXp,this),this.jt.skillPoints.subscribe(this.updateSkillPoints,this)}updateLevel(t){this.gi.text=""+t,this.R.updateLayout()}updateLevelXp(t){this.yi.text=`${this.jt.xp.get()}/${t}`,this.R.updateLayout()}updateXp(t){this.yi.text=`${t}/${this.jt.levelXp.get()}`,this.R.updateLayout()}updateSkillPoints(t){this.mi.text=""+t,this.R.updateLayout()}destroy(){this.t.ticker.remove(this.handleInput,this),this.jt.level.unsubscribe(this.updateLevel,this),this.jt.levelXp.unsubscribe(this.updateLevelXp,this),this.jt.xp.unsubscribe(this.updateXp,this),this.jt.skillPoints.unsubscribe(this.updateSkillPoints,this),this.vi.destroy(),this.bi.destroy(),this.xi.destroy(),this._i.destroy(),super.destroy()}handleInput(){this.t.joystick.stats.once()&&this.t.closeModal()}}class $s{constructor(t,s,i,h,e,n){this.Mi=!1,this.ki=!1,this.jt=t,this.m=new PIXI.BitmapText(s,{font:{name:"alagard",size:16},tint:l}),this.I=new PIXI.BitmapText(s,{font:{name:"alagard",size:16}}),this.I.anchor=new PIXI.Point(1,0),this.I.position.set(100,0);const r=new w({width:100});r.addChild(this.I),this.Ii=[],this.Si=new f({label:"-",width:18,height:18}),this.Oi=new f({label:"+",width:18,height:18}),this.R=i,this.Ni=h,this.X=e,this.Di=n,this.R.setGrid(this.Ni,0,this.m),this.R.setGrid(this.Ni,1,r),this.R.setGrid(this.Ni,2,this.Si),this.R.setGrid(this.Ni,3,this.Oi),this.X.set(0,this.Di,this.Si,()=>{this.Mi&&this.onDecrease()}),this.X.set(1,this.Di,this.Oi,()=>{this.ki&&this.onIncrease()}),this.disableDecrease(),this.disableIncrease(),this.jt.skillPoints.subscribe(this.updateSkillPoints,this)}destroy(){this.jt.skillPoints.unsubscribe(this.updateSkillPoints,this)}updateSkillPoints(t){t>0?this.enableIncrease():this.disableIncrease()}enableDecrease(){this.Mi=!0,this.Si.alpha=1}disableDecrease(){this.Mi=!1,this.Si.alpha=.5}enableIncrease(){this.ki=!0,this.Oi.alpha=1}disableIncrease(){this.ki=!1,this.Oi.alpha=.5}onDecrease(){if(0===this.Ii.length)throw"illegal state";this.jt.skillPoints.update(t=>t+1);const t=this.Ii.pop();this.decrease(t),0===this.Ii.length&&this.disableDecrease()}onIncrease(){if(0===this.jt.skillPoints.get())throw"illegal state";this.Ii.push(this.current()),this.increase(),this.jt.skillPoints.update(t=>t-1),this.enableDecrease()}}class zs extends $s{constructor(t,s,i,h,e){super(t,"Health",s,i,h,e),this.jt.healthMax.subscribe(this.updateHealthMax,this),this.jt.health.subscribe(this.updateHealth,this)}destroy(){super.destroy(),this.jt.healthMax.unsubscribe(this.updateHealthMax,this),this.jt.health.unsubscribe(this.updateHealth,this)}updateHealthMax(t){this.I.text=`${this.jt.health.get()}/${t}`,this.R.updateLayout()}updateHealth(t){this.I.text=`${t}/${this.jt.healthMax.get()}`,this.R.updateLayout()}decrease(t){this.jt.healthMax.set(t)}current(){return this.jt.healthMax.get()}increase(){this.jt.increaseHealthMax()}}class Hs extends $s{constructor(t,s,i,h,e){super(t,"Stamina",s,i,h,e),this.jt.staminaMax.subscribe(this.updateStaminaMax,this)}destroy(){super.destroy(),this.jt.staminaMax.unsubscribe(this.updateStaminaMax,this)}updateStaminaMax(t){this.I.text=""+t,this.R.updateLayout()}current(){return this.jt.staminaMax.get()}decrease(t){this.jt.staminaMax.set(t)}increase(){this.jt.increaseStamina()}}class Gs extends $s{constructor(t,s,i,h,e){super(t,"Base damage",s,i,h,e),this.jt.baseDamage.subscribe(this.updateBaseDamage,this)}destroy(){super.destroy(),this.jt.baseDamage.unsubscribe(this.updateBaseDamage,this)}updateBaseDamage(t){this.I.text=""+t,this.R.updateLayout()}current(){return this.jt.baseDamage.get()}decrease(t){this.jt.baseDamage.set(t)}increase(){this.jt.increaseBaseDamage()}}class Bs extends $s{constructor(t,s,i,h,e){super(t,"Speed",s,i,h,e),this.jt.speed.subscribe(this.updateSpeed,this)}destroy(){super.destroy(),this.jt.speed.unsubscribe(this.updateSpeed,this)}updateSpeed(t){this.I.text=""+t,this.R.updateLayout()}current(){return this.jt.speed.get()}decrease(t){this.jt.speed.set(t)}increase(){this.jt.increaseSpeed()}}class Us extends s{constructor(t,s){super(t),this._t=s}init(){const t=this.t.screen,s=new et(this._t.level);s.position.set(t.width>>1,16),s.zIndex=10,this.addChild(s),this._t.layer.zIndex=0,this.addChild(this._t.layer),this._t.light.layer.zIndex=1,this.addChild(this._t.light.layer),this._t.light.shadow.zIndex=2,this._t.light.shadow.alpha=.8,this.addChild(this._t.light.shadow);const[i]=this._t.registry.query({type:Ns.type}),h=new us(this.t.resources,i.state.inventory.belt),e=h.width;h.position.set((t.width>>1)-(e>>1),t.height-52),h.zIndex=11,this.addChild(h);const n=new Rs(i,{fixedHPSize:!1});n.position.set(16,16),n.zIndex=12,this.addChild(n);const[r]=this._t.registry.query({type:Et.type});if(r){const s=new Rt(r);s.zIndex=13,s.position.set(t.width>>1,64),this.addChild(s)}this.sortChildren(),this._t.ticker.start()}destroy(){this._t.destroy(),super.destroy({children:!0})}pause(){this._t.ticker.stop()}resume(){this._t.ticker.start()}}async function Fs(t=0){return await new Promise(s=>setTimeout(s,t))}function Ws(t,s){const i=[];for(let h=0;h<t;h++)i.push(s);return i}(t=>{t[t.Decided=0]="Decided",t[t.Undecided=-1]="Undecided",t[t.Contradiction=-2]="Contradiction"})(Ts||(Ts={}));let js=(()=>{class t{constructor(t,s,i){this.wave=[],this.propagator=[],this.compatible=[],this.observed=null,this.toPropagate=[],this.backtrackItems=[],this.Ei=[],this.Ti=[],this.Ai=0,this.T=0,this.periodic=!1,this.weights=[],this.weightLogWeights=[],this.sumsOfOnes=[],this.sumOfWeights=0,this.sumOfWeightLogWeights=0,this.startingEntropy=0,this.sumsOfWeights=[],this.sumsOfWeightLogWeights=[],this.entropies=[],this.status=Ts.Undecided,this.deferredConstraintsStep=!1,this.debug=!1,this.rng=t,this.FMX=s,this.FMY=i}get percent(){let t=0;for(let s=0;s<this.wave.length;s++)1===this.sumsOfOnes[s]&&t++;return 100*t/this.wave.length}init(){this.wave=Ws(this.FMX*this.FMY,[]),this.compatible=[];for(let t=0;t<this.wave.length;t++){this.wave[t]=Ws(this.T,!0),this.compatible[t]=[];for(let s=0;s<this.T;s++)this.compatible[t][s]=Ws(4,0)}this.weightLogWeights=[],this.sumOfWeights=0,this.sumOfWeightLogWeights=0;for(let t=0;t<this.T;t++)this.weightLogWeights[t]=this.weights[t]*Math.log(this.weights[t]),this.sumOfWeights+=this.weights[t],this.sumOfWeightLogWeights+=this.weightLogWeights[t];this.startingEntropy=Math.log(this.sumOfWeights)-this.sumOfWeightLogWeights/this.sumOfWeights,this.status=Ts.Undecided,this.initConstraint()}clear(){this.sumsOfOnes=[],this.sumsOfWeights=[],this.sumsOfWeightLogWeights=[],this.entropies=[];for(let s=0;s<this.wave.length;s++){for(let i=0;i<this.T;i++){this.wave[s][i]=!0;for(let h=0;h<4;h++)this.compatible[s][i][h]=this.propagator[t.opposite[h]][i].length}this.sumsOfOnes[s]=this.weights.length,this.sumsOfWeights[s]=this.sumOfWeights,this.sumsOfWeightLogWeights[s]=this.sumOfWeightLogWeights,this.entropies[s]=this.startingEntropy}this.toPropagate=[],this.backtrackItems=[],this.Ei=[0],this.Ai=0,this.Ti=[],this.status=Ts.Undecided}async run(t=0,s=!1){0===this.wave.length&&this.init(),this.clear(),this.debug=s;let i=0;for(;(i<t||0===t)&&(i%50==0&&await Fs(),this.debug,this.step(),this.debug&&this.graphics([]),this.status===Ts.Undecided);i++);return this.status}step(){let t,s=-1,i=!1;this.deferredConstraintsStep&&(this.debug,this.stepConstraint()),this.status!=Ts.Undecided&&(s=0,i=!0,this.debug),i||(this.Ei.push(this.Ai+this.backtrackItems.length),[s,t]=this.observe(),this.debug,-1!==s&&(this.debug,this.Ti.push([s,t])));do{if(this.debug,i=!1,this.debug,this.status===Ts.Undecided&&this.propagate(),this.status===Ts.Undecided&&this.stepConstraint(),-1===s&&this.status===Ts.Undecided)return this.debug,this.status=Ts.Decided,this.status;if(this.status===Ts.Contradiction)for(this.debug,s=0;;){if(this.debug,1==this.Ei.length)return this.debug,Ts.Contradiction;this.backtrack();const t=this.Ti.pop();if(this.toPropagate=[],this.status=Ts.Undecided,this.debug&&this.graphics([t[0]]),this.internalBan(t[0],t[1])&&(this.status=Ts.Contradiction),this.status===Ts.Undecided&&this.propagate(),this.status!==Ts.Contradiction){this.debug,this.Ei.pop(),this.Ei.push(this.Ai+this.backtrackItems.length),this.debug,i=!0;break}this.debug}}while(i);return this.status}observe(){this.debug;let t=1e3,s=-1;for(let i=0;i<this.wave.length;i++){if(this.onBoundary(i%this.FMX,Math.floor(i/this.FMX)))continue;const h=this.sumsOfOnes[i];if(0===h)return this.debug,this.debug&&this.graphics([i]),this.status=Ts.Contradiction,[-1,-1];const e=this.entropies[i];if(h>1&&e<=t){const h=1e-6*this.rng.float();e+h<t&&(t=e+h,s=i)}}if(-1==s){this.debug,this.observed=Ws(this.FMX*this.FMY,0);for(let t=0;t<this.wave.length;t++){const s=t%this.FMX,i=Math.floor(t/this.FMX);if(!this.onBoundary(s,i)){this.testObserved(t);for(let s=0;s<this.T;s++)if(this.wave[t][s]){this.observed[t]=s;break}}}return[-1,-1]}let i=0;const h=[];for(let t=0;t<this.T;t++)h[t]=this.wave[s][t]?this.weights[t]:0,i+=h[t];let e=this.rng.float()*i,n=0;for(const t of h){if(e-=t,e<0)break;n++}const r=this.wave[s];for(let t=0;t<this.T;t++)r[t]!=(t==n)&&(this.debug,this.internalBan(s,t)&&(this.status=Ts.Contradiction));return this.debug&&this.graphics([s]),[s,n]}propagate(){for(;this.toPropagate.length>0;){const[s,i]=this.toPropagate.pop(),h=s%this.FMX,e=Math.floor(s/this.FMX);for(let s=0;s<4;s++){let n=h+t.DX[s],r=e+t.DY[s];if(this.onBoundary(n,r))continue;n<0?n+=this.FMX:n>=this.FMX&&(n-=this.FMX),r<0?r+=this.FMY:r>=this.FMY&&(r-=this.FMY);const o=n+r*this.FMX,l=this.propagator[s][i],a=this.compatible[o];for(const t of l){const i=a[t];i[s]--,0==i[s]&&this.internalBan(o,t)&&(this.status=Ts.Contradiction)}}if(this.status==Ts.Contradiction)break}}ban(t,s){return this.debug,this.wave[t][s]&&(this.deferredConstraintsStep=!0,this.internalBan(t,s))?this.status=Ts.Contradiction:(this.propagate(),this.status)}internalBan(t,s){this.debug,this.wave[t][s]=!1;const i=this.compatible[t][s];for(let t=0;t<4;t++)i[t]-=this.T;this.toPropagate.push([t,s]),this.sumsOfOnes[t]-=1,this.sumsOfWeights[t]-=this.weights[s],this.sumsOfWeightLogWeights[t]-=this.weightLogWeights[s];const h=this.sumsOfWeights[t];return this.entropies[t]=Math.log(h)-this.sumsOfWeightLogWeights[t]/h,this.backtrackItems.push([t,s]),this.banConstraint(t,s),0===this.sumsOfOnes[t]&&(this.debug&&this.graphics([t]),!0)}backtrack(){const s=this.Ei.pop()-this.Ai;this.debug;const i=[],h=new Set(this.toPropagate.map(t=>t.join(",")));for(;this.backtrackItems.length>s;){const[s,e]=this.backtrackItems.pop();i.push(s);const n=this.compatible[s][e];for(let t=0;t<4;t++)n[t]+=this.T;this.wave[s][e]=!0,this.sumsOfOnes[s]+=1,this.sumsOfWeights[s]+=this.weights[e],this.sumsOfWeightLogWeights[s]+=this.weightLogWeights[e];const r=this.sumsOfWeights[s];if(this.entropies[s]=Math.log(r)-this.sumsOfWeightLogWeights[s]/r,!h.has([s,e].join(","))){const h=s%this.FMX,n=Math.floor(s/this.FMX);for(let s=0;s<4;s++){let r=h+t.DX[s],o=n+t.DY[s];if(this.onBoundary(r,o))continue;r<0?r+=this.FMX:r>=this.FMX&&(r-=this.FMX),o<0?o+=this.FMY:o>=this.FMY&&(o-=this.FMY);const l=r+o*this.FMX;i.push(l);const a=this.propagator[s][e];for(const t of a)this.compatible[l][t][s]++}}this.backtrackConstraint(s,e)}this.debug&&this.graphics(i)}}return t.DX=[-1,0,1,0],t.DY=[0,1,0,-1],t.opposite=[2,3,0,1],t})(),Ks=(()=>{class t{constructor(t=0,s=0){this.x=t,this.y=s}plus(s){return new t(this.x+s.x,this.y+s.y)}minus(s){return new t(this.x-s.x,this.y-s.y)}multiply(s){return new t(this.x*s,this.y*s)}get negative(){return new t(-this.x,-this.y)}equal(t,s){return this.x===t&&this.y===s}equals(t){return this.x===t.x&&this.y===t.y}toString(){return`{x: ${this.x}, y: ${this.y}}`}static from(s){return new t(s.x,s.y)}}return t.NORTH=new t(-1,0),t.SOUTH=new t(1,0),t.EAST=new t(0,1),t.WEST=new t(0,-1),t.NORTH_EAST=new t(-1,1),t.SOUTH_EAST=new t(1,1),t.SOUTH_WEST=new t(1,-1),t.NORTH_WEST=new t(-1,-1),t.ZERO=new t(0,0),t})();var Xs,Vs,qs,Ys,Js;(t=>{t[t.NORTH=0]="NORTH",t[t.EAST=1]="EAST",t[t.SOUTH=2]="SOUTH",t[t.WEST=3]="WEST",t[t.NORTH_EAST=4]="NORTH_EAST",t[t.SOUTH_EAST=5]="SOUTH_EAST",t[t.SOUTH_WEST=6]="SOUTH_WEST",t[t.NORTH_WEST=7]="NORTH_WEST"})(Xs||(Xs={})),(t=>{t[t.OPEN=0]="OPEN",t[t.CLOSED=1]="CLOSED",t[t.GUARANTEED_OPEN=2]="GUARANTEED_OPEN",t[t.GUARANTEED_CLOSED=3]="GUARANTEED_CLOSED",t[t.NON_JOIN_OPEN=4]="NON_JOIN_OPEN",t[t.NON_JOIN_CLOSED=5]="NON_JOIN_CLOSED",t[t.NON_JOIN_GUARANTEED_OPEN=6]="NON_JOIN_GUARANTEED_OPEN",t[t.NON_JOIN_GUARANTEED_CLOSED=7]="NON_JOIN_GUARANTEED_CLOSED",t[t.INSIDE_ROOM_OPEN=8]="INSIDE_ROOM_OPEN",t[t.INSIDE_TUNNEL_OPEN=9]="INSIDE_TUNNEL_OPEN",t[t.INSIDE_ANTEROOM_OPEN=10]="INSIDE_ANTEROOM_OPEN",t[t.H_DOOR=11]="H_DOOR",t[t.V_DOOR=12]="V_DOOR",t[t.COLUMN=13]="COLUMN"})(Vs||(Vs={})),(t=>{t[t.SMALL=0]="SMALL",t[t.MEDIUM=1]="MEDIUM",t[t.LARGE=2]="LARGE"})(qs||(qs={}));class Qs{constructor(t=[]){this.inside=t,this.inDungeon=!1}randomSquare(){return this.inside[Math.floor(Math.random()*this.inside.length)]}center(){let t=0,s=0;for(const i of this.inside)t+=i.x,s+=i.y;t/=this.inside.length,s/=this.inside.length;const i=i=>Math.max(Math.abs(t-i.x),Math.abs(s-i.y));let h=this.inside[0],e=i(h);for(const t of this.inside){const s=i(t);s<e&&(h=t,e=s)}return h}static compare(t,s){return t.inside.length-s.inside.length}}class Zs{constructor(t,s,i,h,e){this.startX=t,this.startY=s,this.endX=i,this.endY=h,this.type=e}}class ti{constructor(t,s,i,h,e,n,r){this.rng=t,this.dungeonCrawler=s,this.config=s.config,this.location=i,this.direction=h,this.age=e,this.maxAge=n,this.generation=r}rightDirection(){if(0===this.direction.x)return new Ks(this.direction.y,0);if(0===this.direction.y)return new Ks(0,-this.direction.x);throw"illegal direction"}valid(t){return t.x>=0&&t.y>=0&&t.x<this.config.width&&t.y<this.config.height}validDirection(t){return 0===t.x&&(-1===t.y||1===t.y)||0===t.y&&(-1===t.x||1===t.x)}frontFree(t,s,i,h){let e;if(0===s.x)e=new Ks(s.y,0);else{if(0!==s.y)throw"invalid heading";e=new Ks(0,-s.x)}const n=this.findFrontFree(i,h,t,e,s);return n>0&&(i=this.findLeftFree(i,n,t,e,s),h=this.findRightFree(h,n,t,e,s)),[n,i,h]}findFrontFree(t,s,i,h,e){let n=0;for(;;){n++;for(let r=-t;r<=s;r++){const t=i.plus(h.multiply(r)).plus(e.multiply(n));if(!this.valid(t))return Math.max(0,n-1);if(this.freePredicate(this.dungeonCrawler.getMap(t)))return Math.max(0,n-1)}}}findLeftFree(t,s,i,h,e){for(;;){t++;for(let n=1;n<=s;n++){const s=i.minus(h.multiply(t)).plus(e.multiply(n));if(!this.valid(s))return t-1;if(this.freePredicate(this.dungeonCrawler.getMap(s)))return t-1}}}findRightFree(t,s,i,h,e){for(;;){t++;for(let n=1;n<=s;n++){const s=i.plus(h.multiply(t)).plus(e.multiply(n));if(!this.valid(s))return t-1;if(this.freePredicate(this.dungeonCrawler.getMap(s)))return t-1}}}freePredicate(t){return t!==Vs.CLOSED&&t!==Vs.NON_JOIN_CLOSED}contains(t,...s){for(const i of s)if(t===i)return!0;return!1}}class si extends ti{constructor(t,s,i,h,e,n,r,o,l){super(t,s,i,h,e,n,r),this.Li=o,this.Pi=l}stepAhead(){if(!this.dungeonCrawler.isMoreRoomsDungeon(this.Pi))return!1;if(this.generation!==this.dungeonCrawler.activeGeneration)return!0;if(this.age++,this.age>=this.maxAge)return!1;if(this.age<0)return!0;const t=this.rightDirection();let s=this.Li;const i=this.getMinRoomSize(this.Pi),h=this.getMaxRoomSize(this.Pi);let e,n,r;do{[r,e,n]=this.frontFree(this.location,this.direction,s+1,s+1);let o=r-2,l=e+n-1;if(o<2)break;if(l/o<this.config.roomAspectRatio&&(o=Math.floor(l/this.config.roomAspectRatio),this.config.roomAspectRatio),o/l<this.config.roomAspectRatio&&(l=Math.floor(o/this.config.roomAspectRatio),this.config.roomAspectRatio),l/o<this.config.roomAspectRatio)return!1;for(;o*l>h;)o>l?o--:l>o?l--:this.rng.range(0,100)<50?o--:l--;if(o*l>=i){const s=new Qs;return e<=n?(2*e-1>l?this.attachRoom(s,t,o,(l>>1)-l+1,l>>2):this.attachRoom(s,t,o,1-e,-e+l),0===this.direction.x?this.dungeonCrawler.setMap(this.location.plus(this.direction),Vs.V_DOOR):this.dungeonCrawler.setMap(this.location.plus(this.direction),Vs.H_DOOR)):(2*n-1>l?this.attachRoom(s,t,o,-(l>>1),-(l>>1)+l-1):this.attachRoom(s,t,o,n-l,n-1),0===this.direction.x?this.dungeonCrawler.setMap(this.location.plus(this.direction),Vs.V_DOOR):this.dungeonCrawler.setMap(this.location.plus(this.direction),Vs.H_DOOR)),this.dungeonCrawler.builtRoomDungeon(this.Pi),s.inDungeon=!0,this.dungeonCrawler.addRoom(s),!1}s++}while(r-2>=(2*s+1)*this.config.roomAspectRatio);return!1}attachRoom(t,s,i,h,e){for(let n=1;n<=i;n++)for(let i=h;i<=e;i++){const h=this.location.plus(this.direction.multiply(n+1)).plus(s.multiply(i));this.dungeonCrawler.setMap(h,Vs.INSIDE_ROOM_OPEN),t.inside.push(h)}}getMinRoomSize(t){switch(t){case qs.SMALL:return this.config.minRoomSize;case qs.MEDIUM:return this.config.mediumRoomSize;case qs.LARGE:return this.config.largeRoomSize}}getMaxRoomSize(t){switch(t){case qs.SMALL:return this.config.mediumRoomSize-1;case qs.MEDIUM:return this.config.largeRoomSize-1;case qs.LARGE:return this.config.maxRoomSize-1}}}class ii extends ti{constructor(t,s,i,h,e,n,r,o,l,a,c,u,f,d,w,p){super(t,s,i,h,e,n,r),this.Ri=o,this.Ci=l,this.$i=a,this.zi=c,this.Hi=u,this.Gi=f,this.Bi=d,this.Ui=w,this.Fi=p}freePredicate(t){if(this.config.crawlersInTunnels&&this.config.crawlersInAnterooms){if(!this.contains(t,Vs.OPEN,Vs.NON_JOIN_OPEN,Vs.GUARANTEED_OPEN,Vs.INSIDE_TUNNEL_OPEN,Vs.INSIDE_ANTEROOM_OPEN,Vs.NON_JOIN_GUARANTEED_OPEN))return!0}else if(this.config.crawlersInTunnels){if(!this.contains(t,Vs.OPEN,Vs.NON_JOIN_OPEN,Vs.GUARANTEED_OPEN,Vs.INSIDE_TUNNEL_OPEN,Vs.NON_JOIN_GUARANTEED_OPEN))return!0}else if(!this.contains(t,Vs.OPEN,Vs.NON_JOIN_OPEN,Vs.GUARANTEED_OPEN,Vs.NON_JOIN_GUARANTEED_OPEN))return!0;return!1}stepAhead(){if(this.generation!==this.dungeonCrawler.activeGeneration)return!0;if(this.age++,this.age>=this.maxAge)return!1;if(this.age<0)return!0;const[t,s,i]=this.frontFree(this.location,this.direction,this.zi,this.zi),h=this.rightDirection(),e=h.negative;let n=h;if(0===this.$i&&t<this.config.joinDistance&&this.join(t))return!1;let r=this.Ci;if(t>this.zi){t-this.zi<this.Ci&&(r=t-this.zi);for(let t=1;t<=r;t++)n=this.location.plus(this.direction.multiply(t)),1===this.$i?this.dungeonCrawler.setMap(n,Vs.CLOSED):this.dungeonCrawler.setMap(n,Vs.NON_JOIN_CLOSED);this.location=n;const o=this.rng.range(0,100);let l=this.generation+1,a=0;for(let t=0;t<=10;t++)if(a+=this.getChildDelayProbabilityForGenerationCrawlers(t),o<a){l=this.generation+t;break}const c={straightSingleSpawnProbability:this.dungeonCrawler.mutate(this.Hi),straightDoubleSpawnProbability:this.dungeonCrawler.mutate(this.Gi),turnSingleSpawnProbability:this.dungeonCrawler.mutate(this.Bi),turnDoubleSpawnProbability:this.dungeonCrawler.mutate(this.Ui),changeDirectionProbability:this.dungeonCrawler.mutate(this.Fi)};if(this.rng.range(0,100)<this.Fi){const t=this.direction;if(0===this.Ri.x&&0===this.Ri.y||this.Ri.x===this.direction.x&&this.Ri.y===this.direction.y){const t=this.rng.range(0,4);0===t?this.direction=h:1===t?this.direction=e:i>s||i===s&&this.rng.boolean()?this.direction=h:this.direction=e}else 0===this.Ri.x||0===this.Ri.y?this.direction=this.Ri:this.direction=this.Ri.minus(this.direction);this.rng.range(0,100)<this.Ui?(this.spawnWallCrawler(this.direction.negative,this.direction.negative,l,c),this.spawnWallCrawler(t,t,l,c)):this.rng.range(0,100)<this.Bi&&this.spawnWallCrawler(this.direction.negative,this.direction.negative,l,c)}else this.rng.range(0,100)<this.Gi?(this.spawnWallCrawler(h,h,l,c),this.spawnWallCrawler(e,e,l,c)):this.rng.range(0,100)<this.Hi&&(n=s>i||s===i&&this.rng.boolean()?e:h,0===this.rng.range(0,3)&&(n=n.negative),this.spawnWallCrawler(n,n,l,c))}else if(this.direction.equals(this.Ri)||this.Ri.equal(0,0)){const[t]=this.frontFree(this.location,h,this.zi,this.zi),[s]=this.frontFree(this.location,e,this.zi,this.zi);if(t<=this.zi&&s<=this.zi)return!1;t>2*this.zi+1&&s>2*this.zi+1?this.rng.boolean()?this.direction=h:this.direction=e:t>s?this.direction=h:s>t?this.direction=e:this.rng.boolean()?this.direction=h:this.direction=e}else if(0===this.Ri.x||0===this.Ri.y){const[t]=this.frontFree(this.location,this.Ri,this.zi,this.zi);if(!(t>this.zi))return!1;this.direction=this.Ri}else{n=this.Ri.minus(this.direction);const[t]=this.frontFree(this.location,n,this.zi,this.zi);if(!(t>this.zi))return!1;this.direction=n}return!0}spawnWallCrawler(t,s,i,h){this.rng.range(0,100)<this.config.noHeadingProbability&&(s=Ks.ZERO),this.dungeonCrawler.createWallCrawler(this.location,t,0,this.dungeonCrawler.getMaxAgeCrawlers(i),i,s,this.dungeonCrawler.getStepLength(i),1,this.dungeonCrawler.getCorridorWidth(i),h.straightSingleSpawnProbability,h.straightDoubleSpawnProbability,h.turnSingleSpawnProbability,h.turnDoubleSpawnProbability,h.changeDirectionProbability)}join(t){const s=this.rightDirection();let i=this.location.plus(this.direction.multiply(t+1));if(!this.valid(i))return!1;let h=this.dungeonCrawler.getMap(i);if(this.contains(h,Vs.CLOSED,Vs.GUARANTEED_CLOSED)){for(let s=1;s<=t;s++){const t=this.location.plus(this.direction.multiply(s));if(!this.valid(t))return!1;this.dungeonCrawler.setMap(t,Vs.NON_JOIN_CLOSED)}return!0}if(this.contains(h,Vs.NON_JOIN_CLOSED,Vs.NON_JOIN_GUARANTEED_CLOSED))return!1;let e=new Ks,n=0;for(let i=1;i<=this.zi;i++){let r=this.location.plus(s.multiply(i)).plus(this.direction.multiply(t+1));if(!this.valid(r))return!1;if(h=this.dungeonCrawler.getMap(r),this.contains(h,Vs.CLOSED,Vs.GUARANTEED_CLOSED,Vs.NON_JOIN_CLOSED,Vs.NON_JOIN_GUARANTEED_CLOSED)){e=r,n=i;break}if(r=this.location.minus(s.multiply(i).plus(this.direction.multiply(t+1))),!this.valid(r))return!1;if(h=this.dungeonCrawler.getMap(r),this.contains(h,Vs.CLOSED,Vs.GUARANTEED_CLOSED,Vs.NON_JOIN_CLOSED,Vs.NON_JOIN_GUARANTEED_CLOSED)){e=r,n=-i;break}}if(0!==e.x||0!==e.y)return!1;if(0!==n)return!1;if(this.contains(h,Vs.NON_JOIN_CLOSED,Vs.NON_JOIN_GUARANTEED_CLOSED))return!1;i=n<0?s:s.negative;const[r]=this.frontFree(e,i,1,1);let o,l;if(n>0?(o=n,l=1):(o=-n,l=-1),r<o+1)return!1;for(let s=1;s<=t+1;s++){const t=this.location.plus(this.direction.multiply(s));if(!this.valid(t))return!1;this.dungeonCrawler.setMap(t,Vs.NON_JOIN_CLOSED)}for(let i=1;i<o;i++){const h=this.location.plus(s.multiply(i*l)).plus(this.direction.multiply(t+1));if(!this.valid(h))return!1;this.dungeonCrawler.setMap(h,Vs.NON_JOIN_CLOSED)}return!0}getChildDelayProbabilityForGenerationCrawlers(t){return 0<=t&&t<=10?this.config.childDelayProbabilityForGenerationCrawlers[t]:0}}class hi extends ti{constructor(t,s,i,h,e,n,r,o,l,a,c,u,f,d,w,p){super(t,s,i,h,e,n,r),this.Ri=o,this.Ci=l,this.Wi=a,this.Gi=c,this.Ui=u,this.Fi=f,this.ji=d,this.Ki=w,this.Xi=p}stepAhead(){const t=this.dungeonCrawler;if(this.generation!==t.activeGeneration)return!0;if(this.age++,this.age>=this.maxAge)return!1;if(this.age<0)return!0;const[s,i,h]=this.frontFree(this.location,this.direction,this.Wi+1,this.Wi+1);if(0===s)return!1;const[e,n]=this.sidewaysBranchingRoomSizes(),r=this.rightDirection(),o=r.negative,l=this.roomGeneration();if(s<2*this.Ci||this.maxAge-1===this.age)return this.joinOrBuildTerminatingRoom(n,s,i,h,r,o);if(this.buildTunnel(this.Ci,this.Wi),this.rng.range(0,100)<this.ji){const t=this.location.plus(this.direction.multiply(this.Ci>>2)).plus(r.multiply(this.Wi));this.spawnRoomCrawler(t,r,-1,2,l,e,!1)}if(this.rng.range(0,100)<this.Ki){const t=this.location.plus(this.direction.multiply(this.Ci>>2)).plus(o.multiply(this.Wi));this.spawnRoomCrawler(t,o,-1,2,l,e,!1)}this.location=this.location.plus(this.direction.multiply(this.Ci));const a=this.isAnteroomPossible(r,this.Wi+2,this.Wi+2,2*this.Wi+5),c=this.isAnteroomPossible(r,this.Wi+3,this.Wi+3,2*this.Wi+7);let u=!1,f=!1;const d=this.rng.range(0,100),w=this.getSizeUpProbability(this.generation),p=w+this.getSizeDownProbability(this.generation);if(d<w?u=!0:d<p&&(f=!0),u&&!c)return!0;const g=this.isChangeDirection(),y=this.isSpawn(g);if(!g&&!y)return!0;const m=this.isSpawnRoom(y),v=this.rng.range(0,100);let b=this.generation+1;if(y)if(u)b=this.generation+this.config.sizeUpGenDelay;else{let t=0;for(let s=0;s<=10;s++)if(t+=this.getChildDelayProbabilityForGenerationTunnelCrawlers(s),v<t){b=this.generation+s;break}}const x=this.mutateOptions(),_=this.determineSpawnPoints(u,y,a,r,o);if(!0===_)return!0;const[M,k,I,S]=_;let O=!1,N=!1;const D=this.direction;let E=!1;if(g){const[t]=this.frontFree(k,r,this.Wi+1,this.Wi+1),[s]=this.frontFree(I,o,this.Wi+1,this.Wi+1);if(this.Ri.equal(0,0)||this.Ri.equals(this.direction)?u&&y?t<s||t===s&&this.rng.boolean()?t>0&&(this.location=k,this.direction=r,O=!0):s>0&&(this.location=I,this.direction=o,N=!0):t>s||t===s&&this.rng.boolean()?t>0&&(this.location=k,this.direction=r,O=!0):s>0&&(this.location=I,this.direction=o,N=!0):0===this.Ri.x||0===this.Ri.y?(this.direction=this.Ri,this.direction.equals(r)?t>0&&(O=!0,this.location=k):s>0&&(this.location=I,N=!0)):(this.direction=this.Ri.minus(this.direction),this.direction.equals(r)?t>0&&(O=!0,this.location=k):s>0&&(this.location=I,N=!0)),y){let t=Ks.ZERO,s=Ks.ZERO;if(N?(t=k,s=r):O?(t=I,s=o):E=!0,!E){const i=this.rng.range(0,100);m&&i<50?this.spawnRoomCrawler(t,s,0,2,l,n,S):this.spawnTunnelCrawler(u,f,t,s,b,s,x),m&&i>=50?this.spawnRoomCrawler(M,D,0,2,l,n,S):this.spawnTunnelCrawler(u,f,M,D,b,D,x)}}}else E=!0;if(E){this.location=M;const t=this.rng.range(0,100);m&&t<50?this.spawnRoomCrawler(k,r,0,2,l,n,S):this.spawnTunnelCrawler(u,f,k,r,b,r,x),m&&t>=50?this.spawnRoomCrawler(k,o,0,2,l,n,S):this.spawnTunnelCrawler(u,f,I,o,b,o,x)}return!0}isAnteroomPossible(t,s,i,h){const e=this.dungeonCrawler;let n=!1;e.setMap(this.location,Vs.CLOSED);for(let s=1;s<=this.Wi;s++)e.setMap(this.location.plus(t.multiply(s)),Vs.CLOSED),e.setMap(this.location.minus(t.multiply(s)),Vs.CLOSED);const[r]=this.frontFree(this.location.minus(this.direction),this.direction,s,i);r>=h&&(n=!0),e.setMap(this.location,Vs.INSIDE_TUNNEL_OPEN);for(let s=1;s<=this.Wi;s++)e.setMap(this.location.plus(t.multiply(s)),Vs.INSIDE_TUNNEL_OPEN),e.setMap(this.location.minus(t.multiply(s)),Vs.INSIDE_TUNNEL_OPEN);return n}determineSpawnPoints(t,s,i,h,e){const n=this.dungeonCrawler;if(t){if(this.rng.range(0,100)<this.getAnteroomProbability(this.Wi)||s){this.buildAnteroom(2*this.Wi+5,this.Wi+2);return[this.location.plus(this.direction.multiply(2*this.Wi+5)),this.location.plus(this.direction.multiply(this.Wi+3)).plus(h.multiply(this.Wi+2)),this.location.plus(this.direction.multiply(this.Wi+3)).plus(e.multiply(this.Wi+2)),!0]}}else if(this.rng.range(0,100)<this.getAnteroomProbability(this.Wi)&&i){this.buildAnteroom(2*this.Wi+3,this.Wi+1);return[this.location.plus(this.direction.multiply(2*this.Wi+3)),this.location.plus(this.direction.multiply(this.Wi+2)).plus(h.multiply(this.Wi+1)),this.location.plus(this.direction.multiply(this.Wi+2)).plus(e.multiply(this.Wi+1)),!0]}const r=this.location,o=this.location.minus(this.direction.multiply(this.Wi)).plus(h.multiply(this.Wi)),l=this.location.minus(this.direction.multiply(this.Wi)).plus(e.multiply(this.Wi));return this.dungeonCrawler.getMap(o)!==Vs.INSIDE_TUNNEL_OPEN||n.getMap(l)!==Vs.INSIDE_TUNNEL_OPEN||[r,o,l,!1]}joinOrBuildTerminatingRoom(t,s,i,h,e,n){const r=this.dungeonCrawler;let o=!1,l=!1,a=!1,c=0;for(let t=-this.Wi;t<=this.Wi;t++){const i=this.location.plus(this.direction.multiply(s+1)).plus(e.multiply(t)),h=r.getMap(i);this.contains(h,Vs.OPEN,Vs.GUARANTEED_OPEN,Vs.INSIDE_TUNNEL_OPEN,Vs.INSIDE_ANTEROOM_OPEN)?(l=!0,c++):this.contains(h,Vs.GUARANTEED_CLOSED,Vs.NON_JOIN_GUARANTEED_CLOSED)?(o=!0,c=0):h===Vs.INSIDE_ROOM_OPEN?(a=!0,c=0):c=0}if(this.rng.range(0,100)<=this.Xi&&(this.age<this.maxAge-1||s<=this.config.tunnelJoinDist)||s<5){const t=this.joinOtherTunnel(c,s,i,h,l,a,o,e);if(null!=t)return t}r.isMoreRoomsDungeon(t)&&this.spawnRoomCrawler(this.location,this.direction,0,2,this.generation,t,!1);const u=10*this.rng.range(0,11);if(100!==this.Xi||this.Ki!==this.config.lastChanceTunnelCrawler.makeRoomsLeftProbability||this.ji!==this.config.lastChanceTunnelCrawler.makeRoomsRightProbability||this.Fi!==this.config.lastChanceTunnelCrawler.changeDirectionProbability||this.Gi!==this.config.lastChanceTunnelCrawler.straightDoubleSpawnProbability||this.Ui!==this.config.lastChanceTunnelCrawler.turnDoubleSpawnProbability||0!==this.Wi){const[t]=this.frontFree(this.location.plus(e.multiply(this.Wi)),e,this.Wi+1,this.Wi+1),[i]=this.frontFree(this.location.minus(e.multiply(this.Wi)),n,this.Wi+1,this.Wi+1),[h]=this.frontFree(this.location,this.direction.negative,this.Wi+1,this.Wi+1),r=(t,s,i,h)=>{this.dungeonCrawler.createTunnelCrawler(t,s,0,this.maxAge,i,h,3,0,this.config.lastChanceTunnelCrawler.straightDoubleSpawnProbability,this.config.lastChanceTunnelCrawler.turnDoubleSpawnProbability,this.config.lastChanceTunnelCrawler.changeDirectionProbability,this.config.lastChanceTunnelCrawler.makeRoomsRightProbability,this.config.lastChanceTunnelCrawler.makeRoomsLeftProbability,u)};0===this.Wi?this.Ki===this.config.lastChanceTunnelCrawler.makeRoomsLeftProbability&&this.ji===this.config.lastChanceTunnelCrawler.makeRoomsRightProbability&&this.Fi===this.config.lastChanceTunnelCrawler.changeDirectionProbability&&this.Gi===this.config.lastChanceTunnelCrawler.straightDoubleSpawnProbability&&this.Ui===this.config.lastChanceTunnelCrawler.turnDoubleSpawnProbability?s>=t&&s>=i&&s>=h?r(this.location,this.direction,this.generation+1,this.direction):h>=t&&h>=i?r(this.location,this.direction.negative,this.generation+this.config.genDelayLastChance,this.direction.negative):t>=i||t===i&&this.rng.range(0,100)<50?r(this.location,e,this.generation+this.config.genDelayLastChance,e):r(this.location,n,this.generation+this.config.genDelayLastChance,n):r(this.location,this.direction,this.generation+this.config.genDelayLastChance,this.direction):o?(r(this.location.plus(e.multiply(this.Wi)),e,this.generation+this.config.genDelayLastChance,e),r(this.location.minus(e.multiply(this.Wi)),n,this.generation+this.config.genDelayLastChance,n)):t>=i||t===i&&this.rng.range(0,100)<50?(r(this.location.plus(e.multiply(this.Wi)),e,this.generation+this.config.genDelayLastChance,e),r(this.location.minus(e.multiply(this.Wi)),this.direction,this.generation+this.config.genDelayLastChance,this.direction)):(r(this.location.plus(e.multiply(this.Wi)),this.direction,this.generation+this.config.genDelayLastChance,this.direction),r(this.location.minus(e.multiply(this.Wi)),this.direction,this.generation+this.config.genDelayLastChance,this.direction))}return!1}joinOtherTunnel(t,s,i,h,e,n,r,o){const l=this.dungeonCrawler;if(2*this.Wi+1===t)return this.buildTunnel(s,this.Wi),!1;if(e)return this.buildSmallerTunnel(s,l,o);if(n&&0===this.Wi&&s>1){const t=this.location.plus(this.direction.multiply(s+1));l.getMap(t);return this.buildTunnel(s-1,0),0===this.direction.x?l.setMap(this.location.plus(this.direction.multiply(s)),Vs.V_DOOR):l.setMap(this.location.plus(this.direction.multiply(s)),Vs.H_DOOR),!1}if(r&&0===this.Wi){if(100!==this.Xi||20!==this.Ki||20!==this.ji||30!==this.Fi||0!==this.Gi||0!==this.Ui||0!==this.Wi){const t=10*this.rng.range(0,11),s=i>=h?o.negative:o;l.createTunnelCrawler(this.location,s,0,this.maxAge,this.generation+1,s,3,0,0,0,30,20,20,t)}return!1}if(!e&&!r){if(this.isSpecialCase(s,o)){this.buildTunnel(s,this.Wi);for(let t=-this.Wi;t<=this.Wi;t++)l.setMap(this.location.plus(this.direction.multiply(s+1)).plus(o.multiply(t)),Vs.INSIDE_TUNNEL_OPEN);let t=s+2,i=!0,h=!0;for(;i&&h;){for(let s=-this.Wi;s<=this.Wi;s++){const h=this.location.plus(this.direction.multiply(t)).plus(o.multiply(s));if(l.getMap(h)!==Vs.CLOSED){i=!1;break}}let s=this.location.plus(this.direction.multiply(t)).plus(o.multiply(this.Wi+1)),e=this.location.plus(this.direction.multiply(t)).minus(o.multiply(this.Wi+1)),n=l.getMap(s),r=l.getMap(e);if(!this.contains(n,Vs.OPEN,Vs.GUARANTEED_OPEN,Vs.INSIDE_TUNNEL_OPEN,Vs.INSIDE_ANTEROOM_OPEN)&&!this.contains(r,Vs.OPEN,Vs.GUARANTEED_OPEN,Vs.INSIDE_TUNNEL_OPEN,Vs.INSIDE_ANTEROOM_OPEN)){i=!1;break}if(n===Vs.INSIDE_ROOM_OPEN||r===Vs.INSIDE_ROOM_OPEN){i=!1;break}for(let s=-this.Wi;s<=this.Wi;s++){const i=this.location.plus(this.direction.multiply(t+1)).plus(o.multiply(s));l.getMap(i)!==Vs.CLOSED&&(h=!1)}s=this.location.plus(this.direction.multiply(t+1)).plus(o.multiply(this.Wi+1)),e=this.location.plus(this.direction.multiply(t+1)).minus(o.multiply(this.Wi+1)),n=l.getMap(s),r=l.getMap(e),this.contains(n,Vs.OPEN,Vs.GUARANTEED_OPEN,Vs.INSIDE_TUNNEL_OPEN,Vs.INSIDE_ANTEROOM_OPEN,Vs.CLOSED)||this.contains(r,Vs.OPEN,Vs.GUARANTEED_OPEN,Vs.INSIDE_TUNNEL_OPEN,Vs.INSIDE_ANTEROOM_OPEN,Vs.CLOSED)||(h=!1),n!==Vs.INSIDE_ROOM_OPEN&&r!==Vs.INSIDE_ROOM_OPEN||(h=!1);let a=!0;for(let s=-this.Wi-1;s<=this.Wi+1;s++){const i=this.location.plus(this.direction.multiply(t+1)).plus(o.multiply(s)),h=l.getMap(i);h!==Vs.INSIDE_TUNNEL_OPEN&&h!==Vs.INSIDE_ANTEROOM_OPEN&&(a=!1)}if(a&&(h=!0),i&&h)for(let s=-this.Wi;s<=this.Wi;s++)l.setMap(this.location.plus(this.direction.multiply(t)).plus(o.multiply(s)),Vs.INSIDE_TUNNEL_OPEN);t++}return!1}if(0===this.Wi&&l.getMap(this.location.plus(this.direction.multiply(s+1)))===Vs.CLOSED){if(l.getMap(this.location.plus(this.direction.multiply(s+1)).plus(o))===Vs.INSIDE_ROOM_OPEN)return this.direction=o.negative,this.direction.equals(this.Ri.negative)&&(this.direction=this.Ri),!0;if(l.getMap(this.location.plus(this.direction.multiply(s+1)).minus(o))===Vs.INSIDE_ROOM_OPEN)return this.direction=o,this.direction.equals(this.Ri.negative)&&(this.direction=this.Ri),!0}}return null}isSpecialCase(t,s){const i=this.dungeonCrawler;let h=!0;for(let e=-this.Wi;e<=this.Wi;e++){const n=this.location.plus(this.direction.multiply(t+1)).plus(s.multiply(e));if(i.getMap(n)!==Vs.CLOSED){h=!1;break}}const e=this.location.plus(this.direction.multiply(t+1)).plus(s.multiply(this.Wi+1)),n=this.location.plus(this.direction.multiply(t+1)).minus(s.multiply(this.Wi+1)),r=i.getMap(e),o=i.getMap(n);this.contains(r,Vs.OPEN,Vs.GUARANTEED_OPEN,Vs.INSIDE_TUNNEL_OPEN,Vs.INSIDE_ANTEROOM_OPEN)||this.contains(o,Vs.OPEN,Vs.GUARANTEED_OPEN,Vs.INSIDE_TUNNEL_OPEN,Vs.INSIDE_ANTEROOM_OPEN)||(h=!1),r!==Vs.INSIDE_ROOM_OPEN&&o!==Vs.INSIDE_ROOM_OPEN||(h=!1);for(let e=-this.Wi-1;e<=this.Wi+1;e++){const n=this.location.plus(this.direction.multiply(t+2)).plus(s.multiply(e));if(i.getMap(n)===Vs.INSIDE_ROOM_OPEN){h=!1;break}}return h}spawnTunnelCrawler(t,s,i,h,e,n,r){let o=this.Wi,l=this.Ci;t?(o++,l+=2):s&&(o--,o<0&&(o=0),l-=2,l<3&&(l=3)),this.dungeonCrawler.createTunnelCrawler(i,h,0,this.getMaxAgeTunnelCrawlers(e),e,n,l,o,r.straightDoubleSpawnProbability,r.turnDoubleSpawnProbability,r.changeDirectionProbability,r.makeRoomsRightProbability,r.makeRoomsLeftProbability,r.joinPreference)}spawnRoomCrawler(t,s,i,h,e,n,r){const o=Math.max(1,2*this.Wi);r&&(e=this.generation+Math.floor((e-this.generation)/this.config.genSpeedUpOnAnteroom)),this.dungeonCrawler.createRoomCrawler(t,s,i,h,e,o,n)}buildSmallerTunnel(t,s,i){const h=this.location.plus(this.direction.multiply(t+1)),e=s.getMap(h);if(this.contains(e,Vs.OPEN,Vs.GUARANTEED_OPEN,Vs.INSIDE_TUNNEL_OPEN,Vs.INSIDE_ANTEROOM_OPEN))return this.buildTunnel(t,0),!1;let n=0;for(let h=1;h<=this.Wi;h++){const e=this.location.plus(this.direction.multiply(t+1)).plus(i.multiply(h)),r=s.getMap(e);if(this.contains(r,Vs.OPEN,Vs.GUARANTEED_OPEN,Vs.INSIDE_TUNNEL_OPEN,Vs.INSIDE_ANTEROOM_OPEN)){n=h;break}const o=this.location.plus(this.direction.multiply(t+1)).minus(i.multiply(h)),l=s.getMap(o);if(this.contains(l,Vs.OPEN,Vs.GUARANTEED_OPEN,Vs.INSIDE_TUNNEL_OPEN,Vs.INSIDE_ANTEROOM_OPEN)){n=-h;break}}for(let h=1;h<=t;h++){const t=this.location.plus(this.direction.multiply(h)).plus(i.multiply(n));s.setMap(t,Vs.INSIDE_TUNNEL_OPEN)}return!1}roomGeneration(){const t=this.rng.range(0,100);let s=this.generation,i=0;for(let h=0;h<=10;h++)if(i+=this.getChildDelayProbabilityForGenerationRoomCrawlers(h),t<i){s=this.generation+h;break}return s}sidewaysBranchingRoomSizes(){let t,s;const i=this.getRoomSizeProbabilitySideways(this.Wi,qs.MEDIUM),h=this.getRoomSizeProbabilitySideways(this.Wi,qs.SMALL),e=this.getRoomSizeProbabilityBranching(this.Wi,qs.MEDIUM),n=this.getRoomSizeProbabilityBranching(this.Wi,qs.SMALL),r=this.rng.range(0,100);return t=r<h?qs.SMALL:r<h+i?qs.MEDIUM:qs.LARGE,s=r<n?qs.SMALL:r<n+e?qs.MEDIUM:qs.LARGE,[t,s]}isChangeDirection(){return this.rng.range(0,100)<this.Fi}isSpawn(t){return!!(t&&this.rng.range(0,100)<this.Ui)||!t&&this.rng.range(0,100)<this.Gi}isSpawnRoom(t){return t&&this.rng.range(0,100)>this.config.patience}buildAnteroom(t,s){if(t<3||s<1)return!1;const[i]=this.frontFree(this.location,this.direction,s+1,s+1);if(i<=t)return!1;const h=this.rightDirection();for(let i=1;i<=t;i++)for(let t=-s;t<=s;t++){const s=this.location.plus(this.direction.multiply(i)).plus(h.multiply(t));this.dungeonCrawler.setMap(s,Vs.INSIDE_ANTEROOM_OPEN)}if(s>=3&&t>=7&&this.config.columnsInTunnels){const t=2;this.placeColumns(s,t,h)}return!0}buildTunnel(t,s){if(t<1||s<0)return!1;const[i]=this.frontFree(this.location,this.direction,s+1,s+1);if(i<t)return!1;const h=this.rightDirection();for(let i=1;i<=t;i++)for(let t=-s;t<=s;t++){const s=this.location.plus(this.direction.multiply(i)).plus(h.multiply(t));this.dungeonCrawler.setMap(s,Vs.INSIDE_TUNNEL_OPEN)}if(s>=3&&t>=7&&this.config.columnsInTunnels){const i=Math.floor((t-1)/6);for(let t=0;t<i;t++){const i=2+3*t;this.placeColumns(s,i,h)}}return!0}placeColumns(t,s,i){let h=1-t,e=this.location.plus(this.direction.multiply(s)).plus(i.multiply(h));this.dungeonCrawler.setMap(e,Vs.COLUMN),h=t-1,e=this.location.plus(this.direction.multiply(s)).plus(i.multiply(h)),this.dungeonCrawler.setMap(e,Vs.COLUMN),s-=1,h=1-t,e=this.location.plus(this.direction.multiply(s)).plus(i.multiply(h)),this.dungeonCrawler.setMap(e,Vs.COLUMN),h=t-1,e=this.location.plus(this.direction.multiply(s)).plus(i.multiply(h)),this.dungeonCrawler.setMap(e,Vs.COLUMN)}getChildDelayProbabilityForGenerationRoomCrawlers(t){return 0<=t&&t<=10?this.config.childDelayProbabilityForGenerationRoomCrawlers[t]:0}getChildDelayProbabilityForGenerationTunnelCrawlers(t){return 0<=t&&t<=10?this.config.childDelayProbabilityForGenerationTunnelCrawlers[t]:0}getAnteroomProbability(t){return t>=this.config.anteroomProbability.length?100:this.config.anteroomProbability[t]}getSizeUpProbability(t){return t>=this.config.sizeUpProbability.length?this.config.sizeUpProbability[this.config.sizeUpProbability.length-1]:this.config.sizeUpProbability[t]}getSizeDownProbability(t){return t>=this.config.sizeDownProbability.length?this.config.sizeDownProbability[this.config.sizeDownProbability.length-1]:this.config.sizeDownProbability[t]}getMaxAgeTunnelCrawlers(t){return t>=this.config.maxAgesTunnelCrawlers.length?this.config.maxAgesTunnelCrawlers[this.config.maxAgesTunnelCrawlers.length-1]:this.config.maxAgesTunnelCrawlers[t]}getRoomSizeProbabilitySideways(t,s){if(t>=this.config.roomSizeProbabilitySidewaysRooms.length)return qs.LARGE===s?100:0;switch(s){case qs.LARGE:return this.config.roomSizeProbabilitySidewaysRooms[t][2];case qs.MEDIUM:return this.config.roomSizeProbabilitySidewaysRooms[t][1];case qs.SMALL:return this.config.roomSizeProbabilitySidewaysRooms[t][0]}}getRoomSizeProbabilityBranching(t,s){if(t>=this.config.roomSizeProbabilityBranching.length)return qs.LARGE===s?100:0;switch(s){case qs.LARGE:return this.config.roomSizeProbabilityBranching[t][2];case qs.MEDIUM:return this.config.roomSizeProbabilityBranching[t][1];case qs.SMALL:return this.config.roomSizeProbabilityBranching[t][0]}}mutateOptions(){return{straightDoubleSpawnProbability:this.dungeonCrawler.mutate(this.Gi),turnDoubleSpawnProbability:this.dungeonCrawler.mutate(this.Ui),changeDirectionProbability:this.dungeonCrawler.mutate(this.Fi),makeRoomsRightProbability:this.dungeonCrawler.mutate(this.ji),makeRoomsLeftProbability:this.dungeonCrawler.mutate(this.Ki),joinPreference:this.dungeonCrawler.mutate(this.Xi)}}}class ei{constructor(t,s){this.Vi=[],this.qi=[],this.Yi=[],this.activeGeneration=0,this.Ji=0,this.Qi=0,this.Zi=0,this.th=0,this.sh=0,this.ih=0,this.rng=s,this.config=t,this.Kt=[];for(let t=0;t<this.config.width*this.config.height;t++)this.Kt[t]=this.config.background,this.qi[t]=!1;for(let t=0;t<4;t++)this.Yi[t]=null;this.setRect(0,0,this.config.width-1,0,Vs.GUARANTEED_CLOSED),this.setRect(0,0,0,this.config.height-1,Vs.GUARANTEED_CLOSED),this.setRect(this.config.width-1,0,this.config.width-1,this.config.height-1,Vs.GUARANTEED_CLOSED),this.setRect(0,this.config.height-1,this.config.width-1,this.config.height-1,Vs.GUARANTEED_CLOSED);for(const t of this.config.design)this.setRectFill(t);for(const t of this.config.openings)switch(t){case Xs.NORTH:this.setRect(0,Math.floor(this.config.height/2)-1,2,Math.floor(this.config.height/2)+1,Vs.GUARANTEED_OPEN);break;case Xs.WEST:this.setRect(Math.floor(this.config.width/2)-1,0,Math.floor(this.config.width/2)+1,2,Vs.GUARANTEED_OPEN);break;case Xs.EAST:this.setRect(Math.floor(this.config.width/2)-1,this.config.height-3,Math.floor(this.config.width/2)+1,this.config.height-1,Vs.GUARANTEED_OPEN);break;case Xs.SOUTH:this.setRect(this.config.width-3,Math.floor(this.config.height/2)-1,this.config.width-1,Math.floor(this.config.height/2)+1,Vs.GUARANTEED_OPEN);break;case Xs.NORTH_WEST:this.setRect(0,0,2,2,Vs.GUARANTEED_OPEN);break;case Xs.NORTH_EAST:this.setRect(0,this.config.height-3,2,this.config.height-1,Vs.GUARANTEED_OPEN);break;case Xs.SOUTH_WEST:this.setRect(this.config.width-3,0,this.config.width-1,2,Vs.GUARANTEED_OPEN);break;case Xs.SOUTH_EAST:this.setRect(this.config.width-3,this.config.height-3,this.config.width-1,this.config.height-1,Vs.GUARANTEED_OPEN)}const i=(s,i,h)=>{this.createWallCrawler(s,i,0,this.getMaxAgeCrawlers(h),h,i,this.getStepLength(h),1,this.getCorridorWidth(h),this.mutate2(t.randCrawler.straightSingleSpawnProbability),this.mutate2(t.randCrawler.straightDoubleSpawnProbability),this.mutate2(t.randCrawler.turnSingleSpawnProbability),this.mutate2(t.randCrawler.turnDoubleSpawnProbability),this.mutate2(t.randCrawler.changeDirectionProbability))};for(let s=0;s<t.randCrawler.perGeneration.length;s++){const h=t.randCrawler.perGeneration[s];if(h>0){let t=Math.floor(this.config.height*h/1e3);0===t&&this.rng.range(0,1e3)<this.config.height*h&&(t=1);let e=0;for(let h=0;h<t;h++)e=2+this.rng.range(0,this.config.height-4),i(new Ks(0,e),Ks.SOUTH,s),e=2+this.rng.range(0,this.config.height-4),i(new Ks(this.config.width-1,e),Ks.NORTH,s);let n=Math.floor(this.config.width*h/1e3);0===n&&this.rng.range(0,1e3)<this.config.width*h&&(n=1);let r=0;for(let t=0;t<n;t++)r=2+this.rng.range(0,this.config.width-4),i(new Ks(r,0),Ks.EAST,s),r=2+this.rng.range(0,this.config.width-4),i(new Ks(r,this.config.height-1),Ks.EAST,s)}}for(const s of t.crawlers)this.createWallCrawler(s.location,s.direction,-s.age,s.maxAge,s.generation,s.intendedDirection,s.stepLength,s.opening,s.corridorWidth,s.straightSingleSpawnProbability,s.straightDoubleSpawnProbability,s.turnSingleSpawnProbability,s.turnDoubleSpawnProbability,s.changeDirectionProbability);for(const[s,i]of t.crawlerPairs){let t=!0;this.rng.boolean()&&(t=!1),this.createWallCrawler(s.location,s.direction,-s.age,s.maxAge,s.generation,s.intendedDirection,s.stepLength,t?1:0,s.corridorWidth,s.straightSingleSpawnProbability,s.straightDoubleSpawnProbability,s.turnSingleSpawnProbability,s.turnDoubleSpawnProbability,s.changeDirectionProbability),this.setMap(s.location,Vs.CLOSED),this.createWallCrawler(i.location,i.direction,-i.age,i.maxAge,i.generation,i.intendedDirection,i.stepLength,t?1:0,i.corridorWidth,i.straightSingleSpawnProbability,i.straightDoubleSpawnProbability,i.turnSingleSpawnProbability,i.turnDoubleSpawnProbability,i.changeDirectionProbability),this.setMap(i.location,Vs.CLOSED)}for(const s of t.tunnelCrawlers)this.createTunnelCrawler(s.location,s.direction,-s.age,s.maxAge,s.generation,s.intendedDirection,s.stepLength,s.tunnelWidth,s.straightDoubleSpawnProbability,s.turnDoubleSpawnProbability,s.changeDirectionProbability,s.makeRoomsRightProbability,s.makeRoomsLeftProbability,s.joinPreference)}isOpen(t){const s=this.getMap(t);return s===Vs.OPEN||s===Vs.NON_JOIN_OPEN||s===Vs.INSIDE_TUNNEL_OPEN||s===Vs.INSIDE_ANTEROOM_OPEN||s===Vs.GUARANTEED_OPEN||s===Vs.NON_JOIN_GUARANTEED_OPEN}static isActive(t,s){for(const i of s)if(t.x===i.x&&t.y===i.y)return!0;return!1}setMap(t,s){const i=t.x,h=t.y;this.Kt[i*this.config.height+h]=s}getMap(t){const s=t.x,i=t.y;return this.Kt[s*this.config.height+i]}isMapOpen(t){switch(this.getMap(t)){case Vs.OPEN:case Vs.GUARANTEED_OPEN:case Vs.NON_JOIN_OPEN:case Vs.NON_JOIN_GUARANTEED_OPEN:case Vs.INSIDE_ROOM_OPEN:case Vs.INSIDE_TUNNEL_OPEN:case Vs.INSIDE_ANTEROOM_OPEN:case Vs.H_DOOR:case Vs.V_DOOR:return!0;default:return!1}}isMoreRoomsLabyrinth(t=null){if(null===t)return this.isMoreRoomsLabyrinth(qs.SMALL)||this.isMoreRoomsLabyrinth(qs.MEDIUM)||this.isMoreRoomsLabyrinth(qs.LARGE);switch(t){case qs.SMALL:return this.config.numSmallRoomsInLabyrinth>this.Ji;case qs.MEDIUM:return this.config.numMediumRoomsInLabyrinth>this.Qi;case qs.LARGE:return this.config.numLargeRoomsInLabyrinth>this.Zi}}isMoreRoomsDungeon(t){if(null===t)return this.isMoreRoomsDungeon(qs.SMALL)||this.isMoreRoomsDungeon(qs.MEDIUM)||this.isMoreRoomsDungeon(qs.LARGE);switch(t){case qs.SMALL:return this.config.numSmallRoomsInDungeon>this.th;case qs.MEDIUM:return this.config.numMediumRoomsInDungeon>this.sh;case qs.LARGE:return this.config.numLargeRoomsInDungeon>this.ih}}builtRoomDungeon(t){qs.SMALL===t?this.th++:qs.MEDIUM===t?this.sh++:qs.LARGE===t&&this.ih++}getStepLength(t){return t>=this.config.stepLengths.length?this.config.stepLengths[this.config.stepLengths.length-1]:this.config.stepLengths[t]}getCorridorWidth(t){return t>=this.config.corridorWidths.length?this.config.corridorWidths[this.config.corridorWidths.length-1]:this.config.corridorWidths[t]}getMaxAgeCrawlers(t){return t>=this.config.maxAgesCrawlers.length?this.config.maxAgesCrawlers[this.config.maxAgesCrawlers.length-1]:this.config.maxAgesCrawlers[t]}addRoom(t){this.Vi.push(t)}get rooms(){return[...this.Vi]}isChecked(t){return this.qi[t.x*this.config.height+t.y]}static isCheckedList(t,s){for(let i=0;i<s.length;i++)if(t.x===s[i].x&&t.y===s[i].y)return!0;return!1}setChecked(t){this.qi[t.x*this.config.height+t.y]=!0}setRectFill(t){this.setRect(t.startX,t.startY,t.endX,t.endY,t.type)}setRect(t,s,i,h,e){if(!(i<t||h<s))for(let n=t;n<=i;n++)for(let t=s;t<=h;t++)this.setMap({x:n,y:t},e)}createWallCrawler(t,s,i,h,e,n,r,o,l,a,c,u,f,d){const w=new ii(this.rng,this,Ks.from(t),Ks.from(s),i,h,e,Ks.from(n),r,o,l,a,c,u,f,d);for(let t=0;t<this.Yi.length;t++)if(null===this.Yi[t])return void(this.Yi[t]=w);this.Yi.push(w)}createTunnelCrawler(t,s,i,h,e,n,r,o,l,a,c,u,f,d){const w=new hi(this.rng,this,Ks.from(t),Ks.from(s),i,h,e,Ks.from(n),r,o,l,a,c,u,f,d);for(let t=0;t<this.Yi.length;t++)if(null===this.Yi[t])return void(this.Yi[t]=w);this.Yi.push(w)}createRoomCrawler(t,s,i,h,e,n,r){const o=new si(this.rng,this,Ks.from(t),Ks.from(s),i,h,e,n,r);for(let t=0;t<this.Yi.length;t++)if(null===this.Yi[t])return void(this.Yi[t]=o);this.Yi.push(o)}mutate(t){const s=t-this.config.mutator+this.rng.range(0,2*this.config.mutator+1);return s<0?0:s}mutate2(t){return t<=50?t<0?0:this.rng.range(0,2*t+1):t>100?100:2*t-100+this.rng.range(0,200-2*t+1)}createSeedCrawlersInTunnels(){let t=0,s=0;for(new ii(this.rng,this,new Ks(2,2),Ks.SOUTH,0,1,0,Ks.SOUTH,1,0,1,0,0,0,0,0);t<this.config.seedCrawlersInTunnels&&s<this.config.width*this.config.height;){s++;let i=1+this.rng.range(0,this.config.width-4),h=1+this.rng.range(0,this.config.height-4),e=new Ks(i,h);this.rng.range(0,100)<50?i=0:h=0,0===i?h=this.rng.range(0,100)<50?-1:1:i=this.rng.range(0,100)<50?-1:1;const n=new Ks(i,h);let r;if(0===n.x)r=new Ks(n.y,0);else{if(0!==n.y)throw"illegal direction";r=new Ks(0,-n.x)}let o=!0;for(;o&&(e=e.plus(n),!(e.x<2||e.y<2||e.x>this.config.width-3||e.y>this.config.height-3));)this.getMap(e)===Vs.INSIDE_TUNNEL_OPEN&&this.getMap(e.plus(n))===Vs.INSIDE_TUNNEL_OPEN&&this.getMap(e.minus(n))===Vs.INSIDE_TUNNEL_OPEN&&this.getMap(e.plus(r))===Vs.INSIDE_TUNNEL_OPEN&&this.getMap(e.minus(r))===Vs.INSIDE_TUNNEL_OPEN&&this.getMap(e.plus(n).plus(r))===Vs.INSIDE_TUNNEL_OPEN&&this.getMap(e.minus(n).plus(r))===Vs.INSIDE_TUNNEL_OPEN&&this.getMap(e.plus(n).minus(r))===Vs.INSIDE_TUNNEL_OPEN&&this.getMap(e.minus(n).minus(r))===Vs.INSIDE_TUNNEL_OPEN&&(this.setMap(e,Vs.CLOSED),this.createWallCrawler(e,n,0,this.config.tunnelCrawlerStats.maxAge,this.activeGeneration+1,n,this.config.tunnelCrawlerStats.stepLength,1,1,this.config.tunnelCrawlerStats.straightSingleSpawnProbability,this.config.tunnelCrawlerStats.straightDoubleSpawnProbability,this.config.tunnelCrawlerStats.turnSingleSpawnProbability,this.config.tunnelCrawlerStats.turnDoubleSpawnProbability,this.config.tunnelCrawlerStats.changeDirectionProbability),this.createWallCrawler(e,r,0,this.config.tunnelCrawlerStats.maxAge,this.activeGeneration+1,n,this.config.tunnelCrawlerStats.stepLength,1,1,this.config.tunnelCrawlerStats.straightSingleSpawnProbability,this.config.tunnelCrawlerStats.straightDoubleSpawnProbability,this.config.tunnelCrawlerStats.turnSingleSpawnProbability,this.config.tunnelCrawlerStats.turnDoubleSpawnProbability,this.config.tunnelCrawlerStats.changeDirectionProbability),this.createWallCrawler(e,r.negative,0,this.config.tunnelCrawlerStats.maxAge,this.activeGeneration+1,n,this.config.tunnelCrawlerStats.stepLength,1,1,this.config.tunnelCrawlerStats.straightSingleSpawnProbability,this.config.tunnelCrawlerStats.straightDoubleSpawnProbability,this.config.tunnelCrawlerStats.turnSingleSpawnProbability,this.config.tunnelCrawlerStats.turnDoubleSpawnProbability,this.config.tunnelCrawlerStats.changeDirectionProbability),this.rng.range(0,100)<this.config.tunnelCrawlerClosedProbability?this.createWallCrawler(e,n.negative,0,this.config.tunnelCrawlerStats.maxAge,this.activeGeneration+1,n,this.config.tunnelCrawlerStats.stepLength,0,1,this.config.tunnelCrawlerStats.straightSingleSpawnProbability,this.config.tunnelCrawlerStats.straightDoubleSpawnProbability,this.config.tunnelCrawlerStats.turnSingleSpawnProbability,this.config.tunnelCrawlerStats.turnDoubleSpawnProbability,this.config.tunnelCrawlerStats.changeDirectionProbability):this.createWallCrawler(e,n.negative,0,this.config.tunnelCrawlerStats.maxAge,this.activeGeneration+1,n,this.config.tunnelCrawlerStats.stepLength,1,1,this.config.tunnelCrawlerStats.straightSingleSpawnProbability,this.config.tunnelCrawlerStats.straightDoubleSpawnProbability,this.config.tunnelCrawlerStats.turnSingleSpawnProbability,this.config.tunnelCrawlerStats.turnDoubleSpawnProbability,this.config.tunnelCrawlerStats.changeDirectionProbability),o=!1,t++)}}makeIteration(){for(let t=0;t<this.Yi.length;t++)null!==this.Yi[t]&&(this.Yi[t].stepAhead()||(this.Yi[t]=null));return!1}advanceGeneration(){let t=!1,s=0;for(let i=0;i<this.Yi.length;i++)if(null!==this.Yi[i]&&(t=!0,this.Yi[i].generation===this.activeGeneration)){const t=this.Yi[i].age;if(t>=0)return!0;(0===s||t>s)&&(s=t)}if(0===s)return this.activeGeneration++,t;for(let t=0;t<this.Yi.length;t++)null!==this.Yi[t]&&this.Yi[t].generation===this.activeGeneration&&(this.Yi[t].age-=s);return t}createRoom(t){if(this.config.width<10||this.config.height<10)return!1;if(t.endX-t.startX<=5)return!1;if(t.endY-t.startY<=5)return!1;const s=t.startX+1+this.rng.range(0,t.endX-t.startX-3),i=t.startY+1+this.rng.range(0,t.endY-t.startY-3),h=new Ks(s,i);if(!this.isOpen(h))return!1;if(this.isChecked(h))return!1;let e=this.config.maxRoomSize;if(this.isMoreRoomsLabyrinth(qs.LARGE)||(e=this.config.largeRoomSize),this.isMoreRoomsLabyrinth(qs.LARGE)||this.isMoreRoomsLabyrinth(qs.MEDIUM)||(e=this.config.mediumRoomSize),!this.isMoreRoomsLabyrinth())return!1;let n=!0;const r=[],o=[],l=[];let a;for(o.push(h);n;){n=!1;for(let t=0;t<o.length;){const s=o[t];if(a=0,!this.isOpen(s.plus(Ks.NORTH))||ei.isCheckedList(s.plus(Ks.NORTH),r)||ei.isActive(s.plus(Ks.NORTH),o)||ei.isActive(s.plus(Ks.NORTH),l)||a++,!this.isOpen(s.plus(Ks.SOUTH))||ei.isCheckedList(s.plus(Ks.SOUTH),r)||ei.isActive(s.plus(Ks.SOUTH),o)||ei.isActive(s.plus(Ks.SOUTH),l)||a++,!this.isOpen(s.plus(Ks.EAST))||ei.isCheckedList(s.plus(Ks.EAST),r)||ei.isActive(s.plus(Ks.EAST),o)||ei.isActive(s.plus(Ks.EAST),l)||a++,!this.isOpen(s.plus(Ks.WEST))||ei.isCheckedList(s.plus(Ks.WEST),r)||ei.isActive(s.plus(Ks.WEST),o)||ei.isActive(s.plus(Ks.WEST),l)||a++,!this.isOpen(s.plus(Ks.NORTH_EAST))||ei.isCheckedList(s.plus(Ks.NORTH_EAST),r)||ei.isActive(s.plus(Ks.NORTH_EAST),o)||ei.isActive(s.plus(Ks.NORTH_EAST),l)||a++,!this.isOpen(s.plus(Ks.NORTH_WEST))||ei.isCheckedList(s.plus(Ks.NORTH_WEST),r)||ei.isActive(s.plus(Ks.NORTH_WEST),o)||ei.isActive(s.plus(Ks.NORTH_WEST),l)||a++,!this.isOpen(s.plus(Ks.SOUTH_EAST))||ei.isCheckedList(s.plus(Ks.SOUTH_EAST),r)||ei.isActive(s.plus(Ks.SOUTH_EAST),o)||ei.isActive(s.plus(Ks.SOUTH_EAST),l)||a++,!this.isOpen(s.plus(Ks.SOUTH_WEST))||ei.isCheckedList(s.plus(Ks.SOUTH_WEST),r)||ei.isActive(s.plus(Ks.SOUTH_WEST),o)||ei.isActive(s.plus(Ks.SOUTH_WEST),l)||a++,a>2)n=!0,!this.isOpen(s.plus(Ks.NORTH))||ei.isCheckedList(s.plus(Ks.NORTH),r)||ei.isActive(s.plus(Ks.NORTH),o)||ei.isActive(s.plus(Ks.NORTH),l)||l.push(s.plus(Ks.NORTH)),!this.isOpen(s.plus(Ks.SOUTH))||ei.isCheckedList(s.plus(Ks.SOUTH),r)||ei.isActive(s.plus(Ks.SOUTH),o)||ei.isActive(s.plus(Ks.SOUTH),l)||l.push(s.plus(Ks.SOUTH)),!this.isOpen(s.plus(Ks.EAST))||ei.isCheckedList(s.plus(Ks.EAST),r)||ei.isActive(s.plus(Ks.EAST),o)||ei.isActive(s.plus(Ks.EAST),l)||l.push(s.plus(Ks.EAST)),!this.isOpen(s.plus(Ks.WEST))||ei.isCheckedList(s.plus(Ks.WEST),r)||ei.isActive(s.plus(Ks.WEST),o)||ei.isActive(s.plus(Ks.WEST),l)||l.push(s.plus(Ks.WEST)),!this.isOpen(s.plus(Ks.NORTH_EAST))||ei.isCheckedList(s.plus(Ks.NORTH_EAST),r)||ei.isActive(s.plus(Ks.NORTH_EAST),o)||ei.isActive(s.plus(Ks.NORTH_EAST),l)||l.push(s.plus(Ks.NORTH_EAST)),!this.isOpen(s.plus(Ks.NORTH_WEST))||ei.isCheckedList(s.plus(Ks.NORTH_WEST),r)||ei.isActive(s.plus(Ks.NORTH_WEST),o)||ei.isActive(s.plus(Ks.NORTH_WEST),l)||l.push(s.plus(Ks.NORTH_WEST)),!this.isOpen(s.plus(Ks.SOUTH_EAST))||ei.isCheckedList(s.plus(Ks.SOUTH_EAST),r)||ei.isActive(s.plus(Ks.SOUTH_EAST),o)||ei.isActive(s.plus(Ks.SOUTH_EAST),l)||l.push(s.plus(Ks.SOUTH_EAST)),!this.isOpen(s.plus(Ks.SOUTH_WEST))||ei.isCheckedList(s.plus(Ks.SOUTH_WEST),r)||ei.isActive(s.plus(Ks.SOUTH_WEST),o)||ei.isActive(s.plus(Ks.SOUTH_WEST),l)||l.push(s.plus(Ks.SOUTH_WEST)),ei.isCheckedList(s,r)||(r.push(s),this.setChecked(s)),o.splice(t,1),t++;else if(2===a){let i=0;if(!this.isOpen(s.plus(Ks.NORTH))||ei.isCheckedList(s.plus(Ks.NORTH),r)||ei.isActive(s.plus(Ks.NORTH),o)||ei.isActive(s.plus(Ks.NORTH),l)||(l.push(s.plus(Ks.NORTH)),i++),!this.isOpen(s.plus(Ks.SOUTH))||ei.isCheckedList(s.plus(Ks.SOUTH),r)||ei.isActive(s.plus(Ks.SOUTH),o)||ei.isActive(s.plus(Ks.SOUTH),l)||(l.push(s.plus(Ks.SOUTH)),i++),!this.isOpen(s.plus(Ks.EAST))||ei.isCheckedList(s.plus(Ks.EAST),r)||ei.isActive(s.plus(Ks.EAST),o)||ei.isActive(s.plus(Ks.EAST),l)||(l.push(s.plus(Ks.EAST)),i++),!this.isOpen(s.plus(Ks.WEST))||ei.isCheckedList(s.plus(Ks.WEST),r)||ei.isActive(s.plus(Ks.WEST),o)||ei.isActive(s.plus(Ks.WEST),l)||(l.push(s.plus(Ks.WEST)),i++),1===i){t++;continue}!this.isOpen(s.plus(Ks.NORTH_EAST))||ei.isCheckedList(s.plus(Ks.NORTH_EAST),r)||ei.isActive(s.plus(Ks.NORTH_EAST),o)||ei.isActive(s.plus(Ks.NORTH_EAST),l)||l.push(s.plus(Ks.NORTH_EAST)),!this.isOpen(s.plus(Ks.NORTH_WEST))||ei.isCheckedList(s.plus(Ks.NORTH_WEST),r)||ei.isActive(s.plus(Ks.NORTH_WEST),o)||ei.isActive(s.plus(Ks.NORTH_WEST),l)||l.push(s.plus(Ks.NORTH_WEST)),!this.isOpen(s.plus(Ks.SOUTH_EAST))||ei.isCheckedList(s.plus(Ks.SOUTH_EAST),r)||ei.isActive(s.plus(Ks.SOUTH_EAST),o)||ei.isActive(s.plus(Ks.SOUTH_EAST),l)||l.push(s.plus(Ks.SOUTH_EAST)),!this.isOpen(s.plus(Ks.SOUTH_WEST))||ei.isCheckedList(s.plus(Ks.SOUTH_WEST),r)||ei.isActive(s.plus(Ks.SOUTH_WEST),o)||ei.isActive(s.plus(Ks.SOUTH_WEST),l)||l.push(s.plus(Ks.SOUTH_WEST)),ei.isCheckedList(s,r)||(r.push(s),this.setChecked(s)),o.splice(t,1),t++}else 1==a||(ei.isCheckedList(s,r)||(r.push(s),this.setChecked(s)),o.splice(t,1)),t++;if(r.length>e)return!1}for(const t of l){if(this.getMap(t)===Vs.GUARANTEED_OPEN||this.getMap(t)===Vs.NON_JOIN_GUARANTEED_OPEN)return!1;ei.isCheckedList(t,r)||ei.isActive(t,o)||o.push(t)}l.splice(0,l.length)}let c=!0,u=0,f=Ks.ZERO;for(;c;){u=0,c=!1;for(let t=0;t<o.length;)f=o[t],a=0,!this.isOpen(f.plus(Ks.NORTH))||ei.isCheckedList(f.plus(Ks.NORTH),r)||ei.isActive(f.plus(Ks.NORTH),o)||ei.isActive(f.plus(Ks.NORTH),l)||a++,!this.isOpen(f.plus(Ks.SOUTH))||ei.isCheckedList(f.plus(Ks.SOUTH),r)||ei.isActive(f.plus(Ks.SOUTH),o)||ei.isActive(f.plus(Ks.SOUTH),l)||a++,!this.isOpen(f.plus(Ks.EAST))||ei.isCheckedList(f.plus(Ks.EAST),r)||ei.isActive(f.plus(Ks.EAST),o)||ei.isActive(f.plus(Ks.EAST),l)||a++,!this.isOpen(f.plus(Ks.WEST))||ei.isCheckedList(f.plus(Ks.WEST),r)||ei.isActive(f.plus(Ks.WEST),o)||ei.isActive(f.plus(Ks.WEST),l)||a++,!this.isOpen(f.plus(Ks.NORTH_EAST))||ei.isCheckedList(f.plus(Ks.NORTH_EAST),r)||ei.isActive(f.plus(Ks.NORTH_EAST),o)||ei.isActive(f.plus(Ks.NORTH_EAST),l)||a++,!this.isOpen(f.plus(Ks.NORTH_WEST))||ei.isCheckedList(f.plus(Ks.NORTH_WEST),r)||ei.isActive(f.plus(Ks.NORTH_WEST),o)||ei.isActive(f.plus(Ks.NORTH_WEST),l)||a++,!this.isOpen(f.plus(Ks.SOUTH_EAST))||ei.isCheckedList(f.plus(Ks.SOUTH_EAST),r)||ei.isActive(f.plus(Ks.SOUTH_EAST),o)||ei.isActive(f.plus(Ks.SOUTH_EAST),l)||a++,!this.isOpen(f.plus(Ks.SOUTH_WEST))||ei.isCheckedList(f.plus(Ks.SOUTH_WEST),r)||ei.isActive(f.plus(Ks.SOUTH_WEST),o)||ei.isActive(f.plus(Ks.SOUTH_WEST),l)||a++,a>1?(u++,t++):1===a?(c=!0,!this.isOpen(f.plus(Ks.NORTH))||ei.isCheckedList(f.plus(Ks.NORTH),r)||ei.isActive(f.plus(Ks.NORTH),o)||ei.isActive(f.plus(Ks.NORTH),l)||l.push(f.plus(Ks.NORTH)),!this.isOpen(f.plus(Ks.SOUTH))||ei.isCheckedList(f.plus(Ks.SOUTH),r)||ei.isActive(f.plus(Ks.SOUTH),o)||ei.isActive(f.plus(Ks.SOUTH),l)||l.push(f.plus(Ks.SOUTH)),!this.isOpen(f.plus(Ks.EAST))||ei.isCheckedList(f.plus(Ks.EAST),r)||ei.isActive(f.plus(Ks.EAST),o)||ei.isActive(f.plus(Ks.EAST),l)||l.push(f.plus(Ks.EAST)),!this.isOpen(f.plus(Ks.WEST))||ei.isCheckedList(f.plus(Ks.WEST),r)||ei.isActive(f.plus(Ks.WEST),o)||ei.isActive(f.plus(Ks.WEST),l)||l.push(f.plus(Ks.WEST)),!this.isOpen(f.plus(Ks.NORTH_EAST))||ei.isCheckedList(f.plus(Ks.NORTH_EAST),r)||ei.isActive(f.plus(Ks.NORTH_EAST),o)||ei.isActive(f.plus(Ks.NORTH_EAST),l)||l.push(f.plus(Ks.NORTH_EAST)),!this.isOpen(f.plus(Ks.NORTH_WEST))||ei.isCheckedList(f.plus(Ks.NORTH_WEST),r)||ei.isActive(f.plus(Ks.NORTH_WEST),o)||ei.isActive(f.plus(Ks.NORTH_WEST),l)||l.push(f.plus(Ks.NORTH_WEST)),!this.isOpen(f.plus(Ks.SOUTH_EAST))||ei.isCheckedList(f.plus(Ks.SOUTH_EAST),r)||ei.isActive(f.plus(Ks.SOUTH_EAST),o)||ei.isActive(f.plus(Ks.SOUTH_EAST),l)||l.push(f.plus(Ks.SOUTH_EAST)),!this.isOpen(f.plus(Ks.SOUTH_WEST))||ei.isCheckedList(f.plus(Ks.SOUTH_WEST),r)||ei.isActive(f.plus(Ks.SOUTH_WEST),o)||ei.isActive(f.plus(Ks.SOUTH_WEST),l)||l.push(f.plus(Ks.SOUTH_WEST)),ei.isCheckedList(f,r)||(r.push(f),this.setChecked(f)),o.splice(t,1)):(ei.isCheckedList(f,r)||(r.push(f),this.setChecked(f)),o.splice(t,1));for(f of l){if(this.getMap(f)===Vs.GUARANTEED_OPEN||this.getMap(f)===Vs.NON_JOIN_GUARANTEED_OPEN)return!1;ei.isCheckedList(f,r)||ei.isActive(f,o)||o.push(f)}l.splice(0,l.length)}if(u>1)return!1;if(0===u)for(let t=0;t!==r.length;t++)this.setMap(r[t],Vs.CLOSED);else{if(r.length<this.config.minRoomSize)return!1;let t=!1,s=!1;for(let i=0;i!==r.length;i++)r[i].x!==r[0].x&&(t=!0),r[i].y!==r[0].y&&(s=!0);if(!t||!s)return!1;if(this.getMap(f.plus(Ks.WEST))===Vs.V_DOOR||this.getMap(f.plus(Ks.EAST))===Vs.V_DOOR||this.getMap(f.plus(Ks.WEST))===Vs.H_DOOR||this.getMap(f.plus(Ks.EAST))===Vs.H_DOOR||this.getMap(f.plus(Ks.NORTH))===Vs.V_DOOR||this.getMap(f.plus(Ks.SOUTH))===Vs.V_DOOR||this.getMap(f.plus(Ks.NORTH))===Vs.H_DOOR||this.getMap(f.plus(Ks.SOUTH))===Vs.H_DOOR)return!1;if(r.length<this.config.mediumRoomSize){if(!this.isMoreRoomsLabyrinth(qs.SMALL))return!1;this.Ji++}else if(r.length<this.config.largeRoomSize){if(!this.isMoreRoomsLabyrinth(qs.MEDIUM))return!1;this.Qi++}else{if(!(r.length<this.config.maxRoomSize))return!1;if(!this.isMoreRoomsLabyrinth(qs.LARGE))return!1;this.Zi++}f=o[0],this.isOpen(f.plus(Ks.NORTH))?this.setMap(f,Vs.H_DOOR):this.isOpen(f.plus(Ks.WEST))&&this.setMap(f,Vs.V_DOOR);const i=new Qs;for(let t=0;t!==r.length;t++)this.setMap(r[t],Vs.INSIDE_ROOM_OPEN),i.inside.push(r[t]);i.inDungeon=!1,this.Vi.push(i)}return!0}generate(){for(;;){for(this.activeGeneration===this.config.tunnelCrawlerGeneration&&this.createSeedCrawlersInTunnels();this.makeIteration(););if(!this.advanceGeneration())break}if(this.config.tunnelCrawlerGeneration<0||this.activeGeneration<this.config.tunnelCrawlerGeneration)for(this.createSeedCrawlersInTunnels();;){for(;this.makeIteration(););if(!this.advanceGeneration())break}let t=0,s=0;if(this.config.background===Vs.OPEN){const i=new Zs(0,0,this.config.width,this.config.height,this.config.background);for(t=0,s=this.config.width*this.config.height;this.isMoreRoomsLabyrinth()&&(this.createRoom(i)||t++,!(t>s)););}for(const i of this.config.design)if(i.type===Vs.OPEN)for(t=0,s=(i.endX-i.startX)*(i.endY-i.startY);this.isMoreRoomsLabyrinth()&&(this.createRoom(i)||t++,!(t>s)););}}(t=>{t[t.RIGHT=2]="RIGHT",t[t.DOWN=1]="DOWN"})(Ys||(Ys={})),(t=>{t[t.EMPTY=0]="EMPTY",t[t.FLOOR=1]="FLOOR",t[t.FLOOR_WALL_TOP=2]="FLOOR_WALL_TOP",t[t.WALL_MID=3]="WALL_MID",t[t.WALL_TOP=4]="WALL_TOP",t[t.WALL_SIDE=5]="WALL_SIDE"})(Js||(Js={}));class ni extends js{constructor(t,s,i,h,e,n){super(i,h,e),this.hh=null,this.ut=t,this.weights=[],this.tileset=s,this.eh=n,this.T=s.cells.length;for(let t=0;t<this.T;t++)this.weights[t]=1;const r=[];for(let t=0;t<4;t++){r[t]=[];for(let s=0;s<this.T;s++){r[t][s]=[];for(let i=0;i<this.T;i++)r[t][s][i]=!1}}for(const[t,i]of s.right){const s=js.opposite[Ys.RIGHT];r[Ys.RIGHT][t][i]=!0,r[s][i][t]=!0}for(const[t,i]of s.down){const s=js.opposite[Ys.DOWN];r[Ys.DOWN][t][i]=!0,r[s][i][t]=!0}this.propagator=[];for(let t=0;t<4;t++){this.propagator[t]=[];for(let s=0;s<this.T;s++){this.propagator[t][s]=[];for(let i=0;i<this.T;i++)r[t][s][i]&&this.propagator[t][s].push(i)}}}onBoundary(t,s){return!this.periodic&&(t<0||s<0||t>=this.FMX||s>=this.FMY)}clear(){super.clear();for(const t of this.eh)t.onClear(),this.propagate()}backtrackConstraint(t,s){for(const i of this.eh)i.onBacktrack(t,s)}banConstraint(t,s){for(const i of this.eh)i.onBan(t,s)}initConstraint(){for(const t of this.eh)if(t.init(this),this.status!=Ts.Undecided)return void this.debug}stepConstraint(){for(const t of this.eh){if(t.check(),this.status!=Ts.Undecided)return void this.debug;if(this.propagate(),this.status!=Ts.Undecided)return void this.debug}this.deferredConstraintsStep=!1}testObserved(t){const s=t%this.FMX,i=Math.floor(t/this.FMX);if(!this.onBoundary(s,i)){this.wave[t].filter(t=>t).length}}graphics(s){const i=this.tileset.size;null==this.hh&&(this.hh=new t.Application({width:this.FMX*i*1,height:this.FMY*i*1,resolution:1,antialias:!1,autoStart:!1,sharedTicker:!1,sharedLoader:!1}),document.body.appendChild(this.hh.view));const h=this.hh;this.hh.stage.removeChildren();const e=new t.Container;if(e.scale.set(1,1),h.stage.addChild(e),null!=this.observed)for(let t=0;t<this.FMX;t++)for(let s=0;s<this.FMY;s++){const[h,n]=this.tileset.cells[this.observed[t+s*this.FMX]];if(h>=0){const n=this.ut.spriteOrAnimation(this.tileset.tiles[h]);n.position.set(t*i,s*i),n.zIndex=1,e.addChild(n)}if(n>=0){const h=this.ut.spriteOrAnimation(this.tileset.tiles[n]);h.position.set(t*i,s*i),h.zIndex=2,e.addChild(h)}}else for(let t=0;t<this.FMX;t++)for(let s=0;s<this.FMY;s++){const h=this.wave[t+s*this.FMX];let n=0;for(let t=0;t<this.T;t++)h[t]&&(n+=this.weights[t]);const r=1/n;for(let n=0;n<this.T;n++)if(h[n]){const[h,o]=this.tileset.cells[n],l=(h>=0?1:0)+(o>=0?1:0);if(h>=0){const o=this.ut.spriteOrAnimation(this.tileset.tiles[h]);o.position.set(t*i,s*i),o.zIndex=1,o.alpha=r*(1/l)*this.weights[n],e.addChild(o)}if(o>=0){const h=this.ut.spriteOrAnimation(this.tileset.tiles[o]);h.position.set(t*i,s*i),h.zIndex=2,h.alpha=r*(1/l)*this.weights[n],e.addChild(h)}}}const n=new t.Graphics;e.addChild(n),n.lineStyle(1,16711680);for(const t of s){const s=t%this.FMX,h=Math.floor(t/this.FMX);n.drawRect(s*i,h*i,i,i)}h.render();h.view}}class ri{constructor(t){this.nh=null,this.rh=null,this.at=t}get crawler(){return this.rh}init(t){this.nh=t}onClear(){const t=this.nh,s=this.rh=new ei(this.at,t.rng);s.generate();const i=Ws(t.FMX*t.FMY,!1);for(let h=0;h<s.config.height;h++)for(let e=0;e<s.config.width;e++){const n=e+h*t.FMX;i[n]=s.isMapOpen({x:e,y:h})}function h(s){const h=s%t.FMX,e=Math.floor(s/t.FMX);for(let s=0;s<=1;s++)for(let n=-1;n<=1;n++)if(0!==n||0!==s){const r=h+n,o=e+s;if(t.onBoundary(r,o))continue;if(!i[r+o*t.FMX])return!1}return!0}function e(s,h=2){const e=s%t.FMX,n=Math.floor(s/t.FMX);for(let s=-1;s<=h;s++)for(let h=-1;h<=1;h++)if(0!==h||0!==s){const r=e+h,o=n+s;if(t.onBoundary(r,o))continue;if(i[r+o*t.FMX])return!0}return!1}function n(s,h,e){const n=s%t.FMX+h,r=Math.floor(s/t.FMX)+e;return t.onBoundary(n,r)?null:i[n+r*t.FMX]}for(let s=0;s<i.length;s++){const r=Ws(6,!1),o=n(s,0,1);if(i[s])r[Js.EMPTY]=!1,r[Js.FLOOR]=!0,h(s)||(r[Js.FLOOR_WALL_TOP]=!0);else if(e(s)){const t=n(s,0,-1);r[Js.EMPTY]=!(!0===t||!0===o),r[Js.WALL_MID]=!0===t||!0===o,r[Js.WALL_TOP]=!0,r[Js.WALL_SIDE]=!0}else r[Js.EMPTY]=!0;for(let i=0;i<t.T;i++){r[t.tileset.cells[i][2]]||t.ban(s,i)}}}check(){}onBacktrack(t,s){}onBan(t,s){}}class oi extends class{constructor(t){this.resources=t.resources,this.controller=t}createDungeon(s,i,h,e,n){return new J(this.controller,new t.Ticker,s,i,h,e,n)}replaceFloorRandomly(t,s){const i=["floor_2.png","floor_3.png","floor_4.png","floor_5.png","floor_6.png","floor_7.png","floor_8.png"];for(let h=0;h<s.height;h++)for(let e=0;e<s.width;e++){const n=s.cell(e,h);n.hasFloor&&t.float()<.2&&(n.floorName=t.select(i))}}replaceWallRandomly(t,s){const i=["wall_banner_red.png","wall_banner_blue.png","wall_banner_green.png","wall_banner_yellow.png"],h=["wall_goo.png"],e=["wall_fountain_mid_red","wall_fountain_mid_blue"],n=["wall_hole_1.png","wall_hole_2.png"];for(let r=0;r<s.height;r++)for(let o=0;o<s.width;o++){if("wall_mid.png"===s.cell(o,r).wallName&&t.float()<.3){const l=[...n],a=r+1<s.height&&"floor_1.png"===s.cell(o,r+1).floorName;a&&(l.push(...i),l.push(...h)),r>0&&"wall_top_mid.png"===s.cell(o,r-1).wallName&&a&&l.push(...e);const c=t.select(l);switch(c){case"wall_goo.png":s.cell(o,r).wallName="wall_goo.png",s.cell(o,r+1).floorName="wall_goo_base.png";break;case"wall_fountain_mid_red":s.cell(o,r-1).wallName="wall_fountain_top.png",s.cell(o,r).wallName="wall_fountain_mid_red",s.cell(o,r+1).floorName="wall_fountain_basin_red";break;case"wall_fountain_mid_blue":s.cell(o,r-1).wallName="wall_fountain_top.png",s.cell(o,r).wallName="wall_fountain_mid_blue",s.cell(o,r+1).floorName="wall_fountain_basin_blue";break;default:s.cell(o,r).wallName=c}}}}}{constructor(t){super(t),this.nh=null}get percent(){var t;return(null===(t=this.nh)||void 0===t?void 0:t.percent)||0}async generate(t){const s=this.controller.loader.resources["dungeon.rules.json"].data,i=this.controller.loader.resources["dungeon.design.json"].data,h=this.controller.heroManager.state(t.hero);let e;h.dungeons.hasSeed(t.level)?e=h.dungeons.getSeed(t.level):(e=this.controller.rng.int(),h.dungeons.setSeed(t.level,e));const n=k.seeded(e);await Fs(10);const r=new ri(i);let o;for(this.nh=new ni(this.resources,s,n,i.width,i.height,[r]);o=await this.nh.run(1e4),o!==Ts.Decided;)await Fs();const l=this.createDungeon(n,e,t.level,this.nh.FMX,this.nh.FMY),a=this.nh.observed;for(let t=0;t<this.nh.FMY;t++)for(let i=0;i<this.nh.FMX;i++){const h=i+t*this.nh.FMX,[e,n]=s.cells[a[h]];e>=0&&(l.cell(i,t).floorName=s.tiles[e]),n>=0&&(l.cell(i,t).wallName=s.tiles[n])}const c=r.crawler.rooms.sort(Qs.compare).reverse();return await Fs(),this.replaceFloorRandomly(n,l),await Fs(),this.replaceWallRandomly(n,l),t.level%5==0?await this.placeWithBoss(n,l,c,h):await this.placeWithoutBoss(n,l,c,h),await this.placeDrop(n,l),l.light.loadMap(),await Fs(),l}async placeWithoutBoss(t,s,i,h){const e=i.shift(),n=i.shift();await this.placeHero(t,s,h,e),await this.placeLadder(t,s,n),await this.placeBonfire(t,s,h,e),await this.placeNpc(t,s,e),await this.placeMonsters(t,s,e)}async placeWithBoss(t,s,i,h){const e=i.shift(),n=i.shift();await this.placeHero(t,s,h,n),await this.placeNpc(t,s,n),await this.placeBonfire(t,s,h,n),await this.placeLadder(t,s,e),await this.placeBoss(t,s,e),await this.placeMonsters(t,s,n)}async placeHero(t,s,i,h){const e=this.findSpawnCellInRoom(t,s,3,3,h);if(!e)throw"error place bonfire";{const t=new Ns(i,s,e.x+1,e.y-2);s.light.addLight(t.view,X.HERO)}}async placeLadder(t,s,i){const h=this.findSpawnCellInRoom(t,s,3,3,i);if(!h)throw"error place bonfire";s.cell(h.x+1,h.y-1).ladder()}async placeBonfire(t,s,i,h){const e=this.findSpawnCellInRoom(t,s,3,3,h);if(!e)throw"error place bonfire";{const t=i.dungeons.hasBonfire(s.level);new it(s,e.x+1,e.y-1,t)}}async placeNpc(t,s,i){for(let h=0;h<5;h++){const h=this.findSpawnCellInRoom(t,s,2,2,i);if(!h)break;this.controller.npcManager.spawnRandom(s,h.x,h.y)}}async placeBoss(t,s,i){const h=this.findSpawnCellInRoom(t,s,4,4,i);if(!h)throw"error place boos";this.controller.monsterManager.spawnLevelBossMonster(s,h.x+1,h.y-1)}async placeMonsters(t,s,i){const h=s.width*s.height,e=Math.floor(.4*h),n=Math.floor(.2*e),r=Math.floor(.07*n),o=Math.floor(.005*n);for(let h=0;h<r&&await this.placeTinyMonster(t,s,i);h++);for(let h=0;h<o&&await this.placeSummonMonster(t,s,i);h++);}async placeTinyMonster(t,s,i){const h=this.findSpawnCellExcludeRoom(t,s,2,2,i);return null!==h&&(this.controller.monsterManager.spawnRandomTinyMonster(s,h.x,h.y),!0)}async placeSummonMonster(t,s,i){const h=this.findSpawnCellExcludeRoom(t,s,3,3,i);return null!==h&&(this.controller.monsterManager.spawnRandomSummonMonster(s,h.x+1,h.y-1),!0)}async placeDrop(t,s){const i=[];for(let t=0;t<s.height;t++)for(let h=0;h<s.height;h++){const e=s.cell(h,t);!e.hasFloor||e.hasDrop||e.hasObject||i.push(e)}const h=()=>{const s=t.range(0,i.length);return i.splice(s,1)[0]},e=Math.floor(.01*i.length),n=Math.floor(.008*i.length),r=Math.floor(.004*i.length),o=Math.floor(.002*i.length);for(let t=0;t<o&&i.length>0;t++)h().dropItem=this.controller.weaponManager.randomHeroWeapon(s);for(let t=0;t<r&&i.length>0;t++)h().dropItem=new R;for(let t=0;t<n&&i.length>0;t++)h().dropItem=new P;for(let s=0;s<e&&i.length>0;s++)h().dropItem=new L(t)}findSpawnCellExcludeRoom(t,s,i,h,e){const n=new Set(e.inside.map(t=>`${t.x}:${t.y}`)),r=[];for(let t=h;t<s.height;t++)for(let e=0;e<s.width-i;e++){let o=!0;for(let r=0;r<h&&o;r++){for(let h=0;h<i&&o;h++){const i=s.cell(e+h,t-r);if(o=i.hasFloor&&!i.hasObject&&!n.has(`${i.x}:${i.y}`),!o)break}if(!o)break}o&&r.push(s.cell(e,t))}return t.select(r)}findSpawnCellInRoom(t,s,i,h,e){const n=[];for(const t of e.inside){const e=t.x,r=t.y;let o=!0;for(let t=0;t<h&&o;t++)for(let h=0;h<i&&o;h++){const i=s.cell(e+h,r-t);o=i.hasFloor&&!i.hasObject}o&&n.push(s.cell(e,r))}return t.select(n)}}class li extends s{constructor(s,i){super(s),this.oh=new oi(this.t);const h=this.t.screen,n=new t.BitmapText("ROGUELIKE DUNGEON",{font:{name:"alagard",size:64}});n.anchor=new t.Point(.5,0),n.position.set(this.t.screen.width>>1,64),this.addChild(n),this.lh=new u({color:e,width:h.width-(c<<2),height:64,valueMax:100}),this.lh.position.set(c<<1,h.height-(c<<1)-64),this.addChild(this.lh),this.ah=i}async generate(){const t=await this.oh.generate(this.ah);this.t.dungeon(t)}init(){this.t.ticker.add(this.update,this),this.generate()}destroy(){this.t.ticker.remove(this.update,this),super.destroy({children:!0})}pause(){}resume(){}update(){this.lh.value=this.oh.percent}}class ai extends s{constructor(t){super(t)}init(){this.t.ticker.add(this.handleInput,this);const s=new t.BitmapText("ROGUELIKE DUNGEON",{font:{name:"alagard",size:64}});s.anchor=new t.Point(.5,0),s.position.set(this.t.screen.width>>1,64),this.addChild(s);const i=["WASD - top, left, bottom, right","WASD + SPACE - dodge","F - action, hold for charged attack","Q - drop weapon","I - inventory","P - show stats","1 ... 0 - belt","","PRESS F TO CONTINUE"];for(let s=0;s<i.length;s++){const h=i[s];if(h.length>0){const i=new t.BitmapText(h,{font:{name:"alagard",size:32}});i.position.set(40,200+30*s),this.addChild(i)}}}destroy(){this.t.ticker.remove(this.handleInput,this),super.destroy({children:!0})}pause(){}resume(){}handleInput(){this.t.joystick.hit.once()&&this.t.selectHero()}}class ci extends s{constructor(t){super(t),this.X=new v(t.joystick)}init(){this.renderTitle(),this.renderHeroes(),this.t.ticker.add(this.X.handleInput,this.X)}destroy(){this.t.ticker.remove(this.X.handleInput,this.X),super.destroy({children:!0})}pause(){}resume(){}renderTitle(){const s=new t.BitmapText("ROGUELIKE DUNGEON",{font:{name:"alagard",size:64}});s.anchor=new t.Point(.5,0),s.position.set(this.t.screen.width>>1,64),this.addChild(s)}renderHeroes(){const t=this.t.screen,s=Os.length,i=Math.floor((t.width-40*(s+1))/s),h=(i-80)/16,e=Math.floor(28*h)+32+120;for(let h=0;h<s;h++){const s=Os[h],n=40*(h+1)+i*h,r=(t.height>>1)-(e>>1),o=new ui(i,e,s,this.t.resources);o.position.set(n,r),this.addChild(o),this.X.set(h,0,o,()=>this.select(s))}this.X.reset()}select(t){const s=this.t.heroManager.state(t).dungeons.bonfires(),i=s.length>0?s[s.length-1]:1;this.t.generateDungeon({level:i,hero:t})}}class ui extends t.Container{constructor(s,i,h,r){super(),this.uh=!1,this.fh=(new t.Graphics).beginFill(e).drawRect(0,0,s,i).endFill(),this.dh=(new t.Graphics).beginFill(n).drawRect(0,0,s,i).endFill(),this.q=new t.BitmapText(h,{font:{name:"alagard",size:32}}),this.q.anchor=.5,this.q.position.set(s>>1,40);const o=s-80,l=o/16,a=Math.floor(28*l);this.ct=r.animatedSprite(h+"_idle"),this.ct.width=o,this.ct.height=a,this.ct.position.set(40,112),this.addChild(this.fh,this.dh,this.q,this.ct),this.selected=!1}get selected(){return this.uh}set selected(t){this.uh=t,t?(this.fh.visible=!0,this.dh.visible=!1,this.q.visible=!0,this.ct.gotoAndPlay(0)):(this.fh.visible=!1,this.dh.visible=!0,this.q.visible=!1,this.ct.gotoAndStop(0))}destroy(){super.destroy(),this.fh.destroy(),this.dh.destroy(),this.q.destroy(),this.ct.destroy()}}class fi extends Ot{constructor(t,s,i,h){super(s,{x:i,y:h,width:t.width,height:t.height,static:!1,interacting:!0,animation:t.name+"_idle",zIndex:Y.character}),this.state=t,this.init()}onDead(){this.destroy()}interact(t){this.lookAt(t),this._t.controller.showDialog(t.state,this.state)}fsm(){const t=this.idle();return t.state(1).transitionTo(0).action(()=>"npc idle complete"),t}}class di extends ks{constructor(t){super(t),this.xs=new Map,this.wh=new Map,this.level=t.level,this.width=t.width,this.height=t.height}setContext(t,s){this.xs.set(t,s)}getContext(t){return this.xs.get(t)}hasSkill(t){return this.wh.has(t)}getSkill(t){return this.wh.get(t)||null}addSkill(t,s){this.wh.set(t,s)}}class wi{constructor(t,s){this.npc=t,this.controller=s}}let pi=(()=>{class t extends wi{constructor(t,s){super(t,s)}use(t){this.controller.sellInventory(t,this.npc)}}return t.id="selling",t})(),gi=(()=>{class t extends wi{constructor(t,s,i){super(t,s);for(const h of i)switch(h){case"potions":for(let s=0;s<10;s++)t.inventory.backpack.cell(s,0).set(new P,3);for(let s=0;s<10;s++)t.inventory.backpack.cell(s,1).set(new R,3);break;case"weapons":for(const i of s.weaponManager.heroWeapons(t.level+2)){const h=s.weaponManager.weapon(i);t.inventory.backpack.add(h)}}}use(t){this.controller.buyInventory(t,this.npc)}}return t.id="buying",t})(),yi=(()=>{class s extends wi{constructor(t,s){super(t,s)}use(s){t.sound.play("big_egg_collect"),s.health.set(s.healthMax.get())}}return s.id="heal",s})();class mi{constructor(t){this.t=t}init(){this.at=this.t.loader.resources["npc.config.json"].data}state(t,s){const i=this.at.npc[s];if(!i)throw"Npc not found: "+s;const h=new di({name:i.name,healthMax:i.health,health:i.health,staminaMax:i.stamina,stamina:i.stamina,baseDamage:i.baseDamage,speed:i.speed,coins:i.coins,level:t,width:i.width,height:i.height});for(const t of i.skills)switch(t){case pi.id:h.addSkill(t,new pi(h,this.t));break;case gi.id:h.addSkill(t,new gi(h,this.t,i.trading));break;case yi.id:h.addSkill(t,new yi(h,this.t))}const e=this.t.rng.select(i.weapons);if(e){const t=this.t.weaponManager.npcWeapon(e);h.inventory.equipment.weapon.set(t)}return h}spawnRandom(t,s,i){const h=t.rng.select(Object.keys(this.at.npc)),e=this.state(t.level,h);return new fi(e,t,s,i)}}var vi,bi,xi;(t=>{t.POTIONS="potions",t.WEAPONS="weapons"})(vi||(vi={})),(t=>{t[t.Started=1]="Started",t[t.ParsingNumber=2]="ParsingNumber",t[t.ParsingStringStarted=3]="ParsingStringStarted",t[t.ParsingString=4]="ParsingString",t[t.ParsingStringFinished=5]="ParsingStringFinished",t[t.ParsingFunction=6]="ParsingFunction",t[t.Finished=7]="Finished",t[t.ParsingContext=8]="ParsingContext",t[t.ParsingBracket=9]="ParsingBracket",t[t.Error=10]="Error"})(bi||(bi={})),(t=>{t[t.Delimiter=1]="Delimiter",t[t.Digit=2]="Digit",t[t.Bracket=3]="Bracket",t[t.Other=4]="Other",t[t.ContextBracket=5]="ContextBracket",t[t.Quote=6]="Quote"})(xi||(xi={}));const _i={[bi.Started]:{[xi.Delimiter]:bi.Started,[xi.Digit]:bi.ParsingNumber,[xi.Bracket]:bi.ParsingBracket,[xi.Other]:bi.ParsingFunction,[xi.ContextBracket]:bi.ParsingContext,[xi.Quote]:bi.ParsingStringStarted},[bi.ParsingNumber]:{[xi.Delimiter]:bi.Finished,[xi.Digit]:bi.ParsingNumber,[xi.Bracket]:bi.Finished,[xi.Other]:bi.Finished,[xi.ContextBracket]:bi.Error,[xi.Quote]:bi.Error},[bi.ParsingFunction]:{[xi.Delimiter]:bi.Finished,[xi.Digit]:bi.ParsingFunction,[xi.Bracket]:bi.Finished,[xi.Other]:bi.ParsingFunction,[xi.ContextBracket]:bi.Error,[xi.Quote]:bi.Error},[bi.ParsingContext]:{[xi.Delimiter]:bi.Finished,[xi.Digit]:bi.ParsingContext,[xi.Bracket]:bi.Finished,[xi.Other]:bi.ParsingContext,[xi.ContextBracket]:bi.ParsingContext,[xi.Quote]:bi.Error},[bi.ParsingBracket]:{[xi.Delimiter]:bi.Finished,[xi.Digit]:bi.Finished,[xi.Bracket]:bi.Finished,[xi.Other]:bi.Finished,[xi.ContextBracket]:bi.Finished,[xi.Quote]:bi.Finished},[bi.ParsingStringStarted]:{[xi.Delimiter]:bi.ParsingString,[xi.Digit]:bi.ParsingString,[xi.Bracket]:bi.ParsingString,[xi.Other]:bi.ParsingString,[xi.ContextBracket]:bi.ParsingString,[xi.Quote]:bi.Finished},[bi.ParsingString]:{[xi.Delimiter]:bi.ParsingString,[xi.Digit]:bi.ParsingString,[xi.Bracket]:bi.ParsingString,[xi.Other]:bi.ParsingString,[xi.ContextBracket]:bi.ParsingString,[xi.Quote]:bi.ParsingStringFinished},[bi.ParsingStringFinished]:{[xi.Delimiter]:bi.Finished,[xi.Digit]:bi.Finished,[xi.Bracket]:bi.Finished,[xi.Other]:bi.Finished,[xi.ContextBracket]:bi.Finished,[xi.Quote]:bi.Finished}};let Mi=(()=>{class t{constructor(){this.ph={"+":{priority:0,variable:!1,apply:(t,s)=>t+s},"-":{priority:0,variable:!1,apply:(t,s)=>t-s},"*":{priority:1,variable:!1,apply:(t,s)=>t*s},"/":{priority:1,variable:!1,apply:(t,s)=>t/s},"%":{priority:1,variable:!1,apply:(t,s)=>t%s},or:{priority:0,variable:!1,apply:(t,s)=>t||s},and:{priority:1,variable:!1,apply:(t,s)=>t&&s},"!":{priority:2,variable:!1,apply:t=>!t},true:{priority:100,variable:!1,apply:()=>!0},false:{priority:100,variable:!1,apply:()=>!1},$$getContextValue:{priority:100,variable:!1,apply:(t,s)=>s[t.substring(1,t.length-1)]}},this.xs={}}static classifySymbol(s){return-1!==t.delimiters.indexOf(s)?xi.Delimiter:-1!==t.brackets.indexOf(s)?xi.Bracket:-1!==t.digits.indexOf(s)?xi.Digit:-1!==t.contextBrackets.indexOf(s)?xi.ContextBracket:-1!==t.quotes.indexOf(s)?xi.Quote:xi.Other}isOfMoreOrEqualPriority(t,s){return this.ph[t].priority<=this.ph[s].priority}scanToken(s,i){let h=bi.Started,e=bi.Error,n="",r=i;for(;r<s.length&&h!==bi.Finished&&h!==bi.Error;){const i=t.classifySymbol(s[r]);h=_i[h][i],h===bi.ParsingFunction&&void 0!==this.ph[n]&&(h=bi.Finished),h===bi.ParsingFunction||h===bi.ParsingNumber||h===bi.ParsingBracket||h===bi.ParsingContext||h===bi.ParsingString?(e=h,n+=s[r++]):h!==bi.Started&&h!==bi.ParsingStringStarted&&h!==bi.ParsingStringFinished||r++}return""===n&&(e=bi.Error),{workingState:e,tokenString:n,pos:r}}convertToRPN(s){const i=[],h=[];let e,n=0;for(let r=0;r<s.length;r++)if("n"!==s[r].type)if("("!==s[r].type)if(")"!==s[r].type){if(-1!==Object.keys(this.ph).indexOf(s[r].type)){if(i.length>0){do{e=i.pop(),h[n++]=e}while(i.length>0&&-1===t.brackets.indexOf(h[n-1].type)&&this.isOfMoreOrEqualPriority(s[r].type,h[n-1].type));-1===t.brackets.indexOf(h[n-1].type)&&this.isOfMoreOrEqualPriority(s[r].type,h[n-1].type)||(i.push(e),n--)}i.push(s[r])}}else{do{e=i.pop(),h[n++]=e}while("("!==h[n-1].type);n--}else i.push(s[r]);else h[n++]=s[r];for(;i.length>0;)e=i.pop(),h[n++]=e;return h}calculateRPN(t){var s;const i=[];if(0===t.length)return null;for(let s=0;s<t.length;s++)if("n"===t[s].type)i.push(t[s]);else{const h=this.ph[t[s].type],e=h.apply,n=h.variable?i.length:e.length,r=e(...i.splice(i.length-n).map(t=>t.value));i.push({type:"n",value:r})}return(null===(s=i.shift())||void 0===s?void 0:s.value)||null}tokenize(t){const s=[];for(let i=0;i<t.length;){const h=this.scanToken(t,i);h.workingState!==bi.Error&&(h.workingState===bi.ParsingNumber?s.push({type:"n",value:-1!==h.tokenString.indexOf(".")?parseFloat(h.tokenString):parseInt(h.tokenString)}):h.workingState===bi.ParsingContext?(s.push({type:"$$getContextValue",value:null}),s.push({type:"n",value:h.tokenString}),s.push({type:"n",value:this.xs})):h.workingState===bi.ParsingString?s.push({type:"n",value:h.tokenString}):s.push({type:h.tokenString,value:null})),i=h.pos}return s}register(t,s,i,h){this.ph[t]={priority:s,variable:i,apply:h}}evaluate(t,s={}){this.xs=s;const i=this.tokenize(t),h=this.convertToRPN(i);return this.calculateRPN(h)}}return t.digits="0123456789.",t.brackets="()",t.contextBrackets="{}",t.delimiters=" ,\r\r\n",t.quotes="'\"",t})();class ki{constructor(){this.xs={}}add(t,s){this.xs[t]=s}render(t){return t.replace(/{{([^}]+)}}/g,(t,s)=>{const i=s.split(".");if(i.length>=1){let t=this.xs;for(;i.length>0;){const[s]=i.splice(0,1);t=t[s]}return t||null}return s})}}class Ii{constructor(t){this.t=t}init(){this.gh=this.t.loader.resources["dialogs.json"].data}dialog(t,s){const i=this.gh[s.name]||this.gh.default;return new Si(this.t,t,s,i)}}class Si{constructor(t,s,i,h){this.yh=new Kt,this.t=t,this.hero=s,this.npc=i,this.at=h,this.mh=new Mi,this.mh.register("goto",100,!0,this.goto.bind(this)),this.mh.register("exit",100,!1,this.exit.bind(this)),this.mh.register("context",100,!1,this.context.bind(this)),this.mh.register("hasSkill",100,!1,this.hasSkill.bind(this)),this.mh.register("skill",100,!1,this.skill.bind(this)),this.vh=new ki,this.vh.add("hero",this.hero),this.vh.add("npc",this.npc)}get question(){return this.yh}start(){this.goto(...this.at.start)}hasSkill(t){return this.npc.hasSkill(t)}skill(t){var s;null===(s=this.npc.getSkill(t))||void 0===s||s.use(this.hero)}exit(){this.t.closeModal()}context(t,s){return void 0===s?this.npc.getContext(t):(this.npc.setContext(t,s),null)}goto(...t){for(const s of t){const t=this.at.questions[s];if(this.check(t.conditions)){const s=this.vh.render(t.text),i=new Oi(this,s);for(const s of t.answers)if(this.check(s.conditions)){const t=this.vh.render(s.text);i.add(t,s.commands)}return void this.yh.send(i)}}}check(t){if(t)for(const s of t)if(!this.evaluate(s))return!1;return!0}evaluate(t){return this.mh.evaluate(t)}}class Oi{constructor(t,s){this.answers=[],this.bh=t,this.text=s}add(t,s){this.answers.push(new Ni(this.bh,t,s))}}class Ni{constructor(t,s,i){this.dialog=t,this.text=s,this.commands=i}action(){for(const t of this.commands)this.dialog.evaluate(t)}}class Di extends _{constructor(t,s){super(t,"Dialog"),this.xh=null,this._h=null,this.Mh=[],this.bh=s}init(){super.init();const t=new g({padding:0});this.addChild(t);const s=new p({spacing:0,backgroundColor:h});t.addChild(s);const i=this.t.resources.animatedSprite(this.bh.npc.name+"_idle");i.width=4*i.width,i.height=4*i.height,s.addChild(i),this.xh=new p({padding:0}),t.addChild(this.xh),this._h=new Ei(300),this.xh.addChild(this._h),this.bh.question.subscribe(this.onQuestion,this),this.bh.start()}destroy(){this.bh.question.unsubscribe(this.onQuestion,this),super.destroy()}onQuestion(t){for(let t=0;t<this.Mh.length;t++){this.Mh[t].destroy(),this.X.remove(0,t+1)}this.X.reset(),this.Mh=[],this._h.text=t.text;for(let s=0;s<t.answers.length;s++){const i=t.answers[s],h=new f({label:i.text,width:300});this.X.set(0,s+1,h,i.action.bind(i)),this.Mh.push(h),this.xh.addChild(h)}this.X.select(0,1),this.updateLayout(),this.X.reset()}}class Ei extends t.Container{constructor(s){super(),this.I=new t.BitmapText("",{font:{name:"alagard",size:16}}),this.I.maxWidth=s-2*a,this.I.calculateBounds(),this.I.position.set(a,a),this.O=(new t.Graphics).beginFill(h).drawRect(0,0,1,1).endFill(),this.O.width=s,this.addChild(this.O,this.I)}set text(t){this.I.text=t,this.O.height=this.I.height+2*a}}class Ti extends t.Container{constructor(s,i){super(),this.kh=120,this.Ih=60,this.t=s;const h=s.screen,e=Math.floor(.7*h.height);this.I=new t.BitmapText(i.text,{font:{name:"alagard",size:64},align:"center",tint:i.color}),this.I.anchor=new t.Point(.5,.5),this.I.position.set(h.width>>1,e);const n=new t.filters.BlurFilter;n.blurY=1,n.blurX=10,n.quality=4,this.Sh=new t.BitmapText(i.text,{font:{name:"alagard",size:64},align:"center",tint:i.color}),this.Sh.anchor=new t.Point(.5,.5),this.Sh.position.set(h.width>>1,e),this.Sh.width+=44.8,this.Sh.alpha=.5,this.Sh.filters=[n],this.Sh.filterArea=this.Sh.getBounds().clone().pad(50,0),this.Oh=Ti.gradient(1,128),this.O=new t.TilingSprite(this.Oh,h.width,128),this.O.position.set(0,e-64),this.addChild(this.O,this.Sh,this.I),this.t.ticker.add(this.update,this)}update(t){this.kh>0?this.kh-=t:this.Ih>0?(this.Ih-=t,this.alpha=this.Ih/60):this.t.closeBanner()}destroy(){super.destroy(),this.t.ticker.remove(this.update,this),this.I.destroy(),this.O.destroy(),this.Oh.destroy(!0)}static gradient(s,i){const h=document.createElement("canvas");h.width=s,h.height=i;const e=h.getContext("2d"),n=e.createLinearGradient(0,0,0,i);return n.addColorStop(0,"rgba(0, 0, 0, 0)"),n.addColorStop(.3,"rgba(0, 0, 0, 1)"),n.addColorStop(.7,"rgba(0, 0, 0, 1)"),n.addColorStop(1,"rgba(0, 0, 0, 0)"),e.fillStyle=n,e.fillRect(0,0,s,i),t.Texture.from(h)}}class Ai{constructor(t){this.Us=t}deserialize(t){return t?this.Us.deserialize(t):null}serialize(t){return null!==t?this.Us.serialize(t):""}}let Li=(()=>{class t{deserialize(t){return t}serialize(t){return t}}return t.instance=new t,t})(),Pi=(()=>{class t{deserialize(t){if(!t)throw"empty";const s=Number.parseFloat(t);if(isNaN(s))throw"NaN";return s}serialize(t){if(isNaN(t))throw"NaN";return t.toString()}}return t.instance=new t,t})(),Ri=(()=>{class t{deserialize(t){if(!t)throw"empty";const s=Number.parseInt(t);if(isNaN(s))throw"NaN";return s}serialize(t){if(isNaN(t))throw"NaN";return t.toString()}}return t.instance=new t,t})();class Ci{deserialize(t){return JSON.parse(t)}serialize(t){return JSON.stringify(t)}}class $i{constructor(t,s){this.Nh=t,this.Dh=s+".",this._destroyed=!1}static init(t){const s="localhost"===location.hostname||"0.0.0.0"===location.hostname||"127.0.0.1"===location.hostname?sessionStorage:localStorage;return new $i(s,t)}active(){if(this._destroyed)throw"IllegalStateError"}key(t){return this.Dh+t}destroy(){this._destroyed||(this._destroyed=!0)}clear(){this.active();for(const t of Object.keys(this.Nh))t.startsWith(this.Dh)&&this.Nh.removeItem(t)}keys(){const t=[];for(const s of Object.keys(this.Nh))s.startsWith(this.Dh)&&t.push(s.replace(this.Dh,""));return t}isEmpty(){return 0===this.keys().length}prefix(t){return this.active(),new $i(this.Nh,this.key(t))}get(t){return this.active(),this.Nh.getItem(this.key(t))}set(t,s){this.active(),this.Nh.setItem(this.key(t),s)}remove(t){this.active(),this.Nh.removeItem(this.key(t))}variable(t,s,i){this.active();const h=this.get(t),e=null===h?s:i.deserialize(h);return new zi(t,e,i,this)}optionalVar(t,s,i){this.active();const h=new Ai(i),e=this.get(t),n=null===e?s:h.deserialize(e);return new zi(t,n,h,this)}stringVar(t,s){return this.active(),this.variable(t,s,Li.instance)}floatVar(t,s){return this.active(),this.variable(t,s,Pi.instance)}integerVar(t,s){return this.active(),this.variable(t,s,Ri.instance)}objectVar(t,s){return this.active(),this.variable(t,s,new Ci)}}class zi extends jt{constructor(t,s,i,h){super(s),this.Eh=t,this.Us=i,this.Bs=h}onUpdate(t){this.Bs.set(this.Eh,this.Us.serialize(t))}}class Hi{constructor(t){this.Th=null,this.Ah=null,this.Lh=null,this.rng=k.create(),this.joystick=new S,this.resources=new O(t.loader),this.hh=t,this.ticker=t.ticker,this.loader=t.loader,this.screen=t.screen,this.store=$i.init("#"),this.dialogManager=new Ii(this),this.heroManager=new Ps(this),this.npcManager=new mi(this),this.monsterManager=new Ss(this),this.weaponManager=new E(this)}async init(){await this.resources.load(),this.weaponManager.init(),this.npcManager.init(),this.monsterManager.init(),this.dialogManager.init()}destroy(){this.hh.destroy()}get scene(){return this.Th}setScene(t){var s;null===(s=this.Th)||void 0===s||s.destroy(),this.Th=t,this.hh.stage=this.Th,this.Th.init()}keyBind(){this.setScene(new ai(this))}selectHero(){this.setScene(new ci(this))}dead(){this.setScene(new N(this))}generateDungeon(t){this.setScene(new li(this,t))}dungeon(t){this.setScene(new Us(this,t))}modal(s){var i,h;t.sound.play("text"),null===(i=this.Th)||void 0===i||i.pause(),this.Ah=s,null===(h=this.Th)||void 0===h||h.addChild(s),this.Ah.init(),this.Ah.position.set((this.screen.width>>1)-(this.Ah.width>>1),(this.screen.height>>1)-(this.Ah.height>>1))}closeModal(){var t,s;null===(t=this.Ah)||void 0===t||t.destroy(),null===(s=this.Th)||void 0===s||s.resume()}showStats(t){this.modal(new Cs(this,t))}showInventory(t){const s=new vs(t);this.modal(new gs(this,s))}sellInventory(t,s){const i=new bs(t,s);this.modal(new gs(this,i))}buyInventory(t,s){const i=new xs(t,s);this.modal(new gs(this,i))}showDialog(t,s){const i=this.dialogManager.dialog(t,s);this.modal(new Di(this,i))}showBonfire(t){this.modal(new ht(this,t))}showBanner(t){var s;this.closeBanner(),this.Lh=new Ti(this,t),null===(s=this.Th)||void 0===s||s.addChild(this.Lh)}closeBanner(){var t;null===(t=this.Lh)||void 0===t||t.destroy(),this.Lh=null}}(async()=>{PIXI.settings.SCALE_MODE=PIXI.SCALE_MODES.NEAREST,PIXI.settings.FAIL_IF_MAJOR_PERFORMANCE_CAVEAT=!1,PIXI.sound.volumeAll=.5;const t=new PIXI.Application({width:1200,height:700,antialias:!1});document.getElementById("container").appendChild(t.view);const s=new Hi(t);await s.init(),s.keyBind()})()}(PIXI);
//# sourceMappingURL=bundle.js.map
