!function t(e,i,s){function l(h,n){if(!i[h]){if(!e[h]){var a="function"==typeof require&&require;if(!n&&a)return a(h,!0);if(o)return o(h,!0);var r=new Error("Cannot find module '"+h+"'");throw r.code="MODULE_NOT_FOUND",r}var c=i[h]={exports:{}};e[h][0].call(c.exports,(function(t){return l(e[h][1][t]||t)}),c,c.exports,t,e,i,s)}return i[h].exports}for(var o="function"==typeof require&&require,h=0;h<s.length;h++)l(s[h]);return l}({1:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});i.Coins=class{constructor(t){this.tileName="coin_anim",this.coins=t.nextRange(1,30)}pickedUp(t){return t.addCoins(this.coins),!0}};class s{constructor(){this.tileName="flask_red",this.health=2}pickedUp(t){return t.inventory.add(this)}same(t){return t instanceof s}use(t){t.hill(this.health)}}i.HealthFlask=s;class l{constructor(){this.tileName="flask_big_red",this.health=5}pickedUp(t){return t.inventory.add(this)}same(t){return t instanceof l}use(t){t.hill(this.health)}}i.HealthBigFlask=l},{}],2:[function(t,e,i){"use strict";var s=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))((function(l,o){function h(t){try{a(s.next(t))}catch(t){o(t)}}function n(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?l(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(h,n)}a((s=s.apply(t,e||[])).next())}))};Object.defineProperty(i,"__esModule",{value:!0});const l=t("./input"),o=t("./tilemap"),h=t("./hero"),n=t("./level"),a=t("./scene"),r=t("./rng"),c=t("./monster");!function(){s(this,void 0,void 0,(function*(){const t=new o.TileRegistry;yield t.load();const e=document.getElementById("dungeon"),i=e.getContext("2d");i.imageSmoothingEnabled=!1;const s=document.createElement("canvas"),w=s.getContext("2d");w.imageSmoothingEnabled=!1;const d=(new Date).getTime(),m=new r.RNG,f=new l.Joystick,_=new h.Weapon(t,"weapon_rusty_sword"),g=new h.HeroMonster(t,f,0,0,"knight_f",_,d),u=new a.Scene;u.setLevel(new n.Level(m,t,u,g,1,d));function p(t,e,i){const s=i<<1,l=t-i,o=e-i,h=w.createRadialGradient(t,e,16,t,e,i);h.addColorStop(.5,"rgb(255,255,255)"),h.addColorStop(1,"transparent"),w.fillStyle=h,w.fillRect(l,o,s,s)}function y(t,e,s,l){if(t&&!(t instanceof c.MovingMonsterWrapper)){const o=t.tile.w,h=t.tile.h,n=t.tile.x+o*t.frame,a=t.tile.y,r=2*o,w=2*h,d=w-28;let m=0,f=0;if(t.state===c.MonsterState.Run){const e=t.start,i=t.speed*t.tile.numOfFrames,s=Math.min(i,l-e)/i;m=32*(t.new_x-t.x)*s,f=32*(t.new_y-t.y)*s}if(e+m+r>0&&e+m<i.canvas.width&&s+f+w>0&&s+f<i.canvas.height){if(i.save(),i.translate(e+m,s+f),t.is_left){if(i.scale(-1,1),t.weapon){i.save();const e=t.weapon.tile,s=2*e.w,l=2*e.h,o=l-28,h=8;if(i.translate(-h,-o),t.state===c.MonsterState.Hit){let o=90*t.weapon.frame/(t.weapon.numOfFrames-1);i.translate(s>>1,l),i.rotate(o*Math.PI/180),i.drawImage(e.tileSet,e.x,e.y,e.w,e.h,-(s>>1),-l,s,l)}else i.drawImage(e.tileSet,e.x,e.y,e.w,e.h,0,0,s,l);i.restore()}i.drawImage(t.tile.tileSet,n,a,o,h,0-r,-d,r,w)}else{if(t.weapon){i.save();const e=t.weapon.tile,s=2*e.w,l=2*e.h,o=l-28,h=24;if(i.translate(h,-o),t.state===c.MonsterState.Hit){let o=90*t.weapon.frame/(t.weapon.numOfFrames-1);i.translate(s>>1,l),i.rotate(o*Math.PI/180),i.drawImage(e.tileSet,e.x,e.y,e.w,e.h,-(s>>1),-l,s,l)}else i.drawImage(e.tileSet,e.x,e.y,e.w,e.h,0,0,s,l);i.restore()}i.drawImage(t.tile.tileSet,n,a,o,h,0,-d,r,w)}i.restore()}}}function v(e,s,l){const o=t.get(e);if(o){const t=o.w,e=o.h,h=2*t,n=2*e;if(s+h>0&&s<i.canvas.width&&l+n>0&&l<i.canvas.height)if(o.isAnim&&o.numOfFrames>1){const a=(new Date).getTime(),r=Math.floor(a/100)%o.numOfFrames,c=o.x+t*r,w=o.y;i.drawImage(o.tileSet,c,w,t,e,s,l,h,n)}else{const a=o.x,r=o.y;i.drawImage(o.tileSet,a,r,t,e,s,l,h,n)}}}!function l(){const o=(new Date).getTime();u.level.animate(o),function(t){const l=e.width,o=e.height;s.width=l,s.height=o,i.save(),i.fillStyle="rgb(34,34,34)",i.fillRect(0,0,l,o),w.save(),w.fillStyle="black",w.fillRect(0,0,l,o),w.globalCompositeOperation="lighter",p(l>>1,o>>1,192);let h=16*u.level.hero.x*2+8-l/2,n=16*u.level.hero.y*2+8-o/2;if(u.level.hero.state===c.MonsterState.Run){const e=u.level.hero.start,i=u.level.hero.speed,s=u.level.hero.tile.numOfFrames,l=i*s,o=Math.min(l,t-e)/l,a=32*(u.level.hero.new_x-u.level.hero.x)*o,r=32*(u.level.hero.new_y-u.level.hero.y)*o;h+=a,n+=r}for(let t=0;t<u.level.w;t++)for(let e=0;e<u.level.h;e++){const i=16*t*2-h,s=16*e*2-n;v(u.level.floor[e][t],i,s),u.level.drop[e][t]&&v(u.level.drop[e][t].tileName,i,s)}for(let e=0;e<u.level.h;e++){for(let t=0;t<u.level.w;t++){const i=16*t*2-h,s=16*e*2-n,l=u.level.wall[e][t];v(l,i,s),"wall_fountain_mid_red_anim"!==l&&"wall_fountain_mid_blue_anim"!==l||p(i+16,s+16,128)}if(e<u.level.h-1)for(let i=0;i<u.level.w;i++){const s=e+1,l=16*i*2-h,o=16*s*2-n;y(u.level.monsters[s][i],l,o,t)}}i.restore(),i.save(),i.globalAlpha=.8,i.globalCompositeOperation="multiply",i.drawImage(s,0,0),i.restore()}(o),function(s){(function(t){const e=u.level.hero.healthMax,s=u.level.hero.health;i.save(),i.translate(40,40),i.fillStyle="rgb(0,0,0)",i.fillRect(0,0,8+10*e,28),i.fillStyle="rgb(255,0,0)",i.fillRect(4,4,10*s,20),i.fillStyle="rgb(255,255,255)",i.font="20px silkscreennormal",i.fillText(s.toString(),8,20),i.fillText(`$${g.coins}`,0,50),i.restore()})(),function(t){const s=e.width,l=e.height;i.save(),i.translate(s/2,60),i.fillStyle="rgb(255,255,255)",i.textAlign="center",i.font="20px silkscreennormal",i.fillText(`level ${u.level.level}`,0,0),i.restore(),u.level.log=u.level.log.slice(-5),i.save(),i.translate(40,l-100);for(let t=0;t<u.level.log.length;t++)i.fillStyle="rgb(255,255,255)",i.font="20px silkscreennormal",i.fillText(u.level.log[t],0,20*t);i.restore()}(),function(t){const s=e.width,l=e.height;u.level.hero.dead&&(i.save(),i.fillStyle="rgba(0, 0, 0, 0.7)",i.fillRect(0,0,s,l),i.translate(s/2,l/2),i.fillStyle="rgb(255,0,0)",i.textAlign="center",i.font="200px silkscreennormal",i.fillText("YOU DIED",0,0),i.restore())}(),function(s){const l=e.width,o=e.height,h=u.level.hero.inventory.cells,n=h.length,a=2*(18*n+2);i.save(),i.translate((l>>1)-(a>>1),o-40-40),i.fillStyle="rgb(100,100,100)",i.fillRect(0,0,a,40),i.translate(4,4);for(let e=0;e<n;e++){const l=18*e*2,o=0;i.fillStyle="rgb(70,70,70)",i.fillRect(l,0,32,32);const n=h[e];if(n.item){const e=t.get(n.item.tileName);if(e)if(e.isAnim&&e.numOfFrames>1){let t;t=3===e.numOfFrames?Math.floor(s/100)%e.numOfFrames:(e.numOfFrames,(s>>2)%e.numOfFrames);const h=e.w,n=e.h,a=e.x+h*t,r=e.y,c=2*h,w=2*n;i.drawImage(e.tileSet,a,r,h,n,l,o,c,w)}else{const t=e.x,s=e.y,h=e.w,n=e.h,a=2*h,r=2*n;i.drawImage(e.tileSet,t,s,h,n,l,o,a,r)}i.textAlign="end",i.textBaseline="top",i.font="10px silkscreennormal",i.fillStyle="rgb(255,255,255)",i.fillText(n.count.toString(),l+32,0,32)}}i.restore()}(s)}(o),window.requestAnimationFrame(l)}()}))}()},{"./hero":3,"./input":4,"./level":6,"./monster":7,"./rng":8,"./scene":9,"./tilemap":10}],3:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});const s=t("./inventory"),l=t("./monster");i.heroMonsterNames=["elf_f","elf_m","knight_f","knight_m","wizard_f","wizard_m"];i.HeroMonster=class{constructor(t,e,i,o,h,n,a){this.registry=t,this.joystick=e,this.x=i,this.y=o,this.new_x=i,this.new_y=o,this.is_left=!1,this.name=h,this.healthMax=30,this.health=this.healthMax,this.coins=0,this.damage=5,this.dead=!1,this.weapon=n,this.speed=100,this.inventory=new s.Inventory,this.setAnimation(l.MonsterState.Idle,a)}setLevel(t){this.level=t}setAnimation(t,e){if(!this.dead)switch(t){case l.MonsterState.Idle:this.state=t,this.tileName=this.name+"_idle_anim",this.tile=this.registry.get(this.tileName),this.frame=0,this.start=e;break;case l.MonsterState.Run:this.state=t,this.tileName=this.name+"_run_anim",this.tile=this.registry.get(this.tileName),this.frame=0,this.start=e;break;case l.MonsterState.Hit:this.state=t,this.tileName=this.name+"_hit_anim",this.tile=this.registry.get(this.tileName),this.frame=0,this.weapon.frame=0,this.start=e}}animate(t){switch(this.state){case l.MonsterState.Idle:this.frame=Math.floor((t-this.start)/this.speed),this.action(t)||this.frame>=this.tile.numOfFrames&&this.setAnimation(l.MonsterState.Idle,t);break;case l.MonsterState.Run:this.frame=Math.floor((t-this.start)/this.speed),this.frame>=this.tile.numOfFrames&&(this.level.monsters[this.y][this.x]=null,this.level.monsters[this.new_y][this.new_x]=this,this.x=this.new_x,this.y=this.new_y,this.scanDrop(),this.action(t)||this.setAnimation(l.MonsterState.Idle,t));break;case l.MonsterState.Hit:this.weapon.frame=Math.floor((t-this.start)/this.weapon.speed),this.weapon.frame>=this.weapon.numOfFrames&&(this.scanHit(t),this.scanDrop(),this.action(t)||this.setAnimation(l.MonsterState.Idle,t))}}action(t){this.scanDrop();for(let t=0;t<10;t++){const e=(t+1)%10;this.joystick.digit(e).processed||(this.joystick.digit(e).processed=!0,this.inventory.cells[t].use(this))}return this.joystick.hit.triggered&&!this.joystick.hit.processed?"floor_ladder"===this.level.floor[this.y][this.x]?(this.joystick.hit.processed=!0,this.level.exit(t),!0):(this.setAnimation(l.MonsterState.Hit,t),!0):!(!this.joystick.moveUp.triggered&&this.joystick.moveUp.processed||(this.joystick.moveUp.processed=!0,!this.move(0,-1,t)))||(!(!this.joystick.moveDown.triggered&&this.joystick.moveDown.processed||(this.joystick.moveDown.processed=!0,!this.move(0,1,t)))||(!(!this.joystick.moveLeft.triggered&&this.joystick.moveLeft.processed||(this.joystick.moveLeft.processed=!0,this.is_left=!0,!this.move(-1,0,t)))||!(!this.joystick.moveRight.triggered&&this.joystick.moveRight.processed||(this.joystick.moveRight.processed=!0,this.is_left=!1,!this.move(1,0,t)))))}scanDrop(){if(this.level.drop[this.y][this.x]){this.level.drop[this.y][this.x].pickedUp(this)&&(this.level.drop[this.y][this.x]=null)}}scanHit(t){const e=this.weapon.distance,i=this.is_left?Math.max(0,this.x-e):this.x,s=this.is_left?this.x:Math.min(this.level.w,this.x+e),l=Math.max(0,this.y-e),o=Math.min(this.level.h,this.y+e);for(let e=l;e<=o;e++)for(let l=i;l<=s;l++)if(l!==this.x||e!==this.y){const i=this.level.monsters[e][l];i&&i.hitDamage(this.damage,this.name,t)}}move(t,e,i){if(!this.dead&&this.state===l.MonsterState.Idle){const s=this.x+t,o=this.y+e;return!!this.level.floor[o][s]&&(!this.level.monsters[o][s]&&(this.level.monsters[o][s]=new l.MovingMonsterWrapper(this),this.new_x=s,this.new_y=o,this.setAnimation(l.MonsterState.Run,i),!0))}return!1}resetPosition(t,e){this.x=t,this.y=e,this.new_x=t,this.new_y=e}hitDamage(t,e,i){this.dead||(this.level.log.push(`${this.name} damaged ${t} by ${e}`),this.health=Math.max(0,this.health-t),this.health<=0&&(this.level.log.push(`${this.name} killed by ${e}`),this.setAnimation(l.MonsterState.Idle,i),this.dead=!0))}hill(t){this.health=Math.min(this.healthMax,this.health+t)}addCoins(t){this.coins=this.coins+t}},i.weaponNames=["weapon_knife","weapon_rusty_sword","weapon_regular_sword","weapon_red_gem_sword","weapon_big_hammer","weapon_hammer","weapon_baton_with_spikes","weapon_mace","weapon_katana","weapon_saw_sword","weapon_anime_sword","weapon_axe","weapon_machete","weapon_cleaver","weapon_duel_sword","weapon_knight_sword","weapon_golden_sword","weapon_lavish_sword","weapon_red_magic_staff","weapon_green_magic_staff"];i.Weapon=class{constructor(t,e){this.tileName=e,this.tile=t.get(this.tileName),this.frame=0,this.numOfFrames=4,this.speed=100,this.distance=1}}},{"./inventory":5,"./monster":7}],4:[function(t,e,i){"use strict";var s;Object.defineProperty(i,"__esModule",{value:!0}),function(t){t[t.Await=1]="Await",t[t.Pressed=2]="Pressed"}(s||(s={}));class l{constructor(t){this.code=t,this.state=s.Await,this.triggered=!1,this.processed=!0}keydown(t){t.code===this.code&&(t.preventDefault(),this.state===s.Await&&(this.triggered=!0,this.processed=!1,this.state=s.Pressed))}keyup(t){t.code===this.code&&(t.preventDefault(),this.state===s.Pressed&&(this.triggered=!1,this.state=s.Await))}}i.KeyBind=l;i.Joystick=class{constructor(){this.moveUp=new l("KeyW"),this.moveLeft=new l("KeyA"),this.moveDown=new l("KeyS"),this.moveRight=new l("KeyD"),this.hit=new l("KeyF"),this.digit1=new l("Digit1"),this.digit2=new l("Digit2"),this.digit3=new l("Digit3"),this.digit4=new l("Digit4"),this.digit5=new l("Digit5"),this.digit6=new l("Digit6"),this.digit7=new l("Digit7"),this.digit8=new l("Digit8"),this.digit9=new l("Digit9"),this.digit0=new l("Digit0"),this.init()}digit(t){switch(t){case 1:return this.digit1;case 2:return this.digit2;case 3:return this.digit3;case 4:return this.digit4;case 5:return this.digit5;case 6:return this.digit6;case 7:return this.digit7;case 8:return this.digit8;case 9:return this.digit9;case 0:return this.digit0}}init(){window.addEventListener("keydown",this.keydown.bind(this)),window.addEventListener("keyup",this.keyup.bind(this))}keydown(t){this.moveUp.keydown(t),this.moveLeft.keydown(t),this.moveDown.keydown(t),this.moveRight.keydown(t),this.hit.keydown(t),this.digit1.keydown(t),this.digit2.keydown(t),this.digit3.keydown(t),this.digit4.keydown(t),this.digit5.keydown(t),this.digit6.keydown(t),this.digit7.keydown(t),this.digit8.keydown(t),this.digit9.keydown(t),this.digit0.keydown(t)}keyup(t){this.moveUp.keyup(t),this.moveLeft.keyup(t),this.moveDown.keyup(t),this.moveRight.keyup(t),this.hit.keyup(t),this.digit1.keyup(t),this.digit2.keyup(t),this.digit3.keyup(t),this.digit4.keyup(t),this.digit5.keyup(t),this.digit6.keyup(t),this.digit7.keyup(t),this.digit8.keyup(t),this.digit9.keyup(t),this.digit0.keyup(t)}}},{}],5:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});i.Inventory=class{constructor(){this.cells=[];for(let t=0;t<10;t++)this.cells[t]=new s}add(t){for(let e=0;e<this.cells.length;e++)if(this.cells[e].stack(t))return!0;for(let e=0;e<this.cells.length;e++)if(this.cells[e].set(t))return!0;return!1}};class s{constructor(){this.maxInStack=3,this.item=null,this.count=0}stack(t){return!!(this.item&&this.item.same(t)&&this.count<this.maxInStack)&&(this.count++,!0)}set(t){return!this.item&&(this.item=t,this.count=1,!0)}use(t){return!!(this.item&&this.count>0)&&(this.item.use(t),this.count--,this.count<=0&&(this.item=null,this.count=0),!0)}}i.InventoryCell=s},{}],6:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});const s=t("./tiny.monster"),l=t("./drop");class o{constructor(t,e,i,s){this.x=t,this.y=e,this.w=i,this.h=s}expand(){const t=this;return new o(t.x-2,t.y-3,t.w+2+2,t.h+3+3)}expandV(){const t=this;return new o(t.x-2,t.y,t.w+2+2,t.h)}expandH(){const t=this;return new o(t.x,t.y-3,t.w,t.h+3+3)}isOverlap(t){const e=this;return e.x<t.x+t.w&&e.x+e.w>t.x&&e.y<t.y+t.h&&e.y+e.h>t.y}}i.Rect=o;class h{constructor(t,e,i,s,l,o){this.rng=t,this.registry=e,this.scene=i,this.level=l,this.w=200,this.h=120,this.log=[],this.rooms=[],this.corridorsV=[],this.corridorsH=[],this.floor=this.createBuffer(()=>null),this.drop=this.createBuffer(()=>null),this.wall=this.createBuffer(()=>null),this.monsterList=[],this.hero=s,this.monsters=this.createBuffer(()=>null),this.generate(o),this.fill(),this.replace()}createBuffer(t){const e=[];for(let i=0;i<this.h;i++){const i=[];e.push(i);for(let e=0;e<this.w;e++)i.push(t())}return e}generate(t){const e=1+this.level,i=3+this.level,l=5+this.level;for(let t=0;t<e;t++)this.generateRoom();for(let e=0;e<i;e++){const e=this.rng.nextRange(1,this.rooms.length),i=this.rooms[e];for(let e=0;e<10;e++){const e=i.x+this.rng.nextRange(0,i.w),l=i.y+this.rng.nextRange(0,i.h);if(!this.monsters[l][e]){const i=this.rng.choice(s.tinyMonsterNames),o=new s.TinyMonster(this.rng,this.registry,this,e,l,i,t);this.monsterList.push(o),this.monsters[l][e]=o;break}}}for(let t=0;t<l;t++){const t=this.rng.choice(this.rooms);for(let e=0;e<10;e++){const e=t.x+this.rng.nextRange(0,t.w),i=t.y+this.rng.nextRange(0,t.h);if(!this.drop[i][e]){this.randomDrop(e,i);break}}}{const t=this.rooms[0],e=t.x+(t.w>>1),i=t.y+(t.h>>1);this.hero.setLevel(this),this.hero.resetPosition(e,i),this.monsters[i][e]=this.hero}}generateRoom(){for(;;){const t=this.rng.nextRange(5,15),e=this.rng.nextRange(3,10),i=new o(this.rng.nextRange(2,this.w-2-t),this.rng.nextRange(2,this.h-2-e),t,e);if(!this.isOverlap(i.expand())){if(0===this.rooms.length){this.rooms.push(i);break}{const t=i;let e=!1;for(let i=0;i<this.rooms.length;i++){let s=this.rooms[i];const l=Math.max(t.x,s.x),h=Math.min(t.x+t.w,s.x+s.w);if(l+5<=h){let i;i=t.y+t.h<s.y?new o(l+2,t.y+t.h,h-l-4,s.y-t.y-t.h):new o(l+2,s.y+s.h,h-l-4,t.y-s.y-s.h),i.h<12&&!this.isOverlap(i.expandV())&&(this.corridorsV.push(i),e=!0)}const n=Math.max(t.y,s.y),a=Math.min(t.y+t.h,s.y+s.h);if(n+3<=a){let i;i=t.x+t.w<s.x?new o(t.x+t.w,n+1,s.x-t.x-t.w,a-n-2):new o(s.x+s.w,n+1,t.x-s.x-s.w,a-n-2),i.w<12&&!this.isOverlap(i.expandH())&&(this.corridorsH.push(i),e=!0)}}if(e){this.rooms.push(i);break}}}}}isOverlap(t){const e=t.isOverlap.bind(t);return this.rooms.some(e)||this.corridorsV.some(e)||this.corridorsH.some(e)}randomDrop(t,e){this.rng.nextFloat()<.5?this.drop[e][t]=new l.Coins(this.rng):this.rng.nextFloat()<.3?this.drop[e][t]=new l.HealthFlask:this.rng.nextFloat()<.3&&(this.drop[e][t]=new l.HealthBigFlask)}fill(){this.rooms.forEach(t=>this.fillRoom(t.x,t.y,t.w,t.h)),this.corridorsH.forEach(t=>this.fillCorridorH(t.x,t.y,t.w,t.h)),this.corridorsV.forEach(t=>this.fillCorridorV(t.x,t.y,t.w,t.h))}fillRoom(t,e,i,s){for(let l=e;l<e+s;l++)for(let e=t;e<t+i;e++)this.floor[l][e]="floor_1";if(this.wall[e-2][t]="wall_corner_top_left",this.wall[e-1][t]="wall_corner_left",i>1){for(let s=t+1;s<t+i-1;s++)this.wall[e-2][s]="wall_top_mid",this.wall[e-1][s]="wall_mid";this.wall[e-2][t+i-1]="wall_corner_top_right",this.wall[e-1][t+i-1]="wall_corner_right"}if(this.wall[e+s-1][t]="wall_corner_bottom_left",this.wall[e+s][t]="wall_left",i>1){for(let l=t+1;l<t+i-1;l++)this.wall[e+s-1][l]="wall_top_mid",this.wall[e+s][l]="wall_mid";this.wall[e+s-1][t+i-1]="wall_corner_bottom_right",this.wall[e+s][t+i-1]="wall_right"}for(let i=e;i<e+s-1;i++)this.wall[i][t]="wall_side_mid_right";for(let l=e;l<e+s-1;l++)this.wall[l][t+i-1]="wall_side_mid_left"}fillCorridorH(t,e,i,s){for(let l=e;l<e+s;l++)for(let e=t;e<t+i;e++)this.floor[l][e]="floor_1";switch(this.wall[e-2][t-1]){case"wall_corner_top_right":this.wall[e-2][t-1]="wall_top_mid";break;case"wall_side_mid_left":break;default:console.log("top left 2",this.wall[e-2][t-1])}switch(this.wall[e-1][t-1]){case"wall_corner_right":this.wall[e-1][t-1]="wall_mid";break;case"wall_side_mid_left":this.wall[e-1][t-1]="wall_side_front_left";break;default:console.log("top left 1",this.wall[e-1][t-1])}if(s>1)for(let i=e;i<e+s-1;i++)switch(this.wall[i][t-1]){case"wall_side_mid_left":this.wall[i][t-1]=null;break;default:console.log("mid left",this.wall[i][t-1])}switch(this.wall[e+s-1][t-1]){case"wall_side_mid_left":this.wall[e+s-1][t-1]="wall_side_top_left";break;case"wall_corner_bottom_right":this.wall[e+s-1][t-1]="wall_top_mid";break;default:console.log("bottom left 0",this.wall[e+s-1][t-1])}switch(this.wall[e+s][t-1]){case"wall_side_mid_left":break;case"wall_right":this.wall[e+s][t-1]="wall_mid";break;default:console.log("bottom left 1",this.wall[e+s][t-1])}switch(this.wall[e-2][t+i]){case"wall_corner_top_left":this.wall[e-2][t+i]="wall_top_mid";break;case"wall_side_mid_right":break;default:console.log("top right 2",this.wall[e-2][t+i])}switch(this.wall[e-1][t+i]){case"wall_corner_left":this.wall[e-1][t+i]="wall_mid";break;case"wall_side_mid_right":this.wall[e-1][t+i]="wall_side_front_right";break;default:console.log("top right 1",this.wall[e-1][t+i])}if(s>1)for(let l=e;l<e+s-1;l++)switch(this.wall[l][t+i]){case"wall_side_mid_right":this.wall[l][t+i]=null;break;default:console.log("mid right",this.wall[l][t+i])}switch(this.wall[e+s-1][t+i]){case"wall_side_mid_right":this.wall[e+s-1][t+i]="wall_side_top_right";break;case"wall_corner_bottom_left":this.wall[e+s-1][t+i]="wall_top_mid";break;default:console.log("bottom right 0",this.wall[e+s-1][t+i])}switch(this.wall[e+s][t+i]){case"wall_side_mid_right":break;case"wall_left":this.wall[e+s][t+i]="wall_mid";break;default:console.log("bottom right +1",this.wall[e+s][t+i])}for(let s=t;s<t+i;s++)this.wall[e-2][s]="wall_top_mid",this.wall[e-1][s]="wall_mid";for(let l=t;l<t+i;l++)this.wall[e+s-1][l]="wall_top_mid",this.wall[e+s][l]="wall_mid"}fillCorridorV(t,e,i,s){for(let l=e;l<e+s;l++)for(let e=t;e<t+i;e++)this.floor[l][e]="floor_1";switch(this.wall[e-1][t-1]){case"wall_top_mid":this.wall[e-1][t-1]="wall_corner_top_right";break;default:console.log("top left -1 -1",this.wall[e-1][t-1])}switch(this.wall[e][t-1]){case"wall_mid":this.wall[e][t-1]="wall_corner_right";break;default:console.log("top left 0 -1",this.wall[e][t-1])}for(let s=t;s<t+i;s++){switch(this.wall[e-1][s]){case"wall_top_mid":this.wall[e-1][s]=null;break;default:console.log("top mid -1",this.wall[e-1][s])}switch(this.wall[e][s]){case"wall_mid":this.wall[e][s]=null;break;default:console.log("top mid 0",this.wall[e][s])}}switch(this.wall[e-1][t+i]){case"wall_top_mid":this.wall[e-1][t+i]="wall_corner_top_left";break;default:console.log("top right -1 1",this.wall[e-1][t+i])}switch(this.wall[e][t+i]){case"wall_mid":this.wall[e][t+i]="wall_corner_left";break;default:console.log("top right 0 -1",this.wall[e][t+i])}switch(this.wall[e+s-2][t-1]){case"wall_top_mid":this.wall[e+s-2][t-1]="wall_corner_bottom_right";break;default:console.log("bottom left -2 -1",this.wall[e+s-2][t-1])}switch(this.wall[e+s-1][t-1]){case"wall_mid":this.wall[e+s-1][t-1]="wall_corner_front_right";break;default:console.log("top left 0 -1",this.wall[e+s-1][t-1])}for(let l=t;l<t+i;l++){switch(this.wall[e+s-2][l]){case"wall_top_mid":this.wall[e+s-2][l]=null;break;default:console.log("bottom mid -2",this.wall[e+s-2][l])}switch(this.wall[e+s-1][l]){case"wall_mid":this.wall[e+s-1][l]=null;break;default:console.log("bottom mid -1",this.wall[e+s-1][l])}}switch(this.wall[e+s-2][t+i]){case"wall_top_mid":this.wall[e+s-2][t+i]="wall_corner_bottom_left";break;default:console.log("bottom right -2 -1",this.wall[e+s-2][t-1])}switch(this.wall[e+s-1][t+i]){case"wall_mid":this.wall[e+s-1][t+i]="wall_corner_front_left";break;default:console.log("bottom right 0 -1",this.wall[e+s-1][t-1])}for(let l=e+1;l<e+s-2;l++)this.wall[l][t-1]="wall_side_mid_left",this.wall[l][t+i]="wall_side_mid_right"}replace(){this.replaceFloorRandomly(),this.replaceLadder(),this.replaceWallRandomly()}replaceFloorRandomly(){const t=["floor_2","floor_3","floor_4","floor_5","floor_6","floor_7","floor_8"];for(let e=0;e<this.h;e++)for(let i=0;i<this.w;i++)this.floor[e][i]&&this.rng.nextFloat()<.2&&(this.floor[e][i]=this.rng.choice(t))}replaceLadder(){const t=this.rooms[this.rooms.length-1],e=t.x+(t.w>>1),i=t.y+(t.h>>1);console.log(e,i,t),this.floor[i][e]="floor_ladder"}replaceWallRandomly(){const t=["wall_hole_1","wall_hole_2","wall_banner_red","wall_banner_blue","wall_banner_green","wall_banner_yellow","wall_goo","wall_fountain_mid_red_anim","wall_fountain_mid_blue_anim"],e=["wall_hole_1","wall_hole_2"];for(let i=0;i<this.h;i++)for(let s=0;s<this.w;s++)if(this.wall[i][s])switch(this.wall[i][s]){case"wall_mid":if(this.rng.nextFloat()<.2){let l;l=!!this.floor[i+1][s]?t:e;const o=this.rng.choice(l);switch(o){case"wall_goo":this.wall[i][s]="wall_goo",this.floor[i+1][s]="wall_goo_base";break;case"wall_fountain_mid_red_anim":this.wall[i-1][s]="wall_fountain_top",this.wall[i][s]="wall_fountain_mid_red_anim",this.floor[i+1][s]="wall_fountain_basin_red_anim";break;case"wall_fountain_mid_blue_anim":this.wall[i-1][s]="wall_fountain_top",this.wall[i][s]="wall_fountain_mid_blue_anim",this.floor[i+1][s]="wall_fountain_basin_blue_anim";break;default:this.wall[i][s]=o}}}}exit(t){this.scene.setLevel(new h(this.rng,this.registry,this.scene,this.hero,this.level+1,t))}animate(t){this.monsterList.forEach(e=>e.animate(t)),this.hero.animate(t)}}i.Level=h},{"./drop":1,"./tiny.monster":11}],7:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),function(t){t[t.Idle=0]="Idle",t[t.Run=1]="Run",t[t.Hit=2]="Hit"}(i.MonsterState||(i.MonsterState={}));i.MovingMonsterWrapper=class{constructor(t){this.monster=t}hitDamage(t,e,i){this.monster.hitDamage(t,e,i)}get x(){return this.monster.x}get y(){return this.monster.y}get new_x(){return this.monster.new_x}get new_y(){return this.monster.new_y}get is_left(){return this.monster.is_left}get frame(){return this.monster.frame}get start(){return this.monster.start}get speed(){return this.monster.speed}get tile(){return this.monster.tile}get state(){return this.monster.state}get weapon(){return this.monster.weapon}}},{}],8:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});const s=2147483648;i.RNG=class{constructor(t=null){this.state=t||Math.floor(Math.random()*(s-1)),console.log("seed",this.state)}nextInt(){return this.state=(1103515245*this.state+12345)%s,this.state}nextFloat(){return this.nextInt()/(s-1)}nextRange(t,e){const i=e-t,l=this.nextInt()/s;return t+Math.floor(l*i)}choice(t){return t[this.nextRange(0,t.length)]}}},{}],9:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});i.Scene=class{setLevel(t){this.level=t}}},{}],10:[function(t,e,i){"use strict";var s=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))((function(l,o){function h(t){try{a(s.next(t))}catch(t){o(t)}}function n(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?l(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(h,n)}a((s=s.apply(t,e||[])).next())}))};Object.defineProperty(i,"__esModule",{value:!0});i.TileRegistry=class{constructor(){this.tileMap={}}loadTileSet(){return s(this,void 0,void 0,(function*(){return yield new Promise(t=>{const e=new Image;e.onload=i=>t(e),e.src="0x72_DungeonTilesetII_v1.2.png"})}))}load(){return s(this,void 0,void 0,(function*(){const t=yield this.loadTileSet(),e=yield fetch("tiles_list_v1.1.txt");(yield e.text()).split(/(\r?\n)/g).forEach(e=>{let i=e.match(/([a-z0-9_]+) +([0-9]+) +([0-9]+) +([0-9]+) +([0-9]+) ?([0-9]?)/);if(i){const e=parseInt(i[2]),s=parseInt(i[3]),o=parseInt(i[4]),h=parseInt(i[5]),n=parseInt(i[6]||"0"),a=new l(t,i[1],e,s,o,h,n);this.tileMap[a.name]=a}})}))}get(t){return this.tileMap[t]}};class l{constructor(t,e,i,s,l,o,h){this.tileSet=t,this.name=e,this.x=i,this.y=s,this.w=l,this.h=o,this.numOfFrames=h,this.isAnim=this.numOfFrames>1}}i.Tile=l},{}],11:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});const s=t("./monster");i.tinyMonsterNames=["tiny_zombie","goblin","imp","skeleton","muddy","swampy","zombie","ice_zombie"];i.TinyMonster=class{constructor(t,e,i,l,o,h,n){this.rng=t,this.registry=e,this.level=i,this.x=l,this.y=o,this.new_x=l,this.new_y=o,this.is_left=!1,this.name=h,this.healthMax=10,this.health=this.healthMax,this.damage=1,this.luck=.5,this.speed=100,this.setAnimation(s.MonsterState.Idle,n)}setAnimation(t,e){switch(t){case s.MonsterState.Idle:this.state=t,this.tileName=this.name+"_idle_anim",this.tile=this.registry.get(this.tileName),this.frame=0,this.start=e;break;case s.MonsterState.Run:this.state=t,this.tileName=this.name+"_run_anim",this.tile=this.registry.get(this.tileName),this.frame=0,this.start=e}}animate(t){if(this.frame=Math.floor((t-this.start)/this.speed),this.frame>=this.tile.numOfFrames){this.state===s.MonsterState.Run&&(this.level.monsters[this.y][this.x]=null,this.level.monsters[this.new_y][this.new_x]=this,this.x=this.new_x,this.y=this.new_y),this.setAnimation(s.MonsterState.Idle,t);const e=3,i=Math.max(0,this.x-e),l=Math.max(0,this.y-e),o=Math.min(this.level.w,this.x+e),h=Math.min(this.level.h,this.y+e);if(!this.level.hero.dead&&this.level.hero.x>=i&&this.level.hero.x<=o&&this.level.hero.y>=l&&this.level.hero.y<=h){const e=Math.abs(this.x-this.level.hero.x),i=Math.abs(this.y-this.level.hero.y);if(e>1){const e=Math.max(-1,Math.min(1,this.level.hero.x-this.x));if(this.move(e,0,t))return void console.log("move to hero x")}if(i>0){const e=Math.max(-1,Math.min(1,this.level.hero.y-this.y));if(this.move(0,e,t))return void console.log("move to hero y")}if(e<=1&&i<=1&&this.rng.nextFloat()<this.luck)return void this.level.hero.hitDamage(this.damage,this.name,t)}const n=.1;if(this.rng.nextFloat()<n){const e=this.rng.nextRange(-1,1),i=this.rng.nextRange(-1,1);if(this.move(e,i,t))return}}}move(t,e,i){if(this.is_left=t<0,this.state===s.MonsterState.Idle){const l=this.x+t,o=this.y+e;return!!this.level.floor[o][l]&&(!this.level.monsters[o][l]&&(this.level.monsters[o][l]=new s.MovingMonsterWrapper(this),this.new_x=l,this.new_y=o,this.setAnimation(s.MonsterState.Run,i),!0))}return!1}hitDamage(t,e,i){this.level.log.push(`${this.name} damaged ${t} by ${e}`),this.health=Math.max(0,this.health-t),this.health<=0&&(this.level.log.push(`${this.name} killed by ${e}`),this.level.monsters[this.y][this.x]=null,this.level.monsters[this.new_y][this.new_x]=null,this.level.monsterList=this.level.monsterList.filter(t=>t!==this),this.rng.nextFloat()<this.luck&&this.level.randomDrop(this.x,this.y))}}},{"./monster":7}]},{},[2]);
//# sourceMappingURL=bundle.js.map
