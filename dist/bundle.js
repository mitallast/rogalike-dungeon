!function(t){var e={};function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(s,n,function(e){return t[e]}.bind(null,n));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=8)}([function(t,e){t.exports=PIXI},function(t,e,i){"use strict";i.d(e,"b",(function(){return n})),i.d(e,"e",(function(){return o})),i.d(e,"a",(function(){return r})),i.d(e,"c",(function(){return h})),i.d(e,"d",(function(){return l}));var s=i(0);const n={background:2105376,uiBackground:5263440,uiSelected:9474192,uiNotSelected:5263440,uiRed:16711680,uiYellow:16765696},o={uiBorder:4,uiMargin:16};class r extends s.Container{constructor(t){super(),this._selected=!1,this._width=t.width||200,this._height=t.height||24,this._textSize=t.textSize||16,this._bg=new s.Graphics,this._text=new s.BitmapText(t.label,{font:{name:"alagard",size:this._textSize}}),this._text.anchor=new s.Point(.5,.5),this._text.position.set(this._width>>1,this._height>>1),this.selected=t.selected||!1,super.addChild(this._bg,this._text)}get selected(){return this._selected}set selected(t){this._selected=t,this._bg.clear().beginFill(t?n.uiSelected:n.uiNotSelected).drawRect(0,0,this._width,this._height).endFill()}}class h{constructor(){this.commitX=0,this.commitY=0,this.offsetX=0,this.offsetY=0}commit(){this.commitX=this.offsetX,this.commitY=this.offsetY}reset(){this.offsetX=this.commitX,this.offsetY=this.commitY}offset(t,e){this.offsetX+=t,this.offsetY+=e}get x(){return this.offsetX}get y(){return this.offsetY}}function a(t,e){const i=e||0;if(t[i]>0)return i;const s=function(t,e){for(let i=e-1;i>=0;i--)if(t[i]>0)return i;return null}(t,i);if(null!==s)return s;const n=function(t,e){for(let i=e+1;i<t.length;i++)if(t[i]>0)return i;return null}(t,i);return null!==n?n:null}class l{constructor(t){this.cells=[],this.counts_x=[],this.counts_y=[],this.limit_x=-1,this.limit_y=-1,this.selected_x=null,this.selected_y=null,this.joystick=t}reset(){if(this.unmark(),this.selected_x=a(this.counts_x,this.selected_x),this.selected_y=a(this.counts_y,this.selected_y),null===this.selected_x||null===this.selected_y)this.selected_x=null,this.selected_y=null;else if(!this.cell(this.selected_x,this.selected_y).isSelectable){const t=this.selected_y,e=(e=>{for(let i=e-1;i>=0;i--)if(this.cell(i,t).isSelectable)return i;return null})(this.selected_x);if(null!==e)this.selected_x=e;else{const e=(e=>{for(let i=e+1;i<=this.limit_x;i++)if(this.cell(i,t).isSelectable)return i;return null})(this.selected_x);if(null===e)throw"illegal state";this.selected_x=e}}this.mark()}moveLeft(){var t;if(this.unmark(),null!==this.selected_x&&null!==this.selected_y){const e=this.selected_y;if(0===this.counts_y[e])throw"illegal state: empty column "+e;const i=null===(t=this.selectedCell)||void 0===t?void 0:t.merged,s=this.selected_x,n=t=>t>0?t-1:this.limit_x;for(let t=n(s);t!=s;t=n(t))if(!(null==i?void 0:i.contains(t,e))&&this.cell(t,e).isSelectable){this.selected_x=t;break}}this.mark()}moveRight(){var t;if(this.unmark(),null!==this.selected_x&&null!==this.selected_y){const e=this.selected_y;if(0===this.counts_y[e])throw"illegal state: empty column "+e;const i=null===(t=this.selectedCell)||void 0===t?void 0:t.merged,s=this.selected_x,n=t=>(t+1)%(this.limit_x+1);for(let t=n(s);t!=s;t=n(t))if(!(null==i?void 0:i.contains(t,e))&&this.cell(t,e).isSelectable){this.selected_x=t;break}}this.mark()}moveUp(){var t;if(this.unmark(),null!==this.selected_x&&null!==this.selected_y){const e=this.selected_x;if(0===this.counts_x[e])throw"illegal state: empty row "+e;const i=null===(t=this.selectedCell)||void 0===t?void 0:t.merged,s=this.selected_y,n=t=>t>0?t-1:this.limit_y;for(let t=n(s);t!=s;t=n(t))if(!(null==i?void 0:i.contains(e,t))&&this.cell(e,t).isSelectable){this.selected_y=t;break}}this.mark()}moveDown(){var t;if(this.unmark(),null!==this.selected_x&&null!==this.selected_y){const e=this.selected_x;if(0===this.counts_x[e])throw"illegal state: empty row "+e;const i=null===(t=this.selectedCell)||void 0===t?void 0:t.merged,s=this.selected_y,n=t=>(t+1)%(this.limit_y+1);for(let t=n(s);t!=s;t=n(t))if(!(null==i?void 0:i.contains(e,t))&&this.cell(e,t).isSelectable){this.selected_y=t;break}}this.mark()}unmark(){var t;null===(t=this.selectedCell)||void 0===t||t.unmark()}mark(){var t;null===(t=this.selectedCell)||void 0===t||t.mark()}get selected(){var t;return(null===(t=this.selectedCell)||void 0===t?void 0:t.value)||null}get selectedCell(){if(null!==this.selected_x&&null!==this.selected_y){const t=this.cell(this.selected_x,this.selected_y);return t.merged&&t.isRef?this.cell(t.merged.from_x,t.merged.from_y):t}return null}set(t,e,i,s){if(t<0||e<0)throw`illegal coordinate: ${t}:${e}`;const n=this.cell(t,e);if(n.isRef)throw`cell is ref: ${t}:${e}`;const o=null!==n.value;if(n.value=[i,s],!o)if(n.merged){const t=n.merged;for(let e=t.from_x;e<=t.to_x;e++)for(let i=t.from_y;i<=t.to_y;i++)this.counts_x[e]++,this.counts_y[i]++}else this.counts_x[t]++,this.counts_y[e]++;this.reset()}merge(t,e,i,s){if(t<0||e<0)throw`illegal coordinate: ${t}:${e}`;if(i<1||s<1)throw`illegal size: ${i}:${s}`;const n=new d(t,e,t+i-1,e+s-1),o=this.cell(t,e);if(o.isRef)throw`cell is ref: ${t}:${e}`;if(o.merged)throw"cell is merged: "+JSON.stringify(o.merged);o.merged=n;const r=null!==o.value;for(let i=n.from_x;i<=n.to_x;i++)for(let s=n.from_y;s<=n.to_y;s++)if(i!==t||s!==e){const t=this.cell(i,s);if(t.value)throw`merging cell already has value: ${i}:${s}`;if(t.isRef)throw`merging cell is ref: ${i}:${s}`;t.merged=n,r&&(this.counts_x[i]++,this.counts_y[s]++)}}remove(t,e){if(t<0||e<0)throw`illegal coordinate: ${t}:${e}`;const i=this.cell(t,e);if(i.isRef)throw`cell is ref: ${t}:${e}`;if(i.value)if(i.value=null,i.merged){const t=i.merged;for(let e=t.from_x;e<=t.to_x;e++)for(let i=t.from_y;i<=t.to_y;i++)this.counts_x[e]--,this.counts_y[i]--}else this.counts_x[t]--,this.counts_y[e]--}unmerge(t,e){if(t<0||e<0)throw`illegal coordinate: ${t}:${e}`;const i=this.cell(t,e);if(i.isRef)throw`cell is ref: ${t}:${e}`;if(i.merged){const s=null!==i.value,n=i.merged;i.merged=null;for(let i=n.from_x;i<=n.to_x;i++)for(let o=n.from_y;o<=n.to_y;o++)i===t&&o===e||(this.cell(i,o).merged=null,s&&(this.counts_x[i]--,this.counts_y[o]--))}}cell(t,e){if(t<0||e<0)throw"illegal coordinate";return this.expand(t,e),this.cells[e][t]}expand(t,e){for(;this.limit_y<e;){this.limit_y++,this.counts_y[this.limit_y]=0,this.cells[this.limit_y]=[];for(let t=0;t<=this.limit_x;t++)this.cells[this.limit_y][t]=new c(t,this.limit_y)}for(;this.limit_x<t;){this.limit_x++,this.counts_x[this.limit_x]=0;for(let t=0;t<=this.limit_y;t++)this.cells[t][this.limit_x]=new c(this.limit_x,t)}}handleInput(){const t=this.joystick;if(t.moveUp.once()&&this.moveUp(),t.moveDown.once()&&this.moveDown(),t.moveLeft.once()&&this.moveLeft(),t.moveRight.once()&&this.moveRight(),t.hit.once()){const t=this.selected;if(t){let[,e]=t;s.sound.play("confirm"),e()}else s.sound.play("cancel"),console.warn("selected not found")}}}class c{constructor(t,e){this.x=t,this.y=e,this.merged=null,this.value=null}unmark(){this.value&&(this.value[0].selected=!1)}mark(){this.value&&(this.value[0].selected=!0)}get isRef(){return null!==this.merged&&!(this.merged.from_x===this.x&&this.merged.from_y===this.y)}get isSelectable(){return null!==this.value||this.isRef}}class d{constructor(t,e,i,s){this.from_x=t,this.from_y=e,this.to_x=i,this.to_y=s}contains(t,e){return t>=this.from_x&&t<=this.to_x&&e>=this.from_y&&e<=this.to_y}}},function(t,e,i){"use strict";i.d(e,"a",(function(){return s})),i.d(e,"c",(function(){return n})),i.d(e,"b",(function(){return o})),i.d(e,"h",(function(){return a})),i.d(e,"g",(function(){return l})),i.d(e,"e",(function(){return c})),i.d(e,"f",(function(){return d})),i.d(e,"d",(function(){return u}));class s{constructor(t){this.spriteName="coin",this.coins=t.range(1,30)}pickedUp(t){return t.addCoins(this.coins),!0}}class n{constructor(){this.spriteName="flask_red.png",this.health=2}info(){return{name:"Health flask",health:this.health,buyPrice:100}}pickedUp(t){return t.inventory.add(this)}same(t){return t instanceof n}use(t,e){e.heal(this.health),t.decrease()}}class o{constructor(){this.spriteName="flask_big_red.png",this.health=5}info(){return{name:"Big health flask",health:this.health,buyPrice:300}}pickedUp(t){return t.inventory.add(this)}same(t){return t instanceof o}use(t,e){e.heal(this.health),t.decrease()}}const r={idle:{angle:[0,0],pos:[{time:0,args:[-1,0]},{time:1,args:[-1,1]},{time:2,args:[-1,2]},{time:3,args:[-1,1]}]},run:{angle:[0,0],pos:[{time:0,args:[-1,-1]},{time:1,args:[-1,-2]},{time:2,args:[-1,-1]},{time:3,args:[-1,0]}]},hit:{angle:[0,-10,-20,-30,-40,-40,0,400,100,100,0],pos:[{time:0,args:[-1,0]},{time:1,args:[-1,0]},{time:2,args:[-1,0]},{time:3,args:[-1,0]}]}},h={knife:{idle:r.idle,run:r.run,hit:{angle:[90,90],pos:[{time:0,args:[-8,-4]},{time:1,args:[-4,-4]},{time:2,args:[4,-4]},{time:3,args:[-2,-4]}]}},rusty_sword:r,regular_sword:r,red_gem_sword:r,hammer:r,big_hammer:{idle:r.idle,run:r.run,hit:{angle:[0,-30,-30,-30,-30,-30,0,100,100,100,100,100,100,100,100,100,80,60,40,20,10],pos:[{time:0,args:[-1,0]},{time:1,args:[-1,0]},{time:2,args:[-1,0]},{time:3,args:[-1,0]}]}},baton_with_spikes:r,mace:r,katana:r,saw_sword:r,anime_sword:r,axe:r,machete:r,cleaver:r,duel_sword:r,knight_sword:r,golden_sword:r,lavish_sword:r},a={knife:{name:"weapon_knife",speed:1.4,distance:1,damage:2,level:1,price:12,animations:h.knife},rusty_sword:{name:"weapon_rusty_sword",speed:1,distance:1,damage:4,level:1,price:15,animations:h.rusty_sword},regular_sword:{name:"weapon_regular_sword",speed:1,distance:1,damage:5,level:3,price:20,animations:h.regular_sword},red_gem_sword:{name:"weapon_red_gem_sword",speed:1,distance:1,damage:6,level:3,price:30,animations:h.red_gem_sword},hammer:{name:"weapon_hammer",speed:.7,distance:1,damage:7,level:5,price:38,animations:h.hammer},big_hammer:{name:"weapon_big_hammer",speed:.5,distance:2,damage:10,level:5,price:40,animations:h.big_hammer},baton_with_spikes:{name:"weapon_baton_with_spikes",speed:.6,distance:1,damage:7,level:5,price:42,animations:h.baton_with_spikes},mace:{name:"weapon_mace",speed:.6,distance:1,damage:7,level:5,price:45,animations:h.mace},katana:{name:"weapon_katana",speed:1.5,distance:1,damage:8,level:7,price:100,animations:h.katana},saw_sword:{name:"weapon_saw_sword",speed:1.5,distance:1,damage:9,level:7,price:110,animations:h.saw_sword},anime_sword:{name:"weapon_anime_sword",speed:.7,distance:1,damage:12,level:7,price:130,animations:h.anime_sword},axe:{name:"weapon_axe",speed:.8,distance:1,damage:12,level:7,price:115,animations:h.axe},machete:{name:"weapon_machete",speed:1,distance:1,damage:11,level:9,price:150,animations:h.machete},cleaver:{name:"weapon_cleaver",speed:1,distance:1,damage:12,level:9,price:160,animations:h.cleaver},duel_sword:{name:"weapon_duel_sword",speed:1.5,distance:1,damage:13,level:9,price:170,animations:h.duel_sword},knight_sword:{name:"weapon_knight_sword",speed:1.5,distance:1,damage:14,level:9,price:180,animations:h.knight_sword},golden_sword:{name:"weapon_golden_sword",speed:1.5,distance:1,damage:15,level:11,price:220,animations:h.golden_sword},lavish_sword:{name:"weapon_lavish_sword",speed:1.5,distance:1,damage:16,level:11,price:240,animations:h.lavish_sword}},l=Object.getOwnPropertyNames(a).map(t=>a[t]),c={knife:{name:"weapon_knife",speed:.7,distance:1,damage:.5,level:1,price:0,animations:h.knife},baton_with_spikes:{name:"weapon_baton_with_spikes",speed:.3,distance:1,damage:3,level:5,price:0,animations:h.baton_with_spikes},anime_sword:{name:"weapon_anime_sword",speed:.4,distance:1,damage:4,level:10,price:0,animations:h.anime_sword},big_hammer:{name:"weapon_big_hammer",speed:.3,distance:2,damage:5,level:15,price:0,animations:h.big_hammer},mace:{name:"weapon_mace",speed:.6,distance:1,damage:6,level:20,price:0,animations:h.mace},cleaver:{name:"weapon_cleaver",speed:.5,distance:1,damage:7,level:25,price:0,animations:h.cleaver}},d={knife:{name:"weapon_knife",speed:1.4,distance:1,damage:2,level:1,price:12,animations:h.knife},hammer:{name:"weapon_hammer",speed:.7,distance:1,damage:7,level:5,price:38,animations:h.hammer},cleaver:{name:"weapon_cleaver",speed:1,distance:1,damage:12,level:9,price:160,animations:h.cleaver},axe:{name:"weapon_axe",speed:.8,distance:1,damage:12,level:7,price:115,animations:h.axe},regular_sword:{name:"weapon_regular_sword",speed:1,distance:1,damage:5,level:3,price:20,animations:h.regular_sword},knight_sword:{name:"weapon_knight_sword",speed:1.5,distance:1,damage:14,level:9,price:180,animations:h.knight_sword}};class u{constructor(t){this.name=t.name,this.speed=t.speed,this.distance=t.distance,this.damage=t.damage,this.price=t.price,this.animations=t.animations}get spriteName(){return this.name+".png"}info(){return{name:this.name.replace(/weapon_/,""),speed:this.speed,distance:this.distance,damage:this.damage,sellPrice:this.price,buyPrice:10*this.price}}pickedUp(t){return t.inventory.add(this)}same(t){return!1}use(t){t.equip()}static create(t,e){const i=l.filter(t=>t.level<=e);if(i.length>0){const e=t.select(i);return new u(e)}return null}static select(t,e){if(e.length>0){const i=t.select(e);return new u(i)}return null}}},function(t,e,i){"use strict";i.d(e,"b",(function(){return s})),i.d(e,"a",(function(){return n}));class s{constructor(t){this.listeners=[],this.value=t}set(t){this.value=t;for(let t=this.listeners.length-1;t>=0;t--){let e=this.listeners[t];e.gc?this.listeners.splice(t,1):e.send(this.value)}}update(t){this.set(t(this.value))}get(){return this.value}subscribe(t,e){const i=new o(t,e);this.listeners.push(i),i.send(this.value)}unsubscribe(t,e){var i;null===(i=this.listeners.find(i=>i.matches(t,e)))||void 0===i||i.unsubscribe()}}class n{constructor(){this.listeners=[]}send(t){for(let e=this.listeners.length-1;e>=0;e--){let i=this.listeners[e];i.gc?this.listeners.splice(e,1):i.send(t)}}subscribe(t,e){const i=new o(t,e);this.listeners.push(i)}unsubscribe(t,e){var i;null===(i=this.listeners.find(i=>i.matches(t,e)))||void 0===i||i.unsubscribe()}}class o{constructor(t,e){this._gc=!1,this.callback=t,this.context=e||null}get gc(){return this._gc}matches(t,e){return this.callback===t&&this.context===e}send(t){this.context?this.callback.call(this.context,t):this.callback(t)}unsubscribe(){this._gc=!0}}},function(t,e,i){"use strict";i.d(e,"d",(function(){return h})),i.d(e,"c",(function(){return g})),i.d(e,"f",(function(){return f})),i.d(e,"b",(function(){return m})),i.d(e,"e",(function(){return w})),i.d(e,"a",(function(){return y}));var s=i(2),n=i(3),o=i(1),r=i(0);class h{constructor(t){this._drop=new n.a,this.equipment=new a(t,this._drop),this.belt=new l(t,this._drop),this.backpack=new c(t,this._drop)}get drop(){return this._drop}stack(t){return this.belt.stack(t)||this.backpack.stack(t)}set(t){return this.belt.set(t)||this.backpack.set(t)}add(t){return this.stack(t)||this.set(t)}hasSpace(t){return this.belt.hasSpace(t)||this.backpack.hasSpace(t)}}class a{constructor(t,e){this.weapon=new d(t,1,t=>t instanceof s.d,e,this)}}class l{constructor(t,e){this.length=10,this.cells=[];for(let i=0;i<10;i++)this.cells[i]=new d(t,3,()=>!0,e,this)}cell(t){return this.cells[t]}stack(t){for(let e=0;e<this.cells.length;e++)if(this.cells[e].stack(t))return!0;return!1}set(t){for(let e=0;e<this.cells.length;e++)if(this.cells[e].set(t))return!0;return!1}add(t){return this.stack(t)||this.set(t)}hasSpace(t){for(let e=0;e<this.cells.length;e++)if(this.cells[e].hasSpace(t))return!0;return!1}}class c{constructor(t,e){this.width=10,this.height=5,this.cells=[];for(let i=0;i<this.height;i++){this.cells.push([]);for(let s=0;s<this.width;s++)this.cells[i][s]=new d(t,3,()=>!0,e,this)}}cell(t,e){return this.cells[e][t]}stack(t){for(let e=0;e<this.height;e++)for(let i=0;i<this.width;i++)if(this.cells[e][i].stack(t))return!0;return!1}set(t){for(let e=0;e<this.height;e++)for(let i=0;i<this.width;i++)if(this.cells[e][i].set(t))return!0;return!1}add(t){return this.stack(t)||this.set(t)}hasSpace(t){for(let e=0;e<this.height;e++)for(let i=0;i<this.width;i++)if(this.cells[e][i].hasSpace(t))return!0;return!1}}class d{constructor(t,e,i,s,o){this._item=new n.b(null),this._count=new n.b(0),this.character=t,this._maxInStack=e,this._predicate=i,this._drop=s,this.parent=o}get item(){return this._item}get count(){return this._count}hasSpace(t){return this.supports(t)&&(this.isEmpty||this._item.get().same(t)&&this._count.get()<this._maxInStack)}supports(t){return this._predicate(t)}stack(t){var e;return!!((null===(e=this._item.get())||void 0===e?void 0:e.same(t))&&this._count.get()<this._maxInStack)&&(this._count.update(t=>t+1),!0)}clear(){this._item.get()&&(this._item.set(null),this._count.set(0))}set(t,e=1){return!(this._item.get()||!this._predicate(t))&&(this._item.set(t),this._count.set(e),!0)}decrease(){this._count.update(t=>Math.max(0,t-1)),this._count.get()<=0&&(this._item.set(null),this._count.set(0))}get isEmpty(){return null==this._item.get()}use(){const t=this._item.get();return!!t&&(t.use(this,this.character),!0)}equip(){const t=this._item.get(),e=this.character.inventory.equipment.weapon;if(t&&e.supports(t)){const i=e.item.get();e.clear(),e.set(t),this.clear(),i&&this.set(i)}}toBelt(){const t=this._item.get();for(;t&&!this.isEmpty&&this.character.inventory.belt.add(t);)this.decrease()}toBackpack(){const t=this._item.get();for(;t&&!this.isEmpty&&this.character.inventory.backpack.add(t);)this.decrease()}drop(){const t=this._item.get(),e=this._count.get();t&&(this._item.set(null),this._count.set(0),this._drop.send([t,e]))}}class u{constructor(t){this.inventory=t}handleActions(t,e){t.removeButtons(),e&&this.buttons(t,e)}}class p extends u{constructor(t){super(t)}basicButtons(t,e){const i=t.cell;(i.parent instanceof l||i.parent instanceof c)&&(this.inventory.equipment.weapon.supports(e)?t.addButton("Equip",()=>i.equip()):t.addButton("Use item",()=>i.use())),i.parent instanceof l||t.addButton("To belt",()=>i.toBelt()),i.parent instanceof c||t.addButton("To backpack",()=>i.toBackpack()),t.addButton("Drop",()=>i.drop())}}class g extends p{constructor(t){super(t)}buttons(t,e){this.basicButtons(t,e)}handleInfo(t){const e=t.info();return e.price=e.sellPrice,e}}class f extends p{constructor(t,e){super(t.inventory),this.hero=t,this.npc=e}buttons(t,e){this.basicButtons(t,e),this.sellingButtons(t,e)}sellingButtons(t,e){const i=e.info().sellPrice;void 0!==i&&this.npc.coins.get()>=i&&this.npc.inventory.backpack.hasSpace(e)?t.addButton("Sell",()=>{this.npc.coins.get()>=i&&this.npc.inventory.backpack.hasSpace(e)?(this.npc.decreaseCoins(i),this.npc.inventory.backpack.add(e),this.hero.addCoins(i),t.cell.decrease()):console.warn("failed sell item")}):console.warn(`price: ${i} npc coins: ${this.npc.coins.get()}`)}handleInfo(t){const e=t.info();return e.price=e.sellPrice,e}}class m extends u{constructor(t,e){super(e.inventory),this.hero=t,this.npc=e}buttons(t,e){t.cell.parent instanceof c&&this.buyingButtons(t,e)}buyingButtons(t,e){const i=e.info().buyPrice;void 0!==i&&this.hero.coins.get()>=i&&this.hero.inventory.hasSpace(e)?t.addButton("Buy",()=>{this.npc.coins.get()>=i&&this.hero.inventory.hasSpace(e)?(this.hero.decreaseCoins(i),this.hero.inventory.backpack.add(e),this.npc.addCoins(i),t.cell.decrease()):console.warn("failed buy item")}):console.warn(`price: ${i} hero coins: ${this.hero.coins.get()}`)}handleInfo(t){const e=t.info();return e.price=e.buyPrice,e}}class w extends r.Container{constructor(t,e,i,s){super(),this.selectable=i,this.selectableOffset=s;const n=e.inventory,r=new o.c;this.equipment=new _(t,n.equipment),this.equipment.position.set(r.x,r.y),this.equipment.calculateBounds(),r.offset(0,this.equipment.height),r.offset(0,o.e.uiMargin),i.set(s,0,this.equipment.weapon,()=>this.show(n.equipment.weapon)),i.merge(s,0,10,1),this.belt=new y(t,n.belt),this.belt.position.set(r.x,r.y),this.belt.calculateBounds(),r.offset(0,this.belt.height),r.offset(0,o.e.uiMargin);for(let t=0;t<this.belt.length;t++){const e=n.belt.cell(t);this.selectable.set(s+t,1,this.belt.cell(t),()=>this.show(e))}this.backpack=new b(t,n.backpack),this.backpack.position.set(r.x,r.y),this.backpack.calculateBounds(),r.offset(0,this.backpack.height),r.offset(0,o.e.uiMargin);for(let t=0;t<n.backpack.width;t++)for(let e=0;e<n.backpack.height;e++){const i=n.backpack.cell(t,e);this.selectable.set(s+t,e+2,this.backpack.cell(t,e),()=>this.show(i))}this.actions=new x(this.selectable,this.selectableOffset,e),this.actions.position.set(r.x,r.y),r.offset(0,32),r.offset(0,o.e.uiMargin),r.offset(0,32);const h=r.y;r.reset(),r.offset(this.backpack.width,0),r.offset(o.e.uiMargin,0),this.card=new S(t,e,{width:400,height:h}),this.card.position.set(r.x,r.y),this.card.calculateBounds(),this.addChild(this.equipment,this.belt,this.backpack,this.card,this.actions)}destroy(){super.destroy(),this.equipment.destroy(),this.belt.destroy(),this.backpack.destroy(),this.card.destroy()}show(t){this.card.publisher=t.item,this.actions.cell=t}}class _ extends r.Container{constructor(t,e){super(),this.equipment=e;const i=(new r.Graphics).beginFill(o.b.uiBackground,.3).drawRect(0,0,32+(o.e.uiBorder<<1),32+(o.e.uiBorder<<1)).endFill();super.addChild(i),this.weapon=new O(t,{item:this.equipment.weapon.item,count:new n.b(null)}),this.weapon.position.set(o.e.uiBorder,o.e.uiBorder),super.addChild(this.weapon)}}class y extends r.Container{constructor(t,e){super(),this.inventory=e;const i=(new r.Graphics).beginFill(o.b.uiBackground,.3).drawRect(0,0,o.e.uiBorder+(32+o.e.uiBorder)*e.length,32+(o.e.uiBorder<<1)).endFill();super.addChild(i),this.cells=[];for(let i=0;i<e.length;i++){const s=e.cell(i),n=new O(t,{item:s.item,count:s.count});n.position.set(o.e.uiBorder+(32+o.e.uiBorder)*i,o.e.uiBorder),this.cells.push(n),super.addChild(n)}}get length(){return this.inventory.length}cell(t){return this.cells[t]}}class b extends r.Container{constructor(t,e){super();const i=(new r.Graphics).beginFill(o.b.uiBackground,.3).drawRect(0,0,o.e.uiBorder+(32+o.e.uiBorder)*e.width,o.e.uiBorder+(32+o.e.uiBorder)*e.height).endFill();super.addChild(i),this.cells=[];for(let i=0;i<e.height;i++){this.cells.push([]);for(let s=0;s<e.width;s++){const n=e.cell(s,i),r=new O(t,{item:n.item,count:n.count});r.position.set(o.e.uiBorder+(32+o.e.uiBorder)*s,o.e.uiBorder+(32+o.e.uiBorder)*i),this.cells[i][s]=r,super.addChild(r)}}}cell(t,e){return this.cells[e][t]}}class O extends r.Container{constructor(t,e){super(),this.sprite=null,this._selected=!1,this._item=e.item,this._count=e.count,this._alpha=e.alpha||.3,this.resources=t,this.background=new r.Graphics,this.selected=!1,this.counter=new r.BitmapText("0",{font:{name:"alagard",size:16}}),this.counter.anchor=new r.Point(1,0),this.counter.position.set(32-o.e.uiBorder,0),super.addChild(this.background,this.counter),this._item.subscribe(this.updateItem,this),this._count.subscribe(this.updateCounter,this)}destroy(){super.destroy(),this._item.unsubscribe(this.updateItem,this),this._count.unsubscribe(this.updateCounter,this)}get selected(){return this._selected}set selected(t){this._selected=t,this.background.clear().beginFill(t?o.b.uiSelected:o.b.uiNotSelected,this._alpha).drawRect(0,0,32,32).endFill()}updateCounter(t){this.counter.text=null===t||0===t?"":t.toString()}updateItem(t){var e;if(null===(e=this.sprite)||void 0===e||e.destroy(),this.sprite=null,t){this.sprite=this.resources.sprite(t.spriteName);const e=(32-(o.e.uiBorder<<1))/Math.max(this.sprite.width,this.sprite.height);this.sprite.scale.set(e,e),this.sprite.anchor.set(.5,0),this.sprite.position.set(16,o.e.uiBorder),super.addChild(this.sprite)}}}class S extends r.Container{constructor(t,e,i){super(),this._sprite=null,this._publisher=null,this.resources=t,this.controller=e,this._width=i.width||400,this._height=i.height||400,this._sprite_size=128+(o.e.uiMargin<<1);const s=(new r.Graphics).beginFill(o.b.uiBackground,.3).drawRect(0,0,this._width,this._height).endFill().beginFill(o.b.uiNotSelected,.3).drawRect(o.e.uiMargin,o.e.uiMargin+32+o.e.uiMargin,this._sprite_size,this._sprite_size).endFill();this._title=new r.BitmapText("",{font:{name:"alagard",size:32}}),this._title.anchor=new r.Point(.5,0),this._title.position.set(this._width>>1,o.e.uiMargin),this._description=new r.BitmapText("",{font:{name:"alagard",size:16}}),this._description.position.set(o.e.uiMargin+this._sprite_size+o.e.uiMargin,o.e.uiMargin+32+o.e.uiMargin),super.addChild(s,this._title,this._description)}destroy(){var t;super.destroy(),null===(t=this._publisher)||void 0===t||t.unsubscribe(this.handle,this),this._publisher=null}set publisher(t){var e;null===(e=this._publisher)||void 0===e||e.unsubscribe(this.handle,this),this._publisher=null,this._publisher=t,this._publisher.subscribe(this.handle,this)}handle(t){var e;if(null===(e=this._sprite)||void 0===e||e.destroy(),this._sprite=null,this._title.text="",this._description.text="",t){const e=this._sprite=this.resources.sprite(t.spriteName);e.anchor=new r.Point(.5,.5),e.position.set(o.e.uiMargin+(this._sprite_size>>1),o.e.uiMargin+(this._sprite_size>>1)+32+o.e.uiMargin);const i=e.width,s=e.height,n=this._sprite_size-o.e.uiMargin;i>s?(this._sprite.width=n,this._sprite.height=n/i*s):(this._sprite.height=n,this._sprite.width=n/s*i),this.addChild(this._sprite);const h=this.controller.handleInfo(t);this._title.text=h.name;const a=[];h.health&&a.push("health: "+h.health),h.speed&&a.push(`speed: ${100*h.speed}%`),h.distance&&a.push("distance: "+h.distance),h.damage&&a.push("damage: "+h.damage),h.price&&a.push(`price: ${h.price}$`),this._description.text=a.join("\n")}}}class x extends r.Container{constructor(t,e,i){super(),this.buttons=[],this._cell=null,this.selectable=t,this.selectableOffset=e,this.controller=i}destroy(){var t;super.destroy(),null===(t=this._cell)||void 0===t||t.item.unsubscribe(this.handle,this),this._cell=null,this.removeButtons()}set cell(t){var e;null===(e=this._cell)||void 0===e||e.item.unsubscribe(this.handle,this),this.removeButtons(),this._cell=t,this._cell.item.subscribe(this.handle,this)}get cell(){return this._cell}handle(t){this.controller.handleActions(this,t)}removeButtons(){for(let[t,e,i]of this.buttons)this.selectable.unmerge(e,i),this.selectable.remove(e,i),t.destroy();this.selectable.reset(),this.buttons.splice(0,this.buttons.length)}addButton(t,e){const i=this.buttons.length,s=i>>1,n=i%2,r=this.selectableOffset+5*n,h=10+s,a=new o.a({label:t,width:170,height:32});a.position.set(n*(170+o.e.uiMargin),s*(32+o.e.uiMargin)),this.buttons.push([a,r,h]),this.selectable.set(r,h,a,e),this.selectable.merge(r,h,5,1),this.addChild(a)}}},function(t,e,i){"use strict";(function(t){i.d(e,"a",(function(){return o}));var s=i(1),n=i(4);class o{constructor(t,e){this.container=null,this.background=null,this.selectable=null,this.inventoryView=null,this.controller=t,this.actionsController=e}init(){this.background=new t.Graphics,this.selectable=new s.d(this.controller.joystick),this.inventoryView=new n.e(this.controller.resources,this.actionsController,this.selectable,0),this.inventoryView.position.set(s.e.uiMargin,s.e.uiMargin),this.inventoryView.calculateBounds(),this.inventoryView.zIndex=1;const e=this.inventoryView.width+(s.e.uiMargin<<1),i=this.inventoryView.height+(s.e.uiMargin<<1);this.background.beginFill(0).drawRect(0,0,e,i).endFill(),this.background.zIndex=0,this.container=new t.Container,this.container.addChild(this.background,this.inventoryView),this.container.sortChildren(),this.container.position.set((this.controller.app.screen.width>>1)-(e>>1),(this.controller.app.screen.height>>1)-(i>>1)),this.controller.stage.addChild(this.container),this.controller.app.ticker.add(this.handleInput,this)}destroy(){var t,e,i;this.controller.app.ticker.remove(this.handleInput,this),null===(t=this.container)||void 0===t||t.destroy(),this.container=null,null===(e=this.background)||void 0===e||e.destroy(),this.background=null,null===(i=this.inventoryView)||void 0===i||i.destroy(),this.inventoryView=null,this.selectable=null}handleInput(){var t;this.controller.joystick.inventory.once()?this.controller.closeModal():null===(t=this.selectable)||void 0===t||t.handleInput()}}}).call(this,i(0))},function(t,e,i){"use strict";i.d(e,"a",(function(){return o}));var s=i(0),n=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{a(s.next(t))}catch(t){o(t)}}function h(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,h)}a((s=s.apply(t,e||[])).next())}))};class o{constructor(t){this._sprites={},this._animations={},this.loader=t}load(){return n(this,void 0,void 0,(function*(){return yield new Promise(t=>{this.loader.add("npc.json").add("dungeon.json").add("bonfire.json").add("dungeon.rules.json").add("dungeon.rules.4.json").add("dungeon.design.json").add("dialogs.json").add("alagard","fonts/alagard.fnt").add("big_egg_collect","sounds/big_egg_collect.{ogg,mp3}").add("fruit_collect","sounds/fruit_collect.{ogg,mp3}").add("select","sounds/select.{ogg,mp3}").add("confirm","sounds/confirm.{ogg,mp3}").add("cancel","sounds/cancel.{ogg,mp3}").add("text","sounds/text.{ogg,mp3}").add("boss_hit","sounds/boss_hit.{ogg,mp3}").add("hit_damage","sounds/hit_damage.{ogg,mp3}").load((e,i)=>{i["fonts/alagard.png"].texture.baseTexture.scaleMode=s.SCALE_MODES.NEAREST,this.add(i["npc.json"].spritesheet),this.add(i["dungeon.json"].spritesheet),this.add(i["bonfire.json"].spritesheet),t()})})}))}add(t){t.baseTexture.scaleMode=s.SCALE_MODES.NEAREST;for(let e of Object.keys(t.textures))this._sprites[e]=t.textures[e];for(let e of Object.keys(t.animations))this._animations[e]=t.animations[e]}sprite(t,e={}){if(this._sprites[t])return this.fixed(t);if(this._animations[t])return this.animated(t,e);throw"sprite or animation not found: "+t}fixed(t){if(!this._sprites[t])throw"sprite not found: "+t;const e=new s.Sprite(this._sprites[t]);return e.name=t,e}animated(t,e={}){if(!this._animations[t])throw"animation not found: "+t;const i=new s.AnimatedSprite(this._animations[t]);return i.name=t,i.autoUpdate=void 0===e.autoUpdate||e.autoUpdate,i.animationSpeed=void 0!==e.animationSpeed?e.animationSpeed:.2,i.loop=void 0===e.loop||e.loop,(void 0===e.play||e.play)&&i.play(),i}}},function(t,e,i){"use strict";i.d(e,"a",(function(){return Se}));const s=2.3283064365386963e-10;class n{constructor(t){if(t<=1)throw"Illegal seed number";return this._s0=(t>>>0)*s,t=69069*t+1>>>0,this._s1=t*s,t=69069*t+1>>>0,this._s2=t*s,this._c=1,this}static create(){const t=crypto.getRandomValues(new Uint32Array(1))[0];return console.log("SRG generated seed: "+t),new n(t)}static seeded(t){return new n(t)}float(){let t=2091639*this._s0+this._c*s;return this._s0=this._s1,this._s1=this._s2,this._c=0|t,this._s2=t-this._c,this._s2}int(){return 4294967296*this.float()}boolean(){return this.float()<.5}range(t,e){return Math.floor(this.float()*(e-t))+t}normal(t=0,e=1){let i,s,n;do{i=2*this.float()-1,s=2*this.float()-1,n=i*i+s*s}while(n>1||0==n);return t+i*Math.sqrt(-2*Math.log(n)/n)*e}skewNormal(t,e,i){let s=0,n=0;for(;0===s;)s=this.float();for(;0===n;)n=this.float();let o=Math.sqrt(-2*Math.log(s))*Math.cos(2*Math.PI*n);return o=o/10+.5,(o>1||o<0)&&(o=this.skewNormal(t,e,i)),o=Math.pow(o,i),o*=e-t,o+=t,o}select(t){return 0===t.length?null:t[Math.floor(this.float()*t.length)]}}var o;!function(t){t[t.Await=1]="Await",t[t.Pressed=2]="Pressed"}(o||(o={}));class r{constructor(t){this.code=t,this.state=o.Await,this._triggered=!1,this._processed=!0}get triggered(){return this._triggered}once(){return!this._processed&&(this._processed=!0,!0)}keydown(t){t.code===this.code&&(t.preventDefault(),this.state===o.Await&&(this._triggered=!0,this._processed=!1,this.state=o.Pressed))}keyup(t){t.code===this.code&&(t.preventDefault(),this.state===o.Pressed&&(this._triggered=!1,this.state=o.Await))}reset(){this._triggered=!1,this._processed=!0}}class h{constructor(){this.moveUp=new r("KeyW"),this.moveLeft=new r("KeyA"),this.moveDown=new r("KeyS"),this.moveRight=new r("KeyD"),this.hit=new r("KeyF"),this.drop=new r("KeyQ"),this.inventory=new r("KeyI"),this.digit1=new r("Digit1"),this.digit2=new r("Digit2"),this.digit3=new r("Digit3"),this.digit4=new r("Digit4"),this.digit5=new r("Digit5"),this.digit6=new r("Digit6"),this.digit7=new r("Digit7"),this.digit8=new r("Digit8"),this.digit9=new r("Digit9"),this.digit0=new r("Digit0"),this.bindings={};for(const t of Object.getOwnPropertyNames(this)){const e=this[t];e&&e instanceof r&&(this.bindings[e.code]=e)}window.addEventListener("keydown",this.keydown.bind(this)),window.addEventListener("keyup",this.keyup.bind(this))}digit(t){switch(t){case 1:return this.digit1;case 2:return this.digit2;case 3:return this.digit3;case 4:return this.digit4;case 5:return this.digit5;case 6:return this.digit6;case 7:return this.digit7;case 8:return this.digit8;case 9:return this.digit9;case 0:return this.digit0}}reset(){var t;for(const e of Object.getOwnPropertyNames(this.bindings))null===(t=this.bindings[e])||void 0===t||t.reset()}keydown(t){var e;null===(e=this.bindings[t.code])||void 0===e||e.keydown(t)}keyup(t){var e;null===(e=this.bindings[t.code])||void 0===e||e.keyup(t)}}var a=i(0);class l{constructor(t){this.controller=t}init(){this.renderTitle(),this.renderHelp(),this.controller.app.ticker.add(this.handleInput,this)}destroy(){this.controller.app.ticker.remove(this.handleInput,this),this.controller.stage.removeChildren()}pause(){}resume(){}renderTitle(){let t=new a.BitmapText("ROGUELIKE DUNGEON",{font:{name:"alagard",size:64}});t.anchor=new a.Point(.5,0),t.position.set(this.controller.app.screen.width>>1,64),this.controller.stage.addChild(t);let e=new a.BitmapText("YOU DEAD",{font:{name:"alagard",size:128},tint:16711680});e.anchor=.5,e.position.set(this.controller.app.screen.width>>1,256),this.controller.stage.addChild(e)}renderHelp(){const t=new a.BitmapText("PRESS F TO RESTART",{font:{name:"alagard",size:32}});t.anchor=.5,t.position.set(this.controller.app.screen.width>>1,this.controller.app.screen.height-64),this.controller.stage.addChild(t)}handleInput(){this.controller.joystick.hit.once()&&this.controller.selectHero()}}var c=i(2);class d{constructor(t,e){this.begin=!1,this.angle=0,this.point=t,this.segment=e}}var u;!function(t){t[t.NORMAL=0]="NORMAL",t[t.TOP=1]="TOP"}(u||(u={}));class p{constructor(t,e,i){this.distance=0,this.p1=new d(t,this),this.p2=new d(e,this),this.type=i}toString(){const t=this.p1.point,e=this.p2.point;return`[${t.x}:${t.y} - ${e.x}:${e.y}]`}}class g{constructor(){this.segments=[],this.endpoints=[],this.light=new a.Point(0,0),this.maxDistance=500}init(){this.segments=[],this.endpoints=[],this.light=new a.Point(0,0)}addSegment(t,e,i,s,n){const o=new a.Point(t,e),r=new a.Point(i,s),h=new p(o,r,n);this.segments.push(h),this.endpoints.push(h.p1),this.endpoints.push(h.p2)}static deduplicated(t){const e=[];for(;t.length>0;){const i=t.pop(),s=[];for(let e=0;e<t.length;e++){let n=t[e],o=i.type===n.type,r=i.p1.point.equals(n.p1.point)&&i.p2.point.equals(n.p2.point);o&&r&&s.push(e)}for(let e of s)t.splice(e,1);e.push(i)}return e}static connected(t){const e=[];for(let i=0;i<t.length;i++){let s=t[i],n=!1,o=!1;for(let r=0;r<t.length;r++){if(r==i)continue;let h=t[r];if((!s.p1.point.equals(h.p1.point)||!s.p2.point.equals(h.p2.point))&&(n||!s.p1.point.equals(h.p1.point)&&!s.p1.point.equals(h.p2.point)||(n=!0),o||!s.p2.point.equals(h.p1.point)&&!s.p2.point.equals(h.p2.point)||(o=!0),n&&o)){e.push(s);break}}}return e}static filtered(t){const e=[],i=[],s=[[0,12,0,16],[5,12,5,16],[0,12,5,12],[0,0,5,0],[11,12,11,16],[11,12,16,12],[11,0,16,0]],n=t=>{const e=t.p1.point.x%16,i=t.p1.point.y%16,n=t.p2.point.x-t.p1.point.x+e,o=t.p2.point.y-t.p1.point.y+i;for(let[t,r,h,a]of s)if(t===e&&r===i&&h===n&&a===o)return!0;return!1};for(const s of t)n(s)?i.push(s):e.push(s);for(;i.length>0;){const t=i.pop(),s=[t],n=[t.p1.point,t.p2.point],o=[1,1],r=[];for(let t=0;t<2;t++)for(let t=0;t<i.length;t++){if(r.indexOf(t)>=0)continue;let e=i[t];const h=e.p1.point,a=e.p2.point;let l=!1,c=!1;for(let t=0;t<n.length;t++){let e=n[t];e.equals(h)?(l=!0,o[t]++):e.equals(a)&&(c=!0,o[t]++)}(l||c)&&(r.push(t),s.push(e),l||(n.push(h),o.push(1)),c||(n.push(a),o.push(1)))}if(4===o.length&&o.every(t=>2===t)){let t=0,n=0;for(let e=0;e<4;e++){let i=s[e];i.p1.point.y===i.p2.point.y&&i.p1.point.y>n&&(t=e,n=i.p1.point.y)}for(let t of r.reverse())i.splice(t,1);s.splice(t,1),e.push(...s)}else e.push(t)}return e}static merge(t){const e=[];for(;t.length>0;){const i=t.pop();let s=null;for(let e=0;e<t.length;e++){let n=t[e];if(i.type===n.type){if(i.p2.point.equals(n.p1.point)){t.splice(e,1),s=[i,n];break}if(n.p2.point.equals(i.p1.point)){t.splice(e,1),s=[n,i];break}}}if(s){const[e,i]=s;t.push(new p(e.p1.point,i.p2.point,e.type))}else e.push(i)}return e}optimize(){console.log("optimize: segments="+this.segments.length);const t=g.deduplicated([...this.segments]);console.log("optimize: deduplicated="+t.length);const e=g.connected(t);console.log("optimize: connected="+e.length);const i=g.filtered(e);console.log("optimize: filtered="+i.length);const s=g.connected(i);console.log("optimize: connected = "+s.length);const n=[...g.merge(s.filter(t=>t.p1.point.x===t.p2.point.x)),...g.merge(s.filter(t=>t.p1.point.y===t.p2.point.y))];console.log("optimize: merged="+n.length),this.segments=[],this.endpoints=[];for(const t of n)this.segments.push(t),this.endpoints.push(t.p1),this.endpoints.push(t.p2)}setLightLocation(t,e,i){this.light.x=t,this.light.y=e,this.maxDistance=i,this.endpoints=[];for(const s of this.segments){let n=.5*(s.p1.point.x+s.p2.point.x)-t,o=.5*(s.p1.point.y+s.p2.point.y)-e;if(s.distance=Math.sqrt(n*n+o*o),s.distance<i){s.p1.angle=Math.atan2(s.p1.point.y-e,s.p1.point.x-t),s.p2.angle=Math.atan2(s.p2.point.y-e,s.p2.point.x-t);let i=s.p2.angle-s.p1.angle;i<=-Math.PI&&(i+=2*Math.PI),i>Math.PI&&(i-=2*Math.PI),s.p1.begin=i>0,s.p2.begin=!s.p1.begin,this.endpoints.push(s.p1,s.p2)}}this.endpoints.sort(g.compare)}static compare(t,e){return t.angle>e.angle?1:t.angle<e.angle?-1:!t.begin&&e.begin?1:t.begin&&!e.begin?-1:0}static leftOf(t,e){return(t.p2.point.x-t.p1.point.x)*(e.y-t.p1.point.y)-(t.p2.point.y-t.p1.point.y)*(e.x-t.p1.point.x)<0}static interpolate(t,e,i){return new a.Point(t.x*(1-i)+e.x*i,t.y*(1-i)+e.y*i)}static segmentInFrontOf(t,e,i){const s=g.leftOf(t,g.interpolate(e.p1.point,e.p2.point,.01)),n=g.leftOf(t,g.interpolate(e.p2.point,e.p1.point,.01)),o=g.leftOf(t,i),r=g.leftOf(e,g.interpolate(t.p1.point,t.p2.point,.01)),h=g.leftOf(e,g.interpolate(t.p2.point,t.p1.point,.01)),a=g.leftOf(e,i);return r==h&&h!=a||s==n&&n==o}sweep(){const t=[],e=[];let i=0;for(let s=0;s<=2;s++)for(const n of this.endpoints){let o=0===e.length?null:e[0];if(n.begin){let t=0,i=e[t];for(;null!=i&&g.segmentInFrontOf(n.segment,i,this.light);)t++,i=e[t];null==i?e.push(n.segment):e.splice(t,0,n.segment)}else for(let t=0;t<e.length;t++)e[t]===n.segment&&e.splice(t,1);o!==(0===e.length?null:e[0])&&(1==s&&this.addTriangle(i,n.angle,o,t),i=n.angle)}const s=[...t],n=[];for(;s.length>0;){if(s.length>=2){const[t,e]=s;if(t.equals(e)){s.shift();continue}}const t=s.shift();n.push(t)}const o=[];for(;n.length>0;){if(n.length>=3){const[t,e,i]=n;if(t.x===e.x&&t.x===i.x){n.splice(1,1);continue}}const t=n.shift();o.push(t)}return o}static lineIntersection(t,e,i,s){const n=(s.x-i.x)*(t.y-i.y)-(s.y-i.y)*(t.x-i.x),o=(s.y-i.y)*(e.x-t.x)-(s.x-i.x)*(e.y-t.y);if(0===o)return null;const r=n/o;return new a.Point(t.x+r*(e.x-t.x),t.y+r*(e.y-t.y))}addTriangle(t,e,i,s){const n=Math.cos(t),o=Math.sin(t),r=Math.cos(e),h=Math.sin(e);let l=this.light,c=new a.Point(this.light.x+n,this.light.y+o),d=new a.Point(0,0),p=new a.Point(0,0);null!=i?(d.x=i.p1.point.x,d.y=i.p1.point.y,p.x=i.p2.point.x,p.y=i.p2.point.y):(d.x=this.light.x+n*this.maxDistance,d.y=this.light.y+o*this.maxDistance,p.x=this.light.x+r*this.maxDistance,p.y=this.light.y+h*this.maxDistance);let f=g.lineIntersection(d,p,l,c);if(null===f)return;f.x=Math.round(f.x),f.y=Math.round(f.y),c.x=this.light.x+r,c.y=this.light.y+h;let m=g.lineIntersection(d,p,l,c);if(null!==m)if(m.x=Math.round(m.x),m.y=Math.round(m.y),null!=i)switch(i.type){case u.TOP:s.push(f),s.push(new a.Point(f.x,f.y-16)),s.push(new a.Point(m.x,m.y-16)),s.push(m);break;case u.NORMAL:s.push(f),s.push(m)}else s.push(f),s.push(m)}debug(){const t=document.createElement("canvas");t.width=1280,t.height=1280;const e=t.getContext("2d");e.fillRect(0,0,1280,1280),e.scale(1,1);const i=new Path2D;for(let t of this.segments){const e=t.p1.point,s=t.p2.point;i.moveTo(e.x,e.y),i.lineTo(s.x,s.y)}e.strokeStyle="rgba(255,0,0,0.5)",e.stroke(i),console.log("%c ",`\n      font-size: 1px;\n      padding: ${t.height/2}px ${t.width/2}px;\n      background: no-repeat url(${t.toDataURL("image/png")});\n      background-size: ${t.width}px ${t.height}px;\n    `)}}class f{constructor(t){this.lights=[],this.wall_top={default:[{x1:0,y1:12,x2:16,y2:12,type:u.NORMAL},{x1:0,y1:12,x2:0,y2:16,type:u.NORMAL},{x1:16,y1:12,x2:16,y2:16,type:u.NORMAL}],top:[{x1:0,y1:0,x2:16,y2:0,type:u.TOP}],left:[{x1:0,y1:0,x2:0,y2:12,type:u.NORMAL}],right:[{x1:16,y1:0,x2:16,y2:12,type:u.NORMAL}],bottom:[]},this.wall_side_left={default:[{x1:11,y1:0,x2:11,y2:16,type:u.NORMAL},{x1:11,y1:0,x2:16,y2:0,type:u.NORMAL},{x1:11,y1:16,x2:16,y2:16,type:u.TOP}],top:[{x1:0,y1:0,x2:11,y2:0,type:u.TOP}],left:[{x1:0,y1:0,x2:0,y2:16,type:u.NORMAL}],right:[],bottom:[{x1:0,y1:16,x2:11,y2:16,type:u.NORMAL}]},this.wall_side_right={default:[{x1:5,y1:0,x2:5,y2:16,type:u.NORMAL},{x1:0,y1:0,x2:5,y2:0,type:u.NORMAL},{x1:0,y1:16,x2:5,y2:16,type:u.TOP}],top:[{x1:5,y1:0,x2:16,y2:0,type:u.TOP}],left:[],right:[{x1:16,y1:0,x2:16,y2:16,type:u.NORMAL}],bottom:[{x1:5,y1:16,x2:16,y2:16,type:u.NORMAL}]},this.wall_corner_left={default:[{x1:5,y1:0,x2:5,y2:12,type:u.NORMAL},{x1:5,y1:12,x2:16,y2:12,type:u.NORMAL},{x1:16,y1:12,x2:16,y2:16,type:u.NORMAL}],top:[{x1:5,y1:0,x2:16,y2:0,type:u.TOP}],left:[],right:[{x1:16,y1:0,x2:16,y2:12,type:u.NORMAL}],bottom:[]},this.wall_corner_right={default:[{x1:11,y1:0,x2:11,y2:12,type:u.NORMAL},{x1:0,y1:12,x2:11,y2:12,type:u.NORMAL},{x1:0,y1:12,x2:0,y2:16,type:u.NORMAL}],top:[{x1:0,y1:0,x2:11,y2:0,type:u.TOP}],left:[{x1:0,y1:0,x2:0,y2:12,type:u.NORMAL}],right:[],bottom:[]},this.wall_default={default:[],top:[{x1:0,y1:0,x2:16,y2:0,type:u.TOP}],left:[{x1:0,y1:0,x2:0,y2:16,type:u.NORMAL}],right:[{x1:16,y1:0,x2:16,y2:16,type:u.NORMAL}],bottom:[{x1:0,y1:16,x2:16,y2:16,type:u.NORMAL}]},this.config={"wall_top_mid.png":this.wall_top,"wall_side_front_left.png":this.wall_side_left,"wall_side_front_right.png":this.wall_side_right,"wall_side_mid_left.png":this.wall_side_left,"wall_side_mid_right.png":this.wall_side_right,"wall_side_top_left.png":{default:[{x1:11,y1:12,x2:16,y2:12,type:u.NORMAL},{x1:11,y1:12,x2:11,y2:16,type:u.NORMAL}],top:[{x1:0,y1:0,x2:16,y2:0,type:u.TOP}],left:[{x1:0,y1:0,x2:0,y2:16,type:u.NORMAL}],right:[{x1:16,y1:0,x2:16,y2:12,type:u.NORMAL}],bottom:[{x1:0,y1:16,x2:11,y2:16,type:u.NORMAL}]},"wall_side_top_right.png":{default:[{x1:0,y1:12,x2:5,y2:12,type:u.NORMAL},{x1:5,y1:12,x2:5,y2:16,type:u.NORMAL}],top:[{x1:0,y1:0,x2:16,y2:0,type:u.TOP}],left:[{x1:0,y1:12,x2:0,y2:16,type:u.NORMAL}],right:[{x1:16,y1:0,x2:16,y2:16,type:u.NORMAL}],bottom:[{x1:5,y1:16,x2:16,y2:16,type:u.NORMAL}]},"wall_inner_corner_t_top_left.png":this.wall_top,"wall_inner_corner_t_top_right.png":this.wall_top,"wall_inner_corner_l_top_left.png":this.wall_corner_left,"wall_inner_corner_l_top_right.png":this.wall_corner_right,"wall_corner_bottom_left.png":this.wall_corner_left,"wall_corner_bottom_right.png":this.wall_corner_right,"wall_corner_top_left.png":this.wall_top,"wall_corner_top_right.png":this.wall_top,"wall_fountain_top.png":{default:[{x1:0,y1:12,x2:0,y2:16,type:u.NORMAL},{x1:0,y1:12,x2:2,y2:12,type:u.NORMAL},{x1:2,y1:9,x2:2,y2:12,type:u.NORMAL},{x1:2,y1:9,x2:14,y2:9,type:u.NORMAL},{x1:14,y1:9,x2:14,y2:12,type:u.NORMAL},{x1:14,y1:12,x2:16,y2:12,type:u.NORMAL},{x1:16,y1:12,x2:16,y2:16,type:u.NORMAL}],top:[{x1:0,y1:0,x2:16,y2:0,type:u.TOP}],left:[{x1:0,y1:0,x2:0,y2:12,type:u.NORMAL}],right:[{x1:16,y1:0,x2:16,y2:12,type:u.NORMAL}],bottom:[]},"wall_one_top.png":this.wall_top,"wall_one_corner_left.png":this.wall_corner_left,"wall_one_corner_right.png":this.wall_corner_right},this.dungeon=t,this.layer=new a.display.Layer,this.layer.useRenderTexture=!0,this.layer.on("display",t=>{t.blendMode=a.BLEND_MODES.MULTIPLY}),this.layer.clearColor=[0,0,0,1],this.container=new a.Container,this.layer.addChild(this.container),this.heroLightTexture=f.gradient("white",150),this.fountainRedTexture=f.gradient("rgb(211,78,56)",50),this.fountainBlueTexture=f.gradient("rgb(86,152,204)",50),this.bonfireTexture=f.gradient("rgb(255,239,204)",100),this.shadowCaster=new g,this.dungeon.ticker.add(this.update,this)}destroy(){this.dungeon.ticker.remove(this.update,this),this.lights.forEach(t=>t.destroy()),this.heroLightTexture.destroy(),this.fountainBlueTexture.destroy(),this.fountainRedTexture.destroy(),this.bonfireTexture.destroy(),this.container.destroy(),this.layer.destroy()}loadMap(){this.shadowCaster.init();const t=this.dungeon;for(let e=0;e<t.height;e++)for(let i=0;i<t.width;i++){const s=t.cell(i,e);if(s.hasFloor){const n=new a.Point(16*i,16*e);switch(s.floorName){case"wall_fountain_basin_red":this.addLight(n,m.RED_BASIN);break;case"wall_fountain_basin_blue":this.addLight(n,m.BLUE_BASIN)}const o=e>0&&t.cell(i,e-1).hasFloor,r=e+1<t.height&&t.cell(i,e+1).hasFloor,h=i>0&&t.cell(i-1,e).hasFloor,l=i+1<t.width&&t.cell(i+1,e).hasFloor;let c;const d=s.wallName;c=d&&this.config[d]&&this.config[d]||this.wall_default,this.add(i,e,c.default),o||this.add(i,e,c.top),r||this.add(i,e,c.bottom),h||this.add(i,e,c.left),l||this.add(i,e,c.right)}}this.shadowCaster.optimize(),this.update()}addLight(t,e){let i,s;switch(e){case m.HERO:i=this.heroLightTexture,s=350;break;case m.RED_BASIN:i=this.fountainRedTexture,s=150;break;case m.BLUE_BASIN:i=this.fountainBlueTexture,s=150;break;case m.BONFIRE:i=this.bonfireTexture,s=250}const n=new w(t,s,i,this.container);this.lights.push(n),this.renderLight(n)}add(t,e,i){for(let s of i)this.shadowCaster.addSegment(16*t+s.x1,16*e+s.y1,16*t+s.x2,16*e+s.y2,s.type)}update(){for(const t of this.lights)t.dirty&&(this.renderLight(t),t.rendered())}renderLight(t){const e=new a.Point(t.position.x+8,t.position.y+8);this.shadowCaster.setLightLocation(e.x,e.y,t.maxDistance);const i=this.shadowCaster.sweep();t.sprite.position.set(e.x,e.y),t.mask.clear().beginFill(16777215,1).drawPolygon(i).endFill()}static gradient(t,e){const i=e<<1,s=document.createElement("canvas");s.width=i,s.height=i;const n=s.getContext("2d");if(n){const s=n.createRadialGradient(e,e,0,e,e,e);s.addColorStop(.1,t),s.addColorStop(1,"transparent"),n.fillStyle=s,n.fillRect(0,0,i,i)}return a.Texture.from(s)}}var m;!function(t){t[t.HERO=0]="HERO",t[t.RED_BASIN=1]="RED_BASIN",t[t.BLUE_BASIN=2]="BLUE_BASIN",t[t.BONFIRE=3]="BONFIRE"}(m||(m={}));class w{constructor(t,e,i,s){this._rendered=null,this.position=t,this.maxDistance=e,this.mask=new a.Graphics,this.mask.isMask=!0,this.sprite=new a.Sprite(i),this.sprite.anchor.set(.5,.5),this.sprite.mask=this.mask,this.sprite.blendMode=a.BLEND_MODES.ADD,s.addChild(this.mask),s.addChild(this.sprite)}get dirty(){return null===this._rendered||this.position.x!==this._rendered.x||this.position.y!==this._rendered.y}rendered(){this._rendered={x:this.position.x,y:this.position.y}}destroy(){this.sprite.destroy(),this.mask.destroy()}}const _=60,y=70,b=50,O=40,S=1,x=100,E=256;class v{constructor(t,e,i,s,n,o,r){this.scale=2,this.controller=t,this.ticker=e,this.rng=i,this.seed=s,this.level=n,this.width=o,this.height=r,this.cells=[];for(let t=0;t<this.width;t++){this.cells[t]=[];for(let e=0;e<this.height;e++)this.cells[t][e]=new N(this,e,t)}this.container=new a.Container,this.container.zIndex=0,this.container.sortableChildren=!0,this.container.scale.set(this.scale,this.scale),this.floorContainer=new a.Container,this.floorContainer.zIndex=S,this.floorContainer.sortableChildren=!1,this.floorContainer.cacheAsBitmap=!0,this.container.addChild(this.floorContainer),this.light=new f(this),this.light.layer.zIndex=1,this.light.container.scale.set(this.scale,this.scale),this.lighting=new a.Sprite(this.light.layer.getRenderTexture()),this.lighting.blendMode=a.BLEND_MODES.MULTIPLY,this.lighting.zIndex=2}destroy(){for(let t=0;t<this.height;t++)for(let e=0;e<this.width;e++)this.cells[t][e].destroy();this.lighting.destroy(),this.light.destroy(),this.container.destroy({children:!0})}log(t){console.info(t)}cell(t,e){return this.cells[e][t]}remove(t,e,i){for(let s=0;s<i.width;s++)for(let n=0;n<i.height;n++){const o=this.cell(t+s,e-n),r=o.object;r&&r===i&&(o.object=null)}}set(t,e,i){for(let s=0;s<i.width;s++)for(let n=0;n<i.height;n++)this.cell(t+s,e-n).object=i}available(t,e,i){for(let s=0;s<i.width;s++)for(let n=0;n<i.height;n++){const o=this.cell(t+s,e-n);if(!o.hasFloor||o.collide(i))return!1}return!0}camera(t,e){const i=this.controller.app.screen.width,s=this.controller.app.screen.height,n=(i>>1)-t*this.scale,o=(s>>1)-e*this.scale;this.container.position.set(n,o),this.light.container.position.set(n,o)}sprite(t,e,i){const s=this.controller.resources.sprite(i);return s.position.set(16*t,16*e),this.container.addChild(s),s}animated(t,e,i){const s=this.controller.resources.animated(i);return s.position.set(16*t,16*e),s.play(),this.container.addChild(s),s}}class N{constructor(t,e,i){this._floor=null,this._wall=null,this._drop=null,this._object=null,this.dungeon=t,this.x=e,this.y=i}destroy(){var t,e,i,s;null===(t=this._floor)||void 0===t||t.destroy(),this._floor=null,null===(e=this._wall)||void 0===e||e.destroy(),this._wall=null,null===(i=this._drop)||void 0===i||i.destroy(),this._drop=null,null===(s=this._object)||void 0===s||s.destroy(),this._object=null}set floorName(t){var e;null===(e=this._floor)||void 0===e||e.destroy(),this._floor=null,t&&(this._floor=new M(this.dungeon,this.x,this.y,t))}get floorName(){var t;return(null===(t=this._floor)||void 0===t?void 0:t.name)||null}get floor(){return this._floor}get hasFloor(){return!!this._floor}get wallName(){var t;return(null===(t=this._wall)||void 0===t?void 0:t.name)||null}set wallName(t){var e;null===(e=this._wall)||void 0===e||e.destroy(),this._wall=null,t&&(this._wall=new D(this.dungeon,this.x,this.y,t))}get wall(){return this._wall}set dropItem(t){var e;null===(e=this._drop)||void 0===e||e.destroy(),this._drop=null,t&&(this._drop=new C(this.dungeon,this.x,this.y,t))}get drop(){return this._drop}get hasDrop(){return!!this._drop}randomDrop(){const t=this.dungeon.rng;let e=50*t.float();return(e-=10)<=0?this.dropItem=c.d.create(t,this.dungeon.level):(e-=10)<=0?this.dropItem=new c.b:(e-=10)<=0?this.dropItem=new c.c:e-20<=0&&(this.dropItem=new c.a(t)),this.hasDrop}get object(){return this._object}set object(t){if(t&&null!==this._object&&this._object!==t)throw console.log("current char",this._object),console.log("new char",t),"error while set char to cell";this._object=t}get hasObject(){return null!=this._object}ladder(){var t;null===(t=this._floor)||void 0===t||t.destroy(),this._floor=new k(this.dungeon,this.x,this.y)}get interacting(){var t,e,i,s;return(null===(t=this._floor)||void 0===t?void 0:t.interacting)||(null===(e=this._wall)||void 0===e?void 0:e.interacting)||(null===(i=this._drop)||void 0===i?void 0:i.interacting)||(null===(s=this._object)||void 0===s?void 0:s.interacting)||!1}interact(t){this._object&&this._object.interacting?this._object.interact(t):this._drop&&this._drop.interacting?this._drop.interact(t):this._wall&&this._wall.interacting?this._wall.interact(t):this._floor&&this._floor.interacting&&this._floor.interact(t)}collide(t){return this._object&&this._object.collide(t)||this._wall&&this._wall.collide(t)||!1}}class T{constructor(t,e,i,s){this.height=1,this.width=1,this.static=!0,this.dungeon=t,this.x=e,this.y=i,this.name=s,this.sprite=this.dungeon.controller.resources.sprite(s),this.sprite.zIndex=S,this.sprite.position.set(16*e,16*i),this.sprite instanceof a.AnimatedSprite?this.dungeon.container.addChild(this.sprite):this.dungeon.floorContainer.addChild(this.sprite)}collide(t){return!1}destroy(){this.sprite.destroy()}}class M extends T{constructor(t,e,i,s){super(t,e,i,s),this.interacting=!1}interact(t){}}class k extends T{constructor(t,e,i){super(t,e,i,"floor_ladder.png"),this.interacting=!0}interact(t){this.dungeon.controller.updateHero(t.character,this.dungeon.level+1)}}class D{constructor(t,e,i,s){this.height=1,this.width=1,this.static=!0,this.interacting=!1,this.dungeon=t,this.x=e,this.y=i,this.name=s,this.sprite=t.sprite(e,i,s),this.sprite.zIndex=x+i*E}interact(t){}collide(t){return!this.dungeon.cell(this.x,this.y).hasFloor}destroy(){this.sprite.destroy()}}class C{constructor(t,e,i,s){this.height=1,this.width=1,this.static=!0,this.interacting=!0,this.dungeon=t,this.x=e,this.y=i,this.drop=s,this.sprite=t.sprite(e,i,s.spriteName),this.sprite.zIndex=b+i*E,this.sprite.x+=8,this.sprite.y+=14,this.sprite.anchor.set(.5,1)}pickedUp(t){return!!this.drop.pickedUp(t)&&(this.dungeon.cell(this.x,this.y).dropItem=null,!0)}interact(t){}collide(t){return!1}destroy(){this.sprite.destroy()}}class R extends a.Container{constructor(){super(),this.title=new a.BitmapText("",{font:{name:"alagard",size:32}}),this.title.anchor=.5,this.title.position.set(0,16),this.addChild(this.title)}set level(t){this.title.text="LEVEL "+t}destroy(){this.title.destroy()}}var P,A=i(3);function L(t){let e=1;for(let i=2;i<=t;i++)e*=i;return e}class I{static basis(t,e,i){return L(e)/(L(t)*L(e-t))*Math.pow(i,t)*Math.pow(1-i,e-t)}static line(...t){const e=t.length-1;return i=>{i>1&&(i=1);let s=0;for(let n=0;n<t.length;n++){let o=I.basis(n,e,i);s+=t[n]*o}return s}}static matrix(...t){const e=t.length-1,i=t[0].length;return s=>{s>1&&(s=1);let n=[];for(let t=0;t<i;t++)n[t]=0;for(let o=0;o<t.length;o++){let r=I.basis(o,e,s);for(let e=0;e<i;e++)n[e]+=t[o][e]*r}return n}}}!function(t){t[t.Manhattan=0]="Manhattan",t[t.Euclidean=1]="Euclidean",t[t.Chebyshev=2]="Chebyshev",t[t.Octile=3]="Octile"}(P||(P={}));class W{constructor(t,e){this.g=0,this.h=0,this.f=0,this.parent=t,this.position=e}equal(t){return this.position.equals(t.position)}}class U{constructor(t,e,i=!0,s=!1,n=!1,o=P.Chebyshev,r=1){this.map=[],this.weight=1,this.width=t,this.height=e,this.diagonalAllowed=i,this.includeStart=s,this.includeEnd=n,this.heuristic=o,this.weight=r;for(let i=0;i<t;i++){const t=[];this.map.push(t);for(let i=0;i<e;i++)t.push(1)}}clear(t,e){this.map[t][e]=0}mark(t,e){this.map[t][e]=1}find(t,e){let i=new W(null,t),s=new W(null,e),n=[],o=[];for(n.push(i);n.length>0;){let t=n[0],e=0;for(let i=1;i<n.length;i++){let s=n[i];s.f<t.f&&(t=s,e=i)}if(n.splice(e,1),o.push(t),t.equal(s)){const e=[];let i;for(i=this.includeEnd?t:t.parent;null!==i.parent;)e.push(i.position),i=i.parent;return this.includeStart&&e.push(i.position),e.reverse()}const i=[],r=this.diagonalAllowed?U.adjacentSquaresDiagonal:U.adjacentSquares;for(let e=0;e<r.length;e++){let s=r[e],n=new a.Point(t.position.x+s.x,t.position.y+s.y);if(n.x>=this.width||n.x<0||n.y>=this.height||n.y<0)continue;if(0!=this.map[n.x][n.y])continue;let o=new W(t,n);i.push(o)}for(let e=0;e<i.length;e++){let r=i[e];null==o.find(t=>t.equal(r))&&(r.g=t.g+1,r.h=this.heuristicFunction(r.position,s.position),r.f=r.g+r.h,null==n.find(t=>t.equal(r))&&n.push(r))}}return[]}heuristicFunction(t,e){let i=Math.abs(e.x-t.x),s=Math.abs(e.y-t.y);switch(this.heuristic){case P.Manhattan:return(i+s)*this.weight;case P.Euclidean:return Math.sqrt(i*i+s*s)*this.weight;case P.Chebyshev:return Math.max(i,s)*this.weight;case P.Octile:return(i+s-.58*Math.min(i,s))*this.weight}}}U.adjacentSquares=[new a.Point(0,-1),new a.Point(0,1),new a.Point(-1,0),new a.Point(1,0)],U.adjacentSquaresDiagonal=[new a.Point(0,-1),new a.Point(0,1),new a.Point(-1,0),new a.Point(1,0),new a.Point(-1,-1),new a.Point(-1,1),new a.Point(1,-1),new a.Point(1,1)];var B=i(4);class H{constructor(){this.clips=[],this._playing=!1}get isPlaying(){return this._playing}add(t){this.clips.push(t)}clear(){this.stop(),this.clips.splice(0,this.clips.length)}start(){this._playing=!0;for(let t of this.clips)t.start()}stop(){this._playing=!1;for(let t of this.clips)t.stop()}update(t){let e=!1;for(let i of this.clips)i.update(t),i.isPlaying&&(e=!0);e||this.stop()}}class F{constructor(t){this._time=0,this._playing=!1,this.animationSpeed=t}get isPlaying(){return this._playing}start(){this._time=0,this._playing=!0,this.play()}stop(){this._playing=!1}update(t){this._time+=this.animationSpeed*t,this._playing&&this.play()}}class z extends F{constructor(t){super(t.animationSpeed),this._sprite=t}get duration(){return this._sprite.totalFrames}play(){const t=this._sprite;let e=Math.floor(this._time)%t.totalFrames;e<0&&(e+=t.totalFrames);const i=t.currentFrame;this._time<0||this._time>=t.totalFrames?this.stop():i!==e&&t.gotoAndStop(e)}}class G extends F{constructor(t,e,i,s,n){super(i),this._curve=t,this._duration=e,this._method=s,this._context=n}get duration(){return this._duration}play(){let t=this._time/this._duration;t>=1?(this._playing=!1,this._method.call(this._context,...this._curve(1))):this._method.call(this._context,...this._curve(t))}}class j extends F{constructor(t,e,i){super(t),this._events=[],this._event=null,this._method=e,this._context=i}get duration(){return this._events.length>0?this._events[this._events.length-1].time:0}play(){for(;this._playing;){let t=null===this._event?0:this._event+1;if(t<this._events.length){if(!(this._events[t].time<=this._time))break;this._event=t,this._method.call(this._context,...this._events[t].args)}else this._playing=!1}}addEvent(t){this._events.push(t),this._events.sort(this.compare)}addEvents(t){this._events.push(...t),this._events.sort(this.compare)}add(t,...e){this.addEvent({time:t,args:e})}compare(t,e){return t.time-e.time}}class X{constructor(t){this.inventory=new B.d(this),this.name=t.name,this._speed=new A.b(t.speed),this._healthMax=new A.b(t.healthMax),this._health=new A.b(t.healthMax),this._dead=new A.b(!1),this._killedBy=new A.b(null),this._baseDamage=new A.b(t.baseDamage),this._coins=new A.b(t.coins)}get speed(){return this._speed.get()}get healthMax(){return this._healthMax}get health(){return this._health}get dead(){return this._dead}get killedBy(){return this._killedBy}get coins(){return this._coins}addCoins(t){this._coins.update(e=>e+t)}decreaseCoins(t){const e=this._coins.get();return e>=t&&(this._coins.set(e-t),!0)}get weapon(){return this.inventory.equipment.weapon.item.get()||null}get damage(){var t;return this._baseDamage.get()+((null===(t=this.weapon)||void 0===t?void 0:t.damage)||0)}heal(t){this._health.update(e=>Math.min(this._healthMax.get(),e+t))}hitDamage(t,e){this._dead.get()||(this._health.update(t=>Math.max(0,t-e)),0===this._health.get()&&(this._killedBy.set(t),this._dead.set(!0)))}}var q;!function(t){t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT",t[t.AROUND=4]="AROUND"}(q||(q={}));class ${constructor(t,e){this.static=!1,this._animation=null,this.dungeon=t,this.width=e.width,this.height=e.height,this._x=e.x,this._y=e.y,this.view=new Q(t,e.zIndex,e.width,e.on_position)}get x(){return this._x}get y(){return this._y}set animation(t){var e;null===(e=this._animation)||void 0===e||e.cancel(),this._animation=t,this._animation.start()}get animation(){return this._animation}init(){this.setPosition(this._x,this._y),this.character.killedBy.subscribe(this.handleKilledBy,this),this.character.dead.subscribe(this.handleDead,this),this.character.inventory.equipment.weapon.item.subscribe(this.onWeaponUpdate,this),this.idle(),this.dungeon.ticker.add(this.update,this)}destroy(){var t;this.dungeon.ticker.remove(this.update,this),null===(t=this._animation)||void 0===t||t.cancel(),this.character.killedBy.unsubscribe(this.handleKilledBy,this),this.character.dead.unsubscribe(this.handleDead,this),this.character.inventory.equipment.weapon.item.unsubscribe(this.onWeaponUpdate,this),this.dungeon.remove(this._x,this._y,this),this.view.destroy()}collide(t){return this!==t}handleKilledBy(t){t&&this.onKilledBy(t)}handleDead(t){t&&this.onDead()}onWeaponUpdate(t){this.view.weapon.setWeapon(t)}findDropCell(t=5){return this.findCell(t,t=>t.hasFloor&&!t.hasObject&&!t.hasDrop)}findSpawnCell(t=5){return this.findCell(t,t=>t.hasFloor&&!t.hasObject)}findCell(t,e){const i=this.x,s=this.y,n=this.view.isLeft;let o=null,r=null;const h=Math.max(0,i-t),a=Math.min(this.dungeon.width-1,i+t),l=Math.max(0,s-t),c=Math.min(this.dungeon.width-1,s+t);for(let t=h;t<=a;t++)for(let h=l;h<=c;h++){const a=this.dungeon.cell(t,h);if(a.hasFloor&&e(a)){const t=(d=a,Math.max(Math.abs(d.x-i),Math.abs(d.y-s))+(d.y!==s?.5:0)+(d.x===i&&d.y===s?0:1)+(n?d.x<i?0:1:d.x>i?0:.5));(null===r||r>t)&&(o=a,r=t)}}var d;return o}move(t,e){t>0&&(this.view.isLeft=!1),t<0&&(this.view.isLeft=!0);const i=this.x+t,s=this.y+e;return!!this.dungeon.available(i,s,this)&&(this.run(i,s),!0)}findPath(t){const e=this.dungeon,i=new U(e.width,e.height);for(let s=0;s<e.height;s++)for(let n=0;n<e.width;n++){const o=e.cell(n,s),r=o.object;!o.hasFloor||o.collide(this)&&r!==t?i.mark(n,s):i.clear(n,s)}const s=new a.Point(this.x,this.y),n=new a.Point(t.x,t.y);return i.find(s,n)}idle(){this.animation=new V(this)}run(t,e){this.animation=new J(this,t,e)}hit(){this.animation=new K(this)}update(t){const e=this._animation;e.update(t);const i=!e.isPlaying;!this.action(i)&&i&&this.idle()}setPosition(t,e){this.dungeon.remove(this._x,this._y,this),this._x=Math.floor(t),this._y=Math.floor(e),this.dungeon.set(this._x,this._y,this),this.view.setPosition(t,e)}lookAt(t){t.x<this.x&&(this.view.isLeft=!0),t.x>this.x&&(this.view.isLeft=!1)}scanObjects(t,e,i){const s=this.scanCells(t,e,t=>t.hasObject&&i(t.object)).map(t=>t.object);return[...new Set(s)]}scanCells(t,e,i){const s=this.x,n=this.y,o=t===q.AROUND||t===q.LEFT,r=t===q.AROUND||t===q.RIGHT,h=o?Math.max(0,s-e):s,a=r?Math.min(this.dungeon.width-1,s+e):s,l=Math.max(0,n-e),c=Math.min(this.dungeon.height-1,n+e),d=[];for(let t=l;t<=c;t++)for(let e=h;e<=a;e++){const s=this.dungeon.cell(e,t);i(s)&&d.push(s)}return d}raycastIsVisible(t,e){let i=this.x,s=this.y;const n=Math.abs(t-i),o=Math.abs(e-s),r=i<t?1:-1,h=s<e?1:-1;let a=(n>o?n:-o)/2;for(;i!==t||s!==e;){let l=a;if(l>-n&&(a-=o,i+=r),l<o&&(a+=n,s+=h),i===t&&s===e)break;const c=this.dungeon.cell(i,s);if(!c.hasFloor)return!1;if(c.collide(this))return!1}return!0}}class Y{constructor(t,e){this.ai=t,this.view=t.view,this.spriteName=e,this.animation=new H}get isPlaying(){return this.animation.isPlaying}animateWeapon(t,e,i){const s=new j(e,this.view.weapon.setPosition,this.view.weapon);s.addEvents(t.pos),this.animation.add(s);const n=new G(I.matrix(...t.angle.map(t=>[t])),i,e,this.view.weapon.setAngle,this.view.weapon);this.animation.add(n)}update(t){this.animation.update(t),this.animation.isPlaying||this.finish()}cancel(){this.animation.stop()}finish(){this.animation.stop()}}class V extends Y{constructor(t){super(t,t.character.name+"_idle")}start(){const t=this.view.animation(this.spriteName,.2*this.ai.character.speed);this.animation.add(t);const e=this.ai.character.weapon;e&&this.animateWeapon(e.animations.idle,t.animationSpeed,t.duration),this.animation.start()}}class J extends Y{constructor(t,e,i){super(t,t.character.name+"_run"),this.x=this.ai.x,this.y=this.ai.y,this.new_x=e,this.new_y=i}start(){const t=this.view.animation(this.spriteName,.2*this.ai.character.speed);this.ai.dungeon.set(this.new_x,this.new_y,this.ai),this.animation.clear(),this.animation.add(t),this.animation.add(new G(class{static line(t,e){return i=>t*(1-i)+e*i}static matrix(t,e){return i=>{let s=[];for(let n=0;n<t.length;n++)s[n]=t[n]*(1-i)+e[n]*i;return s}}}.matrix([this.x,this.y],[this.new_x,this.new_y]),t.duration,t.animationSpeed,this.view.setPosition,this.view));const e=this.ai.character.weapon;e&&this.animateWeapon(e.animations.run,t.animationSpeed,t.duration),this.animation.start()}cancel(){super.cancel(),this.ai.dungeon.remove(this.x,this.y,this.ai),this.ai.dungeon.remove(this.new_x,this.new_y,this.ai),this.ai.setPosition(this.ai.x,this.ai.y)}finish(){super.finish(),this.ai.dungeon.remove(this.x,this.y,this.ai),this.ai.dungeon.remove(this.new_x,this.new_y,this.ai),this.ai.setPosition(this.new_x,this.new_y)}}class K extends Y{constructor(t){super(t,t.character.name+"_idle")}start(){const t=this.ai.character.weapon,e=this.view.animation(this.spriteName,.2*(t?t.speed:this.ai.character.speed));this.animation.clear(),this.animation.add(e),t&&this.animateWeapon(t.animations.hit,e.animationSpeed,e.duration),this.animation.start()}update(t){this.animation.update(t),this.animation.isPlaying||this.finish()}cancel(){this.animation.stop()}finish(){this.animation.stop()}}class Q extends a.Container{constructor(t,e,i,s){super(),this._isLeft=!1,this._sprite=null,this.point=new a.Point(0,0),this.resources=t.controller.resources,this._baseZIndex=e,this._gridWidth=i,this._onPosition=s||null,this._weapon=new Z(this.resources),this._weapon.zIndex=2,this._weapon.position.set(16*this._gridWidth,12),this.addChild(this._weapon),t.container.addChild(this)}get isLeft(){return this._isLeft}set isLeft(t){this._isLeft=t,this.updatePosition()}get weapon(){return this._weapon}setPosition(t,e){const i=Math.round(16*t*2)/2,s=Math.round(16*e*2)/2;this.point.set(i,s),this.updatePosition(),this.zIndex=this._baseZIndex+Math.floor(e)*E,this._onPosition&&this._onPosition(i,s)}updatePosition(){this.scale.set(this._isLeft?-1:1,1),this.position.set(this.point.x+(this._isLeft?16*this._gridWidth:0),this.point.y)}animation(t,e){var i;return null===(i=this._sprite)||void 0===i||i.destroy(),this._sprite=this.resources.animated(t,{autoUpdate:!1,loop:!1,animationSpeed:e}),this._sprite.anchor.set(0,1),this._sprite.position.y=14,this._sprite.position.x=0,this._sprite.width>16*this._gridWidth&&(this._sprite.position.x-=(this._sprite.width-16*this._gridWidth)/2),this._sprite.zIndex=1,this.addChild(this._sprite),new z(this._sprite)}}class Z extends a.Container{constructor(t){super(),this._sprite=null,this.resources=t}destroy(){var t;null===(t=this._sprite)||void 0===t||t.destroy(),this._sprite=null,super.destroy()}setWeapon(t){var e;null===(e=this._sprite)||void 0===e||e.destroy(),this._sprite=null,t&&(this._sprite=this.resources.sprite(t.spriteName),this._sprite.anchor.set(.5,1),this.addChild(this._sprite))}setAngle(t){this._sprite&&(this._sprite.angle=t)}setPosition(t,e){this._sprite&&this._sprite.position.set(t,e)}}var tt=i(1);class et extends a.Container{constructor(t){super(),this._color=t.color,this._width=t.width||0,this._widthMax=t.widthMax,this._rect=new a.Graphics,this._labelCenter=t.labelCenter||!1,this._label=new a.BitmapText("",{font:{name:"alagard",size:16}}),this._label.anchor=new a.Point(this._labelCenter?.5:0,.5),this._label.position.set((tt.e.uiBorder<<1)+(this._labelCenter?this._widthMax>>1:0),tt.e.uiBorder+9),super.addChild(this._rect,this._label)}set color(t){this._color=t,this.updateRect()}set width(t){this._width=t,this.updateRect()}set label(t){this._label.text=t}set widthMax(t){this._widthMax=t,this._label.position.set((tt.e.uiBorder<<1)+(this._labelCenter?this._widthMax>>1:0),tt.e.uiBorder+9),this.updateRect()}updateRect(){this._rect.clear().beginFill(tt.b.uiBackground,.3).drawRect(0,0,this._widthMax+(tt.e.uiBorder<<1),18+(tt.e.uiBorder<<1)).endFill().beginFill(this._color,.3).drawRect(tt.e.uiBorder,tt.e.uiBorder,this._width,18).endFill()}}var it,st,nt;!function(t){t[t.DEMON=1]="DEMON",t[t.ZOMBIE=2]="ZOMBIE",t[t.ORC=3]="ORC",t[t.SLIME=4]="SLIME",t[t.UNDEAD=5]="UNDEAD"}(it||(it={})),function(t){t[t.NORMAL=1]="NORMAL",t[t.LEADER=2]="LEADER",t[t.MINION=3]="MINION"}(st||(st={})),function(t){t[t.READY=0]="READY",t[t.ALARM=1]="ALARM"}(nt||(nt={}));class ot extends X{constructor(t){super({name:t.name,speed:t.speed,healthMax:t.healthMax,baseDamage:t.baseDamage,coins:0}),this.level=t.level,this.luck=t.luck,this.xp=t.xp,this.category=t.category,this.type=t.type,this.spawn=t.spawn}}class rt extends ${constructor(t,e){super(t,e),this.interacting=!1,this._state=nt.READY,this.last_path=[],this.spawned=[]}interact(){}onKilledBy(t){t&&t instanceof lt&&(this.dungeon.log(`${this.character.name} killed by ${t.name}`),t.addXp(this.character.xp))}ready(){this._state=nt.READY}sendAlarm(t){this._state=nt.ALARM;for(const e of this.scanMonsters(q.AROUND,this.max_distance))e.alarm(t)}alarm(t){!this.character.dead.get()&&this.character.type!==st.LEADER&&this._state===nt.READY&&this.animation instanceof V&&this.moveTo(t)}get state(){return this._state}randomMove(){if(Math.random()<.1){const t=Math.floor(3*Math.random())-1,e=Math.floor(3*Math.random())-1;if(this.move(t,e))return!0}return!1}moveToHero(){const[t]=this.scanHero(q.AROUND,this.max_distance);if(t){this.lookAt(t),this.sendAlarm(t);const e=Math.abs(this.x-t.x),i=Math.abs(this.y-t.y);if(e>this.width||i>this.height)return this.moveTo(t);if(this.character.luck<this.dungeon.rng.float())return this.hit(),!0}return!1}moveTo(t){return this.last_path=this.findPath(t),this.moveByPath()}moveByPath(){if(this.last_path.length>0){const t=this.last_path[0],e=t.x-this.x,i=t.y-this.y;return this.move(e,i)?(this.last_path.splice(0,1),!0):(this.last_path=[],!1)}return!1}scanHit(){const t=this.character.weapon,e=this.view.isLeft?q.LEFT:q.RIGHT,i=(null==t?void 0:t.distance)||1,s=this.scanHero(e,i);for(const t of s)t.character.hitDamage(this.character,this.character.damage)}spawnMinions(){for(let t=this.spawned.length-1;t>=0;t--)this.spawned[t].character.dead.get()&&this.spawned.splice(t,1);if(this.spawned.length<this.character.spawn){if(Math.random()>.1)return!1;const t=this.findSpawnCell();if(!t)return console.warn(`spawn cell not found at ${this.x}:${this.y}`,this.character.category,this.character.type),!1;const e=this.spawnMinion(t.x,t.y);return e?(t.object=e,this.spawned.push(e),!0):(console.warn("minion not spawned",this.character.category,this.character.type),!1)}return!1}scanHero(t,e){return this.scanObjects(t,e,t=>t instanceof ct).filter(t=>this.raycastIsVisible(t.x,t.y))}scanMonsters(t,e){return this.scanObjects(t,e,t=>t instanceof rt)}}const ht=["elf_f","elf_m","knight_f","knight_m","wizard_f","wizard_m"],at={coins:0,baseDamage:3,level:1,levelXp:0,skillPoints:0,xp:0,healthMax:30,speed:1};class lt extends X{constructor(t,e,i){super({name:t,speed:e.speed,healthMax:e.healthMax,baseDamage:e.baseDamage,coins:e.coins}),this.dungeonSeeds=new Map,this.bonfires=new Set,this.persistent=i,this._level=new A.b(e.level),this._levelXp=new A.b(e.levelXp),this._skillPoints=new A.b(e.skillPoints),this._xp=new A.b(e.xp),this.subscribe()}get level(){return this._level}get levelXp(){return this._levelXp}get skillPoints(){return this._skillPoints}get xp(){return this._xp}addXp(t){this._xp.update(e=>{let i=e+t;for(;;){const t=this._levelXp.get();if(!(i>=t))break;i-=t,this._level.update(t=>t+1),this._levelXp.update(t=>t+1e3),this._skillPoints.update(t=>t+1)}return i})}increaseHealth(){this._skillPoints.update(t=>(t>0&&(t--,this._healthMax.update(t=>t+1),this._health.update(t=>t+1)),t))}subscribe(){this._coins.subscribe(this.save,this),this._baseDamage.subscribe(this.save,this),this._level.subscribe(this.save,this),this._levelXp.subscribe(this.save,this),this._skillPoints.subscribe(this.save,this),this._xp.subscribe(this.save,this),this._healthMax.subscribe(this.save,this),this._speed.subscribe(this.save,this)}save(){this.persistent.global.save(this.name,this.state)}get state(){return{coins:this._coins.get(),baseDamage:this._baseDamage.get(),level:this._level.get(),levelXp:this._levelXp.get(),skillPoints:this._skillPoints.get(),xp:this._xp.get(),healthMax:this._healthMax.get(),speed:this._speed.get()}}static load(t,e){let i=e.global.load(t)||at;return new lt(t,i,e)}}class ct extends ${constructor(t,e,i,s){super(e,{x:i,y:s,width:1,height:1,zIndex:y,on_position:e.camera.bind(e)}),this.interacting=!1,this.character=t,this.init(),this.character.inventory.drop.subscribe(this.onDrop,this)}destroy(){super.destroy(),this.character.inventory.drop.unsubscribe(this.onDrop,this)}interact(){}onKilledBy(t){this.dungeon.log(`${this.character.name} killed by ${t.name}`)}onDead(){this.dungeon.controller.dead()}onDrop(t){let[e]=t;const i=this.findDropCell();i&&(i.dropItem=e)}action(t){if(!this.character.dead.get()){const e=this.animation instanceof V,i=this.animation instanceof K;t&&(i&&this.scanHit(),this.scanDrop());const s=this.dungeon.controller.joystick;if(e&&s.inventory.once())return this.dungeon.controller.showInventory(this.character),this.idle(),!0;for(let t=0;t<=9;t++){const i=(t+1)%10;if(s.digit(i).once()){const i=this.character.inventory.belt.cell(t),s=i.item.get();s&&(s instanceof c.d||e)&&i.use()}}if(e&&s.drop.once()&&this.character.inventory.equipment.weapon.drop(),e||t){const t=s.hit.triggered,e=s.hit.once();if(e){const t=this.view.isLeft?q.LEFT:q.RIGHT,[e]=this.scanInteracting(t,1);if(e)return this.idle(),e.interact(this),!0}if(t||e)return this.lookAtMonsters(),this.hit(),!0}if(e||t){const t=ct.delta(s.moveLeft,s.moveRight),e=ct.delta(s.moveUp,s.moveDown);if((0!==t||0!==e)&&this.move(t,e))return!0}}return!1}static delta(t,e){return t.triggered?-1:e.triggered?1:0}scanDrop(){var t;(null===(t=this.dungeon.cell(this.x,this.y).drop)||void 0===t?void 0:t.pickedUp(this.character))&&a.sound.play("fruit_collect")}scanHit(){const t=this.character.weapon,e=(null==t?void 0:t.distance)||1,i=this.view.isLeft?q.LEFT:q.RIGHT,s=this.scanMonsters(i,e);for(let t of s)t.character.hitDamage(this.character,this.character.damage);s.length>0&&a.sound.play("hit_damage",{speed:(null==t?void 0:t.speed)||1})}lookAtMonsters(){const t=this.character.weapon,e=(null==t?void 0:t.distance)||1,i=this.monstersHealth(q.LEFT,e),s=this.monstersHealth(q.RIGHT,e);i>0&&i>s?this.view.isLeft=!0:s>0&&s>i&&(this.view.isLeft=!1)}scanInteracting(t,e){return this.scanCells(t,e,t=>t.interacting)}scanMonsters(t,e){return this.scanObjects(t,e,t=>t instanceof rt)}monstersHealth(t,e){return this.scanMonsters(t,e).map(t=>t.character.health.get()).reduce((t,e)=>t+e,0)}}class dt extends a.Container{constructor(t,e){super(),this.fixedHPSize=e.fixedHPSize,this.hpBarSize=e.hpBarSize||8,this.maxBarSize=e.maxBarSize||256,this.maxBarInnerSize=this.maxBarSize-(tt.e.uiBorder<<1);const i=18+(tt.e.uiBorder<<1)+tt.e.uiMargin;this.heroState=t,this.health=new et({color:tt.b.uiRed,width:0,widthMax:this.maxBarInnerSize}),this.xp=new et({color:tt.b.uiYellow,width:0,widthMax:this.maxBarInnerSize}),this.xp.position.set(0,i),this.coins=new a.BitmapText("",{font:{name:"alagard",size:16}}),this.coins.position.set(0,2*i),super.addChild(this.health,this.xp,this.coins),t.health.subscribe(this.updateHealth,this),t.healthMax.subscribe(this.updateHealthMax,this),t.level.subscribe(this.updateXp,this),t.levelXp.subscribe(this.updateXp,this),t.skillPoints.subscribe(this.updateXp,this),t.xp.subscribe(this.updateXp,this),t.coins.subscribe(this.updateCoins,this)}destroy(){super.destroy(),this.heroState.health.unsubscribe(this.updateHealth,this),this.heroState.healthMax.unsubscribe(this.updateHealthMax,this),this.heroState.level.unsubscribe(this.updateXp,this),this.heroState.levelXp.unsubscribe(this.updateXp,this),this.heroState.skillPoints.unsubscribe(this.updateXp,this),this.heroState.xp.unsubscribe(this.updateXp,this),this.heroState.coins.unsubscribe(this.updateCoins,this)}updateHealthMax(t){const e=this.heroState.health.get();this.fixedHPSize||(this.health.widthMax=this.hpBarSize*t),this.health.label=`${e}/${t}`}updateHealth(t){const e=this.heroState.healthMax.get();this.fixedHPSize?this.health.width=Math.floor(this.maxBarInnerSize*t/e):this.health.width=this.hpBarSize*t,this.health.label=`${t}/${e}`}updateXp(){const t=this.heroState.level.get(),e=this.heroState.levelXp.get(),i=this.heroState.skillPoints.get(),s=this.heroState.xp.get();this.xp.widthMax=this.maxBarInnerSize,this.xp.width=Math.floor(this.maxBarInnerSize*s/e),this.xp.label=`L:${t} XP:${s}/${e} SP:${i}`}updateCoins(t){this.coins.text="$"+t}}const ut=[{name:"chort",category:it.DEMON,type:st.NORMAL,luck:.3,weapons:[]},{name:"wogol",category:it.DEMON,type:st.NORMAL,luck:.3,weapons:[]},{name:"imp",category:it.DEMON,type:st.NORMAL,luck:.3,weapons:[]},{name:"ice_zombie",category:it.ZOMBIE,type:st.NORMAL,luck:.3,weapons:[c.e.knife]},{name:"tiny_zombie",category:it.ZOMBIE,type:st.NORMAL,luck:.3,weapons:[c.e.knife]},{name:"zombie",category:it.ZOMBIE,type:st.NORMAL,luck:.3,weapons:[c.e.knife]},{name:"orc_shaman",category:it.ORC,type:st.LEADER,luck:.4,weapons:[c.e.knife]},{name:"masked_orc",category:it.ORC,type:st.NORMAL,luck:.3,weapons:[c.e.knife]},{name:"orc_warrior",category:it.ORC,type:st.MINION,luck:.3,weapons:[c.e.knife]},{name:"goblin",category:it.ORC,type:st.MINION,luck:.3,weapons:[c.e.knife]},{name:"swampy",category:it.SLIME,type:st.NORMAL,luck:.3,weapons:[]},{name:"muddy",category:it.SLIME,type:st.NORMAL,luck:.3,weapons:[]},{name:"necromancer",category:it.UNDEAD,type:st.LEADER,luck:.4,weapons:[c.e.knife]},{name:"skeleton",category:it.UNDEAD,type:st.MINION,luck:.3,weapons:[c.e.knife]}];class pt extends ot{constructor(t,e){super({name:t.name,category:t.category,type:t.type,speed:.8,healthMax:10+Math.floor(2*e),level:e,luck:t.luck,baseDamage:1+.5*e,xp:35+5*e,spawn:3})}}class gt extends rt{constructor(t,e,i,s){super(e,{x:i,y:s,width:1,height:1,zIndex:_}),this.max_distance=5,this.character=new pt(t,e.level);const n=t.luck<this.dungeon.rng.float()?c.d.select(this.dungeon.rng,t.weapons):null;n&&this.character.inventory.equipment.weapon.set(n),this.init()}action(t){if(!this.character.dead.get()&&t){if(this.animation instanceof K&&this.scanHit(),this.character.type===st.LEADER){if(this.spawnMinions())return!1;if(this.moveFromHeroOrAttack())return!0;this.ready()}else{if(this.moveToHero())return!0;if(this.moveByPath())return!0;if(this.ready(),this.randomMove())return!0}}return!1}moveFromHeroOrAttack(){const[t]=this.scanHero(q.AROUND,this.max_distance);if(t){this.lookAt(t),this.sendAlarm(t);const e=Math.abs(this.x-t.x),i=Math.abs(this.y-t.y);if(e>this.width||i>this.height){const e=Math.min(1,Math.max(-1,this.x-t.x)),i=Math.min(1,Math.max(-1,this.y-t.y));return console.log("move from hero"),this.move(e,i)||this.move(e,0)||this.move(0,i)}if(this.character.luck<this.dungeon.rng.float())return console.log("attack hero"),this.hit(),!0}return!1}onDead(){var t;Math.random()<this.character.luck&&(null===(t=this.findDropCell())||void 0===t||t.randomDrop()),this.destroy()}spawnMinion(t,e){const i=ut.filter(t=>t.category===this.character.category&&t.type===st.MINION);if(0===i.length)return console.warn("no minion config found",this.character.category),null;const s=this.dungeon.rng.select(i);return new gt(s,this.dungeon,t,e)}}const ft=[{name:"big_zombie",category:it.ZOMBIE,weapons:[c.e.anime_sword,c.e.baton_with_spikes,c.e.big_hammer,c.e.cleaver,c.e.mace]},{name:"big_demon",category:it.DEMON,weapons:[]},{name:"ogre",category:it.ORC,weapons:[c.e.anime_sword,c.e.baton_with_spikes,c.e.big_hammer,c.e.cleaver,c.e.mace]}];class mt extends ot{constructor(t,e){super({name:t.name,category:t.category,type:st.LEADER,speed:.5,healthMax:50+Math.floor(10*e),level:e,luck:.4,baseDamage:5+.5*e,xp:100+50*e,spawn:5})}}class wt extends rt{constructor(t,e,i,s){super(e,{width:2,height:2,x:i,y:s,zIndex:_}),this.max_distance=7,this.character=new mt(t,e.level);const n=c.d.select(this.dungeon.rng,t.weapons);n&&this.character.inventory.equipment.weapon.set(n),this.init();const o=e.controller.app.screen.width,r=new _t(this.character);r.zIndex=13,r.position.set(o>>1,64),e.controller.stage.addChild(r)}action(t){if(!this.character.dead.get()&&t){const e=this.animation instanceof K;if(t&&e&&this.scanHit(),this.spawnMinions())return!1;if(this.moveToHero())return!0;if(this.moveByPath())return!0;if(this.ready(),this.randomMove())return!0}return!1}onDead(){var t;this.dungeon.controller.showBanner({text:this.dungeon.rng.boolean()?"VICTORY ACHIEVED":"YOU DEFEATED",color:tt.b.uiYellow});for(let e=0;e<9;e++)null===(t=this.findDropCell())||void 0===t||t.randomDrop();this.destroy()}spawnMinion(t,e){const i=ut.filter(t=>t.category===this.character.category&&t.type!==st.LEADER);if(0===i.length)return console.warn("no minion config found",this.character.category),null;const s=this.dungeon.rng.select(i);return new gt(s,this.dungeon,t,e)}}class _t extends a.Container{constructor(t){super(),this.destroyed=!1,this.boss=t;this.pointWidth=Math.min(4,Math.floor(500/this.boss.healthMax.get())),this.widthMax=this.pointWidth*this.boss.healthMax.get(),this.health=new et({color:tt.b.uiRed,widthMax:this.widthMax,labelCenter:!0}),this.health.position.set(-(this.widthMax>>1),0),this.addChild(this.health),this.boss.health.subscribe(this.updateHealth,this),this.boss.dead.subscribe(this.updateDead,this)}destroy(){this.destroyed||(this.destroyed=!0,this.boss.health.unsubscribe(this.updateHealth,this),this.boss.dead.unsubscribe(this.updateDead,this),this.health.destroy(),super.destroy())}updateHealth(t){this.health.width=this.pointWidth*t,this.health.label=`${this.boss.name} - ${t}`}updateDead(t){t&&this.destroy()}}class yt{constructor(t,e){this.npc=t,this.controller=e}}class bt extends yt{constructor(t,e){super(t,e)}use(t){this.controller.sellInventory(t,this.npc)}}bt.id="selling";class Ot extends yt{constructor(t,e){super(t,e)}use(t){this.controller.buyInventory(t,this.npc)}}Ot.id="buying";class St extends yt{constructor(t,e){super(t,e)}use(t){a.sound.play("big_egg_collect"),t.heal(t.healthMax.get())}}var xt;St.id="heal",function(t){t[t.POTIONS=1]="POTIONS",t[t.WEAPONS=2]="WEAPONS"}(xt||(xt={}));const Et=[{name:"alchemist",width:1,height:1,baseDamage:0,coins:1e3,skills:[bt.id,Ot.id],weapons:[],trading:[xt.POTIONS]},{name:"archer",width:1,height:1,baseDamage:0,coins:1e3,skills:[],weapons:[],trading:[]},{name:"bishop",width:1,height:2,baseDamage:0,coins:0,skills:[],weapons:[],trading:[]},{name:"blacksmith",width:1,height:1,baseDamage:0,coins:1e3,skills:[bt.id,Ot.id],weapons:[c.f.hammer],trading:[xt.WEAPONS]},{name:"butcher",width:1,height:1,baseDamage:0,coins:1e3,skills:[bt.id,Ot.id],weapons:[],trading:[]},{name:"executioner",width:2,height:2,baseDamage:0,coins:0,skills:[],weapons:[c.f.axe],trading:[]},{name:"herald",width:1,height:1,baseDamage:0,coins:0,skills:[],weapons:[],trading:[]},{name:"king",width:1,height:1,baseDamage:0,coins:0,skills:[],weapons:[],trading:[]},{name:"knight",width:1,height:1,baseDamage:0,coins:0,skills:[],weapons:[c.f.regular_sword],trading:[]},{name:"knight_elite",width:1,height:1,baseDamage:0,coins:0,skills:[],weapons:[c.f.regular_sword],trading:[]},{name:"knight_heavy",width:1,height:1,baseDamage:0,coins:0,skills:[],weapons:[c.f.regular_sword],trading:[]},{name:"large_knight",width:2,height:2,baseDamage:0,coins:0,skills:[],weapons:[c.f.knight_sword],trading:[]},{name:"large_knight_elite",width:2,height:2,baseDamage:0,coins:0,skills:[],weapons:[c.f.knight_sword],trading:[]},{name:"mage",width:1,height:1,baseDamage:0,coins:1e3,skills:[bt.id,Ot.id],weapons:[],trading:[xt.POTIONS]},{name:"magic_shop_keeper",width:1,height:1,baseDamage:0,coins:1e3,skills:[bt.id,Ot.id],weapons:[],trading:[xt.POTIONS]},{name:"merchant",width:1,height:1,baseDamage:0,coins:1e4,skills:[bt.id,Ot.id],weapons:[],trading:[xt.POTIONS]},{name:"mountain_king",width:1,height:1,baseDamage:0,coins:0,skills:[],weapons:[],trading:[]},{name:"nun",width:1,height:1,baseDamage:0,coins:0,skills:[St.id],weapons:[],trading:[]},{name:"nun_fat",width:1,height:1,baseDamage:0,coins:0,skills:[St.id],weapons:[],trading:[]},{name:"nun_tall",width:1,height:1,baseDamage:0,coins:0,skills:[St.id],weapons:[],trading:[]},{name:"princess",width:1,height:1,baseDamage:0,coins:0,skills:[],weapons:[],trading:[]},{name:"queen",width:1,height:1,baseDamage:0,coins:0,skills:[],weapons:[],trading:[]},{name:"thief",width:1,height:1,baseDamage:0,coins:1e3,skills:[bt.id,Ot.id],weapons:[c.f.knife],trading:[]},{name:"townsfolk_f",width:1,height:1,baseDamage:0,coins:100,skills:[bt.id,Ot.id],weapons:[],trading:[]},{name:"townsfolk_m",width:1,height:1,baseDamage:0,coins:100,skills:[bt.id,Ot.id],weapons:[],trading:[]}];class vt extends X{constructor(t){super({name:t.name,speed:1,healthMax:1e3,baseDamage:t.baseDamage,coins:t.coins}),this._context={},this._skill={}}setContext(t,e){this._context[t]=e}getContext(t){return this._context[t]}hasSkill(t){return this._skill.hasOwnProperty(t)}getSkill(t){return this._skill[t]||null}addSkill(t,e){this._skill[t]=e}}class Nt extends ${constructor(t,e,i,s,n){super(e,{width:t.width,height:t.height,x:s,y:n,zIndex:_}),this.interacting=!0,this.character=new vt(t);const o=c.d.select(this.dungeon.rng,t.weapons);o&&this.character.inventory.equipment.weapon.set(o),this.initSkills(i,t),this.init()}initSkills(t,e){for(const i of e.skills)switch(i){case bt.id:this.character.addSkill(i,new bt(this.character,t));break;case Ot.id:this.character.addSkill(i,new Ot(this.character,t));const s=this.character.inventory.backpack;for(const t of e.trading)switch(t){case xt.POTIONS:for(let t=0;t<10;t++)s.cell(t,0).set(new c.c,3);for(let t=0;t<10;t++)s.cell(t,1).set(new c.b,3);break;case xt.WEAPONS:for(const t of c.g)t.level<=this.dungeon.level+2&&s.add(new c.d(t))}break;case St.id:this.character.addSkill(i,new St(this.character,t))}}onDead(){}onKilledBy(t){}action(){return!1}interact(t){this.lookAt(t),this.dungeon.controller.showDialog(t.character,this.character)}}var Tt;!function(t){t[t.UNLIT=0]="UNLIT",t[t.LIGHT=1]="LIGHT",t[t.LIT=2]="LIT"}(Tt||(Tt={}));class Mt{constructor(t,e,i,s){this.width=1,this.height=1,this.static=!0,this.interacting=!0,this.dungeon=t,this.x=e,this.y=i,this._state=Tt.UNLIT,this._sprite=this.dungeon.animated(this.x,this.y,"bonfire_unlit"),this._sprite.zIndex=O+this.y*E,this.dungeon.set(this.x,this.y,this),s&&this.light()}get state(){return this._state}destroy(){this.dungeon.remove(this.x,this.y,this),this._sprite.destroy()}interact(t){switch(this._state){case Tt.UNLIT:t.character.bonfires.add(this.dungeon.level),this.dungeon.controller.showBanner({text:"BONFIRE LIT",color:tt.b.uiYellow}),this.light();break;case Tt.LIGHT:case Tt.LIT:this.dungeon.controller.showBonfire(t.character)}}collide(t){return!0}light(){this._state===Tt.UNLIT&&(this._state=Tt.LIGHT,this._sprite.destroy(),this._sprite=this.dungeon.animated(this.x,this.y,"bonfire_light"),this._sprite.zIndex=O+this.y*E,this._sprite.loop=!1,this._sprite.onComplete=()=>this.lit(),this.dungeon.light.addLight({x:16*this.x+8,y:16*this.y-16},m.BONFIRE))}lit(){var t;this._state=Tt.LIT,null===(t=this._sprite)||void 0===t||t.destroy(),this._sprite=this.dungeon.animated(this.x,this.y,"bonfire_lit"),this._sprite.zIndex=O+this.y*E}}class kt{constructor(t,e){this.container=null,this.background=null,this.selectable=null,this.controller=t,this.hero=e}init(){this.selectable=new tt.d(this.controller.joystick),this.background=new a.Graphics,this.background.beginFill(0).drawRect(0,0,400,400).endFill(),this.background.zIndex=0,this.container=new a.Container,this.container.addChild(this.background),this.container.sortChildren(),this.container.position.set((this.controller.app.screen.width>>1)-200,(this.controller.app.screen.height>>1)-200),this.controller.stage.addChild(this.container),this.controller.app.ticker.add(this.handleInput,this);const t=new tt.c;t.offset(tt.e.uiMargin,tt.e.uiMargin),t.commit();let e=0;const i=(i,s)=>{const n=new tt.a({label:i,width:400-2*tt.e.uiMargin,height:32,textSize:24});this.container.addChild(n),n.position.set(t.x,t.y),t.offset(0,32),t.offset(0,tt.e.uiMargin),this.selectable.set(0,e,n,s),e++},s=[...this.hero.bonfires].sort((t,e)=>t-e);for(const t of s)i("Level "+t,()=>this.goto(t));i("Cancel",()=>this.cancel())}goto(t){this.controller.closeModal(),this.controller.generateDungeon({hero:this.hero,level:t})}cancel(){this.controller.closeModal()}handleInput(){var t;null===(t=this.selectable)||void 0===t||t.handleInput()}destroy(){var t,e;this.controller.app.ticker.remove(this.handleInput,this),null===(t=this.container)||void 0===t||t.destroy(),this.container=null,null===(e=this.background)||void 0===e||e.destroy(),this.background=null,this.selectable=null}}var Dt=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{a(s.next(t))}catch(t){o(t)}}function h(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,h)}a((s=s.apply(t,e||[])).next())}))};function Ct(t=0){return Dt(this,void 0,void 0,(function*(){return yield new Promise(e=>setTimeout(e,t))}))}var Rt,Pt=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{a(s.next(t))}catch(t){o(t)}}function h(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,h)}a((s=s.apply(t,e||[])).next())}))};function At(t,e){const i=[];for(let s=0;s<t;s++)i.push(e);return i}!function(t){t[t.Decided=0]="Decided",t[t.Undecided=-1]="Undecided",t[t.Contradiction=-2]="Contradiction"}(Rt||(Rt={}));class Lt{constructor(t,e,i){this.wave=[],this.propagator=[],this.compatible=[],this.observed=null,this.toPropagate=[],this.backtrackItems=[],this.backtrackItemsLengths=[],this.prevChoices=[],this.droppedBacktrackItemsCount=0,this.T=0,this.periodic=!1,this.weights=[],this.weightLogWeights=[],this.sumsOfOnes=[],this.sumOfWeights=0,this.sumOfWeightLogWeights=0,this.startingEntropy=0,this.sumsOfWeights=[],this.sumsOfWeightLogWeights=[],this.entropies=[],this.status=Rt.Undecided,this.deferredConstraintsStep=!1,this.debug=!1,this.rng=t,this.FMX=e,this.FMY=i}get percent(){let t=0;for(let e=0;e<this.wave.length;e++)1===this.sumsOfOnes[e]&&t++;return 100*t/this.wave.length}init(){this.wave=At(this.FMX*this.FMY,[]),this.compatible=[];for(let t=0;t<this.wave.length;t++){this.wave[t]=At(this.T,!0),this.compatible[t]=[];for(let e=0;e<this.T;e++)this.compatible[t][e]=At(4,0)}this.weightLogWeights=[],this.sumOfWeights=0,this.sumOfWeightLogWeights=0;for(let t=0;t<this.T;t++)this.weightLogWeights[t]=this.weights[t]*Math.log(this.weights[t]),this.sumOfWeights+=this.weights[t],this.sumOfWeightLogWeights+=this.weightLogWeights[t];this.startingEntropy=Math.log(this.sumOfWeights)-this.sumOfWeightLogWeights/this.sumOfWeights,this.status=Rt.Undecided,this.initConstraint()}clear(){this.sumsOfOnes=[],this.sumsOfWeights=[],this.sumsOfWeightLogWeights=[],this.entropies=[];for(let t=0;t<this.wave.length;t++){for(let e=0;e<this.T;e++){this.wave[t][e]=!0;for(let i=0;i<4;i++)this.compatible[t][e][i]=this.propagator[Lt.opposite[i]][e].length}this.sumsOfOnes[t]=this.weights.length,this.sumsOfWeights[t]=this.sumOfWeights,this.sumsOfWeightLogWeights[t]=this.sumOfWeightLogWeights,this.entropies[t]=this.startingEntropy}this.toPropagate=[],this.backtrackItems=[],this.backtrackItemsLengths=[0],this.droppedBacktrackItemsCount=0,this.prevChoices=[],this.status=Rt.Undecided}run(t=0,e=!1){return Pt(this,void 0,void 0,(function*(){0===this.wave.length&&(console.time("model.init"),this.init(),console.timeEnd("model.init")),console.time("model.clear"),this.clear(),console.timeEnd("model.clear"),console.time("model.run"),this.debug=e;let i=0;for(;(i<t||0===t)&&(i%50==0&&(yield Ct()),this.debug&&console.log("step",i),this.step(),this.debug&&(console.log("after step",i),this.graphics([])),this.status===Rt.Undecided);i++);return console.timeEnd("model.run"),console.log("complete, steps: "+i),this.status}))}step(){let t,e=-1,i=!1;this.deferredConstraintsStep&&(this.debug&&console.log("step constraint"),this.stepConstraint()),this.status!=Rt.Undecided&&(e=0,i=!0,this.debug&&console.log("restart = true")),i||(console.assert(0==this.toPropagate.length),this.backtrackItemsLengths.push(this.droppedBacktrackItemsCount+this.backtrackItems.length),[e,t]=this.observe(),this.debug&&console.log("observed",e,t),-1!==e&&(this.debug&&console.log("push to prev choices"),this.prevChoices.push([e,t])));do{if(this.debug&&console.log("do loop"),i=!1,this.debug&&console.log("status",this.status),this.status===Rt.Undecided&&this.propagate(),this.status===Rt.Undecided&&this.stepConstraint(),-1===e&&this.status===Rt.Undecided)return this.debug&&console.log("decided"),this.status=Rt.Decided,this.status;if(this.status===Rt.Contradiction)for(this.debug&&console.log("contradiction"),e=0;;){if(this.debug&&console.log("while backtrack"),1==this.backtrackItemsLengths.length)return this.debug&&console.log("We've backtracked as much as we can, but, it's still not possible. That means it is impossible"),Rt.Contradiction;this.backtrack();let t=this.prevChoices.pop();if(this.toPropagate=[],this.status=Rt.Undecided,this.debug&&(console.log("Mark the given choice as impossible",t[0],t[1]),this.graphics([t[0]])),this.internalBan(t[0],t[1])&&(this.status=Rt.Contradiction),this.status===Rt.Undecided&&this.propagate(),this.status!==Rt.Contradiction){this.debug&&console.log("// Include the last ban as part of the previous backtrack"),console.assert(0===this.toPropagate.length),this.backtrackItemsLengths.pop(),this.backtrackItemsLengths.push(this.droppedBacktrackItemsCount+this.backtrackItems.length),this.debug&&console.log("restart = true and break"),i=!0;break}this.debug&&console.log("If still in contradiction, repeat backtracking")}}while(i);return this.status}observe(){this.debug&&console.log("observe");let t=1e3,e=-1;for(let i=0;i<this.wave.length;i++){if(this.onBoundary(i%this.FMX,Math.floor(i/this.FMX)))continue;let s=this.sumsOfOnes[i];if(0===s)return this.debug&&console.error(`[wave=${i}] found zero sum of ones`),this.debug&&this.graphics([i]),this.status=Rt.Contradiction,[-1,-1];let n=this.entropies[i];if(s>1&&n<=t){let s=1e-6*this.rng.float();n+s<t&&(t=n+s,e=i)}}if(-1==e){this.debug&&console.log("complete observed"),this.observed=At(this.FMX*this.FMY,0);for(let t=0;t<this.wave.length;t++){let e=t%this.FMX,i=Math.floor(t/this.FMX);if(!this.onBoundary(e,i)){this.testObserved(t);for(let e=0;e<this.T;e++)if(this.wave[t][e]){this.observed[t]=e;break}}}return[-1,-1]}let i=0,s=[];for(let t=0;t<this.T;t++)s[t]=this.wave[e][t]?this.weights[t]:0,i+=s[t];let n=this.rng.float()*i,o=0;for(let t of s){if(n-=t,n<0)break;o++}let r=this.wave[e];for(let t=0;t<this.T;t++)r[t]!=(t==o)&&(this.debug&&console.log("observe select"),this.internalBan(e,t)&&(this.status=Rt.Contradiction));return this.debug&&(console.log("observed",[e,o]),this.graphics([e])),[e,o]}propagate(){for(;this.toPropagate.length>0;){let[t,e]=this.toPropagate.pop(),i=t%this.FMX,s=Math.floor(t/this.FMX);for(let t=0;t<4;t++){let n=i+Lt.DX[t],o=s+Lt.DY[t];if(this.onBoundary(n,o))continue;n<0?n+=this.FMX:n>=this.FMX&&(n-=this.FMX),o<0?o+=this.FMY:o>=this.FMY&&(o-=this.FMY);let r=n+o*this.FMX,h=this.propagator[t][e],a=this.compatible[r];for(let e of h){let i=a[e];i[t]--,0==i[t]&&this.internalBan(r,e)&&(this.status=Rt.Contradiction)}}if(this.status==Rt.Contradiction)break}}ban(t,e){return this.debug&&console.log("ban",t,e),this.wave[t][e]&&(this.deferredConstraintsStep=!0,this.internalBan(t,e))?this.status=Rt.Contradiction:(this.propagate(),this.status)}internalBan(t,e){this.debug&&console.log("internal ban",t,e),this.wave[t][e]=!1;let i=this.compatible[t][e];for(let t=0;t<4;t++)i[t]-=this.T;this.toPropagate.push([t,e]),this.sumsOfOnes[t]-=1,this.sumsOfWeights[t]-=this.weights[e],this.sumsOfWeightLogWeights[t]-=this.weightLogWeights[e];let s=this.sumsOfWeights[t];return this.entropies[t]=Math.log(s)-this.sumsOfWeightLogWeights[t]/s,this.backtrackItems.push([t,e]),this.banConstraint(t,e),0===this.sumsOfOnes[t]&&(this.debug&&(console.error("sum is zero",t),this.graphics([t])),!0)}backtrack(){const t=this.backtrackItemsLengths.pop()-this.droppedBacktrackItemsCount;this.debug&&console.warn("backtrack",t);const e=[],i=new Set(this.toPropagate.map(t=>t.join(",")));for(;this.backtrackItems.length>t;){let[t,s]=this.backtrackItems.pop();e.push(t);let n=this.compatible[t][s];for(let t=0;t<4;t++)n[t]+=this.T;this.wave[t][s]=!0,this.sumsOfOnes[t]+=1,this.sumsOfWeights[t]+=this.weights[s],this.sumsOfWeightLogWeights[t]+=this.weightLogWeights[s];let o=this.sumsOfWeights[t];if(this.entropies[t]=Math.log(o)-this.sumsOfWeightLogWeights[t]/o,!i.has([t,s].join(","))){let i=t%this.FMX,n=Math.floor(t/this.FMX);for(let t=0;t<4;t++){let o=i+Lt.DX[t],r=n+Lt.DY[t];if(this.onBoundary(o,r))continue;o<0?o+=this.FMX:o>=this.FMX&&(o-=this.FMX),r<0?r+=this.FMY:r>=this.FMY&&(r-=this.FMY);let h=o+r*this.FMX;e.push(h);const a=this.propagator[t][s];for(let e of a)this.compatible[h][e][t]++}}this.backtrackConstraint(t,s)}this.debug&&(console.log("backtracked"),this.graphics(e))}}Lt.DX=[-1,0,1,0],Lt.DY=[0,1,0,-1],Lt.opposite=[2,3,0,1];var It,Wt,Ut,Bt;!function(t){t[t.TOP=0]="TOP",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.LEFT=3]="LEFT"}(It||(It={}));class Ht{constructor(t=0,e=0){this.x=t,this.y=e}plus(t){return new Ht(this.x+t.x,this.y+t.y)}minus(t){return new Ht(this.x-t.x,this.y-t.y)}multiply(t){return new Ht(this.x*t,this.y*t)}get negative(){return new Ht(-this.x,-this.y)}equal(t,e){return this.x===t&&this.y===e}equals(t){return this.x===t.x&&this.y===t.y}toString(){return`{x: ${this.x}, y: ${this.y}}`}static from(t){return new Ht(t.x,t.y)}}Ht.NORTH=new Ht(-1,0),Ht.SOUTH=new Ht(1,0),Ht.EAST=new Ht(0,1),Ht.WEST=new Ht(0,-1),Ht.NORTH_EAST=new Ht(-1,1),Ht.SOUTH_EAST=new Ht(1,1),Ht.SOUTH_WEST=new Ht(1,-1),Ht.NORTH_WEST=new Ht(-1,-1),Ht.ZERO=new Ht(0,0),function(t){t[t.NORTH=0]="NORTH",t[t.EAST=1]="EAST",t[t.SOUTH=2]="SOUTH",t[t.WEST=3]="WEST",t[t.NORTH_EAST=4]="NORTH_EAST",t[t.SOUTH_EAST=5]="SOUTH_EAST",t[t.SOUTH_WEST=6]="SOUTH_WEST",t[t.NORTH_WEST=7]="NORTH_WEST"}(Wt||(Wt={})),function(t){t[t.OPEN=0]="OPEN",t[t.CLOSED=1]="CLOSED",t[t.GUARANTEED_OPEN=2]="GUARANTEED_OPEN",t[t.GUARANTEED_CLOSED=3]="GUARANTEED_CLOSED",t[t.NON_JOIN_OPEN=4]="NON_JOIN_OPEN",t[t.NON_JOIN_CLOSED=5]="NON_JOIN_CLOSED",t[t.NON_JOIN_GUARANTEED_OPEN=6]="NON_JOIN_GUARANTEED_OPEN",t[t.NON_JOIN_GUARANTEED_CLOSED=7]="NON_JOIN_GUARANTEED_CLOSED",t[t.INSIDE_ROOM_OPEN=8]="INSIDE_ROOM_OPEN",t[t.INSIDE_TUNNEL_OPEN=9]="INSIDE_TUNNEL_OPEN",t[t.INSIDE_ANTEROOM_OPEN=10]="INSIDE_ANTEROOM_OPEN",t[t.H_DOOR=11]="H_DOOR",t[t.V_DOOR=12]="V_DOOR",t[t.COLUMN=13]="COLUMN"}(Ut||(Ut={})),function(t){t[t.SMALL=0]="SMALL",t[t.MEDIUM=1]="MEDIUM",t[t.LARGE=2]="LARGE"}(Bt||(Bt={}));class Ft{constructor(t=[]){this.inside=t,this.inDungeon=!1}randomSquare(){return this.inside[Math.floor(Math.random()*this.inside.length)]}static compare(t,e){return t.inside.length-e.inside.length}}class zt{constructor(t,e,i,s,n){this.startX=t,this.startY=e,this.endX=i,this.endY=s,this.type=n}}class Gt{constructor(t,e,i,s,n,o,r){this.rng=t,this.dungeonCrawler=e,this.config=e.config,this.location=i,this.direction=s,this.age=n,this.maxAge=o,this.generation=r,console.assert(this.valid(i)),console.assert(this.validDirection(s))}rightDirection(){if(0===this.direction.x)return new Ht(this.direction.y,0);if(0===this.direction.y)return new Ht(0,-this.direction.x);throw"illegal direction"}valid(t){return t.x>=0&&t.y>=0&&t.x<this.config.width&&t.y<this.config.height}validDirection(t){return 0===t.x&&(-1===t.y||1===t.y)||0===t.y&&(-1===t.x||1===t.x)}frontFree(t,e,i,s){let n;if(console.assert(i>=1&&s>=1),console.assert(this.valid(t)),console.assert(0===e.x&&(1===e.y||-1===e.y)||0===e.y&&(1===e.x||-1===e.x)),0===e.x)n=new Ht(e.y,0);else{if(0!==e.y)throw"invalid heading";n=new Ht(0,-e.x)}const o=this.findFrontFree(i,s,t,n,e);return console.assert(o>=0),o>0&&(i=this.findLeftFree(i,o,t,n,e),s=this.findRightFree(s,o,t,n,e)),[o,i,s]}findFrontFree(t,e,i,s,n){let o=0;for(;;){o++;for(let r=-t;r<=e;r++){const t=i.plus(s.multiply(r)).plus(n.multiply(o));if(!this.valid(t))return Math.max(0,o-1);if(this.freePredicate(this.dungeonCrawler.getMap(t)))return Math.max(0,o-1)}}}findLeftFree(t,e,i,s,n){for(;;){t++;for(let o=1;o<=e;o++){const e=i.minus(s.multiply(t)).plus(n.multiply(o));if(!this.valid(e))return t-1;if(this.freePredicate(this.dungeonCrawler.getMap(e)))return t-1}}}findRightFree(t,e,i,s,n){for(;;){t++;for(let o=1;o<=e;o++){const e=i.plus(s.multiply(t)).plus(n.multiply(o));if(!this.valid(e))return t-1;if(this.freePredicate(this.dungeonCrawler.getMap(e)))return t-1}}}freePredicate(t){return t!==Ut.CLOSED&&t!==Ut.NON_JOIN_CLOSED}contains(t,...e){for(const i of e)if(t===i)return!0;return!1}}class jt extends Gt{constructor(t,e,i,s,n,o,r,h,a,l,c,d,u,p,g,f){super(t,e,i,s,n,o,r),this.intendedDirection=h,this.stepLength=a,this.opening=l,this.corridorWidth=c,this.straightSingleSpawnProbability=d,this.straightDoubleSpawnProbability=u,this.turnSingleSpawnProbability=p,this.turnDoubleSpawnProbability=g,this.changeDirectionProbability=f,console.assert(c>=0)}freePredicate(t){if(this.config.crawlersInTunnels&&this.config.crawlersInAnterooms){if(!this.contains(t,Ut.OPEN,Ut.NON_JOIN_OPEN,Ut.GUARANTEED_OPEN,Ut.INSIDE_TUNNEL_OPEN,Ut.INSIDE_ANTEROOM_OPEN,Ut.NON_JOIN_GUARANTEED_OPEN))return!0}else if(this.config.crawlersInTunnels){if(!this.contains(t,Ut.OPEN,Ut.NON_JOIN_OPEN,Ut.GUARANTEED_OPEN,Ut.INSIDE_TUNNEL_OPEN,Ut.NON_JOIN_GUARANTEED_OPEN))return!0}else if(!this.contains(t,Ut.OPEN,Ut.NON_JOIN_OPEN,Ut.GUARANTEED_OPEN,Ut.NON_JOIN_GUARANTEED_OPEN))return!0;return!1}stepAhead(){if(this.generation!==this.dungeonCrawler.activeGeneration)return console.assert(this.generation>this.dungeonCrawler.activeGeneration),!0;if(this.age++,this.age>=this.maxAge)return!1;if(this.age<0)return!0;let[t,e,i]=this.frontFree(this.location,this.direction,this.corridorWidth,this.corridorWidth);const s=this.rightDirection(),n=s.negative;let o=s;if(0===this.opening&&t<this.config.joinDistance&&this.join(t))return!1;let r=this.stepLength;if(t>this.corridorWidth){t-this.corridorWidth<this.stepLength&&(r=t-this.corridorWidth);for(let t=1;t<=r;t++)o=this.location.plus(this.direction.multiply(t)),1===this.opening?this.dungeonCrawler.setMap(o,Ut.CLOSED):(console.assert(0===this.opening),this.dungeonCrawler.setMap(o,Ut.NON_JOIN_CLOSED));this.location=o;let h=this.rng.range(0,100),a=this.generation+1,l=0;for(let t=0;t<=10;t++)if(l+=this.getChildDelayProbabilityForGenerationCrawlers(t),h<l){a=this.generation+t;break}const c={straightSingleSpawnProbability:this.dungeonCrawler.mutate(this.straightSingleSpawnProbability),straightDoubleSpawnProbability:this.dungeonCrawler.mutate(this.straightDoubleSpawnProbability),turnSingleSpawnProbability:this.dungeonCrawler.mutate(this.turnSingleSpawnProbability),turnDoubleSpawnProbability:this.dungeonCrawler.mutate(this.turnDoubleSpawnProbability),changeDirectionProbability:this.dungeonCrawler.mutate(this.changeDirectionProbability)};if(this.rng.range(0,100)<this.changeDirectionProbability){let t=this.direction;if(0===this.intendedDirection.x&&0===this.intendedDirection.y||this.intendedDirection.x===this.direction.x&&this.intendedDirection.y===this.direction.y){let t=this.rng.range(0,4);0===t?this.direction=s:1===t?this.direction=n:i>e||i===e&&this.rng.boolean()?this.direction=s:this.direction=n}else 0===this.intendedDirection.x||0===this.intendedDirection.y?this.direction=this.intendedDirection:(console.assert(!this.intendedDirection.equal(0,0)),this.direction=this.intendedDirection.minus(this.direction));this.rng.range(0,100)<this.turnDoubleSpawnProbability?(this.spawnWallCrawler(this.direction.negative,this.direction.negative,a,c),this.spawnWallCrawler(t,t,a,c)):this.rng.range(0,100)<this.turnSingleSpawnProbability&&this.spawnWallCrawler(this.direction.negative,this.direction.negative,a,c)}else this.rng.range(0,100)<this.straightDoubleSpawnProbability?(this.spawnWallCrawler(s,s,a,c),this.spawnWallCrawler(n,n,a,c)):this.rng.range(0,100)<this.straightSingleSpawnProbability&&(o=e>i||e===i&&this.rng.boolean()?n:s,0===this.rng.range(0,3)&&(o=o.negative),this.spawnWallCrawler(o,o,a,c))}else if(this.direction.equals(this.intendedDirection)||this.intendedDirection.equal(0,0)){let[t]=this.frontFree(this.location,s,this.corridorWidth,this.corridorWidth),[e]=this.frontFree(this.location,n,this.corridorWidth,this.corridorWidth);if(t<=this.corridorWidth&&e<=this.corridorWidth)return!1;t>2*this.corridorWidth+1&&e>2*this.corridorWidth+1?this.rng.boolean()?this.direction=s:this.direction=n:t>e?this.direction=s:e>t?this.direction=n:this.rng.boolean()?this.direction=s:this.direction=n}else if(0===this.intendedDirection.x||0===this.intendedDirection.y){let[t]=this.frontFree(this.location,this.intendedDirection,this.corridorWidth,this.corridorWidth);if(!(t>this.corridorWidth))return!1;this.direction=this.intendedDirection}else{console.assert(!this.intendedDirection.equal(0,0)),o=this.intendedDirection.minus(this.direction);let[t]=this.frontFree(this.location,o,this.corridorWidth,this.corridorWidth);if(!(t>this.corridorWidth))return!1;this.direction=o}return!0}spawnWallCrawler(t,e,i,s){this.rng.range(0,100)<this.config.noHeadingProbability&&(e=Ht.ZERO),this.dungeonCrawler.createWallCrawler(this.location,t,0,this.dungeonCrawler.getMaxAgeCrawlers(i),i,e,this.dungeonCrawler.getStepLength(i),1,this.dungeonCrawler.getCorridorWidth(i),s.straightSingleSpawnProbability,s.straightDoubleSpawnProbability,s.turnSingleSpawnProbability,s.turnDoubleSpawnProbability,s.changeDirectionProbability)}join(t){let e=this.rightDirection(),i=this.location.plus(this.direction.multiply(t+1));if(!this.valid(i))return!1;let s=this.dungeonCrawler.getMap(i);if(this.contains(s,Ut.CLOSED,Ut.GUARANTEED_CLOSED)){for(let e=1;e<=t;e++){const t=this.location.plus(this.direction.multiply(e));if(!this.valid(t))return!1;this.dungeonCrawler.setMap(t,Ut.NON_JOIN_CLOSED)}return!0}if(this.contains(s,Ut.NON_JOIN_CLOSED,Ut.NON_JOIN_GUARANTEED_CLOSED))return!1;let n=new Ht,o=0;for(let i=1;i<=this.corridorWidth;i++){let r=this.location.plus(e.multiply(i)).plus(this.direction.multiply(t+1));if(!this.valid(r))return!1;if(s=this.dungeonCrawler.getMap(r),this.contains(s,Ut.CLOSED,Ut.GUARANTEED_CLOSED,Ut.NON_JOIN_CLOSED,Ut.NON_JOIN_GUARANTEED_CLOSED)){n=r,o=i;break}if(r=this.location.minus(e.multiply(i).plus(this.direction.multiply(t+1))),!this.valid(r))return!1;if(s=this.dungeonCrawler.getMap(r),this.contains(s,Ut.CLOSED,Ut.GUARANTEED_CLOSED,Ut.NON_JOIN_CLOSED,Ut.NON_JOIN_GUARANTEED_CLOSED)){n=r,o=-i;break}}if(0!==n.x||0!==n.y)return!1;if(0!==o)return!1;if(this.contains(s,Ut.NON_JOIN_CLOSED,Ut.NON_JOIN_GUARANTEED_CLOSED))return!1;i=o<0?e:e.negative;let r,h,[a]=this.frontFree(n,i,1,1);if(o>0?(r=o,h=1):(r=-o,h=-1),a<r+1)return!1;for(let e=1;e<=t+1;e++){const t=this.location.plus(this.direction.multiply(e));if(!this.valid(t))return!1;this.dungeonCrawler.setMap(t,Ut.NON_JOIN_CLOSED)}for(let i=1;i<r;i++){const s=this.location.plus(e.multiply(i*h)).plus(this.direction.multiply(t+1));if(!this.valid(s))return!1;this.dungeonCrawler.setMap(s,Ut.NON_JOIN_CLOSED)}return!0}getChildDelayProbabilityForGenerationCrawlers(t){return 0<=t&&t<=10?this.config.childDelayProbabilityForGenerationCrawlers[t]:0}}class Xt extends Gt{constructor(t,e,i,s,n,o,r,h,a,l,c,d,u,p,g,f){super(t,e,i,s,n,o,r),this.intendedDirection=h,this.stepLength=a,this.tunnelWidth=l,this.straightDoubleSpawnProbability=c,this.turnDoubleSpawnProbability=d,this.changeDirectionProbability=u,this.makeRoomsRightProbability=p,this.makeRoomsLeftProbability=g,this.joinPreference=f}stepAhead(){const t=this.dungeonCrawler;if(this.generation!==t.activeGeneration)return console.assert(this.generation>t.activeGeneration),!0;if(this.age++,this.age>=this.maxAge)return!1;if(this.age<0)return!0;console.assert(this.tunnelWidth>=0);let[e,i,s]=this.frontFree(this.location,this.direction,this.tunnelWidth+1,this.tunnelWidth+1);if(0===e)return!1;let[n,o]=this.sidewaysBranchingRoomSizes(),r=this.rightDirection(),h=r.negative;const a=this.roomGeneration();if(e<2*this.stepLength||this.maxAge-1===this.age)return this.joinOrBuildTerminatingRoom(o,e,i,s,r,h);if(console.assert(e>=2*this.stepLength),console.assert(this.stepLength>0),this.buildTunnel(this.stepLength,this.tunnelWidth),this.rng.range(0,100)<this.makeRoomsRightProbability){let t=this.location.plus(this.direction.multiply(this.stepLength>>2)).plus(r.multiply(this.tunnelWidth));this.spawnRoomCrawler(t,r,-1,2,a,n,!1)}if(this.rng.range(0,100)<this.makeRoomsLeftProbability){let t=this.location.plus(this.direction.multiply(this.stepLength>>2)).plus(h.multiply(this.tunnelWidth));this.spawnRoomCrawler(t,h,-1,2,a,n,!1)}this.location=this.location.plus(this.direction.multiply(this.stepLength));const l=this.isAnteroomPossible(r,this.tunnelWidth+2,this.tunnelWidth+2,2*this.tunnelWidth+5),c=this.isAnteroomPossible(r,this.tunnelWidth+3,this.tunnelWidth+3,2*this.tunnelWidth+7);let d=!1,u=!1,p=this.rng.range(0,100);const g=this.getSizeUpProbability(this.generation);let f=g+this.getSizeDownProbability(this.generation);if(p<g?d=!0:p<f&&(u=!0),d&&!c)return!0;const m=this.isChangeDirection(),w=this.isSpawn(m);if(!m&&!w)return!0;const _=this.isSpawnRoom(w),y=this.rng.range(0,100);let b=this.generation+1;if(w)if(d)b=this.generation+this.config.sizeUpGenDelay;else{let t=0;for(let e=0;e<=10;e++)if(t+=this.getChildDelayProbabilityForGenerationTunnelCrawlers(e),y<t){b=this.generation+e;break}}const O=this.mutateOptions();let S=this.determineSpawnPoints(d,w,l,r,h);if(!0===S)return!0;const[x,E,v,N]=S;let T=!1,M=!1,k=this.direction,D=!1;if(m){let[t]=this.frontFree(E,r,this.tunnelWidth+1,this.tunnelWidth+1),[e]=this.frontFree(v,h,this.tunnelWidth+1,this.tunnelWidth+1);if(this.intendedDirection.equal(0,0)||this.intendedDirection.equals(this.direction)?d&&w?(console.assert(w),t<e||t===e&&this.rng.boolean()?t>0&&(this.location=E,this.direction=r,T=!0):e>0&&(this.location=v,this.direction=h,M=!0)):t>e||t===e&&this.rng.boolean()?t>0&&(this.location=E,this.direction=r,T=!0):e>0&&(this.location=v,this.direction=h,M=!0):0===this.intendedDirection.x||0===this.intendedDirection.y?(this.direction=this.intendedDirection,this.direction.equals(r)?t>0&&(T=!0,this.location=E):e>0&&(console.assert(this.direction.equals(h)),this.location=v,M=!0)):(console.assert(!this.intendedDirection.equal(0,0)),this.direction=this.intendedDirection.minus(this.direction),this.direction.equals(r)?t>0&&(T=!0,this.location=E):e>0&&(console.assert(this.direction.equals(h)),this.location=v,M=!0)),w){let t=Ht.ZERO,e=Ht.ZERO;if(M?(t=E,e=r):T?(t=v,e=h):D=!0,!D){let i=this.rng.range(0,100);_&&i<50?this.spawnRoomCrawler(t,e,0,2,a,o,N):this.spawnTunnelCrawler(d,u,t,e,b,e,O),_&&i>=50?this.spawnRoomCrawler(x,k,0,2,a,o,N):this.spawnTunnelCrawler(d,u,x,k,b,k,O)}}}else D=!0;if(D){this.location=x;const t=this.rng.range(0,100);_&&t<50?this.spawnRoomCrawler(E,r,0,2,a,o,N):this.spawnTunnelCrawler(d,u,E,r,b,r,O),_&&t>=50?this.spawnRoomCrawler(E,h,0,2,a,o,N):this.spawnTunnelCrawler(d,u,v,h,b,h,O)}return!0}isAnteroomPossible(t,e,i,s){const n=this.dungeonCrawler;let o=!1;console.assert(this.tunnelWidth>=0),console.assert(n.getMap(this.location)===Ut.INSIDE_TUNNEL_OPEN),n.setMap(this.location,Ut.CLOSED);for(let e=1;e<=this.tunnelWidth;e++)console.assert(n.getMap(this.location.plus(t.multiply(e)))===Ut.INSIDE_TUNNEL_OPEN),console.assert(n.getMap(this.location.minus(t.multiply(e)))===Ut.INSIDE_TUNNEL_OPEN),n.setMap(this.location.plus(t.multiply(e)),Ut.CLOSED),n.setMap(this.location.minus(t.multiply(e)),Ut.CLOSED);let[r]=this.frontFree(this.location.minus(this.direction),this.direction,e,i);r>=s&&(o=!0),n.setMap(this.location,Ut.INSIDE_TUNNEL_OPEN);for(let e=1;e<=this.tunnelWidth;e++)n.setMap(this.location.plus(t.multiply(e)),Ut.INSIDE_TUNNEL_OPEN),n.setMap(this.location.minus(t.multiply(e)),Ut.INSIDE_TUNNEL_OPEN);return o}determineSpawnPoints(t,e,i,s,n){const o=this.dungeonCrawler;if(t){if(this.rng.range(0,100)<this.getAnteroomProbability(this.tunnelWidth)||e){const t=this.buildAnteroom(2*this.tunnelWidth+5,this.tunnelWidth+2);return console.assert(t),[this.location.plus(this.direction.multiply(2*this.tunnelWidth+5)),this.location.plus(this.direction.multiply(this.tunnelWidth+3)).plus(s.multiply(this.tunnelWidth+2)),this.location.plus(this.direction.multiply(this.tunnelWidth+3)).plus(n.multiply(this.tunnelWidth+2)),!0]}}else if(this.rng.range(0,100)<this.getAnteroomProbability(this.tunnelWidth)&&i){const t=this.buildAnteroom(2*this.tunnelWidth+3,this.tunnelWidth+1);return console.assert(t),[this.location.plus(this.direction.multiply(2*this.tunnelWidth+3)),this.location.plus(this.direction.multiply(this.tunnelWidth+2)).plus(s.multiply(this.tunnelWidth+1)),this.location.plus(this.direction.multiply(this.tunnelWidth+2)).plus(n.multiply(this.tunnelWidth+1)),!0]}const r=this.location,h=this.location.minus(this.direction.multiply(this.tunnelWidth)).plus(s.multiply(this.tunnelWidth)),a=this.location.minus(this.direction.multiply(this.tunnelWidth)).plus(n.multiply(this.tunnelWidth));return this.dungeonCrawler.getMap(h)!==Ut.INSIDE_TUNNEL_OPEN||o.getMap(a)!==Ut.INSIDE_TUNNEL_OPEN||[r,h,a,!1]}joinOrBuildTerminatingRoom(t,e,i,s,n,o){const r=this.dungeonCrawler;let h=!1,a=!1,l=!1,c=0;for(let t=-this.tunnelWidth;t<=this.tunnelWidth;t++){const i=this.location.plus(this.direction.multiply(e+1)).plus(n.multiply(t)),s=r.getMap(i);this.contains(s,Ut.OPEN,Ut.GUARANTEED_OPEN,Ut.INSIDE_TUNNEL_OPEN,Ut.INSIDE_ANTEROOM_OPEN)?(a=!0,c++):this.contains(s,Ut.GUARANTEED_CLOSED,Ut.NON_JOIN_GUARANTEED_CLOSED)?(h=!0,c=0):s===Ut.INSIDE_ROOM_OPEN?(l=!0,c=0):c=0}if(this.rng.range(0,100)<=this.joinPreference&&(this.age<this.maxAge-1||e<=this.config.tunnelJoinDist)||e<5){const t=this.joinOtherTunnel(c,e,i,s,a,l,h,n);if(null!=t)return t}r.isMoreRoomsDungeon(t)&&this.spawnRoomCrawler(this.location,this.direction,0,2,this.generation,t,!1);let d=10*this.rng.range(0,11);if(100!==this.joinPreference||this.makeRoomsLeftProbability!==this.config.lastChanceTunnelCrawler.makeRoomsLeftProbability||this.makeRoomsRightProbability!==this.config.lastChanceTunnelCrawler.makeRoomsRightProbability||this.changeDirectionProbability!==this.config.lastChanceTunnelCrawler.changeDirectionProbability||this.straightDoubleSpawnProbability!==this.config.lastChanceTunnelCrawler.straightDoubleSpawnProbability||this.turnDoubleSpawnProbability!==this.config.lastChanceTunnelCrawler.turnDoubleSpawnProbability||0!==this.tunnelWidth){let[t]=this.frontFree(this.location.plus(n.multiply(this.tunnelWidth)),n,this.tunnelWidth+1,this.tunnelWidth+1),[i]=this.frontFree(this.location.minus(n.multiply(this.tunnelWidth)),o,this.tunnelWidth+1,this.tunnelWidth+1),[s]=this.frontFree(this.location,this.direction.negative,this.tunnelWidth+1,this.tunnelWidth+1);const r=(t,e,i,s)=>{this.dungeonCrawler.createTunnelCrawler(t,e,0,this.maxAge,i,s,3,0,this.config.lastChanceTunnelCrawler.straightDoubleSpawnProbability,this.config.lastChanceTunnelCrawler.turnDoubleSpawnProbability,this.config.lastChanceTunnelCrawler.changeDirectionProbability,this.config.lastChanceTunnelCrawler.makeRoomsRightProbability,this.config.lastChanceTunnelCrawler.makeRoomsLeftProbability,d)};0===this.tunnelWidth?this.makeRoomsLeftProbability===this.config.lastChanceTunnelCrawler.makeRoomsLeftProbability&&this.makeRoomsRightProbability===this.config.lastChanceTunnelCrawler.makeRoomsRightProbability&&this.changeDirectionProbability===this.config.lastChanceTunnelCrawler.changeDirectionProbability&&this.straightDoubleSpawnProbability===this.config.lastChanceTunnelCrawler.straightDoubleSpawnProbability&&this.turnDoubleSpawnProbability===this.config.lastChanceTunnelCrawler.turnDoubleSpawnProbability?e>=t&&e>=i&&e>=s?r(this.location,this.direction,this.generation+1,this.direction):s>=t&&s>=i?r(this.location,this.direction.negative,this.generation+this.config.genDelayLastChance,this.direction.negative):t>=i||t===i&&this.rng.range(0,100)<50?r(this.location,n,this.generation+this.config.genDelayLastChance,n):r(this.location,o,this.generation+this.config.genDelayLastChance,o):r(this.location,this.direction,this.generation+this.config.genDelayLastChance,this.direction):h?(r(this.location.plus(n.multiply(this.tunnelWidth)),n,this.generation+this.config.genDelayLastChance,n),r(this.location.minus(n.multiply(this.tunnelWidth)),o,this.generation+this.config.genDelayLastChance,o)):t>=i||t===i&&this.rng.range(0,100)<50?(r(this.location.plus(n.multiply(this.tunnelWidth)),n,this.generation+this.config.genDelayLastChance,n),r(this.location.minus(n.multiply(this.tunnelWidth)),this.direction,this.generation+this.config.genDelayLastChance,this.direction)):(r(this.location.plus(n.multiply(this.tunnelWidth)),this.direction,this.generation+this.config.genDelayLastChance,this.direction),r(this.location.minus(n.multiply(this.tunnelWidth)),this.direction,this.generation+this.config.genDelayLastChance,this.direction))}return!1}joinOtherTunnel(t,e,i,s,n,o,r,h){const a=this.dungeonCrawler;if(2*this.tunnelWidth+1===t)return this.buildTunnel(e,this.tunnelWidth),!1;if(n)return this.buildSmallerTunnel(e,a,h);if(o&&0===this.tunnelWidth&&e>1){const t=this.location.plus(this.direction.multiply(e+1)),i=a.getMap(t);return console.assert(i===Ut.INSIDE_ROOM_OPEN),this.buildTunnel(e-1,0),0===this.direction.x?a.setMap(this.location.plus(this.direction.multiply(e)),Ut.V_DOOR):(console.assert(0===this.direction.y),a.setMap(this.location.plus(this.direction.multiply(e)),Ut.H_DOOR)),!1}if(r&&0===this.tunnelWidth){if(100!==this.joinPreference||20!==this.makeRoomsLeftProbability||20!==this.makeRoomsRightProbability||30!==this.changeDirectionProbability||0!==this.straightDoubleSpawnProbability||0!==this.turnDoubleSpawnProbability||0!==this.tunnelWidth){const t=10*this.rng.range(0,11),e=i>=s?h.negative:h;a.createTunnelCrawler(this.location,e,0,this.maxAge,this.generation+1,e,3,0,0,0,30,20,20,t)}return!1}if(!n&&!r){if(this.isSpecialCase(e,h)){const t=this.buildTunnel(e,this.tunnelWidth);console.assert(t);for(let t=-this.tunnelWidth;t<=this.tunnelWidth;t++)a.setMap(this.location.plus(this.direction.multiply(e+1)).plus(h.multiply(t)),Ut.INSIDE_TUNNEL_OPEN);let i=e+2,s=!0,n=!0;for(;s&&n;){for(let t=-this.tunnelWidth;t<=this.tunnelWidth;t++){const e=this.location.plus(this.direction.multiply(i)).plus(h.multiply(t));if(a.getMap(e)!==Ut.CLOSED){s=!1;break}}let t=this.location.plus(this.direction.multiply(i)).plus(h.multiply(this.tunnelWidth+1)),e=this.location.plus(this.direction.multiply(i)).minus(h.multiply(this.tunnelWidth+1)),o=a.getMap(t),r=a.getMap(e);if(!this.contains(o,Ut.OPEN,Ut.GUARANTEED_OPEN,Ut.INSIDE_TUNNEL_OPEN,Ut.INSIDE_ANTEROOM_OPEN)&&!this.contains(r,Ut.OPEN,Ut.GUARANTEED_OPEN,Ut.INSIDE_TUNNEL_OPEN,Ut.INSIDE_ANTEROOM_OPEN)){s=!1;break}if(o===Ut.INSIDE_ROOM_OPEN||r===Ut.INSIDE_ROOM_OPEN){s=!1;break}for(let t=-this.tunnelWidth;t<=this.tunnelWidth;t++){const e=this.location.plus(this.direction.multiply(i+1)).plus(h.multiply(t));a.getMap(e)!==Ut.CLOSED&&(n=!1)}t=this.location.plus(this.direction.multiply(i+1)).plus(h.multiply(this.tunnelWidth+1)),e=this.location.plus(this.direction.multiply(i+1)).minus(h.multiply(this.tunnelWidth+1)),o=a.getMap(t),r=a.getMap(e),this.contains(o,Ut.OPEN,Ut.GUARANTEED_OPEN,Ut.INSIDE_TUNNEL_OPEN,Ut.INSIDE_ANTEROOM_OPEN,Ut.CLOSED)||this.contains(r,Ut.OPEN,Ut.GUARANTEED_OPEN,Ut.INSIDE_TUNNEL_OPEN,Ut.INSIDE_ANTEROOM_OPEN,Ut.CLOSED)||(n=!1),o!==Ut.INSIDE_ROOM_OPEN&&r!==Ut.INSIDE_ROOM_OPEN||(n=!1);let l=!0;for(let t=-this.tunnelWidth-1;t<=this.tunnelWidth+1;t++){const e=this.location.plus(this.direction.multiply(i+1)).plus(h.multiply(t)),s=a.getMap(e);s!==Ut.INSIDE_TUNNEL_OPEN&&s!==Ut.INSIDE_ANTEROOM_OPEN&&(l=!1)}if(l&&(n=!0),s&&n)for(let t=-this.tunnelWidth;t<=this.tunnelWidth;t++)a.setMap(this.location.plus(this.direction.multiply(i)).plus(h.multiply(t)),Ut.INSIDE_TUNNEL_OPEN);i++}return!1}if(0===this.tunnelWidth&&a.getMap(this.location.plus(this.direction.multiply(e+1)))===Ut.CLOSED){if(a.getMap(this.location.plus(this.direction.multiply(e+1)).plus(h))===Ut.INSIDE_ROOM_OPEN)return this.direction=h.negative,this.direction.equals(this.intendedDirection.negative)&&(this.direction=this.intendedDirection),!0;if(a.getMap(this.location.plus(this.direction.multiply(e+1)).minus(h))===Ut.INSIDE_ROOM_OPEN)return this.direction=h,this.direction.equals(this.intendedDirection.negative)&&(this.direction=this.intendedDirection),!0}}return null}isSpecialCase(t,e){const i=this.dungeonCrawler;let s=!0;for(let n=-this.tunnelWidth;n<=this.tunnelWidth;n++){const o=this.location.plus(this.direction.multiply(t+1)).plus(e.multiply(n));if(i.getMap(o)!==Ut.CLOSED){s=!1;break}}let n=this.location.plus(this.direction.multiply(t+1)).plus(e.multiply(this.tunnelWidth+1)),o=this.location.plus(this.direction.multiply(t+1)).minus(e.multiply(this.tunnelWidth+1)),r=i.getMap(n),h=i.getMap(o);this.contains(r,Ut.OPEN,Ut.GUARANTEED_OPEN,Ut.INSIDE_TUNNEL_OPEN,Ut.INSIDE_ANTEROOM_OPEN)||this.contains(h,Ut.OPEN,Ut.GUARANTEED_OPEN,Ut.INSIDE_TUNNEL_OPEN,Ut.INSIDE_ANTEROOM_OPEN)||(s=!1),r!==Ut.INSIDE_ROOM_OPEN&&h!==Ut.INSIDE_ROOM_OPEN||(s=!1);for(let n=-this.tunnelWidth-1;n<=this.tunnelWidth+1;n++){const o=this.location.plus(this.direction.multiply(t+2)).plus(e.multiply(n));if(i.getMap(o)===Ut.INSIDE_ROOM_OPEN){s=!1;break}}return s}spawnTunnelCrawler(t,e,i,s,n,o,r){let h=this.tunnelWidth,a=this.stepLength;t?(h++,a+=2):e&&(h--,h<0&&(h=0),a-=2,a<3&&(a=3)),this.dungeonCrawler.createTunnelCrawler(i,s,0,this.getMaxAgeTunnelCrawlers(n),n,o,a,h,r.straightDoubleSpawnProbability,r.turnDoubleSpawnProbability,r.changeDirectionProbability,r.makeRoomsRightProbability,r.makeRoomsLeftProbability,r.joinPreference)}spawnRoomCrawler(t,e,i,s,n,o,r){const h=Math.max(1,2*this.tunnelWidth);r&&(n=this.generation+Math.floor((n-this.generation)/this.config.genSpeedUpOnAnteroom)),this.dungeonCrawler.createRoomCrawler(t,e,i,s,n,h,o)}buildSmallerTunnel(t,e,i){const s=this.location.plus(this.direction.multiply(t+1)),n=e.getMap(s);if(this.contains(n,Ut.OPEN,Ut.GUARANTEED_OPEN,Ut.INSIDE_TUNNEL_OPEN,Ut.INSIDE_ANTEROOM_OPEN))return this.buildTunnel(t,0)||console.error("openAhead, failed to join, frontFree = "+t),!1;let o=0;for(let s=1;s<=this.tunnelWidth;s++){const n=this.location.plus(this.direction.multiply(t+1)).plus(i.multiply(s)),r=e.getMap(n);if(this.contains(r,Ut.OPEN,Ut.GUARANTEED_OPEN,Ut.INSIDE_TUNNEL_OPEN,Ut.INSIDE_ANTEROOM_OPEN)){o=s;break}const h=this.location.plus(this.direction.multiply(t+1)).minus(i.multiply(s)),a=e.getMap(h);if(this.contains(a,Ut.OPEN,Ut.GUARANTEED_OPEN,Ut.INSIDE_TUNNEL_OPEN,Ut.INSIDE_ANTEROOM_OPEN)){o=-s;break}}console.assert(0!==o);for(let s=1;s<=t;s++){const t=this.location.plus(this.direction.multiply(s)).plus(i.multiply(o));e.setMap(t,Ut.INSIDE_TUNNEL_OPEN)}return!1}roomGeneration(){let t=this.rng.range(0,100),e=this.generation,i=0;for(let s=0;s<=10;s++)if(i+=this.getChildDelayProbabilityForGenerationRoomCrawlers(s),t<i){e=this.generation+s;break}return e}sidewaysBranchingRoomSizes(){let t,e;const i=this.getRoomSizeProbabilitySideways(this.tunnelWidth,Bt.MEDIUM),s=this.getRoomSizeProbabilitySideways(this.tunnelWidth,Bt.SMALL),n=this.getRoomSizeProbabilityBranching(this.tunnelWidth,Bt.MEDIUM),o=this.getRoomSizeProbabilityBranching(this.tunnelWidth,Bt.SMALL);let r=this.rng.range(0,100);return t=r<s?Bt.SMALL:r<s+i?Bt.MEDIUM:Bt.LARGE,e=r<o?Bt.SMALL:r<o+n?Bt.MEDIUM:Bt.LARGE,[t,e]}isChangeDirection(){return this.rng.range(0,100)<this.changeDirectionProbability}isSpawn(t){return!!(t&&this.rng.range(0,100)<this.turnDoubleSpawnProbability)||!t&&this.rng.range(0,100)<this.straightDoubleSpawnProbability}isSpawnRoom(t){return t&&this.rng.range(0,100)>this.config.patience}buildAnteroom(t,e){if(t<3||e<1)return console.error("Anteroom must be at least 3x3"),!1;let[i]=this.frontFree(this.location,this.direction,e+1,e+1);if(i<=t)return!1;const s=this.rightDirection();for(let i=1;i<=t;i++)for(let t=-e;t<=e;t++){const e=this.location.plus(this.direction.multiply(i)).plus(s.multiply(t));this.dungeonCrawler.setMap(e,Ut.INSIDE_ANTEROOM_OPEN)}if(e>=3&&t>=7&&this.config.columnsInTunnels){let t=2;this.placeColumns(e,t,s)}return!0}buildTunnel(t,e){if(t<1||e<0)return console.error("Trying to build zero size tunnel with length = "+t+"; width =  "+e),!1;let[i]=this.frontFree(this.location,this.direction,e+1,e+1);if(i<t)return!1;const s=this.rightDirection();for(let i=1;i<=t;i++)for(let t=-e;t<=e;t++){const e=this.location.plus(this.direction.multiply(i)).plus(s.multiply(t));this.dungeonCrawler.setMap(e,Ut.INSIDE_TUNNEL_OPEN)}if(e>=3&&t>=7&&this.config.columnsInTunnels){const i=Math.floor((t-1)/6);console.assert(i>0);for(let t=0;t<i;t++){let i=2+3*t;this.placeColumns(e,i,s)}}return!0}placeColumns(t,e,i){let s=1-t,n=this.location.plus(this.direction.multiply(e)).plus(i.multiply(s));this.dungeonCrawler.setMap(n,Ut.COLUMN),s=t-1,n=this.location.plus(this.direction.multiply(e)).plus(i.multiply(s)),this.dungeonCrawler.setMap(n,Ut.COLUMN),e-=1,s=1-t,n=this.location.plus(this.direction.multiply(e)).plus(i.multiply(s)),this.dungeonCrawler.setMap(n,Ut.COLUMN),s=t-1,n=this.location.plus(this.direction.multiply(e)).plus(i.multiply(s)),this.dungeonCrawler.setMap(n,Ut.COLUMN)}getChildDelayProbabilityForGenerationRoomCrawlers(t){return 0<=t&&t<=10?this.config.childDelayProbabilityForGenerationRoomCrawlers[t]:0}getChildDelayProbabilityForGenerationTunnelCrawlers(t){return 0<=t&&t<=10?this.config.childDelayProbabilityForGenerationTunnelCrawlers[t]:0}getAnteroomProbability(t){return t>=this.config.anteroomProbability.length?100:this.config.anteroomProbability[t]}getSizeUpProbability(t){return t>=this.config.sizeUpProbability.length?this.config.sizeUpProbability[this.config.sizeUpProbability.length-1]:this.config.sizeUpProbability[t]}getSizeDownProbability(t){return t>=this.config.sizeDownProbability.length?this.config.sizeDownProbability[this.config.sizeDownProbability.length-1]:this.config.sizeDownProbability[t]}getMaxAgeTunnelCrawlers(t){return t>=this.config.maxAgesTunnelCrawlers.length?this.config.maxAgesTunnelCrawlers[this.config.maxAgesTunnelCrawlers.length-1]:this.config.maxAgesTunnelCrawlers[t]}getRoomSizeProbabilitySideways(t,e){if(t>=this.config.roomSizeProbabilitySidewaysRooms.length)return Bt.LARGE===e?100:0;switch(e){case Bt.LARGE:return this.config.roomSizeProbabilitySidewaysRooms[t][2];case Bt.MEDIUM:return this.config.roomSizeProbabilitySidewaysRooms[t][1];case Bt.SMALL:return this.config.roomSizeProbabilitySidewaysRooms[t][0]}}getRoomSizeProbabilityBranching(t,e){if(t>=this.config.roomSizeProbabilityBranching.length)return Bt.LARGE===e?100:0;switch(e){case Bt.LARGE:return this.config.roomSizeProbabilityBranching[t][2];case Bt.MEDIUM:return this.config.roomSizeProbabilityBranching[t][1];case Bt.SMALL:return this.config.roomSizeProbabilityBranching[t][0]}}mutateOptions(){return{straightDoubleSpawnProbability:this.dungeonCrawler.mutate(this.straightDoubleSpawnProbability),turnDoubleSpawnProbability:this.dungeonCrawler.mutate(this.turnDoubleSpawnProbability),changeDirectionProbability:this.dungeonCrawler.mutate(this.changeDirectionProbability),makeRoomsRightProbability:this.dungeonCrawler.mutate(this.makeRoomsRightProbability),makeRoomsLeftProbability:this.dungeonCrawler.mutate(this.makeRoomsLeftProbability),joinPreference:this.dungeonCrawler.mutate(this.joinPreference)}}}class qt extends Gt{constructor(t,e,i,s,n,o,r,h,a){super(t,e,i,s,n,o,r),this.defaultWidth=h,this.size=a}stepAhead(){if(!this.dungeonCrawler.isMoreRoomsDungeon(this.size))return!1;if(this.generation!==this.dungeonCrawler.activeGeneration)return console.assert(this.generation>this.dungeonCrawler.activeGeneration),!0;if(this.age++,this.age>=this.maxAge)return!1;if(this.age<0)return!0;const t=this.rightDirection();let e=this.defaultWidth;const i=this.getMinRoomSize(this.size),s=this.getMaxRoomSize(this.size);let n,o,r;do{[r,n,o]=this.frontFree(this.location,this.direction,e+1,e+1);let h=r-2,a=n+o-1;if(h<2)break;if(a/h<this.config.roomAspectRatio&&(h=Math.floor(a/this.config.roomAspectRatio),a/h<this.config.roomAspectRatio&&console.error("length = "+h+", width = "+a+", but width/length should be >= "+this.config.roomAspectRatio)),h/a<this.config.roomAspectRatio&&(a=Math.floor(h/this.config.roomAspectRatio),h/a<this.config.roomAspectRatio&&console.error("length = "+h+", width = "+a+", but length/width should be >= "+this.config.roomAspectRatio)),a/h<this.config.roomAspectRatio)return console.error("The Emperor suggests you make your roomAspectRatio in the design file smaller..."),!1;for(;h*a>s;)h>a?h--:a>h?a--:this.rng.range(0,100)<50?h--:a--;if(console.assert(h*a<=s),h*a>=i){const e=new Ft;return n<=o?(2*n-1>a?this.attachRoom(e,t,h,(a>>1)-a+1,a>>2):this.attachRoom(e,t,h,1-n,-n+a),0===this.direction.x?this.dungeonCrawler.setMap(this.location.plus(this.direction),Ut.V_DOOR):(console.assert(0===this.direction.y),this.dungeonCrawler.setMap(this.location.plus(this.direction),Ut.H_DOOR))):(2*o-1>a?this.attachRoom(e,t,h,-(a>>1),-(a>>1)+a-1):this.attachRoom(e,t,h,o-a,o-1),0===this.direction.x?this.dungeonCrawler.setMap(this.location.plus(this.direction),Ut.V_DOOR):(console.assert(0===this.direction.y),this.dungeonCrawler.setMap(this.location.plus(this.direction),Ut.H_DOOR))),this.dungeonCrawler.builtRoomDungeon(this.size),e.inDungeon=!0,this.dungeonCrawler.addRoom(e),!1}e++}while(r-2>=(2*e+1)*this.config.roomAspectRatio);return!1}attachRoom(t,e,i,s,n){for(let o=1;o<=i;o++)for(let i=s;i<=n;i++){const s=this.location.plus(this.direction.multiply(o+1)).plus(e.multiply(i));this.dungeonCrawler.setMap(s,Ut.INSIDE_ROOM_OPEN),t.inside.push(s)}}getMinRoomSize(t){switch(t){case Bt.SMALL:return this.config.minRoomSize;case Bt.MEDIUM:return this.config.mediumRoomSize;case Bt.LARGE:return this.config.largeRoomSize}}getMaxRoomSize(t){switch(t){case Bt.SMALL:return this.config.mediumRoomSize-1;case Bt.MEDIUM:return this.config.largeRoomSize-1;case Bt.LARGE:return this.config.maxRoomSize-1}}}class $t{constructor(t,e){this.rooms=[],this.mapFlagsDirections=[],this.crawlers=[],this.activeGeneration=0,this.currSmallRoomsLabyrinth=0,this.currMediumRoomsLabyrinth=0,this.currLargeRoomsLabyrinth=0,this.currSmallRoomsDungeon=0,this.currMediumRoomsDungeon=0,this.currLargeRoomsDungeon=0,this.rng=e,this.config=t,console.assert(11===t.childDelayProbabilityForGenerationCrawlers.length),console.assert(11===t.childDelayProbabilityForGenerationRoomCrawlers.length),console.assert(t.roomAspectRatio>=0&&t.roomAspectRatio<=1,"roomAspectRatio must be a double between 0 and 1"),console.assert(t.genSpeedUpOnAnteroom>=1,"Please use genSpeedUpOnAnteroom >= 1; parameter reset to 1"),console.assert(!t.crawlersInAnterooms||t.crawlersInAnterooms&&t.crawlersInTunnels,"when you allow Crawlers in Anterooms, you must also allow them in Tunnels"),this.map=[];for(let t=0;t<this.config.width*this.config.height;t++)this.map[t]=this.config.background,this.mapFlagsDirections[t]=!1;for(let t=0;t<4;t++)this.crawlers[t]=null;this.setRect(0,0,this.config.width-1,0,Ut.GUARANTEED_CLOSED),this.setRect(0,0,0,this.config.height-1,Ut.GUARANTEED_CLOSED),this.setRect(this.config.width-1,0,this.config.width-1,this.config.height-1,Ut.GUARANTEED_CLOSED),this.setRect(0,this.config.height-1,this.config.width-1,this.config.height-1,Ut.GUARANTEED_CLOSED);for(const t of this.config.design)this.setRectFill(t);for(const t of this.config.openings)switch(t){case Wt.NORTH:this.setRect(0,Math.floor(this.config.height/2)-1,2,Math.floor(this.config.height/2)+1,Ut.GUARANTEED_OPEN);break;case Wt.WEST:this.setRect(Math.floor(this.config.width/2)-1,0,Math.floor(this.config.width/2)+1,2,Ut.GUARANTEED_OPEN);break;case Wt.EAST:this.setRect(Math.floor(this.config.width/2)-1,this.config.height-3,Math.floor(this.config.width/2)+1,this.config.height-1,Ut.GUARANTEED_OPEN);break;case Wt.SOUTH:this.setRect(this.config.width-3,Math.floor(this.config.height/2)-1,this.config.width-1,Math.floor(this.config.height/2)+1,Ut.GUARANTEED_OPEN);break;case Wt.NORTH_WEST:this.setRect(0,0,2,2,Ut.GUARANTEED_OPEN);break;case Wt.NORTH_EAST:this.setRect(0,this.config.height-3,2,this.config.height-1,Ut.GUARANTEED_OPEN);break;case Wt.SOUTH_WEST:this.setRect(this.config.width-3,0,this.config.width-1,2,Ut.GUARANTEED_OPEN);break;case Wt.SOUTH_EAST:this.setRect(this.config.width-3,this.config.height-3,this.config.width-1,this.config.height-1,Ut.GUARANTEED_OPEN);break;default:console.assert(!1)}const i=(e,i,s)=>{this.createWallCrawler(e,i,0,this.getMaxAgeCrawlers(s),s,i,this.getStepLength(s),1,this.getCorridorWidth(s),this.mutate2(t.randCrawler.straightSingleSpawnProbability),this.mutate2(t.randCrawler.straightDoubleSpawnProbability),this.mutate2(t.randCrawler.turnSingleSpawnProbability),this.mutate2(t.randCrawler.turnDoubleSpawnProbability),this.mutate2(t.randCrawler.changeDirectionProbability))};for(let e=0;e<t.randCrawler.perGeneration.length;e++){let s=t.randCrawler.perGeneration[e];if(s>0){let t=Math.floor(this.config.height*s/1e3);0===t&&this.rng.range(0,1e3)<this.config.height*s&&(t=1);let n=0;for(let s=0;s<t;s++)n=2+this.rng.range(0,this.config.height-4),i(new Ht(0,n),Ht.SOUTH,e),n=2+this.rng.range(0,this.config.height-4),i(new Ht(this.config.width-1,n),Ht.NORTH,e);let o=Math.floor(this.config.width*s/1e3);0===o&&this.rng.range(0,1e3)<this.config.width*s&&(o=1);let r=0;for(let t=0;t<o;t++)r=2+this.rng.range(0,this.config.width-4),i(new Ht(r,0),Ht.EAST,e),r=2+this.rng.range(0,this.config.width-4),i(new Ht(r,this.config.height-1),Ht.EAST,e)}}for(const e of t.crawlers)this.createWallCrawler(e.location,e.direction,-e.age,e.maxAge,e.generation,e.intendedDirection,e.stepLength,e.opening,e.corridorWidth,e.straightSingleSpawnProbability,e.straightDoubleSpawnProbability,e.turnSingleSpawnProbability,e.turnDoubleSpawnProbability,e.changeDirectionProbability);for(let[e,i]of t.crawlerPairs){let t=!0;this.rng.boolean()&&(t=!1),this.createWallCrawler(e.location,e.direction,-e.age,e.maxAge,e.generation,e.intendedDirection,e.stepLength,t?1:0,e.corridorWidth,e.straightSingleSpawnProbability,e.straightDoubleSpawnProbability,e.turnSingleSpawnProbability,e.turnDoubleSpawnProbability,e.changeDirectionProbability),this.setMap(e.location,Ut.CLOSED),this.createWallCrawler(i.location,i.direction,-i.age,i.maxAge,i.generation,i.intendedDirection,i.stepLength,t?1:0,i.corridorWidth,i.straightSingleSpawnProbability,i.straightDoubleSpawnProbability,i.turnSingleSpawnProbability,i.turnDoubleSpawnProbability,i.changeDirectionProbability),this.setMap(i.location,Ut.CLOSED)}for(let e of t.tunnelCrawlers)this.createTunnelCrawler(e.location,e.direction,-e.age,e.maxAge,e.generation,e.intendedDirection,e.stepLength,e.tunnelWidth,e.straightDoubleSpawnProbability,e.turnDoubleSpawnProbability,e.changeDirectionProbability,e.makeRoomsRightProbability,e.makeRoomsLeftProbability,e.joinPreference)}isOpen(t){let e=this.getMap(t);return e===Ut.OPEN||e===Ut.NON_JOIN_OPEN||e===Ut.INSIDE_TUNNEL_OPEN||e===Ut.INSIDE_ANTEROOM_OPEN||e===Ut.GUARANTEED_OPEN||e===Ut.NON_JOIN_GUARANTEED_OPEN}static isActive(t,e){for(let i of e)if(t.x===i.x&&t.y===i.y)return!0;return!1}setMap(t,e){const i=t.x,s=t.y;console.assert(void 0!==e),console.assert(i<this.config.width&&s<this.config.height&&i>=0&&s>=0),this.map[i*this.config.height+s]=e}getMap(t){const e=t.x,i=t.y;return console.assert(e<this.config.width&&i<this.config.height&&e>=0&&i>=0),this.map[e*this.config.height+i]}isMapOpen(t){switch(this.getMap(t)){case Ut.OPEN:case Ut.GUARANTEED_OPEN:case Ut.NON_JOIN_OPEN:case Ut.NON_JOIN_GUARANTEED_OPEN:case Ut.INSIDE_ROOM_OPEN:case Ut.INSIDE_TUNNEL_OPEN:case Ut.INSIDE_ANTEROOM_OPEN:case Ut.H_DOOR:case Ut.V_DOOR:return!0;default:return!1}}isMoreRoomsLabyrinth(t=null){if(null===t)return this.isMoreRoomsLabyrinth(Bt.SMALL)||this.isMoreRoomsLabyrinth(Bt.MEDIUM)||this.isMoreRoomsLabyrinth(Bt.LARGE);switch(t){case Bt.SMALL:return this.config.numSmallRoomsInLabyrinth>this.currSmallRoomsLabyrinth;case Bt.MEDIUM:return this.config.numMediumRoomsInLabyrinth>this.currMediumRoomsLabyrinth;case Bt.LARGE:return this.config.numLargeRoomsInLabyrinth>this.currLargeRoomsLabyrinth}}isMoreRoomsDungeon(t){if(null===t)return this.isMoreRoomsDungeon(Bt.SMALL)||this.isMoreRoomsDungeon(Bt.MEDIUM)||this.isMoreRoomsDungeon(Bt.LARGE);switch(t){case Bt.SMALL:return this.config.numSmallRoomsInDungeon>this.currSmallRoomsDungeon;case Bt.MEDIUM:return this.config.numMediumRoomsInDungeon>this.currMediumRoomsDungeon;case Bt.LARGE:return this.config.numLargeRoomsInDungeon>this.currLargeRoomsDungeon}}builtRoomDungeon(t){Bt.SMALL===t?this.currSmallRoomsDungeon++:Bt.MEDIUM===t?this.currMediumRoomsDungeon++:Bt.LARGE===t&&this.currLargeRoomsDungeon++}getStepLength(t){return t>=this.config.stepLengths.length?this.config.stepLengths[this.config.stepLengths.length-1]:this.config.stepLengths[t]}getCorridorWidth(t){return t>=this.config.corridorWidths.length?this.config.corridorWidths[this.config.corridorWidths.length-1]:this.config.corridorWidths[t]}getMaxAgeCrawlers(t){return t>=this.config.maxAgesCrawlers.length?this.config.maxAgesCrawlers[this.config.maxAgesCrawlers.length-1]:this.config.maxAgesCrawlers[t]}addRoom(t){this.rooms.push(t)}isChecked(t){return console.assert(t.x<this.config.width&&t.y<this.config.height&&t.x>=0&&t.y>=0),this.mapFlagsDirections[t.x*this.config.height+t.y]}static isCheckedList(t,e){for(let i=0;i<e.length;i++)if(t.x===e[i].x&&t.y===e[i].y)return!0;return!1}setChecked(t){console.assert(t.x<this.config.width&&t.y<this.config.height&&t.x>=0&&t.y>=0),this.mapFlagsDirections[t.x*this.config.height+t.y]=!0}setRectFill(t){this.setRect(t.startX,t.startY,t.endX,t.endY,t.type)}setRect(t,e,i,s,n){if(i<t||s<e)console.error(`Refuse to set incorrectly specified rectangle; sX = ${t} sY=${e} eX=${i} endY=${s}`);else for(let o=t;o<=i;o++)for(let t=e;t<=s;t++)this.setMap({x:o,y:t},n)}createWallCrawler(t,e,i,s,n,o,r,h,a,l,c,d,u,p){let g=new jt(this.rng,this,Ht.from(t),Ht.from(e),i,s,n,Ht.from(o),r,h,a,l,c,d,u,p);for(let t=0;t<this.crawlers.length;t++)if(null===this.crawlers[t])return void(this.crawlers[t]=g);this.crawlers.push(g)}createTunnelCrawler(t,e,i,s,n,o,r,h,a,l,c,d,u,p){let g=new Xt(this.rng,this,Ht.from(t),Ht.from(e),i,s,n,Ht.from(o),r,h,a,l,c,d,u,p);for(let t=0;t<this.crawlers.length;t++)if(null===this.crawlers[t])return void(this.crawlers[t]=g);this.crawlers.push(g)}createRoomCrawler(t,e,i,s,n,o,r){const h=new qt(this.rng,this,Ht.from(t),Ht.from(e),i,s,n,o,r);for(let t=0;t<this.crawlers.length;t++)if(null===this.crawlers[t])return void(this.crawlers[t]=h);this.crawlers.push(h)}mutate(t){let e=t-this.config.mutator+this.rng.range(0,2*this.config.mutator+1);return e<0?0:e}mutate2(t){return t<=50?t<0?0:this.rng.range(0,2*t+1):t>100?100:2*t-100+this.rng.range(0,200-2*t+1)}createSeedCrawlersInTunnels(){let t=0,e=0;for(new jt(this.rng,this,new Ht(2,2),Ht.SOUTH,0,1,0,Ht.SOUTH,1,0,1,0,0,0,0,0);t<this.config.seedCrawlersInTunnels&&e<this.config.width*this.config.height;){e++;let i=1+this.rng.range(0,this.config.width-4),s=1+this.rng.range(0,this.config.height-4),n=new Ht(i,s);this.rng.range(0,100)<50?i=0:s=0,0===i?s=this.rng.range(0,100)<50?-1:1:(console.assert(0===s),i=this.rng.range(0,100)<50?-1:1);let o,r=new Ht(i,s);if(0===r.x)o=new Ht(r.y,0);else{if(0!==r.y)throw"illegal direction";o=new Ht(0,-r.x)}let h=!0;for(;h&&(n=n.plus(r),!(n.x<2||n.y<2||n.x>this.config.width-3||n.y>this.config.height-3));)this.getMap(n)===Ut.INSIDE_TUNNEL_OPEN&&this.getMap(n.plus(r))===Ut.INSIDE_TUNNEL_OPEN&&this.getMap(n.minus(r))===Ut.INSIDE_TUNNEL_OPEN&&this.getMap(n.plus(o))===Ut.INSIDE_TUNNEL_OPEN&&this.getMap(n.minus(o))===Ut.INSIDE_TUNNEL_OPEN&&this.getMap(n.plus(r).plus(o))===Ut.INSIDE_TUNNEL_OPEN&&this.getMap(n.minus(r).plus(o))===Ut.INSIDE_TUNNEL_OPEN&&this.getMap(n.plus(r).minus(o))===Ut.INSIDE_TUNNEL_OPEN&&this.getMap(n.minus(r).minus(o))===Ut.INSIDE_TUNNEL_OPEN&&(this.setMap(n,Ut.CLOSED),this.createWallCrawler(n,r,0,this.config.tunnelCrawlerStats.maxAge,this.activeGeneration+1,r,this.config.tunnelCrawlerStats.stepLength,1,1,this.config.tunnelCrawlerStats.straightSingleSpawnProbability,this.config.tunnelCrawlerStats.straightDoubleSpawnProbability,this.config.tunnelCrawlerStats.turnSingleSpawnProbability,this.config.tunnelCrawlerStats.turnDoubleSpawnProbability,this.config.tunnelCrawlerStats.changeDirectionProbability),this.createWallCrawler(n,o,0,this.config.tunnelCrawlerStats.maxAge,this.activeGeneration+1,r,this.config.tunnelCrawlerStats.stepLength,1,1,this.config.tunnelCrawlerStats.straightSingleSpawnProbability,this.config.tunnelCrawlerStats.straightDoubleSpawnProbability,this.config.tunnelCrawlerStats.turnSingleSpawnProbability,this.config.tunnelCrawlerStats.turnDoubleSpawnProbability,this.config.tunnelCrawlerStats.changeDirectionProbability),this.createWallCrawler(n,o.negative,0,this.config.tunnelCrawlerStats.maxAge,this.activeGeneration+1,r,this.config.tunnelCrawlerStats.stepLength,1,1,this.config.tunnelCrawlerStats.straightSingleSpawnProbability,this.config.tunnelCrawlerStats.straightDoubleSpawnProbability,this.config.tunnelCrawlerStats.turnSingleSpawnProbability,this.config.tunnelCrawlerStats.turnDoubleSpawnProbability,this.config.tunnelCrawlerStats.changeDirectionProbability),this.rng.range(0,100)<this.config.tunnelCrawlerClosedProbability?this.createWallCrawler(n,r.negative,0,this.config.tunnelCrawlerStats.maxAge,this.activeGeneration+1,r,this.config.tunnelCrawlerStats.stepLength,0,1,this.config.tunnelCrawlerStats.straightSingleSpawnProbability,this.config.tunnelCrawlerStats.straightDoubleSpawnProbability,this.config.tunnelCrawlerStats.turnSingleSpawnProbability,this.config.tunnelCrawlerStats.turnDoubleSpawnProbability,this.config.tunnelCrawlerStats.changeDirectionProbability):this.createWallCrawler(n,r.negative,0,this.config.tunnelCrawlerStats.maxAge,this.activeGeneration+1,r,this.config.tunnelCrawlerStats.stepLength,1,1,this.config.tunnelCrawlerStats.straightSingleSpawnProbability,this.config.tunnelCrawlerStats.straightDoubleSpawnProbability,this.config.tunnelCrawlerStats.turnSingleSpawnProbability,this.config.tunnelCrawlerStats.turnDoubleSpawnProbability,this.config.tunnelCrawlerStats.changeDirectionProbability),h=!1,t++)}}makeIteration(){for(let t=0;t<this.crawlers.length;t++)null!==this.crawlers[t]&&(this.crawlers[t].stepAhead()||(this.crawlers[t]=null));return!1}advanceGeneration(){let t=!1,e=0;for(let i=0;i<this.crawlers.length;i++)if(null!==this.crawlers[i]&&(t=!0,this.crawlers[i].generation===this.activeGeneration)){let t=this.crawlers[i].age;if(t>=0)return!0;(0===e||t>e)&&(e=t)}if(0===e)return this.activeGeneration++,t;console.assert(e<0);for(let t=0;t<this.crawlers.length;t++)null!==this.crawlers[t]&&this.crawlers[t].generation===this.activeGeneration&&(this.crawlers[t].age-=e);return t}createRoom(t){if(this.config.width<10||this.config.height<10)return!1;if(t.endX-t.startX<=5)return!1;if(t.endY-t.startY<=5)return!1;let e=t.startX+1+this.rng.range(0,t.endX-t.startX-3),i=t.startY+1+this.rng.range(0,t.endY-t.startY-3),s=new Ht(e,i);if(!this.isOpen(s))return!1;if(this.isChecked(s))return!1;let n=this.config.maxRoomSize;if(this.isMoreRoomsLabyrinth(Bt.LARGE)||(n=this.config.largeRoomSize),this.isMoreRoomsLabyrinth(Bt.LARGE)||this.isMoreRoomsLabyrinth(Bt.MEDIUM)||(n=this.config.mediumRoomSize),!this.isMoreRoomsLabyrinth())return!1;let o,r=!0,h=[],a=[],l=[];for(a.push(s);r;){r=!1;for(let t=0;t<a.length;){let e=a[t];if(o=0,!this.isOpen(e.plus(Ht.NORTH))||$t.isCheckedList(e.plus(Ht.NORTH),h)||$t.isActive(e.plus(Ht.NORTH),a)||$t.isActive(e.plus(Ht.NORTH),l)||o++,!this.isOpen(e.plus(Ht.SOUTH))||$t.isCheckedList(e.plus(Ht.SOUTH),h)||$t.isActive(e.plus(Ht.SOUTH),a)||$t.isActive(e.plus(Ht.SOUTH),l)||o++,!this.isOpen(e.plus(Ht.EAST))||$t.isCheckedList(e.plus(Ht.EAST),h)||$t.isActive(e.plus(Ht.EAST),a)||$t.isActive(e.plus(Ht.EAST),l)||o++,!this.isOpen(e.plus(Ht.WEST))||$t.isCheckedList(e.plus(Ht.WEST),h)||$t.isActive(e.plus(Ht.WEST),a)||$t.isActive(e.plus(Ht.WEST),l)||o++,!this.isOpen(e.plus(Ht.NORTH_EAST))||$t.isCheckedList(e.plus(Ht.NORTH_EAST),h)||$t.isActive(e.plus(Ht.NORTH_EAST),a)||$t.isActive(e.plus(Ht.NORTH_EAST),l)||o++,!this.isOpen(e.plus(Ht.NORTH_WEST))||$t.isCheckedList(e.plus(Ht.NORTH_WEST),h)||$t.isActive(e.plus(Ht.NORTH_WEST),a)||$t.isActive(e.plus(Ht.NORTH_WEST),l)||o++,!this.isOpen(e.plus(Ht.SOUTH_EAST))||$t.isCheckedList(e.plus(Ht.SOUTH_EAST),h)||$t.isActive(e.plus(Ht.SOUTH_EAST),a)||$t.isActive(e.plus(Ht.SOUTH_EAST),l)||o++,!this.isOpen(e.plus(Ht.SOUTH_WEST))||$t.isCheckedList(e.plus(Ht.SOUTH_WEST),h)||$t.isActive(e.plus(Ht.SOUTH_WEST),a)||$t.isActive(e.plus(Ht.SOUTH_WEST),l)||o++,o>2)r=!0,!this.isOpen(e.plus(Ht.NORTH))||$t.isCheckedList(e.plus(Ht.NORTH),h)||$t.isActive(e.plus(Ht.NORTH),a)||$t.isActive(e.plus(Ht.NORTH),l)||l.push(e.plus(Ht.NORTH)),!this.isOpen(e.plus(Ht.SOUTH))||$t.isCheckedList(e.plus(Ht.SOUTH),h)||$t.isActive(e.plus(Ht.SOUTH),a)||$t.isActive(e.plus(Ht.SOUTH),l)||l.push(e.plus(Ht.SOUTH)),!this.isOpen(e.plus(Ht.EAST))||$t.isCheckedList(e.plus(Ht.EAST),h)||$t.isActive(e.plus(Ht.EAST),a)||$t.isActive(e.plus(Ht.EAST),l)||l.push(e.plus(Ht.EAST)),!this.isOpen(e.plus(Ht.WEST))||$t.isCheckedList(e.plus(Ht.WEST),h)||$t.isActive(e.plus(Ht.WEST),a)||$t.isActive(e.plus(Ht.WEST),l)||l.push(e.plus(Ht.WEST)),!this.isOpen(e.plus(Ht.NORTH_EAST))||$t.isCheckedList(e.plus(Ht.NORTH_EAST),h)||$t.isActive(e.plus(Ht.NORTH_EAST),a)||$t.isActive(e.plus(Ht.NORTH_EAST),l)||l.push(e.plus(Ht.NORTH_EAST)),!this.isOpen(e.plus(Ht.NORTH_WEST))||$t.isCheckedList(e.plus(Ht.NORTH_WEST),h)||$t.isActive(e.plus(Ht.NORTH_WEST),a)||$t.isActive(e.plus(Ht.NORTH_WEST),l)||l.push(e.plus(Ht.NORTH_WEST)),!this.isOpen(e.plus(Ht.SOUTH_EAST))||$t.isCheckedList(e.plus(Ht.SOUTH_EAST),h)||$t.isActive(e.plus(Ht.SOUTH_EAST),a)||$t.isActive(e.plus(Ht.SOUTH_EAST),l)||l.push(e.plus(Ht.SOUTH_EAST)),!this.isOpen(e.plus(Ht.SOUTH_WEST))||$t.isCheckedList(e.plus(Ht.SOUTH_WEST),h)||$t.isActive(e.plus(Ht.SOUTH_WEST),a)||$t.isActive(e.plus(Ht.SOUTH_WEST),l)||l.push(e.plus(Ht.SOUTH_WEST)),$t.isCheckedList(e,h)||(h.push(e),this.setChecked(e)),a.splice(t,1),t++;else if(2===o){let i=0;if(!this.isOpen(e.plus(Ht.NORTH))||$t.isCheckedList(e.plus(Ht.NORTH),h)||$t.isActive(e.plus(Ht.NORTH),a)||$t.isActive(e.plus(Ht.NORTH),l)||(l.push(e.plus(Ht.NORTH)),i++),!this.isOpen(e.plus(Ht.SOUTH))||$t.isCheckedList(e.plus(Ht.SOUTH),h)||$t.isActive(e.plus(Ht.SOUTH),a)||$t.isActive(e.plus(Ht.SOUTH),l)||(l.push(e.plus(Ht.SOUTH)),i++),!this.isOpen(e.plus(Ht.EAST))||$t.isCheckedList(e.plus(Ht.EAST),h)||$t.isActive(e.plus(Ht.EAST),a)||$t.isActive(e.plus(Ht.EAST),l)||(l.push(e.plus(Ht.EAST)),i++),!this.isOpen(e.plus(Ht.WEST))||$t.isCheckedList(e.plus(Ht.WEST),h)||$t.isActive(e.plus(Ht.WEST),a)||$t.isActive(e.plus(Ht.WEST),l)||(l.push(e.plus(Ht.WEST)),i++),1===i){t++;continue}!this.isOpen(e.plus(Ht.NORTH_EAST))||$t.isCheckedList(e.plus(Ht.NORTH_EAST),h)||$t.isActive(e.plus(Ht.NORTH_EAST),a)||$t.isActive(e.plus(Ht.NORTH_EAST),l)||l.push(e.plus(Ht.NORTH_EAST)),!this.isOpen(e.plus(Ht.NORTH_WEST))||$t.isCheckedList(e.plus(Ht.NORTH_WEST),h)||$t.isActive(e.plus(Ht.NORTH_WEST),a)||$t.isActive(e.plus(Ht.NORTH_WEST),l)||l.push(e.plus(Ht.NORTH_WEST)),!this.isOpen(e.plus(Ht.SOUTH_EAST))||$t.isCheckedList(e.plus(Ht.SOUTH_EAST),h)||$t.isActive(e.plus(Ht.SOUTH_EAST),a)||$t.isActive(e.plus(Ht.SOUTH_EAST),l)||l.push(e.plus(Ht.SOUTH_EAST)),!this.isOpen(e.plus(Ht.SOUTH_WEST))||$t.isCheckedList(e.plus(Ht.SOUTH_WEST),h)||$t.isActive(e.plus(Ht.SOUTH_WEST),a)||$t.isActive(e.plus(Ht.SOUTH_WEST),l)||l.push(e.plus(Ht.SOUTH_WEST)),$t.isCheckedList(e,h)||(h.push(e),this.setChecked(e)),a.splice(t,1),t++}else 1==o||(console.assert(0===o),$t.isCheckedList(e,h)||(h.push(e),this.setChecked(e)),a.splice(t,1)),t++;if(h.length>n)return!1}for(let t of l){if(this.getMap(t)===Ut.GUARANTEED_OPEN||this.getMap(t)===Ut.NON_JOIN_GUARANTEED_OPEN)return!1;$t.isCheckedList(t,h)||$t.isActive(t,a)||a.push(t)}l.splice(0,l.length)}let c=!0,d=0,u=Ht.ZERO;for(;c;){d=0,c=!1;for(let t=0;t<a.length;)u=a[t],o=0,!this.isOpen(u.plus(Ht.NORTH))||$t.isCheckedList(u.plus(Ht.NORTH),h)||$t.isActive(u.plus(Ht.NORTH),a)||$t.isActive(u.plus(Ht.NORTH),l)||o++,!this.isOpen(u.plus(Ht.SOUTH))||$t.isCheckedList(u.plus(Ht.SOUTH),h)||$t.isActive(u.plus(Ht.SOUTH),a)||$t.isActive(u.plus(Ht.SOUTH),l)||o++,!this.isOpen(u.plus(Ht.EAST))||$t.isCheckedList(u.plus(Ht.EAST),h)||$t.isActive(u.plus(Ht.EAST),a)||$t.isActive(u.plus(Ht.EAST),l)||o++,!this.isOpen(u.plus(Ht.WEST))||$t.isCheckedList(u.plus(Ht.WEST),h)||$t.isActive(u.plus(Ht.WEST),a)||$t.isActive(u.plus(Ht.WEST),l)||o++,!this.isOpen(u.plus(Ht.NORTH_EAST))||$t.isCheckedList(u.plus(Ht.NORTH_EAST),h)||$t.isActive(u.plus(Ht.NORTH_EAST),a)||$t.isActive(u.plus(Ht.NORTH_EAST),l)||o++,!this.isOpen(u.plus(Ht.NORTH_WEST))||$t.isCheckedList(u.plus(Ht.NORTH_WEST),h)||$t.isActive(u.plus(Ht.NORTH_WEST),a)||$t.isActive(u.plus(Ht.NORTH_WEST),l)||o++,!this.isOpen(u.plus(Ht.SOUTH_EAST))||$t.isCheckedList(u.plus(Ht.SOUTH_EAST),h)||$t.isActive(u.plus(Ht.SOUTH_EAST),a)||$t.isActive(u.plus(Ht.SOUTH_EAST),l)||o++,!this.isOpen(u.plus(Ht.SOUTH_WEST))||$t.isCheckedList(u.plus(Ht.SOUTH_WEST),h)||$t.isActive(u.plus(Ht.SOUTH_WEST),a)||$t.isActive(u.plus(Ht.SOUTH_WEST),l)||o++,o>1?(d++,t++):1===o?(c=!0,!this.isOpen(u.plus(Ht.NORTH))||$t.isCheckedList(u.plus(Ht.NORTH),h)||$t.isActive(u.plus(Ht.NORTH),a)||$t.isActive(u.plus(Ht.NORTH),l)||l.push(u.plus(Ht.NORTH)),!this.isOpen(u.plus(Ht.SOUTH))||$t.isCheckedList(u.plus(Ht.SOUTH),h)||$t.isActive(u.plus(Ht.SOUTH),a)||$t.isActive(u.plus(Ht.SOUTH),l)||l.push(u.plus(Ht.SOUTH)),!this.isOpen(u.plus(Ht.EAST))||$t.isCheckedList(u.plus(Ht.EAST),h)||$t.isActive(u.plus(Ht.EAST),a)||$t.isActive(u.plus(Ht.EAST),l)||l.push(u.plus(Ht.EAST)),!this.isOpen(u.plus(Ht.WEST))||$t.isCheckedList(u.plus(Ht.WEST),h)||$t.isActive(u.plus(Ht.WEST),a)||$t.isActive(u.plus(Ht.WEST),l)||l.push(u.plus(Ht.WEST)),!this.isOpen(u.plus(Ht.NORTH_EAST))||$t.isCheckedList(u.plus(Ht.NORTH_EAST),h)||$t.isActive(u.plus(Ht.NORTH_EAST),a)||$t.isActive(u.plus(Ht.NORTH_EAST),l)||l.push(u.plus(Ht.NORTH_EAST)),!this.isOpen(u.plus(Ht.NORTH_WEST))||$t.isCheckedList(u.plus(Ht.NORTH_WEST),h)||$t.isActive(u.plus(Ht.NORTH_WEST),a)||$t.isActive(u.plus(Ht.NORTH_WEST),l)||l.push(u.plus(Ht.NORTH_WEST)),!this.isOpen(u.plus(Ht.SOUTH_EAST))||$t.isCheckedList(u.plus(Ht.SOUTH_EAST),h)||$t.isActive(u.plus(Ht.SOUTH_EAST),a)||$t.isActive(u.plus(Ht.SOUTH_EAST),l)||l.push(u.plus(Ht.SOUTH_EAST)),!this.isOpen(u.plus(Ht.SOUTH_WEST))||$t.isCheckedList(u.plus(Ht.SOUTH_WEST),h)||$t.isActive(u.plus(Ht.SOUTH_WEST),a)||$t.isActive(u.plus(Ht.SOUTH_WEST),l)||l.push(u.plus(Ht.SOUTH_WEST)),$t.isCheckedList(u,h)||(h.push(u),this.setChecked(u)),a.splice(t,1)):(console.assert(0===o),$t.isCheckedList(u,h)||(h.push(u),this.setChecked(u)),a.splice(t,1));for(u of l){if(this.getMap(u)===Ut.GUARANTEED_OPEN||this.getMap(u)===Ut.NON_JOIN_GUARANTEED_OPEN)return!1;$t.isCheckedList(u,h)||$t.isActive(u,a)||a.push(u)}l.splice(0,l.length)}if(d>1)return!1;if(0===d){console.assert(h.length>0),console.log("FILLING CLOSED ROOM");for(let t=0;t!==h.length;t++)console.assert(this.getMap(h[t])===Ut.OPEN||this.getMap(h[t])===Ut.NON_JOIN_OPEN||this.getMap(h[t])===Ut.INSIDE_TUNNEL_OPEN||this.getMap(h[t])===Ut.INSIDE_ANTEROOM_OPEN),this.setMap(h[t],Ut.CLOSED)}else{if(console.assert(1===d),h.length<this.config.minRoomSize)return!1;let t=!1,e=!1;for(let i=0;i!==h.length;i++)h[i].x!==h[0].x&&(t=!0),h[i].y!==h[0].y&&(e=!0);if(!t||!e)return!1;if(this.getMap(u.plus(Ht.WEST))===Ut.V_DOOR||this.getMap(u.plus(Ht.EAST))===Ut.V_DOOR||this.getMap(u.plus(Ht.WEST))===Ut.H_DOOR||this.getMap(u.plus(Ht.EAST))===Ut.H_DOOR||this.getMap(u.plus(Ht.NORTH))===Ut.V_DOOR||this.getMap(u.plus(Ht.SOUTH))===Ut.V_DOOR||this.getMap(u.plus(Ht.NORTH))===Ut.H_DOOR||this.getMap(u.plus(Ht.SOUTH))===Ut.H_DOOR)return!1;if(h.length<this.config.mediumRoomSize){if(!this.isMoreRoomsLabyrinth(Bt.SMALL))return!1;this.currSmallRoomsLabyrinth++}else if(h.length<this.config.largeRoomSize){if(!this.isMoreRoomsLabyrinth(Bt.MEDIUM))return!1;this.currMediumRoomsLabyrinth++}else{if(!(h.length<this.config.maxRoomSize))return!1;if(!this.isMoreRoomsLabyrinth(Bt.LARGE))return!1;this.currLargeRoomsLabyrinth++}console.assert(1===a.length),u=a[0],this.isOpen(u.plus(Ht.NORTH))?(console.assert(this.isOpen(u.plus(Ht.SOUTH))),this.setMap(u,Ut.H_DOOR)):this.isOpen(u.plus(Ht.WEST))&&(console.assert(this.isOpen(u.plus(Ht.EAST))),this.setMap(u,Ut.V_DOOR));let i=new Ft;for(let t=0;t!==h.length;t++)console.assert(this.getMap(h[t])===Ut.OPEN||this.getMap(h[t])===Ut.NON_JOIN_OPEN||this.getMap(h[t])===Ut.INSIDE_TUNNEL_OPEN||this.getMap(h[t])===Ut.INSIDE_ANTEROOM_OPEN),this.setMap(h[t],Ut.INSIDE_ROOM_OPEN),i.inside.push(h[t]);i.inDungeon=!1,this.rooms.push(i)}return!0}generate(){for(;;){for(this.activeGeneration===this.config.tunnelCrawlerGeneration&&this.createSeedCrawlersInTunnels();this.makeIteration(););if(!this.advanceGeneration())break}if(this.config.tunnelCrawlerGeneration<0||this.activeGeneration<this.config.tunnelCrawlerGeneration)for(this.createSeedCrawlersInTunnels();;){for(;this.makeIteration(););if(!this.advanceGeneration())break}let t=0,e=0;if(this.config.background===Ut.OPEN){let i=new zt(0,0,this.config.width,this.config.height,this.config.background);for(t=0,e=this.config.width*this.config.height;this.isMoreRoomsLabyrinth()&&(this.createRoom(i)||t++,!(t>e)););}for(let i of this.config.design)if(i.type===Ut.OPEN)for(t=0,e=(i.endX-i.startX)*(i.endY-i.startY);this.isMoreRoomsLabyrinth()&&(this.createRoom(i)||t++,!(t>e)););}}var Yt,Vt;!function(t){t[t.RIGHT=2]="RIGHT",t[t.DOWN=1]="DOWN"}(Yt||(Yt={})),function(t){t[t.EMPTY=0]="EMPTY",t[t.FLOOR=1]="FLOOR",t[t.FLOOR_WALL_TOP=2]="FLOOR_WALL_TOP",t[t.WALL_MID=3]="WALL_MID",t[t.WALL_TOP=4]="WALL_TOP",t[t.WALL_SIDE=5]="WALL_SIDE"}(Vt||(Vt={}));class Jt extends Lt{constructor(t,e,i,s,n,o){super(i,s,n),this.app=null,this.resources=t,this.weights=[],this.tileset=e,this.constraints=o,this.T=e.cells.length;for(let t=0;t<this.T;t++)this.weights[t]=1;const r=[];for(let t=0;t<4;t++){r[t]=[];for(let e=0;e<this.T;e++){r[t][e]=[];for(let i=0;i<this.T;i++)r[t][e][i]=!1}}for(let[t,i]of e.right){const e=Lt.opposite[Yt.RIGHT];r[Yt.RIGHT][t][i]=!0,r[e][i][t]=!0}for(let[t,i]of e.down){const e=Lt.opposite[Yt.DOWN];r[Yt.DOWN][t][i]=!0,r[e][i][t]=!0}this.propagator=[];for(let t=0;t<4;t++){this.propagator[t]=[];for(let e=0;e<this.T;e++){this.propagator[t][e]=[];for(let i=0;i<this.T;i++)r[t][e][i]&&this.propagator[t][e].push(i)}}}onBoundary(t,e){return!this.periodic&&(t<0||e<0||t>=this.FMX||e>=this.FMY)}clear(){super.clear();for(let t of this.constraints)t.onClear(),this.propagate()}backtrackConstraint(t,e){for(let i of this.constraints)i.onBacktrack(t,e)}banConstraint(t,e){for(let i of this.constraints)i.onBan(t,e)}initConstraint(){for(let t of this.constraints)if(t.init(this),this.status!=Rt.Undecided)return void(this.debug&&console.warn("failed init constraint",this.status))}stepConstraint(){for(let t of this.constraints){if(t.check(),this.status!=Rt.Undecided)return void(this.debug&&console.warn("failed step constraint check"));if(this.propagate(),this.status!=Rt.Undecided)return void(this.debug&&console.warn("failed step constraint propagate"))}this.deferredConstraintsStep=!1}testObserved(t){let e=t%this.FMX,i=Math.floor(t/this.FMX);if(!this.onBoundary(e,i)){const e=this.wave[t].filter(t=>t).length;console.assert(1===e,`wave ${t} pattern count ${e}`)}}graphics(t){const e=this.tileset.size;console.log("tilesize",e,this.tileset,this.tileset.size),null==this.app&&(this.app=new a.Application({width:this.FMX*e*1,height:this.FMY*e*1,resolution:1,antialias:!1,autoStart:!1,sharedTicker:!1,sharedLoader:!1}),document.body.appendChild(this.app.view));const i=this.app;this.app.stage.removeChildren();const s=new a.Container;if(s.scale.set(1,1),i.stage.addChild(s),null!=this.observed)for(let t=0;t<this.FMX;t++)for(let i=0;i<this.FMY;i++){let[n,o]=this.tileset.cells[this.observed[t+i*this.FMX]];if(n>=0){const o=this.resources.sprite(this.tileset.tiles[n]);o.position.set(t*e,i*e),o.zIndex=1,s.addChild(o)}if(o>=0){const n=this.resources.sprite(this.tileset.tiles[o]);n.position.set(t*e,i*e),n.zIndex=2,s.addChild(n)}}else for(let t=0;t<this.FMX;t++)for(let i=0;i<this.FMY;i++){let n=this.wave[t+i*this.FMX],o=0;for(let t=0;t<this.T;t++)n[t]&&(o+=this.weights[t]);const r=1/o;for(let o=0;o<this.T;o++)if(n[o]){const[n,h]=this.tileset.cells[o],a=(n>=0?1:0)+(h>=0?1:0);if(n>=0){const h=this.resources.sprite(this.tileset.tiles[n]);h.position.set(t*e,i*e),h.zIndex=1,h.alpha=r*(1/a)*this.weights[o],s.addChild(h)}if(h>=0){const n=this.resources.sprite(this.tileset.tiles[h]);n.position.set(t*e,i*e),n.zIndex=2,n.alpha=r*(1/a)*this.weights[o],s.addChild(n)}}}const n=new a.Graphics;s.addChild(n),n.lineStyle(1,16711680);for(let i of t){let t=i%this.FMX,s=Math.floor(i/this.FMX);n.drawRect(t*e,s*e,e,e)}i.render();const o=i.view;console.log("%c ",`\n      font-size: 1px;\n      padding: ${o.height/2}px ${o.width/2}px;\n      background: no-repeat url(${o.toDataURL("image/png")});\n      background-size: ${o.width}px ${o.height}px;\n    `)}}class Kt{constructor(t){this.model=null,this.config=t}init(t){this.model=t}onClear(){const t=this.model;console.time("crawler");const e=new $t(this.config,t.rng);e.generate(),console.timeEnd("crawler"),console.time("crawler constraint");const i=At(t.FMX*t.FMY,!1);for(let s=0;s<e.config.height;s++)for(let n=0;n<e.config.width;n++){const o=n+s*t.FMX;i[o]=e.isMapOpen({x:n,y:s})}function s(e){let s=e%t.FMX,n=Math.floor(e/t.FMX);for(let e=0;e<=1;e++)for(let o=-1;o<=1;o++)if(0!==o||0!==e){let r=s+o,h=n+e;if(t.onBoundary(r,h))continue;if(!i[r+h*t.FMX])return!1}return!0}function n(e,s=2){let n=e%t.FMX,o=Math.floor(e/t.FMX);for(let e=-1;e<=s;e++)for(let s=-1;s<=1;s++)if(0!==s||0!==e){let r=n+s,h=o+e;if(t.onBoundary(r,h))continue;if(i[r+h*t.FMX])return!0}return!1}function o(e,s,n){let o=e%t.FMX+s,r=Math.floor(e/t.FMX)+n;return t.onBoundary(o,r)?null:i[o+r*t.FMX]}for(let e=0;e<i.length;e++){const r=At(6,!1),h=o(e,0,1);if(i[e])r[Vt.EMPTY]=!1,r[Vt.FLOOR]=!0,s(e)||(r[Vt.FLOOR_WALL_TOP]=!0);else if(n(e)){const t=o(e,0,-1);r[Vt.EMPTY]=!(!0===t||!0===h),r[Vt.WALL_MID]=!0===t||!0===h,r[Vt.WALL_TOP]=!0,r[Vt.WALL_SIDE]=!0}else r[Vt.EMPTY]=!0;for(let i=0;i<t.T;i++){r[t.tileset.cells[i][2]]||t.ban(e,i)}}console.timeEnd("crawler constraint")}check(){}onBacktrack(t,e){}onBan(t,e){}}var Qt=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{a(s.next(t))}catch(t){o(t)}}function h(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,h)}a((s=s.apply(t,e||[])).next())}))};class Zt extends class{constructor(t){this.resources=t.resources,this.controller=t}createDungeon(t,e,i,s,n){return new v(this.controller,new a.Ticker,t,e,i,s,n)}replaceFloorRandomly(t,e){const i=["floor_2.png","floor_3.png","floor_4.png","floor_5.png","floor_6.png","floor_7.png","floor_8.png"];for(let s=0;s<e.height;s++)for(let n=0;n<e.width;n++){const o=e.cell(n,s);o.hasFloor&&t.float()<.2&&(o.floorName=t.select(i))}}replaceWallRandomly(t,e){const i=["wall_banner_red.png","wall_banner_blue.png","wall_banner_green.png","wall_banner_yellow.png"],s=["wall_goo.png"],n=["wall_fountain_mid_red","wall_fountain_mid_blue"],o=["wall_hole_1.png","wall_hole_2.png"];for(let r=0;r<e.height;r++)for(let h=0;h<e.width;h++){if("wall_mid.png"===e.cell(h,r).wallName&&t.float()<.3){const a=[...o],l=r+1<e.height&&"floor_1.png"===e.cell(h,r+1).floorName;l&&(a.push(...i),a.push(...s)),r>0&&"wall_top_mid.png"===e.cell(h,r-1).wallName&&l&&a.push(...n);const c=t.select(a);switch(c){case"wall_goo.png":e.cell(h,r).wallName="wall_goo.png",e.cell(h,r+1).floorName="wall_goo_base.png";break;case"wall_fountain_mid_red":e.cell(h,r-1).wallName="wall_fountain_top.png",e.cell(h,r).wallName="wall_fountain_mid_red",e.cell(h,r+1).floorName="wall_fountain_basin_red";break;case"wall_fountain_mid_blue":e.cell(h,r-1).wallName="wall_fountain_top.png",e.cell(h,r).wallName="wall_fountain_mid_blue",e.cell(h,r+1).floorName="wall_fountain_basin_blue";break;default:e.cell(h,r).wallName=c}}}}distance(t,e){return Math.max(Math.abs(t.x-e.x),Math.abs(t.y-e.y))}findFreePositions(t,e,i){const s=[];for(let n=i;n<t.height;n++)for(let o=0;o<t.width-e;o++){let r=!0;for(let s=0;s<i&&r;s++)for(let i=0;i<e&&r;i++){const e=t.cell(o+i,n-s);r=e.hasFloor&&!e.hasObject}r&&s.push(t.cell(o,n))}return s}placeHero(t,e,i){const s=this.findFreePositions(e,2,2);if(0===s.length)throw"hero not placed";const n=t.select(s),o=new ct(i,e,n.x,n.y);return e.light.addLight(o.view.point,m.HERO),o}placeNpc(t,e,i){for(let s=0;s<5;s++){const s=this.findFreePositions(e,2,2).filter(t=>this.distance(i,t)<10);0===s.length&&console.warn("no free place for npc");const n=t.range(0,s.length),[o]=s.splice(n,1),r=t.select(Et);new Nt(r,e,this.controller,o.x,o.y)}}placeMonsters(t,e,i){const s=e.width*e.height,n=Math.floor(.4*s),o=Math.floor(.2*n),r=Math.floor(.07*o);console.log("floor_space: "+n),console.log("monster_count: "+r);for(let s=0;s<r&&this.placeMonster(t,e,i);s++);}placeMonster(t,e,i){const s=this.bossConfig(e).category,n=ut.filter(t=>t.category===s||t.category!=it.DEMON&&t.category!=it.ORC&&t.category!=it.ZOMBIE);if(0===n.length)return console.warn("no tiny monster config found"),!1;const o=this.findFreePositions(e,2,2).filter(t=>this.distance(i,t)>15);if(0===o.length)return console.warn("no free place for tiny monster"),!1;const r=t.range(0,o.length);let[h]=o.splice(r,1);const a=t.select(n);return new gt(a,e,h.x,h.y),!0}placeBoss(t,e,i){const s=this.findFreePositions(e,2,2).filter(t=>this.distance(i,t)>20);if(s.length>0){const i=t.range(0,s.length);let[n]=s.splice(i,1);const o=this.bossConfig(e);new wt(o,e,n.x,n.y)}else console.error("boss not placed")}bossConfig(t){return ft[Math.floor(t.level/5)%ft.length]}placeDrop(t,e){const i=[];for(let t=0;t<e.height;t++)for(let s=0;s<e.height;s++){const n=e.cell(s,t);!n.hasFloor||n.hasDrop||n.hasObject||i.push(n)}const s=Math.floor(3*i.length/100);for(let e=0;e<s&&i.length>0;e++){const e=t.range(0,i.length);i.splice(e,1)[0].randomDrop()}}placeLadder(t,e,i){const s=[],n=[],o=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]];for(let t=1;t<e.height-1;t++)for(let r=1;r<e.height-1;r++){const h=e.cell(r,t);if(h.hasFloor){let a=0;for(let[i,s]of o)e.cell(r+i,t+s).hasFloor&&a++;const l=this.distance(i,{x:r,y:t});a===o.length?s.push([h,l]):n.push([h,l])}}s.sort((t,e)=>t[1]-e[1]),n.sort((t,e)=>t[1]-e[1]);const r=[...n,...s].reverse().splice(0,10);if(0==r.length)throw"ladder not set";t.select(r)[0].ladder()}placeBonfire(t,e,i){const s=this.findFreePositions(e,2,2).filter(t=>this.distance(i,t)<10);if(s.length>0){const n=t.select(s),o=i.character.bonfires.has(e.level);return new Mt(e,n.x,n.y,o)}throw"bonfire not placed"}}{constructor(t){super(t),this.model=null}get percent(){var t;return(null===(t=this.model)||void 0===t?void 0:t.percent)||0}generate(t){return Qt(this,void 0,void 0,(function*(){const e=this.controller.app.loader.resources["dungeon.rules.4.json"].data,i=this.controller.app.loader.resources["dungeon.design.json"].data,s=t.hero;let o;s.dungeonSeeds.has(t.level)?(o=s.dungeonSeeds.get(t.level),console.log(`dungeon level ${t.level} exists seed: ${o}`)):(o=this.controller.rng.int(),console.log(`dungeon level ${t.level} new seed: ${o}`),s.dungeonSeeds.set(t.level,o));const r=n.seeded(o);yield Ct(10);const h=new Kt(i);let a;for(this.model=new Jt(this.resources,e,r,i.width,i.height,[h]),console.time("model loop run");;){if(console.time("model run"),a=yield this.model.run(1e4),console.timeEnd("model run"),a===Rt.Decided){console.log("success run model");break}console.error("failed run model"),yield Ct()}console.timeEnd("model loop run");const l=this.createDungeon(r,o,t.level,this.model.FMX,this.model.FMY),c=this.model.observed;for(let t=0;t<this.model.FMY;t++)for(let i=0;i<this.model.FMX;i++){const s=i+t*this.model.FMX,[n,o]=e.cells[c[s]];n>=0&&(l.cell(i,t).floorName=e.tiles[n]),o>=0&&(l.cell(i,t).wallName=e.tiles[o])}yield Ct(),this.replaceFloorRandomly(r,l),yield Ct(),this.replaceWallRandomly(r,l);const d=this.placeHero(r,l,t.hero);return yield Ct(),this.placeLadder(r,l,d),yield Ct(),t.level%5==1&&(this.placeBonfire(r,l,d),yield Ct()),this.placeNpc(r,l,d),yield Ct(),this.placeMonsters(r,l,d),yield Ct(),t.level%5==0&&(this.placeBoss(r,l,d),yield Ct()),this.placeDrop(r,l),yield Ct(),l.light.loadMap(),yield Ct(),l}))}}class te{constructor(t,e){this.title=null,this.controller=t,this.generator=new Zt(this.controller),this.promise=this.generator.generate(e),this.promise.then(t=>this.controller.dungeon(e.hero,t)),this.progressBar=new a.Graphics}init(){this.renderTitle(),this.renderProgressBar(),this.controller.app.ticker.add(this.update,this)}destroy(){var t,e;this.controller.app.ticker.remove(this.update,this),null===(t=this.title)||void 0===t||t.destroy(),null===(e=this.progressBar)||void 0===e||e.destroy()}pause(){}resume(){}renderTitle(){this.title=new a.BitmapText("ROGUELIKE DUNGEON",{font:{name:"alagard",size:64}}),this.title.anchor=new a.Point(.5,0),this.title.position.set(this.controller.app.screen.width>>1,64),this.controller.stage.addChild(this.title)}renderProgressBar(){this.progressBar=new a.Graphics,this.controller.stage.addChild(this.progressBar)}update(){const t=this.controller.app.screen.width,e=this.controller.app.screen.height,i=t-40-40,s=Math.floor((i-4-4)*this.generator.percent/100);this.progressBar.clear(),this.progressBar.beginFill(tt.b.uiBackground,.3),this.progressBar.drawRect(40,e-40-60-4-4,i,60),this.progressBar.endFill(),this.progressBar.beginFill(tt.b.uiSelected,.3),this.progressBar.drawRect(44,e-40-60-4,s,52),this.progressBar.endFill()}}class ee{constructor(t,e,i){this.controller=t,this.dungeon=i,this.titleView=new R,this.inventoryView=new B.a(this.controller.resources,e.inventory.belt),this.healthView=new dt(e,{fixedHPSize:!1})}init(){const t=this.controller.app.screen.width,e=this.controller.app.screen.height;this.titleView.position.set(t>>1,16),this.titleView.zIndex=10,this.controller.stage.addChild(this.titleView);const i=this.inventoryView.width;this.inventoryView.position.set((t>>1)-(i>>1),e-52),this.inventoryView.zIndex=11,this.controller.stage.addChild(this.inventoryView),this.healthView.position.set(16,16),this.healthView.zIndex=12,this.controller.stage.addChild(this.healthView),this.titleView.level=this.dungeon.level,this.dungeon.container.zIndex=0,this.controller.stage.addChild(this.dungeon.container),this.dungeon.light.layer.zIndex=1,this.controller.stage.addChild(this.dungeon.light.layer),this.dungeon.lighting.zIndex=2,this.dungeon.lighting.alpha=.8,this.controller.stage.addChild(this.dungeon.lighting),this.controller.stage.sortChildren(),this.dungeon.ticker.start()}destroy(){this.titleView.destroy(),this.healthView.destroy(),this.inventoryView.destroy(),this.dungeon.destroy(),this.controller.stage.removeChildren()}pause(){this.dungeon.ticker.stop()}resume(){this.dungeon.ticker.start()}}class ie{constructor(t){this.controller=t}init(){this.renderTitle(),this.renderHelp(),this.controller.app.ticker.add(this.handleInput,this)}destroy(){this.controller.app.ticker.remove(this.handleInput,this),this.controller.stage.removeChildren()}pause(){}resume(){}renderTitle(){let t=new a.BitmapText("ROGUELIKE DUNGEON",{font:{name:"alagard",size:64}});t.anchor=new a.Point(.5,0),t.position.set(this.controller.app.screen.width>>1,64),this.controller.stage.addChild(t)}renderHelp(){const t=["WASD - top, left, bottom, right","F - action","Q - drop weapon","I - inventory","1 ... 0 - belt","","PRESS F TO CONTINUE"];for(let e=0;e<t.length;e++){const i=t[e];if(i.length>0){const t=new a.BitmapText(i,{font:{name:"alagard",size:32}});t.position.set(40,200+30*e),this.controller.stage.addChild(t)}}}handleInput(){this.controller.joystick.hit.once()&&this.controller.selectHero()}}class se{constructor(t){this.heroes=[],this.controller=t,this.selectable=new tt.d(t.joystick)}init(){this.renderTitle(),this.renderHeroes(),this.controller.app.ticker.add(this.selectable.handleInput,this.selectable)}destroy(){this.controller.app.ticker.remove(this.selectable.handleInput,this.selectable),this.heroes.forEach(t=>t.destroy()),this.controller.stage.removeChildren()}pause(){}resume(){}renderTitle(){let t=new a.BitmapText("ROGUELIKE DUNGEON",{font:{name:"alagard",size:64}});t.anchor=new a.Point(.5,0),t.position.set(this.controller.app.screen.width>>1,64),this.controller.stage.addChild(t)}renderHeroes(){const t=this.controller.app.screen.width,e=this.controller.app.screen.height,i=ht.length,s=Math.floor((t-40*(i+1))/i),n=(s-80)/16,o=Math.floor(28*n)+32+120;for(let t=0;t<i;t++){const i=ht[t],n=40*(t+1)+s*t,r=(e>>1)-(o>>1),h=new ne(s,o,i,this.controller.resources);h.position.set(n,r),this.heroes.push(h),this.controller.stage.addChild(h),this.selectable.set(t,0,h,()=>this.select(i))}this.selectable.reset()}select(t){const e=lt.load(t,this.controller.persistent),i=new c.d(c.h.machete);e.inventory.equipment.weapon.set(i),this.controller.generateDungeon({level:1,hero:e})}}class ne extends a.Container{constructor(t,e,i,s){super(),this.isSelected=!1,this.selectedBg=(new a.Graphics).beginFill(tt.b.uiSelected).drawRect(0,0,t,e).endFill(),this.notSelectedBg=(new a.Graphics).beginFill(tt.b.uiNotSelected).drawRect(0,0,t,e).endFill(),this.title=new a.BitmapText(i,{font:{name:"alagard",size:32}}),this.title.anchor=.5,this.title.position.set(t>>1,40);const n=t-80,o=n/16,r=Math.floor(28*o);this.sprite=s.animated(i+"_idle"),this.sprite.width=n,this.sprite.height=r,this.sprite.position.set(40,112),this.addChild(this.selectedBg,this.notSelectedBg,this.title,this.sprite),this.selected=!1}get selected(){return this.isSelected}set selected(t){this.isSelected=t,t?(this.selectedBg.visible=!0,this.notSelectedBg.visible=!1,this.title.visible=!0,this.sprite.gotoAndPlay(0)):(this.selectedBg.visible=!1,this.notSelectedBg.visible=!0,this.title.visible=!1,this.sprite.gotoAndStop(0))}destroy(){super.destroy(),this.selectedBg.destroy(),this.notSelectedBg.destroy(),this.title.destroy(),this.sprite.destroy()}}class oe{constructor(t,e){this.title=null,this.sprite=null,this.spriteBg=null,this.state=null,this.inventory=null,this.buttons=[],this.controller=t,this.hero=e.hero,this.options=e,this.selectable=new tt.d(t.joystick)}init(){const t=new tt.c;this.renderTitle(t),this.renderState(t),this.renderIcon(t),this.renderContinue(t),t.reset(),t.offset(256+tt.e.uiMargin,0),t.commit(),this.renderIncreaseHealth(t),t.reset(),t.offset(24+2*tt.e.uiMargin,0),t.commit(),this.renderInventory(t),this.selectable.reset(),this.controller.app.ticker.add(this.handleInput,this)}destroy(){var t,e,i,s,n;this.controller.app.ticker.remove(this.handleInput,this),null===(t=this.title)||void 0===t||t.destroy(),null===(e=this.sprite)||void 0===e||e.destroy(),null===(i=this.spriteBg)||void 0===i||i.destroy(),null===(s=this.state)||void 0===s||s.destroy(),null===(n=this.inventory)||void 0===n||n.destroy();for(let t of this.buttons)t.destroy();this.sprite=null,this.spriteBg=null,this.title=null,this.state=null,this.inventory=null,this.buttons.splice(0,1e3)}pause(){}resume(){}renderTitle(t){this.title=new a.BitmapText("ROGUELIKE DUNGEON",{font:{name:"alagard",size:64}}),this.title.anchor=new a.Point(.5,0),this.title.position.set(this.controller.app.screen.width>>1,64),this.controller.stage.addChild(this.title),t.offset(0,128+tt.e.uiMargin),t.commit()}renderState(t){t.offset(tt.e.uiMargin,0),t.commit(),this.state=new dt(this.hero,{fixedHPSize:!0}),this.state.position.set(t.x,t.y),this.controller.stage.addChild(this.state),t.offset(0,this.state.getBounds().height)}renderIcon(t){this.sprite=this.controller.resources.animated(this.hero.name+"_idle");const e=this.sprite.width,i=this.sprite.height;this.sprite.width=256-(tt.e.uiMargin<<1);const s=this.sprite.width/e;this.sprite.height=Math.floor(s*i);const n=Math.floor(s*this.sprite.texture.trim.height),o=this.sprite.height-n;t.offset(0,tt.e.uiMargin),this.sprite.position.set(t.x+tt.e.uiMargin,t.y+tt.e.uiMargin-o),this.spriteBg=(new a.Graphics).beginFill(tt.b.uiBackground).drawRect(0,0,256,n+(tt.e.uiMargin<<1)).endFill(),this.spriteBg.position.set(t.x,t.y),this.controller.stage.addChild(this.spriteBg,this.sprite),t.offset(0,n+(tt.e.uiMargin<<1))}renderIncreaseHealth(t){const e=new tt.a({label:"+",width:24,height:24});e.position.set(t.x,t.y),this.selectable.set(1,0,e,()=>this.hero.increaseHealth()),this.selectable.merge(1,0,1,12),this.buttons.push(e),this.controller.stage.addChild(e),t.offset(0,24)}renderContinue(t){t.offset(0,tt.e.uiMargin);const e=new tt.a({label:"Continue ...",width:256,height:32});e.position.set(t.x,t.y),this.selectable.set(0,0,e,()=>this.controller.generateDungeon(this.options)),this.selectable.merge(0,0,1,12),this.buttons.push(e),this.controller.stage.addChild(e),t.offset(0,32)}renderInventory(t){const e=new B.c(this.hero.inventory);this.inventory=new B.e(this.controller.resources,e,this.selectable,2),this.inventory.position.set(t.x,t.y),this.controller.stage.addChild(this.inventory)}handleInput(){this.selectable.handleInput()}}var re,he,ae=i(5);class le{constructor(t,e){this.transaction=new Map,this.storage=t,this.prefix=e}clear(){for(let t of Object.keys(this.storage))t.startsWith(this.prefix)&&this.storage.removeItem(t);this.transaction.clear()}load(t){const e=this.storage.getItem(this.key(t));return null!==e?JSON.parse(e):null}save(t,e){this.transaction.set(t,e),this.storage.setItem(this.key(t),JSON.stringify(e))}commit(){for(let[t,e]of this.transaction)this.storage.setItem(this.key(t),JSON.stringify(e));this.transaction.clear()}key(t){return[this.prefix,t].join()}}class ce{constructor(){const t="localhost"===location.hostname||"0.0.0.0"===location.hostname||"127.0.0.1"===location.hostname?sessionStorage:localStorage;this.global=new le(t,"global."),this.session=new le(t,"session.")}}!function(t){t[t.Started=1]="Started",t[t.ParsingNumber=2]="ParsingNumber",t[t.ParsingStringStarted=3]="ParsingStringStarted",t[t.ParsingString=4]="ParsingString",t[t.ParsingStringFinished=5]="ParsingStringFinished",t[t.ParsingFunction=6]="ParsingFunction",t[t.Finished=7]="Finished",t[t.ParsingContext=8]="ParsingContext",t[t.ParsingBracket=9]="ParsingBracket",t[t.Error=10]="Error"}(re||(re={})),function(t){t[t.Delimiter=1]="Delimiter",t[t.Digit=2]="Digit",t[t.Bracket=3]="Bracket",t[t.Other=4]="Other",t[t.ContextBracket=5]="ContextBracket",t[t.Quote=6]="Quote"}(he||(he={}));const de={[re.Started]:{[he.Delimiter]:re.Started,[he.Digit]:re.ParsingNumber,[he.Bracket]:re.ParsingBracket,[he.Other]:re.ParsingFunction,[he.ContextBracket]:re.ParsingContext,[he.Quote]:re.ParsingStringStarted},[re.ParsingNumber]:{[he.Delimiter]:re.Finished,[he.Digit]:re.ParsingNumber,[he.Bracket]:re.Finished,[he.Other]:re.Finished,[he.ContextBracket]:re.Error,[he.Quote]:re.Error},[re.ParsingFunction]:{[he.Delimiter]:re.Finished,[he.Digit]:re.ParsingFunction,[he.Bracket]:re.Finished,[he.Other]:re.ParsingFunction,[he.ContextBracket]:re.Error,[he.Quote]:re.Error},[re.ParsingContext]:{[he.Delimiter]:re.Finished,[he.Digit]:re.ParsingContext,[he.Bracket]:re.Finished,[he.Other]:re.ParsingContext,[he.ContextBracket]:re.ParsingContext,[he.Quote]:re.Error},[re.ParsingBracket]:{[he.Delimiter]:re.Finished,[he.Digit]:re.Finished,[he.Bracket]:re.Finished,[he.Other]:re.Finished,[he.ContextBracket]:re.Finished,[he.Quote]:re.Finished},[re.ParsingStringStarted]:{[he.Delimiter]:re.ParsingString,[he.Digit]:re.ParsingString,[he.Bracket]:re.ParsingString,[he.Other]:re.ParsingString,[he.ContextBracket]:re.ParsingString,[he.Quote]:re.Finished},[re.ParsingString]:{[he.Delimiter]:re.ParsingString,[he.Digit]:re.ParsingString,[he.Bracket]:re.ParsingString,[he.Other]:re.ParsingString,[he.ContextBracket]:re.ParsingString,[he.Quote]:re.ParsingStringFinished},[re.ParsingStringFinished]:{[he.Delimiter]:re.Finished,[he.Digit]:re.Finished,[he.Bracket]:re.Finished,[he.Other]:re.Finished,[he.ContextBracket]:re.Finished,[he.Quote]:re.Finished}};class ue{constructor(){this.operations={"+":{priority:0,variable:!1,apply:(t,e)=>t+e},"-":{priority:0,variable:!1,apply:(t,e)=>t-e},"*":{priority:1,variable:!1,apply:(t,e)=>t*e},"/":{priority:1,variable:!1,apply:(t,e)=>t/e},"%":{priority:1,variable:!1,apply:(t,e)=>t%e},or:{priority:0,variable:!1,apply:(t,e)=>t||e},and:{priority:1,variable:!1,apply:(t,e)=>t&&e},"!":{priority:2,variable:!1,apply:t=>!t},true:{priority:100,variable:!1,apply:()=>!0},false:{priority:100,variable:!1,apply:()=>!1},$$getContextValue:{priority:100,variable:!1,apply:(t,e)=>e[t.substring(1,t.length-1)]}},this.context={}}static classifySymbol(t){return-1!==ue.delimiters.indexOf(t)?he.Delimiter:-1!==ue.brackets.indexOf(t)?he.Bracket:-1!==ue.digits.indexOf(t)?he.Digit:-1!==ue.contextBrackets.indexOf(t)?he.ContextBracket:-1!==ue.quotes.indexOf(t)?he.Quote:he.Other}isOfMoreOrEqualPriority(t,e){return this.operations[t].priority<=this.operations[e].priority}scanToken(t,e){let i=re.Started,s=re.Error,n="",o=e;for(;o<t.length&&i!==re.Finished&&i!==re.Error;){let e=ue.classifySymbol(t[o]);i=de[i][e],i===re.ParsingFunction&&void 0!==this.operations[n]&&(i=re.Finished),i===re.ParsingFunction||i===re.ParsingNumber||i===re.ParsingBracket||i===re.ParsingContext||i===re.ParsingString?(s=i,n+=t[o++]):i!==re.Started&&i!==re.ParsingStringStarted&&i!==re.ParsingStringFinished||o++}return""===n&&(s=re.Error),{workingState:s,tokenString:n,pos:o}}convertToRPN(t){let e,i=[],s=[],n=0;for(let o=0;o<t.length;o++)if("n"!==t[o].type)if("("!==t[o].type)if(")"!==t[o].type){if(-1!==Object.keys(this.operations).indexOf(t[o].type)){if(i.length>0){do{e=i.pop(),s[n++]=e}while(i.length>0&&-1===ue.brackets.indexOf(s[n-1].type)&&this.isOfMoreOrEqualPriority(t[o].type,s[n-1].type));-1===ue.brackets.indexOf(s[n-1].type)&&this.isOfMoreOrEqualPriority(t[o].type,s[n-1].type)||(i.push(e),n--)}i.push(t[o])}}else{do{e=i.pop(),s[n++]=e}while("("!==s[n-1].type);n--}else i.push(t[o]);else s[n++]=t[o];for(;i.length>0;)e=i.pop(),s[n++]=e;return s}calculateRPN(t){var e;let i=[];if(0===t.length)return null;for(let e=0;e<t.length;e++)if("n"===t[e].type)i.push(t[e]);else{let s=this.operations[t[e].type],n=s.apply,o=s.variable?i.length:n.length,r=i.splice(i.length-o).map(t=>t.value),h=n.apply(null,r);i.push({type:"n",value:h})}return(null===(e=i.shift())||void 0===e?void 0:e.value)||null}tokenize(t){const e=[];for(let i=0;i<t.length;){let s=this.scanToken(t,i);s.workingState!==re.Error&&(s.workingState===re.ParsingNumber?e.push({type:"n",value:-1!==s.tokenString.indexOf(".")?parseFloat(s.tokenString):parseInt(s.tokenString)}):s.workingState===re.ParsingContext?(e.push({type:"$$getContextValue",value:null}),e.push({type:"n",value:s.tokenString}),e.push({type:"n",value:this.context})):s.workingState===re.ParsingString?e.push({type:"n",value:s.tokenString}):e.push({type:s.tokenString,value:null})),i=s.pos}return e}register(t,e,i,s){this.operations[t]={priority:e,variable:i,apply:s}}evaluate(t,e={}){this.context=e;const i=this.tokenize(t),s=this.convertToRPN(i);return this.calculateRPN(s)}}ue.digits="0123456789.",ue.brackets="()",ue.contextBrackets="{}",ue.delimiters=" ,\r\r\n",ue.quotes="'\"";class pe{constructor(){this.context={}}add(t,e){this.context[t]=e}render(t){return t.replace(/{{([^}]+)}}/g,(t,e)=>{let i=e.split(".");if(i.length>=1){let t=this.context;for(;i.length>0;){const[e]=i.splice(0,1);t=t[e]}return t||null}return e})}}class ge{constructor(t){this.controller=t,this.config=t.app.loader.resources["dialogs.json"].data}dialog(t,e){const i=this.config[e.name]||this.config.default;return new fe(this.controller,t,e,i)}}class fe{constructor(t,e,i,s){this._question=new A.a,this.controller=t,this.hero=e,this.npc=i,this._config=s,this._expression=new ue,this._expression.register("goto",100,!0,this.goto.bind(this)),this._expression.register("exit",100,!1,this.exit.bind(this)),this._expression.register("context",100,!1,this.context.bind(this)),this._expression.register("hasSkill",100,!1,this.hasSkill.bind(this)),this._expression.register("skill",100,!1,this.skill.bind(this)),this._template=new pe,this._template.add("hero",this.hero),this._template.add("npc",this.npc)}get question(){return this._question}start(){this.goto(...this._config.start)}hasSkill(t){return this.npc.hasSkill(t)}skill(t){var e;null===(e=this.npc.getSkill(t))||void 0===e||e.use(this.hero)}exit(){this.controller.closeModal()}context(t,e){return void 0===e?this.npc.getContext(t):(this.npc.setContext(t,e),null)}goto(...t){for(let e of t){const t=this._config.questions[e];if(this.check(t.conditions||[])){const e=this._template.render(t.text),i=new me(this,e);for(let e of t.answers)if(this.check(e.conditions)){const t=this._template.render(e.text);i.add(t,e.commands)}return void this._question.send(i)}}}check(t){if(t)for(let e of t)if(!this.evaluate(e))return!1;return!0}evaluate(t){return this._expression.evaluate(t)}}class me{constructor(t,e){this.answers=[],this.dialog=t,this.text=e}add(t,e){this.answers.push(new we(this.dialog,t,e))}}class we{constructor(t,e,i){this.dialog=t,this.text=e,this.commands=i}action(){for(let t of this.commands)this.dialog.evaluate(t)}}class _e{constructor(t,e){this.container=null,this.background=null,this.selectable=null,this._width=0,this._layout=new tt.c,this._question=null,this._answers=[],this.controller=t,this.dialog=e}init(){this.background=new a.Graphics,this.selectable=new tt.d(this.controller.joystick);this.background.beginFill(0).drawRect(0,0,600,400).endFill(),this.background.zIndex=0,this.container=new a.Container,this.container.addChild(this.background),this.container.sortChildren(),this.container.position.set((this.controller.app.screen.width>>1)-300,(this.controller.app.screen.height>>1)-200);const t=this._layout;t.offset(tt.e.uiMargin,tt.e.uiMargin);const e=this.controller.resources.animated(this.dialog.npc.name+"_idle");e.width=4*e.width,e.height=4*e.height,e.position.set(t.x+tt.e.uiBorder,t.y+tt.e.uiBorder);const i=new a.Graphics;i.beginFill(tt.b.uiBackground).drawRect(t.x,t.y,e.width+2*tt.e.uiBorder,e.height+2*tt.e.uiBorder).endFill(),t.reset(),t.offset(e.width,0),t.offset(tt.e.uiMargin,0),t.offset(2*tt.e.uiBorder,0),t.commit(),this._width=600-t.x,this.container.addChild(i,e),this.controller.stage.addChild(this.container),this.controller.app.ticker.add(this.handleInput,this),this.dialog.question.subscribe(this.onQuestion,this),this.dialog.start()}destroy(){var t,e;this.dialog.question.unsubscribe(this.onQuestion,this),this.controller.app.ticker.remove(this.handleInput,this),null===(t=this.container)||void 0===t||t.destroy(),this.container=null,null===(e=this.background)||void 0===e||e.destroy(),this.background=null,this.selectable=null}onQuestion(t){var e;null===(e=this._question)||void 0===e||e.destroy();for(let t=0;t<this._answers.length;t++){this._answers[t].destroy(),this.selectable.remove(0,t)}this.selectable.reset(),this._answers=[];const i=this._width-2*tt.e.uiMargin,s=this._layout;s.reset(),s.offset(tt.e.uiMargin,tt.e.uiMargin),this._question=new ye(t,i),this._question.position.set(s.x,s.y),this.container.addChild(this._question),s.offset(0,this._question.height),s.offset(0,tt.e.uiMargin);for(let e=0;e<t.answers.length;e++){let n=t.answers[e];const o=new be(n,i);this.selectable.set(0,e,o,n.action.bind(n)),o.position.set(s.x,s.y),s.offset(0,o.height),s.offset(0,tt.e.uiMargin),this._answers.push(o),this.container.addChild(o)}this.selectable.reset()}handleInput(){var t;null===(t=this.selectable)||void 0===t||t.handleInput()}}class ye extends a.Container{constructor(t,e){super(),this._text=new a.BitmapText(t.text,{font:{name:"alagard",size:16}}),this._text.maxWidth=e-2*tt.e.uiBorder,this._text.calculateBounds(),this._text.position.set(tt.e.uiBorder,tt.e.uiBorder);const i=this._text.height+2*tt.e.uiBorder;this._background=new a.Graphics,this._background.clear().beginFill(tt.b.uiBackground,.3).drawRect(0,0,e,i).endFill(),this.addChild(this._background,this._text)}}class be extends a.Container{constructor(t,e){super(),this._selected=!1,this._background=new a.Graphics,this._text=new a.BitmapText(t.text,{font:{name:"alagard",size:16}}),this._text.maxWidth=e-2*tt.e.uiBorder,this._text.calculateBounds(),this._text.position.set(tt.e.uiBorder,tt.e.uiBorder),this._width=e,this._height=this._text.height+2*tt.e.uiBorder,this.selected=!1,this.addChild(this._background,this._text)}get selected(){return this._selected}set selected(t){this._selected=t,this._background.clear().beginFill(t?tt.b.uiSelected:tt.b.uiNotSelected).drawRect(0,0,this._width,this._height).endFill()}}class Oe extends a.Container{constructor(t,e){super(),this.show=120,this.fadeOut=60,this.controller=t;const i=this.controller.app.screen,s=Math.floor(.7*i.height);this.text=new a.BitmapText(e.text,{font:{name:"alagard",size:64},align:"center",tint:e.color}),this.text.anchor=new a.Point(.5,.5),this.text.position.set(i.width>>1,s);const n=new a.filters.BlurFilter;n.blurY=1,n.blurX=10,n.quality=4,this.textShadow=new a.BitmapText(e.text,{font:{name:"alagard",size:64},align:"center",tint:e.color}),this.textShadow.anchor=new a.Point(.5,.5),this.textShadow.position.set(i.width>>1,s),this.textShadow.width+=44.8,this.textShadow.alpha=.5,this.textShadow.filters=[n],this.textShadow.filterArea=this.textShadow.getBounds().clone().pad(50,0),this.texture=Oe.gradient(1,128),this.background=new a.TilingSprite(this.texture,i.width,128),this.background.position.set(0,s-64),this.addChild(this.background,this.textShadow,this.text),this.controller.stage.addChild(this),this.controller.app.ticker.add(this.update,this)}update(t){this.show>0?this.show-=t:this.fadeOut>0?(this.fadeOut-=t,this.alpha=this.fadeOut/60):this.controller.closeBanner()}destroy(){super.destroy(),this.controller.app.ticker.remove(this.update,this),this.text.destroy(),this.background.destroy(),this.texture.destroy(!0)}static gradient(t,e){const i=document.createElement("canvas");i.width=t,i.height=e;const s=i.getContext("2d"),n=s.createLinearGradient(0,0,0,e);return n.addColorStop(0,"rgba(0, 0, 0, 0)"),n.addColorStop(.3,"rgba(0, 0, 0, 1)"),n.addColorStop(.7,"rgba(0, 0, 0, 1)"),n.addColorStop(1,"rgba(0, 0, 0, 0)"),s.fillStyle=n,s.fillRect(0,0,t,e),a.Texture.from(i)}}class Se{constructor(t,e,i){this.mainScene=null,this.modalScene=null,this.banner=null,this.persistent=new ce,this.rng=n.create(),this.joystick=new h,this.resources=t,this.app=e,this.stage=i,this.dialogs=new ge(this),this.app.ticker.add(this.persistent.global.commit,this.persistent.global,a.UPDATE_PRIORITY.LOW),this.app.ticker.add(this.persistent.session.commit,this.persistent.session,a.UPDATE_PRIORITY.LOW)}set scene(t){var e;null===(e=this.mainScene)||void 0===e||e.destroy(),this.joystick.reset(),this.mainScene=t,this.mainScene.init()}keyBind(){this.scene=new ie(this)}selectHero(){this.scene=new se(this)}updateHero(t,e){this.scene=new oe(this,{level:e,hero:t})}dead(){this.scene=new l(this)}generateDungeon(t){this.scene=new te(this,t)}dungeon(t,e){this.scene=new ee(this,t,e)}modal(t){var e;a.sound.play("text"),null===(e=this.mainScene)||void 0===e||e.pause(),this.joystick.reset(),this.modalScene=t,this.modalScene.init()}closeModal(){var t,e;null===(t=this.modalScene)||void 0===t||t.destroy(),this.joystick.reset(),null===(e=this.mainScene)||void 0===e||e.resume()}showInventory(t){const e=new B.c(t.inventory);this.modal(new ae.a(this,e))}sellInventory(t,e){const i=new B.f(t,e);this.modal(new ae.a(this,i))}buyInventory(t,e){const i=new B.b(t,e);this.modal(new ae.a(this,i))}showDialog(t,e){const i=this.dialogs.dialog(t,e);this.modal(new _e(this,i))}showBonfire(t){this.modal(new kt(this,t))}showBanner(t){this.closeBanner(),this.banner=new Oe(this,t)}closeBanner(){var t;null===(t=this.banner)||void 0===t||t.destroy(),this.banner=null}}},function(t,e,i){"use strict";i.r(e),function(t){i(0),i(9),i(10);var e=i(6),s=i(7),n=i(1),o=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{a(s.next(t))}catch(t){o(t)}}function h(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,h)}a((s=s.apply(t,e||[])).next())}))};!function(){o(this,void 0,void 0,(function*(){t.settings.SCALE_MODE=t.SCALE_MODES.NEAREST,t.settings.FAIL_IF_MAJOR_PERFORMANCE_CAVEAT=!1,t.sound.volumeAll=.5;const i=new t.Application({width:1200,height:700,resolution:1,antialias:!1}),o=new t.display.Stage;i.stage=o,i.renderer.backgroundColor=n.b.background;const r=new e.a(i.loader);yield r.load(),document.getElementById("container").appendChild(i.view),new s.a(r,i,o).keyBind()}))}()}.call(this,i(0))},function(t,e){t.exports=PIXI.layers},function(t,e){t.exports=PIXI.sound}]);
//# sourceMappingURL=bundle.js.map