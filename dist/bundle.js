!function t(e,s,i){function l(o,r){if(!s[o]){if(!e[o]){var n="function"==typeof require&&require;if(!r&&n)return n(o,!0);if(h)return h(o,!0);var a=new Error("Cannot find module '"+o+"'");throw a.code="MODULE_NOT_FOUND",a}var c=s[o]={exports:{}};e[o][0].call(c.exports,(function(t){return l(e[o][1][t]||t)}),c,c.exports,t,e,s,i)}return s[o].exports}for(var h="function"==typeof require&&require,o=0;o<i.length;o++)l(i[o]);return l}({1:[function(t,e,s){"use strict";Object.defineProperty(s,"__esModule",{value:!0});const i=t("./monster");s.mossMonsterNames=["ogre","big_zombie","big_demon"];s.BossMonster=class{constructor(t,e,s,l,h,o,r){this.rng=t,this.registry=e,this.level=s,this.x=l,this.y=h,this.new_x=l,this.new_y=h,this.is_left=!1,this.name=o,this.healthMax=50+Math.floor(10*s.level),this.health=this.healthMax,this.damage=7,this.luck=.5,this.speed=100,this.wrapper=new i.MovingMonsterWrapper(this),this.setAnimation(i.MonsterState.Idle,r)}setAnimation(t,e){switch(t){case i.MonsterState.Idle:this.state=t,this.tile=this.registry.get(this.name+"_idle_anim"),this.frame=0,this.start=e;break;case i.MonsterState.Run:this.state=t,this.tile=this.registry.get(this.name+"_run_anim"),this.frame=0,this.start=e}}animate(t){if(this.frame=Math.floor((t-this.start)/this.speed),this.frame>=this.tile.numOfFrames){this.state===i.MonsterState.Run&&(this.level.monsters[this.y][this.x]=null,this.level.monsters[this.y][this.x+1]=null,this.level.monsters[this.y-1][this.x]=null,this.level.monsters[this.y-1][this.x+1]=null,this.level.monsters[this.new_y][this.new_x]=this,this.level.monsters[this.new_y][this.new_x+1]=this.wrapper,this.level.monsters[this.new_y-1][this.new_x]=this.wrapper,this.level.monsters[this.new_y-1][this.new_x+1]=this.wrapper,this.x=this.new_x,this.y=this.new_y),this.setAnimation(i.MonsterState.Idle,t);const e=5,s=Math.max(0,this.x-e),l=Math.max(0,this.y-e),h=Math.min(this.level.w,this.x+e),o=Math.min(this.level.h,this.y+e);if(!this.level.hero.dead&&this.level.hero.x>=s&&this.level.hero.x<=h&&this.level.hero.y>=l&&this.level.hero.y<=o){const e=Math.abs(this.x-this.level.hero.x),s=Math.abs(this.y-this.level.hero.y);if(e>1){const e=Math.max(-1,Math.min(1,this.level.hero.x-this.x));if(this.move(e,0,t))return void console.log("move to hero x")}if(s>0){const e=Math.max(-1,Math.min(1,this.level.hero.y-this.y));if(this.move(0,e,t))return void console.log("move to hero y")}if(e<=1&&s<=1&&this.rng.nextFloat()<this.luck)return void this.level.hero.hitDamage(this.damage,this.name,t)}const r=.5;if(this.rng.nextFloat()<r){const e=this.rng.nextRange(-1,2),s=this.rng.nextRange(-1,2);if(console.log("random move",e,s),this.move(e,s,t))return}}}move(t,e,s){if(this.is_left=t<0,this.state===i.MonsterState.Idle){const l=this.x+t,h=this.y+e;for(let t=l;t<=l+1;t++)for(let e=h-1;e<=h;e++){if(!this.level.floor[e][t])return!1;const s=this.level.monsters[e][t];if(s&&s!==this&&s!==this.wrapper)return!1}return this.level.monsters[h][l]=this.wrapper,this.level.monsters[h][l+1]=this.wrapper,this.level.monsters[h-1][l]=this.wrapper,this.level.monsters[h-1][l+1]=this.wrapper,this.level.monsters[this.y][this.x]=this,this.new_x=l,this.new_y=h,this.setAnimation(i.MonsterState.Run,s),!0}return!1}hitDamage(t,e,s){this.level.log.push(`${this.name} damaged ${t} by ${e}`),this.health=Math.max(0,this.health-t),this.health<=0&&(this.level.log.push(`${this.name} killed by ${e}`),this.level.monsters[this.y][this.x]=null,this.level.monsters[this.y][this.x+1]=null,this.level.monsters[this.y-1][this.x]=null,this.level.monsters[this.y-1][this.x+1]=null,this.level.monsters[this.new_y][this.new_x]=null,this.level.monsters[this.new_y][this.new_x+1]=null,this.level.monsters[this.new_y-1][this.new_x]=null,this.level.monsters[this.new_y-1][this.new_x+1]=null,this.level.boss=null,this.rng.nextFloat()<this.luck&&this.level.randomDrop(this.x,this.y))}}},{"./monster":8}],2:[function(t,e,s){"use strict";Object.defineProperty(s,"__esModule",{value:!0});s.Coins=class{constructor(t,e){this.tile=e.get("coin_anim"),this.coins=t.nextRange(1,30)}pickedUp(t){return t.addCoins(this.coins),!0}};class i{constructor(t){this.tile=t.get("flask_red"),this.health=2}pickedUp(t){return t.inventory.add(this)}same(t){return t instanceof i}use(t,e){e.hill(this.health),t.count--,t.count<=0&&(t.item=null,t.count=0)}}s.HealthFlask=i;class l{constructor(t){this.tile=t.get("flask_big_red"),this.health=5}pickedUp(t){return t.inventory.add(this)}same(t){return t instanceof l}use(t,e){e.hill(this.health),t.count--,t.count<=0&&(t.item=null,t.count=0)}}s.HealthBigFlask=l,s.weaponNames=["weapon_knife","weapon_rusty_sword","weapon_regular_sword","weapon_red_gem_sword","weapon_big_hammer","weapon_hammer","weapon_baton_with_spikes","weapon_mace","weapon_katana","weapon_saw_sword","weapon_anime_sword","weapon_axe","weapon_machete","weapon_cleaver","weapon_duel_sword","weapon_knight_sword","weapon_golden_sword","weapon_lavish_sword","weapon_red_magic_staff","weapon_green_magic_staff"];class h{constructor(t,e,s,i,l){this.tileName=t,this.speed=e,this.distance=s,this.damage=i,this.level=l}create(t){return new o(t.get(this.tileName),this.speed,this.distance,this.damage)}}s.WeaponConfig=h,h.configs=[new h("weapon_knife",100,1,3,1),new h("weapon_rusty_sword",100,1,4,1),new h("weapon_regular_sword",100,1,5,3),new h("weapon_red_gem_sword",100,1,6,3),new h("weapon_big_hammer",300,2,10,5),new h("weapon_hammer",200,1,7,5),new h("weapon_baton_with_spikes",200,1,7,5),new h("weapon_mace",200,1,7,5),new h("weapon_katana",100,1,8,7),new h("weapon_saw_sword",200,1,9,7),new h("weapon_anime_sword",200,1,12,7),new h("weapon_axe",200,1,12,7),new h("weapon_machete",100,1,11,9),new h("weapon_cleaver",100,1,12,9),new h("weapon_duel_sword",100,1,13,9),new h("weapon_knight_sword",100,1,14,9),new h("weapon_golden_sword",100,1,15,11),new h("weapon_lavish_sword",100,1,16,11)];class o{constructor(t,e,s,i){this.tile=t,this.frame=0,this.numOfFrames=4,this.speed=e,this.distance=s,this.damage=i}pickedUp(t){return t.inventory.add(this)}same(t){return!1}use(t,e){const s=e.weapon;e.weapon=this,s?(t.item=s,t.count=1):(t.item=null,t.count=0)}}s.Weapon=o},{}],3:[function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,e,s,i){return new(s||(s=Promise))((function(l,h){function o(t){try{n(i.next(t))}catch(t){h(t)}}function r(t){try{n(i.throw(t))}catch(t){h(t)}}function n(t){var e;t.done?l(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,r)}n((i=i.apply(t,e||[])).next())}))};Object.defineProperty(s,"__esModule",{value:!0});const l=t("./input"),h=t("./tilemap"),o=t("./hero"),r=t("./level"),n=t("./scene"),a=t("./rng"),c=t("./monster"),w=t("./drop");!function(){i(this,void 0,void 0,(function*(){const t=new h.TileRegistry;yield t.load();const e=document.getElementById("dungeon"),s=e.getContext("2d");s.imageSmoothingEnabled=!1;const i=document.createElement("canvas"),m=i.getContext("2d");m.imageSmoothingEnabled=!1;const d=(new Date).getTime(),g=new a.RNG,f=new l.Joystick,_=w.WeaponConfig.configs[0].create(t),u=new o.HeroMonster(t,f,0,0,"knight_f",_,d),y=new n.Scene;y.setLevel(new r.Level(g,t,y,u,1,d));function p(t,e,s){const i=s<<1,l=t-s,h=e-s,o=m.createRadialGradient(t,e,16,t,e,s);o.addColorStop(.5,"rgb(255,255,255)"),o.addColorStop(1,"transparent"),m.fillStyle=o,m.fillRect(l,h,i,i)}function v(t,e,i,l){if(t&&!(t instanceof c.MovingMonsterWrapper)){const h=t.tile.w,o=t.tile.h,r=t.tile.x+h*t.frame,n=t.tile.y,a=2*h,w=2*o,m=w-28;let d=0,g=0;if(t.state===c.MonsterState.Run){const e=t.start,s=t.speed*t.tile.numOfFrames,i=Math.min(s,l-e)/s;d=32*(t.new_x-t.x)*i,g=32*(t.new_y-t.y)*i}if(e+d+a>0&&e+d<s.canvas.width&&i+g+w>0&&i+g<s.canvas.height){if(s.save(),s.translate(e+d,i+g),t.is_left){if(s.scale(-1,1),t.weapon){s.save();const e=t.weapon.tile,i=2*e.w,l=2*e.h,h=l-28,o=8;if(s.translate(-o,-h),t.state===c.MonsterState.Hit){let h=90*t.weapon.frame/(t.weapon.numOfFrames-1);s.translate(i>>1,l),s.rotate(h*Math.PI/180),s.drawImage(e.tileSet,e.x,e.y,e.w,e.h,-(i>>1),-l,i,l)}else s.drawImage(e.tileSet,e.x,e.y,e.w,e.h,0,0,i,l);s.restore()}s.drawImage(t.tile.tileSet,r,n,h,o,0-a,-m,a,w)}else{if(t.weapon){s.save();const e=t.weapon.tile,i=2*e.w,l=2*e.h,h=l-28,o=24;if(s.translate(o,-h),t.state===c.MonsterState.Hit){let h=90*t.weapon.frame/(t.weapon.numOfFrames-1);s.translate(i>>1,l),s.rotate(h*Math.PI/180),s.drawImage(e.tileSet,e.x,e.y,e.w,e.h,-(i>>1),-l,i,l)}else s.drawImage(e.tileSet,e.x,e.y,e.w,e.h,0,0,i,l);s.restore()}s.drawImage(t.tile.tileSet,r,n,h,o,0,-m,a,w)}s.restore()}}}function x(t,e,i){if(t){const l=t.w,h=t.h,o=2*l,r=2*h,n=r-32,a=32-o>>1;if(e+o>0&&e<s.canvas.width&&i-n+r>0&&i-n<s.canvas.height)if(t.isAnim&&t.numOfFrames>1){const c=(new Date).getTime(),w=Math.floor(c/100)%t.numOfFrames,m=t.x+l*w,d=t.y;s.drawImage(t.tileSet,m,d,l,h,e+a,i-n,o,r)}else{const c=t.x,w=t.y;s.drawImage(t.tileSet,c,w,l,h,e+a,i-n,o,r)}}}!function t(){const l=(new Date).getTime();y.level.animate(l),function(t){const l=e.width,h=e.height;i.width=l,i.height=h,s.save(),s.fillStyle="rgb(34,34,34)",s.fillRect(0,0,l,h),m.save(),m.fillStyle="black",m.fillRect(0,0,l,h),m.globalCompositeOperation="lighter",p(l>>1,h>>1,192);let o=16*y.level.hero.x*2+8-l/2,r=16*y.level.hero.y*2+8-h/2;if(y.level.hero.state===c.MonsterState.Run){const e=y.level.hero.start,s=y.level.hero.speed,i=y.level.hero.tile.numOfFrames,l=s*i,h=Math.min(l,t-e)/l,n=32*(y.level.hero.new_x-y.level.hero.x)*h,a=32*(y.level.hero.new_y-y.level.hero.y)*h;o+=n,r+=a}for(let t=0;t<y.level.w;t++)for(let e=0;e<y.level.h;e++){const s=16*t*2-o,i=16*e*2-r;x(y.level.floor[e][t],s,i),y.level.drop[e][t]&&x(y.level.drop[e][t].tile,s,i)}for(let e=0;e<y.level.h;e++){for(let t=0;t<y.level.w;t++){const s=16*t*2-o,i=16*e*2-r,l=y.level.wall[e][t];l&&(x(l,s,i),"wall_fountain_mid_red_anim"!==l.name&&"wall_fountain_mid_blue_anim"!==l.name||p(s+16,i+16,128))}if(e<y.level.h-1)for(let s=0;s<y.level.w;s++){const i=e+1,l=16*s*2-o,h=16*i*2-r;v(y.level.monsters[i][s],l,h,t)}}s.restore(),s.save(),s.globalAlpha=.8,s.globalCompositeOperation="multiply",s.drawImage(i,0,0),s.restore()}(l),function(t){(function(t){const e=y.level.hero.healthMax,i=y.level.hero.health;s.save(),s.translate(40,40),s.fillStyle="rgb(0,0,0)",s.fillRect(0,0,8+10*e,28),s.fillStyle="rgb(255,0,0)",s.fillRect(4,4,10*i,20),s.fillStyle="rgb(255,255,255)",s.font="20px silkscreennormal",s.fillText(i.toString(),8,20),s.fillText(`$${u.coins}`,0,50),s.restore()})(),function(t){const i=e.width,l=e.height;if(s.save(),s.translate(i/2,60),s.fillStyle="rgb(255,255,255)",s.textAlign="center",s.font="20px silkscreennormal",s.fillText(`level ${y.level.level}`,0,0),s.restore(),y.level.boss){s.save(),s.translate(i/2,100);const t=4,e=20,l=500,h=y.level.boss.healthMax,o=y.level.boss.health,r=Math.min(10,Math.floor(l/h)),n=2*t+r*h;s.fillStyle="rgb(0,0,0)",s.fillRect(-(n>>1),0,n,2*t+e);const a=r*o;s.fillStyle="rgb(255,0,0)",s.fillRect(t-(r*h>>1),t,a,e),s.fillStyle="rgb(255,255,255)",s.font="20px silkscreennormal",s.fillText(`${y.level.boss.name} - ${o}`,2*t-(r*h>>1),t+16),s.restore()}y.level.log=y.level.log.slice(-5),s.save(),s.translate(40,l-100);for(let t=0;t<y.level.log.length;t++)s.fillStyle="rgb(255,255,255)",s.font="20px silkscreennormal",s.fillText(y.level.log[t],0,20*t);s.restore()}(),function(t){const i=e.width,l=e.height;y.level.hero.dead&&(s.save(),s.fillStyle="rgba(0, 0, 0, 0.7)",s.fillRect(0,0,i,l),s.translate(i/2,l/2),s.fillStyle="rgb(255,0,0)",s.textAlign="center",s.font="200px silkscreennormal",s.fillText("YOU DIED",0,0),s.restore())}(),function(t){const i=e.width,l=e.height,h=y.level.hero.inventory.cells,o=h.length,r=2*(18*o+2);s.save(),s.translate((i>>1)-(r>>1),l-40-40),s.fillStyle="rgb(100,100,100)",s.fillRect(0,0,r,40),s.translate(4,4);for(let e=0;e<o;e++){const i=18*e*2,l=0;s.fillStyle="rgb(70,70,70)",s.fillRect(i,0,32,32);const o=h[e];if(o.item){const e=o.item.tile;let h=e.x;const r=e.y,n=e.w,a=e.h;if(e.isAnim&&e.numOfFrames>1){const s=Math.floor(t/100)%e.numOfFrames;h=e.x+n*s}const c=a<=16?1:16/a,w=2*n*c,m=2*a*c,d=16-(w>>1);s.drawImage(e.tileSet,h,r,n,a,i+d,l,w,m),s.textAlign="end",s.textBaseline="top",s.font="10px silkscreennormal",s.fillStyle="rgb(255,255,255)",s.fillText(o.count.toString(),i+32,0,32)}}s.restore()}(t)}(l),window.requestAnimationFrame(t)}()}))}()},{"./drop":2,"./hero":4,"./input":5,"./level":7,"./monster":8,"./rng":9,"./scene":10,"./tilemap":11}],4:[function(t,e,s){"use strict";Object.defineProperty(s,"__esModule",{value:!0});const i=t("./inventory"),l=t("./monster");s.heroMonsterNames=["elf_f","elf_m","knight_f","knight_m","wizard_f","wizard_m"];s.HeroMonster=class{constructor(t,e,s,h,o,r,n){this.registry=t,this.joystick=e,this.x=s,this.y=h,this.new_x=s,this.new_y=h,this.is_left=!1,this.name=o,this.healthMax=30,this.health=this.healthMax,this.coins=0,this.baseDamage=1,this.dead=!1,this.weapon=r,this.speed=100,this.inventory=new i.Inventory,this.setAnimation(l.MonsterState.Idle,n)}get damage(){return this.baseDamage+(this.weapon?this.weapon.damage:0)}setLevel(t){this.level=t}setAnimation(t,e){switch(t){case l.MonsterState.Idle:this.state=t,this.tile=this.registry.get(this.name+"_idle_anim"),this.frame=0,this.start=e;break;case l.MonsterState.Run:this.dead||(this.state=t,this.tile=this.registry.get(this.name+"_run_anim"),this.frame=0,this.start=e);break;case l.MonsterState.Hit:this.dead||(this.state=t,this.tile=this.registry.get(this.name+"_hit_anim"),this.frame=0,this.weapon&&(this.weapon.frame=0),this.start=e)}}animate(t){switch(this.state){case l.MonsterState.Idle:this.frame=Math.floor((t-this.start)/this.speed),this.action(t)||this.frame>=this.tile.numOfFrames&&this.setAnimation(l.MonsterState.Idle,t);break;case l.MonsterState.Run:this.frame=Math.floor((t-this.start)/this.speed),this.frame>=this.tile.numOfFrames&&(this.level.monsters[this.y][this.x]=null,this.level.monsters[this.new_y][this.new_x]=this,this.x=this.new_x,this.y=this.new_y,this.scanDrop(),this.action(t)||this.setAnimation(l.MonsterState.Idle,t));break;case l.MonsterState.Hit:this.weapon?(this.weapon.frame=Math.floor((t-this.start)/this.weapon.speed),this.weapon.frame>=this.weapon.numOfFrames&&(this.scanHit(t),this.scanDrop(),this.action(t)||this.setAnimation(l.MonsterState.Idle,t))):(this.frame=Math.floor((t-this.start)/this.speed),this.frame>=this.tile.numOfFrames&&(this.scanHit(t),this.scanDrop(),this.action(t)||this.setAnimation(l.MonsterState.Idle,t)))}}action(t){if(!this.dead){this.scanDrop();for(let t=0;t<10;t++){const e=(t+1)%10;this.joystick.digit(e).processed||(this.joystick.digit(e).processed=!0,this.inventory.cells[t].use(this))}if(this.joystick.drop.processed||(this.joystick.drop.processed=!0,this.dropWeapon()),this.joystick.hit.triggered&&!this.joystick.hit.processed)return"floor_ladder"===this.level.floor[this.y][this.x].name?(this.joystick.hit.processed=!0,this.level.exit(t),!0):(this.setAnimation(l.MonsterState.Hit,t),!0);if((this.joystick.moveUp.triggered||!this.joystick.moveUp.processed)&&(this.joystick.moveUp.processed=!0,this.move(0,-1,t)))return!0;if((this.joystick.moveDown.triggered||!this.joystick.moveDown.processed)&&(this.joystick.moveDown.processed=!0,this.move(0,1,t)))return!0;if((this.joystick.moveLeft.triggered||!this.joystick.moveLeft.processed)&&(this.joystick.moveLeft.processed=!0,this.is_left=!0,this.move(-1,0,t)))return!0;if((this.joystick.moveRight.triggered||!this.joystick.moveRight.processed)&&(this.joystick.moveRight.processed=!0,this.is_left=!1,this.move(1,0,t)))return!0}return!1}dropWeapon(){if(this.weapon){const t=5;let e=this.x,s=this.x,i=this.y,l=this.y;for(let h=0;h<t;h++){e--,s++,i--,l++;let t=this.y,o=this.y;for(let i=0;i<=h;i++){let i=this.is_left?[e,s]:[s,e],l=[t,o];for(let t=0;t<2;t++){let e=i[t];for(let t=0;t<2;t++){let s=l[t];if(e>=0&&s>=0&&!this.level.drop[s][e]&&this.level.floor[s][e]){const t=this.weapon;return this.weapon=null,void(this.level.drop[s][e]=t)}}}t--,o++}for(let i=0;i<h;h++){e++,s--;let i=this.is_left?[e,s]:[s,e],l=[t,o];for(let t=0;t<2;t++){let e=i[t];for(let t=0;t<2;t++){let s=l[t];if(e>=0&&s>=0&&!this.level.drop[s][e]&&this.level.floor[s][e]){const t=this.weapon;return this.weapon=null,void(this.level.drop[s][e]=t)}}}}}}}scanDrop(){if(this.level.drop[this.y][this.x]){this.level.drop[this.y][this.x].pickedUp(this)&&(this.level.drop[this.y][this.x]=null)}}scanHit(t){const e=this.weapon?this.weapon.distance:1,s=this.is_left?Math.max(0,this.x-e):this.x,i=this.is_left?this.x:Math.min(this.level.w,this.x+e),l=Math.max(0,this.y-e),h=Math.min(this.level.h,this.y+e);for(let e=l;e<=h;e++)for(let l=s;l<=i;l++)if(l!==this.x||e!==this.y){const s=this.level.monsters[e][l];s&&s.hitDamage(this.damage,this.name,t)}}move(t,e,s){if(!this.dead&&this.state===l.MonsterState.Idle){const i=this.x+t,h=this.y+e;return!!this.level.floor[h][i]&&(!this.level.monsters[h][i]&&(this.level.monsters[h][i]=new l.MovingMonsterWrapper(this),this.new_x=i,this.new_y=h,this.setAnimation(l.MonsterState.Run,s),!0))}return!1}resetPosition(t,e){this.x=t,this.y=e,this.new_x=t,this.new_y=e}hitDamage(t,e,s){this.dead||(this.level.log.push(`${this.name} damaged ${t} by ${e}`),this.health=Math.max(0,this.health-t),this.health<=0&&(this.level.log.push(`${this.name} killed by ${e}`),this.setAnimation(l.MonsterState.Idle,s),this.dead=!0))}hill(t){this.health=Math.min(this.healthMax,this.health+t)}addCoins(t){this.coins=this.coins+t}}},{"./inventory":6,"./monster":8}],5:[function(t,e,s){"use strict";var i;Object.defineProperty(s,"__esModule",{value:!0}),function(t){t[t.Await=1]="Await",t[t.Pressed=2]="Pressed"}(i||(i={}));class l{constructor(t){this.code=t,this.state=i.Await,this.triggered=!1,this.processed=!0}keydown(t){t.code===this.code&&(t.preventDefault(),this.state===i.Await&&(this.triggered=!0,this.processed=!1,this.state=i.Pressed))}keyup(t){t.code===this.code&&(t.preventDefault(),this.state===i.Pressed&&(this.triggered=!1,this.state=i.Await))}}s.KeyBind=l;s.Joystick=class{constructor(){this.moveUp=new l("KeyW"),this.moveLeft=new l("KeyA"),this.moveDown=new l("KeyS"),this.moveRight=new l("KeyD"),this.hit=new l("KeyF"),this.drop=new l("KeyQ"),this.digit1=new l("Digit1"),this.digit2=new l("Digit2"),this.digit3=new l("Digit3"),this.digit4=new l("Digit4"),this.digit5=new l("Digit5"),this.digit6=new l("Digit6"),this.digit7=new l("Digit7"),this.digit8=new l("Digit8"),this.digit9=new l("Digit9"),this.digit0=new l("Digit0"),this.init()}digit(t){switch(t){case 1:return this.digit1;case 2:return this.digit2;case 3:return this.digit3;case 4:return this.digit4;case 5:return this.digit5;case 6:return this.digit6;case 7:return this.digit7;case 8:return this.digit8;case 9:return this.digit9;case 0:return this.digit0}}init(){window.addEventListener("keydown",this.keydown.bind(this)),window.addEventListener("keyup",this.keyup.bind(this))}keydown(t){this.moveUp.keydown(t),this.moveLeft.keydown(t),this.moveDown.keydown(t),this.moveRight.keydown(t),this.hit.keydown(t),this.drop.keydown(t),this.digit1.keydown(t),this.digit2.keydown(t),this.digit3.keydown(t),this.digit4.keydown(t),this.digit5.keydown(t),this.digit6.keydown(t),this.digit7.keydown(t),this.digit8.keydown(t),this.digit9.keydown(t),this.digit0.keydown(t)}keyup(t){this.moveUp.keyup(t),this.moveLeft.keyup(t),this.moveDown.keyup(t),this.moveRight.keyup(t),this.hit.keyup(t),this.drop.keyup(t),this.digit1.keyup(t),this.digit2.keyup(t),this.digit3.keyup(t),this.digit4.keyup(t),this.digit5.keyup(t),this.digit6.keyup(t),this.digit7.keyup(t),this.digit8.keyup(t),this.digit9.keyup(t),this.digit0.keyup(t)}}},{}],6:[function(t,e,s){"use strict";Object.defineProperty(s,"__esModule",{value:!0});s.Inventory=class{constructor(){this.cells=[];for(let t=0;t<10;t++)this.cells[t]=new i}add(t){for(let e=0;e<this.cells.length;e++)if(this.cells[e].stack(t))return!0;for(let e=0;e<this.cells.length;e++)if(this.cells[e].set(t))return!0;return!1}};class i{constructor(){this.maxInStack=3,this.item=null,this.count=0}stack(t){return!!(this.item&&this.item.same(t)&&this.count<this.maxInStack)&&(this.count++,!0)}set(t){return!this.item&&(this.item=t,this.count=1,!0)}use(t){return!!(this.item&&this.count>0)&&(this.item.use(this,t),!0)}}s.InventoryCell=i},{}],7:[function(t,e,s){"use strict";Object.defineProperty(s,"__esModule",{value:!0});const i=t("./tiny.monster"),l=t("./drop"),h=t("./boss.monster");class o{constructor(t,e,s,i){this.x=t,this.y=e,this.w=s,this.h=i}expand(){const t=this;return new o(t.x-2,t.y-3,t.w+2+2,t.h+3+3)}expandV(){const t=this;return new o(t.x-2,t.y,t.w+2+2,t.h)}expandH(){const t=this;return new o(t.x,t.y-3,t.w,t.h+3+3)}isOverlap(t){const e=this;return e.x<t.x+t.w&&e.x+e.w>t.x&&e.y<t.y+t.h&&e.y+e.h>t.y}}s.Rect=o;class r{constructor(t,e,s,i,l,h){this.rng=t,this.registry=e,this.scene=s,this.level=l,this.w=200,this.h=120,this.log=[],this.rooms=[],this.corridorsV=[],this.corridorsH=[],this.floor=this.createBuffer(()=>null),this.drop=this.createBuffer(()=>null),this.wall=this.createBuffer(()=>null),this.monsterList=[],this.hero=i,this.monsters=this.createBuffer(()=>null),this.generate(h),this.fill(),this.replace()}createBuffer(t){const e=[];for(let s=0;s<this.h;s++){const s=[];e.push(s);for(let e=0;e<this.w;e++)s.push(t())}return e}generate(t){const e=1+this.level,s=3+this.level,l=5+this.level,o=this.level%5==0;for(let t=0;t<e;t++)this.generateRoom();const r=this.rooms.length-(o?1:0);if(r>1)for(let e=0;e<s;e++){const e=this.rng.nextRange(1,r),s=this.rooms[e];for(let e=0;e<10;e++){const e=s.x+this.rng.nextRange(0,s.w),l=s.y+this.rng.nextRange(0,s.h);if(!this.monsters[l][e]){const s=this.rng.choice(i.tinyMonsterNames),h=new i.TinyMonster(this.rng,this.registry,this,e,l,s,t);this.monsterList.push(h),this.monsters[l][e]=h;break}}}if(o){const e=this.rooms[this.rooms.length-1];for(let s=0;s<10;s++){const s=e.x+this.rng.nextRange(1,e.w),i=e.y+this.rng.nextRange(1,e.h);if(!(this.monsters[i][s]||this.monsters[i][s+1]||this.monsters[i-1][s]||this.monsters[i-1][s+1])){const e=h.mossMonsterNames[Math.floor(this.level/5)%h.mossMonsterNames.length],l=new h.BossMonster(this.rng,this.registry,this,s,i,e,t);this.boss=l,this.monsters[i][s]=l;break}}}for(let t=0;t<l;t++){const t=this.rng.choice(this.rooms);for(let e=0;e<10;e++){const e=t.x+this.rng.nextRange(0,t.w),s=t.y+this.rng.nextRange(0,t.h);if(!this.drop[s][e]){this.randomDrop(e,s);break}}}{const t=this.rooms[0],e=t.x+(t.w>>1),s=t.y+(t.h>>1);this.hero.setLevel(this),this.hero.resetPosition(e,s),this.monsters[s][e]=this.hero}}generateRoom(){for(let t=0;t<1e3;t++){const t=this.rng.nextRange(5,15),e=this.rng.nextRange(3,10),s=new o(this.rng.nextRange(2,this.w-2-t),this.rng.nextRange(2,this.h-2-e),t,e);if(!this.isOverlap(s.expand())){if(0===this.rooms.length){this.rooms.push(s);break}{const t=s;let e=!1;for(let s=0;s<this.rooms.length;s++){let i=this.rooms[s];const l=Math.max(t.x,i.x),h=Math.min(t.x+t.w,i.x+i.w);if(l+5<=h){let s;s=t.y+t.h<i.y?new o(l+2,t.y+t.h,h-l-4,i.y-t.y-t.h):new o(l+2,i.y+i.h,h-l-4,t.y-i.y-i.h),s.h<12&&!this.isOverlap(s.expandV())&&(this.corridorsV.push(s),e=!0)}const r=Math.max(t.y,i.y),n=Math.min(t.y+t.h,i.y+i.h);if(r+3<=n){let s;s=t.x+t.w<i.x?new o(t.x+t.w,r+1,i.x-t.x-t.w,n-r-2):new o(i.x+i.w,r+1,t.x-i.x-i.w,n-r-2),s.w<12&&!this.isOverlap(s.expandH())&&(this.corridorsH.push(s),e=!0)}}if(e){console.log("add room",s),this.rooms.push(s);break}}}}}isOverlap(t){const e=t.isOverlap.bind(t);return this.rooms.some(e)||this.corridorsV.some(e)||this.corridorsH.some(e)}randomDrop(t,e){const s=53*this.rng.nextFloat();if(s<3){const s=l.WeaponConfig.configs.filter(t=>t.level<=this.level);this.drop[e][t]=this.rng.choice(s).create(this.registry)}else s<10?this.drop[e][t]=new l.HealthBigFlask(this.registry):s<10?this.drop[e][t]=new l.HealthFlask(this.registry):s<30&&(this.drop[e][t]=new l.Coins(this.rng,this.registry))}fill(){this.rooms.forEach(t=>this.fillRoom(t.x,t.y,t.w,t.h)),this.corridorsH.forEach(t=>this.fillCorridorH(t.x,t.y,t.w,t.h)),this.corridorsV.forEach(t=>this.fillCorridorV(t.x,t.y,t.w,t.h))}fillRoom(t,e,s,i){for(let l=e;l<e+i;l++)for(let e=t;e<t+s;e++)this.floor[l][e]=this.registry.get("floor_1");if(this.wall[e-2][t]=this.registry.get("wall_corner_top_left"),this.wall[e-1][t]=this.registry.get("wall_corner_left"),s>1){for(let i=t+1;i<t+s-1;i++)this.wall[e-2][i]=this.registry.get("wall_top_mid"),this.wall[e-1][i]=this.registry.get("wall_mid");this.wall[e-2][t+s-1]=this.registry.get("wall_corner_top_right"),this.wall[e-1][t+s-1]=this.registry.get("wall_corner_right")}if(this.wall[e+i-1][t]=this.registry.get("wall_corner_bottom_left"),this.wall[e+i][t]=this.registry.get("wall_left"),s>1){for(let l=t+1;l<t+s-1;l++)this.wall[e+i-1][l]=this.registry.get("wall_top_mid"),this.wall[e+i][l]=this.registry.get("wall_mid");this.wall[e+i-1][t+s-1]=this.registry.get("wall_corner_bottom_right"),this.wall[e+i][t+s-1]=this.registry.get("wall_right")}for(let s=e;s<e+i-1;s++)this.wall[s][t]=this.registry.get("wall_side_mid_right");for(let l=e;l<e+i-1;l++)this.wall[l][t+s-1]=this.registry.get("wall_side_mid_left")}fillCorridorH(t,e,s,i){for(let l=e;l<e+i;l++)for(let e=t;e<t+s;e++)this.floor[l][e]=this.registry.get("floor_1");switch(this.wall[e-2][t-1].name){case"wall_corner_top_right":this.wall[e-2][t-1]=this.registry.get("wall_top_mid");break;case"wall_side_mid_left":break;default:console.log("top left 2",this.wall[e-2][t-1])}switch(this.wall[e-1][t-1].name){case"wall_corner_right":this.wall[e-1][t-1]=this.registry.get("wall_mid");break;case"wall_side_mid_left":this.wall[e-1][t-1]=this.registry.get("wall_side_front_left");break;default:console.log("top left 1",this.wall[e-1][t-1])}if(i>1)for(let s=e;s<e+i-1;s++)switch(this.wall[s][t-1].name){case"wall_side_mid_left":this.wall[s][t-1]=null;break;default:console.log("mid left",this.wall[s][t-1])}switch(this.wall[e+i-1][t-1].name){case"wall_side_mid_left":this.wall[e+i-1][t-1]=this.registry.get("wall_side_top_left");break;case"wall_corner_bottom_right":this.wall[e+i-1][t-1]=this.registry.get("wall_top_mid");break;default:console.log("bottom left 0",this.wall[e+i-1][t-1])}switch(this.wall[e+i][t-1].name){case"wall_side_mid_left":break;case"wall_right":this.wall[e+i][t-1]=this.registry.get("wall_mid");break;default:console.log("bottom left 1",this.wall[e+i][t-1])}switch(this.wall[e-2][t+s].name){case"wall_corner_top_left":this.wall[e-2][t+s]=this.registry.get("wall_top_mid");break;case"wall_side_mid_right":break;default:console.log("top right 2",this.wall[e-2][t+s])}switch(this.wall[e-1][t+s].name){case"wall_corner_left":this.wall[e-1][t+s]=this.registry.get("wall_mid");break;case"wall_side_mid_right":this.wall[e-1][t+s]=this.registry.get("wall_side_front_right");break;default:console.log("top right 1",this.wall[e-1][t+s])}if(i>1)for(let l=e;l<e+i-1;l++)switch(this.wall[l][t+s].name){case"wall_side_mid_right":this.wall[l][t+s]=null;break;default:console.log("mid right",this.wall[l][t+s])}switch(this.wall[e+i-1][t+s].name){case"wall_side_mid_right":this.wall[e+i-1][t+s]=this.registry.get("wall_side_top_right");break;case"wall_corner_bottom_left":this.wall[e+i-1][t+s]=this.registry.get("wall_top_mid");break;default:console.log("bottom right 0",this.wall[e+i-1][t+s])}switch(this.wall[e+i][t+s].name){case"wall_side_mid_right":break;case"wall_left":this.wall[e+i][t+s]=this.registry.get("wall_mid");break;default:console.log("bottom right +1",this.wall[e+i][t+s])}for(let i=t;i<t+s;i++)this.wall[e-2][i]=this.registry.get("wall_top_mid"),this.wall[e-1][i]=this.registry.get("wall_mid");for(let l=t;l<t+s;l++)this.wall[e+i-1][l]=this.registry.get("wall_top_mid"),this.wall[e+i][l]=this.registry.get("wall_mid")}fillCorridorV(t,e,s,i){for(let l=e;l<e+i;l++)for(let e=t;e<t+s;e++)this.floor[l][e]=this.registry.get("floor_1");switch(this.wall[e-1][t-1].name){case"wall_top_mid":this.wall[e-1][t-1]=this.registry.get("wall_corner_top_right");break;default:console.log("top left -1 -1",this.wall[e-1][t-1])}switch(this.wall[e][t-1].name){case"wall_mid":this.wall[e][t-1]=this.registry.get("wall_corner_right");break;default:console.log("top left 0 -1",this.wall[e][t-1])}for(let i=t;i<t+s;i++){switch(this.wall[e-1][i].name){case"wall_top_mid":this.wall[e-1][i]=null;break;default:console.log("top mid -1",this.wall[e-1][i])}switch(this.wall[e][i].name){case"wall_mid":this.wall[e][i]=null;break;default:console.log("top mid 0",this.wall[e][i])}}switch(this.wall[e-1][t+s].name){case"wall_top_mid":this.wall[e-1][t+s]=this.registry.get("wall_corner_top_left");break;default:console.log("top right -1 1",this.wall[e-1][t+s])}switch(this.wall[e][t+s].name){case"wall_mid":this.wall[e][t+s]=this.registry.get("wall_corner_left");break;default:console.log("top right 0 -1",this.wall[e][t+s])}switch(this.wall[e+i-2][t-1].name){case"wall_top_mid":this.wall[e+i-2][t-1]=this.registry.get("wall_corner_bottom_right");break;default:console.log("bottom left -2 -1",this.wall[e+i-2][t-1])}switch(this.wall[e+i-1][t-1].name){case"wall_mid":this.wall[e+i-1][t-1]=this.registry.get("wall_corner_front_right");break;default:console.log("top left 0 -1",this.wall[e+i-1][t-1])}for(let l=t;l<t+s;l++){switch(this.wall[e+i-2][l].name){case"wall_top_mid":this.wall[e+i-2][l]=null;break;default:console.log("bottom mid -2",this.wall[e+i-2][l])}switch(this.wall[e+i-1][l].name){case"wall_mid":this.wall[e+i-1][l]=null;break;default:console.log("bottom mid -1",this.wall[e+i-1][l])}}switch(this.wall[e+i-2][t+s].name){case"wall_top_mid":this.wall[e+i-2][t+s]=this.registry.get("wall_corner_bottom_left");break;default:console.log("bottom right -2 -1",this.wall[e+i-2][t-1])}switch(this.wall[e+i-1][t+s].name){case"wall_mid":this.wall[e+i-1][t+s]=this.registry.get("wall_corner_front_left");break;default:console.log("bottom right 0 -1",this.wall[e+i-1][t-1])}for(let l=e+1;l<e+i-2;l++)this.wall[l][t-1]=this.registry.get("wall_side_mid_left"),this.wall[l][t+s]=this.registry.get("wall_side_mid_right")}replace(){this.replaceFloorRandomly(),this.replaceLadder(),this.replaceWallRandomly()}replaceFloorRandomly(){const t=["floor_2","floor_3","floor_4","floor_5","floor_6","floor_7","floor_8"];for(let e=0;e<this.h;e++)for(let s=0;s<this.w;s++)this.floor[e][s]&&this.rng.nextFloat()<.2&&(this.floor[e][s]=this.registry.get(this.rng.choice(t)))}replaceLadder(){const t=this.rooms[this.rooms.length-1],e=t.x+(t.w>>1),s=t.y+(t.h>>1);console.log(e,s,t),this.floor[s][e]=this.registry.get("floor_ladder")}replaceWallRandomly(){const t=["wall_hole_1","wall_hole_2","wall_banner_red","wall_banner_blue","wall_banner_green","wall_banner_yellow","wall_goo","wall_fountain_mid_red_anim","wall_fountain_mid_blue_anim"],e=["wall_hole_1","wall_hole_2"];for(let s=0;s<this.h;s++)for(let i=0;i<this.w;i++)if(this.wall[s][i])switch(this.wall[s][i].name){case"wall_mid":if(this.rng.nextFloat()<.2){let l;l=!!this.floor[s+1][i]?t:e;const h=this.rng.choice(l);switch(h){case"wall_goo":this.wall[s][i]=this.registry.get("wall_goo"),this.floor[s+1][i]=this.registry.get("wall_goo_base");break;case"wall_fountain_mid_red_anim":this.wall[s-1][i]=this.registry.get("wall_fountain_top"),this.wall[s][i]=this.registry.get("wall_fountain_mid_red_anim"),this.floor[s+1][i]=this.registry.get("wall_fountain_basin_red_anim");break;case"wall_fountain_mid_blue_anim":this.wall[s-1][i]=this.registry.get("wall_fountain_top"),this.wall[s][i]=this.registry.get("wall_fountain_mid_blue_anim"),this.floor[s+1][i]=this.registry.get("wall_fountain_basin_blue_anim");break;default:this.wall[s][i]=this.registry.get(h)}}}}exit(t){this.scene.setLevel(new r(this.rng,this.registry,this.scene,this.hero,this.level+1,t))}animate(t){this.hero.animate(t),this.boss&&this.boss.animate(t),this.monsterList.forEach(e=>e.animate(t))}}s.Level=r},{"./boss.monster":1,"./drop":2,"./tiny.monster":12}],8:[function(t,e,s){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),function(t){t[t.Idle=0]="Idle",t[t.Run=1]="Run",t[t.Hit=2]="Hit"}(s.MonsterState||(s.MonsterState={}));s.MovingMonsterWrapper=class{constructor(t){this.monster=t}hitDamage(t,e,s){this.monster.hitDamage(t,e,s)}get x(){return this.monster.x}get y(){return this.monster.y}get new_x(){return this.monster.new_x}get new_y(){return this.monster.new_y}get is_left(){return this.monster.is_left}get frame(){return this.monster.frame}get start(){return this.monster.start}get speed(){return this.monster.speed}get tile(){return this.monster.tile}get state(){return this.monster.state}get weapon(){return this.monster.weapon}animate(t){}}},{}],9:[function(t,e,s){"use strict";Object.defineProperty(s,"__esModule",{value:!0});const i=2147483648;s.RNG=class{constructor(t=null){this.state=t||Math.floor(Math.random()*(i-1)),console.log("seed",this.state)}nextInt(){return this.state=(1103515245*this.state+12345)%i,this.state}nextFloat(){return this.nextInt()/(i-1)}nextRange(t,e){const s=e-t,l=this.nextInt()/i;return t+Math.floor(l*s)}choice(t){return t[this.nextRange(0,t.length)]}}},{}],10:[function(t,e,s){"use strict";Object.defineProperty(s,"__esModule",{value:!0});s.Scene=class{setLevel(t){this.level=t}}},{}],11:[function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,e,s,i){return new(s||(s=Promise))((function(l,h){function o(t){try{n(i.next(t))}catch(t){h(t)}}function r(t){try{n(i.throw(t))}catch(t){h(t)}}function n(t){var e;t.done?l(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,r)}n((i=i.apply(t,e||[])).next())}))};Object.defineProperty(s,"__esModule",{value:!0});s.TileRegistry=class{constructor(){this.tileMap={}}loadTileSet(){return i(this,void 0,void 0,(function*(){return yield new Promise(t=>{const e=new Image;e.onload=s=>t(e),e.src="0x72_DungeonTilesetII_v1.2.png"})}))}load(){return i(this,void 0,void 0,(function*(){const t=yield this.loadTileSet(),e=yield fetch("tiles_list_v1.1.txt");(yield e.text()).split(/(\r?\n)/g).forEach(e=>{let s=e.match(/([a-z0-9_]+) +([0-9]+) +([0-9]+) +([0-9]+) +([0-9]+) ?([0-9]?)/);if(s){const e=parseInt(s[2]),i=parseInt(s[3]),h=parseInt(s[4]),o=parseInt(s[5]),r=parseInt(s[6]||"0"),n=new l(t,s[1],e,i,h,o,r);this.tileMap[n.name]=n}})}))}get(t){return this.tileMap[t]}};class l{constructor(t,e,s,i,l,h,o){this.tileSet=t,this.name=e,this.x=s,this.y=i,this.w=l,this.h=h,this.numOfFrames=o,this.isAnim=this.numOfFrames>1}}s.Tile=l},{}],12:[function(t,e,s){"use strict";Object.defineProperty(s,"__esModule",{value:!0});const i=t("./monster");s.tinyMonsterNames=["tiny_zombie","goblin","imp","skeleton","muddy","swampy","zombie","ice_zombie"];s.TinyMonster=class{constructor(t,e,s,l,h,o,r){this.rng=t,this.registry=e,this.level=s,this.x=l,this.y=h,this.new_x=l,this.new_y=h,this.is_left=!1,this.name=o,this.healthMax=10,this.health=this.healthMax,this.damage=3,this.luck=.5,this.speed=100,this.setAnimation(i.MonsterState.Idle,r)}setAnimation(t,e){switch(t){case i.MonsterState.Idle:this.state=t,this.tile=this.registry.get(this.name+"_idle_anim"),this.frame=0,this.start=e;break;case i.MonsterState.Run:this.state=t,this.tile=this.registry.get(this.name+"_run_anim"),this.frame=0,this.start=e}}animate(t){if(this.frame=Math.floor((t-this.start)/this.speed),this.frame>=this.tile.numOfFrames){this.state===i.MonsterState.Run&&(this.level.monsters[this.y][this.x]=null,this.level.monsters[this.new_y][this.new_x]=this,this.x=this.new_x,this.y=this.new_y),this.setAnimation(i.MonsterState.Idle,t);const e=3,s=Math.max(0,this.x-e),l=Math.max(0,this.y-e),h=Math.min(this.level.w,this.x+e),o=Math.min(this.level.h,this.y+e);if(!this.level.hero.dead&&this.level.hero.x>=s&&this.level.hero.x<=h&&this.level.hero.y>=l&&this.level.hero.y<=o){const e=Math.abs(this.x-this.level.hero.x),s=Math.abs(this.y-this.level.hero.y);if(e>1){const e=Math.max(-1,Math.min(1,this.level.hero.x-this.x));if(this.move(e,0,t))return void console.log("move to hero x")}if(s>0){const e=Math.max(-1,Math.min(1,this.level.hero.y-this.y));if(this.move(0,e,t))return void console.log("move to hero y")}if(e<=1&&s<=1&&this.rng.nextFloat()<this.luck)return void this.level.hero.hitDamage(this.damage,this.name,t)}const r=.1;if(this.rng.nextFloat()<r){const e=this.rng.nextRange(-1,2),s=this.rng.nextRange(-1,2);if(this.move(e,s,t))return}}}move(t,e,s){if(this.is_left=t<0,this.state===i.MonsterState.Idle){const l=this.x+t,h=this.y+e;return!!this.level.floor[h][l]&&(!this.level.monsters[h][l]&&(this.level.monsters[h][l]=new i.MovingMonsterWrapper(this),this.new_x=l,this.new_y=h,this.setAnimation(i.MonsterState.Run,s),!0))}return!1}hitDamage(t,e,s){this.level.log.push(`${this.name} damaged ${t} by ${e}`),this.health=Math.max(0,this.health-t),this.health<=0&&(this.level.log.push(`${this.name} killed by ${e}`),this.level.monsters[this.y][this.x]=null,this.level.monsters[this.new_y][this.new_x]=null,this.level.monsterList=this.level.monsterList.filter(t=>t!==this),this.rng.nextFloat()<this.luck&&this.level.randomDrop(this.x,this.y))}}},{"./monster":8}]},{},[3]);
//# sourceMappingURL=bundle.js.map
