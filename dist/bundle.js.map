{"version":3,"sources":["node_modules/browser-pack/_prelude.js","src/drop.ts","src/dungeon.ts","src/hero.ts","src/input.ts","src/inventory.ts","src/level.ts","src/monster.ts","src/rng.ts","src/scene.ts","src/tilemap.ts","src/tiny.monster.ts"],"names":["r","e","n","t","o","i","f","c","require","u","a","Error","code","p","exports","call","length","1","module","Coins","[object Object]","rng","registry","this","tile","get","coins","nextRange","hero","addCoins","HealthFlask","health","inventory","add","item","hill","HealthBigFlask","input_1","tilemap_1","hero_1","level_1","scene_1","rng_1","monster_1","TileRegistry","load","canvas","document","getElementById","ctx","getContext","imageSmoothingEnabled","buffer","createElement","b_ctx","start","Date","getTime","RNG","joystick","Joystick","hero_weapon","Weapon","HeroMonster","scene","Scene","setLevel","Level","renderLight","x","y","radius","diameter","box_x","box_y","grd","createRadialGradient","addColorStop","fillStyle","fillRect","renderMonster","monster","dx","dy","time","MovingMonsterWrapper","sw","w","sh","h","sx","frame","sy","dw","dh","tile_offset_y","offset_x","offset_y","state","MonsterState","Run","maxTime","speed","numOfFrames","delta","Math","min","scale","new_x","new_y","width","height","save","translate","is_left","weapon","w_dw","w_dh","w_dy","w_dx","Hit","angle","rotate","PI","drawImage","tileSet","restore","renderTile","isAnim","sf","floor","render","level","animate","c_w","c_h","globalCompositeOperation","t_x","t_y","t_offset_x","t_offset_y","l_x","l_y","d_x","d_y","drop","wall","name","m_y","monsters","globalAlpha","renderLevel","h_m","healthMax","border","font","fillText","toString","renderHealth","textAlign","log","slice","renderLevelTitle","dead","renderYouDead","cells","grid_w","inv_w","grid_spacing","g_x","c_x","c_y","cell_size","cell","textBaseline","count","renderInventory","renderHUD","window","requestAnimationFrame","inventory_1","heroMonsterNames","damage","Inventory","setAnimation","Idle","action","scanDrop","scanHit","d","digit","processed","use","hit","triggered","exit","moveUp","move","moveDown","moveLeft","moveRight","pickedUp","max_distance","distance","scan_x_min","max","scan_x_max","scan_y_min","scan_y_max","s_y","s_x","hitDamage","push","weaponNames","tileName","KeyBindState","KeyBind","Await","preventDefault","Pressed","digit1","digit2","digit3","digit4","digit5","digit6","digit7","digit8","digit9","digit0","init","num","addEventListener","keydown","bind","keyup","InventoryCell","stack","set","maxInStack","same","tiny_monster_1","drop_1","Rect","b","l","rooms","corridorsV","corridorsH","createBuffer","monsterList","generate","fill","replace","defaultValue","rows","row","rooms_total","monsters_total","drop_total","generateRoom","m","room","choice","tinyMonsterNames","TinyMonster","randomDrop","hero_x","hero_y","resetPosition","room_w","room_h","isOverlap","expand","connected","max_x","min_x_w","rect","expandV","max_y","min_y_h","expandH","some","nextFloat","forEach","fillRoom","fillCorridorH","fillCorridorV","r_y","r_x","console","replaceFloorRandomly","replaceLadder","replaceWallRandomly","replacements","last","ladder_x","ladder_y","wall_mid_top_replaces","wall_mid_bottom_replaces","replacement","seed","random","nextInt","end","rangeSize","randomUnder1","array","tileMap","Promise","resolve","img","Image","onload","ev","src","loadTileSet","response","fetch","text","split","line","match","parseInt","Tile","luck","dist_x","abs","dist_y","move_x","move_y","random_move_percent","filter","s"],"mappings":"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","file":"bundle.js","sourcesContent":["(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c=\"function\"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error(\"Cannot find module '\"+i+\"'\");throw a.code=\"MODULE_NOT_FOUND\",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u=\"function\"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()","import {RNG} from \"./rng\";\nimport {HeroMonster} from \"./hero\";\nimport {Tile, TileRegistry} from \"./tilemap\";\n\nexport interface Drop {\n  readonly tile: Tile\n  pickedUp(hero: HeroMonster): boolean;\n}\n\nexport interface UsableDrop extends Drop {\n  same(item: UsableDrop): boolean;\n  use(hero: HeroMonster): void;\n}\n\nexport class Coins implements Drop {\n  readonly tile: Tile;\n  private readonly coins: number;\n\n  constructor(rng: RNG, registry: TileRegistry) {\n    this.tile = registry.get(\"coin_anim\");\n    this.coins = rng.nextRange(1, 30)\n  }\n\n  pickedUp(hero: HeroMonster): boolean {\n    hero.addCoins(this.coins);\n    return true;\n  };\n}\n\nexport class HealthFlask implements UsableDrop {\n  readonly tile: Tile;\n  private readonly health: number;\n\n  constructor(registry: TileRegistry) {\n    this.tile = registry.get(\"flask_red\");\n    this.health = 2;\n  }\n\n  pickedUp(hero: HeroMonster): boolean {\n    return hero.inventory.add(this);\n\n  };\n\n  same(item: UsableDrop): boolean {\n    return item instanceof HealthFlask;\n  };\n\n  use(hero: HeroMonster) {\n    hero.hill(this.health);\n  };\n}\n\nexport class HealthBigFlask implements UsableDrop {\n  readonly tile: Tile;\n  private readonly health: number;\n\n  constructor(registry: TileRegistry) {\n    this.tile = registry.get(\"flask_big_red\");\n    this.health = 5;\n  }\n\n  pickedUp(hero: HeroMonster): boolean {\n    return hero.inventory.add(this);\n  };\n\n  same(item: UsableDrop): boolean {\n    return item instanceof HealthBigFlask;\n  };\n\n  use(hero: HeroMonster) {\n    hero.hill(this.health);\n  };\n}","import {Joystick} from \"./input\";\nimport {Tile, TileRegistry} from \"./tilemap\";\nimport {HeroMonster, Weapon} from \"./hero\";\nimport {Level} from \"./level\";\nimport {Scene} from \"./scene\";\nimport {RNG} from \"./rng\";\nimport {Monster, MonsterState, MovingMonsterWrapper} from \"./monster\";\n\n(async function () {\n\n  // https://0x72.itch.io/dungeontileset-ii\n\n  const registry = new TileRegistry();\n  await registry.load();\n\n  const canvas: HTMLCanvasElement = document.getElementById(\"dungeon\") as HTMLCanvasElement;\n  const ctx = canvas.getContext(\"2d\");\n  ctx.imageSmoothingEnabled = false;\n\n  const buffer = document.createElement(\"canvas\");\n  const b_ctx = buffer.getContext(\"2d\");\n  b_ctx.imageSmoothingEnabled = false;\n\n  const start = new Date().getTime();\n  const rng = new RNG();\n  const joystick = new Joystick();\n  const hero_weapon = new Weapon(registry,\"weapon_rusty_sword\");\n  const hero = new HeroMonster(registry, joystick,0, 0, \"knight_f\", hero_weapon, start);\n  const scene = new Scene();\n  scene.setLevel(new Level(rng, registry, scene, hero, 1, start));\n\n  const scale = 2;\n  function render() {\n    const time = new Date().getTime();\n    scene.level.animate(time);\n    renderLevel(time);\n    renderHUD(time);\n    window.requestAnimationFrame(render);\n  }\n\n  function renderLevel(time: number) {\n    const c_w = canvas.width;\n    const c_h = canvas.height;\n    buffer.width = c_w;\n    buffer.height = c_h;\n\n    ctx.save();\n    ctx.fillStyle = \"rgb(34,34,34)\";\n    ctx.fillRect(0, 0, c_w, c_h);\n\n    b_ctx.save();\n    b_ctx.fillStyle = \"black\";\n    b_ctx.fillRect(0, 0, c_w, c_h);\n    b_ctx.globalCompositeOperation = \"lighter\";\n\n    // render hero light\n    renderLight(c_w >> 1, c_h >> 1, 16 * scale * 6);\n\n    let t_x = scene.level.hero.x * 16 * scale + 8 - c_w / 2;\n    let t_y = scene.level.hero.y * 16 * scale + 8 - c_h / 2;\n\n    // translate level to hero position\n    if(scene.level.hero.state === MonsterState.Run) {\n      const start = scene.level.hero.start;\n      const speed = scene.level.hero.speed;\n      const numOfFrames = scene.level.hero.tile.numOfFrames;\n      const maxTime = speed * numOfFrames;\n      const delta = Math.min(maxTime, time - start) / maxTime;\n\n      const t_offset_x = scale * 16 * (scene.level.hero.new_x - scene.level.hero.x) * delta;\n      const t_offset_y = scale * 16 * (scene.level.hero.new_y - scene.level.hero.y) * delta;\n\n      t_x = t_x + t_offset_x;\n      t_y = t_y + t_offset_y;\n    }\n\n    // render floor, drop\n    for(let l_x=0; l_x<scene.level.w; l_x++) {\n      for(let l_y=0; l_y<scene.level.h; l_y++) {\n        const d_x = -t_x + l_x * 16 * scale;\n        const d_y = -t_y + l_y * 16 * scale;\n        renderTile(scene.level.floor[l_y][l_x], d_x, d_y);\n        if(scene.level.drop[l_y][l_x]) {\n          renderTile(scene.level.drop[l_y][l_x].tile, d_x, d_y);\n        }\n      }\n    }\n    // render wall, monsters\n    for(let l_y=0; l_y<scene.level.h; l_y++) {\n      for(let l_x=0; l_x<scene.level.w; l_x++) {\n        const d_x = -t_x + l_x * 16 * scale;\n        const d_y = -t_y + l_y * 16 * scale;\n        const tile = scene.level.wall[l_y][l_x];\n        if(tile) {\n          renderTile(tile, d_x, d_y);\n          if (tile.name === \"wall_fountain_mid_red_anim\" || tile.name === \"wall_fountain_mid_blue_anim\") {\n            renderLight(d_x + 8 * scale, d_y + 8 * scale, 16 * scale * 4);\n          }\n        }\n      }\n      if(l_y < scene.level.h -1) {\n        for (let l_x = 0; l_x < scene.level.w; l_x++) {\n          const m_y = l_y + 1;\n          const d_x = -t_x + l_x * 16 * scale;\n          const d_y = -t_y + m_y * 16 * scale;\n          renderMonster(scene.level.monsters[m_y][l_x], d_x, d_y, time);\n        }\n      }\n    }\n\n    ctx.restore();\n\n    ctx.save();\n    ctx.globalAlpha = 0.8;\n    ctx.globalCompositeOperation = \"multiply\";\n    ctx.drawImage(buffer, 0, 0);\n    ctx.restore();\n  }\n\n  function renderLight(x: number, y: number, radius: number) {\n    const diameter = radius << 1;\n    const box_x = x - radius;\n    const box_y = y - radius;\n\n    const grd = b_ctx.createRadialGradient(x, y, 16, x, y, radius);\n    grd.addColorStop(0.5, \"rgb(255,255,255)\");\n    grd.addColorStop(1, \"transparent\");\n    b_ctx.fillStyle = grd;\n    b_ctx.fillRect(box_x, box_y, diameter, diameter);\n  }\n\n  function renderHUD(time: number) {\n    renderHealth(time);\n    renderLevelTitle(time);\n    renderYouDead(time);\n    renderInventory(time);\n  }\n  function renderHealth(time: number) {\n    const border = 4;\n    const height = 20;\n    const point_w = 10;\n    const h_m = scene.level.hero.healthMax;\n    const h = scene.level.hero.health;\n\n    // render HUD - hero health\n    ctx.save();\n    ctx.translate(40, 40);\n\n    // background\n    ctx.fillStyle = \"rgb(0,0,0)\";\n    ctx.fillRect(0, 0, border * 2 + point_w * h_m, border * 2 + height);\n\n    // health red line\n    ctx.fillStyle = \"rgb(255,0,0)\";\n    ctx.fillRect(border, border, point_w * h, height);\n\n    // health points text\n    ctx.fillStyle = \"rgb(255,255,255)\";\n    ctx.font = \"20px silkscreennormal\";\n    ctx.fillText(h.toString(), border * 2, border + 16);\n\n    // coins text\n    ctx.fillText(`$${hero.coins}`, 0, 50);\n\n    ctx.restore();\n  }\n  function renderLevelTitle(time: number) {\n    const c_w = canvas.width;\n    const c_h = canvas.height;\n\n    // render HUD - level\n    ctx.save();\n    ctx.translate(c_w / 2, 60);\n    ctx.fillStyle = \"rgb(255,255,255)\";\n    ctx.textAlign = \"center\";\n    ctx.font = \"20px silkscreennormal\";\n    ctx.fillText(`level ${scene.level.level}`, 0, 0);\n    ctx.restore();\n\n    // render HUD - log info\n    scene.level.log = scene.level.log.slice(-5);\n    ctx.save();\n    ctx.translate(40, c_h - 100);\n    for(let i=0; i<scene.level.log.length; i++) {\n      ctx.fillStyle = \"rgb(255,255,255)\";\n      ctx.font = \"20px silkscreennormal\";\n      ctx.fillText(scene.level.log[i], 0, i * 20);\n    }\n\n    ctx.restore();\n  }\n  function renderYouDead(time: number) {\n    const c_w = canvas.width;\n    const c_h = canvas.height;\n\n    if(scene.level.hero.dead) {\n      ctx.save();\n\n      ctx.fillStyle = \"rgba(0, 0, 0, 0.7)\";\n      ctx.fillRect(0, 0, c_w, c_h);\n\n      ctx.translate(c_w / 2, c_h / 2);\n\n      ctx.fillStyle = \"rgb(255,0,0)\";\n      ctx.textAlign = \"center\";\n      ctx.font = \"200px silkscreennormal\";\n      ctx.fillText(\"YOU DIED\", 0, 0);\n      ctx.restore();\n    }\n  }\n  function renderInventory(time: number) {\n    const c_w = canvas.width;\n    const c_h = canvas.height;\n\n    const cells = scene.level.hero.inventory.cells;\n    const cell_size = 16;\n    const grid_w = cells.length;\n    const grid_spacing = 2;\n\n    const inv_w = scale * (grid_w * (cell_size + grid_spacing) + grid_spacing);\n    const inv_h = scale * (cell_size + grid_spacing + grid_spacing);\n\n    ctx.save();\n    ctx.translate((c_w >> 1) - (inv_w >> 1), c_h - inv_h - 40);\n\n    // background\n    ctx.fillStyle = \"rgb(100,100,100)\";\n    ctx.fillRect(0, 0, inv_w, inv_h);\n\n    ctx.translate(grid_spacing * scale, grid_spacing * scale); // grid spacing\n\n    for (let g_x = 0; g_x < grid_w; g_x++) {\n      const c_x = scale * (g_x * (cell_size + grid_spacing));\n      const c_y = 0;\n\n      ctx.fillStyle = \"rgb(70,70,70)\";\n      ctx.fillRect(c_x, 0, cell_size * scale, cell_size * scale);\n      const cell = cells[g_x];\n      if(cell.item) {\n        const tile = cell.item.tile;\n          // @todo fix dw/dh for swords\n        if (tile.isAnim && tile.numOfFrames > 1) {\n          let sf;\n          if (tile.numOfFrames === 3) {\n            sf = Math.floor(time / 100) % tile.numOfFrames;\n          } else if (tile.numOfFrames === 4) {\n            sf = (time >> 2) % tile.numOfFrames;\n          } else {\n            sf = (time >> 2) % tile.numOfFrames;\n          }\n          const sw = tile.w;\n          const sh = tile.h;\n          const sx = tile.x + sw * sf;\n          const sy = tile.y;\n          const dw = sw * scale;\n          const dh = sh * scale;\n          ctx.drawImage(tile.tileSet, sx, sy, sw, sh, c_x, c_y, dw, dh);\n        } else {\n          const sx = tile.x;\n          const sy = tile.y;\n          const sw = tile.w;\n          const sh = tile.h;\n          const dw = sw * scale;\n          const dh = sh * scale;\n          ctx.drawImage(tile.tileSet, sx, sy, sw, sh, c_x, c_y, dw, dh);\n        }\n        ctx.textAlign = \"end\";\n        ctx.textBaseline = \"top\";\n        ctx.font = \"10px silkscreennormal\";\n        ctx.fillStyle = \"rgb(255,255,255)\";\n        ctx.fillText(cell.count.toString(), c_x + (cell_size * scale), 0, cell_size * scale);\n      }\n    }\n    ctx.restore();\n  }\n\n  function renderMonster(monster: Monster, dx: number, dy: number, time: number) {\n    if(monster && !(monster instanceof MovingMonsterWrapper)) {\n      const sw = monster.tile.w;\n      const sh = monster.tile.h;\n      const sx = monster.tile.x + sw * monster.frame;\n      const sy = monster.tile.y;\n      const dw = sw * scale;\n      const dh = sh * scale;\n\n      const tile_offset_y = dh - 14 * scale;\n\n      let offset_x = 0;\n      let offset_y = 0;\n\n      if(monster.state === MonsterState.Run) {\n        const start = monster.start;\n        const speed = monster.speed;\n        const numOfFrames = monster.tile.numOfFrames;\n        const maxTime = speed * numOfFrames;\n        const delta = Math.min(maxTime, time - start) / maxTime;\n\n        offset_x = scale * 16 * (monster.new_x - monster.x) * delta;\n        offset_y = scale * 16 * (monster.new_y - monster.y) * delta;\n      }\n\n      if(dx + offset_x + dw > 0 && dx + offset_x < ctx.canvas.width &&\n        dy + offset_y + dh > 0 && dy + offset_y < ctx.canvas.height) {\n\n\n        ctx.save();\n        ctx.translate(dx + offset_x, dy + offset_y);\n        if(monster.is_left) {\n          ctx.scale(-1, 1);\n          if(monster.weapon) {\n            ctx.save();\n            const w = monster.weapon.tile;\n            const w_dw = w.w * scale;\n            const w_dh = w.h * scale;\n\n            const w_dy = w_dh - 14 * scale;\n            const w_dx = 4 * scale;\n\n            ctx.translate(-w_dx, -w_dy);\n\n            if(monster.state === MonsterState.Hit) {\n              let angle = 90 * monster.weapon.frame / (monster.weapon.numOfFrames - 1);\n              ctx.translate(w_dw >> 1, w_dh); // to bottom center of tile\n              ctx.rotate(angle * Math.PI / 180); // 90 degree\n              ctx.drawImage(w.tileSet, w.x, w.y, w.w, w.h, -(w_dw >> 1), -w_dh, w_dw, w_dh);\n            } else {\n              ctx.drawImage(w.tileSet, w.x, w.y, w.w, w.h, 0, 0, w_dw, w_dh);\n            }\n            ctx.restore();\n          }\n          ctx.drawImage(monster.tile.tileSet, sx, sy, sw, sh, 0 - dw, -tile_offset_y, dw, dh);\n        } else {\n          if(monster.weapon) {\n            ctx.save();\n            const w = monster.weapon.tile;\n            const w_dw = w.w * scale;\n            const w_dh = w.h * scale;\n\n            const w_dy = w_dh - 14 * scale;\n            const w_dx = 12 * scale;\n\n            ctx.translate(w_dx, -w_dy);\n\n            if(monster.state === MonsterState.Hit) {\n              let angle = 90 * monster.weapon.frame / (monster.weapon.numOfFrames - 1);\n              ctx.translate(w_dw >> 1, w_dh); // to bottom center of tile\n              ctx.rotate(angle * Math.PI / 180); // 90 degree\n              ctx.drawImage(w.tileSet, w.x, w.y, w.w, w.h, -(w_dw >> 1), -w_dh, w_dw, w_dh);\n            }else {\n              ctx.drawImage(w.tileSet, w.x, w.y, w.w, w.h, 0, 0, w_dw, w_dh);\n            }\n            ctx.restore();\n          }\n          ctx.drawImage(monster.tile.tileSet, sx, sy, sw, sh, 0, -tile_offset_y, dw, dh);\n        }\n        ctx.restore();\n      }\n    }\n  }\n\n  function renderTile(tile: Tile, dx: number, dy: number) {\n    if(tile) {\n      const sw = tile.w;\n      const sh = tile.h;\n      const dw = sw * scale;\n      const dh = sh * scale;\n\n      if(dx + dw > 0 && dx < ctx.canvas.width &&\n        dy + dh > 0 && dy < ctx.canvas.height) {\n        if (tile.isAnim && tile.numOfFrames > 1) {\n          const time = new Date().getTime();\n          const sf = Math.floor(time / 100) % tile.numOfFrames;\n          const sx = tile.x + sw * sf;\n          const sy = tile.y;\n          ctx.drawImage(tile.tileSet, sx, sy, sw, sh, dx, dy, dw, dh);\n        } else {\n          const sx = tile.x;\n          const sy = tile.y;\n          ctx.drawImage(tile.tileSet, sx, sy, sw, sh, dx, dy, dw, dh);\n        }\n      }\n    }\n  }\n\n  render();\n})();","import {Inventory} from \"./inventory\";\nimport {Tile, TileRegistry} from \"./tilemap\";\nimport {Joystick} from \"./input\";\nimport {Monster, MonsterState, MovingMonsterWrapper} from \"./monster\";\nimport {Level} from \"./level\";\n\nexport const heroMonsterNames = [\n  \"elf_f\",\n  \"elf_m\",\n  \"knight_f\",\n  \"knight_m\",\n  \"wizard_f\",\n  \"wizard_m\",\n];\n\nexport class HeroMonster implements Monster {\n  private registry: TileRegistry;\n  private joystick: Joystick;\n  x: number;\n  y: number;\n  new_x: number;\n  new_y: number;\n  is_left: boolean;\n  readonly name: string;\n  readonly healthMax: number;\n  health: number;\n  coins: number;\n  private readonly damage: number;\n  dead: boolean;\n  weapon: Weapon;\n  readonly speed: number;\n  readonly inventory: Inventory;\n  private level: Level;\n  state: MonsterState;\n  tile: Tile;\n  frame: number;\n  start: number;\n\n  constructor(registry: TileRegistry, joystick: Joystick, x: number, y: number, name: string, weapon: Weapon, time: number) {\n    this.registry = registry;\n    this.joystick = joystick;\n    this.x = x;\n    this.y = y;\n    this.new_x = x;\n    this.new_y = y;\n    this.is_left = false;\n    this.name = name;\n    this.healthMax = 30;\n    this.health = this.healthMax;\n    this.coins = 0;\n    this.damage = 5;\n    this.dead = false;\n    this.weapon = weapon;\n    this.speed = 100;\n    this.inventory = new Inventory();\n    this.setAnimation(MonsterState.Idle, time);\n  }\n\n  setLevel(level: Level) {\n    this.level = level;\n  };\n\n  setAnimation(state: MonsterState, time: number) {\n    if (!this.dead) {\n      switch (state) {\n        case MonsterState.Idle:\n          this.state = state;\n          this.tile = this.registry.get(this.name + \"_idle_anim\");\n          this.frame = 0;\n          this.start = time;\n          break;\n        case MonsterState.Run:\n          this.state = state;\n          this.tile = this.registry.get(this.name + \"_run_anim\");\n          this.frame = 0;\n          this.start = time;\n          break;\n        case MonsterState.Hit:\n          this.state = state;\n          this.tile = this.registry.get(this.name + \"_hit_anim\");\n          this.frame = 0;\n          this.weapon.frame = 0;\n          this.start = time;\n          break;\n      }\n    }\n  };\n\n  animate(time: number) {\n    switch (this.state) {\n      case MonsterState.Idle:\n        this.frame = Math.floor((time - this.start) / this.speed);\n        if (!this.action(time)) {\n          if (this.frame >= this.tile.numOfFrames) {\n            this.setAnimation(MonsterState.Idle, time);\n          }\n        }\n        break;\n      case MonsterState.Run:\n        this.frame = Math.floor((time - this.start) / this.speed);\n        if (this.frame >= this.tile.numOfFrames) {\n          this.level.monsters[this.y][this.x] = null;\n          this.level.monsters[this.new_y][this.new_x] = this;\n          this.x = this.new_x;\n          this.y = this.new_y;\n          this.scanDrop();\n          if (!this.action(time)) {\n            this.setAnimation(MonsterState.Idle, time);\n          }\n        }\n        break;\n      case MonsterState.Hit:\n        this.weapon.frame = Math.floor((time - this.start) / this.weapon.speed);\n        if (this.weapon.frame >= this.weapon.numOfFrames) {\n          this.scanHit(time);\n          this.scanDrop();\n          if (!this.action(time)) {\n            this.setAnimation(MonsterState.Idle, time);\n          }\n        }\n        break;\n    }\n  };\n\n  action(time: number) {\n    this.scanDrop();\n    for (let d = 0; d < 10; d++) {\n      const digit = (d + 1) % 10;\n      if (!this.joystick.digit(digit).processed) {\n        this.joystick.digit(digit).processed = true;\n        this.inventory.cells[d].use(this);\n      }\n    }\n\n    if (this.joystick.hit.triggered && !this.joystick.hit.processed) {\n      if (this.level.floor[this.y][this.x].name === \"floor_ladder\") {\n        this.joystick.hit.processed = true;\n        this.level.exit(time);\n        return true;\n      } else {\n        this.setAnimation(MonsterState.Hit, time);\n        return true;\n      }\n    }\n    if (this.joystick.moveUp.triggered || !this.joystick.moveUp.processed) {\n      this.joystick.moveUp.processed = true;\n      if (this.move(0, -1, time)) {\n        return true;\n      }\n    }\n    if (this.joystick.moveDown.triggered || !this.joystick.moveDown.processed) {\n      this.joystick.moveDown.processed = true;\n      if (this.move(0, 1, time)) {\n        return true;\n      }\n    }\n    if (this.joystick.moveLeft.triggered || !this.joystick.moveLeft.processed) {\n      this.joystick.moveLeft.processed = true;\n      this.is_left = true;\n      if (this.move(-1, 0, time)) {\n        return true;\n      }\n    }\n    if (this.joystick.moveRight.triggered || !this.joystick.moveRight.processed) {\n      this.joystick.moveRight.processed = true;\n      this.is_left = false;\n      if (this.move(1, 0, time)) {\n        return true;\n      }\n    }\n    return false;\n  };\n\n  scanDrop() {\n    if (this.level.drop[this.y][this.x]) {\n      const drop = this.level.drop[this.y][this.x];\n      if (drop.pickedUp(this)) {\n        this.level.drop[this.y][this.x] = null;\n      }\n    }\n  };\n\n  scanHit(time: number) {\n    const max_distance = this.weapon.distance;\n    // search only left or right path\n    const scan_x_min = this.is_left ? Math.max(0, this.x - max_distance) : this.x;\n    const scan_x_max = this.is_left ? this.x : Math.min(this.level.w, this.x + max_distance);\n\n    const scan_y_min = Math.max(0, this.y - max_distance);\n    const scan_y_max = Math.min(this.level.h, this.y + max_distance);\n\n    for (let s_y = scan_y_min; s_y <= scan_y_max; s_y++) {\n      for (let s_x = scan_x_min; s_x <= scan_x_max; s_x++) {\n        // not self\n        if (!(s_x === this.x && s_y === this.y)) {\n          const monster = this.level.monsters[s_y][s_x];\n          if (monster) {\n            monster.hitDamage(this.damage, this.name, time);\n          }\n        }\n      }\n    }\n  };\n\n  move(d_x: number, d_y: number, time: number) {\n    if (!this.dead && this.state === MonsterState.Idle) {\n      const new_x = this.x + d_x;\n      const new_y = this.y + d_y;\n\n      // check is floor exists\n      if (!this.level.floor[new_y][new_x]) return false;\n\n      // check is no monster\n      if (this.level.monsters[new_y][new_x]) return false;\n\n      // start move animation\n      this.level.monsters[new_y][new_x] = new MovingMonsterWrapper(this); // mark as used\n      this.new_x = new_x;\n      this.new_y = new_y;\n      this.setAnimation(MonsterState.Run, time);\n      return true;\n    }\n    return false;\n  };\n\n  resetPosition(x: number, y: number) {\n    this.x = x;\n    this.y = y;\n    this.new_x = x;\n    this.new_y = y;\n  };\n\n  hitDamage(damage: number, name: string, time: number) {\n    if (!this.dead) {\n      this.level.log.push(`${this.name} damaged ${damage} by ${name}`);\n      this.health = Math.max(0, this.health - damage);\n      if (this.health <= 0) {\n        this.level.log.push(`${this.name} killed by ${name}`);\n        this.setAnimation(MonsterState.Idle, time);\n        this.dead = true;\n      }\n    }\n  };\n\n  hill(health: number) {\n    this.health = Math.min(this.healthMax, this.health + health);\n  };\n\n  addCoins(coins: number) {\n    this.coins = this.coins + coins;\n  };\n}\n\nexport const weaponNames = [\n  \"weapon_knife\",\n  \"weapon_rusty_sword\",\n  \"weapon_regular_sword\",\n  \"weapon_red_gem_sword\",\n  \"weapon_big_hammer\",\n  \"weapon_hammer\",\n  \"weapon_baton_with_spikes\",\n  \"weapon_mace\",\n  \"weapon_katana\",\n  \"weapon_saw_sword\",\n  \"weapon_anime_sword\",\n  \"weapon_axe\",\n  \"weapon_machete\",\n  \"weapon_cleaver\",\n  \"weapon_duel_sword\",\n  \"weapon_knight_sword\",\n  \"weapon_golden_sword\",\n  \"weapon_lavish_sword\",\n  \"weapon_red_magic_staff\",\n  \"weapon_green_magic_staff\",\n];\n\nexport class Weapon {\n  readonly tile: Tile;\n  frame: number;\n  readonly numOfFrames: number;\n  readonly speed: number;\n  readonly distance: number;\n\n  constructor(registry: TileRegistry, tileName: string) {\n    this.tile = registry.get(tileName);\n    this.frame = 0;\n    this.numOfFrames = 4;\n    this.speed = 100;\n    this.distance = 1;\n  }\n}","enum KeyBindState {Await = 1, Pressed = 2}\n\nexport class KeyBind {\n  private readonly code: string;\n  private state: KeyBindState;\n  triggered: boolean;\n  processed: boolean;\n\n  constructor(code: string) {\n    this.code = code;\n    this.state = KeyBindState.Await;\n    this.triggered = false;\n    this.processed = true;\n  }\n\n  keydown(e: KeyboardEvent) {\n    if (e.code === this.code) {\n      e.preventDefault();\n      if (this.state === KeyBindState.Await) {\n        this.triggered = true;\n        this.processed = false;\n        this.state = KeyBindState.Pressed;\n      }\n    }\n  }\n\n  keyup(e: KeyboardEvent) {\n    if (e.code === this.code) {\n      e.preventDefault();\n      if (this.state === KeyBindState.Pressed) {\n        this.triggered = false;\n        this.state = KeyBindState.Await;\n      }\n    }\n  }\n}\n\nexport class Joystick {\n  readonly moveUp: KeyBind;\n  readonly moveLeft: KeyBind;\n  readonly moveDown: KeyBind;\n  readonly moveRight: KeyBind;\n  readonly hit: KeyBind;\n  readonly digit1: KeyBind;\n  readonly digit2: KeyBind;\n  readonly digit3: KeyBind;\n  readonly digit4: KeyBind;\n  readonly digit5: KeyBind;\n  readonly digit6: KeyBind;\n  readonly digit7: KeyBind;\n  readonly digit8: KeyBind;\n  readonly digit9: KeyBind;\n  readonly digit0: KeyBind;\n\n  constructor() {\n    this.moveUp = new KeyBind('KeyW');\n    this.moveLeft = new KeyBind('KeyA');\n    this.moveDown = new KeyBind('KeyS');\n    this.moveRight = new KeyBind('KeyD');\n    this.hit = new KeyBind('KeyF');\n\n    this.digit1 = new KeyBind('Digit1');\n    this.digit2 = new KeyBind('Digit2');\n    this.digit3 = new KeyBind('Digit3');\n    this.digit4 = new KeyBind('Digit4');\n    this.digit5 = new KeyBind('Digit5');\n    this.digit6 = new KeyBind('Digit6');\n    this.digit7 = new KeyBind('Digit7');\n    this.digit8 = new KeyBind('Digit8');\n    this.digit9 = new KeyBind('Digit9');\n    this.digit0 = new KeyBind('Digit0');\n    this.init();\n  }\n\n  digit(num: number): KeyBind {\n    switch (num) {\n      case 1: return this.digit1;\n      case 2: return this.digit2;\n      case 3: return this.digit3;\n      case 4: return this.digit4;\n      case 5: return this.digit5;\n      case 6: return this.digit6;\n      case 7: return this.digit7;\n      case 8: return this.digit8;\n      case 9: return this.digit9;\n      case 0: return this.digit0;\n    }\n  }\n\n  init() {\n    window.addEventListener(\"keydown\", this.keydown.bind(this));\n    window.addEventListener(\"keyup\", this.keyup.bind(this));\n  };\n\n  keydown(e: KeyboardEvent) {\n    this.moveUp.keydown(e);\n    this.moveLeft.keydown(e);\n    this.moveDown.keydown(e);\n    this.moveRight.keydown(e);\n    this.hit.keydown(e);\n    this.digit1.keydown(e);\n    this.digit2.keydown(e);\n    this.digit3.keydown(e);\n    this.digit4.keydown(e);\n    this.digit5.keydown(e);\n    this.digit6.keydown(e);\n    this.digit7.keydown(e);\n    this.digit8.keydown(e);\n    this.digit9.keydown(e);\n    this.digit0.keydown(e);\n  };\n\n  keyup(e: KeyboardEvent) {\n    this.moveUp.keyup(e);\n    this.moveLeft.keyup(e);\n    this.moveDown.keyup(e);\n    this.moveRight.keyup(e);\n    this.hit.keyup(e);\n    this.digit1.keyup(e);\n    this.digit2.keyup(e);\n    this.digit3.keyup(e);\n    this.digit4.keyup(e);\n    this.digit5.keyup(e);\n    this.digit6.keyup(e);\n    this.digit7.keyup(e);\n    this.digit8.keyup(e);\n    this.digit9.keyup(e);\n    this.digit0.keyup(e);\n  };\n}","import {UsableDrop} from \"./drop\";\nimport {HeroMonster} from \"./hero\";\n\nexport class Inventory {\n  readonly cells: InventoryCell[];\n\n  constructor() {\n    this.cells = [];\n    for (let i = 0; i < 10; i++) {\n      this.cells[i] = new InventoryCell();\n    }\n  }\n\n  add(item: UsableDrop) {\n    for (let i = 0; i < this.cells.length; i++) {\n      if (this.cells[i].stack(item)) {\n        return true;\n      }\n    }\n    for (let i = 0; i < this.cells.length; i++) {\n      if (this.cells[i].set(item)) {\n        return true;\n      }\n    }\n    return false;\n  };\n}\n\nexport class InventoryCell {\n  private readonly maxInStack: number;\n  item: UsableDrop;\n  count: number;\n\n  constructor() {\n    this.maxInStack = 3;\n    this.item = null;\n    this.count = 0;\n  }\n\n  stack(item: UsableDrop) {\n    if (this.item && this.item.same(item) && this.count < this.maxInStack) {\n      this.count++;\n      return true;\n    }\n    return false;\n  };\n\n  set(item: UsableDrop) {\n    if (!this.item) {\n      this.item = item;\n      this.count = 1;\n      return true;\n    }\n    return false;\n  };\n\n  use(hero: HeroMonster) {\n    if (this.item && this.count > 0) {\n      this.item.use(hero);\n      this.count--;\n      if (this.count <= 0) {\n        this.item = null;\n        this.count = 0;\n      }\n      return true;\n    }\n    return false;\n  };\n}","import {TinyMonster, tinyMonsterNames} from \"./tiny.monster\";\nimport {Coins, Drop, HealthBigFlask, HealthFlask} from \"./drop\";\nimport {RNG} from \"./rng\";\nimport {Tile, TileRegistry} from \"./tilemap\";\nimport {Scene} from \"./scene\";\nimport {HeroMonster} from \"./hero\";\nimport {Monster} from \"./monster\";\n\nconst x_dist = 2;\nconst y_dist = 3;\n\nexport class Rect {\n  readonly x: number;\n  readonly y: number;\n  readonly w: number;\n  readonly h: number;\n\n  constructor(x: number, y: number, w: number, h: number) {\n    this.x = x;\n    this.y = y;\n    this.w = w;\n    this.h = h;\n  }\n\n  expand() {\n    const a = this;\n    return new Rect(\n      a.x - x_dist,\n      a.y - y_dist,\n      a.w + x_dist + x_dist,\n      a.h + y_dist + y_dist\n    );\n  }\n\n  expandV() {\n    const a = this;\n    return new Rect(\n      a.x - x_dist,\n      a.y,\n      a.w + x_dist + x_dist,\n      a.h\n    );\n  }\n\n  expandH() {\n    const a = this;\n    return new Rect(\n      a.x,\n      a.y - y_dist,\n      a.w,\n      a.h + y_dist + y_dist\n    );\n  }\n\n  isOverlap(b: Rect) {\n    const a = this;\n    return a.x < b.x + b.w\n      && a.x + a.w > b.x\n      && a.y < b.y + b.h\n      && a.y + a.h > b.y;\n  }\n}\n\nexport class Level {\n  private readonly rng: RNG;\n  private readonly registry: TileRegistry;\n  private readonly scene: Scene;\n  readonly level: number;\n  readonly w: number;\n  readonly h: number;\n  log: string[];\n  private readonly rooms: Rect[];\n  private readonly corridorsV: Rect[];\n  private readonly corridorsH: Rect[];\n  readonly floor: Tile[][];\n  readonly drop: Drop[][];\n  readonly wall: Tile[][];\n\n  monsterList: TinyMonster[];\n  readonly hero: HeroMonster;\n  readonly monsters: Monster[][];\n\n  constructor(rng: RNG, registry: TileRegistry, scene: Scene, hero: HeroMonster, l: number, time: number) {\n    this.rng = rng;\n    this.registry = registry;\n    this.scene = scene;\n    this.level = l;\n    this.w = 200;\n    this.h = 120;\n\n    this.log = [];\n    this.rooms = [];\n    this.corridorsV = [];\n    this.corridorsH = [];\n\n    this.floor = this.createBuffer(() => null);\n    this.drop = this.createBuffer(() => null);\n    this.wall = this.createBuffer(() => null);\n\n    this.monsterList = [];\n    this.hero = hero;\n    this.monsters = this.createBuffer(() => null);\n\n    this.generate(time);\n    this.fill();\n    this.replace();\n  }\n\n  createBuffer<T>(defaultValue: () => T): T[][] {\n    const rows: T[][] = [];\n    for (let y = 0; y < this.h; y++) {\n      const row: T[] = [];\n      rows.push(row);\n      for (let x = 0; x < this.w; x++) {\n        row.push(defaultValue());\n      }\n    }\n    return rows;\n  };\n\n  generate(time: number) {\n    const rooms_total = 1 + this.level;\n    const monsters_total = 3 + this.level;\n    const drop_total = 5 + this.level;\n\n    // create rooms\n    for (let r = 0; r < rooms_total; r++) {\n      this.generateRoom();\n    }\n\n    // create monsters\n    for (let m = 0; m < monsters_total; m++) {\n      const r = this.rng.nextRange(1, this.rooms.length);\n      const room = this.rooms[r];\n      for (let t = 0; t < 10; t++) {\n        const x = room.x + this.rng.nextRange(0, room.w);\n        const y = room.y + this.rng.nextRange(0, room.h);\n        if (!this.monsters[y][x]) {\n          const name = this.rng.choice(tinyMonsterNames);\n          const monster = new TinyMonster(this.rng, this.registry, this, x, y, name, time);\n          this.monsterList.push(monster);\n          this.monsters[y][x] = monster;\n          break;\n        }\n      }\n    }\n\n    // create drop\n    for (let d = 0; d < drop_total; d++) {\n      const room = this.rng.choice(this.rooms);\n      for (let t = 0; t < 10; t++) {\n        const x = room.x + this.rng.nextRange(0, room.w);\n        const y = room.y + this.rng.nextRange(0, room.h);\n        if (!this.drop[y][x]) {\n          this.randomDrop(x, y);\n          break;\n        }\n      }\n    }\n\n    // position of hero\n    {\n      const room = this.rooms[0];\n      const hero_x = room.x + (room.w >> 1);\n      const hero_y = room.y + (room.h >> 1);\n      this.hero.setLevel(this);\n      this.hero.resetPosition(hero_x, hero_y);\n      this.monsters[hero_y][hero_x] = this.hero;\n    }\n  };\n\n  generateRoom() {\n    const room_min_w = 5;\n    const room_min_h = 3;\n    const room_max_w = 15;\n    const room_max_h = 10;\n    const room_min_x = 2;\n    const room_min_y = 2;\n\n    const max_corr_dist = 12;\n\n    while (true) {\n      const room_w = this.rng.nextRange(room_min_w, room_max_w);\n      const room_h = this.rng.nextRange(room_min_h, room_max_h);\n\n      const room = new Rect(\n        this.rng.nextRange(room_min_x, this.w - 2 - room_w),\n        this.rng.nextRange(room_min_y, this.h - 2 - room_h),\n        room_w,\n        room_h\n      );\n\n      if (!this.isOverlap(room.expand())) {\n        // free position found\n        if (this.rooms.length === 0) {\n          this.rooms.push(room);\n          break;\n        } else {\n          // find connection\n          const a = room;\n          let connected = false;\n\n          // find closest room\n          for (let i = 0; i < this.rooms.length; i++) {\n            let b = this.rooms[i];\n\n            // try calculate horizontal distance\n            const max_x = Math.max(a.x, b.x);\n            const min_x_w = Math.min(a.x + a.w, b.x + b.w);\n            if (max_x + 5 <= min_x_w) {\n              let rect;\n              if (a.y + a.h < b.y) {\n                rect = new Rect(\n                  max_x + 2,\n                  a.y + a.h,\n                  min_x_w - max_x - 4,\n                  b.y - a.y - a.h\n                );\n              } else {\n                rect = new Rect(\n                  max_x + 2,\n                  b.y + b.h,\n                  min_x_w - max_x - 4,\n                  a.y - b.y - b.h\n                );\n              }\n              if (rect.h < max_corr_dist && !this.isOverlap(rect.expandV())) {\n                this.corridorsV.push(rect);\n                connected = true;\n              }\n            }\n\n            // try calculate vertical distance\n            const max_y = Math.max(a.y, b.y);\n            const min_y_h = Math.min(a.y + a.h, b.y + b.h);\n            if (max_y + 3 <= min_y_h) {\n              let rect;\n              if (a.x + a.w < b.x) {\n                rect = new Rect(\n                  a.x + a.w,\n                  max_y + 1,\n                  b.x - a.x - a.w,\n                  min_y_h - max_y - 2\n                );\n              } else {\n                rect = new Rect(\n                  b.x + b.w,\n                  max_y + 1,\n                  a.x - b.x - b.w,\n                  min_y_h - max_y - 2,\n                );\n              }\n              if (rect.w < max_corr_dist && !this.isOverlap(rect.expandH())) {\n                this.corridorsH.push(rect);\n                connected = true;\n              }\n            }\n          }\n\n          if (connected) {\n            this.rooms.push(room);\n            break;\n          }\n        }\n      }\n    }\n  }\n\n  isOverlap(a: Rect) {\n    const f = a.isOverlap.bind(a);\n    return this.rooms.some(f) ||\n      this.corridorsV.some(f) ||\n      this.corridorsH.some(f);\n  };\n\n  randomDrop(x: number, y: number) {\n    if (this.rng.nextFloat() < 0.5) {\n      this.drop[y][x] = new Coins(this.rng, this.registry);\n    } else if (this.rng.nextFloat() < 0.3) {\n      this.drop[y][x] = new HealthFlask(this.registry);\n    } else if (this.rng.nextFloat() < 0.3) {\n      this.drop[y][x] = new HealthBigFlask(this.registry);\n    }\n  };\n\n  fill() {\n    this.rooms.forEach(r => this.fillRoom(r.x, r.y, r.w, r.h));\n    this.corridorsH.forEach(r => this.fillCorridorH(r.x, r.y, r.w, r.h));\n    this.corridorsV.forEach(r => this.fillCorridorV(r.x, r.y, r.w, r.h));\n  };\n\n  fillRoom(x: number, y: number, w: number, h: number) {\n    // fill floor\n    for (let r_y = y; r_y < y + h; r_y++) {\n      for (let r_x = x; r_x < x + w; r_x++) {\n        this.floor[r_y][r_x] = this.registry.get(\"floor_1\");\n      }\n    }\n    // fill top wall\n    this.wall[y - 2][x] = this.registry.get(\"wall_corner_top_left\");\n    this.wall[y - 1][x] = this.registry.get(\"wall_corner_left\");\n    if (w > 1) {\n      for (let r_x = x + 1; r_x < x + w - 1; r_x++) {\n        this.wall[y - 2][r_x] = this.registry.get(\"wall_top_mid\");\n        this.wall[y - 1][r_x] = this.registry.get(\"wall_mid\");\n      }\n      this.wall[y - 2][x + w - 1] = this.registry.get(\"wall_corner_top_right\");\n      this.wall[y - 1][x + w - 1] = this.registry.get(\"wall_corner_right\");\n    }\n    // fill bottom wall\n    this.wall[y + h - 1][x] = this.registry.get(\"wall_corner_bottom_left\");\n    this.wall[y + h][x] = this.registry.get(\"wall_left\");\n    if (w > 1) {\n      for (let r_x = x + 1; r_x < x + w - 1; r_x++) {\n        this.wall[y + h - 1][r_x] = this.registry.get(\"wall_top_mid\");\n        this.wall[y + h][r_x] = this.registry.get(\"wall_mid\");\n      }\n      this.wall[y + h - 1][x + w - 1] = this.registry.get(\"wall_corner_bottom_right\");\n      this.wall[y + h][x + w - 1] = this.registry.get(\"wall_right\");\n    }\n    // fill right wall\n    for (let r_y = y; r_y < y + h - 1; r_y++) {\n      this.wall[r_y][x] = this.registry.get(\"wall_side_mid_right\");\n    }\n    // fill left wall\n    for (let r_y = y; r_y < y + h - 1; r_y++) {\n      this.wall[r_y][x + w - 1] = this.registry.get(\"wall_side_mid_left\");\n    }\n  };\n\n  fillCorridorH(x: number, y: number, w: number, h: number) {\n    // fill floor\n    for (let r_y = y; r_y < y + h; r_y++) {\n      for (let r_x = x; r_x < x + w; r_x++) {\n        this.floor[r_y][r_x] = this.registry.get(\"floor_1\");\n      }\n    }\n\n    // connect with room top left\n    switch (this.wall[y - 2][x - 1].name) {\n      case \"wall_corner_top_right\":\n        this.wall[y - 2][x - 1] = this.registry.get(\"wall_top_mid\");\n        break;\n      case \"wall_side_mid_left\":\n        break;\n      default:\n        console.log(\"top left 2\", this.wall[y - 2][x - 1]);\n        break;\n    }\n    switch (this.wall[y - 1][x - 1].name) {\n      case \"wall_corner_right\":\n        this.wall[y - 1][x - 1] = this.registry.get(\"wall_mid\");\n        break;\n      case \"wall_side_mid_left\":\n        this.wall[y - 1][x - 1] = this.registry.get(\"wall_side_front_left\");\n        break;\n      default:\n        console.log(\"top left 1\", this.wall[y - 1][x - 1]);\n        break;\n    }\n\n    // connect with room mid left\n    if (h > 1) {\n      for (let l_y = y; l_y < y + h - 1; l_y++) {\n        switch (this.wall[l_y][x - 1].name) {\n          case \"wall_side_mid_left\":\n            this.wall[l_y][x - 1] = null;\n            break;\n          default:\n            console.log(\"mid left\", this.wall[l_y][x - 1]);\n            break;\n        }\n      }\n    }\n\n    // connect with room bottom left\n    switch (this.wall[y + h - 1][x - 1].name) {\n      case \"wall_side_mid_left\":\n        this.wall[y + h - 1][x - 1] = this.registry.get(\"wall_side_top_left\");\n        break;\n      case \"wall_corner_bottom_right\":\n        this.wall[y + h - 1][x - 1] = this.registry.get(\"wall_top_mid\");\n        break;\n      default:\n        console.log(\"bottom left 0\", this.wall[y + h - 1][x - 1]);\n        break;\n    }\n    switch (this.wall[y + h][x - 1].name) {\n      case \"wall_side_mid_left\":\n        break;\n      case \"wall_right\":\n        this.wall[y + h][x - 1] = this.registry.get(\"wall_mid\");\n        break;\n      default:\n        console.log(\"bottom left 1\", this.wall[y + h][x - 1]);\n        break;\n    }\n\n    // connect with room top right\n    switch (this.wall[y - 2][x + w].name) {\n      case \"wall_corner_top_left\":\n        this.wall[y - 2][x + w] = this.registry.get(\"wall_top_mid\");\n        break;\n      case \"wall_side_mid_right\":\n        break;\n      default:\n        console.log(\"top right 2\", this.wall[y - 2][x + w]);\n        break;\n    }\n    switch (this.wall[y - 1][x + w].name) {\n      case \"wall_corner_left\":\n        this.wall[y - 1][x + w] = this.registry.get(\"wall_mid\");\n        break;\n      case \"wall_side_mid_right\":\n        this.wall[y - 1][x + w] = this.registry.get(\"wall_side_front_right\");\n        break;\n      default:\n        console.log(\"top right 1\", this.wall[y - 1][x + w]);\n        break;\n    }\n\n    // connect with room mid right\n    if (h > 1) {\n      for (let l_y = y; l_y < y + h - 1; l_y++) {\n        switch (this.wall[l_y][x + w].name) {\n          case \"wall_side_mid_right\":\n            this.wall[l_y][x + w] = null;\n            break;\n          default:\n            console.log(\"mid right\", this.wall[l_y][x + w]);\n            break;\n        }\n      }\n    }\n\n    // connect with room bottom right\n    switch (this.wall[y + h - 1][x + w].name) {\n      case \"wall_side_mid_right\":\n        this.wall[y + h - 1][x + w] = this.registry.get(\"wall_side_top_right\");\n        break;\n      case \"wall_corner_bottom_left\":\n        this.wall[y + h - 1][x + w] = this.registry.get(\"wall_top_mid\");\n        break;\n      default:\n        console.log(\"bottom right 0\", this.wall[y + h - 1][x + w]);\n        break;\n    }\n    switch (this.wall[y + h][x + w].name) {\n      case \"wall_side_mid_right\":\n        break;\n      case \"wall_left\":\n        this.wall[y + h][x + w] = this.registry.get(\"wall_mid\");\n        break;\n      default:\n        console.log(\"bottom right +1\", this.wall[y + h][x + w]);\n        break;\n    }\n\n    // fill top wall\n    for (let r_x = x; r_x < x + w; r_x++) {\n      this.wall[y - 2][r_x] = this.registry.get(\"wall_top_mid\");\n      this.wall[y - 1][r_x] = this.registry.get(\"wall_mid\");\n    }\n\n    // fill bottom wall\n    for (let r_x = x; r_x < x + w; r_x++) {\n      this.wall[y + h - 1][r_x] = this.registry.get(\"wall_top_mid\");\n      this.wall[y + h][r_x] = this.registry.get(\"wall_mid\");\n    }\n  };\n\n  fillCorridorV(x: number, y: number, w: number, h: number) {\n    // fill floor\n    for (let r_y = y; r_y < y + h; r_y++) {\n      for (let r_x = x; r_x < x + w; r_x++) {\n        this.floor[r_y][r_x] = this.registry.get(\"floor_1\");\n      }\n    }\n\n    // connect with room top left\n    switch (this.wall[y - 1][x - 1].name) {\n      case \"wall_top_mid\":\n        this.wall[y - 1][x - 1] = this.registry.get(\"wall_corner_top_right\");\n        break;\n      default:\n        console.log(\"top left -1 -1\", this.wall[y - 1][x - 1]);\n        break;\n    }\n    switch (this.wall[y][x - 1].name) {\n      case \"wall_mid\":\n        this.wall[y][x - 1] = this.registry.get(\"wall_corner_right\");\n        break;\n      default:\n        console.log(\"top left 0 -1\", this.wall[y][x - 1]);\n        break;\n    }\n\n    // connect with room top mid\n    for (let r_x = x; r_x < x + w; r_x++) {\n      switch (this.wall[y - 1][r_x].name) {\n        case \"wall_top_mid\":\n          this.wall[y - 1][r_x] = null;\n          break;\n        default:\n          console.log(\"top mid -1\", this.wall[y - 1][r_x]);\n          break;\n      }\n      switch (this.wall[y][r_x].name) {\n        case \"wall_mid\":\n          this.wall[y][r_x] = null;\n          break;\n        default:\n          console.log(\"top mid 0\", this.wall[y][r_x]);\n          break;\n      }\n    }\n\n    // connect with room top right\n    switch (this.wall[y - 1][x + w].name) {\n      case \"wall_top_mid\":\n        this.wall[y - 1][x + w] = this.registry.get(\"wall_corner_top_left\");\n        break;\n      default:\n        console.log(\"top right -1 1\", this.wall[y - 1][x + w]);\n        break;\n    }\n    switch (this.wall[y][x + w].name) {\n      case \"wall_mid\":\n        this.wall[y][x + w] = this.registry.get(\"wall_corner_left\");\n        break;\n      default:\n        console.log(\"top right 0 -1\", this.wall[y][x + w]);\n        break;\n    }\n\n\n    // connect with room bottom left\n    switch (this.wall[y + h - 2][x - 1].name) {\n      case \"wall_top_mid\":\n        this.wall[y + h - 2][x - 1] = this.registry.get(\"wall_corner_bottom_right\");\n        break;\n      default:\n        console.log(\"bottom left -2 -1\", this.wall[y + h - 2][x - 1]);\n        break;\n    }\n    switch (this.wall[y + h - 1][x - 1].name) {\n      case \"wall_mid\":\n        this.wall[y + h - 1][x - 1] = this.registry.get(\"wall_corner_front_right\");\n        break;\n      default:\n        console.log(\"top left 0 -1\", this.wall[y + h - 1][x - 1]);\n        break;\n    }\n\n    // connect with room bottom mid\n    for (let r_x = x; r_x < x + w; r_x++) {\n      switch (this.wall[y + h - 2][r_x].name) {\n        case \"wall_top_mid\":\n          this.wall[y + h - 2][r_x] = null;\n          break;\n        default:\n          console.log(\"bottom mid -2\", this.wall[y + h - 2][r_x]);\n          break;\n      }\n      switch (this.wall[y + h - 1][r_x].name) {\n        case \"wall_mid\":\n          this.wall[y + h - 1][r_x] = null;\n          break;\n        default:\n          console.log(\"bottom mid -1\", this.wall[y + h - 1][r_x]);\n          break;\n      }\n    }\n\n    // connect with room bottom right\n    switch (this.wall[y + h - 2][x + w].name) {\n      case \"wall_top_mid\":\n        this.wall[y + h - 2][x + w] = this.registry.get(\"wall_corner_bottom_left\");\n        break;\n      default:\n        console.log(\"bottom right -2 -1\", this.wall[y + h - 2][x - 1]);\n        break;\n    }\n    switch (this.wall[y + h - 1][x + w].name) {\n      case \"wall_mid\":\n        this.wall[y + h - 1][x + w] = this.registry.get(\"wall_corner_front_left\");\n        break;\n      default:\n        console.log(\"bottom right 0 -1\", this.wall[y + h - 1][x - 1]);\n        break;\n    }\n\n    // fill side walls\n    for (let r_y = y + 1; r_y < y + h - 2; r_y++) {\n      this.wall[r_y][x - 1] = this.registry.get(\"wall_side_mid_left\");\n      this.wall[r_y][x + w] = this.registry.get(\"wall_side_mid_right\");\n    }\n  };\n\n  replace() {\n    this.replaceFloorRandomly();\n    this.replaceLadder();\n    this.replaceWallRandomly();\n  };\n\n  replaceFloorRandomly() {\n    const replacements = [\"floor_2\", \"floor_3\", \"floor_4\", \"floor_5\", \"floor_6\", \"floor_7\", \"floor_8\"];\n    const percent = 0.2;\n    for (let y = 0; y < this.h; y++) {\n      for (let x = 0; x < this.w; x++) {\n        if (this.floor[y][x] && this.rng.nextFloat() < percent) {\n          this.floor[y][x] = this.registry.get(this.rng.choice(replacements));\n        }\n      }\n    }\n  };\n\n  replaceLadder() {\n    // replace one tile in last room as ladder = out from level!\n    const last = this.rooms[this.rooms.length - 1];\n\n    const ladder_x = last.x + (last.w >> 1);\n    const ladder_y = last.y + (last.h >> 1);\n    console.log(ladder_x, ladder_y, last);\n    this.floor[ladder_y][ladder_x] = this.registry.get(\"floor_ladder\");\n  };\n\n  replaceWallRandomly() {\n    const wall_mid_top_replaces = [\n      \"wall_hole_1\",\n      \"wall_hole_2\",\n      \"wall_banner_red\",\n      \"wall_banner_blue\",\n      \"wall_banner_green\",\n      \"wall_banner_yellow\",\n      \"wall_goo\",\n      \"wall_fountain_mid_red_anim\",\n      \"wall_fountain_mid_blue_anim\",\n    ];\n    const wall_mid_bottom_replaces = [\n      \"wall_hole_1\",\n      \"wall_hole_2\",\n    ];\n    const percent = 0.2;\n    for (let y = 0; y < this.h; y++) {\n      for (let x = 0; x < this.w; x++) {\n        if (this.wall[y][x]) {\n          switch (this.wall[y][x].name) {\n            case \"wall_mid\":\n              if (this.rng.nextFloat() < percent) {\n                const is_top = !!this.floor[y + 1][x];\n                let replacements: string[];\n                if (is_top) {\n                  replacements = wall_mid_top_replaces;\n                } else {\n                  replacements = wall_mid_bottom_replaces;\n                }\n                const replacement = this.rng.choice(replacements);\n                switch (replacement) {\n                  case \"wall_goo\":\n                    this.wall[y][x] = this.registry.get(\"wall_goo\");\n                    this.floor[y + 1][x] = this.registry.get(\"wall_goo_base\");\n                    break;\n                  case \"wall_fountain_mid_red_anim\":\n                    this.wall[y - 1][x] = this.registry.get(\"wall_fountain_top\");\n                    this.wall[y][x] = this.registry.get(\"wall_fountain_mid_red_anim\");\n                    this.floor[y + 1][x] = this.registry.get(\"wall_fountain_basin_red_anim\");\n                    break;\n                  case \"wall_fountain_mid_blue_anim\":\n                    this.wall[y - 1][x] = this.registry.get(\"wall_fountain_top\");\n                    this.wall[y][x] = this.registry.get(\"wall_fountain_mid_blue_anim\");\n                    this.floor[y + 1][x] = this.registry.get(\"wall_fountain_basin_blue_anim\");\n                    break;\n                  default:\n                    this.wall[y][x] = this.registry.get(replacement);\n                    break;\n                }\n              }\n              break;\n            default:\n              // console.log(\"replace\", this.wall[y][x]);\n              break;\n          }\n        }\n      }\n    }\n  };\n\n  exit(time: number) {\n    this.scene.setLevel(new Level(this.rng, this.registry, this.scene, this.hero, this.level + 1, time))\n  };\n\n  animate(time: number) {\n    this.monsterList.forEach(m => m.animate(time));\n    this.hero.animate(time);\n  };\n}","import {Tile} from \"./tilemap\";\nimport {Weapon} from \"./hero\";\n\nexport enum MonsterState {\n  Idle = 0, Run = 1, Hit = 2\n}\n\nexport interface Monster {\n  x: number\n  y: number\n  new_x: number\n  new_y: number\n  is_left: boolean\n  frame: number\n  start: number\n  speed: number\n  tile: Tile\n  state: MonsterState\n  weapon: Weapon\n  hitDamage(damage: number, name: string, time: number): void;\n}\n\nexport class MovingMonsterWrapper implements Monster {\n  private readonly monster: Monster;\n\n  constructor(monster: Monster) {\n    this.monster = monster;\n  }\n\n  hitDamage(damage: number, name: string, time: number) {\n    this.monster.hitDamage(damage, name, time);\n  }\n\n  get x(): number {\n    return this.monster.x;\n  }\n\n  get y(): number {\n    return this.monster.y;\n  }\n\n  get new_x(): number {\n    return this.monster.new_x;\n  }\n\n  get new_y(): number {\n    return this.monster.new_y;\n  }\n\n  get is_left(): boolean {\n    return this.monster.is_left;\n  }\n\n  get frame(): number {\n    return this.monster.frame;\n  }\n\n  get start(): number {\n    return this.monster.start;\n  }\n\n  get speed(): number {\n    return this.monster.speed;\n  }\n\n  get tile(): Tile {\n    return this.monster.tile;\n  }\n\n  get state(): MonsterState {\n    return this.monster.state;\n  }\n\n  get weapon(): Weapon {\n    return this.monster.weapon;\n  }\n}","/**\n * https://stackoverflow.com/questions/424292/seedable-javascript-random-number-generator\n * LCG using GCC's constants\n */\n\nconst m = 0x80000000; // 2^31;\nconst a = 1103515245;\nconst c = 12345;\n\nexport class RNG {\n  private state: number;\n\n  constructor(seed: number = null) {\n    this.state = seed ? seed : Math.floor(Math.random() * (m - 1));\n    console.log(\"seed\", this.state);\n  }\n\n  nextInt(): number {\n    this.state = (a * this.state + c) % m;\n    return this.state;\n  }\n\n  nextFloat(): number {\n    return this.nextInt() / (m - 1);\n  }\n\n  nextRange(start: number, end: number): number {\n    const rangeSize = end - start;\n    const randomUnder1 = this.nextInt() / m;\n    return start + Math.floor(randomUnder1 * rangeSize);\n  }\n\n  choice<T>(array: T[]): T {\n    return array[this.nextRange(0, array.length)];\n  }\n}","import {Level} from \"./level\";\n\nexport class Scene {\n  level: Level;\n\n  setLevel(level: Level) {\n    this.level = level;\n  }\n}","// https://0x72.itch.io/dungeontileset-ii\n\nexport class TileRegistry {\n  private readonly tileMap: Record<string, Tile>;\n\n  constructor() {\n    this.tileMap = {};\n  }\n\n  async loadTileSet(): Promise<HTMLImageElement> {\n    return await new Promise<HTMLImageElement>((resolve => {\n      const img = new Image();\n      img.onload = ev => resolve(img);\n      img.src = \"0x72_DungeonTilesetII_v1.2.png\";\n    }));\n  }\n\n  async load() {\n    const tileSet = await this.loadTileSet();\n    const response = await fetch(\"tiles_list_v1.1.txt\");\n    const text = await response.text();\n    const lines = text.split(/(\\r?\\n)/g);\n    lines.forEach((line) => {\n      let m = line.match(/([a-z0-9_]+) +([0-9]+) +([0-9]+) +([0-9]+) +([0-9]+) ?([0-9]?)/);\n      if (m) {\n        const x = parseInt(m[2]);\n        const y = parseInt(m[3]);\n        const w = parseInt(m[4]);\n        const h = parseInt(m[5]);\n        const numOfFrames = parseInt(m[6] || \"0\");\n        const tile = new Tile(tileSet, m[1], x, y, w, h, numOfFrames);\n        this.tileMap[tile.name] = tile;\n      }\n    });\n  }\n\n  get(tileName: string): Tile {\n    return this.tileMap[tileName];\n  }\n}\n\nexport class Tile {\n  readonly tileSet: HTMLImageElement;\n  readonly name: string;\n  readonly x: number;\n  readonly y: number;\n  readonly w: number;\n  readonly h: number;\n  readonly numOfFrames: number;\n  readonly isAnim: boolean;\n\n  constructor(tileSet: HTMLImageElement, name: string, x: number, y: number, w: number, h: number, numOfFrames: number) {\n    this.tileSet = tileSet;\n    this.name = name;\n    this.x = x;\n    this.y = y;\n    this.w = w;\n    this.h = h;\n    this.numOfFrames = numOfFrames;\n    this.isAnim = this.numOfFrames > 1;\n  }\n}","import {RNG} from \"./rng\";\nimport {Tile, TileRegistry} from \"./tilemap\";\nimport {Level} from \"./level\";\nimport {Monster, MonsterState, MovingMonsterWrapper} from \"./monster\";\nimport {Weapon} from \"./hero\";\n\nexport const tinyMonsterNames = [\n  \"tiny_zombie\",\n  \"goblin\",\n  \"imp\",\n  \"skeleton\",\n  \"muddy\",\n  \"swampy\",\n  \"zombie\",\n  \"ice_zombie\",\n];\n\nexport class TinyMonster implements Monster {\n  private readonly rng: RNG;\n  private readonly registry: TileRegistry;\n  private readonly level: Level;\n  x: number;\n  y: number;\n  new_x: number;\n  new_y: number;\n  is_left: boolean;\n  private readonly name: string;\n  private readonly healthMax: number;\n  private health: number;\n  private readonly damage: number;\n  private readonly luck: number;\n  readonly speed: number;\n  state: MonsterState;\n  tile: Tile;\n  frame: number;\n  start: number;\n  weapon: Weapon;\n\n  constructor(rng: RNG, registry: TileRegistry, level: Level, x: number, y: number, name: string, time: number) {\n    this.rng = rng;\n    this.registry = registry;\n    this.level = level;\n    this.x = x;\n    this.y = y;\n    this.new_x = x;\n    this.new_y = y;\n    this.is_left = false;\n    this.name = name;\n    this.healthMax = 10;\n    this.health = this.healthMax;\n    this.damage = 1;\n    this.luck = 0.5;\n    this.speed = 100;\n    this.setAnimation(MonsterState.Idle, time);\n  }\n\n  setAnimation(state: MonsterState, time: number) {\n    switch (state) {\n      case MonsterState.Idle:\n        this.state = state;\n        this.tile = this.registry.get(this.name + \"_idle_anim\");\n        this.frame = 0;\n        this.start = time;\n        break;\n      case MonsterState.Run:\n        this.state = state;\n        this.tile = this.registry.get(this.name + \"_run_anim\");\n        this.frame = 0;\n        this.start = time;\n        break;\n    }\n  };\n\n  animate(time: number) {\n    this.frame = Math.floor((time - this.start) / this.speed);\n    if (this.frame >= this.tile.numOfFrames) {\n      if (this.state === MonsterState.Run) {\n        // console.log(\"finish run animation\");\n        this.level.monsters[this.y][this.x] = null;\n        this.level.monsters[this.new_y][this.new_x] = this;\n        this.x = this.new_x;\n        this.y = this.new_y;\n      }\n\n      this.setAnimation(MonsterState.Idle, time);\n\n      // search hero near\n      const max_distance = 3;\n      const scan_x_min = Math.max(0, this.x - max_distance);\n      const scan_y_min = Math.max(0, this.y - max_distance);\n      const scan_x_max = Math.min(this.level.w, this.x + max_distance);\n      const scan_y_max = Math.min(this.level.h, this.y + max_distance);\n\n      const is_hero_near = !this.level.hero.dead\n        && this.level.hero.x >= scan_x_min && this.level.hero.x <= scan_x_max\n        && this.level.hero.y >= scan_y_min && this.level.hero.y <= scan_y_max;\n\n      // console.log(\"hero is near\", scan_x_min, scan_x_max, scan_y_min, scan_y_max);\n\n      if (is_hero_near) {\n        const dist_x = Math.abs(this.x - this.level.hero.x);\n        const dist_y = Math.abs(this.y - this.level.hero.y);\n\n        if (dist_x > 1) {\n          const move_x = Math.max(-1, Math.min(1, this.level.hero.x - this.x));\n          if (this.move(move_x, 0, time)) {\n            console.log(\"move to hero x\");\n            return;\n          }\n        }\n        if (dist_y > 0) {\n          const move_y = Math.max(-1, Math.min(1, this.level.hero.y - this.y));\n          if (this.move(0, move_y, time)) {\n            console.log(\"move to hero y\");\n            return;\n          }\n        }\n\n        if (dist_x <= 1 && dist_y <= 1 && this.rng.nextFloat() < this.luck) {\n          this.level.hero.hitDamage(this.damage, this.name, time);\n          return;\n        }\n      }\n\n      // random move ?\n      const random_move_percent = 0.1;\n      if (this.rng.nextFloat() < random_move_percent) {\n        const move_x = this.rng.nextRange(-1, 1);\n        const move_y = this.rng.nextRange(-1, 1);\n        // console.log(\"random move\", move_x, move_y);\n        if (this.move(move_x, move_y, time)) {\n          return;\n        }\n      }\n    }\n  };\n\n  move(d_x: number, d_y: number, time: number) {\n    this.is_left = d_x < 0;\n    if (this.state === MonsterState.Idle) {\n      const new_x = this.x + d_x;\n      const new_y = this.y + d_y;\n\n      // check is floor exists\n      if (!this.level.floor[new_y][new_x]) return false;\n\n      // check is no monster\n      if (this.level.monsters[new_y][new_x]) return false;\n\n      // start move animation\n      this.level.monsters[new_y][new_x] = new MovingMonsterWrapper(this); // mark as used\n      this.new_x = new_x;\n      this.new_y = new_y;\n      this.setAnimation(MonsterState.Run, time);\n      return true;\n    }\n    return false;\n  };\n\n  hitDamage(damage: number, name: string, time: number) {\n    this.level.log.push(`${this.name} damaged ${damage} by ${name}`);\n    this.health = Math.max(0, this.health - damage);\n    if (this.health <= 0) {\n      this.level.log.push(`${this.name} killed by ${name}`);\n      this.level.monsters[this.y][this.x] = null;\n      this.level.monsters[this.new_y][this.new_x] = null;\n      this.level.monsterList = this.level.monsterList.filter(s => s !== this);\n      if (this.rng.nextFloat() < this.luck) {\n        this.level.randomDrop(this.x, this.y);\n      }\n    }\n  };\n}"]}